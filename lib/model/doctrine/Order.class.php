<?php

/**
 * Order
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 *
 * @package    enter
 * @subpackage model
 * @author     Связной Маркет
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Order extends BaseOrder
{

    const STATUS_READY     = 6;
    const STATUS_CANCELLED     = 5;


  public function __toString()
  {
    return (string)$this->token;
  }

  public function toParams()
  {
    return array(
      'order' => $this->token,
    );
  }

  public function getCityName()
  {
	  return isset($this->Region) ? $this->Region->name : null;
  }

  public function getAreaName()
  {
	  if (isset($this->Region)) {
		  $parent = $this->Region->getNode()->getParent();
		  if ($parent && $parent->type == 'area') {
			  return $parent->name;
		  }
	  }
	  return null;
  }

  public function getCountryName()
  {
	  if (isset($this->Region)) {
		  $parent = $this->Region->getNode()->getParent();
		  if ($parent && $parent->type == 'country') {
			  return $parent->name;
		  }
		  $parent = $parent->getNode()->getParent();
		  if ($parent && $parent->type == 'country') {
			  return $parent->name;
		  }
	  }
	  return null;
  }

  public function getPersonTypeName()
  {
    $names = array(
      'individual' => 'физическое лицо',
      'legal'      => 'юридическое лицо',
    );

    return isset($names[$this->person_type]) ? $names[$this->person_type] : null;
  }

  public function exportToCore()
  {
    $data = parent::exportToCore();

    /*
    $data['user_id']              = $this->User->core_id;
    $data['payment_id']           = $this->PaymentMethod->core_id;
    $data['geo_id']               = $this->Region->core_id;
    $data['delivery_type_id']     = $this->DeliveryType->core_id;
    $data['delivery_interval_id'] = $this->DeliveryPeriod->core_id;
    $data['shop_id']              = $this->Shop->core_id;
    $data['address_id']           = $this->UserAddress->core_id;
    $data['satus_id']             = $this->Status->core_id;
    */
    $data['store_id']             = null;
    $data['type_id']              = 1;
    $data['ip']                   = isset($_SERVER['REMOTE_ADDR']) ? $_SERVER['REMOTE_ADDR'] : null; //sfContext::getInstance()->getUser()->getIp();


    if (isset($this->ProductRelation))
    {
      foreach ($this->ProductRelation as $product)
      {
        $data['product'][] = array(
          'id'          => $product->Product->core_id,
          'price'       => $product->price,
          'quantity'    => $product->quantity,
        );
      }
    }

    return $data;
  }

  public function importFromCore(array $data)
  {
    parent::importFromCore($data);

    $this->token = uniqid().'-'.$data['number'];

    //$this->type = 1 == $data['type_id'] ? 'order' : 'preorder';

    // check if user doesn't exists
    if (!empty($data['user_id']) && empty($this->user_id))
    {
      if (!$response = Core::getInstance()->getUser($data['user_id']))
      {
        throw new Exception('Can\'t create User ##'.$data['user_id']);
      }

      $user = new User();
      $user->importFromCore($response);
      $user->setCorePush(false);
      $user->save();
    }
  }

  public function isOnlinePayment()
  {
    return in_array($this->payment_method_id, array(3,));
  }

  public function isSelfDelivery()
  {
    return 'self' == $this->DeliveryType->token;
  }

}
