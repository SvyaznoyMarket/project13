<?php

/**
 * ProductFilterGroup
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 *
 * @package    enter
 * @subpackage model
 * @author     Связной Маркет
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class ProductFilterGroup extends BaseProductFilterGroup
{
  public function getFilterList(array $params = array())
  {
    return ProductFilterTable::getInstance()->getListByGroup($this, $params);
  }

  public function importFromCore(array $data)
  {
    //parent::importFromCore($data);
      
    $this->name = 'Фильтр для '.$data['name'];
      
    $filter_ids = array();
    foreach ($this->Filter as $filter)
    {
      if (!empty($filter['core_id']))
      {
        $filter_ids['core_id-'.$filter['core_id']] = $filter['id'];
      }
      else
      {
        $filter_ids[] = $filter['id'];
      }
    }
      
    if (!empty($data['filter_property']))
    {
      //$this->Filter = new Doctrine_Collection(ProductFilterTable::getInstance());
      foreach ($data['filter_property'] as $relationData)
      {
        unset($filter_ids['core_id-'.$relationData['id']]);
        $productFilter = ProductFilterTable::getInstance()->getByCoreId($relationData['id']);
        if (!$productFilter)
        {
          $productFilter = new ProductFilter();
        }
        
        $productFilter->importFromCore($relationData);
        $this->Filter[] = $productFilter;
      }
    }
    
    //Удаляю все, что лишнее
    if ($this->id && count($filter_ids))
    {
      $q = Doctrine_Query::create()
        ->delete('ProductFilter')
        ->whereIn('id', array_values($filter_ids));

      $deleted = $q->execute();
    }
  }

}
