<?php

/**
 * ProductTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class ProductTable extends myDoctrineTable
{
 /**
  * Returns an instance of this class.
  *
  * @return object ProductTable
  */
  public static function getInstance()
  {
    return Doctrine_Core::getTable('Product');
  }

  public function createBaseQuery(array $params = array())
  {
    $this->applyDefaultParameters($params, array(
      'view' => false, // list, show
    ));
    
    $q = $this->createQuery('product');
    
    if ('list' == $params['view'])
    {
      $q->addWhere('product.view_list = ?', true);
    }
    if ('show' == $params['view'])
    {
      $q->addWhere('product.view_show = ?', true);
    }
    
    return $q;
  }

  public function getById($id, array $params = array())
  {
    $q = $this->createBaseQuery($params);

    $q->leftJoin('product.Category productCategory')
      ->leftJoin('product.Creator creator')
      ->leftJoin('product.PropertyRelation productPropertyRelation')
    ;
    
    $this->setQueryParameters($q);
    
    $q->where($q->getRootAlias().'.id = ?', $id);
    
    $q->useResultCache(true, null, $this->getRecordHash($id, $params));
    
    $record = $q->fetchOne();
    if (!$record)
    {
      return $record;
    }
    
    $record['Type'] = ProductTypeTable::getInstance()->getById($record->type_id);
    
    // группировка параметров продукта по свойствам продукта
    $productPropertyRelationArray = array();
    foreach ($record['PropertyRelation'] as $propertyRelation)
    {
      if (!isset($productPropertyRelationArray[$propertyRelation['property_id']]))
      {
        $productPropertyRelationArray[$propertyRelation['property_id']] = array();
      }
      $productPropertyRelationArray[$propertyRelation['property_id']][] = $propertyRelation;
    }

    foreach ($record['Type']['PropertyRelation'] as $propertyRelation)
    {
      //if (!isset($productPropertyRelationArray[$propertyRelation['property_id']]) && null !== $productPropertyRelationArray[$propertyRelation['property_id']]) continue;

      $record['Parameter'][] = new ProductParameter($propertyRelation['Property'], $productPropertyRelationArray[$propertyRelation['property_id']]);
    }
    
    return $record;
  }
}