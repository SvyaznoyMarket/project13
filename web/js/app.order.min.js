$(document).ready(function(){if("order_complete"==$("body").attr("data-template")&&"undefined"!=typeof orderAnalyticsRun&&orderAnalyticsRun(),$(".orderFinal__certificate").length){var e=$(".cardNumber"),t=$(".cardPin"),i=$(".orderFinal__certificate form"),r=$("#sendCard"),a="/certificate-check",n="/certificate-activate",o=function(){function n(e){e>h?h=0:h-=e,$("#paymentWithCard").text(h)}function o(){e.val(""),t.val(""),r.addClass("mDisabled"),m=!1}function s(){return e.val().replace(/[^0-9]/g,"")}function l(){return t.val().replace(/[^0-9]/g,"")}function c(){return{code:s(),pin:l()}}function d(){m&&""!==s()&&14===s().length&&""!==l()&&4===l().length&&r.removeClass("mDisabled")}function u(e){e.match(/\*/)&&r.addClass("mDisabled")}function p(){f("orange","Проверка по номеру карты"),$.post(a,{code:"23846829634"},function(e){if(false in e)return!1;if(!e.success){var t=e.error!==void 0?e.error:"ERROR";return f("red",t),!1}f("green",e.data)}),d(),t.focus()}function f(e,t){var r=$(".process").first();r.hasClass("picked")||r.remove();var a={typeNum:e};switch(e){case"orange":a.text=t,m=!1;break;case"red":a.text="Произошла ошибка: "+t,m=!1;break;case"green":a.text="activated"in t?"Карта "+t.code+" на сумму "+t.sum+" активирована!":"Карта "+t.code+" имеет номинал "+t.sum,m=!0}i.after(tmpl(v,a)),t.activated!==void 0&&$(".process").first().addClass("picked"),d()}var h=1*$("#paymentWithCard").text(),m=!1,v="processBlock";return{activateButton:d,checkCard:p,setProcessingStatus:f,setPaymentSum:n,prepareNewCard:o,getParams:c,checkForStars:u}}();e.mask("999 999 999 9999 9",{completed:o.checkCard,placeholder:"*"}),t.mask("9999",{completed:o.activateButton,placeholder:"*"}),e.bind("keyup",function(){o.checkForStars($(this).val())}),t.bind("keyup",function(){o.checkForStars($(this).val())}),r.bind("click",function(e){return e.preventDefault(),$(this).hasClass("mDisabled")?!1:(o.setProcessingStatus("orange","Минутку, активация карты..."),$.get(n,o.getParams(),function(e){return false in e?!1:e.success?(e.data.activated=!0,o.setProcessingStatus("green",e.data),o.setPaymentSum(1*e.data.sum),o.prepareNewCard(),void 0):(o.setProcessingStatus("red",e.error),!1)}),!1)}),$.mockjax({url:"/certificate-activate",responseTime:1e3,responseText:{success:!0,error:"alredy activated",data:{sum:1e3,code:"3432432"}}})}if($(".auth-link").bind("click",function(e){e.preventDefault();var t=$(this);$("#login-form, #register-form").data("redirect",!1),$("#auth-block").lightbox_me({centered:!0,onLoad:function(){$("#auth-block").find("input:first").focus()},onClose:function(){$.get(t.data("updateUrl"),function(e){if(!0===e.success){var t=$(".order-form");$("#user-block").replaceWith(e.data.content),$.each(e.data.fields,function(e,i){var r=t.find('[name="'+e+'"]');2>r.val().length&&r.val(i)})}})}})}),function(){if($("#product_errors").length){var e=function(e,t,i){var r="tmpErrPopup"+Math.floor(22*Math.random()),a='<div id="'+r+'" class="popup">'+'<div class="popupbox width290">'+'<div class="font18 pb18"> Непредвиденная ошибка</div>'+"</div>"+'<p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>';$("body").append($(a)),$.each(e,function(e,t){$("#"+r).find(".popupbox").append('<div class="font18 pb18"> '+t+"</div>")}),$("#"+r).lightbox_me({centered:!0,closeSelector:".closePopup",onClose:function(){var e=function(t,i){if(t[i]){var r=t[i]+"";$.ajax({url:r}).then(function(){i++,e(t,i)})}else window.location.reload()};$.merge(t,i),e(t,0)}})},t=[],i=[],r=[],a=$("#product_errors").data("value").length;if(a){var n=function(){$.each($("#product_errors").data("value"),function(e,i){708==i.code?i.quantity_available>0?("undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Errors","User error","Нет нужного количества товаров"]),t.push("Вы заказали товар "+i.product.name+" в количестве "+i.product.quantity+" шт. <br/ >Доступно только "+i.quantity_available+" шт.<br/ >Будет заказано "+i.quantity_available+"шт"),r.push(i.product.addUrl)):("undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Errors","User error","Нет товара для выбранного способа доставки"]),t.push("Товара "+i.product.name+" нет в наличии для выбранного способа доставки.<br/>Товар будет удален из корзины.")):("undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Errors","User error","Товар недоступен для продажи"]),t.push("Товар "+i.product.name+" недоступен для продажи.<br/>Товар будет удален из корзины."))}),e(t,i,r)};n()}}}(),function(){function e(){1===r&&(clearInterval(i),$(".form").submit()),r-=1,t.html(r)}var t=$(".timer");if(!t.length)return!1;var i=window.setInterval(e,1e3),r=1*t.html().replace(/\D/g,"")}(),$("#credit-widget").length){var s=$("#credit-widget").data("value");if(!(false in s)){"direct-credit"===s.widget&&$LAB.script("JsHttpRequest.js").script("http://direct-credit.ru/widget/script_utf.js").wait(function(){function e(){dc_getCreditForTheProduct("4427",s.vars.number,"orderProductToBuyOnCredit",{order_id:s.vars.number,region:s.vars.region})}for(var t=s.vars.items.length-1;t>=0;t--){var i=s.vars.items[t];dc_getCreditForTheProduct("4427",s.vars.number,"addProductToBuyOnCredit",{name:i.articul,count:i.quantity,articul:i.articul,price:i.price,type:i.type},function(){e()})}});var l="http://"+window.location.hostname;if("kupivkredit"===s.widget){var c=function(){setTimeout(function(){document.location=l},3e3)},d=function(){};$LAB.script("https://www.kupivkredit.ru/widget/vkredit.js").wait(function(){var e=new VkreditWidget(1,s.vars.sum,{order:s.vars.order,sig:s.vars.sig,callbackUrl:window.location.href,onClose:c,onDecision:d});e.openWidget()})}}}});