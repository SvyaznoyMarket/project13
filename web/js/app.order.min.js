$(document).ready(function(){function e(b){var b=(b+"").split("."),c=b[0],a=b[0].length;6<a?c=c.substr(0,a-6)+" "+c.substr(a-6,a-4)+" "+c.substr(a-3,a):3<a&&(c=c.substr(0,a-3)+" "+c.substr(a-3,a));2==b.length&&(c+="."+b[1]);return c}function h(b){var c=$('<span class="rubl">p</span>'),a=b.split(","),d=0;"undefined"!==typeof a[1]&&a[1].match(/\d+/)&&(d=a[1].match(/\d+/)[0]);b=1*$("div.cheque div.total").find("strong").text().replace(/\D+/g,"")+1*d;$("#dlvrbill").length&&(b-=1*$("#dlvrbill").find("strong").text().replace(/\D+/g,
""),$("#dlvrbill").remove());d&&(a=$("<li>").attr("id","dlvrbill").append($("<div>").text(a[0])).append($("<strong>").text(e(d)+" ").append('<span class="rubl">p</span>')),$("div.cheque ul").append(a));$("div.cheque div.total").find("strong").empty().text(e(b)+" ").append(c)}function f(b){3==b?($(".shop_block").show(),$(".delivery_block").hide(),$(".deliverytext").html("Представьтесь:"),$("#delivered_at_block label").html("Выберите дату:")):($(".shop_block").hide(),$(".delivery_block").show(),$(".deliverytext").html("Кому и куда доставить:"),
$("#delivered_at_block label").html("Выберите дату доставки:"));4==b?($("#order_payment_method_id_1").parent().hide(),$("#order_payment_method_id_2").parent().hide()):$(".checkboxlist2 li:hidden").show();$("#order_shop_id").trigger("change")}$("#order_delivery_type_id_4").parent().css("color","#E8303A").find("div").removeClass("font11");var i=$(".order-form").find('[name="order[delivery_type_id]"]:checked');f(i.val());$('<img src="/images/ajaxnoti.gif" />').css("display","none").appendTo("body");
$("<div>").html('<div><img src="/images/ajaxnoti.gif" /></br></br> Ваш заказ оформляется</div>').attr("id","noti").appendTo("body");var g=!1;$(".order-form").submit(function(b){if(g)return!0;b.preventDefault();g=!0;$(this).find(":submit").val("Оформляется...");$("#noti").lightbox_me({centered:!0,closeClick:!1,closeEsc:!1});setTimeout(function(){$(".order-form").trigger("submit")},500)});$(".order-form").change(function(b){var c=$(this);if("order[shop_id]"==$(b.target).attr("name")){var a=$(b.target).find("option:selected");
if(!a.length)return;$.post(c.data("updateFieldUrl"),{order:{delivery_type_id:c.find('[name="order[delivery_type_id]"]:checked').val(),shop_id:a.val()},field:"delivered_at"},function(a){var b=c.find('[name="order[delivered_at]"]');b.empty();$.each(a.data.content,function(a,c){b.append('<option value="'+a+'">'+c+"</option>")});b.find(":first").attr("selected","selected");b.change()})}if("order[region_id]"==$(b.target).attr("name")){var a=$(b.target).find("option:selected"),d=$("form#region");d.attr("action",
a.data("url"));d.submit()}"order[delivery_type_id]"==$(b.target).attr("name")&&(a=c.find('[name="order[delivery_type_id]"]:checked'),a.length&&(h(a.next().find("strong").text()),f(a.val()),b=a.val(),4==b&&(b=3),$.post(c.data("updateFieldUrl"),{order:{delivery_type_id:b},field:"delivery_period_id"},function(a){if("undefined"!==typeof a.success&&a.success){var b=$('[name="order[delivery_period_id]"]');b.empty();$.each(a.data.content,function(a,c){b.append('<option value="'+a+'">'+c+"</option>")});b.find(":first").attr("selected",
"selected");b.change()}},"json")))});$("#order_shop_id").trigger("change");$(".order_user_address").bind("change",function(){var b=$(this);$('[name="order[address]"]').val(b.val())});$("#basic_register-form").bind({submit:function(b){b.preventDefault();var c=$(this);c.ajaxSubmit({beforeSubmit:function(){var a=c.find("input:submit");a.attr("disabled",!0);a.attr("value","Запоминаю...")},success:function(a){!0!==a.success?c.find(".form-content:first").html(a.data.form):window.location=a.redirect},complete:function(){var a=
c.find("input:submit");a.attr("disabled",!1);a.attr("value","Запомнить меня")}})}});$(".auth-link").bind("click",function(b){b.preventDefault();var c=$(this);$("#login-form, #register-form").data("redirect",!1);$("#auth-block").lightbox_me({centered:!0,onLoad:function(){$("#auth-block").find("input:first").focus()},onClose:function(){$.get(c.data("updateUrl"),function(a){if(!0===a.success){var b=$(".order-form");$("#user-block").replaceWith(a.data.content);$.each(a.data.fields,function(a,c){var e=
b.find('[name="'+a+'"]');2>e.val().length&&e.val(c)})}})}})});(function(){var b=$(".timer");if(!b.length)return!1;var c=window.setInterval(function(){1===a&&(clearInterval(c),$("form").submit());a-=1;b.html(a)},1E3),a=1*b.html().replace(/\D/g,"")})()});
