$(document).ready(function(){var e=window._gaq||[];if($(".orderFinal__certificate").length){var t=$(".cardNumber"),n=$(".cardPin"),r=$(".orderFinal__certificate form"),i=$("#sendCard"),s="/certificate-check",o="/certificate-activate",u=function(){function a(t){t>e?e=0:e-=t,$("#paymentWithCard").text(e)}function f(){t.val(""),n.val(""),i.addClass("mDisabled"),o=!1}function l(){return t.val().replace(/[^0-9]/g,"")}function c(){return n.val().replace(/[^0-9]/g,"")}function h(){return{code:l(),pin:c()}}function p(){o&&l()!==""&&l().length===14&&c()!==""&&c().length===4&&i.removeClass("mDisabled")}function d(e){e.match(/\*/)&&i.addClass("mDisabled")}function v(){m("orange","Проверка по номеру карты"),$.post(s,{code:"23846829634"},function(e){if(!1 in e)return!1;if(!e.success){var t=typeof e.error!="undefined"?e.error:"ERROR";return m("red",t),!1}m("green",e.data)}),p(),n.focus()}function m(e,t){var n=$(".process").first();n.hasClass("picked")||n.remove();var i={typeNum:e};switch(e){case"orange":i.text=t,o=!1;break;case"red":i.text="Произошла ошибка: "+t,o=!1;break;case"green":"activated"in t?i.text="Карта "+t.code+" на сумму "+t.sum+" активирована!":i.text="Карта "+t.code+" имеет номинал "+t.sum,o=!0}r.after(tmpl(u,i)),typeof t["activated"]!="undefined"&&$(".process").first().addClass("picked"),p()}var e=$("#paymentWithCard").text()*1,o=!1,u="processBlock";return{activateButton:p,checkCard:v,setProcessingStatus:m,setPaymentSum:a,prepareNewCard:f,getParams:h,checkForStars:d}}();t.mask("999 999 999 9999 9",{completed:u.checkCard,placeholder:"*"}),n.mask("9999",{completed:u.activateButton,placeholder:"*"}),t.bind("keyup",function(){u.checkForStars($(this).val())}),n.bind("keyup",function(){u.checkForStars($(this).val())}),i.bind("click",function(e){return e.preventDefault(),$(this).hasClass("mDisabled")?!1:(u.setProcessingStatus("orange","Минутку, активация карты..."),$.get(o,u.getParams(),function(e){if(!1 in e)return!1;if(!e.success)return u.setProcessingStatus("red",e.error),!1;e.data.activated=!0,u.setProcessingStatus("green",e.data),u.setPaymentSum(e.data.sum*1),u.prepareNewCard()}),!1)}),$.mockjax({url:"/certificate-activate",responseTime:1e3,responseText:{success:!0,error:"alredy activated",data:{sum:1e3,code:"3432432"}}})}$(".auth-link").bind("click",function(e){e.preventDefault();var t=$(this);$("#login-form, #register-form").data("redirect",!1),$("#auth-block").lightbox_me({centered:!0,onLoad:function(){$("#auth-block").find("input:first").focus()},onClose:function(){$.get(t.data("updateUrl"),function(e){if(!0===e.success){var t=$(".order-form");$("#user-block").replaceWith(e.data.content),$.each(e.data.fields,function(e,n){var r=t.find('[name="'+e+'"]');r.val().length<2&&r.val(n)})}})}})}),function(){if(!$("#product_errors").length)return;var t=function(e,t,n){var r='<div id="orderErrPopup" class="popup"><div class="popupbox width290"><div class="font18 pb18"> '+t+"</div>"+"</div>"+'<p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>';"</div> ",$("body").append($(r)),$("#orderErrPopup").lightbox_me({centered:!0,closeSelector:".closePopup",onClose:function(){n()}})},n=$("#product_errors").data("value").length;if(n){var r=function(){var r=$.Deferred();return $.each($("#product_errors").data("value"),function(i,s){708==s.code?s.quantity_available>0?(e.push(["_trackEvent","Errors","User error","Нет нужного количества товаров"]),t("Непредвиденная ошибка","Вы заказали товар "+s.product.name+" в количестве "+s.product.quantity+" шт. <br/ >Доступно только "+s.quantity_available+" шт.<br/ >Будет заказано "+s.quantity_available+"шт",function(){$.ajax({url:s.product.deleteUrl}).done(function(e){$.ajax({url:s.product.addUrl}).done(function(){i+1==n&&r.resolve()})})})):(e.push(["_trackEvent","Errors","User error","Нет товара для выбранного способа доставки"]),t("Непредвиденная ошибка","Товара "+s.product.name+" нет в наличии для выбранного способа доставки.<br/>Товар будет удален из корзины.",function(){$.ajax({url:s.product.deleteUrl}).done(function(e){i+1==n&&r.resolve()})})):(e.push(["_trackEvent","Errors","User error","Товар недоступен для продажи"]),t("Непредвиденная ошибка","Товар "+s.product.name+" недоступен для продажи.<br/>Товар будет удален из корзины.",function(){$.ajax({url:s.product.deleteUrl}).done(function(){i+1==n&&r.resolve()})}))}),r.promise()};$.when(r()).done(function(){window.location.reload()})}}(),function(){function r(){n===1&&(clearInterval(t),$(".form").submit()),n-=1,e.html(n)}var e=$(".timer");if(!e.length)return!1;var t=window.setInterval(r,1e3),n=e.html().replace(/\D/g,"")*1}();if(!$("#credit-widget").length)return;var a=$("#credit-widget").data("value");if(!1 in a)return;a.widget==="direct-credit"&&$LAB.script("JsHttpRequest.js").script("http://direct-credit.ru/widget/script_utf.js").wait(function(){function n(){dc_getCreditForTheProduct("4427",a.vars.number,"orderProductToBuyOnCredit",{order_id:a.vars.number})}for(var e=a.vars.items.length-1;e>=0;e--){var t=a.vars.items[e];dc_getCreditForTheProduct("4427",a.vars.number,"addProductToBuyOnCredit",{name:t.articul,count:t.quantity,articul:t.articul,price:t.price,type:t.type},function(e){n()})}});var f="http://"+window.location.hostname;if(a.widget==="kupivkredit"){var l=function(e){setTimeout(function(){document.location=f},3e3)},c=function(e){};$LAB.script("https://www.kupivkredit.ru/widget/vkredit.js").wait(function(){var e=new VkreditWidget(1,a.vars.sum,{order:a.vars.order,sig:a.vars.sig,callbackUrl:window.location.href,onClose:l,onDecision:c});e.openWidget()})}});