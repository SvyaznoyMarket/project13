var DKupe3dConstructor=function(ParentItem,HostImgs,HostTextures){function Initialize(e){var t=navigator.userAgent.match(/MSIE ([\d\.]+)/);t&&(MSIE=parseFloat(t[1])),MainDiv=document.createElement("DIV"),MainDiv.setAttribute("id","Planner3d_MainDiv"),MainDiv.style.position="relative",ParentItem.appendChild(MainDiv),MainDiv.innerHTML='<div id="Planner3d_tab_info" style="color: #666666;font-family:\'Enter Type Bold\';font-size:18px;position: absolute;top: 0px;left: 50%;width: 200px;position:absolute;z-index: 100;display:none;">	<table cellpadding=0 cellspacing=0 width=250>	<tr><td height=25 id=Planner3d_TabInfo1Header width=120 align=center>Выбор корпуса</td><td height=25 width=5>&nbsp;</td><td id=Planner3d_TabInfo2Header width=120 align=center>Выбор фасада</td></tr>	<tr><td id=Planner3d_KorpusVariantsDiv height=80 colspan=3 style="padding-left:5px;border:1px solid #c1c1bf;"></td></tr>	<tr><td id=Planner3d_TabInfo colspan=3 height=183 valign=top style="padding-top:5px;padding-bottom:5px;padding-left:5px;border-left:1px solid #c1c1bf;border-right:1px solid #c1c1bf;border-bottom:1px solid #c1c1bf;">	<div id=Planner3d_TabInfo1 style="display:none;">&nbsp;</div><div id=Planner3d_TabInfo2 style="display:none;">	<font style="font-family:\'Enter Type\';color:#000000;font-size:13px;">Выбор цвета вставки</font><br>	<div id="Planner3d_scrollcontent"></div></div></td></tr>	<tr><td id=Planner3d_LampVariantsDiv height=80 colspan=4 style="padding-left:5px;border-left:1px solid #c1c1bf;border-right:1px solid #c1c1bf;border-bottom:1px solid #c1c1bf;"></td></tr>	<tr><td id=Planner3d_ProfileVariantsDiv height=80 colspan=4 style="padding-left:5px;border-left:1px solid #c1c1bf;border-right:1px solid #c1c1bf;border-bottom:1px solid #c1c1bf;"></td></tr>	</table></div>',document.getElementById("Planner3d_TabInfo1Header").addEventListener("click",ActivateTab1,!1),document.getElementById("Planner3d_TabInfo2Header").addEventListener("click",ActivateTab2,!1),PopupMenuDiv=document.createElement("DIV"),PopupMenuDiv.style.position="absolute",PopupMenuDiv.style.zIndex="200",PopupMenuDiv.style.display="none",PopupMenuDiv.addEventListener("mouseover",showPopupMenu,!1),PopupMenuDiv.addEventListener("mouseout",OnPopupOut,!1),MainDiv.appendChild(PopupMenuDiv),ButtColorPicker=document.createElement("DIV"),ButtColorPicker.style.position="absolute",ButtColorPicker.style.cursor="pointer",ButtColorPicker.style.display="none",ButtColorPicker.innerHTML='<img src="'+HostImgs+'icon_colorpicker.png" width=27 height=26 border=0>',ButtColorPicker.addEventListener("mousedown",stopStart,!1),ButtColorPicker.addEventListener("click",OnClickSmallButtColorPicker,!1),MainDiv.appendChild(ButtColorPicker),progDAnim=new DAnimProgressBar(0),progDAnim.Initialize(MainDiv,Window3dWidth,Window3dHeight);var i=new XMLHttpRequest;i.addEventListener("load",onMainData,!1),i.addEventListener("progress",onMainDataProgress,!1),i.open("GET",e,!0),i.send(null)}function Uninitialize(){}function onMainData(e){progDAnim&&progDAnim.doDraw(progDAnim.width),MainJsonText=e.target.responseText,setTimeout(init,1)}function onMainDataProgress(e){e.lengthComputable&&(e.loaded/e.total,progDAnim&&progDAnim.doDraw(progDAnim.width*e.loaded/e.total))}function ArrayHasItem(e,t){for(var i=0;e.length>i;i++)if(e[i]==t)return 1;return 0}function NormAngle(e){for(var t=e;Math.abs(t)>3.1415927;)t>0?t-=6.2831852:t+=6.2831852;return t}function rgb2hex(e){return(255*e[0]<<16)+(255*e[1]<<8)+255*e[2]}function LoadMaterialByName(e){if(void 0!==MatLib[e])return MatLib[e];var t=GetMaterial(e);if(t){var i=MyCreateMaterial(t);return MatLib[e]=i,i}var a={};return a.color=15790320,new THREE.MeshLambertMaterial(a)}function MyCreateMaterial(e){var t={};if(!e.colorDiffuse||e.mapDiffuse&&e.mapDiffuse.length||(t.color=rgb2hex(e.colorDiffuse)),e.colorSpecular&&(t.specular=rgb2hex(e.colorSpecular)),e.colorAmbient&&(t.ambient=rgb2hex(e.colorAmbient)),e.transparency&&(t.opacity=e.transparency),e.specularCoef&&(t.shininess=e.specularCoef),e.mapDiffuse&&(t.map=THREE.ImageUtils.loadTexture(HostTextures+e.mapDiffuse),t.map.wrapS=THREE.RepeatWrapping,t.map.wrapT=THREE.RepeatWrapping,e.mapDiffuseScale&&t.map.repeat.set(e.mapDiffuseScale[0],e.mapDiffuseScale[1]),e.mapDiffuseOffset&&t.map.offset.set(e.mapDiffuseOffset[0],e.mapDiffuseOffset[1])),e.cubeMap){var i=THREE.ImageUtils.loadTextureCube(e.cubeMap);i.format=THREE.RGBFormat,t.envMap=i,t.combine=THREE.MixOperation,t.reflectivity=.3}return new THREE.MeshPhongMaterial(t)}function FindAllArts(e,t){for(var i=0;t.length>i;i++){var a=t[i].api_id;if(a.length){var n=a.indexOf("/");n>0&&(a=a.substring(0,n)),ArrayHasItem(e,a)||e.push(a)}}}function init(){if(MainJsonData=JSON.parse(MainJsonText)){if(!MSIE||MSIE>=11){var e=document.createElement("DIV");e.setAttribute("id","RotateL"),e.innerHTML='<img draggable="false" src="'+HostImgs+'rotate_left.png" width=35 height=43 border=0>',MainDiv.appendChild(e),e.addEventListener("mousedown",OnPressSmallButtRotateL,!1),e.style.position="absolute",e.style.cursor="pointer";var t=document.createElement("DIV");t.setAttribute("id","RotateC"),t.innerHTML='<img draggable="false" src="'+HostImgs+'rotate_center.png" width=51 height=47 border=0>',MainDiv.appendChild(t),t.style.position="absolute";var i=document.createElement("DIV");i.setAttribute("id","RotateR"),i.innerHTML='<img draggable="false" src="'+HostImgs+'rotate_right.png" width=35 height=43 border=0>',MainDiv.appendChild(i),i.addEventListener("mousedown",OnPressSmallButtRotateR,!1),i.style.position="absolute",i.style.cursor="pointer";var a=document.createElement("DIV");a.setAttribute("id","ZoomOut"),a.innerHTML='<img draggable="false" src="'+HostImgs+'zoom_out.png" width=41 height=39 border=0>',MainDiv.appendChild(a),a.addEventListener("mousedown",OnPressSmallButtZoomOut,!1),a.style.position="absolute",a.style.cursor="pointer";var n=document.createElement("DIV");n.setAttribute("id","ZoomIn"),n.innerHTML='<img draggable="false" src="'+HostImgs+'zoom_in.png" width=41 height=39 border=0>',MainDiv.appendChild(n),n.addEventListener("mousedown",OnPressSmallButtZoomIn,!1),n.style.position="absolute",n.style.cursor="pointer",e.style.top=Window3dHeight+10+"px",e.style.left=Window3dWidth/2-20-35+"px",i.style.top=Window3dHeight+10+"px",i.style.left=Window3dWidth/2+33+"px",t.style.left=Window3dWidth/2-20+"px",t.style.top=Window3dHeight+10+"px",a.style.left="0px",a.style.top="0px",n.style.left="0px",n.style.top="50px"}if(MainJsonData.articuls){for(var r=[],o=0;MainJsonData.korpuses.length>o;o++)for(var s=0;MainJsonData.articuls.korpuses.length>s;s++)if(MainJsonData.korpuses[o].name==MainJsonData.articuls.korpuses[s].name){r.push(MainJsonData.korpuses[o]);break}MainJsonData.korpuses=r}MainJsonText=void 0,progDAnim&&progDAnim.Uninitialize(),container=document.createElement("div"),MainDiv.appendChild(container),document.body.addEventListener("drop",onDropHandler,!1),document.body.addEventListener("dragenter",onDragEnter,!1),document.body.addEventListener("dragover",onDragOver,!1),camera=new THREE.PerspectiveCamera(10,Window3dWidth/Window3dHeight,1,2e3),camera.position.x=0,camera.position.y=1.2,camera.position.z=cameraDistance,scene=new THREE.Scene;var l=new THREE.AmbientLight(5000268);scene.add(l);var c=new THREE.DirectionalLight(10066329);c.position.set(1,0,0).normalize(),scene.add(c);var d=new THREE.DirectionalLight(8355711);d.position.set(-1,0,0).normalize(),scene.add(d);var u=new THREE.DirectionalLight(5855577);u.position.set(0,1,0).normalize(),scene.add(u);var p=new THREE.DirectionalLight(7500402);p.position.set(0,-1,0).normalize(),scene.add(p);var h=new THREE.DirectionalLight(10066329);h.position.set(0,0,1).normalize(),scene.add(h);var f=new THREE.DirectionalLight(10066329);f.position.set(0,0,-1).normalize(),scene.add(f);var m=new THREE.CubeGeometry(600,600,5);floormesh=new THREE.Mesh(m,new THREE.MeshBasicMaterial({color:13421772})),floormesh.position.y=-2.5,floormesh.rotation.x=90*Math.PI/180,Korpus3dHolder=new THREE.Object3D,scene.add(Korpus3dHolder),Lamp3dHolder=new THREE.Object3D,scene.add(Lamp3dHolder);for(var o=0;Doors3dHoldersMax>o;o++){var v=new THREE.Object3D;Doors3dHolders[o]=v,scene.add(v)}for(var o=0;Doors3dHoldersMax>o;o++)KupeParams.doors[o]={},KupeParams.doors[o].materials=["","","",""];projector=new THREE.Projector,mouse2D=new THREE.Vector3(0,1e4,.5),loader=new THREE.JSONLoader,void 0==KupeParams.KorpusName&&(KupeParams.KorpusName=MainJsonData.korpuses[0].name),void 0==KupeParams.KorpusMaterial&&(KupeParams.KorpusMaterial=GetKorpusPossibleMaterials(KupeParams.KorpusName)[0]),void 0==KupeParams.ProfileMaterial&&(KupeParams.ProfileMaterial=GetProfilePossibleMaterials(KupeParams.KorpusName)[0]),void 0==KupeParams.Lamp&&(KupeParams.Lamp=0),CreateFullKupe(),UpdateKorpusesDiv();var g=document.getElementById("Planner3d_tab_info");if(g.style.display="block",g.style.left=Window3dWidth+20+"px",g.style.height=Window3dHeight+"px",ActivateTab(1),renderer=!MSIE||MSIE>=11?new THREE.WebGLRenderer({antialias:!0}):new THREE.CanvasRenderer,renderer.setSize(Window3dWidth,Window3dHeight),container.appendChild(renderer.domElement),renderer.domElement.style.borderBottom="2px solid #c1c1bf",stats=null,document.body.addEventListener("mousewheel",onMouseWheel,!1),document.addEventListener("mousedown",onDocumentMouseDown,!1),document.addEventListener("touchstart",onDocumentTouchStart,!1),document.addEventListener("touchmove",onDocumentTouchMove,!1),document.addEventListener("mousemove",onDocumentMouseMove,!1),document.onselectstart=_onFinishStart,document.oncontextmenu=_onFinishStart,animate(),MainJsonData.articuls){for(var b=[],y=0;MainJsonData.articuls.korpuses.length>y;y++)FindAllArts(b,MainJsonData.articuls.korpuses[y].variants);for(var $=0;MainJsonData.articuls.vstavki.length>$;$++)FindAllArts(b,MainJsonData.articuls.vstavki[$].variants);for(var k=0;MainJsonData.articuls.profiles.length>k;k++)FindAllArts(b,MainJsonData.articuls.profiles[k].variants);for(var s=0;MainJsonData.articuls.doors.length>s;s++)for(var w=0;MainJsonData.articuls.doors[s].types.length>w;w++)FindAllArts(b,MainJsonData.articuls.doors[s].types[w].variants);Planner3d_Init(b),UpdatePrice()}}}function AppendSceneApiIdsIds(e,t,i){for(var a=0;t.length>a;a++)if(t[a].color==i){var n=t[a].api_id;if(n.length){var r=n.indexOf("/");if(r>0&&"/2"==n.substring(r))for(var o=0;e.length>o;o++)if(e[o]==n)return e[o]=n.substring(0,r),void 0;e.push(n)}}}function UpdatePrice(){for(var e=[],t=0;MainJsonData.articuls.korpuses.length>t;t++)if(MainJsonData.articuls.korpuses[t].name==KupeParams.KorpusName){AppendSceneApiIdsIds(e,MainJsonData.articuls.korpuses[t].variants,KupeParams.KorpusMaterial);break}var i=GetKorpusByName(KupeParams.KorpusName);if(i){for(var t=0;MainJsonData.articuls.profiles.length>t;t++)if(i.width==MainJsonData.articuls.profiles[t].width){AppendSceneApiIdsIds(e,MainJsonData.articuls.korpuses[t].variants,KupeParams.ProfileMaterial);break}for(var t=0;MainJsonData.articuls.doors.length>t;t++)if(MainJsonData.articuls.doors[t].name==i.doors.type){for(var a=0;KupeParams.nDoors>a;a++)for(var n=0;MainJsonData.articuls.doors[t].types.length>n;n++)if(MainJsonData.articuls.doors[t].types[n].type==KupeParams.doors[a].variantType){AppendSceneApiIdsIds(e,MainJsonData.articuls.doors[t].types[n].variants,KupeParams.ProfileMaterial);break}break}var r=GetDoorByType(KupeParams.DoorsType);if(r)for(var a=0;KupeParams.nDoors>a;a++){for(var o=null,s=0;r.variants.length>s&&null==o;s++)r.variants[s].type==KupeParams.doors[a].variantType&&(o=r.variants[s].sections);if(o)for(var l=0;KupeParams.doors[a].sections.length>l;l++)for(var c=0;MainJsonData.articuls.vstavki.length>c;c++)if(MainJsonData.articuls.vstavki[c].width==r.width&&MainJsonData.articuls.vstavki[c].height==o[l].height){AppendSceneApiIdsIds(e,MainJsonData.articuls.vstavki[c].variants,KupeParams.doors[a].materials[l]);break}}}for(var d=[],s=0;e.length>s;s++){api_id=e[s];var t=api_id.indexOf("/");t>0?d.push({id:parseInt(api_id.substring(0,t)),error:"Вставки продаютя только комплектом по 2шт!"}):d.push({id:parseInt(api_id),error:""})}Planner3d_UpdatePrice(d)}function OnShapeLoaded(e,t,i,a){var n=new THREE.Mesh(i,new THREE.MeshFaceMaterial(a));if("Korpus"==e)Korpus3dHolder.add(n);else if("Lamp"==e)for(var r=0;Lamp3dHolder.children.length>r;r++)KupeParams.Lamp||(n.visible=!1),Lamp3dHolder.children[r].add(0==r?n:n.clone());else for(var r=0;Doors3dHoldersMax>r;r++)if(e=="Door"+r)return 1==iActiveTab&&(n.visible=!1),Doors3dHolders[r].add(n),void 0}function ActivateTab1(){ActivateTab(1)}function ActivateTab2(){ActivateTab(2)}function ActivateTab(e){iActiveTab=e,DoActivateTab("TabInfo"+e,"TabInfo"+(3-e));for(var t=0;KupeParams.nDoors>t;t++)for(var i=0;Doors3dHolders[t].children.length>i;i++)Doors3dHolders[t].children[i].visible=1==iActiveTab?!1:!0;1==iActiveTab&&(ButtColorPicker.style.display="none"),document.getElementById("Planner3d_KorpusVariantsDiv").height=1==iActiveTab?90:57,document.getElementById("Planner3d_TabInfo").height=1==iActiveTab?160:195;var a="";if(1==iActiveTab){a="<font style=\"font-family:'Enter Type';color:#000000;font-size:13px;\">Выбор цвета корпуса</font><br>",a+="<table cellpadding=0 cellspacing=0 onclick=\"Planner3dKupeConstructor.SetKorpusMaterial('',event)\">",a+="<tr>";for(var n=GetKorpusPossibleMaterials(KupeParams.KorpusName),i=0;n.length>i;i++){var r=GetMaterial(n[i]);r&&(a+="<td onmouseover=\"Planner3dKupeConstructor.showPopupMenu('mat_"+n[i]+'\')" onmouseout="Planner3dKupeConstructor.OnPopupOut()" width='+(iconSize+4)+" height="+(iconSize+4)+' valign=middle align=center style="',a+="border:2px solid "+(KupeParams.KorpusMaterial==n[i]?"#ff9e18;":"#ffffff;"),a+='">',a+='<div id="mat_'+n[i]+'" style="width:'+iconSize+"px;height:"+iconSize+"px;background-image:url("+r.icon+');cursor:pointer;" title="'+r.description+'"></div>',a+="</td>")}a+="</tr>",a+="</table>"}if(2==iActiveTab){a+="<table cellpadding=0 cellspacing=0 onclick=\"Planner3dKupeConstructor.SetCurrentVstavkaMaterial('',event)\">",a+="<tr>";var n=GetVstavkaPossibleMaterials(KupeParams.DoorsType);ArrayHasItem(n,CurrentVstavkaMaterial)||(CurrentVstavkaMaterial=n[0]);for(var i=0;n.length>i;i++){i>0&&0==i%4&&(a+="</tr><tr>");var r=GetMaterial(n[i]);r&&(a+="<td onmouseover=\"Planner3dKupeConstructor.showPopupMenu('mat_"+n[i]+'\')" onmouseout="Planner3dKupeConstructor.OnPopupOut()" width='+(iconSize+4)+" height="+(iconSize+4)+' valign=middle align=center style="',a+="border:2px solid "+(CurrentVstavkaMaterial==n[i]?"#ff9e18;":"#ffffff;"),a+='">',a+='<div draggable="true" id="mat_'+n[i]+'" style="width:'+iconSize+"px;height:"+iconSize+"px;background-image:url("+r.icon+');cursor:pointer;" ondragstart="Planner3dKupeConstructor.onDragMatStart(\''+n[i]+'\', event)" ondragend="Planner3dKupeConstructor.onDragMatEnd()"  title="'+r.description+'"></div>',a+="</td>")}a+="</tr>",a+="</table>"}1==iActiveTab?document.getElementById("Planner3d_TabInfo"+iActiveTab).innerHTML=a:document.getElementById("Planner3d_scrollcontent").innerHTML=a,a=1==iActiveTab?"<font style=\"font-family:'Enter Type';color:#000000;font-size:13px;\">Выбор цвета профиля</font><br>":"<font style=\"font-family:'Enter Type';color:#000000;font-size:13px;\">Выбор цвета рамки</font><br>",a+="<table cellpadding=0 cellspacing=0>",a+="<tr>";for(var n=GetProfilePossibleMaterials(KupeParams.KorpusName),i=0;n.length>i;i++){var o=50,s=42,r=GetMaterial(n[i]);r&&(a+="<td width="+(o+6)+" height="+(s+6)+' valign=middle align=center style="',a+=KupeParams.ProfileMaterial==n[i]?"border:2px solid #ff9e18;":"border:2px solid #ffffff;",a+='">',a+='<img ondragstart="Planner3dKupeConstructor.stopStart(event)" onclick="Planner3dKupeConstructor.SetProfileMaterial(\''+n[i]+"',event)\" width="+o+" height="+s+' src="'+r.icon+'" title="'+r.description+'">',a+="</td>")}a+="</tr>",a+="</table>",document.getElementById("Planner3d_ProfileVariantsDiv").innerHTML=a,GetKorpusByName(KupeParams.KorpusName),MainJsonData.articuls.lamps&&(a="<font style=\"font-family:'Enter Type';color:#000000;font-size:13px;\">Подсветка</font><br>",a+="<table cellpadding=0 cellspacing=0>",a+="<tr>",a+='<td valign=middle align=center style="',a+=KupeParams.Lamp?"border:2px solid #ff9e18;":"border:2px solid #ffffff;",a+='">',a+='<img ondragstart="Planner3dKupeConstructor.stopStart(event)" onclick="Planner3dKupeConstructor.SwitchLamp(event)" width='+o+" height="+s+' src="'+HostImgs+'lamp.png">',a+="</td>",a+="</tr>",a+="</table>",document.getElementById("Planner3d_LampVariantsDiv").innerHTML=a),UpdateKorpusesDiv()}function UnborderTableCells(e,t){for(var i=e.rows,a=0;i.length>a;a++)for(var n=i.item(a).cells,r=0;n.length>r;r++){var o=n.item(r);o&&o!=t&&(o.style.borderColor="#FFFFFF")}}function SetKorpusMaterial(e,t){if(SetKorpusMaterial.arguments.length>=2){if("DIV"!=t.target.tagName||"mat_"!=t.target.id.substring(0,4))return;e=t.target.id.substring(4)}var i=GetMaterial(e);if(i&&(Korpus3dHolder.children[0].material=LoadMaterialByName(e),KupeParams.KorpusMaterial=e,SetKorpusMaterial.arguments.length>=2)){var a=t.target?t.target.offsetParent:null;"TD"==a.tagName&&(UnborderTableCells(a.offsetParent,a),a.style.borderColor="#ff9e18")}SetKorpusMaterial.arguments.length>=2&&UpdatePrice()}function SetCurrentVstavkaMaterial(e,t){if(SetCurrentVstavkaMaterial.arguments.length>=2){if("DIV"!=t.target.tagName&&"IMG"!=t.target.tagName||"mat_"!=t.target.id.substring(0,4))return;e=t.target.id.substring(4),LoadMaterialByName(e)}if(CurrentVstavkaMaterial=e,SetCurrentVstavkaMaterial.arguments.length>=2){var i=t.target?t.target.offsetParent:null;"TD"==i.tagName&&(UnborderTableCells(i.offsetParent,i),i.style.borderColor="#ff9e18")}}function SetProfileMaterial(e,t){var i=LoadMaterialByName(e);Korpus3dHolder.children[1].material=i,KupeParams.ProfileMaterial=e;for(var a=0;KupeParams.nDoors>a;a++)Doors3dHolders[a].children.length>0&&(Doors3dHolders[a].children[0].material=i);if(SetProfileMaterial.arguments.length>=2){var n=t.target?t.target.offsetParent:null;"TD"==n.tagName&&(UnborderTableCells(n.offsetParent,n),n.style.borderColor="#ff9e18"),UpdatePrice()}}function SwitchLamp(e){if(KupeParams.Lamp=1-KupeParams.Lamp,SwitchLamp.arguments.length>=1){var t=e.target?e.target.offsetParent:null;"TD"==t.tagName&&(t.style.borderColor=KupeParams.Lamp?"#ff9e18":"#ffffff")}for(var i=0;Lamp3dHolder.children.length>i;i++)for(var a=0;Lamp3dHolder.children[i].children.length>a;a++)Lamp3dHolder.children[i].children[a].visible=KupeParams.Lamp?!0:!1}function DoActivateTab(){for(var e=0;DoActivateTab.arguments.length>e;e++){var t=document.getElementById("Planner3d_"+DoActivateTab.arguments[e]),i=document.getElementById("Planner3d_"+DoActivateTab.arguments[e]+"Header");t&&i&&(i.style.borderBottom=0==e?"2px #ff9e18 solid":"0px",t.style.display=0==e?"block":"none",i.style.color=0==e?"#000000":"#666666",i.style.cursor=0==e?"default":"pointer",i.style.fontWeight=0==e?"bold":"normal")}}function GetKorpusPossibleMaterials(e){if(MainJsonData.articuls){for(var t=0;MainJsonData.articuls.korpuses.length>t;t++)if(MainJsonData.articuls.korpuses[t].name==e)return GetColorsArrayFromVariants(MainJsonData.articuls.korpuses[t].variants);return["oak_milk"]}return["oak_milk","oak_ferrara","apple_locarno"]}function GetVstavkaPossibleMaterials(e,t,i){var a=[];if(MainJsonData.articuls){var n=GetDoorByType(e),r=0;if(t)for(var o=GetDoorVariants(n),s=0;o.length>s;s++)if(o[s].type==t){r=o[s].sections[i].height;break}for(var l=[],c=0;MainJsonData.articuls.vstavki.length>c;c++)if(MainJsonData.articuls.vstavki[c].width==n.width&&(0==r||MainJsonData.articuls.vstavki[c].height==r))for(var d=0;MainJsonData.articuls.vstavki[c].variants.length>d;d++)ArrayHasItem(l,MainJsonData.articuls.vstavki[c].variants[d].color)||l.push(MainJsonData.articuls.vstavki[c].variants[d].color);for(var s=0;MainJsonData.materials.length>s;s++)ArrayHasItem(l,MainJsonData.materials[s].name)&&a.push(MainJsonData.materials[s].name)}else for(var s=0;MainJsonData.materials.length>s;s++)0!=MainJsonData.materials[s].name.indexOf("Profile")&&a.push(MainJsonData.materials[s].name);return a}function GetColorsArrayFromVariants(e){for(var t=[],i=0;e.length>i;i++)t.push(e[i].color);return t}function GetProfilePossibleMaterials(e){if(MainJsonData.articuls){var t=GetKorpusByName(e);if(t)for(var i=0;MainJsonData.articuls.profiles.length>i;i++)if(t.width==MainJsonData.articuls.profiles[i].width)return GetColorsArrayFromVariants(MainJsonData.articuls.profiles[i].variants);return["ProfileSilver"]}return["ProfileSilver","ProfileBronza","ProfileZoloto","ProfileShampan"]}function GetMaterial(e){for(var t=0;MainJsonData.materials.length>t;t++)if(MainJsonData.materials[t].name==e)return MainJsonData.materials[t]}function GetDoorVariant(e,t){if(void 0!=e)for(var i=0;t.length>i;i++)if(t[i].type==e)return t[i]}function GetKorpusByName(e){for(var t=0;MainJsonData.korpuses.length>t;t++)if(MainJsonData.korpuses[t].name==e)return MainJsonData.korpuses[t]}function GetDoorByType(e){for(var t=0;MainJsonData.doors.length>t;t++)if(MainJsonData.doors[t].type==e)return MainJsonData.doors[t]}function ClearChildren(e){for(var t=e.children.length-1;t>=0;t--)e.remove(e.children[t])}function GetDoorVariants(e){if(MainJsonData.articuls){for(var t=[],i=0;MainJsonData.articuls.doors.length>i;i++)if(MainJsonData.articuls.doors[i].name==e.type)for(var a=MainJsonData.articuls.doors[i].types,n=0;e.variants.length>n;n++)for(var r=0;a.length>r;r++)if(e.variants[n].type==a[r].type){t.push(e.variants[n]);break}return t}return e.variants}function UpdateKupeDoor(e){var t=GetKorpusByName(KupeParams.KorpusName);if(void 0!=t){var i=GetDoorByType(t.doors.type),a=GetDoorVariants(i);ClearChildren(Doors3dHolders[e]);var n=GetDoorVariant(KupeParams.doors[e].variantType,a);if(void 0!=n){KupeParams.doors[e].sections=n.sections;for(var r=0;KupeParams.doors[e].sections.length>r;r++){var o=GetVstavkaPossibleMaterials(KupeParams.DoorsType,KupeParams.doors[e].variantType,r);ArrayHasItem(o,KupeParams.doors[e].materials[r])||(KupeParams.doors[e].materials[r]=o[0])}Doors3dHolders[e].position.z=0==e%2?i.shiftSecondRail:0,Doors3dHolders[e].position.x=0==e?-.5*t.width+t.DspThickness+.5*i.width:e==t.doors.count-1?.5*t.width-t.DspThickness-.5*i.width:0;for(var s=0;n.shapes.length>s;s++)loader.createModel(n.shapes[s],function(t,i){OnShapeLoaded("Door"+e,s,t,i)},"");UpdateKupeDoorMaterial(e)}}}function UpdateKupeDoorMaterial(e,t){var i=Doors3dHolders[e].children;if(UpdateKupeDoorMaterial.arguments.length>=2)KupeParams.doors[e].sections.length>t&&i.length>t+1&&void 0!=KupeParams.doors[e].materials[t]&&KupeParams.doors[e].materials[t].length&&(i[1+t].material=LoadMaterialByName(KupeParams.doors[e].materials[t]));else{i.length&&void 0!=KupeParams.ProfileMaterial&&(i[0].material=LoadMaterialByName(KupeParams.ProfileMaterial));for(var a=0;KupeParams.doors[e].sections.length>a;a++)i.length>a+1&&void 0!=KupeParams.doors[e].materials[a]&&KupeParams.doors[e].materials[a].length&&(i[1+a].material=LoadMaterialByName(KupeParams.doors[e].materials[a]))}}function UpdateKorpusesDiv(){var e="<table cellpadding=0 cellspacing=0>";if(1==iActiveTab){var t,i=[];for(t=0;MainJsonData.korpuses.length>t;t++){var a,n=Math.round(1e3*MainJsonData.korpuses[t].width);for(a=0;i.length>a&&n>i[a][0];a++);if(a==i.length)i.push([n,MainJsonData.korpuses[t]]);else if(n==i[a][0])i[a].push(MainJsonData.korpuses[t]);else{i.length++;for(var r=i.length-1;r>a;r--)i[r]=i[r-1];i[a]=[n,MainJsonData.korpuses[t]]}}for(var o=GetKorpusByName(KupeParams.KorpusName),s=Math.round(1e3*o.width),l=0;2>l;l++){for(e+="<tr>",t=0;i.length>t;t++){var c=i[t][1];i[t][0]==s&&(c=o),e+='<td align=center style="cursor:pointer;';var d=i[t][0]==s?"#ff9e18":"#ffffff";e+="border-"+(0==l?"top":"bottom")+":2px solid "+d+";border-left:2px solid "+d+";border-right:2px solid "+d+";",1==l&&(e+="font-family:Arial;font-size:9px;"),e+='" onmouseover="Planner3dKupeConstructor.showPopupMenu(\'door_'+i[t][0]+'\',event.target)" onmouseout="Planner3dKupeConstructor.OnPopupOut()"',e+=0==l?" valign=bottom width=80 height=47 onclick=\"Planner3dKupeConstructor.SetKorpus('"+c.name+'\')"><img ondragstart="Planner3dKupeConstructor.stopStart(event)" src="'+HostImgs+"korpus_"+i[t][0]+'.png" >':">"+i[t][0]+" мм",e+="</td>"}e+="</tr>"}}if(2==iActiveTab){e+="<tr>";for(var u=0;KupeParams.nDoors>u;u++){var p=KupeParams.doors[u];e+='<td align=center style="cursor:pointer;" onmouseover="Planner3dKupeConstructor.showPopupMenu(\'dsb_'+u+'\',event.target)" onmouseout="Planner3dKupeConstructor.OnPopupOut()" valign=bottom width=40 height=43><img ondragstart="Planner3dKupeConstructor.stopStart(event)" src="'+HostImgs+"icon_door_variant_"+p.variantType+'.gif" width=36 height=36>',e+="</td>"}e+="</tr>"}e+="</table>",document.getElementById("Planner3d_KorpusVariantsDiv").innerHTML=e,cPopupMenu&&1==iActiveTab&&"door_"==cPopupMenu.substring(0,5)&&CreateDoorPopup(PopupMenuDiv,parseInt(cPopupMenu.substring(5))),cPopupMenu&&2==iActiveTab&&"dsb_"==cPopupMenu.substring(0,4)&&CreateDsbPopup(PopupMenuDiv,parseInt(cPopupMenu.substring(4)))}function SetKorpus(e){KupeParams.KorpusName=e,CreateFullKupe(),UpdateKorpusesDiv(),UpdatePrice()}function CreateFullKupe(){ClearChildren(Korpus3dHolder),ClearChildren(Lamp3dHolder);for(var e=GetKorpusByName(KupeParams.KorpusName),t=e.width>1.5?3:2,i=0;t>i;i++){var a=new THREE.Object3D;a.position.x=-.5*e.width+(i+.5)*e.width/t,Lamp3dHolder.add(a)}KupeParams.nDoors=e.doors.count,(void 0==iActiveDoor||iActiveDoor>=KupeParams.nDoors)&&(iActiveDoor=0),KupeParams.DoorsType=e.doors.type;for(var i=0;e.shapes.length>i;i++)loader.createModel(e.shapes[i],function(e,t){OnShapeLoaded("Korpus",i,e,t)},"");for(var i=0;MainJsonData.lamp.length>i;i++)loader.createModel(MainJsonData.lamp[i],function(e,t){OnShapeLoaded("Lamp",i,e,t)},"");var n=GetDoorByType(KupeParams.DoorsType);if(n)for(var r=GetDoorVariants(n),o=0;Doors3dHoldersMax>o;o++)e.doors.count>o?(void 0==GetDoorVariant(KupeParams.doors[o].variantType,r)&&(KupeParams.doors[o].variantType=r[0].type),UpdateKupeDoor(o)):ClearChildren(Doors3dHolders[o]);SetKorpusMaterial(KupeParams.KorpusMaterial),SetProfileMaterial(KupeParams.ProfileMaterial)}function onDocumentMouseDown(e){var t=e.pageX-getGlobalOffsetX(MainDiv),i=e.pageY-getGlobalOffsetY(MainDiv);if(2==e.button)e.preventDefault(),(!MSIE||MSIE>=11)&&(bMouseNavigationActive=!0,document.addEventListener("mouseup",onDocumentMouseUp,!1),document.addEventListener("mouseout",onDocumentMouseOut,!1),mouseXOnMouseDown=t-windowHalfX,targetRotationOnMouseDown=NormAngle(targetRotation),bMouseMoveBetweenClick=0);else if(0==e.button){if(2==iActiveTab&&t>=0&&Window3dWidth>t&&i>=0&&Window3dHeight>i){mouse2D.x=2*(t/Window3dWidth)-1,mouse2D.y=2*-(i/Window3dHeight)+1,raycaster=projector.pickingRay(mouse2D.clone(),camera);var a=raycaster.intersectObjects(scene.children,!0);if(a.length&&a[0].object.parent==Korpus3dHolder);else if(a.length)for(var n=0;KupeParams.nDoors>n;n++)if(a[0].object.parent==Doors3dHolders[n]){var r=GetDoorByType(KupeParams.DoorsType);if(void 0!=r)for(var o=0;KupeParams.doors[n].sections.length>o;o++)if(a[0].object==Doors3dHolders[n].children[1+o]){var s=GetVstavkaPossibleMaterials(KupeParams.DoorsType,KupeParams.doors[n].variantType,o);ArrayHasItem(s,CurrentVstavkaMaterial)&&(KupeParams.doors[n].materials[o]=CurrentVstavkaMaterial,UpdateKupeDoorMaterial(iActiveDoor,o),UpdatePrice());break}}}}else if(1==e.button&&t>=0&&Window3dWidth>t&&i>=0&&Window3dHeight>i){e.preventDefault(),mouse2D.x=2*(t/Window3dWidth)-1,mouse2D.y=2*-(i/Window3dHeight)+1,raycaster=projector.pickingRay(mouse2D.clone(),camera);var a=raycaster.intersectObjects(scene.children,!0);if(a.length){var l=a[0].point.clone().sub(camera.position),c=new THREE.Quaternion;c.setFromEuler(camera.rotation);var d=new THREE.Vector3(0,0,-1);d.applyQuaternion(c),fPanDistance=l.dot(d)}else fPanDistance=cameraDistance;last_pan_X=t,last_pan_Y=i,bPanActive=!0,document.addEventListener("mouseup",onDocumentMouseUp,!1),document.addEventListener("mouseout",onDocumentMouseOut,!1)}}function onDocumentMouseMove(e){var t=e.pageX-getGlobalOffsetX(MainDiv),i=e.pageY-getGlobalOffsetY(MainDiv);if(bMouseNavigationActive&&(bMouseMoveBetweenClick=1,mouseX=t-windowHalfX,targetRotation=targetRotationOnMouseDown+.02*(mouseX-mouseXOnMouseDown)),bPanActive&&(last_pan_X!=t||last_pan_Y!=i)){var a=new THREE.Vector3(2*(1*last_pan_X/Window3dWidth)-1,2*-(1*last_pan_Y/Window3dHeight)+1,.5);projector.unprojectVector(a,camera),a.sub(camera.position);var n=new THREE.Vector3(2*(1*t/Window3dWidth)-1,2*-(1*i/Window3dHeight)+1,.5);projector.unprojectVector(n,camera),n.sub(camera.position);var r=new THREE.Quaternion;r.setFromEuler(camera.rotation);var o=new THREE.Vector3(0,0,-1);o.applyQuaternion(r);var s=a.dot(o),l=n.dot(o);if(s>0&&l>0){camera.position.y+=fPanDistance*(a.y/s-n.y/l);var c=Math.sin(camera.rotation.y),d=Math.cos(camera.rotation.y);cameraXshift+=fPanDistance*(a.x/s-n.x/l)*d-fPanDistance*(a.z/s-n.z/l)*c,last_pan_X=t,last_pan_Y=i}}On3dMouseMove(t,i),e.stopPropagation()}function On3dMouseMove(e,t){var i=iActiveDoor;if(e>=0&&Window3dWidth>e&&t>=0&&Window3dHeight>t){if(2==iActiveTab){mouse2D.x=2*(e/Window3dWidth)-1,mouse2D.y=2*-(t/Window3dHeight)+1,raycaster=projector.pickingRay(mouse2D.clone(),camera);var a=raycaster.intersectObjects(scene.children,!0);if(a.length&&a[0].object.parent==Korpus3dHolder);else if(a.length)for(var n=0;KupeParams.nDoors>n;n++)if(a[0].object.parent==Doors3dHolders[n]){iActiveDoor=n;var r=GetDoorByType(KupeParams.DoorsType);if(void 0!=r){for(var o=0;KupeParams.doors[n].sections.length>o;o++)if(a[0].object==Doors3dHolders[n].children[1+o]){iActiveDoorSection=o;break}o==KupeParams.doors[n].sections.length&&(iActiveDoorSection=-1)}break}}}else iActiveDoor=-1;iActiveDoor>=0?showPopupMenu("ds_"+iActiveDoor):i!=iActiveDoor&&void 0!=cPopupMenu&&"ds_"==cPopupMenu.substring(0,3)&&OnPopupOut()}function onDocumentContextMenu(){event.preventDefault()}function onDocumentMouseUp(e){(2==e.button||1==e.button)&&(e.preventDefault(),bMouseNavigationActive=!1,bPanActive=!1,document.removeEventListener("mouseup",onDocumentMouseUp,!1),document.removeEventListener("mouseout",onDocumentMouseOut,!1))}function onDocumentMouseOut(){bMouseNavigationActive=!1,bPanActive=!1,document.removeEventListener("mouseup",onDocumentMouseUp,!1),document.removeEventListener("mouseout",onDocumentMouseOut,!1)}function onDocumentTouchStart(e){1==e.touches.length&&(e.preventDefault(),mouseXOnMouseDown=e.touches[0].pageX-windowHalfX,targetRotationOnMouseDown=NormAngle(targetRotation))}function onDocumentTouchMove(e){1==e.touches.length&&(e.preventDefault(),mouseX=e.touches[0].pageX-windowHalfX,targetRotation=targetRotationOnMouseDown+.05*(mouseX-mouseXOnMouseDown))}function onMouseWheel(e){e.wheelDelta>0?cameraDistance*=1-Math.min(.2,5e-4*e.wheelDelta):cameraDistance/=1-Math.min(.2,-5e-4*e.wheelDelta)}function hidePopup(){PopupMenuDiv.style.display="none",(void 0!=cPopupMenu&&("door_"==cPopupMenu.substring(0,5)||"mat_"==cPopupMenu.substring(0,4))||"dsb_"==cPopupMenu.substring(0,4))&&(document.getElementById("Planner3d_ProfileVariantsDiv").style.visibility="visible",document.getElementById("Planner3d_LampVariantsDiv").style.visibility="visible",document.getElementById("Planner3d_TabInfo1").style.visibility="visible",document.getElementById("Planner3d_TabInfo2").style.visibility="visible"),null!=hideTimeout&&(clearTimeout(hideTimeout),hideTimeout=null),cPopupMenu=null}function getGlobalOffsetX(e,t){var i,a=0;for(i=e;"BODY"!=i.tagName&&i!=t;i=i.offsetParent)a+=i.offsetLeft;return a}function getGlobalOffsetY(e,t){var i,a=0;for(i=e;"BODY"!=i.tagName&&i!=t;i=i.offsetParent)a+=i.offsetTop;return a}function OnPopupOut(){null==hideTimeout&&(hideTimeout=setTimeout(hidePopup,100))}function CreateDoorPopup(e,t){var i=GetKorpusByName(KupeParams.KorpusName),a="<table cellpadding=0 cellspacing=0>";a+="";for(var n=0;MainJsonData.korpuses.length>n;n++)if(t==Math.round(1e3*MainJsonData.korpuses[n].width)){a+="<tr>";for(var r=0;2>r;r++){a+='<td style="cursor:pointer;padding-left:4px;padding-top:4px;padding-right:4px;',1==r&&(a+="font-family:Arial;font-size:9px;color:#666666;");
var o=MainJsonData.korpuses[n]==i?"#ff9e18":"#ffffff";a+="border-"+(0==r?"left":"right")+":2px solid "+o+";border-top:2px solid "+o+";border-bottom:2px solid "+o+";",a+='" ',0==r&&(a+=" align=center"),a+=" onclick=\"Planner3dKupeConstructor.SetKorpus('"+MainJsonData.korpuses[n].name+"')\">",a+=0==r?'<img src="'+MainJsonData.korpuses[n].icon+'" height=37>':"глубина "+Math.round(1e3*MainJsonData.korpuses[n].depth)+" мм<br>"+MainJsonData.korpuses[n].doors.count+" двери",a+="</td>"}a+="</tr>"}a+="",a+="</table>",e.innerHTML=a}function CreateDsbPopup(e,t){var t=parseInt(cPopupMenu.substring(4)),i='<table cellpadding=0 cellspacing=0 style="background-color:#FFFFFF">',a=GetDoorByType(KupeParams.DoorsType),n=GetDoorVariants(a);if(a)for(var r=0;n.length>r;r++){i+="<tr>";for(var o=0;2>o;o++){i+='<td style="cursor:pointer;padding-left:4px;padding-top:4px;padding-right:4px;',1==o&&(i+="font-family:Arial;font-size:9px;color:#666666;");var s=KupeParams.doors[t].variantType==n[r].type?"#ff9e18":"#ffffff";i+="border-"+(0==o?"left":"right")+":2px solid "+s+";border-top:2px solid "+s+";border-bottom:2px solid "+s+";",i+='" ',0==o&&(i+=" align=center"),i+=' onclick=\'Planner3dKupeConstructor.OnClickSmallButt(event,"set_variant","'+n[r].type+'","'+t+"\")'>",i+=0==o?'<img src="'+HostImgs+"icon_door_variant_"+n[r].type+'.gif" width=36 height=36 border=0>':1==n[r].type?n[r].type+" секция":n[r].type+" секции",i+="</td>"}i+="</tr>"}i+="</table>",e.innerHTML=i}function showPopupMenu(e,t){if(null!=hideTimeout&&(clearTimeout(hideTimeout),hideTimeout=null),!(0==showPopupMenu.arguments.length||e instanceof Event)&&cPopupMenu!=e){cPopupMenu=e,"door_"==cPopupMenu.substring(0,5)||"mat_"==cPopupMenu.substring(0,4)||"dsb_"==cPopupMenu.substring(0,4)?("mat_"==cPopupMenu.substring(0,4)&&(document.getElementById("Planner3d_ProfileVariantsDiv").style.visibility="hidden",document.getElementById("Planner3d_LampVariantsDiv").style.visibility="hidden"),document.getElementById("Planner3d_TabInfo1").style.visibility="mat_"!=cPopupMenu.substring(0,4)?"hidden":"visible",document.getElementById("Planner3d_TabInfo2").style.visibility="mat_"!=cPopupMenu.substring(0,4)?"hidden":"visible"):"ds_"==cPopupMenu.substring(0,3)&&(document.getElementById("Planner3d_ProfileVariantsDiv").style.visibility="visible",document.getElementById("Planner3d_LampVariantsDiv").style.visibility="visible",document.getElementById("Planner3d_TabInfo1").style.visibility="visible",document.getElementById("Planner3d_TabInfo2").style.visibility="visible");var i=PopupMenuDiv;if(i.style.display="block","door_"==cPopupMenu.substring(0,5)){CreateDoorPopup(i,parseInt(cPopupMenu.substring(5)));var a=getGlobalOffsetX(t,MainDiv),n=document.getElementById("Planner3d_KorpusVariantsDiv");a+i.offsetWidth>getGlobalOffsetX(n,MainDiv)+n.offsetWidth-1&&(a=getGlobalOffsetX(n,MainDiv)+n.offsetWidth-i.offsetWidth-1),i.style.left=a+"px",i.style.top=getGlobalOffsetY(n,MainDiv)+n.offsetHeight+"px"}else if("mat_"==cPopupMenu.substring(0,4)){var r=GetMaterial(cPopupMenu.substring(4));if(void 0!=r){var o='<div style="width:149px;height:89px;background-image:url('+r.icon+');"></div>';o+='<div style="width:149px;text-align:center;font-family:Arial;font-size:9px;color:#666666;">'+r.description+"</div>",i.innerHTML=o}i.style.left=getGlobalOffsetX(document.getElementById("Planner3d_LampVariantsDiv"),MainDiv)+44+"px",i.style.top=getGlobalOffsetY(document.getElementById("Planner3d_LampVariantsDiv"),MainDiv)+25+"px"}else if("ds_"==cPopupMenu.substring(0,3)){var s=parseInt(cPopupMenu.substring(3)),o='<table cellpadding=0 cellspacing=0 style="background-color:#FFFFFF"><tr>',l=GetDoorByType(KupeParams.DoorsType),c=GetDoorVariants(l);if(l)for(var d=0;c.length>d;d++)o+="<td height=30 valign=middle",KupeParams.doors[iActiveDoor].variantType==c[d].type&&(o+=' style="border:2px solid #ff9e18;"'),o+='><img src="'+HostImgs+"icon_door_variant_"+c[d].type+'_sm.gif" style="cursor:pointer" width=20 height=24 border=0 onclick=\'Planner3dKupeConstructor.OnClickSmallButt(event,"set_variant","'+c[d].type+'","'+s+"\")'></td>";o+="</tr></table>",i.innerHTML=o}else if("dsb_"==cPopupMenu.substring(0,4)){CreateDsbPopup(i,parseInt(cPopupMenu.substring(4)));var a=getGlobalOffsetX(t,MainDiv),n=document.getElementById("Planner3d_KorpusVariantsDiv");a+i.offsetWidth>getGlobalOffsetX(n,MainDiv)+n.offsetWidth&&(a=getGlobalOffsetX(n,MainDiv)+n.offsetWidth-i.offsetWidth),i.style.left=a+"px",i.style.top=getGlobalOffsetY(n,MainDiv)+n.offsetHeight+"px"}}}function ClearPlayTimeInterval(){playTimeInterval&&(clearInterval(playTimeInterval),playTimeInterval=null)}function OnPressSmallButtRotateL(event,idStr){ClearPlayTimeInterval(),(""==idStr||"RotateR"==idStr)&&(targetRotation=-camera.rotation.y),eval("ProcessPressAction('"+idStr+"')"),playTimeInterval=setInterval("ProcessPressAction('"+idStr+"')",30)}function OnPressSmallButtRotateL(){ClearPlayTimeInterval(),targetRotation=-camera.rotation.y,document.addEventListener("mouseup",OnReleaseSmallButt,!1),ProcessPressActionRotateL(),playTimeInterval=setInterval(ProcessPressActionRotateL,30)}function OnPressSmallButtRotateR(){ClearPlayTimeInterval(),targetRotation=-camera.rotation.y,document.addEventListener("mouseup",OnReleaseSmallButt,!1),ProcessPressActionRotateR(),playTimeInterval=setInterval(ProcessPressActionRotateR,30)}function OnPressSmallButtZoomIn(){ClearPlayTimeInterval(),document.addEventListener("mouseup",OnReleaseSmallButt,!1),ProcessPressActionZoomIn(),playTimeInterval=setInterval(ProcessPressActionZoomIn,30)}function OnPressSmallButtZoomOut(){ClearPlayTimeInterval(),document.addEventListener("mouseup",OnReleaseSmallButt,!1),ProcessPressActionZoomOut(),playTimeInterval=setInterval(ProcessPressActionZoomOut,30)}function ProcessPressActionRotateR(){targetRotation+=.2}function ProcessPressActionRotateL(){targetRotation-=.2}function ProcessPressActionZoomIn(){cameraDistance*=1-Math.min(.2,.0025)}function ProcessPressActionZoomOut(){cameraDistance/=1-Math.min(.2,.0025)}function OnReleaseSmallButt(){document.removeEventListener("mouseup",OnReleaseSmallButt,!1),ClearPlayTimeInterval()}function OnClickSmallButtColorPicker(e){OnClickSmallButt(e,"colorpicker",0)}function OnClickSmallButt(e,t,i,a){if("set_variant"==t){KupeParams.doors[a].variantType=i,UpdateKupeDoor(a);var n=cPopupMenu;cPopupMenu=void 0,void 0!=n&&"dsb_"==n.substring(0,4)?(cPopupMenu=n,CreateDsbPopup(PopupMenuDiv,parseInt(cPopupMenu.substring(4)))):showPopupMenu(n),UpdateKorpusesDiv(),UpdatePrice()}else"colorpicker"==t&&iActiveDoorSection>=0&&KupeParams.doors[iActiveDoor].sections.length>iActiveDoorSection&&(CurrentVstavkaMaterial=KupeParams.doors[iActiveDoor].materials[iActiveDoorSection],ActivateTab(iActiveTab))}function stopStart(e){e.preventDefault(),e.stopPropagation()}function _onFinishStart(){return!1}function onDragMatStart(e,t){LoadMaterialByName(e),t.dataTransfer.setData("text",e),curDragMat=e,t.stopPropagation()}function onDragMatEnd(){curDragMat=""}function onDropHandler(e){var t=e.pageX-getGlobalOffsetX(MainDiv),i=e.pageY-getGlobalOffsetY(MainDiv);if(t>=0&&Window3dWidth>t&&i>=0&&Window3dHeight>i){mouse2D.x=2*(t/Window3dWidth)-1,mouse2D.y=2*-(i/Window3dHeight)+1,raycaster=projector.pickingRay(mouse2D.clone(),camera);var a=raycaster.intersectObjects(scene.children,!0);if(a.length&&a[0].object.parent==Korpus3dHolder)return;if(a.length)for(var n=0;KupeParams.nDoors>n;n++)if(a[0].object.parent==Doors3dHolders[n]){var r=GetDoorByType(KupeParams.DoorsType);if(void 0!=r)for(var o=0;KupeParams.doors[n].sections.length>o;o++)if(a[0].object==Doors3dHolders[n].children[1+o]){var s=GetVstavkaPossibleMaterials(KupeParams.DoorsType,KupeParams.doors[n].variantType,o);ArrayHasItem(s,curDragMat)&&(KupeParams.doors[n].materials[o]=curDragMat,UpdateKupeDoorMaterial(n,o),UpdatePrice());break}return}}}function onDragOver(e){e.dataTransfer.getData("text"),curDragMat&&curDragMat.length?(e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="copy"):e.dataTransfer.dropEffect="none"}function onDragEnter(e){return curDragMat&&curDragMat.length?(e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="copy"):e.dataTransfer.dropEffect="none",!1}function Project3dPointTo2d(e,t,i){var a=projector.projectVector(new THREE.Vector3(e,t,i),camera);return{x:Math.round(.5*a.x*Window3dWidth+Window3dWidth/2),y:Math.round(Window3dHeight/2-.5*a.y*Window3dHeight)}}function animate(){if(requestAnimationFrame(animate),render(),2==iActiveTab)if(Doors3dHolders[0].children.length>0&&iActiveDoor>=0){if(void 0!=cPopupMenu&&"ds_"==cPopupMenu.substring(0,3)){Doors3dHolders[iActiveDoor].children[0].geometry.computeBoundingBox();var e=Doors3dHolders[iActiveDoor].children[0].geometry.boundingBox,t=Project3dPointTo2d(.5*(e.min.x+e.max.x)+Doors3dHolders[iActiveDoor].position.x,e.max.y+Doors3dHolders[iActiveDoor].position.y,e.max.z+Doors3dHolders[iActiveDoor].position.z),i=PopupMenuDiv;0>t.x-30&&(t.x=30),t.x+30>=Window3dWidth&&(t.x=Window3dWidth-30),16>t.y&&(t.y=16),t.y+28>=Window3dHeight&&(t.y=Window3dHeight-28),i.style.left=t.x-30+"px",i.style.top=Math.round(t.y-16)+"px"}if(iActiveDoorSection>=0&&KupeParams.doors[iActiveDoor].sections.length>iActiveDoorSection){Doors3dHolders[iActiveDoor].children[1+iActiveDoorSection].geometry.computeBoundingBox();var e=Doors3dHolders[iActiveDoor].children[1+iActiveDoorSection].geometry.boundingBox,t=Project3dPointTo2d(.5*(e.min.x+e.max.x)+Doors3dHolders[iActiveDoor].position.x,.5*(e.min.y+e.max.y)+Doors3dHolders[iActiveDoor].position.y,e.max.z+Doors3dHolders[iActiveDoor].position.z);ButtColorPicker.style.left=t.x-13+"px",ButtColorPicker.style.top=Math.round(t.y-13)+"px",ButtColorPicker.style.display="block"}else ButtColorPicker.style.display="none"}else ButtColorPicker.style.display="none";stats&&stats.update()}function render(){var e=NormAngle(camera.rotation.y+.05*(-targetRotation-camera.rotation.y));camera.rotation.y=Math.abs(e)>1.483529886111111?3.1415927*(e>0?1:-1)/2*(17/18):e;var t=Math.sin(camera.rotation.y),i=Math.cos(camera.rotation.y);2>cameraDistance?cameraDistance=2:cameraDistance>25&&(cameraDistance=25),camera.position.x=t*cameraDistance+cameraXshift*i,camera.position.z=i*cameraDistance-cameraXshift*t,renderer.render(scene,camera)}var container,stats,mouse2D,camera,scene,renderer,cameraDistance=15,cameraXshift=0,stats,mouseX=0,mouseY=0,raycaster,projector,Window3dWidth=430,Window3dHeight=450,windowHalfX=Window3dWidth/2,windowHalfY=Window3dHeight/2,iconSize=50,bMouseMoveBetweenClick,bMouseNavigationActive=0,targetRotation=0,targetRotationOnMouseDown=0,mouseXOnMouseDown=0,MainJsonData=null,Korpus3dHolder,Lamp3dHolder,Doors3dHolders=[],Doors3dHoldersMax=3,CurrentVstavkaMaterial,KupeParams={};KupeParams.nDoors=0;var iActiveDoor=0,iActiveDoorSection=-1;KupeParams.doors=[];var hideTimeout=null,cPopupMenu,progDAnim=null,MSIE=0,MainDiv=null,PopupMenuDiv=null,ButtColorPicker=null,MainJsonText,MatLib=[],iActiveTab=1,bPanActive=0,fPanDistance,last_pan_X,last_pan_Y,playTimeInterval=null,curDragMat=0;return{Initialize:Initialize,Uninitialize:Uninitialize,SetKorpusMaterial:SetKorpusMaterial,SetCurrentVstavkaMaterial:SetCurrentVstavkaMaterial,SetProfileMaterial:SetProfileMaterial,SetKorpus:SetKorpus,OnClickSmallButt:OnClickSmallButt,showPopupMenu:showPopupMenu,OnPopupOut:OnPopupOut,stopStart:stopStart,onDragMatStart:onDragMatStart,onDragMatEnd:onDragMatEnd}},DAnimProgressBar=function(e){function t(e,t,i,a,n,r){e.beginPath(),e.moveTo(t+r,i),e.lineTo(t+a-r,i),e.arc(t+a-r,i+r,r,-Math.PI/2,Math.PI/2,!1),e.lineTo(t+r,i+n),e.arc(t+r,i+r,r,Math.PI/2,3*Math.PI/2,!1),e.closePath(),e.fill()}function i(e,i,a,n,r,o){e.save(),e.shadowOffsetX=2,e.shadowOffsetY=2,e.shadowBlur=5,e.shadowColor="#666",e.fillStyle="rgba(189,189,189,1)",t(e,i,a,n,r,o),e.shadowColor="rgba(0,0,0,0)";var s=e.createLinearGradient(0,a+r,0,0);s.addColorStop(0,"rgba(255,255,255, 0.1)"),s.addColorStop(.4,"rgba(255,255,255, 0.7)"),s.addColorStop(1,"rgba(255,255,255,0.4)"),e.fillStyle=s,t(e,i,a,n,r,o),e.fillStyle="white",e.restore()}function a(e,t,i,a,n,r,o){var s=0;e.beginPath(),r>a?(s=r-Math.sqrt(Math.pow(r,2)-Math.pow(r-a,2)),e.moveTo(t+a,i+s),e.lineTo(t+a,i+n-s),e.arc(t+r,i+r,r,Math.PI-Math.acos((r-a)/r),Math.PI+Math.acos((r-a)/r),!1)):a+r>o?(s=r-Math.sqrt(Math.pow(r,2)-Math.pow(r-(o-a),2)),e.moveTo(t+r,i),e.lineTo(t+a,i),e.arc(t+o-r,i+r,r,-Math.PI/2,-Math.acos((r-(o-a))/r),!1),e.lineTo(t+a,i+n-s),e.arc(t+o-r,i+r,r,Math.acos((r-(o-a))/r),Math.PI/2,!1),e.lineTo(t+r,i+n),e.arc(t+r,i+r,r,Math.PI/2,3*Math.PI/2,!1)):(e.moveTo(t+r,i),e.lineTo(t+a,i),e.lineTo(t+a,i+n),e.lineTo(t+r,i+n),e.arc(t+r,i+r,r,Math.PI/2,3*Math.PI/2,!1)),e.closePath(),e.fill(),o-1>a&&(e.save(),e.shadowOffsetX=1,e.shadowBlur=1,e.shadowColor="#666",a+r>o&&(s+=1),e.fillRect(t+a,i+s,1,l-2*s),e.restore())}function n(e,t,i,a,n,r,o){e.save(),e.fillStyle="white";var s=Math.floor(100*(a/o))+"%",l=e.measureText(s).width,c=t+a-l-r/2;r+l>=a&&(c=t+r/2),e.fillText(s,c,i+22),e.restore()}var r=null,o=null,s=300,l=34,c=20,d=20,u=l/2,p=e,h=function(){r.style.display="none"},f=function(e,t,i){if(r=document.createElement(p?"DIV":"canvas"),p||(r.width=500,r.height=150),r.style.position="absolute",r.style.left=Math.floor((t-s)/2)+"px",r.style.top=Math.floor((i-l)/2)+"px",e.appendChild(r),p&&(r.style.width=s+"px",r.style.height=l/2+"px",r.style.overflow="hidden",r.style.borderColor="#000000",r.style.borderWidth="1px",r.style.borderStyle="solid",r.style.backgroundColor="#FFFFFF",r.innerHTML='<DIV style="background-color:#ADD9FF;width:0px;height:'+l/2+'px;"></DIV>'),!p){if(!r||!r.getContext)return;if(o=r.getContext("2d"),!o)return;o.font="16px Verdana";var a=o.createLinearGradient(0,d+l,0,0);a.addColorStop(0,"#4DA4F3"),a.addColorStop(.4,"#ADD9FF"),a.addColorStop(1,"#9ED1FF"),o.fillStyle=a}m(0)},m=function(e){if(p){var t=r.children(0);t&&(t.style.width=e+"px")}else o.clearRect(c-5,d-5,s+15,l+15),i(o,c,d,s,l,u),a(o,c,d,e,l,u,s),n(o,c,d,e,l,u,s)};return{width:s,height:l,Initialize:f,Uninitialize:h,doDraw:m}};