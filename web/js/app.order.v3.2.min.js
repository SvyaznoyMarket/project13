$(document).ready(function(){$("body").delegate(".bBuyingLine label","click",function(){if("radio"==$(this).find("input").attr("type")){var a=$('.mChecked input[name="'+$(this).find("input").attr("name")+'"]');a.length&&a.each(function(a,b){$(b).parent("label").removeClass("mChecked")});$(this).addClass("mChecked")}else"checkbox"==$(this).find("input").attr("type")&&$(this).toggleClass("mChecked")});$("body").delegate(".bBuyingLine input:radio, .bBuyingLine input:checkbox","click",function(a){a.stopPropagation()});
$("body").delegate(".bBuyingLine label","click",function(){var a=$(this).find('input[type="radio"]'),c=$("#order-form").data("deliveryMapUrl");$("#order-form-part2").hide();$(".order-shop-button").hide();"self"==a.data("deliveryType")?$(".order-shop-button").show("medium"):($("#order-loader").clone().appendTo("#order-loader-holder").show(),DeliveryMap.getRemoteData(c,{deliveryTypeId:a.val()},function(){this.render();$("#order-loader-holder").html("");$("#order-form-part2").show("fast")}))});$("body").delegate(".order-shop-button",
"click",function(a){a.preventDefault();DeliveryMap.openShopMap(function(a){console.info(a)})});$("body").delegate(".order-item_delivery-button","click",function(a){a.preventDefault();var a=DeliveryMap.data(),c=$(this),b=Templating.clone($(c.data("template"))),d=a.items[c.data("value")],e=null;$.each(a.deliveryTypes,function(a,b){$.each(b.items,function(b,c){c==d.token&&(e=a)})});var f=b.find("a");$.each(d.deliveries,function(a,b){if(b.token!=e){var c=f.clone(),h={name:b.name,route:JSON.stringify({item:d.token,
from:e,to:b.token})};Templating.assign(c,h);c.insertAfter(f)}});f.remove();b.appendTo(c.parent());b.bind({mouseleave:function(){$(this).remove()},click:function(a){c=$(a.target);c.is("a")&&(a=c.data("value"),DeliveryMap.moveItem(a.item,a.from,a.to),$(this).remove())}});b.show()});$("body").delegate(".order-delivery_date-control","click",function(){var a=$(this),c=a.data("value");a.parent().find(".order-delivery_date").hide();a.parent().find('.order-delivery_date[data-week="'+c+'"]').show();a.parent().find(".order-delivery_date-control").each(function(a,
c){$(c).removeClass("mDisabled")});a.addClass("mDisabled")});$("body").delegate(".order-delivery_date","click",function(){});Templating={assign:function(a,c){$.each(a.data("assign"),function(b,d){var e=d[1];$.isArray(e)||(e=[e]);$.each(e,function(a,d){"_value"==d&&(e[a]=c[b])});a[d[0]].apply(a,e);a.is("data")&&a.replaceWith(a.text())})},clone:function(a){return $(a.clone().html())}};DeliveryMap={dataHolder:$("#order-delivery_map-data"),data:function(a){if(a)this.dataHolder.data("value",a);else return this.dataHolder.data("value")},
getRemoteData:function(a,c,b){var d=this;$.ajax({type:"POST",async:!1,timeout:6E4,url:a,dataType:"json",data:{delivery_type_id:c.deliveryTypeId},success:function(a){a=a.data;d.data(a);$.isFunction(b)&&b.call(d,[a])},complete:function(){}})},moveItem:function(a,c,b){var d=this.data();$.each(d.deliveryTypes[c].items,function(b,f){f==a&&d.deliveryTypes[c].items.splice(b,1)});d.deliveryTypes[b].items.push(a);this.data(d);this.render()},getDeliveryPrice:function(a){var c=this.data(),b=0;$.each(a.items,
function(d,e){var f=c.items[e].deliveries[a.token].price;f>b&&(b=f)});return b},getDeliveryTotal:function(a){var c=this.data(),b=0;$.each(a.items,function(a,e){b+=c.items[e].total});return b},render:function(){var a=this,c=this.data();$(".order-delivery-holder").each(function(b,d){d=$(d);a.renderDeliveryType(d);0==c.deliveryTypes[d.data("value")].items.length?d.hide():d.show()})},renderDeliveryType:function(a){var c=this,b=this.data(),d=b.deliveryTypes[a.data("value")],e=a.find(".order-item-holder");
e.html("");var f=a.find(".order-delivery_price");f.html("");var i=c.getDeliveryPrice(d);if(0<i){var g=Templating.clone($(f.data("template")));g.find("[data-assign]").each(function(a,b){Templating.assign($(b),{price:i})});g.appendTo(f)}else f.html("Бесплатно");f=a.find(".order-delivery_total-holder");f.html("");var j=c.getDeliveryTotal(d),g=Templating.clone($(f.data("template")));g.find("[data-assign]").each(function(a,b){Templating.assign($(b),{total:printPrice(j),name:"Итого"+("self"==d.type?" с доставкой":
"")})});g.appendTo(f);var h=[];$.each(d.items,function(a,c){$.each(b.items[c].deliveries[d.token].dates,function(a,b){h.push(b.value)})});$.each(a.find(".order-delivery_date"),function(a,b){var b=$(b),c=b.data("value");-1!==$.inArray(c,h)?(b.removeClass("bBuyingDates__eDisable"),b.addClass("bBuyingDates__eEnable")):(b.removeClass("bBuyingDates__eEnable"),b.addClass("bBuyingDates__eDisable"))});$.each(d.items,function(a,d){c.renderItem(e,b.items[d])})},renderItem:function(a,c){var b=$(a.data("template")),
b=Templating.clone(b);b.find("[data-assign]").each(function(a,b){Templating.assign($(b),c)});b.find(".order-item_delivery-button").remove();a.append(b)},openShopMap:function(a){$(".mMapPopup").lightbox_me({centered:!0,onLoad:function(){},onClose:function(){a.call(this,[{shopId:null}])}})}};$('[name="order[delivery_type_id]"]:checked').length&&(DeliveryMap.render(),$("#order-form-part2").show("fast"))});
