$(document).ready(function(){function t(){var t=this;t.noDelivery=ko.observable(!1),t.title=i.jstitle,t.price=i.jsprice,t.icon=i.jsbimg,t.shortcut=i.jsshortcut,t.stockq=i.jsstock,t.quantity=ko.observable(1),t.quantityTxt=ko.computed(function(){return t.quantity()+" шт."},this),t.priceTxt=ko.computed(function(){return printPrice(t.price)},this),t.newWarehouse=i.is_quick_only,t.formStatus=ko.observable("typing"),t.formStatusTxt=ko.computed(function(){var e="";switch(t.formStatus()){case"reserve":e="Зарезервировать";break;case"typing":e="Отправить заказ";break;case"process":e="Проверка...";break;case"error":e="Отправить заказ нельзя";break;case"sending":e="Отправка..."}return e},this),t.showMap=ko.observable(!1),t.textfields=[],t.textfields.push(ko.observable({title:"Имя получателя",name:"order[recipient_first_name]",selectorid:"",value:"",valerror:!1,regexp:/^[a-zа-я\s]+$/i})),t.textfields.push(ko.observable({title:"Телефон для связи",name:"order[recipient_phonenumbers]",selectorid:"phonemask",value:"",valerror:!1,regexp:/^[()0-9\-\+\s]+$/})),t.disabledSelectors=ko.observable(!1),t.noQBar=ko.observable(!1),t.stableType=ko.observable(!1),t.chosenDlvr=ko.observable({}),t.chosenDate=ko.observable({}),t.dlvrs=ko.observableArray([]),t.dates=ko.observableArray([]),t.shops=ko.observableArray([]),t.chosenShop=ko.observable({}),t.pickedShop=ko.observable({}),t.dynModel=function(e){var n=t.chosenDlvr().type;n||(n="self"),t.dlvrs.removeAll(),t.chosenDlvr({});for(var r in e)t.dlvrs.push({type:r,name:e[r].name,modeID:e[r].modeId,price:e[r].price}),r==n&&t.chosenDlvr(t.dlvrs()[t.dlvrs().length-1]);"type"in t.chosenDlvr()||t.chosenDlvr(t.dlvrs()[0]),t.dates(e[t.chosenDlvr().type+""].dates.slice(0)),t.chosenDate(t.dates()[0]);if(u)t.shops(e.self.shops.slice(0)),t.chosenShop(t.shops()[0]),t.pickedShop(t.shops()[0]);else{var i={address:"",regtime:"",id:1};t.chosenShop(i),t.pickedShop(i)}},t.dynModel(Deliveries),t.total=ko.computed(function(){return printPrice(t.price*t.quantity()+t.chosenDlvr().price*1)},this),t.changeDlvr=function(e){t.chosenDlvr(e),t.dates.removeAll();for(var n=0;n<Deliveries[e.type].dates.length;n++)t.dates.push(Deliveries[e.type].dates[n]);t.chosenDate(t.dates()[0]),t.showMap()&&t.showMap(!1)},t.plusItem=function(){t.quantity(t.quantity()+1);if(t.quantity()>t.stockq)return t.noDelivery(!0),!1;var e=t.quantity()*1;return setTimeout(function(){t.loadData(e,1)},500),!1},t.minusItem=function(){if(t.quantity()==1)return!1;t.quantity(t.quantity()-1);if(t.noDelivery()){if(!(t.quantity()<=t.stockq))return!1;t.noDelivery(!1)}var e=t.quantity()*1;return setTimeout(function(){t.loadData(e,-1)},500),!1},t.preparedData=function(e){if(e.type==="self"){t.formStatus("reserve");for(var n=0,r=t.dlvrs().length;n<r;n++)if(t.dlvrs()[n].type=="self"){t.chosenDlvr(t.dlvrs()[n]);break}t.disabledSelectors(!0),t.noQBar(!0),"date"in e&&t.chosenDate(e.date),"shop"in e&&t.chosenShop(e.shop)}else if(e.type==="courier"){t.formStatus("reserve");for(var n=0,r=t.dlvrs().length;n<r;n++)if(t.dlvrs()[n].type!="self"){t.chosenDlvr(t.dlvrs()[n]);break}t.disabledSelectors(!1),t.stableType(!0),t.noQBar(!0)}},t.loadData=function(n,r){if(r>0&&t.quantity()>n||r<0&&t.quantity()<n)return;var o={product_id:i.jsitemid,product_quantity:n,region_id:i.jsregionid*1};$.post(s,o,function(n){if(t.noDelivery())return!1;if(!n.success)return t.noDelivery(!0),!1;Deliveries=n.data;var r=0;for(var i in Deliveries)r++;if(r===0)return t.noDelivery(!0),!1;t.noDelivery(!1),u="self"in Deliveries,t.dynModel(Deliveries),u&&typeof mapCenter=="undefined"&&(mapCenter=calcMCenter(Deliveries.self.shops)),u&&!("regionMap"in window)&&(e==="yandex"&&(ymaps.isReady?(window.regionMap=new MapYandexWithShops(mapCenter,$("#map-info_window-container-ya"),"mapPopup"),window.regionMap.addHandler(".shopchoose",f)):PubSub.subscribe("yandexIsReady",function(){window.regionMap=new MapYandexWithShops(mapCenter,$("#map-info_window-container-ya"),"mapPopup"),window.regionMap.addHandler(".shopchoose",f)})),e==="google"&&(window.regionMap=new MapGoogleWithShops(mapCenter,$("#map-info_window-container"),"mapPopup"),window.regionMap.addHandler(".shopchoose",f)))})},t.pickDate=function(e){t.chosenDate(e);if(u&&"shopIds"in e&&e.shopIds.length>0){t.shops.removeAll();for(var n in Deliveries.self.shops)e.shopIds.indexOf(Deliveries.self.shops[n].id*1)!==-1&&t.shops.push(Deliveries.self.shops[n])}t.showMap()&&t.showMarkers()},t.pickShop=function(e){t.chosenShop(e)},t.pickShopOnMap=function(e){for(var n=0,r=t.shops().length;n<r;n++)if(t.shops()[n].id==e){t.pickedShop(t.shops()[n]);return}},t.toggleMap=function(){t.showMap()?$("#mapPopup").hide("blind",null,800,function(){t.showMap(!1)}):(t.showMap(!0),$("#mapPopup").show("blind",null,1e3));if(!t.showMap())return;t.showMarkers()},t.turnOffMap=function(){t.showMap(!1)},t.showMarkers=function(){var e={},n=t.shops();for(var r=0,i=n.length;r<i;r++){var s=n[r].id+"";e[s]={id:n[r].id,name:n[r].address,regtime:n[r].regtime,latitude:n[r].latitude,longitude:n[r].longitude}}window.regionMap.showMarkers(e)},t.chooseShopById=function(e){for(var n=0,r=t.shops().length;n<r;n++)if(t.shops()[n].id==e){t.chosenShop(t.shops()[n]);break}},t.validateField=function(e,n){var i=!1;if(n.currentTarget.value.replace(/\s/g,"")==""||!e.regexp.test(n.currentTarget.value))i=!0,t.formStatus("typing");n.currentTarget.getAttribute("id")==="phonemask"&&n.currentTarget.value.replace(/[^0-9]/g,"").length!==11&&(i=!0,t.formStatus("typing"));for(var s=0,o=t.textfields.length;s<o;s++)if(t.textfields[s]().name===e.name){var u=t.textfields[s]();u.valerror=i,u.value=n.currentTarget.value,t.textfields[s](u);break}return r(),!0},t.validateForm=function(){if(t.noDelivery())return!1;if(t.formStatus()!=="typing"&&t.formStatus()!=="reserve")return;t.formStatus("process"),$("#oneClick input").trigger("change");if(t.formStatus()==="typing")return;t.sendData()},t.sendData=function(){t.formStatus("sending");var e={"order[product_quantity]":t.quantity(),"order[delivered_at]":t.chosenDate().value,"order[delivery_type_id]":t.chosenDlvr().modeID};t.chosenDlvr().type=="self"&&(e["order[shop_id]"]=t.chosenShop().id);for(var n=0,r=t.textfields.length;n<r;n++)e[t.textfields[n]().name+""]=t.textfields[n]().value;var i=$.ajax({type:"POST",timeout:6e4,url:o,data:e,success:function(e,n){if(!e.success||n!=="success"){t.formStatus("typing");return}$(".bFast").parent().append(e.data.content),$(".bFast").remove(),$(".p0").removeClass("p0"),$(".top0").removeClass("top0"),typeof _gaq!="undefined"&&typeof runAnalitics!="undefined"&&runAnalitics(),ANALYTICS.parseAllAnalDivs($(".jsanalytics"))},error:function(e,n){t.formStatus("typing");return}})}}function n(){var e=this;e.showMap=ko.observable(!1),e.title=i.jstitle,e.price=i.jsprice,e.icon=i.jssimg,e.shortcut=i.jsshortcut,e.region=i.jsregion,e.today=ko.observable(!0),e.priceTxt=ko.computed(function(){return printPrice(e.price)},this),e.shops=Deliveries.self.shops.slice(0),e.todayShops=[],e.tomorrowShops=[],e.activeCourier=Deliveries.length>1,parseDateShop=function(t,n){var r=[];e:for(var i=0,s=t.length;i<s;i++)for(var o=0,s=e.shops.length;o<s;o++)if(e.shops[o].id==t[i]){var u={};for(var a in e.shops[o])u[a]=e.shops[o][a];u.lbl=n,r.push(u);continue e}return r};var t=-1;for(var n=0,r=Deliveries.self.dates.length;n<r;n++){if(Deliveries.self.dates[n].value===c){t=n;break}if(Date.parse(c)==Date.parse(Deliveries["self"].dates[n].value)){t=n;break}}t<0?e.tomorrowShops=parseDateShop(Deliveries.self.dates[t+1].shopIds,"tmr"):(e.todayShops=parseDateShop(Deliveries.self.dates[t].shopIds,"td"),Deliveries.self.dates.length>t+1&&(e.tomorrowShops=parseDateShop(Deliveries.self.dates[t+1].shopIds,"tmr"))),e.pickedShop=ko.observable(e.todayShops[0]),e.selectedS=ko.observable({});var s="ах";e.todayShops.length%10===1&&(s="е"),e.todayH2='Можно <span class="mLft">сегодня</span> в '+e.todayShops.length+" магазин"+s+":",e.tomorrowShops.length%10===1?s="е":s="ах",e.tomorrowH2=e.todayShops.length>0?"или":"Можно",e.tomorrowH2+=' <span class="mRt">завтра</span> в '+e.tomorrowShops.length+" магазин"+s+":",e.toggleView=function(t){return e.showMap(t),t&&(e.todayShops.length?e.showMarkers():e.toggleTerm(!1)),!1},e.toggleTerm=function(t){return e.today(t),window.regionMap.hideInfobox(),e.showMarkers(),!1},e.chooseShop=function(t,n){e.selectedS(t),e.today(n)},e.chooseShopById=function(t){for(var n=0,r=e.shops.length;n<r;n++)if(e.shops[n].id==t){e.selectedS(e.shops[n]);break}e.reserveItem()},e.pickShopOnMap=function(t){for(var n=0,r=e.shops.length;n<r;n++)if(e.shops[n].id==t){e.pickedShop(e.shops[n]);return}},e.showMarkers=function(){var t={},n=e.today()?e.todayShops:e.tomorrowShops;for(var r=0,i=n.length;r<i;r++){var s=n[r].id+"";t[s]={id:n[r].id,name:n[r].address,regtime:n[r].regtime,latitude:n[r].latitude,longitude:n[r].longitude}}window.regionMap.showMarkers(t)},e.reserveItem=function(){var n={type:"self",date:e.today()?Deliveries.self.dates[t]:Deliveries.self.dates[t+1],shop:e.selectedS()};return OC_MVM.preparedData(n),$("#order1click-container-new").lightbox_me({}),!1},e.onlyCourier=function(){var e={type:"courier"};return OC_MVM.preparedData(e),$("#order1click-container-new").lightbox_me({}),!1}}function r(){typeof $.mask!="undefined"&&($.mask.definitions.n="[()0-9 -]",$("#phonemask").mask("+7 nnnnnnnnnnnnnnnnn",{placeholder:" ",maxlength:10}))}$("#order1click-container-new").delegate(".bSelect","click",function(){if($(this).hasClass("mDisabled"))return!1;$(this).find(".bSelect__eDropmenu").toggle()}),$("#order1click-container-new").delegate(".bSelect","mouseleave",function(){if($(this).hasClass("mDisabled"))return!1;var e=$(this).find(".bSelect__eDropmenu");e.is(":visible")&&e.hide()});var e="yandex";e==="yandex"&&ymaps.ready(function(){console.info("yandexIsReady"),PubSub.publish("yandexIsReady"),ymaps.isReady=!0});if($(".order1click-link-new").length){var i=$(".order1click-link-new").data("model"),s=$(".order1click-link-new").attr("link-input"),o=$(".order1click-link-new").attr("link-output");Deliveries={self:{modeId:4,name:"Доставка",price:400,dates:[{value:"10-02-2012",name:"10 февраля"},{value:"11-02-2012",name:"11 февраля"}]}};var u=!1;oneClickIsReady=!1;var a={product_id:i.jsitemid,product_quantity:1,region_id:i.jsregionid*1};$.post(s,a,function(n){if(!n.success||n.data.length===0)return OC_MVM=new t,ko.applyBindings(OC_MVM,$("#order1click-container-new")[0]),OC_MVM.noDelivery(!0),$(".order1click-link-new").remove(),!1;Deliveries=n.data,u="self"in Deliveries,u&&(mapCenter=calcMCenter(Deliveries.self.shops)),OC_MVM=new t,ko.applyBindings(OC_MVM,$("#order1click-container-new")[0]),u&&(e==="yandex"&&(ymaps.isReady?(window.regionMap=new MapYandexWithShops(mapCenter,$("#map-info_window-container-ya"),"mapPopup"),window.regionMap.addHandler(".shopchoose",f)):PubSub.subscribe("yandexIsReady",function(){window.regionMap=new MapYandexWithShops(mapCenter,$("#map-info_window-container-ya"),"mapPopup"),window.regionMap.addHandler(".shopchoose",f)})),e==="google"&&(window.regionMap=new MapGoogleWithShops(mapCenter,$("#map-info_window-container"),"mapPopup",l),window.regionMap.addHandler(".shopchoose",f))),oneClickIsReady=!0,r()});function f(e){var t=$(e).parent().find(".shopnum").text();window.regionMap.closeMap(OC_MVM.turnOffMap),OC_MVM.chooseShopById(t)}function l(e){typeof OC_MVM!="undefined"&&OC_MVM.pickShopOnMap(e.id)}$(".order1click-link-new").bind("click",function(e){e.preventDefault();if(!oneClickIsReady)return;typeof _gaq!="undefined"&&_gaq.push(["_trackEvent","QuickOrder","Open"]),"ANALYTICS"in window&&"marketgidOrder"in ANALYTICS&&ANALYTICS.marketgidOrder(),$("#order1click-container-new").lightbox_me({centered:!0,onClose:function(){"regionMap"in window&&window.regionMap.closeMap(OC_MVM.turnOffMap)}})})}if($("#stockBlock").length){var i=$("#stockmodel").data("value"),s=$("#stockmodel").attr("link-input"),o=$("#stockmodel").attr("link-output"),u=!1,c=(new Date).toISOString().substr(0,10),a={product_id:i.jsitemid,product_quantity:1,region_id:i.jsregionid*1};$.post(s,a,function(i){if(!i.success)return $(".bOrderPreloader").hide(),$("#noDlvr").show(),!1;Deliveries=i.data;var s=0;for(var o in Deliveries)s++;Deliveries.length=s,"currentDate"in i&&i.currentDate!=""&&(c=i.currentDate),$(".bOrderPreloader").hide();if(s===0)return $("#noDlvr").show(),!1;u="self"in Deliveries;if(!u)return $("#noDlvr").show(),!1;if(Date.parse(Deliveries.self.dates[0].value)!==Date.parse(c)&&Date.parse(Deliveries.self.dates[0].value)!==Date.parse(c)+864e5)return $("#noDlvr").show(),!1;u&&(mapCenter=calcMCenter(Deliveries.self.shops)),MVM=new n,ko.applyBindings(MVM,$("#stockCntr")[0]),OC_MVM=new t,ko.applyBindings(OC_MVM,$("#order1click-container-new")[0]),r(),u&&(e==="yandex"&&(ymaps.isReady?(window.regionMap=new MapYandexWithShops(mapCenter,$("#infowindowforstockYa"),"stockmap"),window.regionMap.addHandler(".shopchoose",f)):PubSub.subscribe("yandexIsReady",function(){window.regionMap=new MapYandexWithShops(mapCenter,$("#infowindowforstockYa"),"stockmap"),window.regionMap.addHandler(".shopchoose",f)})),e==="google"&&(window.regionMap=new MapGoogleWithShops(mapCenter,$("#infowindowforstock"),"stockmap",l),window.regionMap.addHandler(".shopchoose",f))),$("#stockBlock").show()});function f(e){var t=$(e).parent().find(".shopnum").text();MVM.chooseShopById(t)}function l(e){typeof MVM!="undefined"&&MVM.pickShopOnMap(e.id)}}});