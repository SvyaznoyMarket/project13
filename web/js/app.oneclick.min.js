$(document).ready(function(){function e(){var e=this;e.noDelivery=ko.observable(!1),e.title=r.jstitle,e.price=r.jsprice,e.icon=r.jsbimg,e.shortcut=r.jsshortcut,e.stockq=r.jsstock,e.quantity=ko.observable(1),e.quantityTxt=ko.computed(function(){return e.quantity()+" шт."},this),e.priceTxt=ko.computed(function(){return printPrice(e.price)},this),e.newWarehouse=r.is_quick_only,e.formStatus=ko.observable("typing"),e.formStatusTxt=ko.computed(function(){var t="";switch(e.formStatus()){case"reserve":t="Зарезервировать";break;case"typing":t="Отправить заказ";break;case"process":t="Проверка...";break;case"error":t="Отправить заказ нельзя";break;case"sending":t="Отправка..."}return t},this);var t=docCookies.getItem("scId");e.showMap=ko.observable(!1),e.textfields=[],e.textfields.push(ko.observable({title:"Имя получателя",name:"order[recipient_first_name]",selectorid:"",value:"",valerror:!1,regexp:/^[ёa-zа-я\s]+$/i})),e.textfields.push(ko.observable({title:"Телефон для связи",name:"order[recipient_phonenumbers]",selectorid:"phonemask",value:"",valerror:!1,regexp:/^[()0-9\-\+\s]+$/})),e.textfields.push(ko.observable({title:"номер вашей карты «Связной-Клуб»",name:"order[recipient_scCard]",selectorid:"scCard",value:t,valerror:!1,regexp:/^[()0-9\-\s]+$/})),e.disabledSelectors=ko.observable(!1),e.noQBar=ko.observable(!1),e.stableType=ko.observable(!1),e.chosenDlvr=ko.observable({}),e.chosenDate=ko.observable({}),e.dlvrs=ko.observableArray([]),e.dates=ko.observableArray([]),e.shops=ko.observableArray([]),e.chosenShop=ko.observable({}),e.pickedShop=ko.observable({}),e.dynModel=function(t){var n=e.chosenDlvr().type;n||(n="self"),e.dlvrs.removeAll(),e.chosenDlvr({});for(var r in t)e.dlvrs.push({type:r,name:t[r].name,modeID:t[r].modeId,price:t[r].price}),r==n&&e.chosenDlvr(e.dlvrs()[e.dlvrs().length-1]);"type"in e.chosenDlvr()||e.chosenDlvr(e.dlvrs()[0]),e.dates(t[e.chosenDlvr().type+""].dates.slice(0)),e.chosenDate(e.dates()[0]);if(o)e.shops(t.self.shops.slice(0)),e.chosenShop(e.shops()[0]),e.pickedShop(e.shops()[0]);else{var i={address:"",regtime:"",id:1};e.chosenShop(i),e.pickedShop(i)}},e.dynModel(Deliveries),e.total=ko.computed(function(){return printPrice(e.price*e.quantity()+e.chosenDlvr().price*1)},this),e.changeDlvr=function(t){e.chosenDlvr(t),e.dates.removeAll();for(var n=0;n<Deliveries[t.type].dates.length;n++)e.dates.push(Deliveries[t.type].dates[n]);e.chosenDate(e.dates()[0]),e.showMap()&&e.showMap(!1)},e.plusItem=function(){e.quantity(e.quantity()+1);if(e.quantity()>e.stockq)return e.noDelivery(!0),!1;var t=e.quantity()*1;return setTimeout(function(){e.loadData(t,1)},500),!1},e.minusItem=function(){if(e.quantity()==1)return!1;e.quantity(e.quantity()-1);if(e.noDelivery()){if(!(e.quantity()<=e.stockq))return!1;e.noDelivery(!1)}var t=e.quantity()*1;return setTimeout(function(){e.loadData(t,-1)},500),!1},e.preparedData=function(t){if(t.type==="self"){e.formStatus("reserve");for(var n=0,r=e.dlvrs().length;n<r;n++)if(e.dlvrs()[n].type=="self"){e.chosenDlvr(e.dlvrs()[n]);break}e.disabledSelectors(!0),e.noQBar(!0),"date"in t&&e.chosenDate(t.date),"shop"in t&&e.chosenShop(t.shop)}else if(t.type==="courier"){e.formStatus("reserve");for(var n=0,r=e.dlvrs().length;n<r;n++)if(e.dlvrs()[n].type!="self"){e.chosenDlvr(e.dlvrs()[n]);break}e.disabledSelectors(!1),e.stableType(!0),e.noQBar(!0)}},e.loadData=function(t,n){if(n>0&&e.quantity()>t||n<0&&e.quantity()<t)return;var s={product_id:r.jsitemid,product_quantity:t,region_id:r.jsregionid*1};$.post(i,s,function(t){if(e.noDelivery())return!1;if(!t.success)return e.noDelivery(!0),!1;Deliveries=t.data;var n=0;for(var r in Deliveries)n++;if(n===0)return e.noDelivery(!0),!1;e.noDelivery(!1),o="self"in Deliveries,e.dynModel(Deliveries),o&&typeof mapCenter=="undefined"&&(mapCenter=calcMCenter(Deliveries.self.shops));if(o&&!("regionMap"in window)){var i=function(){window.regionMap.addHandler(".shopchoose",f)};MapInterface.init(mapCenter,"mapPopup",i)}})},e.pickDate=function(t){e.chosenDate(t);if(o&&"shopIds"in t&&t.shopIds.length>0){e.shops.removeAll();for(var n in Deliveries.self.shops)t.shopIds.indexOf(Deliveries.self.shops[n].id*1)!==-1&&e.shops.push(Deliveries.self.shops[n])}e.showMap()&&e.showMarkers()},e.pickShop=function(t){e.chosenShop(t)},e.pickShopOnMap=function(t){for(var n=0,r=e.shops().length;n<r;n++)if(e.shops()[n].id==t){e.pickedShop(e.shops()[n]);return}},e.toggleMap=function(){e.showMap()?$("#mapPopup").hide("blind",null,800,function(){e.showMap(!1)}):$("#mapPopup").show("blind",null,1e3,function(){e.showMap(!0),e.showMarkers()})},e.turnOffMap=function(){e.showMap(!1)},e.showMarkers=function(){var t={},n=e.shops();for(var r=0,i=n.length;r<i;r++){var s=n[r].id*1;t[s]={id:n[r].id,name:n[r].address,regtime:n[r].regtime,latitude:n[r].latitude,longitude:n[r].longitude}}window.regionMap.showMarkers(t)},e.chooseShopById=function(t){for(var n=0,r=e.shops().length;n<r;n++)if(e.shops()[n].id==t){e.chosenShop(e.shops()[n]);break}},e.validateField=function(t,r){var i=!1;if(r.currentTarget.name=="order[recipient_scCard]"&&r.currentTarget.value=="")return!0;if(r.currentTarget.value.replace(/\s/g,"")==""||!t.regexp.test(r.currentTarget.value))i=!0,e.formStatus("typing");r.currentTarget.getAttribute("id")==="phonemask"&&r.currentTarget.value.replace(/[^0-9]/g,"").length!==11&&(i=!0,e.formStatus("typing"));for(var s=0,o=e.textfields.length;s<o;s++)if(e.textfields[s]().name===t.name){var u=e.textfields[s]();u.valerror=i,u.value=r.currentTarget.value,e.textfields[s](u);break}return n(),!0},e.validateForm=function(){if(e.noDelivery())return!1;if(e.formStatus()!=="typing"&&e.formStatus()!=="reserve")return;e.formStatus("process"),$("#oneClick input").trigger("change");if(e.formStatus()==="typing")return;e.sendData()},e.sendData=function(){e.formStatus("sending"),$(".bFastInner tbody tr:last").empty();var t={"order[product_quantity]":e.quantity(),"order[delivered_at]":e.chosenDate().value,"order[delivery_type_id]":e.chosenDlvr().modeID};e.chosenDlvr().type=="self"&&(t["order[shop_id]"]=e.chosenShop().id);for(var n=0,r=e.textfields.length;n<r;n++)t[e.textfields[n]().name+""]=e.textfields[n]().value;var i=$.ajax({type:"POST",timeout:6e4,url:s,data:t,success:function(t,n){if(!t.success||n!=="success"){e.formStatus("typing"),$(".bFastInner tbody tr:last").append('<td colspan="2" class="red">'+t.message+"</td>");return}$(".bFast").parent().append(t.data.content),$(".bFast").remove(),$(".p0").removeClass("p0"),typeof _gaq!="undefined"&&typeof runAnalitics!="undefined"&&runAnalitics(),ANALYTICS.parseAllAnalDivs($(".jsanalytics"))},error:function(t,n){e.formStatus("typing");return}})}}function t(){var e=this;e.showMap=ko.observable(!1),e.title=r.jstitle,e.price=r.jsprice,e.icon=r.jssimg,e.shortcut=r.jsshortcut,e.region=r.jsregion,e.today=ko.observable(!0),e.todayLabel=ko.observable("Сегодня"),e.tomorrowLabel=ko.observable("Завтра"),e.priceTxt=ko.computed(function(){return printPrice(e.price)},this),e.shops=Deliveries.self.shops.slice(0),e.todayShops=[],e.tomorrowShops=[],e.activeCourier=Deliveries.length>1,parseDateShop=function(t,n){var r=[];e:for(var i=0,s=t.length;i<s;i++)for(var o=0,s=e.shops.length;o<s;o++)if(e.shops[o].id==t[i]){var u={};for(var a in e.shops[o])u[a]=e.shops[o][a];u.lbl=n,r.push(u);continue e}return r};var t=0;console.log("zzzz"),e.todayShops=parseDateShop(Deliveries.self.dates[0].shopIds,"td"),e.todayLabel(Deliveries.self.dates[0].name.match(/\d{2}\.\d{2}\.\d{4}/)[0]),Deliveries.self.dates.length>1&&(e.tomorrowShops=parseDateShop(Deliveries.self.dates[1].shopIds,"tmr"),e.tomorrowLabel(Deliveries.self.dates[1].name.match(/\d{2}\.\d{2}\.\d{4}/)[0])),e.pickedShop=ko.observable(e.todayShops[0]),e.selectedS=ko.observable({});var n="ах";e.todayShops.length%10===1&&e.todayShops.length!==11&&(n="е"),e.todayH2='Можно забрать <span class="mLft">'+Deliveries.self.dates[0].name+"</span> в "+e.todayShops.length+" магазин"+n+":",e.tomorrowShops.length%10===1&&e.tomorrowShops.length!==11?n="е":n="ах",e.tomorrowH2=e.todayShops.length>0?"или":"Можно забрать ",Deliveries.self.dates.length>1&&(e.tomorrowH2+=' <span class="mRt">'+Deliveries.self.dates[1].name+"</span> в "+e.tomorrowShops.length+" магазин"+n+":"),e.toggleView=function(t){return e.showMap(t),t&&(e.todayShops.length?e.showMarkers():e.toggleTerm(!1)),!1},e.toggleTerm=function(t){return e.today(t),window.regionMap.hideInfobox(),e.showMarkers(),!1},e.chooseShop=function(t,n){e.selectedS(t),e.today(n)},e.chooseShopById=function(t){for(var n=0,r=e.shops.length;n<r;n++)if(e.shops[n].id==t){e.selectedS(e.shops[n]);break}e.reserveItem()},e.pickShopOnMap=function(t){for(var n=0,r=e.shops.length;n<r;n++)if(e.shops[n].id==t){e.pickedShop(e.shops[n]);return}},e.showMarkers=function(){var t={},n=e.today()?e.todayShops:e.tomorrowShops;for(var r=0,i=n.length;r<i;r++){var s=n[r].id+"";t[s]={id:n[r].id,name:n[r].address,regtime:n[r].regtime,latitude:n[r].latitude,longitude:n[r].longitude}}window.regionMap.showMarkers(t)},e.reserveItem=function(){var n={type:"self",date:e.today()?Deliveries.self.dates[t]:Deliveries.self.dates[t+1],shop:e.selectedS()};return OC_MVM.preparedData(n),$("#order1click-container-new").lightbox_me({}),!1},e.onlyCourier=function(){var e={type:"courier"};return OC_MVM.preparedData(e),$("#order1click-container-new").lightbox_me({}),!1}}function n(){typeof $.mask!="undefined"&&($.mask.definitions.n="[()0-9 -]",$("#phonemask").mask("+7 nnnnnnnnnnnnnnnnn",{placeholder:" ",maxlength:10}))}$("#order1click-container-new").delegate(".bSelect","click",function(){if($(this).hasClass("mDisabled"))return!1;$(this).find(".bSelect__eDropmenu").toggle()}),$("#order1click-container-new").delegate(".bSelect","mouseleave",function(){if($(this).hasClass("mDisabled"))return!1;var e=$(this).find(".bSelect__eDropmenu");e.is(":visible")&&e.hide()});if($(".order1click-link-new").length){MapInterface.ready("yandex",{yandex:$("#map-info_window-container-ya"),google:$("#map-info_window-container")});var r=$(".order1click-link-new").data("model"),i=$(".order1click-link-new").attr("link-input"),s=$(".order1click-link-new").attr("link-output");Deliveries={self:{modeId:4,name:"Доставка",price:400,dates:[{value:"10-02-2012",name:"10 февраля"},{value:"11-02-2012",name:"11 февраля"}]}};var o=!1;oneClickIsReady=!1;var u={product_id:r.jsitemid,product_quantity:1,region_id:r.jsregionid*1};function a(e){typeof OC_MVM!="undefined"&&OC_MVM.pickShopOnMap(e.id)}$.post(i,u,function(t){if(!t.success||t.data.length===0)return OC_MVM=new e,ko.applyBindings(OC_MVM,$("#order1click-container-new")[0]),OC_MVM.noDelivery(!0),$(".order1click-link-new").remove(),!1;Deliveries=t.data,o="self"in Deliveries,o&&(mapCenter=calcMCenter(Deliveries.self.shops)),OC_MVM=new e,ko.applyBindings(OC_MVM,$("#order1click-container-new")[0]);if(o){var r=function(){window.regionMap.addHandler(".shopchoose",f)};MapInterface.init(mapCenter,"mapPopup",r,a)}oneClickIsReady=!0,n()});function f(e){var t=$(e).parent().find(".shopnum").text();window.regionMap.closeMap(OC_MVM.turnOffMap),OC_MVM.chooseShopById(t)}$(".order1click-link-new").bind("click",function(e){e.preventDefault();if(!oneClickIsReady)return!1;typeof yaCounter10503055!="undefined"&&yaCounter10503055.reachGoal("orderscomplete"),typeof _gaq!="undefined"&&_gaq.push(["_trackEvent","QuickOrder","Open"]),"ANALYTICS"in window&&ANALYTICS.runMethod("marketgidOrder"),$("#order1click-container-new").lightbox_me({centered:!0,onClose:function(){"regionMap"in window&&window.regionMap.closeMap(OC_MVM.turnOffMap)}})})}if($("#stockBlock").length){MapInterface.ready("yandex",{yandex:$("#infowindowforstockYa"),google:$("#infowindowforstock")});var r=$("#stockmodel").data("value"),i=$("#stockmodel").attr("link-input"),s=$("#stockmodel").attr("link-output"),o=!1,l=(new Date).toISOString().substr(0,10),u={product_id:r.jsitemid,product_quantity:1,region_id:r.jsregionid*1};$.post(i,u,function(r){if(!r.success)return $(".bOrderPreloader").hide(),$("#noDlvr").show(),!1;Deliveries=r.data;var i=0;for(var s in Deliveries)i++;Deliveries.length=i,"currentDate"in r&&r.currentDate!=""&&(l=r.currentDate),$(".bOrderPreloader").hide();if(i===0)return $("#noDlvr").show(),!1;o="self"in Deliveries;if(!o)return $("#noDlvr").show(),!1;if(!(Deliveries.self.dates.length>0))return $("#noDlvr").show(),!1;o&&(mapCenter=calcMCenter(Deliveries.self.shops)),MVM=new t,ko.applyBindings(MVM,$("#stockCntr")[0]),OC_MVM=new e,ko.applyBindings(OC_MVM,$("#order1click-container-new")[0]),n();if(o){var u=function(){window.regionMap.addHandler(".shopchoose",c)};MapInterface.init(mapCenter,"stockmap",u,h)}$("#stockBlock").show()});function c(e){var t=$(e).parent().find(".shopnum").text();MVM.chooseShopById(t)}function h(e){typeof MVM!="undefined"&&MVM.pickShopOnMap(e.id)}}});