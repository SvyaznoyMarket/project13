$(document).ready(function(){function l(a){$("#ajaxgoods").lightbox_me({centered:!0,closeClick:!1,closeEsc:!1});$.get(a,function(a){$("#ajaxgoods").hide();"undefined"!==typeof a.success&&a.success&&($("#order1click-form").html(a.data.form),"undefined"!==typeof a.data.shop&&"undefined"!==typeof a.data.shop.name&&($(".sLocation").remove(),$("#order1click-container h2").text("Оформить и забрать в магазине").after($("<div>").addClass("pb10").addClass("sLocation").html(a.data.shop.name+". Время работы: "+
a.data.shop.regime))),$("#order1click-container").lightbox_me({centered:!0}),m=!0,n())})}function n(){function a(a){1==c&&0>a||(c+=a,a=printPrice(d*c),$(".c1quant").html(c+" шт."),$("#order_product_quantity").val(c),$(".b1Click__ePriceBig .price").html(a))}var c=1*$("#order_product_quantity").val()||1,d=Math.round(1*$(".b1Click__ePriceBig .price").html().replace(/\s/g,"")/c);$(".c1less").live("click",function(){a(-1)});$(".c1more").live("click",function(){a(1)})}if($(".order1click-link-new").length){console.info("MODEL: ",
$(".order1click-link-new").data("model"));var i=$(".order1click-link-new").data("model");Deliveries={courier:{modeId:4,name:"Доставка",price:400,dates:[{value:"10-02-2012",name:"10 февраля"},{value:"11-02-2012",name:"11 февраля"}]}};console.info("Deliveries: ",Deliveries);var k="self"in Deliveries,o=function(){console.info("IN DEL ",Deliveries);var a=this;a.title=i.jstitle;a.price=i.jsprice;a.icon=i.jsbimg;a.shortcut=i.jsshortcut;a.quantity=ko.observable(1);a.quantityTxt=ko.computed(function(){return a.quantity()+
" шт."},this);a.priceTxt=ko.computed(function(){return printPrice(a.price)},this);a.loaded=ko.observable(!1);a.loadData=function(){};a.loadData();a.chosenDlvr=ko.observable({});a.dlvrs=[];for(var c in Deliveries)a.dlvrs.push({type:c,name:Deliveries[c].name,modeID:Deliveries[c].modeId}),"self"==c&&a.chosenDlvr(a.dlvrs[a.dlvrs.length-1]);"type"in a.chosenDlvr()||a.chosenDlvr(a.dlvrs[0]);a.total=ko.computed(function(){return printPrice(a.price*a.quantity()+1*Deliveries[a.chosenDlvr().type].price)},this);
a.changeDlvr=function(d){a.chosenDlvr(d);a.dates.removeAll();for(var b=0;b<Deliveries[d.type].dates.length;b++)a.dates.push(Deliveries[d.type].dates[b]);a.chosenDate(a.dates()[0]);a.showMap()&&a.showMap(!1)};a.plusItem=function(){a.quantity(a.quantity()+1);return!1};a.minusItem=function(){1<a.quantity()&&a.quantity(a.quantity()-1);return!1};a.dates=ko.observableArray(Deliveries[a.chosenDlvr().type+""].dates.slice(0));a.chosenDate=ko.observable(a.dates()[0]);a.pickDate=function(d){a.chosenDate(d);
if(k&&"shopIds"in d&&0<d.shopIds.length){a.shops.removeAll();for(var b in Deliveries.self.shops)console.info(Deliveries.self.shops[b],d.shopIds.indexOf(Deliveries.self.shops[b].id)),-1!==d.shopIds.indexOf(Deliveries.self.shops[b].id)&&a.shops.push(Deliveries.self.shops[b])}a.showMarkers()};k?(a.shops=ko.observableArray(Deliveries.self.shops.slice(0)),a.chosenShop=ko.observable(a.shops()[0]),a.pickedShop=ko.observable(a.shops()[0])):(a.shops=ko.observableArray([]),c={address:"",regtime:"",id:1},a.chosenShop=
ko.observable(c),a.pickedShop=ko.observable(c));a.pickShop=function(d){a.chosenShop(d)};a.pickShopOnMap=function(d){for(var b=0,c=a.shops().length;b<c;b++)if(a.shops()[b].id==d){a.pickedShop(a.shops()[b]);break}};a.showMap=ko.observable(!1);a.toggleMap=function(){a.showMap()?$("#mapPopup").hide("blind",null,800,function(){a.showMap(!1)}):(a.showMap(!0),$("#mapPopup").show("blind",null,1E3));a.showMap()&&a.showMarkers()};a.showMarkers=function(){for(var d={},b=a.shops(),c=0,e=b.length;c<e;c++)d[b[c].id+
""]={id:b[c].id,name:b[c].address,regtime:b[c].regtime,latitude:b[c].latitude,longitude:b[c].longitude};window.regionMap.showMarkers(d)};a.formStatus=ko.observable("typing");a.formStatusTxt=ko.computed(function(){var d="";switch(a.formStatus()){case "typing":d="Отправить заказ";break;case "process":d="Проверка...";break;case "error":d="Произошла ошибка!";break;case "sending":d="Отправка..."}return d},this);a.textfields=[];a.textfields.push(ko.observable({title:"Имя получателя",name:"fio",value:"",
valerror:!1,regexp:/^[a-zа-я\s]+$/i}));a.textfields.push(ko.observable({title:"Телефон для связи",name:"phone",value:"",valerror:!1,regexp:/^[0-9\-\+\s]+$/}));a.validateField=function(d,b){console.info(d,b.currentTarget.value,d.regexp.test(b.currentTarget.value));var c=!1;if(""==b.currentTarget.value.replace(/\s/g,"")||!d.regexp.test(b.currentTarget.value))c=!0,a.formStatus("typing");for(var e=0,h=a.textfields.length;e<h;e++)if(a.textfields[e]().name===d.name){h=a.textfields[e]();h.valerror=c;h.value=
b.currentTarget.value;a.textfields[e](h);break}};a.validateForm=function(){console.info("validateForm");"typing"===a.formStatus()&&(a.formStatus("process"),$("#oneClick input").trigger("change"),"typing"!==a.formStatus()&&a.sendData())};a.sendData=function(){a.formStatus("sending");for(var d={quantity:a.quantity(),delivery:a.chosenDlvr().modeID,date:a.chosenDate().value,shop:a.chosenShop().id},b=0,c=a.textfields.length;b<c;b++)d[a.textfields[b]().name+""]=a.textfields[b]().value;console.info(d)}};
oneClickIsReady=!1;var g=$(".order1click-link-new").attr("link-input");$.post(g,{product_id:i.jsitemid,product_quantity:1,region_id:1*i.jsregionid},function(a){Deliveries=a.data;if(k="self"in Deliveries){for(var c=a=0,d=0,b=Deliveries.self.shops.length;d<b;d++)a+=1*Deliveries.self.shops[d].latitude,c+=1*Deliveries.self.shops[d].longitude;c={latitude:a/Deliveries.self.shops.length,longitude:c/Deliveries.self.shops.length}}MVM=new o;ko.applyBindings(MVM);if(k)window.regionMap=new p(c,$("#map-info_window-container"),
"mapPopup");oneClickIsReady=!0});var p=function(a,c,d){var b=this;b.mapWS=null;b.infoWindow=null;b.positionC=null;b.markers=[];this.showInfobox=function(a){MVM.pickShopOnMap(a.id);a.setVisible(!1);b.infoWindow.setContent(c.prop("innerHTML"));b.infoWindow.setPosition(a.position);b.infoWindow.open(b.mapWS);google.maps.event.addListener(b.infoWindow,"closeclick",function(){a.setVisible(!0)})};this.showMarkers=function(a){$.each(b.markers,function(a,b){"undefined"!==typeof b.ref&&b.ref.setMap(null)});
b.markers=a;google.maps.event.trigger(b.mapWS,"resize");b.mapWS.setCenter(b.positionC);$.each(a,function(a,d){var c=new google.maps.Marker({position:new google.maps.LatLng(d.latitude,d.longitude),map:b.mapWS,title:d.name,icon:"/images/marker.png",id:d.id});google.maps.event.addListener(c,"click",function(){b.showInfobox(this)});b.markers[c.id].ref=c})};this.closeMap=function(){b.infoWindow.close();$("#mapPopup").hide("blind",null,800,function(){MVM.showMap(!1)})};(function(){b.positionC=new google.maps.LatLng(a.latitude,
a.longitude);var c={zoom:11,center:b.positionC,scrollwheel:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}};b.mapWS=new google.maps.Map(document.getElementById(d),c);b.infoWindow=new google.maps.InfoWindow({maxWidth:400,disableAutoPan:!1})})()},g=$("#mapPopup");g.delegate(".shopchoose","click",function(a){a.preventDefault();j(a.target)});g[0].addEventListener("touchstart",function(a){a.preventDefault();a.target.className.match("shopchoose")&&
j(a.target)},!1);var j=function(a){a=$(a).parent().find(".shopnum").text();window.regionMap.closeMap();for(var c=0,d=MVM.shops().length;c<d;c++)MVM.shops()[c].id==a&&MVM.chosenShop(MVM.shops()[c])};$("#order1click-container-new").delegate(".bSelect","click",function(){$(this).find(".bSelect__eDropmenu").toggle()});$(".order1click-link-new").bind("click",function(a){a.preventDefault();oneClickIsReady&&("undefined"!==typeof _gaq&&_gaq.push(["_trackEvent","QuickOrder","Open"]),$("#order1click-container-new").lightbox_me({centered:!0,
onClose:function(){MVM.showMap(!1)}}))})}$("#gMap").length&&($("#gMap").bind({create:function(a,c,d,b){var f=$(this),a={zoom:11,center:new google.maps.LatLng(c.latitude,c.longitude),scrollwheel:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}},e=new google.maps.Map(document.getElementById(f.attr("id")),a),a=new InfoBox({disableAutoPan:!1,maxWidth:0,pixelOffset:new google.maps.Size(-11,-108),zIndex:null,boxStyle:{opacity:0.85,width:"280px"},
closeBoxURL:"http://www.google.com/intl/en_us/mapfiles/close.gif",infoBoxClearance:new google.maps.Size(1,1),isHidden:!1,pane:"floatShadow",enableEventPropagation:!0}),h=function(){var a=d[this.id];f.trigger("showMarkers");f.trigger("infoWindow",[this,a])};f.data("markers",[]);$.each(d,function(a,b){var d=new google.maps.Marker({position:new google.maps.LatLng(b.latitude,b.longitude),map:e,title:b.name,icon:"/images/marker.png",id:b.id});google.maps.event.addListener(d,"click",h);f.data("markers").push(d)});
google.maps.event.addListener(e,"bounds_changed",function(){});google.maps.event.addListener(e,"click",function(){});google.maps.event.addListener(a,"closeclick",function(){f.trigger("showMarkers")});f.data("map",e);f.data("infoWindow",a);f.data("infoWindowTemplate",b)},move:function(){$(this).data("map")},infoWindow:function(a,c,d){var b=$(this),a=b.data("map"),f=b.data("infoWindow"),b=b.data("infoWindowTemplate");c.setMap(null);$.each(b.find("[data-name]"),function(a,b){b.innerHTML=d[$(b).data("name")]});
f.setContent(b.prop("innerHTML"));f.open(a,c)},showMarkers:function(){var a=$(this);$.each(a.data("markers"),function(c,d){null==d.map&&d.setMap(a.data("map"))})}}),g=$("#gMap"),g.trigger("create",[$("#map-center").data("content"),$("#map-markers").data("content"),$("#map-info_window-container")]),g.delegate(".shopchoose","click",function(a){j(a.target)}),g[0].addEventListener("touchstart",function(a){a.target.className.match("shopchoose")&&j(a.target)},!1),j=function(a){l($(a).parent().find(".shopnum").text())},
$(".bInShopLine__eButton a").bind("click",function(a){a.preventDefault();l($(this).attr("href"))}),$(".bInShop__eCurrent a").click(function(){$.getJSON("/region/init",function(a){if(!a.success)return!1;var a=a.data,c=$("<div>").addClass("graying").css({opacity:"0.5"}),d=$('<div class="bCityPopupWrap">').html('<div class="hideblock bCityPopup"><i title="Закрыть" class="close">Закрыть</i><div class="title">Привет! Из какого вы города?</div></div></div>');d.find(".close").click(function(){$(".graying").remove();
$(".bCityPopupWrap").hide()});for(var b=0,f=a.length;b<f;b++)if(!("undefined"===typeof a[b].link||"undefined"===typeof a[b].name)){var e=$("<div>").append($("<a>").attr("href",a[b].link).text(a[b].name));"undefined"!==typeof a[b].is_active?(e.addClass("bCityPopup__eCurrent"),d.find(".title").after(e)):(e.addClass("bCityPopup__eBlock"),d.find("div:first").append(e))}$("body").append(c).append(d)});return!1}));var m=!1;$(".order1click-link").bind("click",function(a){a.preventDefault();"undefined"!==
typeof _gaq&&_gaq.push(["_trackEvent","QuickOrder","Open"]);m?$("#order1click-container").lightbox_me({centered:!0}):l($(this).attr("href"))});$("#order1click-form").bind("submit",function(a){a.preventDefault();var a=$(this),c=a.find("input:submit");c.attr("disabled",!0);c.val("Оформляю заказ...");c=a.serializeArray();$.ajax({type:"POST",url:a.attr("action"),data:c,success:function(a){a.success?a.data&&($("#order1click-container").find("h2").html(a.data.title),$("#order1click-form").replaceWith(a.data.content),
runAnalitics&&runAnalitics()):(a.data&&$("#order1click-form").html(a.data.form),a=$("#order1click-form").find("input:submit"),a.attr("disabled",!1),a.val("Оформить заказ"),$("#warn").length||(a=$('<span id="warn" style="color:red">').html("Не удалось оформить заказ. Приносим свои извинения! Повторите попытку или обратитесь с заказом в контакт cENTER&nbsp;8&nbsp;(800)&nbsp;700&nbsp;00&nbsp;09"),$(".bFormB2").before(a)))}})})});
