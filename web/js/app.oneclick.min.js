$(document).ready(function(){function n(a){for(var b=0,c=0,d=a.length,g=0;g<d;g++)b+=1*a[g].latitude,c+=1*a[g].longitude;return{latitude:b/d,longitude:c/d}}function o(a,b,c,d){var g=this,h=null,k=null,e=null,f=[],i=$("#"+c),l=b.prop("innerHTML");this.updateInfoWindowTemplate=function(a){d&&d(a);l=b.prop("innerHTML")};this.showInfobox=function(a){var b=f[a.id];a.setVisible(!1);g.updateInfoWindowTemplate(b);k.setContent(l);k.setPosition(a.position);k.open(h);google.maps.event.addListener(k,"closeclick",
function(){a.setVisible(!0)})};this.hideInfobox=function(){k.close()};this.showMarkers=function(a){$.each(f,function(a,b){"undefined"!==typeof b.ref&&b.ref.setMap(null)});f=a;google.maps.event.trigger(h,"resize");h.setCenter(e);$.each(f,function(a,b){var c=new google.maps.Marker({position:new google.maps.LatLng(b.latitude,b.longitude),map:h,title:b.name,icon:"/images/marker.png",id:b.id});google.maps.event.addListener(c,"click",function(){g.showInfobox(this)});f[c.id].ref=c})};this.closeMap=function(a){k.close();
i.hide("blind",null,800,function(){0<arguments.length&&a()})};this.addHandler=function(a,b){i.delegate(a,"click",function(a){a.preventDefault();b(a.target)});i[0].addEventListener("touchstart",function(c){c.preventDefault();c.target.is(a)&&b(c.target)},!1)};(function(){e=new google.maps.LatLng(a.latitude,a.longitude);var b={zoom:11,center:e,scrollwheel:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}};h=new google.maps.Map(document.getElementById(c),
b);k=new google.maps.InfoWindow({maxWidth:400,disableAutoPan:!1})})()}function p(){var a=this;a.noDelivery=ko.observable(!1);a.title=e.jstitle;a.price=e.jsprice;a.icon=e.jsbimg;a.shortcut=e.jsshortcut;a.quantity=ko.observable(1);a.quantityTxt=ko.computed(function(){return a.quantity()+" шт."},this);a.priceTxt=ko.computed(function(){return printPrice(a.price)},this);a.formStatus=ko.observable("typing");a.formStatusTxt=ko.computed(function(){var b="";switch(a.formStatus()){case "reserve":b="Зарезервировать";
break;case "typing":b="Отправить заказ";break;case "process":b="Проверка...";break;case "error":b="Произошла ошибка!";break;case "sending":b="Отправка..."}return b},this);a.showMap=ko.observable(!1);a.textfields=[];a.textfields.push(ko.observable({title:"Имя получателя",name:"order[recipient_first_name]",selectorid:"",value:"",valerror:!1,regexp:/^[a-zа-я\s]+$/i}));a.textfields.push(ko.observable({title:"Телефон для связи",name:"order[recipient_phonenumbers]",selectorid:"phonemask",value:"",valerror:!1,
regexp:/^[()0-9\-\+\s]+$/}));a.disabledSelectors=ko.observable(!1);a.noQBar=ko.observable(!1);a.stableType=ko.observable(!1);a.chosenDlvr=ko.observable({});a.chosenDate=ko.observable({});a.dlvrs=ko.observableArray([]);a.dates=ko.observableArray([]);a.shops=ko.observableArray([]);a.chosenShop=ko.observable({});a.pickedShop=ko.observable({});a.dynModel=function(b){a.dlvrs.removeAll();a.chosenDlvr({});for(var c in b)a.dlvrs.push({type:c,name:b[c].name,modeID:b[c].modeId,price:b[c].price}),"self"==c&&
a.chosenDlvr(a.dlvrs()[a.dlvrs().length-1]);"type"in a.chosenDlvr()||a.chosenDlvr(a.dlvrs()[0]);a.dates(b[a.chosenDlvr().type+""].dates.slice(0));a.chosenDate(a.dates()[0]);f?(a.shops(b.self.shops.slice(0)),a.chosenShop(a.shops()[0]),a.pickedShop(a.shops()[0])):(b={address:"",regtime:"",id:1},a.chosenShop(b),a.pickedShop(b))};a.dynModel(Deliveries);a.total=ko.computed(function(){return printPrice(a.price*a.quantity()+1*a.chosenDlvr().price)},this);a.changeDlvr=function(b){a.chosenDlvr(b);a.dates.removeAll();
for(var c=0;c<Deliveries[b.type].dates.length;c++)a.dates.push(Deliveries[b.type].dates[c]);a.chosenDate(a.dates()[0]);a.showMap()&&a.showMap(!1)};a.plusItem=function(){a.quantity(a.quantity()+1);var b=1*a.quantity();setTimeout(function(){a.loadData(b,1)},500);return!1};a.minusItem=function(){if(1==a.quantity())return!1;a.quantity(a.quantity()-1);var b=1*a.quantity();setTimeout(function(){a.loadData(b,-1)},500);return!1};a.preparedData=function(b){if("self"===b.type){a.formStatus("reserve");for(var c=
0,d=a.dlvrs().length;c<d;c++)if("self"==a.dlvrs()[c].type){a.chosenDlvr(a.dlvrs()[c]);break}a.disabledSelectors(!0);a.noQBar(!0);"date"in b&&a.chosenDate(b.date);"shop"in b&&a.chosenShop(b.shop)}else if("courier"===b.type){a.formStatus("reserve");c=0;for(d=a.dlvrs().length;c<d;c++)if("self"!=a.dlvrs()[c].type){a.chosenDlvr(a.dlvrs()[c]);break}a.disabledSelectors(!1);a.stableType(!0);a.noQBar(!0)}};a.loadData=function(b,c){0<c&&a.quantity()>b||0>c&&a.quantity()<b||$.post(j,{product_id:e.jsitemid,product_quantity:b,
region_id:1*e.jsregionid},function(b){if(!b.success)return!1;Deliveries=b.data;var b=0,c;for(c in Deliveries)b++;if(0===b)return a.noDelivery(!0),!1;a.noDelivery(!1);f="self"in Deliveries;a.dynModel(Deliveries);f&&"undefined"==typeof mapCenter&&(mapCenter=n(Deliveries.self.shops));if(f&&!("regionMap"in window))window.regionMap=new o(mapCenter,$("#map-info_window-container"),"mapPopup"),window.regionMap.addHandler(".shopchoose",m)})};a.pickDate=function(b){a.chosenDate(b);if(f&&"shopIds"in b&&0<b.shopIds.length){a.shops.removeAll();
for(var c in Deliveries.self.shops)-1!==b.shopIds.indexOf(Deliveries.self.shops[c].id)&&a.shops.push(Deliveries.self.shops[c])}a.showMap()&&a.showMarkers()};a.pickShop=function(b){a.chosenShop(b)};a.pickShopOnMap=function(b){for(var c=0,d=a.shops().length;c<d;c++)if(a.shops()[c].id==b){a.pickedShop(a.shops()[c]);break}};a.toggleMap=function(){a.showMap()?$("#mapPopup").hide("blind",null,800,function(){a.showMap(!1)}):(a.showMap(!0),$("#mapPopup").show("blind",null,1E3));a.showMap()&&a.showMarkers()};
a.turnOffMap=function(){a.showMap(!1)};a.showMarkers=function(){for(var b={},c=a.shops(),d=0,g=c.length;d<g;d++)b[c[d].id+""]={id:c[d].id,name:c[d].address,regtime:c[d].regtime,latitude:c[d].latitude,longitude:c[d].longitude};window.regionMap.showMarkers(b)};a.chooseShopById=function(b){for(var c=0,d=a.shops().length;c<d;c++)if(a.shops()[c].id==b){a.chosenShop(a.shops()[c]);break}};a.validateField=function(b,c){var d=!1;if(""==c.currentTarget.value.replace(/\s/g,"")||!b.regexp.test(c.currentTarget.value))d=
!0,a.formStatus("typing");"phonemask"===c.currentTarget.getAttribute("id")&&11!==c.currentTarget.value.replace(/[^0-9]/g,"").length&&(d=!0,a.formStatus("typing"));for(var g=0,h=a.textfields.length;g<h;g++)if(a.textfields[g]().name===b.name){h=a.textfields[g]();h.valerror=d;h.value=c.currentTarget.value;a.textfields[g](h);break}};a.validateForm=function(){if(a.noDelivery())return!1;"typing"!==a.formStatus()&&"reserve"!==a.formStatus()||(a.formStatus("process"),$("#oneClick input").trigger("change"),
"typing"!==a.formStatus()&&a.sendData())};a.sendData=function(){a.formStatus("sending");var b={"order[product_quantity]":a.quantity(),"order[delivered_at]":a.chosenDate().value};if("self"==a.chosenDlvr().type)b["order[shop_id]"]=a.chosenShop().id;for(var c=0,d=a.textfields.length;c<d;c++)b[a.textfields[c]().name+""]=a.textfields[c]().value;$.post(t,b,function(b){b.success?($(".bFast").parent().append(b.data.content),$(".bFast").remove(),$(".p0").removeClass("p0"),$(".top0").removeClass("top0"),$(".order1click-link-new").remove()):
a.formStatus("typing")})}}function v(){var a=this;a.showMap=ko.observable(!1);a.title=e.jstitle;a.price=e.jsprice;a.icon=e.jssimg;a.shortcut=e.jsshortcut;a.region=e.jsregion;a.today=ko.observable(!0);a.priceTxt=ko.computed(function(){return printPrice(a.price)},this);a.shops=Deliveries.self.shops.slice(0);a.todayShops=[];a.tomorrowShops=[];a.activeCourier=1<Deliveries.length;parseDateShop=function(b,c){var d=[],e=0,f=b.length;a:for(;e<f;e++)for(var i=0,f=a.shops.length;i<f;i++)if(a.shops[i].id==b[e]){var l=
{},j;for(j in a.shops[i])l[j]=a.shops[i][j];l.lbl=c;d.push(l);continue a}return d};for(var b=-1,c=0,d=Deliveries.self.dates.length;c<d;c++)if(Deliveries.self.dates[c].value===q){b=c;break}else if(Date.parse(q)==Date.parse(Deliveries.self.dates[c].value)){b=c;break}if(!(0>b))a.todayShops=parseDateShop(Deliveries.self.dates[b].shopIds,"td");a.tomorrowShops=parseDateShop(Deliveries.self.dates[b+1].shopIds,"tmr");a.pickedShop=ko.observable(a.todayShops[0]);a.selectedS=ko.observable({});c="ах";1===a.todayShops.length%
10&&(c="е");a.todayH2='Можно <span class="mLft">сегодня</span> в '+a.todayShops.length+" магазин"+c+":";c=1===a.tomorrowShops.length%10?"е":"ах";a.tomorrowH2=0<a.todayShops.length?"или":"Можно";a.tomorrowH2+=' <span class="mRt">завтра</span> в '+a.tomorrowShops.length+" магазин"+c+":";a.toggleView=function(b){a.showMap(b);b&&a.showMarkers();return!1};a.toggleTerm=function(b){a.today(b);window.regionMap.hideInfobox();a.showMarkers();return!1};a.chooseShop=function(b,c){a.selectedS(b);a.today(c)};a.chooseShopById=
function(b){for(var c=0,d=a.shops.length;c<d;c++)if(a.shops[c].id==b){a.selectedS(a.shops[c]);break}a.reserveItem()};a.pickShopOnMap=function(b){for(var c=0,d=a.shops.length;c<d;c++)if(a.shops[c].id==b){a.pickedShop(a.shops[c]);break}};a.showMarkers=function(){for(var b={},c=a.today()?a.todayShops:a.tomorrowShops,d=0,e=c.length;d<e;d++)b[c[d].id+""]={id:c[d].id,name:c[d].address,regtime:c[d].regtime,latitude:c[d].latitude,longitude:c[d].longitude};window.regionMap.showMarkers(b)};a.reserveItem=function(){var c=
{type:"self",date:a.today()?Deliveries.self.dates[b]:Deliveries.self.dates[b+1],shop:a.selectedS()};OC_MVM.preparedData(c);$("#order1click-container-new").lightbox_me({});return!1};a.onlyCourier=function(){OC_MVM.preparedData({type:"courier"});$("#order1click-container-new").lightbox_me({});return!1}}function u(){if("undefined"!==typeof $.mask)$.mask.definitions.n="[()0-9 -]",$("#phonemask").mask("+7 nnnnnnnnnnnnnnnnn",{placeholder:" "})}$("#order1click-container-new").delegate(".bSelect","click",
function(){if($(this).hasClass("mDisabled"))return!1;$(this).find(".bSelect__eDropmenu").toggle()});$("#order1click-container-new").delegate(".bSelect","mouseleave",function(){if($(this).hasClass("mDisabled"))return!1;var a=$(this).find(".bSelect__eDropmenu");a.is(":visible")&&a.hide()});if($(".order1click-link-new").length){var e=$(".order1click-link-new").data("model"),j=$(".order1click-link-new").attr("link-input"),t=$(".order1click-link-new").attr("link-output");Deliveries={courier:{modeId:4,
name:"Доставка",price:400,dates:[{value:"10-02-2012",name:"10 февраля"},{value:"11-02-2012",name:"11 февраля"}]}};var f="self"in Deliveries;oneClickIsReady=!1;var r={product_id:e.jsitemid,product_quantity:1,region_id:1*e.jsregionid};$.post(j,r,function(a){if(!a.success||0===a.data.length)return OC_MVM=new p,ko.applyBindings(OC_MVM,$("#order1click-container-new")[0]),OC_MVM.noDelivery(!0),$(".order1click-link-new").remove(),!1;Deliveries=a.data;(f="self"in Deliveries)&&(mapCenter=n(Deliveries.self.shops));
OC_MVM=new p;ko.applyBindings(OC_MVM,$("#order1click-container-new")[0]);if(f)window.regionMap=new o(mapCenter,$("#map-info_window-container"),"mapPopup",s),window.regionMap.addHandler(".shopchoose",m);oneClickIsReady=!0;u()});var m=function(a){a=$(a).parent().find(".shopnum").text();window.regionMap.closeMap(OC_MVM.turnOffMap);OC_MVM.chooseShopById(a)},s=function(a){"undefined"!==typeof OC_MVM&&OC_MVM.pickShopOnMap(a.id)};$(".order1click-link-new").bind("click",function(a){a.preventDefault();oneClickIsReady&&
("undefined"!==typeof _gaq&&_gaq.push(["_trackEvent","QuickOrder","Open"]),$("#order1click-container-new").lightbox_me({centered:!0,onClose:function(){"regionMap"in window&&window.regionMap.closeMap(OC_MVM.turnOffMap)}}))})}if($("#stockBlock").length){var e=$("#stockmodel").data("value"),j=$("#stockmodel").attr("link-input"),t=$("#stockmodel").attr("link-output"),f=!1,q=(new Date).toISOString().substr(0,10),r={product_id:e.jsitemid,product_quantity:1,region_id:1*e.jsregionid};$.post(j,r,function(a){if(!a.success)return!1;
Deliveries=a.data;var b=0,c;for(c in Deliveries)b++;Deliveries.length=b;if("currentDate"in a&&""!=a.currentDate)q=a.currentDate;$(".bOrderPreloader").hide();if(0===b)return $("#noDlvr").show(),!1;(f="self"in Deliveries)&&(mapCenter=n(Deliveries.self.shops));MVM=new v;ko.applyBindings(MVM,$("#stockCntr")[0]);OC_MVM=new p;ko.applyBindings(OC_MVM,$("#order1click-container-new")[0]);u();if(f)window.regionMap=new o(mapCenter,$("#infowindowforstock"),"stockmap",s),window.regionMap.addHandler(".shopchoose",
m);$("#stockBlock").show()});m=function(a){a=$(a).parent().find(".shopnum").text();MVM.chooseShopById(a)};s=function(a){"undefined"!==typeof MVM&&MVM.pickShopOnMap(a.id)}}});
