$(document).ready(function(){function i(a){$("#ajaxgoods").lightbox_me({centered:!0,closeClick:!1,closeEsc:!1});$.get(a,function(a){$("#ajaxgoods").hide();"undefined"!==typeof a.success&&a.success&&($("#order1click-form").html(a.data.form),"undefined"!==typeof a.data.shop&&"undefined"!==typeof a.data.shop.name&&($(".sLocation").remove(),$("#order1click-container h2").text("Оформить и забрать в магазине").after($("<div>").addClass("pb10").addClass("sLocation").html(a.data.shop.name+". Время работы: "+
a.data.shop.regime))),$("#order1click-container").lightbox_me({centered:!0}),k=!0,q())})}function q(){function a(a){1==b&&0>a||(b+=a,a=printPrice(c*b),$(".c1quant").html(b+" шт."),$("#order_product_quantity").val(b),$(".b1Click__ePriceBig .price").html(a))}var b=1*$("#order_product_quantity").val()||1,c=Math.round(1*$(".b1Click__ePriceBig .price").html().replace(/\s/g,"")/b);$(".c1less").live("click",function(){a(-1)});$(".c1more").live("click",function(){a(1)})}if($(".order1click-link-new").length){var g=
$(".order1click-link-new").data("model");Deliveries={courier:{modeId:4,name:"Доставка",price:400,dates:[{value:"10-02-2012",name:"10 февраля"},{value:"11-02-2012",name:"11 февраля"}]}};var h="self"in Deliveries,r=function(){var a=this;a.noDelivery=ko.observable(!1);a.title=g.jstitle;a.price=g.jsprice;a.icon=g.jsbimg;a.shortcut=g.jsshortcut;a.quantity=ko.observable(1);a.quantityTxt=ko.computed(function(){return a.quantity()+" шт."},this);a.priceTxt=ko.computed(function(){return printPrice(a.price)},
this);a.formStatus=ko.observable("typing");a.formStatusTxt=ko.computed(function(){var b="";switch(a.formStatus()){case "typing":b="Отправить заказ";break;case "process":b="Проверка...";break;case "error":b="Произошла ошибка!";break;case "sending":b="Отправка..."}return b},this);a.showMap=ko.observable(!1);a.textfields=[];a.textfields.push(ko.observable({title:"Имя получателя",name:"order[recipient_first_name]",value:"",valerror:!1,regexp:/^[a-zа-я\s]+$/i}));a.textfields.push(ko.observable({title:"Телефон для связи",
name:"order[recipient_phonenumbers]",value:"",valerror:!1,regexp:/^[0-9\-\+\s]+$/}));a.chosenDlvr=ko.observable({});a.chosenDate=ko.observable({});a.dlvrs=ko.observableArray([]);a.dates=ko.observableArray([]);a.shops=ko.observableArray([]);a.chosenShop=ko.observable({});a.pickedShop=ko.observable({});a.dynModel=function(b){a.dlvrs.removeAll();a.chosenDlvr({});for(var c in b)a.dlvrs.push({type:c,name:b[c].name,modeID:b[c].modeId,price:b[c].price}),"self"==c&&a.chosenDlvr(a.dlvrs()[a.dlvrs().length-
1]);"type"in a.chosenDlvr()||a.chosenDlvr(a.dlvrs()[0]);a.dates(b[a.chosenDlvr().type+""].dates.slice(0));a.chosenDate(a.dates()[0]);h?(a.shops(b.self.shops.slice(0)),a.chosenShop(a.shops()[0]),a.pickedShop(a.shops()[0])):(b={address:"",regtime:"",id:1},a.chosenShop(b),a.pickedShop(b))};a.dynModel(Deliveries);a.total=ko.computed(function(){return printPrice(a.price*a.quantity()+1*a.chosenDlvr().price)},this);a.changeDlvr=function(b){a.chosenDlvr(b);a.dates.removeAll();for(var c=0;c<Deliveries[b.type].dates.length;c++)a.dates.push(Deliveries[b.type].dates[c]);
a.chosenDate(a.dates()[0]);a.showMap()&&a.showMap(!1)};a.plusItem=function(){a.quantity(a.quantity()+1);var b=1*a.quantity();setTimeout(function(){a.loadData(b,1)},500);return!1};a.minusItem=function(){if(1==a.quantity())return!1;a.quantity(a.quantity()-1);var b=1*a.quantity();setTimeout(function(){a.loadData(b,-1)},500);return!1};a.loadData=function(b,c){0<c&&a.quantity()>b||0>c&&a.quantity()<b||$.post(l,{product_id:g.jsitemid,product_quantity:b,region_id:1*g.jsregionid},function(c){if(!c.success)return!1;
Deliveries=c.data;var c=0,b;for(b in Deliveries)c++;if(0===c)return a.noDelivery(!0),!1;a.noDelivery(!1);h="self"in Deliveries;a.dynModel(Deliveries);h&&"undefined"==typeof mapCenter&&(mapCenter=m(Deliveries.self.shops));if(h&&!("regionMap"in window))window.regionMap=new n(mapCenter,$("#map-info_window-container"),"mapPopup"),window.regionMap.addHandler(".shopchoose",o)})};a.pickDate=function(b){a.chosenDate(b);if(h&&"shopIds"in b&&0<b.shopIds.length){a.shops.removeAll();for(var c in Deliveries.self.shops)console.info(Deliveries.self.shops[c],
b.shopIds.indexOf(Deliveries.self.shops[c].id)),-1!==b.shopIds.indexOf(Deliveries.self.shops[c].id)&&a.shops.push(Deliveries.self.shops[c])}a.showMap()&&a.showMarkers()};a.pickShop=function(b){a.chosenShop(b)};a.pickShopOnMap=function(b){for(var c=0,d=a.shops().length;c<d;c++)if(a.shops()[c].id==b){a.pickedShop(a.shops()[c]);break}};a.toggleMap=function(){a.showMap()?$("#mapPopup").hide("blind",null,800,function(){a.showMap(!1)}):(a.showMap(!0),$("#mapPopup").show("blind",null,1E3));a.showMap()&&
a.showMarkers()};a.showMarkers=function(){for(var b={},c=a.shops(),d=0,e=c.length;d<e;d++)b[c[d].id+""]={id:c[d].id,name:c[d].address,regtime:c[d].regtime,latitude:c[d].latitude,longitude:c[d].longitude};window.regionMap.showMarkers(b)};a.chooseShopById=function(b){for(var c=0,d=a.shops().length;c<d;c++)if(a.shops()[c].id==b){a.chosenShop(a.shops()[c]);break}};a.validateField=function(b,c){var d=!1;if(""==c.currentTarget.value.replace(/\s/g,"")||!b.regexp.test(c.currentTarget.value))d=!0,a.formStatus("typing");
for(var e=0,f=a.textfields.length;e<f;e++)if(a.textfields[e]().name===b.name){f=a.textfields[e]();f.valerror=d;f.value=c.currentTarget.value;a.textfields[e](f);break}};a.validateForm=function(){if(a.noDelivery())return!1;"typing"===a.formStatus()&&(a.formStatus("process"),$("#oneClick input").trigger("change"),"typing"!==a.formStatus()&&a.sendData())};a.sendData=function(){var b=$(".order1click-link-new").attr("link-output");a.formStatus("sending");var c={"order[product_quantity]":a.quantity(),"order[delivered_at]":a.chosenDate().value};
if("self"==a.chosenDlvr().type)c["order[shop_id]"]=a.chosenShop().id;for(var d=0,e=a.textfields.length;d<e;d++)c[a.textfields[d]().name+""]=a.textfields[d]().value;console.info("OUT DEL: ",c);$.post(b,c,function(c){c.success||a.formStatus("typing")})}};oneClickIsReady=!1;var l=$(".order1click-link-new").attr("link-input"),m=function(a){for(var b=0,c=0,d=a.length,e=0;e<d;e++)b+=1*a[e].latitude,c+=1*a[e].longitude;return{latitude:b/d,longitude:c/d}};$.post(l,{product_id:g.jsitemid,product_quantity:1,
region_id:1*g.jsregionid},function(a){if(!a.success)return MVM.noDelivery(!0),!1;Deliveries=a.data;(h="self"in Deliveries)&&(mapCenter=m(Deliveries.self.shops));MVM=new r;ko.applyBindings(MVM);if(h)window.regionMap=new n(mapCenter,$("#map-info_window-container"),"mapPopup"),window.regionMap.addHandler(".shopchoose",o);oneClickIsReady=!0});var n=function(a,b,c){var d=this;d.mapWS=null;d.infoWindow=null;d.positionC=null;d.markers=[];var e=$("#"+c);this.showInfobox=function(a){MVM.pickShopOnMap(a.id);
a.setVisible(!1);d.infoWindow.setContent(b.prop("innerHTML"));d.infoWindow.setPosition(a.position);d.infoWindow.open(d.mapWS);google.maps.event.addListener(d.infoWindow,"closeclick",function(){a.setVisible(!0)})};this.showMarkers=function(a){$.each(d.markers,function(a,c){"undefined"!==typeof c.ref&&c.ref.setMap(null)});d.markers=a;google.maps.event.trigger(d.mapWS,"resize");d.mapWS.setCenter(d.positionC);$.each(a,function(a,c){var b=new google.maps.Marker({position:new google.maps.LatLng(c.latitude,
c.longitude),map:d.mapWS,title:c.name,icon:"/images/marker.png",id:c.id});google.maps.event.addListener(b,"click",function(){d.showInfobox(this)});d.markers[b.id].ref=b})};this.closeMap=function(){d.infoWindow.close();e.hide("blind",null,800,function(){MVM.showMap(!1)})};this.addHandler=function(a,c){e.delegate(a,"click",function(a){a.preventDefault();c(a.target)});e[0].addEventListener("touchstart",function(b){b.preventDefault();b.target.is(a)&&c(b.target)},!1)};(function(){d.positionC=new google.maps.LatLng(a.latitude,
a.longitude);var b={zoom:11,center:d.positionC,scrollwheel:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}};d.mapWS=new google.maps.Map(document.getElementById(c),b);d.infoWindow=new google.maps.InfoWindow({maxWidth:400,disableAutoPan:!1})})()},o=function(a){a=$(a).parent().find(".shopnum").text();window.regionMap.closeMap();MVM.chooseShopById(a)};$("#order1click-container-new").delegate(".bSelect","click",function(){$(this).find(".bSelect__eDropmenu").toggle()});
$("#order1click-container-new").delegate(".bSelect","mouseleave",function(){var a=$(this).find(".bSelect__eDropmenu");a.is(":visible")&&a.hide()});$(".order1click-link-new").bind("click",function(a){a.preventDefault();oneClickIsReady&&("undefined"!==typeof _gaq&&_gaq.push(["_trackEvent","QuickOrder","Open"]),$("#order1click-container-new").lightbox_me({centered:!0,onClose:function(){window.regionMap.closeMap()}}))})}if($("#gMap").length){$("#gMap").bind({create:function(a,b,c,d){var e=$(this),a={zoom:11,
center:new google.maps.LatLng(b.latitude,b.longitude),scrollwheel:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}},f=new google.maps.Map(document.getElementById(e.attr("id")),a),a=new InfoBox({disableAutoPan:!1,maxWidth:0,pixelOffset:new google.maps.Size(-11,-108),zIndex:null,boxStyle:{opacity:0.85,width:"280px"},closeBoxURL:"http://www.google.com/intl/en_us/mapfiles/close.gif",infoBoxClearance:new google.maps.Size(1,1),isHidden:!1,
pane:"floatShadow",enableEventPropagation:!0}),g=function(){var a=c[this.id];e.trigger("showMarkers");e.trigger("infoWindow",[this,a])};e.data("markers",[]);$.each(c,function(a,c){var b=new google.maps.Marker({position:new google.maps.LatLng(c.latitude,c.longitude),map:f,title:c.name,icon:"/images/marker.png",id:c.id});google.maps.event.addListener(b,"click",g);e.data("markers").push(b)});google.maps.event.addListener(f,"bounds_changed",function(){});google.maps.event.addListener(f,"click",function(){});
google.maps.event.addListener(a,"closeclick",function(){e.trigger("showMarkers")});e.data("map",f);e.data("infoWindow",a);e.data("infoWindowTemplate",d)},move:function(){$(this).data("map")},infoWindow:function(a,b,c){var d=$(this),a=d.data("map"),e=d.data("infoWindow"),d=d.data("infoWindowTemplate");b.setMap(null);$.each(d.find("[data-name]"),function(a,b){b.innerHTML=c[$(b).data("name")]});e.setContent(d.prop("innerHTML"));e.open(a,b)},showMarkers:function(){var a=$(this);$.each(a.data("markers"),
function(b,c){null==c.map&&c.setMap(a.data("map"))})}});var j=$("#gMap");j.trigger("create",[$("#map-center").data("content"),$("#map-markers").data("content"),$("#map-info_window-container")]);j.delegate(".shopchoose","click",function(a){p(a.target)});j[0].addEventListener("touchstart",function(a){a.target.className.match("shopchoose")&&p(a.target)},!1);var p=function(a){i($(a).parent().find(".shopnum").text())};$(".bInShopLine__eButton a").bind("click",function(a){a.preventDefault();i($(this).attr("href"))});
$(".bInShop__eCurrent a").click(function(){$.getJSON("/region/init",function(a){if(!a.success)return!1;var a=a.data,b=$("<div>").addClass("graying").css({opacity:"0.5"}),c=$('<div class="bCityPopupWrap">').html('<div class="hideblock bCityPopup"><i title="Закрыть" class="close">Закрыть</i><div class="title">Привет! Из какого вы города?</div></div></div>');c.find(".close").click(function(){$(".graying").remove();$(".bCityPopupWrap").hide()});for(var d=0,e=a.length;d<e;d++)if(!("undefined"===typeof a[d].link||
"undefined"===typeof a[d].name)){var f=$("<div>").append($("<a>").attr("href",a[d].link).text(a[d].name));"undefined"!==typeof a[d].is_active?(f.addClass("bCityPopup__eCurrent"),c.find(".title").after(f)):(f.addClass("bCityPopup__eBlock"),c.find("div:first").append(f))}$("body").append(b).append(c)});return!1})}var k=!1;$(".order1click-link").bind("click",function(a){a.preventDefault();"undefined"!==typeof _gaq&&_gaq.push(["_trackEvent","QuickOrder","Open"]);k?$("#order1click-container").lightbox_me({centered:!0}):
i($(this).attr("href"))});$("#order1click-form").bind("submit",function(a){a.preventDefault();var a=$(this),b=a.find("input:submit");b.attr("disabled",!0);b.val("Оформляю заказ...");b=a.serializeArray();$.ajax({type:"POST",url:a.attr("action"),data:b,success:function(a){a.success?a.data&&($("#order1click-container").find("h2").html(a.data.title),$("#order1click-form").replaceWith(a.data.content),runAnalitics&&runAnalitics()):(a.data&&$("#order1click-form").html(a.data.form),a=$("#order1click-form").find("input:submit"),
a.attr("disabled",!1),a.val("Оформить заказ"),$("#warn").length||(a=$('<span id="warn" style="color:red">').html("Не удалось оформить заказ. Приносим свои извинения! Повторите попытку или обратитесь с заказом в контакт cENTER&nbsp;8&nbsp;(800)&nbsp;700&nbsp;00&nbsp;09"),$(".bFormB2").before(a)))}})})});
