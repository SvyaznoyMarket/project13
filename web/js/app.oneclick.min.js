$(document).ready(function(){function e(){var e=this;e.noDelivery=ko.observable(!1),e.title=s.jstitle,e.price=s.jsprice,e.icon=s.jsbimg,e.shortcut=s.jsshortcut,e.stockq=s.jsstock,e.quantity=ko.observable(1),e.quantityTxt=ko.computed(function(){return e.quantity()+" шт."},this),e.priceTxt=ko.computed(function(){return printPrice(e.price)},this),e.newWarehouse=s.is_quick_only,e.formStatus=ko.observable("typing"),e.formStatusTxt=ko.computed(function(){var r="";switch(e.formStatus()){case"reserve":r="Зарезервировать";break;case"typing":r="Отправить заказ";break;case"process":r="Проверка...";break;case"error":r="Отправить заказ нельзя";break;case"sending":r="Отправка..."}return r},this);var r=docCookies.getItem("scId");e.showMap=ko.observable(!1),e.textfields=[];var a=$("#oneClick").length?$("#oneClick").data("values").recipient_first_name:"",i=$("#oneClick").length?$("#oneClick").data("values").recipient_phonenumbers:"";e.textfields.push(ko.observable({title:"Имя получателя",name:"order[recipient_first_name]",selectorid:"",value:a,valerror:!1,regexp:/^[ёa-zа-я\s]+$/i})),e.textfields.push(ko.observable({title:"Телефон для связи",name:"order[recipient_phonenumbers]",selectorid:"phonemask",value:i,valerror:!1,regexp:/^[()0-9\-\+\s]+$/})),e.textfields.push(ko.observable({title:"номер вашей карты «Связной-Клуб»",name:"order[recipient_scCard]",selectorid:"scCard",value:r,valerror:!1,regexp:/^[()0-9\-\s]+$/})),e.disabledSelectors=ko.observable(!1),e.noQBar=ko.observable(!1),e.stableType=ko.observable(!1),e.chosenDlvr=ko.observable({}),e.chosenDate=ko.observable({}),e.dlvrs=ko.observableArray([]),e.dates=ko.observableArray([]),e.shops=ko.observableArray([]),e.chosenShop=ko.observable({}),e.pickedShop=ko.observable({}),e.dynModel=function(r){var t=e.chosenDlvr().type;t||(t="self"),e.dlvrs.removeAll();for(var a in r)e.dlvrs.push({type:a,name:r[a].name,modeID:r[a].modeId,price:r[a].price}),a==t&&e.chosenDlvr(e.dlvrs()[e.dlvrs().length-1]);if("type"in e.chosenDlvr()||e.chosenDlvr(e.dlvrs()[0]),e.dates(r[e.chosenDlvr().type+""].dates.slice(0)),e.chosenDate(e.dates()[0]),l)e.shops(r.self.shops.slice(0)),e.chosenShop(e.shops()[0]),e.pickedShop(e.shops()[0]);else{var o={address:"",regtime:"",id:1};e.chosenShop(o),e.pickedShop(o)}},e.dynModel(Deliveries),e.total=ko.computed(function(){return printPrice(e.price*e.quantity()+1*e.chosenDlvr().price)},this),e.changeDlvr=function(){var r=e.chosenDlvr().type;for(e.dates.removeAll();e.dates().length;)e.dates.pop();for(var t=0;Deliveries[r].dates.length>t;t++)e.dates().push(Deliveries[r].dates[t]);e.chosenDate(e.dates()[0]),e.showMap()&&e.showMap(!1),window.regionMap===void 0&&$(".bFast__eMapLink").remove()},e.plusItem=function(){if(e.quantity(e.quantity()+1),e.quantity()>e.stockq)return e.noDelivery(!0),!1;var r=1*e.quantity();return setTimeout(function(){e.loadData(r,1)},500),!1},e.minusItem=function(){if(1==e.quantity())return!1;if(e.quantity(e.quantity()-1),e.noDelivery()){if(!(e.quantity()<=e.stockq))return!1;e.noDelivery(!1)}var r=1*e.quantity();return setTimeout(function(){e.loadData(r,-1)},500),!1},e.preparedData=function(r){if("self"===r.type){e.formStatus("reserve");for(var t=0,a=e.dlvrs().length;a>t;t++)if("self"==e.dlvrs()[t].type){e.chosenDlvr(e.dlvrs()[t]);break}e.disabledSelectors(!0),e.noQBar(!0),e.chooseShopById(r.shop.id),"date"in r&&e.chosenDate(r.date),"shop"in r&&e.chooseShopById(r.shop.id)}else if("courier"===r.type){e.formStatus("reserve");for(var t=0,a=e.dlvrs().length;a>t;t++)if("self"!=e.dlvrs()[t].type){e.chosenDlvr(e.dlvrs()[t]);break}e.disabledSelectors(!1),e.stableType(!0),e.noQBar(!0)}},e.loadData=function(r,t){if(console.info("loadData"),!(t>0&&e.quantity()>r||0>t&&r>e.quantity())){var a={product_id:s.jsitemid,product_quantity:r,region_id:1*s.jsregionid};$.post(d,a,function(r){if(e.noDelivery())return!1;if(!r.success)return e.noDelivery(!0),!1;Deliveries=r.data;var t=0;for(var a in Deliveries)t++;if(0===t)return e.noDelivery(!0),!1;if(e.noDelivery(!1),l="self"in Deliveries,e.dynModel(Deliveries),l&&"undefined"==typeof mapCenter&&(mapCenter=calcMCenter(Deliveries.self.shops)),l&&!("regionMap"in window)){var i=function(){window.regionMap.addHandler(".shopchoose",o)};MapInterface.init(mapCenter,"mapPopup",i)}})}},e.pickDate=function(){if(l&&"shopIds"in item&&item.shopIds.length>0){e.shops.removeAll();for(var r in Deliveries.self.shops)-1!==$.inArray(Deliveries.self.shops[r].id,item.shopIds)&&e.shops.push(Deliveries.self.shops[r])}e.showMap()&&e.showMarkers()},e.pickShop=function(){e.chosenShop(item)},e.pickShopOnMap=function(r){for(var t=0,a=e.shops().length;a>t;t++)if(e.shops()[t].id==r)return e.pickedShop(e.shops()[t]),void 0},e.toggleMap=function(){e.showMap()?$("#mapPopup").hide("blind",null,800,function(){e.showMap(!1)}):$("#mapPopup").show("blind",null,1e3,function(){e.showMap(!0),e.showMarkers()})},e.turnOffMap=function(){e.showMap(!1)},e.showMarkers=function(){for(var r={},t=e.shops(),a=0,o=t.length;o>a;a++){var i=1*t[a].id;r[i]={id:t[a].id,name:t[a].address,regtime:t[a].regtime,latitude:t[a].latitude,longitude:t[a].longitude}}window.regionMap.showMarkers(r)},e.chooseShopById=function(r){for(var t=0,a=e.shops().length;a>t;t++)if(e.shops()[t].id==r){e.chosenShop(e.shops()[t]);break}},e.validateField=function(r,a){var o=!1;if("order[recipient_scCard]"==a.currentTarget.name&&""==a.currentTarget.value)return!0;""!=a.currentTarget.value.replace(/\s/g,"")&&r.regexp.test(a.currentTarget.value)||(o=!0,e.formStatus("typing")),"phonemask"===a.currentTarget.getAttribute("id")&&10!==a.currentTarget.value.replace(/[^0-9]/g,"").length&&(o=!0,e.formStatus("typing"));for(var i=0,n=e.textfields.length;n>i;i++)if(e.textfields[i]().name===r.name){var s=e.textfields[i]();s.valerror=o,s.value=a.currentTarget.value,e.textfields[i](s);break}return t(),!0},e.validateForm=function(){return e.noDelivery()?!1:(("typing"===e.formStatus()||"reserve"===e.formStatus())&&(e.formStatus("process"),$("#oneClick input").trigger("change"),"typing"!==e.formStatus()&&e.sendData()),void 0)},e.sendData=function(){e.formStatus("sending"),$(".bFastInner tbody tr:last").empty();var r={"order[product_quantity]":e.quantity(),"order[delivered_at]":e.chosenDate().value,"order[delivery_type_id]":e.chosenDlvr().modeID};"self"==e.chosenDlvr().type&&(r["order[shop_id]"]=e.chosenShop().id);for(var t=0,a=e.textfields.length;a>t;t++)r[e.textfields[t]().name+""]=e.textfields[t]().value;$.ajax({type:"POST",timeout:6e4,url:p,data:r,success:function(r,t){return r.success&&"success"===t?($(".bFast").parent().append(r.data.content),$(".bFast").remove(),$(".p0").removeClass("p0"),"undefined"!=typeof runAnalitics&&runAnalitics(),ANALYTICS.parseAllAnalDivs($(".jsanalytics")),void 0):(e.formStatus("typing"),$(".bFastInner tbody tr:last").append('<td colspan="2" class="red">'+r.message+"</td>"),void 0)},error:function(){e.formStatus("typing")}})}}function r(){var e=this;e.showMap=ko.observable(!1),e.title=s.jstitle,e.price=s.jsprice,e.icon=s.jssimg,e.shortcut=s.jsshortcut,e.region=s.jsregion,e.today=ko.observable(!0),e.todayLabel=ko.observable("Сегодня"),e.tomorrowLabel=ko.observable("Завтра"),e.priceTxt=ko.computed(function(){return printPrice(e.price)},this),e.shops=Deliveries.self.shops.slice(0),e.todayShops=[],e.tomorrowShops=[],e.activeCourier=Deliveries.length>1,parseDateShop=function(r,t){var a=[];e:for(var o=0,i=r.length;i>o;o++)for(var n=0,i=e.shops.length;i>n;n++)if(e.shops[n].id==r[o]){var s={};for(var d in e.shops[n])s[d]=e.shops[n][d];s.lbl=t,a.push(s);continue e}return a};var r=0;e.todayShops=parseDateShop(Deliveries.self.dates[0].shopIds,"td"),e.todayLabel(Deliveries.self.dates[0].name.match(/\d{2}\.\d{2}\.\d{4}/)[0]),Deliveries.self.dates.length>1&&(e.tomorrowShops=parseDateShop(Deliveries.self.dates[1].shopIds,"tmr"),e.tomorrowLabel(Deliveries.self.dates[1].name.match(/\d{2}\.\d{2}\.\d{4}/)[0])),e.pickedShop=ko.observable(e.todayShops[0]),e.selectedS=ko.observable({});var t="ах";1===e.todayShops.length%10&&11!==e.todayShops.length&&(t="е"),e.todayH2='Можно забрать <span class="mLft">'+Deliveries.self.dates[0].name+"</span> в "+e.todayShops.length+" магазин"+t+":",t=1===e.tomorrowShops.length%10&&11!==e.tomorrowShops.length?"е":"ах",e.tomorrowH2=e.todayShops.length>0?"или":"Можно забрать ",Deliveries.self.dates.length>1&&(e.tomorrowH2+=' <span class="mRt">'+Deliveries.self.dates[1].name+"</span> в "+e.tomorrowShops.length+" магазин"+t+":"),e.toggleView=function(r){return e.showMap(r),r&&(e.todayShops.length?e.showMarkers():e.toggleTerm(!1)),!1},e.toggleTerm=function(r){return e.today(r),window.regionMap.hideInfobox(),e.showMarkers(),!1},e.chooseShop=function(r,t){e.selectedS(r),e.today(t)},e.chooseShopById=function(r){for(var t=0,a=e.shops.length;a>t;t++)if(e.shops[t].id==r){e.selectedS(e.shops[t]);break}e.reserveItem()},e.pickShopOnMap=function(r){for(var t=0,a=e.shops.length;a>t;t++)if(e.shops[t].id==r)return e.pickedShop(e.shops[t]),void 0},e.showMarkers=function(){for(var r={},t=e.today()?e.todayShops:e.tomorrowShops,a=0,o=t.length;o>a;a++){var i=t[a].id+"";r[i]={id:t[a].id,name:t[a].address,regtime:t[a].regtime,latitude:t[a].latitude,longitude:t[a].longitude}}window.regionMap.showMarkers(r)},e.reserveItem=function(){var t={type:"self",date:e.today()?Deliveries.self.dates[r]:Deliveries.self.dates[r+1],shop:e.selectedS()};return OC_MVM.preparedData(t),$("#order1click-container-new").lightbox_me({}),!1},e.onlyCourier=function(){var e={type:"courier"};return OC_MVM.preparedData(e),$("#order1click-container-new").lightbox_me({}),!1}}function t(){$("#phonemask").parent().prepend('<span id="phonePH">+7</span>'),$.mask!==void 0&&($("#phonemask").mask("(999) 999-99-99"),$("#phonemask")[0].getAttribute("value")&&$("#phonemask").val($("#phonemask")[0].getAttribute("value")),$.mask.definitions["*"]="[0-9*]",$("#scCard").mask("* ****** ******",{placeholder:"*"}),$("#scCard")[0].getAttribute("value")&&$("#scCard").val($("#scCard")[0].getAttribute("value")),$("#scCard").blur(function(){"* ****** ******"===$(this).val()&&($(this).trigger("unmask").val(""),$(this).focus(function(){$("#scCard").mask("* ****** ******",{placeholder:"*"})}))}))}function a(e){"undefined"!=typeof OC_MVM&&OC_MVM.pickShopOnMap(e.id)}function o(e){var r=$(e).parent().find(".shopnum").text();window.regionMap.closeMap(OC_MVM.turnOffMap),OC_MVM.chooseShopById(r)}function i(e){var r=$(e).parent().find(".shopnum").text();MVM.chooseShopById(r)}function n(e){"undefined"!=typeof MVM&&MVM.pickShopOnMap(e.id)}if($(".order1click-link-new").length){MapInterface.ready("yandex",{yandex:$("#map-info_window-container-ya"),google:$("#map-info_window-container")});var s=$(".order1click-link-new").data("model"),d=$(".order1click-link-new").attr("link-input"),p=$(".order1click-link-new").attr("link-output");Deliveries={self:{modeId:4,name:"Доставка",price:400,dates:[{value:"10-02-2012",name:"10 февраля"},{value:"11-02-2012",name:"11 февраля"}]}};var l=!1;oneClickIsReady=!1;var c={product_id:s.jsitemid,product_quantity:1,region_id:1*s.jsregionid};$.post(d,c,function(r){if(!r.success||0===r.data.length)return OC_MVM=new e,ko.applyBindings(OC_MVM,$("#order1click-container-new")[0]),OC_MVM.noDelivery(!0),$(".order1click-link-new").remove(),!1;if(Deliveries=r.data,l="self"in Deliveries,l&&(mapCenter=calcMCenter(Deliveries.self.shops)),OC_MVM=new e,ko.applyBindings(OC_MVM,$("#order1click-container-new")[0]),l){var i=function(){window.regionMap.addHandler(".shopchoose",o)};try{MapInterface.init(mapCenter,"mapPopup",i,a)}catch(n){$(".bFast__eMapLink").remove()}}oneClickIsReady=!0,t()}),$(".order1click-link-new").bind("click",function(e){return e.preventDefault(),oneClickIsReady?("undefined"!=typeof yaCounter10503055&&yaCounter10503055.reachGoal("orderscomplete"),"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","QuickOrder","Open"]),"ANALYTICS"in window&&ANALYTICS.runMethod("marketgidOrder"),$("#order1click-container-new").lightbox_me({centered:!0,onClose:function(){"regionMap"in window&&window.regionMap.closeMap(OC_MVM.turnOffMap)}}),void 0):!1})}if($("#stockBlock").length){MapInterface.ready("yandex",{yandex:$("#infowindowforstockYa"),google:$("#infowindowforstock")});var s=$("#stockmodel").data("value"),d=$("#stockmodel").attr("link-input"),p=$("#stockmodel").attr("link-output"),l=!1,u=(new Date).toISOString().substr(0,10),c={product_id:s.jsitemid,product_quantity:1,region_id:1*s.jsregionid};$.post(d,c,function(a){if(!a.success)return $(".bOrderPreloader").hide(),$("#noDlvr").show(),!1;Deliveries=a.data;var o=0;for(var s in Deliveries)o++;if(Deliveries.length=o,"currentDate"in a&&""!=a.currentDate&&(u=a.currentDate),$(".bOrderPreloader").hide(),0===o)return $("#noDlvr").show(),!1;if(l="self"in Deliveries,!l)return $("#noDlvr").show(),!1;if(!(Deliveries.self.dates.length>0))return $("#noDlvr").show(),!1;if(l&&(mapCenter=calcMCenter(Deliveries.self.shops)),MVM=new r,ko.applyBindings(MVM,$("#stockCntr")[0]),OC_MVM=new e,ko.applyBindings(OC_MVM,$("#order1click-container-new")[0]),t(),l){var d=function(){window.regionMap.addHandler(".shopchoose",i)};MapInterface.init(mapCenter,"stockmap",d,n)}$("#stockBlock").show()})}});