!function(a){var b=function(){var b,c,d=$("#jsOrder").data("value"),e=d.orders,f=d.isUsedCartRecommendation,g={},h={},i=("https:"===document.location.protocol?"https://":"http://")+"eu-sonar.sociomantic.com/js/2010-07-01/adpan/enter-ru";for(console.info("newOrderAnalytics"),console.log(e),a.sonar_basket={products:[],transaction:e[0].number,amount:0,currency:"RUB"},b=e.length-1;b>=0;b--)for(c=e[b].products.length-1;c>=0;c--)a.sonar_basket.products.push({identifier:e[b].products[c].article+"_"+window.docCookies.getItem("geoshop"),amount:parseInt(e[b].products[c].price,10),currency:"RUB",quantity:e[b].products[c].quantity}),a.sonar_basket.amount+=parseInt(e[b].products[c].price,10);for($LAB.script(i),b=e.length-1;b>=0;b--){for(g={"Checkout Complete Order ID":e[b].number,"Checkout Complete Order ERP ID":e[b].numberErp,"Checkout Complete SKU Quantity":e[b].products.length,"Checkout Complete SKU Total":e[b].sum,"Checkout Complete Delivery Total":e[b].delivery[0].price,"Checkout Complete Order Total":e[b].sum,"Checkout Complete Order Type":"cart order","Checkout Complete Delivery":e[b].delivery[0].typeId,"Checkout Complete Payment":e[b].paymentMethod.id},e[b].coupon_number&&(console.log("Checkout Complete Coupon",e[b].coupon_number),g["Checkout Complete Coupon"]=e[b].coupon_number),c=e[b].products.length-1;c>=0;c--)"undefined"!=typeof _kmq&&"undefined"!=typeof KM&&(h={},h={"Checkout Complete SKU":e[b].products[c].article,"Checkout Complete SKU Quantity":e[b].products[c].quantity,"Checkout Complete SKU Price":parseInt(e[b].products[c].price,10),"Checkout Complete Parent category":e[b].products[c].category[0].name,"Checkout Complete Category name":e[b].products[c].category[e[b].products[c].category.length-1].name,_t:KM.ts()+c+b,_d:1},console.log(h),_kmq.push(["set",h]));console.log(g),"undefined"!=typeof _kmq&&"undefined"!==KM&&(_kmq.push(["alias",e[0].phonenumber,KM.i()]),_kmq.push(["identify",e[0].phonenumber]),_kmq.push(["record","Checkout Complete",g]))}"undefined"!=typeof gaq&&(console.info("Отслеживание рекомендаций"),_gaq.push(["_setCustomVar",5,"Used_cart_rec",f?"YES":"NO",2]),e[0].coupon_number&&(console.info("Отслеживание кода купона: "+e[0].coupon_number),_gaq.push(["_trackEvent","coupon",e[0].coupon_number])))};$(document).ready(function(){if($(".socnet-ico-list-link").length&&$(".socnet-ico-list-link").bind("click",function(){var a=$(this).data("type");"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","SMM","Complete order",a])}),$(".orderFinal__certificate").length){var a=$(".cardNumber"),c=$(".cardPin"),d=$(".orderFinal__certificate form"),e=$("#sendCard"),f="/certificate-check",g="/certificate-activate",h=function(){function b(a){a>o?o=0:o-=a,$("#paymentWithCard").text(o)}function g(){a.val(""),c.val(""),e.addClass("mDisabled"),p=!1}function h(){return a.val().replace(/[^0-9]/g,"")}function i(){return c.val().replace(/[^0-9]/g,"")}function j(){return{code:h(),pin:i()}}function k(){p&&""!==h()&&14===h().length&&""!==i()&&4===i().length&&e.removeClass("mDisabled")}function l(a){a.match(/\*/)&&e.addClass("mDisabled")}function m(){n("orange","Проверка по номеру карты"),$.post(f,{code:"23846829634"},function(a){if(!1 in a)return!1;if(!a.success){var b="undefined"!=typeof a.error?a.error:"ERROR";return n("red",b),!1}n("green",a.data)}),k(),c.focus()}function n(a,b){var c=$(".process").first();c.hasClass("picked")||c.remove();var e={typeNum:a};switch(a){case"orange":e.text=b,p=!1;break;case"red":e.text="Произошла ошибка: "+b,p=!1;break;case"green":e.text="activated"in b?"Карта "+b.code+" на сумму "+b.sum+" активирована!":"Карта "+b.code+" имеет номинал "+b.sum,p=!0}d.after(tmpl(q,e)),"undefined"!=typeof b.activated&&$(".process").first().addClass("picked"),k()}var o=1*$("#paymentWithCard").text(),p=!1,q="processBlock";return{activateButton:k,checkCard:m,setProcessingStatus:n,setPaymentSum:b,prepareNewCard:g,getParams:j,checkForStars:l}}();$.mask.definitions.n="[0-9]",a.mask("nnn nnn nnn nnnn n",{completed:h.checkCard,placeholder:"*"}),c.mask("nnnn",{completed:h.activateButton,placeholder:"*"}),a.bind("keyup",function(){h.checkForStars($(this).val())}),c.bind("keyup",function(){h.checkForStars($(this).val())}),e.bind("click",function(a){return a.preventDefault(),$(this).hasClass("mDisabled")?!1:(h.setProcessingStatus("orange","Минутку, активация карты..."),$.get(g,h.getParams(),function(a){return!1 in a?!1:a.success?(a.data.activated=!0,h.setProcessingStatus("green",a.data),h.setPaymentSum(1*a.data.sum),void h.prepareNewCard()):(h.setProcessingStatus("red",a.error),!1)}),!1)})}$(".auth-link").bind("click",function(a){a.preventDefault();var b=$(this);$("#login-form, #register-form").data("redirect",!1),$("#auth-block").lightbox_me({centered:!0,onLoad:function(){$("#auth-block").find("input:first").focus()},onClose:function(){$.get(b.data("updateUrl"),function(a){if(!0===a.success){var b=$(".order-form");$("#user-block").replaceWith(a.data.content),$.each(a.data.fields,function(a,c){var d=b.find('[name="'+a+'"]');d.val().length<2&&d.val(c)})}})}})}),function(){if($("#product_errors").length){var a=function(a,b,c){var d="tmpErrPopup"+Math.floor(22*Math.random()),e='<div id="'+d+'" class="popup"><div class="popupbox width290"><div class="font18 pb18"> Непредвиденная ошибка</div></div><p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p></div> ';$("body").append($(e)),$.each(a,function(a,b){$("#"+d).find(".popupbox").append('<div class="font18 pb18"> '+b+"</div>")}),$("#"+d).lightbox_me({centered:!0,closeSelector:".closePopup",onClose:function(){var a=function(b,c){if(b[c]){var d=b[c]+"";$.ajax({url:d}).then(function(){c++,a(b,c)})}else window.location.reload()};$.merge(b,c),a(b,0)}})},b=[],c=[],d=[],e=$("#product_errors").data("value").length;if(e){var f=function(){$.each($("#product_errors").data("value"),function(a,e){e.product.deleteUrl&&c.push(e.product.deleteUrl),e.product.addUrl&&d.push(e.product.addUrl),708==e.code?e.quantity_available>0?("undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Errors","User error","Нет нужного количества товаров"]),b.push("Вы заказали товар "+e.product.name+" в количестве "+e.product.quantity+" шт. <br/ >Доступно только "+e.quantity_available+" шт.<br/ >Будет заказано "+e.quantity_available+"шт"),d.push(e.product.addUrl)):("undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Errors","User error","Нет товара для выбранного способа доставки"]),b.push("Товара "+e.product.name+" нет в наличии для выбранного способа доставки.<br/>Товар будет удален из корзины.")):("undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Errors","User error","Товар недоступен для продажи"]),b.push("Товар "+e.product.name+" недоступен для продажи.<br/>Товар будет удален из корзины."))}),a(b,c,d)};f()}}}(),function(){var a=$(".timer");if(!a.length)return!1;var b=function(a){$.ajax({type:"POST",url:a.data("clear-payment-url"),async:!1,data:{},success:function(){}})},c=function(){1===e&&(clearInterval(d),$("form.paymentUrl").length?(b($("form.paymentUrl")),window.location=$("form.paymentUrl").attr("action")):$(".form").submit()),e-=1,a.html(e)},d=window.setInterval(c,1e3),e=1*a.html().replace(/\D/g,"")}(),function(){if(!$("#credit-widget").length)return void console.warn("кредитный виджет не найден");var a=$("#credit-widget").data("value");if(!1 in a)return console.warn("тип виджета не найден в данных"),void console.log(a);console.info("обрабатываем как "+a.widget),"direct-credit"===a.widget&&$LAB.script("JsHttpRequest.min.js").script("http://direct-credit.ru/widget/script_utf.js").wait(function(){function b(){dc_getCreditForTheProduct("4427",a.vars.number,"orderProductToBuyOnCredit",{order_id:a.vars.number,region:a.vars.region})}console.info("скрипты загружены для кредитного виджета. начинаем обработку");for(var c=a.vars.items.length-1;c>=0;c--){var d=a.vars.items[c];dc_getCreditForTheProduct("4427",a.vars.number,"addProductToBuyOnCredit",{name:d.name,count:d.quantity,articul:d.articul,price:d.price,type:d.type},function(){console.log("обработка завершена. открываем виджет"),b()})}});var b="http://"+window.location.hostname;if("kupivkredit"===a.widget){var c=function(){setTimeout(function(){document.location=b},3e3)},d=function(){};$LAB.script("https://www.kupivkredit.ru/widget/vkredit.js").wait(function(){var b=new VkreditWidget(1,a.vars.sum,{order:a.vars.order,sig:a.vars.sig,callbackUrl:window.location.href,onClose:c,onDecision:d});b.openWidget()})}}(),b(),"order_complete"===$("body").attr("data-template")&&"undefined"!=typeof orderAnalyticsRun&&(console.info("запуск старой аналитики зашитой в шаблоне php"),orderAnalyticsRun()),console.log("аналитика завершена")})}(this);