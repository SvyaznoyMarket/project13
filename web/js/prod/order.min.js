(function(e){var t=function t(){var t,r,n=$("#jsOrder").data("value"),o={},a={},c=("https:"===document.location.protocol?"https://":"http://")+"eu-sonar.sociomantic.com/js/2010-07-01/adpan/enter-ru";for(console.info("newOrderAnalytics"),console.log(n),e.sonar_basket={products:[],transaction:n[0].number,amount:0,currency:"RUB"},t=n.length-1;t>=0;t--)for(r=n[t].products.length-1;r>=0;r--)e.sonar_basket.products.push({identifier:n[t].products[r].article+"_"+window.docCookies.getItem("geoshop"),amount:parseInt(n[t].products[r].price,10),currency:"RUB",quantity:n[t].products[r].quantity}),e.sonar_basket.amount+=parseInt(n[t].products[r].price,10);for($LAB.script(c),t=n.length-1;t>=0;t--){for(o={},o={"Checkout Complete Order ID":n[t].number,"Checkout Complete SKU Quantity":n[t].products.length,"Checkout Complete SKU Total":n[t].sum,"Checkout Complete Delivery Total":n[t].delivery[0].price,"Checkout Complete Order Total":n[t].sum,"Checkout Complete Order Type":"cart order","Checkout Complete Delivery":n[t].delivery[0].typeId,"Checkout Complete Payment":n[t].paymentMethod.id},r=n[t].products.length-1;r>=0;r--)"undefined"!=typeof _kmq&&"undefined"!=typeof KM&&(a={},a={"Checkout Complete SKU":n[t].products[r].article,"Checkout Complete SKU Quantity":n[t].products[r].quantity,"Checkout Complete SKU Price":parseInt(n[t].products[r].price,10),"Checkout Complete Parent category":n[t].products[r].category[n[t].products[r].category.length-1].id,"Checkout Complete Category name":n[t].products[r].category[0].id,_t:KM.ts()+r+t,_d:1},console.log(a),_kmq.push(["set",a]));console.log(o),"undefined"!=typeof _kmq&&"undefined"!==KM&&(_kmq.push(["alias",n[0].phonenumber,KM.i()]),_kmq.push(["identify",n[0].phonenumber]),_kmq.push(["record","Checkout Complete",o]))}};$(document).ready(function(){if($(".socnet-ico-list-link").length&&$(".socnet-ico-list-link").bind("click",function(){var e=$(this).data("type");"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","SMM","Complete order",e])}),$(".orderFinal__certificate").length){var e=$(".cardNumber"),r=$(".cardPin"),n=$(".orderFinal__certificate form"),o=$("#sendCard"),a="/certificate-check",c="/certificate-activate",i=function(){function t(e){e>m?m=0:m-=e,$("#paymentWithCard").text(m)}function c(){e.val(""),r.val(""),o.addClass("mDisabled"),h=!1}function i(){return e.val().replace(/[^0-9]/g,"")}function s(){return r.val().replace(/[^0-9]/g,"")}function d(){return{code:i(),pin:s()}}function u(){h&&""!==i()&&14===i().length&&""!==s()&&4===s().length&&o.removeClass("mDisabled")}function l(e){e.match(/\*/)&&o.addClass("mDisabled")}function p(){f("orange","Проверка по номеру карты"),$.post(a,{code:"23846829634"},function(e){if(false in e)return!1;if(!e.success){var t=e.error!==void 0?e.error:"ERROR";return f("red",t),!1}f("green",e.data)}),u(),r.focus()}function f(e,t){var r=$(".process").first();r.hasClass("picked")||r.remove();var o={typeNum:e};switch(e){case"orange":o.text=t,h=!1;break;case"red":o.text="Произошла ошибка: "+t,h=!1;break;case"green":o.text="activated"in t?"Карта "+t.code+" на сумму "+t.sum+" активирована!":"Карта "+t.code+" имеет номинал "+t.sum,h=!0}n.after(tmpl(v,o)),t.activated!==void 0&&$(".process").first().addClass("picked"),u()}var m=1*$("#paymentWithCard").text(),h=!1,v="processBlock";return{activateButton:u,checkCard:p,setProcessingStatus:f,setPaymentSum:t,prepareNewCard:c,getParams:d,checkForStars:l}}();$.mask.definitions.n="[0-9]",e.mask("nnn nnn nnn nnnn n",{completed:i.checkCard,placeholder:"*"}),r.mask("nnnn",{completed:i.activateButton,placeholder:"*"}),e.bind("keyup",function(){i.checkForStars($(this).val())}),r.bind("keyup",function(){i.checkForStars($(this).val())}),o.bind("click",function(e){return e.preventDefault(),$(this).hasClass("mDisabled")?!1:(i.setProcessingStatus("orange","Минутку, активация карты..."),$.get(c,i.getParams(),function(e){return false in e?!1:e.success?(e.data.activated=!0,i.setProcessingStatus("green",e.data),i.setPaymentSum(1*e.data.sum),i.prepareNewCard(),void 0):(i.setProcessingStatus("red",e.error),!1)}),!1)})}$(".auth-link").bind("click",function(e){e.preventDefault();var t=$(this);$("#login-form, #register-form").data("redirect",!1),$("#auth-block").lightbox_me({centered:!0,onLoad:function(){$("#auth-block").find("input:first").focus()},onClose:function(){$.get(t.data("updateUrl"),function(e){if(!0===e.success){var t=$(".order-form");$("#user-block").replaceWith(e.data.content),$.each(e.data.fields,function(e,r){var n=t.find('[name="'+e+'"]');2>n.val().length&&n.val(r)})}})}})}),function(){if($("#product_errors").length){var e=function(e,t,r){var n="tmpErrPopup"+Math.floor(22*Math.random()),o='<div id="'+n+'" class="popup">'+'<div class="popupbox width290">'+'<div class="font18 pb18"> Непредвиденная ошибка</div>'+"</div>"+'<p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>'+"</div> ";$("body").append($(o)),$.each(e,function(e,t){$("#"+n).find(".popupbox").append('<div class="font18 pb18"> '+t+"</div>")}),$("#"+n).lightbox_me({centered:!0,closeSelector:".closePopup",onClose:function(){var e=function(t,r){if(t[r]){var n=t[r]+"";$.ajax({url:n}).then(function(){r++,e(t,r)})}else window.location.reload()};$.merge(t,r),e(t,0)}})},t=[],r=[],n=[],o=$("#product_errors").data("value").length;if(o){var a=function(){$.each($("#product_errors").data("value"),function(e,o){o.product.deleteUrl&&r.push(o.product.deleteUrl),o.product.addUrl&&n.push(o.product.addUrl),708==o.code?o.quantity_available>0?("undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Errors","User error","Нет нужного количества товаров"]),t.push("Вы заказали товар "+o.product.name+" в количестве "+o.product.quantity+" шт. <br/ >Доступно только "+o.quantity_available+" шт.<br/ >Будет заказано "+o.quantity_available+"шт"),n.push(o.product.addUrl)):("undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Errors","User error","Нет товара для выбранного способа доставки"]),t.push("Товара "+o.product.name+" нет в наличии для выбранного способа доставки.<br/>Товар будет удален из корзины.")):("undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Errors","User error","Товар недоступен для продажи"]),t.push("Товар "+o.product.name+" недоступен для продажи.<br/>Товар будет удален из корзины."))}),e(t,r,n)};a()}}}(),function(){var e=$(".timer");if(!e.length)return!1;var t=function(e){$.ajax({type:"POST",url:e.data("clear-payment-url"),async:!1,data:{},success:function(){}})},r=function(){1===o&&(clearInterval(n),$("form.paymentUrl").length?(t($("form.paymentUrl")),window.location=$("form.paymentUrl").attr("action")):$(".form").submit()),o-=1,e.html(o)},n=window.setInterval(r,1e3),o=1*e.html().replace(/\D/g,"")}(),function(){if(!$("#credit-widget").length)return console.warn("кредитный виджет не найден"),void 0;var e=$("#credit-widget").data("value");if(false in e)return console.warn("тип виджета не найден в данных"),console.log(e),void 0;console.info("обрабатываем как "+e.widget),"direct-credit"===e.widget&&$LAB.script("JsHttpRequest.min.js").script("http://direct-credit.ru/widget/script_utf.js").wait(function(){function t(){dc_getCreditForTheProduct("4427",e.vars.number,"orderProductToBuyOnCredit",{order_id:e.vars.number,region:e.vars.region})}console.info("скрипты загружены для кредитного виджета. начинаем обработку");for(var r=e.vars.items.length-1;r>=0;r--){var n=e.vars.items[r];dc_getCreditForTheProduct("4427",e.vars.number,"addProductToBuyOnCredit",{name:n.name,count:n.quantity,price:n.price,type:n.type},function(){console.log("обработка завершена. открываем виджет"),t()})}});var t="http://"+window.location.hostname;if("kupivkredit"===e.widget){var r=function(){setTimeout(function(){document.location=t},3e3)},n=function(){};$LAB.script("https://www.kupivkredit.ru/widget/vkredit.js").wait(function(){var t=new VkreditWidget(1,e.vars.sum,{order:e.vars.order,sig:e.vars.sig,callbackUrl:window.location.href,onClose:r,onDecision:n});t.openWidget()})}}(),t(),"order_complete"===$("body").attr("data-template")&&"undefined"!=typeof orderAnalyticsRun&&(console.info("запуск старой аналитики зашитой в шаблоне php"),orderAnalyticsRun()),console.log("аналитика завершена")})})(this);