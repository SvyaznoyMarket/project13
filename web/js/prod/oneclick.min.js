$(document).ready(function(){function a(){var a=this;a.noDelivery=ko.observable(!1),a.title=e.jstitle,a.price=e.jsprice,a.icon=e.jsbimg,a.shortcut=e.jsshortcut,a.stockq=e.jsstock,a.quantity=ko.observable(1),a.quantityTxt=ko.computed(function(){return a.quantity()+" шт."},this),a.priceTxt=ko.computed(function(){return printPrice(a.price)},this),a.newWarehouse=e.is_quick_only,a.formStatus=ko.observable("typing"),a.formStatusTxt=ko.computed(function(){var b="";switch(a.formStatus()){case"reserve":b="Зарезервировать";break;case"typing":b="Отправить заказ";break;case"process":b="Проверка...";break;case"error":b="Отправить заказ нельзя";break;case"sending":b="Отправка..."}return b},this);var b=window.docCookies.getItem("scId");a.showMap=ko.observable(!1),a.textfields=[];var d=$("#oneClick").length?$("#oneClick").data("values").recipient_first_name:"",h=$("#oneClick").length?$("#oneClick").data("values").recipient_phonenumbers:"",j=$("#oneClick").length?$("#oneClick").data("values").recipient_email:"";a.textfields.push(ko.observable({title:"Имя получателя",name:"order[recipient_first_name]",selectorid:"",value:d,valerror:!1,showsubscribe:!1,regexp:/^[ёa-zа-я\s]+$/i})),a.textfields.push(ko.observable({title:"Телефон для связи",name:"order[recipient_phonenumbers]",selectorid:"phonemask",value:h,valerror:!1,showsubscribe:!1,regexp:/^[()0-9\-\+\s]+$/})),a.textfields.push(ko.observable({title:"E-mail (если есть)",name:"order[recipient_email]",selectorid:"recipientEmail",value:j,valerror:!1,showsubscribe:!0,active:!0,regexp:/./})),a.textfields.push(ko.observable({title:"Номер вашей карты «Связной-Клуб»",name:"order[recipient_scCard]",selectorid:"scCard",value:b,valerror:!1,showsubscribe:!1,regexp:/^[()0-9\-\s]+$/})),a.disabledSelectors=ko.observable(!1),a.noQBar=ko.observable(!1),a.stableType=ko.observable(!1),a.chosenDlvr=ko.observable({}),a.chosenDate=ko.observable({}),a.dlvrs=ko.observableArray([]),a.dates=ko.observableArray([]),a.shops=ko.observableArray([]),a.chosenShop=ko.observable({}),a.pickedShop=ko.observable({}),a.dynModel=function(b){var c=a.chosenDlvr().type;c||(c="self"),a.dlvrs.removeAll();for(var d in b)a.dlvrs.push({type:d,name:b[d].name,modeID:b[d].modeId,price:b[d].price}),d==c&&a.chosenDlvr(a.dlvrs()[a.dlvrs().length-1]);if("type"in a.chosenDlvr()||a.chosenDlvr(a.dlvrs()[0]),a.dates(b[a.chosenDlvr().type+""].dates.slice(0)),a.chosenDate(a.dates()[0]),i)a.shops(b.hasOwnProperty("self")?b.self.shops.slice(0):b.now.shops.slice(0)),a.chosenShop(a.shops()[0]),a.pickedShop(a.shops()[0]);else{var e={address:"",regtime:"",id:1};a.chosenShop(e),a.pickedShop(e)}},a.dynModel(Deliveries),a.total=ko.computed(function(){return printPrice(a.price*a.quantity()+1*a.chosenDlvr().price)},this),a.changeDlvr=function(){var b=a.chosenDlvr().type;for(a.dates.removeAll();a.dates().length;)a.dates.pop();for(var c=0;c<Deliveries[b].dates.length;c++)a.dates().push(Deliveries[b].dates[c]);a.chosenDate(a.dates()[0]),a.showMap()&&a.showMap(!1),"undefined"==typeof window.regionMap&&$(".bFast__eMapLink").remove()},a.plusItem=function(){if(a.quantity(a.quantity()+1),a.quantity()>a.stockq)return a.noDelivery(!0),!1;var b=1*a.quantity();return setTimeout(function(){a.loadData(b,1)},500),k(),!1},a.minusItem=function(){if(1==a.quantity())return!1;if(a.quantity(a.quantity()-1),a.noDelivery()){if(!(a.quantity()<=a.stockq))return!1;a.noDelivery(!1)}var b=1*a.quantity();return setTimeout(function(){a.loadData(b,-1)},500),k(),!1};var k=function(){var b={"Checkout Step 1 SKU Quantity":1*a.quantity(),"Checkout Step 1 SKU Total":a.price*a.quantity()*1,"Checkout Step 1 Order Total":a.price*a.quantity()*1+1*a.chosenDlvr().price};"undefined"!=typeof _kmq&&_kmq.push(["set",b])};a.preparedData=function(b){if("self"===b.type||"now"===b.type){a.formStatus("reserve");for(var c=0,d=a.dlvrs().length;d>c;c++)if("self"===a.dlvrs()[c].type||"now"===a.dlvrs()[c].type){a.chosenDlvr(a.dlvrs()[c]);break}a.disabledSelectors(!0),a.noQBar(!0),a.chooseShopById(b.shop.id),"date"in b&&a.chosenDate(b.date),"shop"in b&&a.chooseShopById(b.shop.id)}else if("courier"===b.type){a.formStatus("reserve");for(var e=0,f=a.dlvrs().length;f>e;e++)if("self"!==a.dlvrs()[e].type&&"now"!==a.dlvrs()[e].type){a.chosenDlvr(a.dlvrs()[e]);break}a.disabledSelectors(!1),a.stableType(!0),a.noQBar(!0)}},a.loadData=function(b,c){if(!(c>0&&a.quantity()>b||0>c&&a.quantity()<b)){var d={product_id:e.jsitemid,product_quantity:b,region_id:1*e.jsregionid};$.post(f,d,function(b){if(a.noDelivery())return!1;if(!b.success)return a.noDelivery(!0),!1;Deliveries=b.data;var c=0;for(var d in Deliveries)c++;if(0===c)return a.noDelivery(!0),!1;if(a.noDelivery(!1),i="self"in Deliveries||"now"in Deliveries,a.dynModel(Deliveries),i&&"undefined"==typeof mapCenter&&(mapCenter=calcMCenter(Deliveries.self.shops)),i&&!("regionMap"in window)){var e=function(){window.regionMap.addHandler(".shopchoose",n)};MapInterface.init(mapCenter,"mapPopup",e)}})}},a.pickDate=function(){if(i&&"shopIds"in item&&item.shopIds.length>0){a.shops.removeAll();for(var b in Deliveries.self.shops)-1!==$.inArray(Deliveries.self.shops[b].id,item.shopIds)&&a.shops.push(Deliveries.self.shops[b])}a.showMap()&&a.showMarkers()},a.pickShop=function(b){for(var c=0,d=a.shops.length;d>c;c++)if(a.shops[c].id==b)return void a.chosenShop(a.shops[c])},a.pickShopOnMap=function(b){for(var c=0,d=a.shops().length;d>c;c++)if(a.shops()[c].id==b)return void a.pickedShop(a.shops()[c])},a.toggleMap=function(){a.showMap()?$("#mapPopup").slideUp(500,function(){a.showMap(!1)}):$("#mapPopup").slideDown(500,function(){a.showMap(!0),a.showMarkers()})},a.turnOffMap=function(){a.showMap(!1)},a.showMarkers=function(){for(var b={},c=a.shops(),d=0,e=c.length;e>d;d++){var f=1*c[d].id;b[f]={id:c[d].id,name:c[d].address,regtime:c[d].regtime,latitude:c[d].latitude,longitude:c[d].longitude}}window.regionMap.showMarkers(b)},a.chooseShopById=function(b){for(var c=0,d=a.shops().length;d>c;c++)if(a.shops()[c].id==b){a.chosenShop(a.shops()[c]);break}},a.validateField=function(b,d){var e=!1;if(("order[recipient_scCard]"==d.currentTarget.name||"order[recipient_email]"===d.currentTarget.name)&&""==d.currentTarget.value)return!0;"order[recipient_email]"!==d.currentTarget.name||d.currentTarget.value.isEmail()||(e=!0,a.formStatus("typing")),"order[recipient_email]"===d.currentTarget.name||""!=d.currentTarget.value.replace(/\s/g,"")&&b.regexp.test(d.currentTarget.value)||(e=!0,a.formStatus("typing")),"phonemask"===d.currentTarget.getAttribute("id")&&10!==d.currentTarget.value.replace(/[^0-9]/g,"").length&&(e=!0,a.formStatus("typing"));for(var f=0,g=a.textfields.length;g>f;f++)if(a.textfields[f]().name===b.name){var h=a.textfields[f]();h.valerror=e,h.value=d.currentTarget.value,"order[recipient_email]"===d.currentTarget.name&&(h.active=!!parseInt($('#order1click-container-new .bSubscibe input[name="subscribe"]').val())),a.textfields[f](h);break}return c(),!0},a.validateForm=function(){return a.noDelivery()?!1:void(("typing"===a.formStatus()||"reserve"===a.formStatus())&&(a.formStatus("process"),$("#oneClick input").trigger("change"),"typing"!==a.formStatus()&&a.sendData()))},a.sendData=function(){a.formStatus("sending"),$(".bFastInner tbody tr:last").empty();var b={"order[product_quantity]":a.quantity(),"order[delivered_at]":a.chosenDate().value,"order[delivery_type_id]":a.chosenDate().isNow?4:a.chosenDlvr().modeID};("self"==a.chosenDlvr().type||"now"==a.chosenDlvr().type)&&(b["order[shop_id]"]=a.chosenShop().id);for(var c=0,d=a.textfields.length;d>c;c++)b[a.textfields[c]().name+""]=a.textfields[c]().value;b.subscribe=$('#order1click-container-new .bSubscibe input[name="subscribe"]').val(),"undefined"!=typeof window.KM&&(b.kiss_session=window.KM.i),$.ajax({type:"POST",timeout:6e4,url:g,data:b,success:function(b,c){var d=$(".bFast");if(!b.success||"success"!==c)return a.formStatus("typing"),void $(".bFastInner tbody tr:last").append('<td colspan="2" class="red">'+b.message+"</td>");OC_MVM.AnalyticsComplete(b.data);try{d.parent().append(b.data.content)}catch(e){}d.remove(),$(".p0").removeClass("p0"),OC_MVM.AnaliticsCompleteExtra()},error:function(){a.formStatus("typing")}})},a.AnalyticsFormOpen=function(){var b={"Checkout Step 1 SKU Quantity":a.quantity(),"Checkout Step 1 SKU Total":a.price*a.quantity(),"Checkout Step 1 Order Total":a.price*a.quantity()+1*a.chosenDlvr().price,"Checkout Step 1 Order Type":"one click order"};"undefined"!=typeof yandexCounter&&yandexCounter.reachGoal("orderscomplete"),"undefined"!=typeof _gaq&&(_gaq.push(["_trackEvent","QuickOrder","Open"]),_gaq.push(["_trackPageview","/order_form"])),"undefined"!=typeof _kmq&&_kmq.push(["record","Checkout Step 1",b])},a.AnalyticsComplete=function(b){var c,d,e=$("#phonemask"),f=e&&e.val()?"8"+e.val().replace(/\D/g,""):null;"undefined"!=typeof Flocktory&&(d={order_id:b.orderNumber,price:a.price*a.quantity()*1+1*a.chosenDlvr().price,items:[{id:a.shortcut,title:a.title,price:a.price,image:a.icon,count:a.quantity()}]},Flocktory.popup_opder(d)),"undefined"!=typeof _kmq&&"undefined"!==KM&&(_kmq.push(["alias",f,KM.i()]),_kmq.push(["identify",f]),c={"Checkout Complete Order ID":b.orderNumber,"Checkout Complete SKU Quantity":a.quantity(),"Checkout Complete SKU Total":a.price*a.quantity()*1,"Checkout Complete Delivery Total":1*a.chosenDlvr().price,"Checkout Complete Order Total":a.price*a.quantity()*1+1*a.chosenDlvr().price,"Checkout Complete Order Type":"one click order","Checkout Complete Delivery":a.chosenDlvr().type},_kmq.push(["record","Checkout Complete",c]),c={"Checkout Complete SKU":b.productArticle,"Checkout Complete SKU Quantity":1*a.quantity(),"Checkout Complete SKU Price":1*a.price,"Checkout Complete Parent category":b.productCategory[0].name,"Checkout Complete Category name":b.productCategory[b.productCategory.length-1].name,_t:KM.ts()+1,_d:1},_kmq.push(["set",c])),"undefined"!=typeof _gaq&&(_gaq.push(["_trackEvent","QuickOrder","Success"]),_gaq.push(["_trackPageview","/thanks_form"]),_gaq.push(["_trackTrans"])),ANALYTICS.parseAllAnalDivs($(".jsanalytics")),ANALYTICS.adriverOrder({order_id:b.orderNumber})},a.AnaliticsCompleteExtra=function(){var a;"undefined"!=typeof _gaq&&(a=$("#GA_addTransJS").data("vars"),a&&_gaq.push(a),a=$("#GA_addItemJS").data("vars"),a&&_gaq.push(a)),a=$("#YA_paramsJS").data("vars"),a&&"undefined"!=typeof yandexCounter&&yandexCounter.reachGoal("QORDER",a),a=$("#adBelnderJS").data("vars"),a&&"undefined"!=typeof window.adBelnder&&window.adBelnder.addOrder(a)}}function b(){var a=this;a.showMap=ko.observable(!1),a.title=e.jstitle,a.price=e.jsprice,a.icon=e.jssimg,a.shortcut=e.jsshortcut,a.region=e.jsregion,a.today=ko.observable(!0),a.todayLabel=ko.observable("Сегодня"),a.tomorrowLabel=ko.observable("Завтра"),a.priceTxt=ko.computed(function(){return printPrice(a.price)},this),a.shops=Deliveries.self.shops.slice(0),a.todayShops=[],a.tomorrowShops=[],a.activeCourier=Deliveries.length>1,parseDateShop=function(b,c){var d=[];a:for(var e=0,f=b.length;f>e;e++)for(var g=0,h=a.shops.length;h>g;g++)if(a.shops[g].id==b[e]){var i={};for(var j in a.shops[g])i[j]=a.shops[g][j];i.lbl=c,d.push(i);continue a}return d};var b=0;a.todayShops=parseDateShop(Deliveries.self.dates[0].shopIds,"td"),a.todayLabel(Deliveries.self.dates[0].name.match(/\d{2}\.\d{2}\.\d{4}/)[0]),Deliveries.self.dates.length>1&&(a.tomorrowShops=parseDateShop(Deliveries.self.dates[1].shopIds,"tmr"),a.tomorrowLabel(Deliveries.self.dates[1].name.match(/\d{2}\.\d{2}\.\d{4}/)[0])),a.pickedShop=ko.observable(a.todayShops[0]),a.selectedS=ko.observable({});var c="ах";a.todayShops.length%10===1&&11!==a.todayShops.length&&(c="е"),a.todayH2='Можно забрать <span class="mLft">'+Deliveries.self.dates[0].name+"</span> в "+a.todayShops.length+" магазин"+c+":",c=a.tomorrowShops.length%10===1&&11!==a.tomorrowShops.length?"е":"ах",a.tomorrowH2=a.todayShops.length>0?"или":"Можно забрать ",Deliveries.self.dates.length>1&&(a.tomorrowH2+=' <span class="mRt">'+Deliveries.self.dates[1].name+"</span> в "+a.tomorrowShops.length+" магазин"+c+":"),a.toggleView=function(b){return a.showMap(b),b&&(a.todayShops.length?a.showMarkers():a.toggleTerm(!1)),!1},a.toggleTerm=function(b){return a.today(b),window.regionMap.hideInfobox(),a.showMarkers(),!1},a.chooseShop=function(b,c){a.selectedS(b),a.today(c)},a.chooseShopById=function(b){for(var c=0,d=a.shops.length;d>c;c++)if(a.shops[c].id==b){a.selectedS(a.shops[c]);break}a.reserveItem()},a.pickShopOnMap=function(b){for(var c=0,d=a.shops.length;d>c;c++)if(a.shops[c].id==b)return void a.pickedShop(a.shops[c])},a.showMarkers=function(){for(var b={},c=a.today()?a.todayShops:a.tomorrowShops,d=0,e=c.length;e>d;d++){var f=c[d].id+"";b[f]={id:c[d].id,name:c[d].address,regtime:c[d].regtime,latitude:c[d].latitude,longitude:c[d].longitude}}window.regionMap.showMarkers(b)},a.reserveItem=function(){var c={type:"self",date:a.today()?Deliveries.self.dates[b]:Deliveries.self.dates[b+1],shop:a.selectedS()};return OC_MVM.preparedData(c),$("#order1click-container-new").lightbox_me({}),!1},a.onlyCourier=function(){var a={type:"courier"};return OC_MVM.preparedData(a),$("#order1click-container-new").lightbox_me({}),!1}}function c(){$("#phonemask").parent().prepend('<span id="phonePH">+7</span>'),"undefined"!=typeof $.mask&&($.mask.definitions.n="[0-9]",$("#phonemask").mask("(nnn) nnn-nn-nn"),$("#phonemask")[0].getAttribute("value")&&$("#phonemask").val($("#phonemask")[0].getAttribute("value")),$.mask.definitions["*"]="[0-9*]",$("#scCard").mask("* ****** ******",{placeholder:"*"}),$("#scCard")[0].getAttribute("value")&&$("#scCard").val($("#scCard")[0].getAttribute("value")),$("#scCard").blur(function(){"* ****** ******"===$(this).val()&&($(this).trigger("unmask").val(""),$(this).focus(function(){$("#scCard").mask("2 98nnnn nnnnn",{placeholder:"*"})}))}))}if($(".jsOrder1click").length){MapInterface.ready("yandex",{yandex:$("#map-info_window-container-ya"),google:$("#map-info_window-container")});var d,e=$(".jsOrder1click").data("model"),f=$(".jsOrder1click").attr("link-input"),g=$(".jsOrder1click").attr("link-output"),h=$(".bSubscibeWrapper");$("body").on("userLogged",function(a,b){b&&!1===b.isSubscribed?(h.show(),d=!0):(h.hide(),d=!1)}),Deliveries={self:{modeId:4,name:"Доставка",price:400,dates:[{value:"10-02-2012",name:"10 февраля"},{value:"11-02-2012",name:"11 февраля"}]}};var i=!1;oneClickIsReady=!1;var j={product_id:e.jsitemid,product_quantity:1,region_id:1*e.jsregionid},k=function(a){"undefined"!=typeof OC_MVM&&OC_MVM.pickShopOnMap(a.id)},l=function(){$(".jsOrder1click").remove()},m=function(b){if(!b.success||0===b.data.length)return $(".jsOrder1click").remove(),!1;if(Deliveries=b.data,i="self"in Deliveries||"now"in Deliveries,i&&(mapCenter=calcMCenter(Deliveries.hasOwnProperty("self")?Deliveries.self.shops:Deliveries.now.shops)),OC_MVM=new a,ko.applyBindings(OC_MVM,$("#order1click-container-new")[0]),i){var d=function(){window.regionMap.addHandler(".shopchoose",n)};try{MapInterface.init(mapCenter,"mapPopup",d,k)}catch(e){$(".bFast__eMapLink").remove()}}oneClickIsReady=!0,c(),document.location.hash.match(/oneclick/)&&$(".jsOrder1click").trigger("click")};$.ajax({type:"POST",url:f,data:j,success:m,statusCode:{500:l,502:l,503:l,504:l},error:l});var n=function(a){var b=$(a).parent().find(".shopnum").text();OC_MVM.toggleMap(),OC_MVM.chooseShopById(b)};$(".jsOrder1click").bind("click",function(){if(!oneClickIsReady)return!1;OC_MVM.AnalyticsFormOpen();var a=function(){var a=$("#recipientEmail").val(),b=$('input[type="checkbox"][name="subscribe"]'),c=$("#recipientEmail").siblings(".bSubscibeWrapper"),e=$(".bSubscibe"),f=$("#recipientEmail");!a&&$("#recipientEmail").siblings(".mEmpty").length&&f.siblings(".mEmpty").hide(),a&&a.isEmail()&&c.hasClass("hf")?(c.removeClass("hf"),d&&(b.attr("disabled",""),b.attr("checked","checked"),b.val(1),e.addClass("checked")),f.siblings(".mEmpty").hide()):a&&(!a||a.isEmail())||c.hasClass("hf")||(c.addClass("hf"),d&&(b.attr("disabled","disabled"),b.attr("checked",""),b.val(0),e.removeClass("checked")),f.val()&&f.siblings(".mEmpty").show())};return $("body").on("keyup ready","#recipientEmail",function(){a()}),$("#order1click-container-new").lightbox_me({centered:!0,onClose:function(){"regionMap"in window&&window.regionMap.closeMap(OC_MVM.turnOffMap)}}),!1}),$(".jsOrder1clickProxy").bind("click",function(a){$(".jsOrder1click").click(),a.preventDefault()})}if($("#stockBlock").length){MapInterface.ready("yandex",{yandex:$("#infowindowforstockYa"),google:$("#infowindowforstock")});var e=$("#stockmodel").data("value"),f=$("#stockmodel").attr("link-input"),g=$("#stockmodel").attr("link-output"),i=!1,o=(new Date).toISOString().substr(0,10),j={product_id:e.jsitemid,product_quantity:1,region_id:1*e.jsregionid};$.post(f,j,function(d){if(!d.success)return $(".bOrderPreloader").hide(),$("#noDlvr").show(),!1;Deliveries=d.data;var e=0;for(var f in Deliveries)e++;if(Deliveries.length=e,"currentDate"in d&&""!=d.currentDate&&(o=d.currentDate),$(".bOrderPreloader").hide(),0===e)return $("#noDlvr").show(),!1;if(i="self"in Deliveries,!i)return $("#noDlvr").show(),!1;if(!(Deliveries.self.dates.length>0))return $("#noDlvr").show(),!1;if(i&&(mapCenter=calcMCenter(Deliveries.self.shops)),MVM=new b,ko.applyBindings(MVM,$("#stockCntr")[0]),OC_MVM=new a,ko.applyBindings(OC_MVM,$("#order1click-container-new")[0]),c(),i){var g=function(a){var b=$(a).parent().find(".shopnum").text();MVM.chooseShopById(b)},h=function(a){"undefined"!=typeof MVM&&MVM.pickShopOnMap(a.id)},j=function(){window.regionMap.addHandler(".shopchoose",g)};MapInterface.init(mapCenter,"stockmap",j,h)}$("#stockBlock").show()})}});