$(document).ready(function(){function e(){var e=this;e.noDelivery=ko.observable(!1),e.title=r.jstitle,e.price=r.jsprice,e.icon=r.jsbimg,e.shortcut=r.jsshortcut,e.stockq=r.jsstock,e.quantity=ko.observable(1),e.quantityTxt=ko.computed(function(){return e.quantity()+" шт."},this),e.priceTxt=ko.computed(function(){return printPrice(e.price)},this),e.newWarehouse=r.is_quick_only,e.formStatus=ko.observable("typing"),e.formStatusTxt=ko.computed(function(){var o="";switch(e.formStatus()){case"reserve":o="Зарезервировать";break;case"typing":o="Отправить заказ";break;case"process":o="Проверка...";break;case"error":o="Отправить заказ нельзя";break;case"sending":o="Отправка..."}return o},this);var o=window.docCookies.getItem("scId");e.showMap=ko.observable(!1),e.textfields=[];var s=$("#oneClick").length?$("#oneClick").data("values").recipient_first_name:"",l=$("#oneClick").length?$("#oneClick").data("values").recipient_phonenumbers:"",c=$("#oneClick").length?$("#oneClick").data("values").recipient_email:"";e.textfields.push(ko.observable({title:"Имя получателя",name:"order[recipient_first_name]",selectorid:"",value:s,valerror:!1,showsubscribe:!1,regexp:/^[ёa-zа-я\s]+$/i})),e.textfields.push(ko.observable({title:"Телефон для связи",name:"order[recipient_phonenumbers]",selectorid:"phonemask",value:l,valerror:!1,showsubscribe:!1,regexp:/^[()0-9\-\+\s]+$/})),e.textfields.push(ko.observable({title:"Email (если есть)",name:"order[recipient_email]",selectorid:"recipientEmail",value:c,valerror:!1,showsubscribe:!0,active:!0,regexp:/./})),e.textfields.push(ko.observable({title:"номер вашей карты «Связной-Клуб»",name:"order[recipient_scCard]",selectorid:"scCard",value:o,valerror:!1,showsubscribe:!1,regexp:/^[()0-9\-\s]+$/})),e.disabledSelectors=ko.observable(!1),e.noQBar=ko.observable(!1),e.stableType=ko.observable(!1),e.chosenDlvr=ko.observable({}),e.chosenDate=ko.observable({}),e.dlvrs=ko.observableArray([]),e.dates=ko.observableArray([]),e.shops=ko.observableArray([]),e.chosenShop=ko.observable({}),e.pickedShop=ko.observable({}),e.dynModel=function(o){var t=e.chosenDlvr().type;t||(t="self"),e.dlvrs.removeAll();for(var r in o)e.dlvrs.push({type:r,name:o[r].name,modeID:o[r].modeId,price:o[r].price}),r==t&&e.chosenDlvr(e.dlvrs()[e.dlvrs().length-1]);if("type"in e.chosenDlvr()||e.chosenDlvr(e.dlvrs()[0]),console.log(e.chosenDlvr()),e.dates(o[e.chosenDlvr().type+""].dates.slice(0)),e.chosenDate(e.dates()[0]),console.log(a),a)o.hasOwnProperty("self")?(console.log("self shops"),e.shops(o.self.shops.slice(0))):(console.log("now shops"),e.shops(o.now.shops.slice(0))),e.chosenShop(e.shops()[0]),e.pickedShop(e.shops()[0]);else{var n={address:"",regtime:"",id:1};e.chosenShop(n),e.pickedShop(n)}},e.dynModel(Deliveries),e.total=ko.computed(function(){return printPrice(e.price*e.quantity()+1*e.chosenDlvr().price)},this),e.changeDlvr=function(){console.info("changeDlvr");var o=e.chosenDlvr().type;for(e.dates.removeAll();e.dates().length;)e.dates.pop();for(var t=0;Deliveries[o].dates.length>t;t++)e.dates().push(Deliveries[o].dates[t]);e.chosenDate(e.dates()[0]),e.showMap()&&e.showMap(!1),window.regionMap===void 0&&(console.warn("region map undefined"),$(".bFast__eMapLink").remove())},e.plusItem=function(){if(e.quantity(e.quantity()+1),e.quantity()>e.stockq)return e.noDelivery(!0),!1;var o=1*e.quantity();return setTimeout(function(){e.loadData(o,1)},500),p(),!1},e.minusItem=function(){if(1==e.quantity())return!1;if(e.quantity(e.quantity()-1),e.noDelivery()){if(!(e.quantity()<=e.stockq))return!1;e.noDelivery(!1)}var o=1*e.quantity();return setTimeout(function(){e.loadData(o,-1)},500),p(),!1};var p=function p(){var o={"Checkout Step 1 SKU Quantity":1*e.quantity(),"Checkout Step 1 SKU Total":1*e.price*e.quantity(),"Checkout Step 1 Order Total":1*e.price*e.quantity()+1*e.chosenDlvr().price};"undefined"!=typeof _kmq&&_kmq.push(["set",o])};e.preparedData=function(o){if("self"===o.type||"now"===o.type){e.formStatus("reserve");for(var t=0,r=e.dlvrs().length;r>t;t++)if("self"===e.dlvrs()[t].type||"now"===e.dlvrs()[t].type){e.chosenDlvr(e.dlvrs()[t]);break}e.disabledSelectors(!0),e.noQBar(!0),e.chooseShopById(o.shop.id),"date"in o&&e.chosenDate(o.date),"shop"in o&&e.chooseShopById(o.shop.id)}else if("courier"===o.type){e.formStatus("reserve");for(var n=0,i=e.dlvrs().length;i>n;n++)if("self"!==e.dlvrs()[n].type&&"now"!==e.dlvrs()[n].type){e.chosenDlvr(e.dlvrs()[n]);break}e.disabledSelectors(!1),e.stableType(!0),e.noQBar(!0)}},e.loadData=function(o,t){if(console.info("loadData"),!(t>0&&e.quantity()>o||0>t&&o>e.quantity())){var i={product_id:r.jsitemid,product_quantity:o,region_id:1*r.jsregionid};$.post(n,i,function(o){if(e.noDelivery())return!1;if(!o.success)return e.noDelivery(!0),!1;Deliveries=o.data;var t=0;for(var r in Deliveries)t++;if(0===t)return e.noDelivery(!0),!1;if(e.noDelivery(!1),a="self"in Deliveries||"now"in Deliveries,console.log(a),e.dynModel(Deliveries),a&&"undefined"==typeof mapCenter&&(mapCenter=calcMCenter(Deliveries.self.shops)),a&&!("regionMap"in window)){var n=function(){window.regionMap.addHandler(".shopchoose",u)};MapInterface.init(mapCenter,"mapPopup",n)}})}},e.pickDate=function(){if(a&&"shopIds"in item&&item.shopIds.length>0){e.shops.removeAll();for(var o in Deliveries.self.shops)-1!==$.inArray(Deliveries.self.shops[o].id,item.shopIds)&&e.shops.push(Deliveries.self.shops[o])}e.showMap()&&e.showMarkers()},e.pickShop=function(o){for(var t=0,r=e.shops.length;r>t;t++)if(e.shops[t].id==o)return e.chosenShop(e.shops[t]),void 0},e.pickShopOnMap=function(o){for(var t=0,r=e.shops().length;r>t;t++)if(e.shops()[t].id==o)return e.pickedShop(e.shops()[t]),void 0},e.toggleMap=function(){e.showMap()?$("#mapPopup").slideUp(500,function(){e.showMap(!1)}):$("#mapPopup").slideDown(500,function(){e.showMap(!0),e.showMarkers()})},e.turnOffMap=function(){console.log("tick"),e.showMap(!1)},e.showMarkers=function(){for(var o={},t=e.shops(),r=0,n=t.length;n>r;r++){var i=1*t[r].id;o[i]={id:t[r].id,name:t[r].address,regtime:t[r].regtime,latitude:t[r].latitude,longitude:t[r].longitude}}window.regionMap.showMarkers(o)},e.chooseShopById=function(o){for(var t=0,r=e.shops().length;r>t;t++)if(e.shops()[t].id==o){e.chosenShop(e.shops()[t]);break}},e.validateField=function(o,r){var n=!1;if(("order[recipient_scCard]"==r.currentTarget.name||"order[recipient_email]"===r.currentTarget.name)&&""==r.currentTarget.value)return!0;"order[recipient_email]"!==r.currentTarget.name||r.currentTarget.value.isEmail()||(n=!0,e.formStatus("typing")),"order[recipient_email]"===r.currentTarget.name||""!=r.currentTarget.value.replace(/\s/g,"")&&o.regexp.test(r.currentTarget.value)||(n=!0,e.formStatus("typing")),"phonemask"===r.currentTarget.getAttribute("id")&&10!==r.currentTarget.value.replace(/[^0-9]/g,"").length&&(n=!0,e.formStatus("typing"));for(var i=0,s=e.textfields.length;s>i;i++)if(e.textfields[i]().name===o.name){var a=e.textfields[i]();a.valerror=n,a.value=r.currentTarget.value,"order[recipient_email]"===r.currentTarget.name&&(a.active=!!parseInt($('#order1click-container-new .bSubscibe input[name="subscribe"]').val())),e.textfields[i](a);break}return t(),!0},e.validateForm=function(){return e.noDelivery()?!1:(("typing"===e.formStatus()||"reserve"===e.formStatus())&&(e.formStatus("process"),$("#oneClick input").trigger("change"),"typing"!==e.formStatus()&&e.sendData()),void 0)},e.sendData=function(){e.formStatus("sending"),$(".bFastInner tbody tr:last").empty();var o={"order[product_quantity]":e.quantity(),"order[delivered_at]":e.chosenDate().value,"order[delivery_type_id]":e.chosenDate().isNow?4:e.chosenDlvr().modeID};("self"==e.chosenDlvr().type||"now"==e.chosenDlvr().type)&&(o["order[shop_id]"]=e.chosenShop().id);for(var t=0,r=e.textfields.length;r>t;t++)o[e.textfields[t]().name+""]=e.textfields[t]().value;o.subscribe=$('#order1click-container-new .bSubscibe input[name="subscribe"]').val(),window.KM!==void 0&&(o.kiss_session=window.KM.i),$.ajax({type:"POST",timeout:6e4,url:i,data:o,success:function(o,t){return o.success&&"success"===t?(OC_MVM.AnalyticsComplete(o.data),$(".bFast").parent().append(o.data.content),$(".bFast").remove(),$(".p0").removeClass("p0"),OC_MVM.AnaliticsCompleteExtra!==void 0&&OC_MVM.AnaliticsCompleteExtra(),void 0):(e.formStatus("typing"),$(".bFastInner tbody tr:last").append('<td colspan="2" class="red">'+o.message+"</td>"),void 0)},error:function(){e.formStatus("typing")}})},e.AnalyticsFormOpen=function(){console.log("% Oneclick. Form is open! ### Begin of AnalyticsFormOpen.");var o={"Checkout Step 1 SKU Quantity":e.quantity(),"Checkout Step 1 SKU Total":e.price*e.quantity(),"Checkout Step 1 Order Total":e.price*e.quantity()+1*e.chosenDlvr().price,"Checkout Step 1 Order Type":"one click order"};"undefined"!=typeof yaCounter10503055&&(console.log("% Oneclick. Run yaCounter10503055"),yaCounter10503055.reachGoal("orderscomplete")),"undefined"!=typeof _gaq&&(console.log("% Oneclick. Setting GA code: /order_form"),_gaq.push(["_trackEvent","QuickOrder","Open"]),_gaq.push(["_trackPageview","/order_form"])),"ANALYTICS"in window&&(console.log("% Oneclick. Run marketgidOrder from ANALYTICS"),ANALYTICS.runMethod("marketgidOrder")),"undefined"!=typeof _kmq&&(console.log("% Oneclick. Setting toKISS_oc code"),_kmq.push(["record","Checkout Step 1",o])),console.log("% Oneclick. ### End of AnalyticsFormOpen")},e.AnalyticsComplete=function(o){console.log("% Oneclick. Order is complete! ### Begin of AnalyticsComplete.");var t,r,n=$("#phonemask"),i=n&&n.val()?"8"+n.val().replace(/\D/g,""):null;"undefined"!=typeof Flocktory&&(r={order_id:o.orderNumber,price:1*e.price*e.quantity()+1*e.chosenDlvr().price,items:[{id:e.shortcut,title:e.title,price:e.price,image:e.icon,count:e.quantity()}]},Flocktory.popup_opder(r)),"undefined"!=typeof _kmq&&"undefined"!==KM&&(console.log("phoneNumber"),console.log(i),_kmq.push(["alias",i,KM.i()]),_kmq.push(["identify",i]),t={"Checkout Complete Order ID":o.orderNumber,"Checkout Complete SKU Quantity":e.quantity(),"Checkout Complete SKU Total":1*e.price*e.quantity(),"Checkout Complete Delivery Total":1*e.chosenDlvr().price,"Checkout Complete Order Total":1*e.price*e.quantity()+1*e.chosenDlvr().price,"Checkout Complete Order Type":"one click order","Checkout Complete Delivery":e.chosenDlvr().type},_kmq.push(["record","Checkout Complete",t]),t={"Checkout Complete SKU":o.productArticle,"Checkout Complete SKU Quantity":1*e.quantity(),"Checkout Complete SKU Price":1*e.price,"Checkout Complete Parent category":o.productCategory[0].name,"Checkout Complete Category name":o.productCategory[o.productCategory.length-1].name,_t:KM.ts()+1,_d:1},_kmq.push(["set",t])),"undefined"!=typeof _gaq&&(console.log("% Oneclick. Setting GA code: /thanks_form"),_gaq.push(["_trackEvent","QuickOrder","Success"]),_gaq.push(["_trackPageview","/thanks_form"]),_gaq.push(["_trackTrans"])),ANALYTICS.parseAllAnalDivs($(".jsanalytics")),console.log("% Oneclick. ### End of AnalyticsComplete.")}}function o(){var e=this;e.showMap=ko.observable(!1),e.title=r.jstitle,e.price=r.jsprice,e.icon=r.jssimg,e.shortcut=r.jsshortcut,e.region=r.jsregion,e.today=ko.observable(!0),e.todayLabel=ko.observable("Сегодня"),e.tomorrowLabel=ko.observable("Завтра"),e.priceTxt=ko.computed(function(){return printPrice(e.price)},this),e.shops=Deliveries.self.shops.slice(0),e.todayShops=[],e.tomorrowShops=[],e.activeCourier=Deliveries.length>1,parseDateShop=function(o,t){var r=[];e:for(var n=0,i=o.length;i>n;n++)for(var s=0,a=e.shops.length;a>s;s++)if(e.shops[s].id==o[n]){var l={};for(var c in e.shops[s])l[c]=e.shops[s][c];l.lbl=t,r.push(l);continue e}return r};var o=0;e.todayShops=parseDateShop(Deliveries.self.dates[0].shopIds,"td"),e.todayLabel(Deliveries.self.dates[0].name.match(/\d{2}\.\d{2}\.\d{4}/)[0]),Deliveries.self.dates.length>1&&(e.tomorrowShops=parseDateShop(Deliveries.self.dates[1].shopIds,"tmr"),e.tomorrowLabel(Deliveries.self.dates[1].name.match(/\d{2}\.\d{2}\.\d{4}/)[0])),e.pickedShop=ko.observable(e.todayShops[0]),e.selectedS=ko.observable({});var t="ах";1===e.todayShops.length%10&&11!==e.todayShops.length&&(t="е"),e.todayH2='Можно забрать <span class="mLft">'+Deliveries.self.dates[0].name+"</span> в "+e.todayShops.length+" магазин"+t+":",t=1===e.tomorrowShops.length%10&&11!==e.tomorrowShops.length?"е":"ах",e.tomorrowH2=e.todayShops.length>0?"или":"Можно забрать ",Deliveries.self.dates.length>1&&(e.tomorrowH2+=' <span class="mRt">'+Deliveries.self.dates[1].name+"</span> в "+e.tomorrowShops.length+" магазин"+t+":"),e.toggleView=function(o){return e.showMap(o),o&&(e.todayShops.length?e.showMarkers():e.toggleTerm(!1)),!1},e.toggleTerm=function(o){return e.today(o),window.regionMap.hideInfobox(),e.showMarkers(),!1},e.chooseShop=function(o,t){e.selectedS(o),e.today(t)},e.chooseShopById=function(o){for(var t=0,r=e.shops.length;r>t;t++)if(e.shops[t].id==o){e.selectedS(e.shops[t]);break}e.reserveItem()},e.pickShopOnMap=function(o){for(var t=0,r=e.shops.length;r>t;t++)if(e.shops[t].id==o)return e.pickedShop(e.shops[t]),void 0},e.showMarkers=function(){for(var o={},t=e.today()?e.todayShops:e.tomorrowShops,r=0,n=t.length;n>r;r++){var i=t[r].id+"";o[i]={id:t[r].id,name:t[r].address,regtime:t[r].regtime,latitude:t[r].latitude,longitude:t[r].longitude}}window.regionMap.showMarkers(o)},e.reserveItem=function(){var t={type:"self",date:e.today()?Deliveries.self.dates[o]:Deliveries.self.dates[o+1],shop:e.selectedS()};return OC_MVM.preparedData(t),$("#order1click-container-new").lightbox_me({}),!1},e.onlyCourier=function(){var e={type:"courier"};return OC_MVM.preparedData(e),$("#order1click-container-new").lightbox_me({}),!1}}function t(){$("#phonemask").parent().prepend('<span id="phonePH">+7</span>'),$.mask!==void 0&&($.mask.definitions.n="[0-9]",$("#phonemask").mask("(nnn) nnn-nn-nn"),$("#phonemask")[0].getAttribute("value")&&$("#phonemask").val($("#phonemask")[0].getAttribute("value")),$.mask.definitions["*"]="[0-9*]",$("#scCard").mask("* ****** ******",{placeholder:"*"}),$("#scCard")[0].getAttribute("value")&&$("#scCard").val($("#scCard")[0].getAttribute("value")),$("#scCard").blur(function(){"* ****** ******"===$(this).val()&&($(this).trigger("unmask").val(""),$(this).focus(function(){$("#scCard").mask("2 98nnnn nnnnn",{placeholder:"*"})}))}))}if($(".jsOrder1click").length){MapInterface.ready("yandex",{yandex:$("#map-info_window-container-ya"),google:$("#map-info_window-container")});var r=$(".jsOrder1click").data("model"),n=$(".jsOrder1click").attr("link-input"),i=$(".jsOrder1click").attr("link-output"),s=$(".bSubscibeWrapper");$("body").on("userLogged",function(e,o){o&&o.isSubscribed&&s.hide()}),Deliveries={self:{modeId:4,name:"Доставка",price:400,dates:[{value:"10-02-2012",name:"10 февраля"},{value:"11-02-2012",name:"11 февраля"}]}};var a=!1;oneClickIsReady=!1;var l={product_id:r.jsitemid,product_quantity:1,region_id:1*r.jsregionid},c=function(e){"undefined"!=typeof OC_MVM&&OC_MVM.pickShopOnMap(e.id)},p=function p(){$(".jsOrder1click").remove()},d=function d(o){if(!o.success||0===o.data.length)return $(".jsOrder1click").remove(),!1;if(Deliveries=o.data,console.info("data recive"),a="self"in Deliveries||"now"in Deliveries,console.log(a),a&&(Deliveries.hasOwnProperty("self")?(console.log("self shops"),mapCenter=calcMCenter(Deliveries.self.shops)):(console.log("now shops"),mapCenter=calcMCenter(Deliveries.now.shops))),OC_MVM=new e,ko.applyBindings(OC_MVM,$("#order1click-container-new")[0]),a){var r=function(){window.regionMap.addHandler(".shopchoose",u)};try{console.info("грузим карту"),MapInterface.init(mapCenter,"mapPopup",r,c)}catch(n){console.warn("карта не загрузилась"),$(".bFast__eMapLink").remove()}}oneClickIsReady=!0,t(),document.location.hash.match(/oneclick/)&&$(".jsOrder1click").trigger("click")};$.ajax({type:"POST",url:n,data:l,success:d,statusCode:{500:p,502:p,503:p,504:p},error:p});var u=function(e){var o=$(e).parent().find(".shopnum").text();OC_MVM.toggleMap(),OC_MVM.chooseShopById(o)};$(".jsOrder1click").bind("click",function(){if(!oneClickIsReady)return!1;OC_MVM.AnalyticsFormOpen();var e=function(){var e=$("#recipientEmail").val(),o=$('input[type="checkbox"][name="subscribe"]'),t=$("#recipientEmail").siblings(".bSubscibeWrapper");!e&&$("#recipientEmail").siblings(".mEmpty").length&&$("#recipientEmail").siblings(".mEmpty").hide(),e&&e.isEmail()&&t.hasClass("hf")?(t.removeClass("hf"),o.attr("disabled",""),o.attr("checked","checked"),o.val(1),$(".bSubscibe").addClass("checked"),$("#recipientEmail").siblings(".mEmpty").hide()):e&&(!e||e.isEmail())||t.hasClass("hf")||(t.addClass("hf"),o.attr("disabled","disabled"),o.attr("checked",""),o.val(0),$(".bSubscibe").removeClass("checked"),$("#recipientEmail").val()&&$("#recipientEmail").siblings(".mEmpty").show())};return $("body").on("keyup ready","#recipientEmail",function(){e()}),$("#order1click-container-new").lightbox_me({centered:!0,onClose:function(){"regionMap"in window&&window.regionMap.closeMap(OC_MVM.turnOffMap)}}),!1}),$(".jsOrder1clickProxy").bind("click",function(e){$(".jsOrder1click").click(),e.preventDefault()})}if($("#stockBlock").length){MapInterface.ready("yandex",{yandex:$("#infowindowforstockYa"),google:$("#infowindowforstock")});var r=$("#stockmodel").data("value"),n=$("#stockmodel").attr("link-input"),i=$("#stockmodel").attr("link-output"),a=!1,h=(new Date).toISOString().substr(0,10),l={product_id:r.jsitemid,product_quantity:1,region_id:1*r.jsregionid};$.post(n,l,function(r){if(!r.success)return $(".bOrderPreloader").hide(),$("#noDlvr").show(),!1;Deliveries=r.data;var n=0;for(var i in Deliveries)n++;if(Deliveries.length=n,"currentDate"in r&&""!=r.currentDate&&(h=r.currentDate),$(".bOrderPreloader").hide(),0===n)return $("#noDlvr").show(),!1;if(a="self"in Deliveries,!a)return $("#noDlvr").show(),!1;if(!(Deliveries.self.dates.length>0))return $("#noDlvr").show(),!1;if(a&&(mapCenter=calcMCenter(Deliveries.self.shops)),MVM=new o,ko.applyBindings(MVM,$("#stockCntr")[0]),OC_MVM=new e,ko.applyBindings(OC_MVM,$("#order1click-container-new")[0]),t(),a){var s=function(e){var o=$(e).parent().find(".shopnum").text();MVM.chooseShopById(o)},l=function(e){"undefined"!=typeof MVM&&MVM.pickShopOnMap(e.id)},c=function(){window.regionMap.addHandler(".shopchoose",s)};MapInterface.init(mapCenter,"stockmap",c,l)}$("#stockBlock").show()})}});