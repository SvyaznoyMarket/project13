!function(ENTER){var form=$(".jsEnterprizeForm"),body=$("body"),mobilePhoneField=$(".jsMobile"),authBlock=$("#enterprize-auth-block"),validationConfig={fields:[{fieldNode:$(".jsName"),require:!0,customErr:"Не указано имя"},{fieldNode:mobilePhoneField,require:!0,validBy:"isPhone",customErr:"Не указан мобильный телефон"},{fieldNode:$(".jsEmail"),require:!0,validBy:"isEmail",customErr:"Не указан email"},{fieldNode:$(".jsAgree"),require:!0,customErr:"Необходимо согласие"},{fieldNode:$(".jsSubscribe"),require:!0,customErr:"Необходимо согласие"}]},validator=new FormValidator(validationConfig),signinValidationConfig={fields:[{fieldNode:$(".jsSigninUsername",authBlock),require:!0,customErr:"Не указан логин"},{fieldNode:$(".jsSigninPassword",authBlock),require:!0,customErr:"Не указан пароль"}]},signinValidator=new FormValidator(signinValidationConfig),forgotPwdValidationConfig={fields:[{fieldNode:$(".jsForgotPwdLogin",authBlock),require:!0,customErr:"Не указан email или мобильный телефон",validateOnChange:!0}]},forgotValidator=new FormValidator(forgotPwdValidationConfig),clearMsg=function(){$("ul.red").length&&$("ul.red").html(""),$("ul.green").length&&$("ul.green").html("")},showMsg=function(a,b){var b=b?b:"error",c="error"===b?"red":"notice"===b?"green":null,d=$("ul."+c);if(c)return d.length?d.html("<li>"+a+"</li>"):form.prepend($('<ul class="'+c+'" />').append("<li>"+a+"</li>")),!1},formErrorHandler=function(a){var b=$('[name="user['+a.field+']"]'),c=function(){validator._unmarkFieldError($(this))};return validator._markFieldError(b,a.message),b.bind("focus",c),!1},serverErrorHandler=function(a){var b,c=null;for(b=a.form.error.length-1;b>=0;b--)c=a.form.error[b],c.message&&("global"===c.field?showMsg(c.message):formErrorHandler(c));return!1},formSubmit=function(a){a.preventDefault();var b=$(this).serializeArray(),c=$(this).attr("action"),d=function(a){return a.error?(a.needAuth&&openAuth(),serverErrorHandler(a),!1):(void 0!==a.data.link?window.location.href=a.data.link:a.notice.message&&showMsg(a.notice.message,"notice"),!1)},e=function(a){var b=$(".js-ep-reg-form"),c=$(".js-ep-reg-complete"),d=c.find(".js-ep-reg-complete-text");return a.error?(a.needAuth&&openAuth(),serverErrorHandler(a),!1):(void 0!==a.data.link?window.location.href=a.data.link:a.notice.message&&d.html(a.notice.message),b.hide(),c.show(),!1)};return"new-form"==$(this).data("form")?$.post(c,b,e,"json"):$.post(c,b,d,"json"),clearMsg(),!1},epHintPopup=function(){var a=$(".js-ep-btn-hint-popup"),b=$(".js-ep-hint-popup"),c=b.find(".js-ep-hint-popup-close"),d=function(){return b.fadeIn(100),!1},e=function(){return b.fadeOut(100),!1};a.on("click",d),c.on("click",e)},openAuth=function(){ENTER.utils.signinValidationConfig=signinValidationConfig,ENTER.utils.signinValidator=signinValidator,ENTER.utils.forgotPwdValidationConfig=forgotPwdValidationConfig,ENTER.utils.forgotValidator=forgotValidator;var removeErrors=function(){var validators=["signin","forgot"],validator,config,self,i,j;for(j in validators)if(validator=eval("ENTER.utils."+validators[j]+"Validator"),config=eval("ENTER.utils."+validators[j]+"ValidationConfig"),config&&config.fields&&validator)for(i in config.fields)self=config.fields[i].fieldNode,self&&validator._unmarkFieldError(self)};return authBlock.lightbox_me({centered:!0,autofocus:!0,onLoad:function(){authBlock.find("input:first").focus()},onClose:removeErrors}),!1};$.mask.definitions.n="[0-9]",mobilePhoneField.length&&mobilePhoneField.mask("8 (nnn) nnn-nn-nn"),body.on("submit",".jsEnterprizeForm",formSubmit),body.on("click",".jsEnterprizeAuthLink",openAuth),$(".js-slider").length&&$(".js-slider").goodsSlider(),body.on("click",".js-enterprize-coupon",function(){var a,b=$(this),c=$("#tplEnterprizeForm"),d=c.html(),e=b.data("column"),f="act",g=b.data("value");if($(".js-enterprize-coupon-hint").remove(),a=Mustache.render(d,g),b.hasClass(f)?(b.removeClass(f),$(".js-enterprize-coupon-hint").remove()):($(".js-enterprize-coupon").removeClass(f),b.addClass(f),b.closest(".js-enterprize-coupon-parent").append(a),$(".js-enterprize-coupon-hint").addClass(e),body.trigger("trackGooglePageview",["/enterprize/form/"+g.token])),g.slider.url){var h=$(".js-enterprize-slider-container");if(h.empty(),body.data("enterprizeSliderXhr"))try{body.data("enterprizeSliderXhr").abort()}catch(i){}var j=$.get(g.slider.url);j.done(function(a){a.content&&h.removeClass("mLoader").html(a.content)}),j.always(function(){body.data("enterprizeSliderXhr",null),$(".js-slider").goodsSlider()}),body.data("enterprizeSliderXhr",j)}}),body.on("click",".js-ep-hint-closer",function(a){a.preventDefault(),$(this).closest(".js-enterprize-coupon-hint").remove(),$(".js-enterprize-coupon").removeClass("act")}),body.on("focus",".js-phone-mask",function(){var a=$(this);$.mask.definitions.n="[0-9]",a.length&&a.mask("8 (nnn) nnn-nn-nn")}),body.on("click",".js-ep-rules-toggle",function(a){a.preventDefault(),$(".js-ep-rules-list").toggle()}),$(document).ready(function(){$(".epHintPopup").length&&epHintPopup("slow")})}(window.ENTER),$.widget("ui.registerAuth",{availableStates:["authRegistration","update","confirm","setEnterprize"],wrapper:void 0,state:"authRegister",authRegistrationForm:"",options:{state:"authRegistration",wrapper:".jsBodyWrapper",beforeInit:function(a,b){return b(),a},afterInit:function(){},beforeComplete:function(a,b){return b(),a},afterComplete:function(){}},_create:function(){var a=this.options;this._state.widget=this,this.wrapper=this.element.find(a.wrapper),this.authRegistrationForm=this.wrapper.html(),this._setState(a.state)},init:function(a){var b=this;return a&&this._setState(a),this.options.beforeInit(this,function(){return b}).options.afterInit(this)},complete:function(){var a=this;return this.options.beforeComplete(this,function(){return a}).options.afterComplete(this),this},_setState:function(a){return this._state[a](),this.state=a,this},applyFormState:function(a,b){this.flushFormState(a),b.error&&this.applyFormErrorMessage(a,b.error),b.message&&this.applyFormMessage(a,b.message);for(k in b.fields)b.fields[k].error&&this.applyFieldError(a,k,b.fields[k].error);return this},applyFormErrors:function(a,b){var c={fields:{}};for(k in b)"global"!=b[k].field?c.fields[b[k].field]={error:b[k].message}:c.error=b[k].message;return this.applyFormState(a,c)},applyFieldError:function(a,b,c){var d=this;return a.find('[name*="'+b+'"]').before(d.getErrorString(c)).addClass("mError").end(),this},flushFormState:function(a){return a.find("input").removeClass("mError").end().find(".bErrorText").remove().end().find(".error_list").remove().end().find(".message").remove().end(),this},applyFormErrorMessage:function(a,b){return a.prepend('<ul class="error_list"><li>'+b+"</li></ul>"),this},applyFormMessage:function(a,b){return a.prepend('<p class="message" style="border: 1px solid #ffa901; padding: 2px 5px">'+b+"</p>"),this},applyMessage:function(a){return this.wrapper.prepend("<h2>"+a+"</h2>"),this},getErrorString:function(a){return'<div class="bErrorText"><div class="bErrorText__eInner">'+a+"</div>"},_state:{authRegistration:function(){"authRegistration"!=this.widget.state&&this.widget.wrapper.html(this.widget.authRegistrationForm);var a=this.widget.wrapper.find(".jsEnterprizeForm");a.off(),a.on("submit",$.proxy(this.widget._formHandler.registration,a)),$.mask.definitions.n="[0-9]",a.find(".jsMobile").mask("8nnnnnnnnnn");var a=this.widget.wrapper.find(".jsLoginForm");a.off(),a.on("submit",$.proxy(this.widget._formHandler.login,a))},update:function(){var a=this,b=function(a){var b=a.widget.wrapper.find(".jsEnterprizeForm");b.off(),b.on("submit",$.proxy(a.widget._formHandler.update,b))};"update"!=this.widget.state?$.get("/updateRegistration?body=1",function(c){"undefined"!=typeof c.error&&401==c.error?a.widget._setState("authRegistration"):(a.widget.wrapper.html(c.body),b(a))}):b(a)},confirm:function(){var a=this,b=function(a){var b=a.widget.wrapper.find(".jsConfirmEmailRepeatCode");b.length>0&&(b.off(),b.on("submit",$.proxy(a.widget._formHandler.confirmEmailRepeatCode,b)));var b=a.widget.wrapper.find(".jsConfirmPhone");b.length>0&&(b.off(),b.on("submit",$.proxy(a.widget._formHandler.confirmPhone,b)));var b=a.widget.wrapper.find(".jsConfirmPhoneRepeatCode");b.length>0&&(b.off(),b.on("submit",$.proxy(a.widget._formHandler.confirmPhoneRepeatCode,b)));var b=a.widget.wrapper.find(".jsCheckConfirmForm");b.length>0&&(b.off(),b.on("submit",$.proxy(a.widget._formHandler.confirmCheckState,b)))};"confirm"!=this.widget.state?$.ajax({url:"/enterprize/confirm-wc/form",success:function(c){"undefined"!=typeof c.error&&401==c.error.code?a.widget._setState("authRegistration"):(a.widget.wrapper.html(c.result.form),b(a))}}):b(a)},setEnterprize:function(){var a=this;$.ajax({url:"/enterprize/confirm-wc/setEnterprize",success:function(b){b.error&&401==b.error.code?a.widget._setState("authRegistration"):b.error?(a.widget.wrapper.html(""),a.widget.applyMessage(b.error.message)):(a.widget.wrapper.html(""),a.widget.applyMessage(b.result.message),window.setTimeout(function(){a.widget.complete()},5e3))}})}},_formHandler:{login:function(){var a=this,b=$(this.context).data().uiRegisterAuth;return $.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(c){c.error?b.applyFormErrors(a,c.form.error):c.data.user.is_enterprize_member?b.complete():c.data.user.mobile_phone&&c.data.user.email?c.data.user.is_email_confirmed&&c.data.user.is_phone_confirmed?c.data.user.is_enterprize_member?c.alreadyLogged?b._setState("update"):b.applyFormState(a,{message:c.message}):b._setState("setEnterprize"):b._setState("confirm"):b._setState("update")},error:function(){b.applyFormState(a,{error:"Не удается авторизоваться."})}}),!1},registration:function(){var a=this,b=$(this.context).data().uiRegisterAuth;return $.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(c){c.success?b._setState(c.alreadyLogged?"update":"confirm"):b.applyFormState(a,c.form)},error:function(){b.applyFormState(a,{error:"Не удается выполнить регистрацию."})}}),!1},update:function(){var a=this,b=$(this.context).data().uiRegisterAuth;$.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(c){c.success?$.ajax({type:"POST",url:"/enterprize/confirm-wc/state",success:function(a){b._setState(a.status.isEmailConfirmed&&a.status.isPhoneConfirmed?"setEnterprize":"confirm")}}):b.applyFormState(a,c.form)},error:function(){b.applyFormState(a,{error:"Не удается обновить данные."})}})},confirmPhone:function(){var a=this,b=$(this.context).data().uiRegisterAuth;return $.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(c){c.error?b.applyFormState(a,{error:c.error.message}):c.status&&c.status.isEmailConfirmed?b._setState("setEnterprize"):(b.flushFormState(a),b.applyFormMessage(a,c.message),b.wrapper.find(".jsPhoneConfirm").hide("slow"))},error:function(){b.applyFormState(a,{error:"Не удается подтвердить телефон."})}}),!1},confirmEmail:function(){var a=this,b=$(this.context).data().uiRegisterAuth;return $.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(c){c.error?b.applyFormState(a,{error:c.error.message}):c.status.isPhoneConfirmed?b._setState("setEnterprize"):(b.flushFormState(a),b.applyFormMessage(a,c.message),b.wrapper.find(".jsPhoneConfirm").hide("slow"))},error:function(){b.applyFormState(a,{error:"Не удается подтвердить email."})}}),!1},confirmPhoneRepeatCode:function(){var a=this,b=$(this.context).data().uiRegisterAuth;return $.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(c){c.error?b.applyFormState(a,{error:c.error.message}):b.applyFormState(a,{message:c.message})},error:function(){b.applyFormState(a,{error:"Не удается запросить код повторно."})}}),!1},confirmEmailRepeatCode:function(){var a=this,b=$(this.context).data().uiRegisterAuth;return $.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(c){c.error?b.applyFormState(a,{error:c.error.message}):b.applyFormState(a,{message:c.message})},error:function(){b.applyFormState(a,{error:"Не удается запросить письмо для подтверждения повторно."})}}),!1},confirmCheckState:function(){var a=this,b=$(this.context).data().uiRegisterAuth;return $.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(c){if(c.error)b.applyFormState(a,{error:c.error.message});else if(c.status.isPhoneConfirmed&&c.status.isEmailConfirmed)b._setState("setEnterprize");else{var d="";c.status.isPhoneConfirmed||(d+="Вы еще не подтвердили телефонный номер <br/>"),c.status.isEmailConfirmed||(d+="Вы еще не подтвердили email"),b.applyFormState(a,{message:d})}},error:function(){b.applyFormState(a,{error:"Извините, не удается подтвердить статус пользователя Enterprize"})}}),!1}}});