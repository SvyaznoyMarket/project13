!function(ENTER){var form=$(".jsEnterprizeForm"),body=$("body"),mobilePhoneField=$(".jsMobile"),authBlock=$("#enterprize-auth-block"),$slider=$(".js-slider"),validationConfig={fields:[{fieldNode:$(".jsName"),require:!0,customErr:"Не указано имя"},{fieldNode:mobilePhoneField,require:!0,validBy:"isPhone",customErr:"Не указан мобильный телефон"},{fieldNode:$(".jsEmail"),require:!0,validBy:"isEmail",customErr:"Не указан email"},{fieldNode:$(".jsAgree"),require:!0,customErr:"Необходимо согласие"},{fieldNode:$(".jsSubscribe"),require:!0,customErr:"Необходимо согласие"}]},validator=new FormValidator(validationConfig),signinValidationConfig={fields:[{fieldNode:$(".jsSigninUsername",authBlock),require:!0,customErr:"Не указан логин"},{fieldNode:$(".jsSigninPassword",authBlock),require:!0,customErr:"Не указан пароль"}]},signinValidator=new FormValidator(signinValidationConfig),forgotPwdValidationConfig={fields:[{fieldNode:$(".jsForgotPwdLogin",authBlock),require:!0,customErr:"Не указан email или мобильный телефон",validateOnChange:!0}]},forgotValidator=new FormValidator(forgotPwdValidationConfig),clearMsg=function(){$("ul.red, ul.green").html("")},showMsg=function(a,b){var c="undefined"!=typeof b?b:"error",d="error"===c?"red":"notice"===c?"green":null,e=$("ul."+d);if(d)return e.length?e.html("<li>"+a+"</li>"):form.prepend($('<ul class="'+d+'" />').append("<li>"+a+"</li>")),!1},formErrorHandler=function(a){var b=$('[name="user['+a.field+']"]'),c=function(){validator._unmarkFieldError($(this))};return validator._markFieldError(b,a.message),b.bind("focus",c),!1},serverErrorHandler=function(a){var b,c=null;for(b=a.form.error.length-1;b>=0;b--)c=a.form.error[b],c.message&&("global"===c.field?(showMsg(c.message),$(".js-global-error").html(c.message)):formErrorHandler(c));return!1},formSubmit=function(a){a.preventDefault();var b=$(this).serializeArray(),c=$(this).attr("action"),d=function(a){return a.error?(a.needAuth&&openAuth(),serverErrorHandler(a),!1):(void 0!==a.data.link?window.location.href=a.data.link:a.notice.message&&showMsg(a.notice.message,"notice"),!1)},e=function(a){var b=$(".js-ep-reg-form"),c=$(".js-ep-reg-complete"),d=c.find(".js-ep-reg-complete-text");return a.error?(a.needAuth&&openAuth(),serverErrorHandler(a),!1):(void 0!==a.data.link?window.location.href=a.data.link:a.notice.message&&d.html(a.notice.message),b.hide(),c.show(),!1)};return"new-form"==$(this).data("form")?$.post(c,b,e,"json"):$.post(c,b,d,"json"),clearMsg(),!1},epHintPopup=function(){var a=$(".js-ep-btn-hint-popup"),b=$(".js-ep-hint-popup"),c=b.find(".js-ep-hint-popup-close"),d=function(){return b.fadeIn(100),!1},e=function(){return b.fadeOut(100),!1};a.on("click",d),c.on("click",e)},openAuth=function(){ENTER.utils.signinValidationConfig=signinValidationConfig,ENTER.utils.signinValidator=signinValidator,ENTER.utils.forgotPwdValidationConfig=forgotPwdValidationConfig,ENTER.utils.forgotValidator=forgotValidator;var removeErrors=function(){var validators=["signin","forgot"],validator,config,self,i,j;for(j in validators)if(validators.hasOwnProperty(j)&&(validator=eval("ENTER.utils."+validators[j]+"Validator"),config=eval("ENTER.utils."+validators[j]+"ValidationConfig"),config&&config.fields&&validator))for(i in config.fields)config.fields.hasOwnProperty(i)&&(self=config.fields[i].fieldNode,self&&validator._unmarkFieldError(self))};return authBlock.lightbox_me({centered:!0,autofocus:!0,onLoad:function(){authBlock.find("input:first").focus()},onClose:removeErrors}),!1};$.mask.definitions.n="[0-9]",mobilePhoneField.length&&mobilePhoneField.mask("+7 (nnn) nnn-nn-nn"),body.on("submit",".jsEnterprizeForm",formSubmit),body.on("click",".jsEnterprizeAuthLink",openAuth),$slider.length&&$slider.goodsSlider(),body.on("click",".js-enterprize-coupon",function(){var a,b,c=$(this),d=$("#tplEnterprizeForm"),e=d.html(),f=$(".js-enterprize-coupon-hint"),g=c.data("column"),h="act",i=c.data("value");if(f.remove(),b=Mustache.render(e,i),c.hasClass(h)?(c.removeClass(h),f.remove()):($(".js-enterprize-coupon").removeClass(h),c.addClass(h),c.closest(".js-enterprize-coupon-parent").append(b),c.siblings(".js-enterprize-coupon-hint-holder").append(b),f=$(".js-enterprize-coupon-hint"),f.addClass(g),$(".js-phone-mask").each(function(){var a=$(this);$.mask.definitions.n="[0-9]",a.length&&a.mask("+7 (nnn) nnn-nn-nn")}),body.trigger("trackGooglePageview",["/enterprize/form/"+i.token])),a=$(".js-enterprize-slider-container"),i.slider.url){if(a.empty(),body.data("enterprizeSliderXhr"))try{body.data("enterprizeSliderXhr").abort()}catch(j){}var k=$.get(i.slider.url);k.done(function(b){b.content&&(a.removeClass("mLoader").html(b.content).find(".mLoader").removeClass("mLoader"),a.find(".js-slider").goodsSlider(),$slider.data("slider")&&0!=$slider.data("slider").count&&$(".js-ep-slides").show(500))}),k.always(function(){body.data("enterprizeSliderXhr",null)}),body.data("enterprizeSliderXhr",k)}else a.remove();$(".product-card-new .jsEnterprizeGetCouponForm").attr("target","_blank")}),body.on("click",".js-ep-hint-closer",function(a){a.preventDefault(),$(this).closest(".js-enterprize-coupon-hint").hide(),$(".js-enterprize-coupon").removeClass("act")}),body.on("click",".js-ep-rules-toggle",function(a){a.preventDefault(),$(".js-ep-rules-list").toggle()}),$(document).ready(function(){$(".epHintPopup").length&&epHintPopup("slow")}),body.on("click",".jsCouponRightIcon",function(){$(".js-enterprize-coupon-hint").toggle()}),$(".js-enterprize-coupon").each(function(a,b){var c=$(b).data("value");return c&&window.location.hash=="#"+c.token?(window.onload=function(){setTimeout(function(){$(b).trigger("click"),$.scrollTo(b)},10)},!1):void 0})}(window.ENTER),$.widget("ui.registerAuth",{availableStates:["authRegistration","update","confirm","setEnterprize"],wrapper:void 0,state:"authRegister",authRegistrationForm:"",options:{state:"authRegistration",wrapper:".jsBodyWrapper",beforeInit:function(a,b){return b(),a},afterInit:function(a){},beforeComplete:function(a,b){return b(),a},afterComplete:function(a){}},_create:function(){var a=this.options;this._state.widget=this,this.wrapper=this.element.find(a.wrapper),this.authRegistrationForm=this.wrapper.html(),this._setState(a.state)},init:function(a){var b=this;return a&&this._setState(a),this.options.beforeInit(this,function(){return b}).options.afterInit(this)},complete:function(){var a=this;return this.options.beforeComplete(this,function(){return a}).options.afterComplete(this),this},_setState:function(a){return this._state[a](),this.state=a,this},applyFormState:function(a,b){this.flushFormState(a),b.error&&this.applyFormErrorMessage(a,b.error),b.message&&this.applyFormMessage(a,b.message);for(k in b.fields)b.fields[k].error&&this.applyFieldError(a,k,b.fields[k].error);return this},applyFormErrors:function(a,b){var c={fields:{}};for(k in b)"global"!=b[k].field?c.fields[b[k].field]={error:b[k].message}:c.error=b[k].message;return this.applyFormState(a,c)},applyFieldError:function(a,b,c){var d=this;return a.find('[name*="'+b+'"]').before(d.getErrorString(c)).addClass("mError").end(),this},flushFormState:function(a){return a.find("input").removeClass("mError").end().find(".bErrorText").remove().end().find(".error_list").remove().end().find(".message").remove().end(),this},applyFormErrorMessage:function(a,b){return a.prepend('<ul class="error_list"><li>'+b+"</li></ul>"),this},applyFormMessage:function(a,b){return a.prepend('<p class="message" style="border: 1px solid #ffa901; padding: 2px 5px">'+b+"</p>"),this},applyMessage:function(a){return this.wrapper.prepend("<h2>"+a+"</h2>"),this},getErrorString:function(a){return'<div class="bErrorText"><div class="bErrorText__eInner">'+a+"</div>"},_state:{authRegistration:function(){"authRegistration"!=this.widget.state&&this.widget.wrapper.html(this.widget.authRegistrationForm);var a=this.widget.wrapper.find(".jsEnterprizeForm");a.off(),a.on("submit",$.proxy(this.widget._formHandler.registration,a)),$.mask.definitions.n="[0-9]",a.find(".jsMobile").mask("8nnnnnnnnnn");var a=this.widget.wrapper.find(".jsLoginForm");a.off(),a.on("submit",$.proxy(this.widget._formHandler.login,a))},update:function(){var a=this,b=function(a){var b=a.widget.wrapper.find(".jsEnterprizeForm");b.off(),b.on("submit",$.proxy(a.widget._formHandler.update,b))};"update"!=this.widget.state?$.get("/updateRegistration?body=1",function(c){"undefined"!=typeof c.error&&401==c.error?a.widget._setState("authRegistration"):(a.widget.wrapper.html(c.body),b(a))}):b(a)},confirm:function(){var a=this,b=function(a){var b=a.widget.wrapper.find(".jsConfirmEmailRepeatCode");b.length>0&&(b.off(),b.on("submit",$.proxy(a.widget._formHandler.confirmEmailRepeatCode,b)));var b=a.widget.wrapper.find(".jsConfirmPhone");b.length>0&&(b.off(),b.on("submit",$.proxy(a.widget._formHandler.confirmPhone,b)));var b=a.widget.wrapper.find(".jsConfirmPhoneRepeatCode");b.length>0&&(b.off(),b.on("submit",$.proxy(a.widget._formHandler.confirmPhoneRepeatCode,b)));var b=a.widget.wrapper.find(".jsCheckConfirmForm");b.length>0&&(b.off(),b.on("submit",$.proxy(a.widget._formHandler.confirmCheckState,b)))};"confirm"!=this.widget.state?$.ajax({url:"/enterprize/confirm-wc/form",success:function(c,d,e){"undefined"!=typeof c.error&&401==c.error.code?a.widget._setState("authRegistration"):(a.widget.wrapper.html(c.result.form),b(a))}}):b(a)},setEnterprize:function(){var a=this;$.ajax({url:"/enterprize/confirm-wc/setEnterprize",success:function(b,c,d){b.error&&401==b.error.code?a.widget._setState("authRegistration"):b.error?(a.widget.wrapper.html(""),a.widget.applyMessage(b.error.message)):(a.widget.wrapper.html(""),a.widget.applyMessage(b.result.message),window.setTimeout(function(){a.widget.complete()},5e3))}})}},_formHandler:{login:function(a){var b=this,c=$(this.context).data().uiRegisterAuth;return $.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(a){a.error?c.applyFormErrors(b,a.form.error):a.data.user.is_enterprize_member?c.complete():a.data.user.mobile_phone&&a.data.user.email?a.data.user.is_email_confirmed&&a.data.user.is_phone_confirmed?a.data.user.is_enterprize_member?a.alreadyLogged?c._setState("update"):c.applyFormState(b,{message:a.message}):c._setState("setEnterprize"):c._setState("confirm"):c._setState("update")},error:function(a,d,e){c.applyFormState(b,{error:"Не удается авторизоваться."})}}),!1},registration:function(a){var b=this,c=$(this.context).data().uiRegisterAuth;return $.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(a){a.success?c._setState(a.alreadyLogged?"update":"confirm"):c.applyFormState(b,a.form)},error:function(a,d,e){c.applyFormState(b,{error:"Не удается выполнить регистрацию."})}}),!1},update:function(a){var b=this,c=$(this.context).data().uiRegisterAuth;$.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(a){a.success?$.ajax({type:"POST",url:"/enterprize/confirm-wc/state",success:function(a){c._setState(a.status.isEmailConfirmed&&a.status.isPhoneConfirmed?"setEnterprize":"confirm")}}):c.applyFormState(b,a.form)},error:function(a,d,e){c.applyFormState(b,{error:"Не удается обновить данные."})}})},confirmPhone:function(a){var b=this,c=$(this.context).data().uiRegisterAuth;return $.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(a){a.error?c.applyFormState(b,{error:a.error.message}):a.status&&a.status.isEmailConfirmed?c._setState("setEnterprize"):(c.flushFormState(b),c.applyFormMessage(b,a.message),c.wrapper.find(".jsPhoneConfirm").hide("slow"))},error:function(a,d,e){c.applyFormState(b,{error:"Не удается подтвердить телефон."})}}),!1},confirmEmail:function(a){var b=this,c=$(this.context).data().uiRegisterAuth;return $.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(a){a.error?c.applyFormState(b,{error:a.error.message}):a.status.isPhoneConfirmed?c._setState("setEnterprize"):(c.flushFormState(b),c.applyFormMessage(b,a.message),c.wrapper.find(".jsPhoneConfirm").hide("slow"))},error:function(a,d,e){c.applyFormState(b,{error:"Не удается подтвердить email."})}}),!1},confirmPhoneRepeatCode:function(a){var b=this,c=$(this.context).data().uiRegisterAuth;return $.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(a){a.error?c.applyFormState(b,{error:a.error.message}):c.applyFormState(b,{message:a.message})},error:function(a,d,e){c.applyFormState(b,{error:"Не удается запросить код повторно."})}}),!1},confirmEmailRepeatCode:function(a){var b=this,c=$(this.context).data().uiRegisterAuth;return $.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(a){a.error?c.applyFormState(b,{error:a.error.message}):c.applyFormState(b,{message:a.message})},error:function(a,d,e){c.applyFormState(b,{error:"Не удается запросить письмо для подтверждения повторно."})}}),!1},confirmCheckState:function(a){var b=this,c=$(this.context).data().uiRegisterAuth;return $.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(a){if(a.error)c.applyFormState(b,{error:a.error.message});else if(a.status.isPhoneConfirmed&&a.status.isEmailConfirmed)c._setState("setEnterprize");else{var d="";a.status.isPhoneConfirmed||(d+="Вы еще не подтвердили телефонный номер <br/>"),a.status.isEmailConfirmed||(d+="Вы еще не подтвердили email"),c.applyFormState(b,{message:d})}},error:function(a,d,e){c.applyFormState(b,{error:"Извините, не удается подтвердить статус пользователя Enterprize"})}}),!1}}});