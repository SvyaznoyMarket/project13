!function(ENTER){var form=$(".jsEnterprizeForm"),body=$("body"),mobilePhoneField=$(".jsMobile"),authBlock=$("#enterprize-auth-block"),validationConfig={fields:[{fieldNode:$(".jsName"),require:!0,customErr:"Не указано имя"},{fieldNode:mobilePhoneField,require:!0,validBy:"isPhone",customErr:"Не указан мобильный телефон"},{fieldNode:$(".jsEmail"),require:!0,validBy:"isEmail",customErr:"Не указан email"},{fieldNode:$(".jsAgree"),require:!0,customErr:"Необходимо согласие"},{fieldNode:$(".jsSubscribe"),require:!0,customErr:"Необходимо согласие"}]},validator=new FormValidator(validationConfig),signinValidationConfig={fields:[{fieldNode:$(".jsSigninUsername",authBlock),require:!0,customErr:"Не указан логин"},{fieldNode:$(".jsSigninPassword",authBlock),require:!0,customErr:"Не указан пароль"}]},signinValidator=new FormValidator(signinValidationConfig),forgotPwdValidationConfig={fields:[{fieldNode:$(".jsForgotPwdLogin",authBlock),require:!0,customErr:"Не указан email или мобильный телефон",validateOnChange:!0}]},forgotValidator=new FormValidator(forgotPwdValidationConfig),clearMsg=function(){$("ul.red").length&&$("ul.red").html(""),$("ul.green").length&&$("ul.green").html("")},showMsg=function(a,b){var b=b?b:"error",c="error"===b?"red":"notice"===b?"green":null,d=$("ul."+c);if(c)return d.length?d.html("<li>"+a+"</li>"):form.prepend($('<ul class="'+c+'" />').append("<li>"+a+"</li>")),!1},formErrorHandler=function(a){var b=$('[name="user['+a.field+']"]'),c=function(){validator._unmarkFieldError($(this))};return validator._markFieldError(b,a.message),b.bind("focus",c),!1},serverErrorHandler=function(a){var b,c=null;for(b=a.form.error.length-1;b>=0;b--)c=a.form.error[b],c.message&&("global"===c.field?showMsg(c.message):formErrorHandler(c));return!1},formSubmit=function(a){a.preventDefault();var b=$(this).serializeArray(),c=$(this).attr("action"),d=function(a){return a.error?(a.needAuth&&openAuth(),serverErrorHandler(a)):void 0!==a.data.link?window.location.href=a.data.link:a.notice.message&&showMsg(a.notice.message,"notice"),!1};return $.post(c,b,d,"json"),clearMsg(),!1},epHintPopup=function(){var a=$(".js-ep-btn-hint-popup"),b=$(".js-ep-hint-popup"),c=b.find(".js-ep-hint-popup-close"),d=function(){return b.fadeIn(100),!1},e=function(){return b.fadeOut(100),!1};a.on("click",d),c.on("click",e)},openAuth=function(){ENTER.utils.signinValidationConfig=signinValidationConfig,ENTER.utils.signinValidator=signinValidator,ENTER.utils.forgotPwdValidationConfig=forgotPwdValidationConfig,ENTER.utils.forgotValidator=forgotValidator;var removeErrors=function(){var validators=["signin","forgot"],validator,config,self,i,j;for(j in validators)if(validator=eval("ENTER.utils."+validators[j]+"Validator"),config=eval("ENTER.utils."+validators[j]+"ValidationConfig"),config&&config.fields&&validator)for(i in config.fields)self=config.fields[i].fieldNode,self&&validator._unmarkFieldError(self)};return authBlock.lightbox_me({centered:!0,autofocus:!0,onLoad:function(){authBlock.find("input:first").focus()},onClose:removeErrors}),!1};$.mask.definitions.n="[0-9]",mobilePhoneField.length&&mobilePhoneField.mask("8nnnnnnnnnn"),body.on("submit",".jsEnterprizeForm",formSubmit),body.on("click",".jsEnterprizeAuthLink",openAuth),$(".bGoodsSlider").length&&$(".bGoodsSlider").goodsSlider(),$(document).ready(function(){$(".epHintPopup").length&&epHintPopup()})}(window.ENTER),$.widget("ui.registerAuth",{availableStates:["authRegistration","update","confirm","setEnterprize"],wrapper:void 0,state:"authRegister",authRegistrationForm:"",options:{state:"authRegistration",wrapper:".jsBodyWrapper",beforeInit:function(a,b){return b(),a},afterInit:function(){},beforeComplete:function(a,b){return b(),a},afterComplete:function(){}},_create:function(){var a=this.options;this._state.widget=this,this.wrapper=this.element.find(a.wrapper),this.authRegistrationForm=this.wrapper.html(),this._setState(a.state)},init:function(a){var b=this;return a&&this._setState(a),this.options.beforeInit(this,function(){return b}).options.afterInit(this)},complete:function(){var a=this;return this.options.beforeComplete(this,function(){return a}).options.afterComplete(this),this},destroy:function(){},_setState:function(a){return this._state[a](),this.state=a,this},applyFormState:function(a,b){b.fields.global.error&&this.applyFormErrorMessage(a,b.fields.global.error);for(k in b.fields)"global"!=k&&b.fields[k].error&&this.applyFieldError(a,k,b.fields[k].error);return this},applyFormErrors:function(a,b){var c={fields:{}};for(k in b)c.fields[b[k].field]={error:b[k].message};return this.applyFormState(a,c)},getErrorString:function(a){return'<div class="bErrorText"><div class="bErrorText__eInner">'+a+"</div>"},applyFieldError:function(){},applyFormErrorMessage:function(a,b){return $(a).prepend('<ul class="error_list"><li>'+b+"</li></ul>"),this},_state:{authRegistration:function(){"authRegistration"!=this.widget.state&&this.widget.wrapper.html(this.widget.authRegistrationForm);var a=this.widget.wrapper.find(".jsEnterprizeForm");a.off(),a.on("submit",$.proxy(this.widget._formHandler.registration,a));var a=this.widget.wrapper.find(".jsLoginForm");a.off(),a.on("submit",$.proxy(this.widget._formHandler.login,a))},update:function(){var a=this,b=function(a){var b=a.widget.wrapper.find(".jsEnterprizeForm");b.off(),b.on("submit",$.proxy(a.widget._formHandler.update,b))};"update"!=this.widget.state?$.get("/updateRegistration?body=1",function(c){"undefined"!=typeof c.error&&301==c.error?a.widget._setState("authRegistration"):(a.widget.wrapper.html(c.body),b(a))}):b(a)},confirm:function(){var a=this,b=function(a){var b=a.widget.wrapper.find(".jsConfirmEmail");b.off(),b.on("submit",$.proxy(a.widget._formHandler.confirmEmail,b));var b=a.widget.wrapper.find(".jsConfirmEmailRepeatCode");b.off(),b.on("submit",$.proxy(a.widget._formHandler.confirmEmailRepeatCode,b));var b=a.widget.wrapper.find(".jsConfirmPhone");b.off(),b.on("submit",$.proxy(a.widget._formHandler.confirmPhone,b));var b=a.widget.wrapper.find(".jsConfirmPhoneRepeatCode");b.off(),b.on("submit",$.proxy(a.widget._formHandler.confirmPhoneRepeatCode,b))};"confirm"!=this.widget.state?$.ajax({url:"/enterprize/confirm-wc/form",success:function(c){"undefined"!=typeof c.error&&301==c.error.code?a.widget._setState("authRegistration"):(a.widget.wrapper.html(c),b(a))}}):b(a)},setEnterprize:function(){var a=this;$.ajax({url:"/enterprize/confirm-wc/setEnterprize",success:function(b){"undefined"!=typeof b.error&&301==b.error.code&&a.widget._setState("authRegistration")}})}},_formHandler:{login:function(){var a=this,b=$(this.context).data().uiRegisterAuth;return $.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(c){c.error?b.applyFormErrors(a,c.form.error):c.alreadyLogged?b._setState("update"):c.data.user.is_enterprize_member?b.complete():b._setState(c.data.user.mobile_phone&&c.data.user.email?"confirm":"update")},error:function(){b.applyFormState(a,{global:"Не удается авторизоваться."})}}),!1},registration:function(){var a=$(this.context).data().uiRegisterAuth;return $.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(b){b.success?a._setState(b.alreadyLogged?"update":"confirm"):a.applyFormState(this,b.form)},error:function(){a.applyFormState(this,{global:"Не удается выполнить регистрацию."})}}),!1},update:function(){var a=$(this.context).data().uiRegisterAuth;$.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(b){b.success?a._setState("confirm"):a.applyFormState(this,b.form)},error:function(){a.applyFormState(this,{global:"Не удается обновить данные."})}})},confirmPhone:function(){var a=$(this.context).data().uiRegisterAuth;return $.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(){},error:function(){a.applyFormState(this,{global:"Не удается подтвердить телефон."})}}),!1},confirmPhoneRepeatCode:function(){$(this.context).data().uiRegisterAuth;return!1},confirmEmail:function(){var a=$(this.context).data().uiRegisterAuth;return $.ajax({type:"POST",url:this.attr("action"),data:this.serializeArray(),success:function(b){b.error&&a.applyFormState(this,{error:{global:b.error.code}})},error:function(){a.applyFormState(this,{global:"Не удается подтвердить email."})}}),!1},confirmEmailRepeatCode:function(){$(this.context).data().uiRegisterAuth;return!1}}});