(function(ENTER){var form=$(".jsEnterprizeForm"),body=$("body"),mobilePhoneField=$(".jsMobile"),authBlock=$("#enterprize-auth-block"),validationConfig={fields:[{fieldNode:$(".jsName"),require:!0,customErr:"Не указано имя"},{fieldNode:mobilePhoneField,require:!0,validBy:"isPhone",customErr:"Не указан мобильный телефон"},{fieldNode:$(".jsEmail"),require:!0,validBy:"isEmail",customErr:"Не указан email"},{fieldNode:$(".jsAgree"),require:!0,customErr:"Необходимо согласие"},{fieldNode:$(".jsSubscribe"),require:!0,customErr:"Необходимо согласие"}]},validator=new FormValidator(validationConfig),signinValidationConfig={fields:[{fieldNode:$(".jsSigninUsername",authBlock),require:!0,customErr:"Не указан логин"},{fieldNode:$(".jsSigninPassword",authBlock),require:!0,customErr:"Не указан пароль"}]},signinValidator=new FormValidator(signinValidationConfig),forgotPwdValidationConfig={fields:[{fieldNode:$(".jsForgotPwdLogin",authBlock),require:!0,customErr:"Не указан email или мобильный телефон",validateOnChange:!0}]},forgotValidator=new FormValidator(forgotPwdValidationConfig),clearMsg=function clearMsg(){$("ul.red").length&&$("ul.red").html(""),$("ul.green").length&&$("ul.green").html("")},showMsg=function showMsg(e,t){var t=t?t:"error",r="error"===t?"red":"notice"===t?"green":null,i=$("ul."+r);if(r)return i.length?i.html("<li>"+e+"</li>"):form.prepend($('<ul class="'+r+'" />').append("<li>"+e+"</li>")),!1},formErrorHandler=function formErrorHandler(e){var t=$('[name="user['+e.field+']"]'),r=function r(){validator._unmarkFieldError($(this))};return console.warn("Ошибка в поле"),validator._markFieldError(t,e.message),t.bind("focus",r),!1},serverErrorHandler=function serverErrorHandler(e){var t,r=null;for(console.warn("Обработка ошибок формы"),t=e.form.error.length-1;t>=0;t--)r=e.form.error[t],r.message&&(console.warn(r),"global"===r.field?showMsg(r.message):formErrorHandler(r));return!1},formSubmit=function formSubmit(e){e.preventDefault();var t=$(this).serializeArray(),r=$(this).attr("action"),i=function i(e){return e.error?(e.needAuth&&openAuth(),console.warn("Form has error"),serverErrorHandler(e)):void 0!==e.data.link?window.location.href=e.data.link:e.notice.message&&showMsg(e.notice.message,"notice"),!1};return $.post(r,t,i,"json"),clearMsg(),!1},openAuth=function(){ENTER.utils.signinValidationConfig=signinValidationConfig,ENTER.utils.signinValidator=signinValidator,ENTER.utils.forgotPwdValidationConfig=forgotPwdValidationConfig,ENTER.utils.forgotValidator=forgotValidator;var removeErrors=function(){var validators=["signin","forgot"],validator,config,self,i,j;for(j in validators)if(validator=eval("ENTER.utils."+validators[j]+"Validator"),config=eval("ENTER.utils."+validators[j]+"ValidationConfig"),config&&config.fields&&validator)for(i in config.fields)self=config.fields[i].fieldNode,self&&validator._unmarkFieldError(self)};return authBlock.lightbox_me({centered:!0,autofocus:!0,onLoad:function(){authBlock.find("input:first").focus()},onClose:removeErrors}),!1},userLoggedHandler=function(e,t){t&&$(".jsCompleteTitleEP").length&&void 0!==t.hasEnterprizeCoupon&&t.hasEnterprizeCoupon&&$(".jsCompleteTitleEP").hide()};$.mask.definitions.n="[0-9]",mobilePhoneField.length&&mobilePhoneField.mask("8nnnnnnnnnn"),body.on("submit",".jsEnterprizeForm",formSubmit),body.on("click",".jsEnterprizeAuthLink",openAuth),body.on("userLogged",userLoggedHandler)})(window.ENTER);