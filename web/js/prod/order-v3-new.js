
;(function(w){w.ENTER.OrderV3={info:{},constructors:{},map:{},mapOptions:{},$map:{},kladrCityId:0};}(window));
(function(root,factory){if(typeof exports=='object')module.exports=factory()
else if(typeof define=='function'&&define.amd)define(factory)
else root.Spinner=factory()}
(this,function(){"use strict";var prefixes=['webkit','Moz','ms','O'],animations={},useCssAnimations
function createEl(tag,prop){var el=document.createElement(tag||'div'),n
for(n in prop)el[n]=prop[n]
return el}
function ins(parent){for(var i=1,n=arguments.length;i<n;i++)
parent.appendChild(arguments[i])
return parent}
var sheet=(function(){var el=createEl('style',{type:'text/css'})
ins(document.getElementsByTagName('head')[0],el)
return el.sheet||el.styleSheet}())
function addAnimation(alpha,trail,i,lines){var name=['opacity',trail,~~(alpha*100),i,lines].join('-'),start=0.01+i/lines*100,z=Math.max(1-(1-alpha)/trail*(100-start),alpha),prefix=useCssAnimations.substring(0,useCssAnimations.indexOf('Animation')).toLowerCase(),pre=prefix&&'-'+prefix+'-'||''
if(!animations[name]){sheet.insertRule('@'+pre+'keyframes '+name+'{'+'0%{opacity:'+z+'}'+
start+'%{opacity:'+alpha+'}'+
(start+0.01)+'%{opacity:1}'+
(start+trail)%100+'%{opacity:'+alpha+'}'+'100%{opacity:'+z+'}'+'}',sheet.cssRules.length)
animations[name]=1}
return name}
function vendor(el,prop){var s=el.style,pp,i
prop=prop.charAt(0).toUpperCase()+prop.slice(1)
for(i=0;i<prefixes.length;i++){pp=prefixes[i]+prop
if(s[pp]!==undefined)return pp}
if(s[prop]!==undefined)return prop}
function css(el,prop){for(var n in prop)
el.style[vendor(el,n)||n]=prop[n]
return el}
function merge(obj){for(var i=1;i<arguments.length;i++){var def=arguments[i]
for(var n in def)
if(obj[n]===undefined)obj[n]=def[n]}
return obj}
function pos(el){var o={x:el.offsetLeft,y:el.offsetTop}
while((el=el.offsetParent))
o.x+=el.offsetLeft,o.y+=el.offsetTop
return o}
function getColor(color,idx){return typeof color=='string'?color:color[idx%color.length]}
var defaults={lines:12,length:7,width:5,radius:10,rotate:0,corners:1,color:'#000',direction:1,speed:1,trail:100,opacity:1/4,fps:20,zIndex:2e9,className:'spinner',top:'50%',left:'50%',position:'absolute'}
function Spinner(o){this.opts=merge(o||{},Spinner.defaults,defaults)}
Spinner.defaults={}
merge(Spinner.prototype,{spin:function(target){this.stop()
var self=this,o=self.opts,el=self.el=css(createEl(0,{className:o.className}),{position:o.position,width:0,zIndex:o.zIndex}),mid=o.radius+o.length+o.width
css(el,{left:o.left,top:o.top})
if(target){target.insertBefore(el,target.firstChild||null)}
el.setAttribute('role','progressbar')
self.lines(el,self.opts)
if(!useCssAnimations){var i=0,start=(o.lines-1)*(1-o.direction)/2,alpha,fps=o.fps,f=fps/o.speed,ostep=(1-o.opacity)/(f*o.trail/100),astep=f/o.lines;(function anim(){i++;for(var j=0;j<o.lines;j++){alpha=Math.max(1-(i+(o.lines-j)*astep)%f*ostep,o.opacity)
self.opacity(el,j*o.direction+start,alpha,o)}
self.timeout=self.el&&setTimeout(anim,~~(1000/fps))})()}
return self},stop:function(){var el=this.el
if(el){clearTimeout(this.timeout)
if(el.parentNode)el.parentNode.removeChild(el)
this.el=undefined}
return this},lines:function(el,o){var i=0,start=(o.lines-1)*(1-o.direction)/2,seg
function fill(color,shadow){return css(createEl(),{position:'absolute',width:(o.length+o.width)+'px',height:o.width+'px',background:color,boxShadow:shadow,transformOrigin:'left',transform:'rotate('+~~(360/o.lines*i+o.rotate)+'deg) translate('+o.radius+'px'+',0)',borderRadius:(o.corners*o.width>>1)+'px'})}
for(;i<o.lines;i++){seg=css(createEl(),{position:'absolute',top:1+~(o.width/2)+'px',transform:o.hwaccel?'translate3d(0,0,0)':'',opacity:o.opacity,animation:useCssAnimations&&addAnimation(o.opacity,o.trail,start+i*o.direction,o.lines)+' '+1/o.speed+'s linear infinite'})
if(o.shadow)ins(seg,css(fill('#000','0 0 4px '+'#000'),{top:2+'px'}))
ins(el,ins(seg,fill(getColor(o.color,i),'0 0 1px rgba(0,0,0,.1)')))}
return el},opacity:function(el,i,val){if(i<el.childNodes.length)el.childNodes[i].style.opacity=val}})
function initVML(){function vml(tag,attr){return createEl('<'+tag+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',attr)}
sheet.addRule('.spin-vml','behavior:url(#default#VML)')
Spinner.prototype.lines=function(el,o){var r=o.length+o.width,s=2*r
function grp(){return css(vml('group',{coordsize:s+' '+s,coordorigin:-r+' '+-r}),{width:s,height:s})}
var margin=-(o.width+o.length)*2+'px',g=css(grp(),{position:'absolute',top:margin,left:margin}),i
function seg(i,dx,filter){ins(g,ins(css(grp(),{rotation:360/o.lines*i+'deg',left:~~dx}),ins(css(vml('roundrect',{arcsize:o.corners}),{width:r,height:o.width,left:o.radius,top:-o.width>>1,filter:filter}),vml('fill',{color:getColor(o.color,i),opacity:o.opacity}),vml('stroke',{opacity:0}))))}
if(o.shadow)
for(i=1;i<=o.lines;i++)
seg(i,-2,'progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)')
for(i=1;i<=o.lines;i++)seg(i)
return ins(el,g)}
Spinner.prototype.opacity=function(el,i,val,o){var c=el.firstChild
o=o.shadow&&o.lines||0
if(c&&i+o<c.childNodes.length){c=c.childNodes[i+o];c=c&&c.firstChild;c=c&&c.firstChild
if(c)c.opacity=val}}}
var probe=css(createEl('group'),{behavior:'url(#default#VML)'})
if(!vendor(probe,'transform')&&probe.adj)initVML()
else useCssAnimations=vendor(probe,'animation')
return Spinner}));
;(function($){var body=$(document.body),_gaq=window._gaq,region=$('.jsRegion').data('value'),sendAnalytic=function sendAnalyticF(category,action,label,value){var lbl=label||'',act=action||'';if(category&&category.data){if(category.data.step)act=category.data.step;if(category.data.action)lbl=category.data.action;}
if(typeof ga==='undefined')ga=window[window['GoogleAnalyticsObject']];if(typeof _gaq==='object')_gaq.push(['_trackEvent','Воронка_новая_v2_'+region,act,lbl]);if(typeof ga==='function')ga('send','event','Воронка_новая_v2_'+region,act,lbl);if(typeof ga!=='function')console.warn('Нет объекта ga');if(typeof ga==='function'&&typeof ga.getAll=='function'&&ga.getAll().length==0)console.warn('Не установлен трекер для ga');console.log('[Google Analytics] Send event: category: "Воронка_новая_v2_%s", action: "%s", label: "%s"',region,act,lbl);};body.on('trackUserAction.orderV3Tracking',sendAnalytic);if(typeof ga==='function'&&typeof ga.getAll=='function'&&ga.getAll().length==0){ga('create','UA-25485956-5','enter.ru');}})(jQuery);
;(function($){var $orderContent=$('#js-order-content');$orderContent.on('click','.orderCol_data-count',function(e){var $this=$(this);e.stopPropagation();$this.hide().siblings('.orderCol_data-summ, .orderCol_data-price').hide();$this.siblings('.orderCol_data-edit').show();});$orderContent.on('click','.bCountSection__eP, .bCountSection__eM',function(e){var $this=$(this),$input=$this.siblings('input'),stock=parseInt($input.data('stock'),10),quantity=parseInt($input.val(),10);if($this.hasClass('bCountSection__eP')){if(stock>quantity)$input.val(quantity+1);}
if($this.hasClass('bCountSection__eM')){if(quantity>1)$input.val(quantity-1);}
e.preventDefault();e.stopPropagation();});$orderContent.on('change','.bCountSection__eNum',function(e){e.stopPropagation();});function _counter(){}
window.ENTER.OrderV3.constructors.counter=_counter;}(jQuery));
;(function(w,ko,$){var address,initialAddressData=$('#jsUserAddress').data('value'),kladrConfig=$('#kladr-config').data('value'),region=$('#page-config').data('value').user.region;function AddressModel(){var self=this,streetTypeDefault='Улица';self.streetShortToLong={'пр-кт':'Проспект','ш':'Шоссе','ул.':'Улица','ул':'Улица','пер':'Переулок','пл':'Площадь','дор':'Дорога'};self.cityName=ko.observable('');self.cityId=ko.observable(0);self.streetName=ko.observable('');self.streetType=ko.observable(streetTypeDefault);self.streetTypeShort=ko.observable('');self.streetId=ko.observable(0);self.buildingName=ko.observable('');self.buildingId=ko.observable(0);self.apartmentName=ko.observable('');self.inputFocus=ko.observable(true);self.inputPrefix=ko.computed(function(){if(self.streetName()=='')return'Улица:';else if(self.buildingName()=='')return'дом:';else return'квартира:';});self.getParent=function(){var result=false;if(self.cityId()!=0&&self.inputPrefix()=='Улица:')result={type:$.kladr.type.street,parentType:'city',parentId:self.cityId()};else if(self.streetId()!=0&&self.inputPrefix()=='дом:')result={type:$.kladr.type.building,parentType:'street',parentId:self.streetId()};return result;};self.update=function(val){if(typeof val=='string'){if(self.streetName()==''){self.streetName(val);self.streetTypeShort('');}
else if(self.buildingName()=='')self.buildingName(val);else if(self.apartmentName()=='')self.apartmentName(val);}
else if(typeof val=='object'){if(val.contentType=='street'){self.streetName(val.name).streetId(val.id).streetType(val.type).streetTypeShort(val.typeShort)}
else if(val.contentType=='building'){self.buildingName(val.name).buildingId(val.id)}}};self.clearCity=function(){self.cityName('').cityId(0);return self};self.clearStreet=function(){self.streetName('').streetType(streetTypeDefault).streetId(0);return self};self.clearBuilding=function(){self.buildingName('').buildingId(0);return self};self.clearApartment=function(){self.apartmentName('');return self};return self;}
function saveAddress(address){if(address.streetName()=='')return;$.ajax({type:'POST',data:{'action':'changeAddress','params':{street:address.streetName()+' '+(address.streetTypeShort()==''?address.streetType():address.streetTypeShort()),building:address.buildingName(),apartment:address.apartmentName(),kladr_id:address.buildingId()!=0?address.buildingId():address.streetId()!=0?address.streetId():address.cityId()!=0?address.cityId():''}}}).fail(function(jqXHR){var response=$.parseJSON(jqXHR.responseText);if(response.result){console.error(response.result);}}).done(function(data){console.log("Saved address:",data.result.OrderDeliveryModel.user_info.address);})}
function autoCompleteRequest(request,response){if(address.getParent()!==false){var query=$.extend({},{limit:10,name:request.term},address.getParent());console.log('[КЛАДР] запрос: ',query);$.kladr.api(query,function(data){console.log('[КЛАДР] ответ',data);response($.map(data,function(elem){return{label:formatStreetName(elem),value:elem}}))});}}
function formatStreetName(elem){var name=elem.name,typeShort=elem.typeShort,dot='';if($.inArray(typeShort,['ул','пер','пл','дор'])!=-1)dot='.';if(elem.contentType==='street'){return name+' '+typeShort+dot;}else{return name;}}
ENTER.OrderV3.constructors.smartAddressInit=function(){var $input=$('.jsSmartAddressInput'),initKladrQuery=$.extend(kladrConfig,{'limit':1,type:$.kladr.type.city,name:region.name});$input.autocomplete({source:autoCompleteRequest,minLength:1,open:function(event,ui){$('.ui-autocomplete').css({'position':'absolute','top':29,'left':0});},select:function(event,ui){this.value='';$input.val('');address.update(ui.item.value);return false;},focus:function(event,ui){this.value=ui.item.label;event.preventDefault();event.stopPropagation();},change:function(event,ui){},messages:{noResults:'',results:function(){}}});$input.on({keypress:function(e){if(e.which==13){if($(this).val().length>0){address.update($(this).val());$input.val('');$input.autocomplete('close');}}},keydown:function(e){var key=e.keyCode||e.charCode;if(key===8&&$(this).val().length===0){if(address.inputPrefix()=='дом:'){$input.val(address.streetName());address.clearBuilding().clearStreet();}
if(address.inputPrefix()=='квартира:'){$input.val(address.buildingName());address.clearApartment().clearBuilding();}
e.preventDefault();}},blur:function(){address.update($(this).val());$input.val('');saveAddress(address);}});$('.jsSmartAddressEditField').on('click',function(){var dataType=$(this).data('type');if(dataType&&typeof address[dataType]=='function'){$input.val(address[dataType]());if(dataType=='apartmentName')address.clearApartment();if(dataType=='buildingName')address.clearBuilding().clearApartment();if(dataType=='streetName'){address.clearStreet().clearBuilding().clearApartment();if(address.streetTypeShort()!='')$input.val($input.val()+' '+address.streetTypeShort());}}});if(region.kladrId){address.cityId(region.kladrId)}else if(kladrConfig&&region.name){$.kladr.api(initKladrQuery,function(data){var id=data.length>0?data[0].id:0;if(id==0)console.error('КЛАДР не определил город, конфигурация запроса: ',initKladrQuery);else address.cityId(data[0].id);})}};address=new AddressModel();if(typeof initialAddressData=='object'){if(initialAddressData.street){var regexResult=initialAddressData.street.match(/(.+)\s+(.+)$/);if(regexResult){if(address.streetShortToLong.hasOwnProperty(regexResult[2])){address.streetType(address.streetShortToLong[regexResult[2]]);address.streetTypeShort(regexResult[2]);}else{address.streetType(regexResult[2]);}
address.streetName(regexResult[1]);}}
if(initialAddressData.building)address.buildingName(initialAddressData.building);if(initialAddressData.apartment)address.apartmentName(initialAddressData.apartment);}
$.each($('.jsAddressRootNode'),function(i,val){console.log(val)
ko.applyBindings(address,val);});ENTER.OrderV3.address=address;ENTER.OrderV3.constructors.smartAddressInit();}(window,ko,jQuery));
(function($){var E=ENTER.OrderV3,$mapContainer=$('#yandex-map-container');var init=function(){var options=$mapContainer.data('options');E.map=new ymaps.Map("yandex-map-container",{center:[options.latitude,options.longitude],zoom:options.zoom},{autoFitToViewport:'always'});E.map.controls.remove('searchControl');E.mapOptions=options;E.$map=$mapContainer;E.koModels=[];E.map.events.add('boundschange',function(event){var bounds;if(event.get('newBounds')){bounds=event.get('target').getBounds();$.each(E.koModels,function(i,val){val.latitudeMin(bounds[0][0]);val.latitudeMax(bounds[1][0]);val.longitudeMin(bounds[0][1]);val.longitudeMax(bounds[1][1]);});}});$.each($('.jsNewPoints'),function(i,val){var pointData=JSON.parse($(this).find('script.jsMapData').html()),points=new ENTER.DeliveryPoints(pointData.points,E.map);E.koModels.push(points);ko.applyBindings(points,val);})};if($mapContainer.length)ymaps.ready(init);})(jQuery);
;(function($){var body=document.getElementsByTagName('body')[0],$body=$(body),$orderContent=$('.orderCnt'),$jsOrder=$('#jsOrder'),region=$('.jsRegion').data('value'),isOnlineMotivPage=$('.jsNewOnlineCompletePage').length>0,spinner=typeof Spinner=='function'?new Spinner({lines:11,length:5,width:8,radius:23,corners:1,rotate:0,direction:1,color:'#666',speed:1,trail:62,shadow:false,hwaccel:true,className:'spinner',zIndex:2e9,top:'50%',left:'50%'}):null,getForm=function getFormF(methodId,orderId,orderNumber,action){var data={'method':methodId,'order':orderId,'number':orderNumber};if(typeof action!=='undefined'&&action!='')data.action=action;$.ajax({'url':'getPaymentForm','type':'POST','data':data,'success':function(data){var $form;if(data.form!=''){$form=$(data.form);if(spinner)spinner.spin(body);if($form.hasClass('jsPaymentFormPaypal')&&typeof $form.attr('action')!='undefined'){window.location.href=$form.attr('action');}else{$body.append($form);$form.submit();}}
console.log('Payment data',data);}})},showCreditWidget=function showCreditWidgetF(bankProviderId,data,number_erp,bank_id){if(bankProviderId==1)showKupiVKredit(data['kupivkredit']);if(bankProviderId==2)showDirectCredit(data['direct-credit']);$.ajax({type:'POST',url:'/order/update-credit',data:{number_erp:number_erp,bank_id:bank_id}});if(bank_id==1)$body.trigger('trackGoogleEvent',['Воронка_новая_v2_'+region,'19_1 Заявка_кредит_Оплата','Тинькофф']);if(bank_id==2)$body.trigger('trackGoogleEvent',['Воронка_новая_v2_'+region,'19_1 Заявка_кредит_Оплата','Ренесанс']);if(bank_id==3)$body.trigger('trackGoogleEvent',['Воронка_новая_v2_'+region,'19_1 Заявка_кредит_Оплата','ОТП-Банк']);},showKupiVKredit=function showKupiVKreditF(data){var callback_close=function(decision){},callback_decision=function(decision){},vkredit;console.log(data);$LAB.script('//www.kupivkredit.ru/widget/vkredit.js').wait(function(){vkredit=new VkreditWidget(1,data.vars.sum,{order:data.vars.order,sig:data.vars.sig,callbackUrl:window.location.href,onClose:callback_close,onDecision:callback_decision});vkredit.openWidget();});},showDirectCredit=function showDirectCreditF(data){var productArr=[];$LAB.script('//api.direct-credit.ru/JsHttpRequest.js').script('//api.direct-credit.ru/dc.js').wait(function(){console.info('скрипты загружены для кредитного виджета. начинаем обработку');$.each(data.vars.items,function(index,elem){productArr.push({id:elem.articul,name:elem.name,price:elem.price,type:elem.type,count:elem.quantity})});DCLoans(data.vars.partnerID,'getCredit',{products:productArr,order:data.vars.number,codeTT:data.vars.region},function(result){console.log(result);},false);});};$orderContent.on('click','.jsPaymentMethod',function(e){var id=$(this).data('value'),$order=$(this).closest('.orderLn').length>0?$(this).closest('.orderLn'):$orderContent,orderId=$order.data('order-id'),orderNumber=$order.data('order-number'),action=$order.data('order-action');e.preventDefault();switch(id){case 5:getForm(5,orderId,orderNumber,action);$body.trigger('trackGoogleEvent',['Воронка_новая_v2_'+region,'17_1 Оплатить_онлайн_Оплата','Онлайн-оплата']);break;case 8:getForm(8,orderId,orderNumber,action);$body.trigger('trackGoogleEvent',['Воронка_новая_v2_'+region,'17_1 Оплатить_онлайн_Оплата','Psb']);break;case 13:getForm(13,orderId,orderNumber,action);$body.trigger('trackGoogleEvent',['Воронка_новая_v2_'+region,'17_1 Оплатить_онлайн_Оплата','PayPal']);break;case 14:getForm(14,orderId,orderNumber,action);$body.trigger('trackUserAction',['17_1 Оплатить_онлайн_Связной_клуб_баллы']);break;}});$orderContent.on('click','.jsOnlinePaymentPossible',function(){$(this).find('.jsOnlinePaymentDiscount').hide();$orderContent.find('.jsOnlinePaymentDiscountPayNow').show();$body.trigger('trackGoogleEvent',['Воронка_новая_v2_'+region,'17 Оплатить_онлайн_вход_Оплата']);});$orderContent.on('click','.jsOnlinePaymentPossibleNoMotiv',function(){var $blocks=$('.jsOnlinePaymentBlock');if($blocks.length){$(this).hide();$blocks.show();}});$orderContent.on('click','.jsOrderCouponInitial',function(event){$(this).hide();$('.jsOrderCouponExpanded').show();event.preventDefault();});$orderContent.on('click','.jsOnlinePaymentSpan',function(e){$(this).parent().siblings('.jsOnlinePaymentList').show();$body.trigger('trackUserAction',['17 Оплатить_онлайн_вход_Оплата']);e.stopPropagation();});$orderContent.on('click','.jsOnlinePaymentBlock',function(e){if($(this).find('.jsOnlinePaymentList').length==0)$(this).siblings('.jsOnlinePaymentList').show();else $(this).find('.jsOnlinePaymentList').show();if($(this).find('.jsCreditList').length!=0)$(this).find('.jsCreditList').show();e.stopPropagation();});$orderContent.on('click','.jsCreditButton',function(e){$(this).siblings('.jsCreditList').show();e.preventDefault();e.stopPropagation();$body.trigger('trackGoogleEvent',['Воронка_новая_v2_'+region,'19 Заявка_кредит_Оплата']);});$orderContent.on('click','.jsCreditList li',function(e){var bankProviderId=$(this).data('bank-provider-id'),bank_id=$(this).data('value'),creditData=$(this).parent().siblings('.credit-widget').data('value'),order_number_erp=$(this).closest('.orderLn').data('order-number-erp');if(typeof order_number_erp=='undefined')order_number_erp=$orderContent.data('order-number-erp');if($(e.target).hasClass('jsCreditListOnlineMotivRules')){$body.trigger('trackGoogleEvent',['Воронка_новая_v2_'+region,'19_2 Условия_кредит_Оплата']);return true;}
e.preventDefault();e.stopPropagation();if(!$(this).closest('ul').hasClass('jsCreditListOnlineMotiv'))$(this).parent().hide();showCreditWidget(bankProviderId,creditData,order_number_erp,bank_id);});$body.on('click',function(){if(window.location.pathname=='/order/complete')$('.popupFl').hide();});if(/order\/complete/.test(window.location.href)){if(isOnlineMotivPage){if($('.jsGAOnlinePaymentNotPossible').length>0)$body.trigger('trackGoogleEvent',['Воронка_новая_v2_'+region,'16 Вход_Оплата_ОБЯЗАТЕЛЬНО','нет онлайн оплаты']);if($('.jsOnlinePaymentPossibleNoMotiv').length>0)$body.trigger('trackGoogleEvent',['Воронка_новая_v2_'+region,'16 Вход_Оплата_ОБЯЗАТЕЛЬНО','нет мотиватора']);if($('.jsOnlinePaymentBlockVisible').length>0)$body.trigger('trackGoogleEvent',['Воронка_новая_v2_'+region,'17 Оплатить_онлайн_вход_Оплата']);if($('.jsCreditBlock').length>0)$body.trigger('trackGoogleEvent',['Воронка_новая_v2_'+region,'19 Заявка_кредит_Оплата']);$body.on('click','.jsCompleteOrderShowShop',function(){$body.trigger('trackGoogleEvent',['Воронка_новая_v2_'+region,'16_1 Как_добраться']);})}else{$body.trigger('trackUserAction',['16 Вход_Оплата_ОБЯЗАТЕЛЬНО']);}
if($('.jsOrderPaid').length>0)$body.trigger('trackGoogleEvent',['Воронка_новая_v2_'+region,'18 Успешная_Оплата']);if(docCookies.hasItem('enter_mnogo_ru'))docCookies.setItem('enter_mnogo_ru','',1,'/');if(docCookies.hasItem('enter_panda_pay'))docCookies.setItem('enter_panda_pay','',1,'/');}
if($jsOrder.length!=0){ENTER.utils.sendOrderToGA($jsOrder.data('value'));ENTER.utils.analytics.reviews.clean();ENTER.utils.analytics.productPageSenders.clean();ENTER.utils.analytics.productPageSenders2.clean();}
$(function(){var data=$('.js-orderV3New-complete-subscribe').data('value');if(data&&data.subscribe&&data.email){$body.trigger('trackGoogleEvent',{category:'subscription',action:'subscribe_order_confirmation',label:data.email});}});}(jQuery));
;(function($){ENTER.OrderV3=ENTER.OrderV3||{};try{console.log('Model',$.parseJSON($('#initialOrderModel').html()));}catch(e){}
var body=document.getElementsByTagName('body')[0],$body=$(body),$orderContent=$('#js-order-content'),comment='',region=$('.jsRegion').data('value'),spinner=typeof Spinner=='function'?new Spinner({lines:11,length:5,width:8,radius:23,corners:1,rotate:0,direction:1,color:'#666',speed:1,trail:62,shadow:false,hwaccel:true,className:'spinner',zIndex:2e9,top:'50%',left:'50%'}):null,changeDelivery=function changeDeliveryF(block_name,delivery_method_token){sendChanges('changeDelivery',{'block_name':block_name,'delivery_method_token':delivery_method_token});},changeDate=function changeDateF(block_name,timestamp){sendChanges('changeDate',{'block_name':block_name,'date':timestamp})},changePoint=function changePointF(block_name,id,token){sendChanges('changePoint',{'block_name':block_name,'id':id,'token':token})},changeInterval=function changeIntervalF(block_name,interval){sendChanges('changeInterval',{'block_name':block_name,'interval':interval})},changeProductQuantity=function changeProductQuantityF(block_name,id,quantity){sendChanges('changeProductQuantity',{'block_name':block_name,'id':id,'quantity':quantity})},changePaymentMethod=function changePaymentMethodF(block_name,method,isActive){var params={'block_name':block_name};params[method]=isActive;sendChanges('changePaymentMethod',params)},changeOrderComment=function changeOrderCommentF(comment){sendChanges('changeOrderComment',{'comment':comment})},applyDiscount=function applyDiscountF(block_name,number){var pin=$('[data-block_name='+block_name+']').find('.jsCertificatePinInput').val();if(pin!='')applyCertificate(block_name,number,pin);else checkCertificate(block_name,number);},deleteDiscount=function deleteDiscountF(block_name,number){sendChanges('deleteDiscount',{'block_name':block_name,'number':number})},checkPandaPay=function checkPandaPayF($button,number){var errorClass='cuponErr',$message=$('<div />',{'class':'jsPandaPayMessage'});$button.attr('disabled',true).css('opacity','0.5');$('.'+errorClass).remove();$.ajax({url:'http://pandapay.ru/api/promocode/check',data:{format:'jsonp',code:number},dataType:'jsonp',jsonp:'callback',success:function(resp){if(resp.error){$message.addClass(errorClass).text(resp.message).insertBefore($button.parent());}
else if(resp.success){$message.addClass(errorClass).css('color','green').text('Промокод принят').insertBefore($button.parent());docCookies.setItem('enter_panda_pay',number,60*60,'/');$button.remove();}}}).always(function(){$button.attr('disabled',false).css('opacity','1');});},checkCertificate=function checkCertificateF(block_name,code){$.ajax({type:'POST',url:'/certificate-check',data:{code:code,pin:'0000'}}).done(function(data){if(data.error_code==742){console.log('Сертификат найден');$('[data-block_name='+block_name+']').find('.cuponPin').show();}else if(data.error_code==743){sendChanges('applyDiscount',{'block_name':block_name,'number':code})}}).always(function(data){console.log('Certificate check response',data);})},applyCertificate=function applyCertificateF(block_name,code,pin){sendChanges('applyCertificate',{'block_name':block_name,'code':code,'pin':pin})},deleteCertificate=function deleteCertificateF(block_name){sendChanges('deleteCertificate',{'block_name':block_name})},sendChanges=function sendChangesF(action,params){console.info('Sending action "%s" with params:',action,params);$.ajax({type:'POST',data:{'action':action,'params':params},beforeSend:function(){$orderContent.fadeOut(500);if(spinner)spinner.spin(body)}}).fail(function(jqXHR){var response=$.parseJSON(jqXHR.responseText);if(response.result){console.error(response.result);}
if(response.result.redirect){window.location.href=response.result.redirect;}}).done(function(data){console.log("Model:",data.result.OrderDeliveryModel);$('.jsNewPoints').remove();$orderContent.empty().html($(data.result.page).find('#js-order-content').html());if($orderContent.find('.jsAddressRootNode').length>0){$.each($orderContent.find('.jsAddressRootNode'),function(i,val){ko.applyBindings(ENTER.OrderV3.address,val);});if(typeof ENTER.OrderV3.constructors.smartAddressInit=='function')ENTER.OrderV3.constructors.smartAddressInit();}
ENTER.OrderV3.koModels=[];$.each($orderContent.find('.jsNewPoints'),function(i,val){var pointData=$.parseJSON($(this).find('script.jsMapData').html()),points=new ENTER.DeliveryPoints(pointData.points,ENTER.OrderV3.map);ENTER.OrderV3.koModels.push(points);ko.applyBindings(points,val);});$orderContent.find('.jsMinOrderSumPopup').lightbox_me({closeClick:false,closeEsc:false,centered:true})}).always(function(){$orderContent.stop(true,true).fadeIn(200);if(spinner)spinner.stop();});},log=function logF(data){$.ajax({"type":'POST',"data":data,"url":'/order/log'})},showMap=function(elem){var $currentMap=elem.find('.js-order-map').first(),mapData=$.parseJSON($currentMap.next().html()),mapOptions=ENTER.OrderV3.mapOptions,map=ENTER.OrderV3.map;if(mapData&&typeof map.getType=='function'){elem.lightbox_me({centered:true,closeSelector:'.jsCloseFl'});if(!elem.is(':visible'))elem.show();map.geoObjects.removeAll();map.setCenter([mapOptions.latitude,mapOptions.longitude],mapOptions.zoom);$currentMap.append(ENTER.OrderV3.$map.show());map.container.fitToViewport();$.each(mapData.points,function(token){for(var i=0;i<mapData.points[token].length;i++){try{map.geoObjects.add(new ENTER.Placemark(mapData.points[token][i],true));}catch(e){console.error('Ошибка добавления точки на карту',e);}}});if(map.geoObjects.getLength()===1){map.setCenter(map.geoObjects.get(0).geometry.getCoordinates(),15);map.geoObjects.get(0).options.set('visible',true);}else{map.setBounds(map.geoObjects.getBounds());}}},showOfertaPopup=function showOfertaPopupF(){$('.js-order-oferta-popup').lightbox_me();},tabsOfertaAction=function tabsOfertaActionF(that){var $self=$(that),tabContent=$('.js-tab-oferta-content'),tab_id=$(that).attr('data-tab');$('.js-oferta-tab').removeClass('orderOferta_tabs_i-cur');tabContent.removeClass('orderOferta_tabcnt-cur');$self.addClass('orderOferta_tabs_i-cur');$("#"+tab_id).addClass('orderOferta_tabcnt-cur');};$orderContent.on('click','.jsCloseFl',function(e){e.stopPropagation();$(this).closest('.popupFl').hide();e.preventDefault();});$orderContent.on('click','.jsAddressRootNode',function(){ENTER.OrderV3.address.inputFocus(true);$(this).find('.jsSmartAddressInput').focus();});$orderContent.on('blur','.jsSmartAddressInput',function(){ENTER.OrderV3.address.inputFocus(false);});$orderContent.on('click','.orderCol_date, .js-order-changePlace-link',function(e){var elemId=$(this).data('content');e.stopPropagation();$('.popupFl').hide();if($(this).hasClass('js-order-changePlace-link')){showMap($(elemId));$body.trigger('trackUserAction',['10 Место_самовывоза_Доставка_ОБЯЗАТЕЛЬНО']);}else{$(elemId).show();log({'action':'view-date'});$body.trigger('trackUserAction',['11 Срок_доставки_Доставка']);}
e.preventDefault();});$body.on('click','.selShop_tab:not(.selShop_tab-act)',function(){var token=$(this).data('token'),id=$(this).closest('.popupFl').attr('id');$('.selShop_l').hide();$('.selShop_l[data-token='+token+']').show();$('.selShop_tab').removeClass('selShop_tab-act');$('.selShop_tab[data-token='+token+']').addClass('selShop_tab-act');showMap($('#'+id));});$orderContent.on('click','.jsShowDiscountForm',function(e){e.stopPropagation();$(this).hide().parent().next().show();});$orderContent.on('click','.orderCol_delivrLst li',function(){var $elem=$(this);if(!$elem.hasClass('orderCol_delivrLst_i-act')){changeDelivery($elem.closest('.orderRow').data('block_name'),$elem.data('delivery_method_token'));}});$orderContent.on('click','.celedr_col',function(){var timestamp=$(this).data('value');if(typeof timestamp=='number'){$body.trigger('trackUserAction',['11_1 Срок_Изменил_дату_Доставка']);changeDate($(this).closest('.orderRow').data('block_name'),timestamp)}});$body.on('click','.jsChangePoint',function(){var blockname=$(this).data('blockname'),id=$(this).data('id'),token=$(this).data('token');if(id&&token){$body.trigger('trackUserAction',['10_1 Ввод_данных_Самовывоза_Доставка_ОБЯЗАТЕЛЬНО']);$body.children('.selShop, .lb_overlay').remove();changePoint(blockname,id,token);}});$body.on('click','.jsOrderV3Dropbox',function(){$(this).siblings().removeClass('opn').find('.jsOrderV3DropboxInner').hide();$(this).find('.jsOrderV3DropboxInner').toggle();$(this).hasClass('opn')?$(this).removeClass('opn'):$(this).addClass('opn');});$orderContent.on('click','.jsShowDeliveryIntervals',function(){$(this).find('.customSel_lst').show();});$orderContent.on('click','.customSel_lst li',function(){changeInterval($(this).closest('.orderRow').data('block_name'),$(this).data('value'));});$orderContent.on('click','.jsChangeProductQuantity',function(e){var $this=$(this),quantity=$this.parent().find('input').val();changeProductQuantity($this.data('block_name'),$this.data('id'),quantity);e.preventDefault();});$orderContent.on('click','.jsDeleteProduct',function(e){var $this=$(this);changeProductQuantity($this.data('block_name'),$this.data('id'),0);e.preventDefault();});$orderContent.on('change','.jsCreditCardPayment',function(){var $this=$(this),block_name=$this.closest('.orderRow').data('block_name');if($this.is(':checked'))$body.trigger('trackUserAction',['13_1 Оплата_банковской_картой_Доставка']);changePaymentMethod(block_name,'by_credit_card',$this.is(':checked'))});$orderContent.on('change','.jsCreditPayment',function(){var $this=$(this),block_name=$this.closest('.orderRow').data('block_name');if($this.is(':checked'))$body.trigger('trackUserAction',['13_2 Оплата_в_кредит_Доставка']);changePaymentMethod(block_name,'by_online_credit',$(this).is(':checked'))});$orderContent.on('blur focus','.orderComment_fld',function(){if(comment!=$(this).val()){comment=$(this).val();changeOrderComment($(this).val());}});$orderContent.on('click','.jsOrderV3Comment',function(){$('.orderComment_fld').toggle();});$orderContent.on('click','.jsApplyDiscount',function(e){var $this=$(this),$orderBlock=$this.closest('.orderRow'),block_name=$orderBlock.data('block_name'),number=$this.parent().siblings('input').val().trim();if(/SN.{10}/.test(number)&&$orderBlock.find('.jsOrderV3Discount').length==0)checkPandaPay($this,number);else if(number!='')applyDiscount(block_name,number);e.preventDefault();});$orderContent.on('click','.jsDeleteDiscount',function(e){var $this=$(this),block_name=$this.closest('.orderRow').data('block_name'),number=$this.data('value');deleteDiscount(block_name,number);e.preventDefault();});$orderContent.on('click','.jsDeleteCertificate',function(){var block_name=$(this).closest('.orderRow').data('block_name');deleteCertificate(block_name);});$orderContent.on('click','.jsAcceptTerms',function(){$body.trigger('trackUserAction',['14 Согласен_оферта_Доставка_ОБЯЗАТЕЛЬНО']);});$body.on('click','.js-order-oferta-popup-btn',function(e){var href=$(this).data('value');e.preventDefault();if(href!=''){console.log('OLD href',href);if(window.location.host!='www.enter.ru')href=href.replace(/^.*enter.ru/,'');console.log('NEW href',href);$.ajax({url:href,success:function(data){$('.orderOferta_tl:first').html($(data).find('.entry-content').html());showOfertaPopup();}})}});$body.on('click','.js-oferta-tab',function(){tabsOfertaAction(this)});$('.jsMinOrderSumPopup').lightbox_me({closeClick:false,closeEsc:false,centered:true});$body.on('click','.jsPaymentMethodRadio',function(){var $this=$(this),block_name=$this.closest('.orderRow').data('block_name'),method=$this.val();if(method=='by_online_credit'){$body.trigger('trackGoogleEvent',['Воронка_новая_v2_'+region,'13_3 Способы_оплаты_Доставка','Кредит']);$body.trigger('trackGoogleEvent',['Credit','Выбор опции','Оформление заказа']);}
if(method=='by_online')$body.trigger('trackGoogleEvent',['Воронка_новая_v2_'+region,'13_3 Способы_оплаты_Доставка','Онлайн-оплата']);changePaymentMethod(block_name,method,'true')});$body.on('change','.jsPaymentMethodSelect',function(e){var $this=$(this),block_name=$this.closest('.orderRow').data('block_name'),selectedMethod=$this.find(':selected').val();changePaymentMethod(block_name,selectedMethod,'true');console.log('[G changed',e);if(selectedMethod=='by_credit_card')$body.trigger('trackGoogleEvent',['Воронка_новая_v2_'+region,'13_3 Способы_оплаты_Доставка','Картой_курьеру']);e.preventDefault();});if(/order\/delivery/.test(window.location.href)){$body.trigger('trackUserAction',['6_1 Далее_успешно_Получатель_ОБЯЗАТЕЛЬНО']);$body.trigger('trackUserAction',['7 Вход_Доставка_ОБЯЗАТЕЛЬНО','Количество заказов: '+$('.orderRow').length]);}
$body.on('click','a.jsChangeRegionAnalytics',function(e){var newRegion=$(this).text(),oldRegion=$('.jsRegion').data('value'),link=$(this).attr('href');e.preventDefault();$body.trigger('trackGoogleEvent',[{'eventCategory':'Воронка_'+oldRegion,'eventAction':'8 Регион_Доставка','eventLabel':'Было: '+oldRegion+', Стало: '+newRegion,'hitCallback':link}]);})})(jQuery);
(function($){var $body=$(document.body),$orderContent=$('.orderCnt'),$inputs=$orderContent.find('input');delete $.mask.definitions[9];$.mask.definitions['x']='[0-9]';$.mask.placeholder="_";$.mask.autoclear=false;$.map($inputs,function(elem,i){if(typeof $(elem).data('mask')!=='undefined')$(elem).mask($(elem).data('mask'));});$orderContent.on('click','.bonusCnt_i',function(e){e.stopPropagation();var $elem=$(this),eq=$elem.data('eq'),$cardsDescriptions=$('.bonusCnt_it');if($elem.hasClass('bonusCnt_i-act'))return;$('.bonusCnt_i').removeClass('bonusCnt_i-act');$elem.addClass('bonusCnt_i-act');$cardsDescriptions.hide().eq(eq).show();$elem.find('.bonusCnt_tx_code .brb-dt').hide();});$body.on('mouseenter','.jsShowBonusCardHint',function(){$(this).parent().siblings('.bonusCnt_popup').show()});$body.on('mouseleave','.jsShowBonusCardHint',function(){$(this).parent().siblings('.bonusCnt_popup').hide()});$('.jsOrderV3BonusCardField').each(function(i,elem){$(elem).closest('.bonusCnt-v2').find('.bonusCnt_tx_code .brb-dt').eq(i).text($(elem).val())});$body.on('focus','.jsOrderV3PhoneField',function(){$body.trigger('trackUserAction',['1 Телефон_Получатель_ОБЯЗАТЕЛЬНО'])});$body.on('focus','.jsOrderV3EmailField',function(){$body.trigger('trackUserAction',['2 Email_Получатель'])});$body.on('focus','.jsOrderV3NameField',function(){$body.trigger('trackUserAction',['3 Имя_Получатель_ОБЯЗАТЕЛЬНО'])});$body.on('focus','.jsOrderV3BonusCardField',function(){$body.trigger('trackUserAction',['4 Начислить_баллы_Получатель'])});$body.on('click','.jsOrderV3AuthLink',function(){$body.trigger('trackUserAction',['5 Войти_с_паролем_Получатель'])});if(/orde(r|rs)\/new/.test(window.location.href)){$body.trigger('trackUserAction',['1 Вход_Получатель_ОБЯЗАТЕЛЬНО']);}
if($('.jsOrderV3SubscribeCheckbox').is(':checked')){docCookies.setItem('enter_wanna_subscribe',true,0,'/');}
$body.on('change','.jsOrderV3SubscribeCheckbox',function(){docCookies.setItem('enter_wanna_subscribe',$(this).is(':checked'),0,'/');});$('.jsOrderV3PhoneField').focus();})(jQuery);
;(function($){var $body=$(document.body),$orderContent=$('.orderCnt'),$errorBlock=$orderContent.find('#OrderV3ErrorBlock'),$pageNew=$('.jsOrderV3PageNew'),$pageDelivery=$('.jsOrderV3PageDelivery'),$validationErrors=$('.jsOrderValidationErrors'),errorClass='textfield-err',cancelInputBlur=false,mnogoRuCookie=docCookies.getItem('enter_mnogo_ru'),validateEmail=function validateEmailF(email){var re=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return re.test(email)&&!/[а-яА-Я]/.test(email);},validateMnogoRu=function validateMnogoRuF(val){return val.length==0||/\d{4}\s\d{4}/.test(val)},validate=function validateF(){var error=[],$phoneInput=$('[name=user_info\\[phone\\]]'),$emailInput=$('[name=user_info\\[email\\]]'),$bonusCardInput=$('[name=user_info\\[bonus_card_number\\]]'),$mnogoRuInput=$('.jsOrderV3MnogoRuCardField'),$subscribeInput=$('.jsOrderV3SubscribeCheckbox'),phone=$phoneInput.val().replace(/\s+/g,'');if(!/\+7\(\d{3}\)\d{3}-\d{2}-\d{2}/.test(phone)){error.push('Неверный формат телефона');$phoneInput.addClass('textfield-err').siblings('.errTx').show();}else{$phoneInput.removeClass('textfield-err').siblings('.errTx').hide();}
if(($subscribeInput.is(':checked')||$emailInput.hasClass('jsOrderV3EmailRequired'))&&$emailInput.val().length==0){error.push('Не указан email');$emailInput.addClass('textfield-err').siblings('.errTx').text('Не указан email').show();}else if($emailInput.val().length!=0&&!validateEmail($emailInput.val())){error.push('Неверный формат E-mail');$emailInput.addClass('textfield-err').siblings('.errTx').text('Неверный формат email').show();}else{$emailInput.removeClass('textfield-err').siblings('.errTx').hide();}
if($bonusCardInput.length>0)$bonusCardInput.mask($bonusCardInput.data('mask'));if($mnogoRuInput.length>0)$mnogoRuInput.mask($mnogoRuInput.data('mask'));if($bonusCardInput.length>0&&$bonusCardInput.val().length!=0&&!ENTER.utils.checkEan($bonusCardInput.val())){error.push('Неверный код карты лояльности');$bonusCardInput.addClass(errorClass).siblings('.errTx').show();}else{$bonusCardInput.removeClass('textfield-err').siblings('.errTx').hide();}
if($mnogoRuInput.length>0&&!validateMnogoRu($mnogoRuInput.val())){error.push('Неверный код карты Много.ру');$mnogoRuInput.addClass(errorClass).siblings('.errTx').show();}else{$mnogoRuInput.removeClass('textfield-err').siblings('.errTx').hide();}
return error;};if($validationErrors.length){console.warn('Validation errors',$validationErrors);}
$pageNew.on('blur','input',function(){if(cancelInputBlur){return;}
validate();});$pageNew.find('form').on('submit',function(e){var error=validate(),$mnogoRuInput=$('.jsOrderV3MnogoRuCardField');if(error.length!=0){e.preventDefault();$body.trigger('trackUserAction',['6_2 Далее_ошибка_Получатель','Поле ошибки: '+error.join(', ')])}else{if($mnogoRuInput)docCookies.setItem('enter_mnogo_ru',$mnogoRuInput.val(),31536e3,'/');console.log('mnogo.ru',docCookies.getItem('enter_mnogo_ru'))}});$pageNew.on('mousedown keydown','.jsOrderV3SubscribeLabel, .jsOrderV3SubscribeCheckbox',function(){cancelInputBlur=true;$pageNew.one('mouseup keyup',function(){setTimeout(function(){cancelInputBlur=false;$('input',$pageNew).blur();},0);});});$pageNew.on('change','.jsOrderV3SubscribeCheckbox',function(){if(!$(this).is(':checked'))$body.trigger('trackGoogleEvent',['Email_checkout','unsubscribe','email']);});$pageNew.on('blur','.jsOrderV3EmailField',function(){if(cancelInputBlur){return;}
var $this=$(this);validateEmail($this.val())?$body.trigger('trackGoogleEvent',['Email_checkout','success_validation','email']):$body.trigger('trackGoogleEvent',['Email_checkout','fail_prevalidation','email'])});if($pageNew&&mnogoRuCookie!=null&&mnogoRuCookie!='undefined'){$pageNew.find('.jsOrderV3MnogoRuCardField').val(mnogoRuCookie);$pageNew.find('.jsMnogoRuSpan').text(mnogoRuCookie);}
$pageDelivery.on('click','.jsAcceptTerms',function(e){$(e.currentTarget).parent().removeClass('accept-err');});$pageDelivery.on('click','.orderCompl_btn',function(e){var error=[],$agreement=$('.jsAcceptAgreement'),$form=$(this).closest('form'),send15_3=false,partnerOrders=$('.jsPartnerOrder');if(!$agreement.is(':checked')){error.push('Необходимо согласие с информацией о продавце и его офертой');$agreement.parent().addClass('accept-err')}else{$agreement.parent().removeClass('accept-err')}
partnerOrders.each(function(){if($(this).find('.orderCol_delivrLst_i-act').text().indexOf('Доставка')!=-1){if(!ENTER.OrderV3.address||!ENTER.OrderV3.address.buildingName()){$('.jsSmartAddressBlock').addClass('orderCol_delivrIn-err');error.push('Укажите адрес доставки');}else{$('.jsSmartAddressBlock').removeClass('orderCol_delivrIn-err');}}
$(this).find('.orderCol_addrs_tx').each(function(i,val){if($(val).text().replace(/\s+/,'').length==0){$(this).closest('.orderCol_delivrIn-empty').addClass('orderCol_delivrIn-err');error.push('Укажите адрес самовывоза');}});});e.preventDefault();if(error.length!=0){$errorBlock=$orderContent.find('#OrderV3ErrorBlock');$body.trigger('trackUserAction',['15_2 Оформить_ошибка_Доставка','Поле ошибки: '+error.join(', ')]);}else{if($('.orderCol_addrs_fld').length>0&&ENTER.OrderV3.address.buildingName()=="")send15_3=true;if($('.orderCol_delivrIn-empty:not(.jsSmartAddressBlock)').length>0)send15_3=true;if(send15_3)$body.trigger('trackUserAction',['15_3 Оформить_успешно_КЦ']);$body.trigger('trackUserAction',['15_1 Оформить_успешно_Доставка_ОБЯЗАТЕЛЬНО']);$(this).attr('disabled',true);setTimeout(function(){$form.submit();},1000);}});}(jQuery));
//@ sourceMappingURL=order-v3-new.js.map