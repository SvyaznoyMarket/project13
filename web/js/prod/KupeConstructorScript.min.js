var DKupe3dConstructor=function(ParentItem,HostImgs,HostTextures,HostIcons){function Initialize(e,a){StartKupeSetId=a;var t=navigator.userAgent.match(/MSIE ([\d\.]+)/);t&&(MSIE=parseFloat(t[1])),MainDiv=document.createElement("DIV"),MainDiv.setAttribute("id","Planner3d_MainDiv"),MainDiv.style.position="relative",ParentItem.appendChild(MainDiv),MainDiv.innerHTML='<div id="Planner3d_tab_info" style="color: #666666;font-family:\'Enter Type Bold\';font-size:18px;position: absolute;top: 0px;left: 50%;width: 200px;position:absolute;z-index: 1;display:none;">	<table cellpadding=0 cellspacing=0 width=250>	<tr><td height=25 id=Planner3d_TabInfo1Header width=120 align=center>Выбор корпуса</td><td height=25 width=5>&nbsp;</td><td id=Planner3d_TabInfo2Header width=120 align=center>Выбор фасада</td></tr>	<tr><td id=Planner3d_KorpusVariantsDiv height=80 colspan=3 style="padding-left:5px;border:1px solid #c1c1bf;"></td></tr>	<tr><td id=Planner3d_TabInfo colspan=3 height=183 valign=top style="padding-top:5px;padding-bottom:5px;padding-left:5px;border-left:1px solid #c1c1bf;border-right:1px solid #c1c1bf;border-bottom:1px solid #c1c1bf;">	<div id=Planner3d_TabInfo1 style="display:none;">&nbsp;</div><div id=Planner3d_TabInfo2 style="display:none;">	<font style="font-family:\'Enter Type\';color:#000000;font-size:13px;">Выбор цвета вставки</font><br>	<div id="Planner3d_scrollcontent"></div></div></td></tr>	<tr><td id=Planner3d_LampVariantsDiv height=80 colspan=4 style="padding-left:5px;border-left:1px solid #c1c1bf;border-right:1px solid #c1c1bf;border-bottom:1px solid #c1c1bf;"></td></tr>	<tr><td id=Planner3d_ProfileVariantsDiv height=80 colspan=4 style="padding-left:5px;border-left:1px solid #c1c1bf;border-right:1px solid #c1c1bf;border-bottom:1px solid #c1c1bf;"></td></tr>	</table></div>',document.getElementById("Planner3d_TabInfo1Header").addEventListener("click",ActivateTab1,!1),document.getElementById("Planner3d_TabInfo2Header").addEventListener("click",ActivateTab2,!1),PopupMenuDiv=document.createElement("DIV"),PopupMenuDiv.style.position="absolute",PopupMenuDiv.style.zIndex="2",PopupMenuDiv.style.display="none",PopupMenuDiv.addEventListener("mouseover",showPopupMenu,!1),PopupMenuDiv.addEventListener("mouseout",OnPopupOut,!1),MainDiv.appendChild(PopupMenuDiv),ButtColorPicker=document.createElement("DIV"),ButtColorPicker.style.position="absolute",ButtColorPicker.style.cursor="pointer",ButtColorPicker.style.display="none",ButtColorPicker.innerHTML='<img src="'+HostImgs+'icon_colorpicker.png" width=27 height=26 border=0>',ButtColorPicker.addEventListener("mousedown",stopStart,!1),ButtColorPicker.addEventListener("click",OnClickSmallButtColorPicker,!1),MainDiv.appendChild(ButtColorPicker),progDAnim=new DAnimProgressBar(0),progDAnim.Initialize(MainDiv,Window3dWidth,Window3dHeight);var r=new XMLHttpRequest;r.addEventListener("load",onMainData,!1),r.addEventListener("progress",onMainDataProgress,!1),r.open("GET",e,!0),r.send(null)}function Uninitialize(){}function onMainData(e){progDAnim&&progDAnim.doDraw(progDAnim.width),MainJsonText=e.target.responseText,setTimeout(init,1)}function onMainDataProgress(e){e.lengthComputable&&(e.loaded/e.total,progDAnim&&progDAnim.doDraw(progDAnim.width*e.loaded/e.total))}function ArrayHasItem(e,a){for(var t=0;e.length>t;t++)if(e[t]==a)return 1;return 0}function NormAngle(e){for(var a=e;Math.abs(a)>3.1415927;)a>0?a-=6.2831852:a+=6.2831852;return a}function rgb2hex(e){return(255*e[0]<<16)+(255*e[1]<<8)+255*e[2]}function LoadMaterialByName(e){if(void 0!==MatLib[e])return MatLib[e];var a=GetMaterial(e);if(a){var t=MyCreateMaterial(a);return MatLib[e]=t,t}var r={};return r.color=15790320,new THREE.MeshLambertMaterial(r)}function MyCreateMaterial(e){var a={};if(!e.colorDiffuse||e.mapDiffuse&&e.mapDiffuse.length||(a.color=rgb2hex(e.colorDiffuse)),e.colorSpecular&&(a.specular=rgb2hex(e.colorSpecular)),e.colorAmbient&&(a.ambient=rgb2hex(e.colorAmbient)),e.transparency&&(a.opacity=e.transparency),e.specularCoef&&(a.shininess=e.specularCoef),e.mapDiffuse&&(a.map=THREE.ImageUtils.loadTexture(HostTextures+e.mapDiffuse),a.map.wrapS=THREE.RepeatWrapping,a.map.wrapT=THREE.RepeatWrapping,e.mapDiffuseScale&&a.map.repeat.set(e.mapDiffuseScale[0],e.mapDiffuseScale[1]),e.mapDiffuseOffset&&a.map.offset.set(e.mapDiffuseOffset[0],e.mapDiffuseOffset[1])),e.cubeMap){var t=THREE.ImageUtils.loadTextureCube(e.cubeMap);t.format=THREE.RGBFormat,a.envMap=t,a.combine=THREE.MixOperation,a.reflectivity=.3}return new THREE.MeshPhongMaterial(a)}function FindAllArts(e,a){for(var t=0;a.length>t;t++){var r=a[t].api_id;if(r.length){var o=r.indexOf("/");o>0&&(r=r.substring(0,o)),ArrayHasItem(e,r)||e.push(r)}}}function init(){if(MainJsonData=JSON.parse(MainJsonText)){if(!MSIE||MSIE>=11){var e=document.createElement("DIV");e.setAttribute("id","RotateL"),e.innerHTML='<img draggable="false" src="'+HostImgs+'rotate_left.png" width=35 height=43 border=0>',MainDiv.appendChild(e),e.addEventListener("mousedown",OnPressSmallButtRotateL,!1),e.style.position="absolute",e.style.cursor="pointer";var a=document.createElement("DIV");a.setAttribute("id","RotateC"),a.innerHTML='<img draggable="false" src="'+HostImgs+'rotate_center.png" width=51 height=47 border=0>',MainDiv.appendChild(a),a.style.position="absolute";var t=document.createElement("DIV");t.setAttribute("id","RotateR"),t.innerHTML='<img draggable="false" src="'+HostImgs+'rotate_right.png" width=35 height=43 border=0>',MainDiv.appendChild(t),t.addEventListener("mousedown",OnPressSmallButtRotateR,!1),t.style.position="absolute",t.style.cursor="pointer";var r=document.createElement("DIV");r.setAttribute("id","ZoomOut"),r.innerHTML='<img draggable="false" src="'+HostImgs+'zoom_out.png" width=41 height=39 border=0>',MainDiv.appendChild(r),r.addEventListener("mousedown",OnPressSmallButtZoomOut,!1),r.style.position="absolute",r.style.cursor="pointer";var o=document.createElement("DIV");o.setAttribute("id","ZoomIn"),o.innerHTML='<img draggable="false" src="'+HostImgs+'zoom_in.png" width=41 height=39 border=0>',MainDiv.appendChild(o),o.addEventListener("mousedown",OnPressSmallButtZoomIn,!1),o.style.position="absolute",o.style.cursor="pointer",e.style.top=Window3dHeight+10+"px",e.style.left=Window3dWidth/2-20-35+"px",t.style.top=Window3dHeight+10+"px",t.style.left=Window3dWidth/2+33+"px",a.style.left=Window3dWidth/2-20+"px",a.style.top=Window3dHeight+10+"px",r.style.left="0px",r.style.top="0px",o.style.left="0px",o.style.top="50px"}if(MainJsonData.articuls){for(var n=[],i=0;MainJsonData.korpuses.length>i;i++)for(var s=0;MainJsonData.articuls.korpuses.length>s;s++)if(MainJsonData.korpuses[i].name==MainJsonData.articuls.korpuses[s].name){n.push(MainJsonData.korpuses[i]);break}MainJsonData.korpuses=n}MainJsonText=void 0,progDAnim&&progDAnim.Uninitialize(),container=document.createElement("div"),MainDiv.appendChild(container),document.body.addEventListener("drop",onDropHandler,!1),document.body.addEventListener("dragenter",onDragEnter,!1),document.body.addEventListener("dragover",onDragOver,!1),camera=new THREE.PerspectiveCamera(10,Window3dWidth/Window3dHeight,1,2e3),camera.position.x=0,camera.position.y=1.2,camera.position.z=cameraDistance,scene=new THREE.Scene;var l=new THREE.AmbientLight(5000268);scene.add(l);var d=new THREE.DirectionalLight(10066329);d.position.set(1,0,0).normalize(),scene.add(d);var p=new THREE.DirectionalLight(8355711);p.position.set(-1,0,0).normalize(),scene.add(p);var u=new THREE.DirectionalLight(5855577);u.position.set(0,1,0).normalize(),scene.add(u);var c=new THREE.DirectionalLight(7500402);c.position.set(0,-1,0).normalize(),scene.add(c);var m=new THREE.DirectionalLight(10066329);m.position.set(0,0,1).normalize(),scene.add(m);var f=new THREE.DirectionalLight(10066329);f.position.set(0,0,-1).normalize(),scene.add(f);var v=new THREE.CubeGeometry(600,600,5);floormesh=new THREE.Mesh(v,new THREE.MeshBasicMaterial({color:13421772})),floormesh.position.y=-2.5,floormesh.rotation.x=90*Math.PI/180,Korpus3dHolder=new THREE.Object3D,scene.add(Korpus3dHolder),Lamp3dHolder=new THREE.Object3D,scene.add(Lamp3dHolder);for(var i=0;Doors3dHoldersMax>i;i++){var h=new THREE.Object3D;Doors3dHolders[i]=h,scene.add(h)}for(var i=0;Doors3dHoldersMax>i;i++)KupeParams.doors[i]={},KupeParams.doors[i].materials=["","","",""];if(projector=new THREE.Projector,mouse2D=new THREE.Vector3(0,1e4,.5),loader=new THREE.JSONLoader,void 0!=StartKupeSetId&&null!=StartKupeSetId&&MainJsonData.sets)for(var i=0;MainJsonData.sets.length>i;i++)if(MainJsonData.sets[i].set_id==StartKupeSetId){KupeParams.KorpusName=MainJsonData.sets[i].KorpusName,KupeParams.KorpusMaterial=MainJsonData.sets[i].KorpusMaterial,KupeParams.ProfileMaterial=MainJsonData.sets[i].ProfileMaterial;for(var g=0;MainJsonData.sets[i].doors.length>g;g++)KupeParams.doors[g].variantType=MainJsonData.sets[i].doors[g].type,KupeParams.doors[g].materials=MainJsonData.sets[i].doors[g].colors;break}void 0==KupeParams.KorpusName&&(KupeParams.KorpusName=MainJsonData.korpuses[0].name),void 0==KupeParams.KorpusMaterial&&(KupeParams.KorpusMaterial=GetKorpusPossibleMaterials(KupeParams.KorpusName)[0]),void 0==KupeParams.ProfileMaterial&&(KupeParams.ProfileMaterial=GetProfilePossibleMaterials(KupeParams.KorpusName)[0]),void 0==KupeParams.Lamp&&(KupeParams.Lamp=0),CreateFullKupe(),UpdateKorpusesDiv();var _=document.getElementById("Planner3d_tab_info");if(_.style.display="block",_.style.left=Window3dWidth+20+"px",_.style.height=Window3dHeight+"px",ActivateTab(1),renderer=!MSIE||MSIE>=11?new THREE.WebGLRenderer({antialias:!0}):new THREE.CanvasRenderer,renderer.setSize(Window3dWidth,Window3dHeight),container.appendChild(renderer.domElement),renderer.domElement.style.borderBottom="2px solid #c1c1bf",stats=null,MainDiv.addEventListener("mousewheel",onMouseWheel,!1),MainDiv.addEventListener("mousedown",onDocumentMouseDown,!1),MainDiv.addEventListener("touchstart",onDocumentTouchStart,!1),MainDiv.addEventListener("touchmove",onDocumentTouchMove,!1),document.addEventListener("mousemove",onDocumentMouseMove,!1),document.onselectstart=_onFinishStart,document.oncontextmenu=_onFinishStart,animate(),MainJsonData.articuls){for(var D=[],M=0;MainJsonData.articuls.korpuses.length>M;M++)FindAllArts(D,MainJsonData.articuls.korpuses[M].variants);for(var y=0;MainJsonData.articuls.vstavki.length>y;y++)FindAllArts(D,MainJsonData.articuls.vstavki[y].variants);for(var b=0;MainJsonData.articuls.profiles.length>b;b++)FindAllArts(D,MainJsonData.articuls.profiles[b].variants);for(var s=0;MainJsonData.articuls.doors.length>s;s++)for(var P=0;MainJsonData.articuls.doors[s].types.length>P;P++)FindAllArts(D,MainJsonData.articuls.doors[s].types[P].variants);Planner3d_Init(D),UpdatePrice()}}}function AppendSceneApiIdsIds(e,a,t){for(var r=0;a.length>r;r++)if(a[r].color==t){var o=a[r].api_id;if(o.length){var n=o.indexOf("/");if(n>0&&"/2"==o.substring(n))for(var i=0;e.length>i;i++)if(e[i]==o)return e[i]=o.substring(0,n),void 0;e.push(o)}}}function GetSceneApiIds(){for(var e=[],a=0;MainJsonData.articuls.korpuses.length>a;a++)if(MainJsonData.articuls.korpuses[a].name==KupeParams.KorpusName){AppendSceneApiIdsIds(e,MainJsonData.articuls.korpuses[a].variants,KupeParams.KorpusMaterial);break}var t=GetKorpusByName(KupeParams.KorpusName);if(t){for(var a=0;MainJsonData.articuls.profiles.length>a;a++)if(t.width==MainJsonData.articuls.profiles[a].width){AppendSceneApiIdsIds(e,MainJsonData.articuls.profiles[a].variants,KupeParams.ProfileMaterial);break}for(var a=0;MainJsonData.articuls.doors.length>a;a++)if(MainJsonData.articuls.doors[a].name==t.doors.type){for(var r=0;KupeParams.nDoors>r;r++)for(var o=0;MainJsonData.articuls.doors[a].types.length>o;o++)if(MainJsonData.articuls.doors[a].types[o].type==KupeParams.doors[r].variantType){AppendSceneApiIdsIds(e,MainJsonData.articuls.doors[a].types[o].variants,KupeParams.ProfileMaterial);break}break}var n=GetDoorByType(KupeParams.DoorsType);if(n)for(var r=0;KupeParams.nDoors>r;r++){for(var i=null,s=0;n.variants.length>s&&null==i;s++)n.variants[s].type==KupeParams.doors[r].variantType&&(i=n.variants[s].sections);if(i)for(var l=0;KupeParams.doors[r].sections.length>l;l++)for(var d=0;MainJsonData.articuls.vstavki.length>d;d++)if(MainJsonData.articuls.vstavki[d].width==n.width&&MainJsonData.articuls.vstavki[d].height==i[l].height){AppendSceneApiIdsIds(e,MainJsonData.articuls.vstavki[d].variants,KupeParams.doors[r].materials[l]);break}}}return e}function UpdatePrice(){var e=GetSceneApiIds(),a=ProblemVstavkaMaterials;ProblemVstavkaMaterials=[];for(var t=[],r=0;e.length>r;r++){var o=e[r],n=o.indexOf("/");if(n>0){t.push({id:parseInt(o.substring(0,n)),error:"Вставки продаютcя только комплектом по 2шт!"});for(var i=0;MainJsonData.articuls.vstavki.length>i;i++)for(var s=0;MainJsonData.articuls.vstavki[i].variants.length>s;s++)MainJsonData.articuls.vstavki[i].variants[s].api_id==o&&ProblemVstavkaMaterials.push(MainJsonData.articuls.vstavki[i].variants[s].color)}else t.push({id:parseInt(o),error:""})}if(Planner3d_UpdatePrice(t),2==iActiveTab&&(a.length||ProblemVstavkaMaterials.length)){var l=document.getElementById("Planner3d_scrollcontent").childNodes;if(l.length&&"TABLE"==l[l.length-1].tagName)for(var d=l[l.length-1].rows,p=0;d.length>p;p++)for(var u=d.item(p).cells,c=0;u.length>c;c++){var m=u.item(c);if(m&&m.childNodes.length&&"DIV"==m.childNodes[0].tagName&&"mat_"==m.childNodes[0].id.substring(0,4)){var f=!ArrayHasItem(ProblemVstavkaMaterials,m.childNodes[0].id.substring(4));f&&m.childNodes[0].childNodes.length?m.childNodes[0].innerHTML="":f||0!=m.childNodes[0].childNodes.length||(m.childNodes[0].innerHTML='<img draggable="false" src="'+HostImgs+'attention.gif" border=0>')}}}}function GetBasketContent(){for(var e=GetSceneApiIds(),a=[],t=0;e.length>t;t++){var r=e[t].indexOf("/"),o=parseInt(r>0?e[t].substring(0,r):e[t]);for(r=0;a.length>r;r++)if(a[r].id==o){a[r].quantity++;break}r==a.length&&a.push({id:o,quantity:1})}return a}function OnShapeLoaded(e,a,t,r){var o=new THREE.Mesh(t,new THREE.MeshFaceMaterial(r));if("Korpus"==e)Korpus3dHolder.add(o);else if("Lamp"==e)for(var n=0;Lamp3dHolder.children.length>n;n++)KupeParams.Lamp||(o.visible=!1),Lamp3dHolder.children[n].add(0==n?o:o.clone());else for(var n=0;Doors3dHoldersMax>n;n++)if(e=="Door"+n)return 1==iActiveTab&&(o.visible=!1),Doors3dHolders[n].add(o),void 0}function ActivateTab1(){ActivateTab(1)}function ActivateTab2(){ActivateTab(2)}function ActivateTab(e){iActiveTab=e,DoActivateTab("TabInfo"+e,"TabInfo"+(3-e));for(var a=0;KupeParams.nDoors>a;a++)for(var t=0;Doors3dHolders[a].children.length>t;t++)Doors3dHolders[a].children[t].visible=1==iActiveTab?!1:!0;1==iActiveTab&&(ButtColorPicker.style.display="none"),document.getElementById("Planner3d_KorpusVariantsDiv").height=1==iActiveTab?90:57,document.getElementById("Planner3d_TabInfo").height=1==iActiveTab?160:195;var r="";if(1==iActiveTab){r="<font style=\"font-family:'Enter Type';color:#000000;font-size:13px;\">Выбор цвета корпуса</font><br>",r+="<table cellpadding=0 cellspacing=0 onclick=\"Planner3dKupeConstructor.SetKorpusMaterial('',event)\">",r+="<tr>";for(var o=GetKorpusPossibleMaterials(KupeParams.KorpusName),t=0;o.length>t;t++){var n=GetMaterial(o[t]);n&&(r+="<td onmouseover=\"Planner3dKupeConstructor.showPopupMenu('mat_"+o[t]+'\')" onmouseout="Planner3dKupeConstructor.OnPopupOut()" width='+(iconSize+4)+" height="+(iconSize+4)+' valign=middle align=center style="',r+="border:2px solid "+(KupeParams.KorpusMaterial==o[t]?"#ff9e18;":"#ffffff;"),r+='">',r+='<div id="mat_'+o[t]+'" style="width:'+iconSize+"px;height:"+iconSize+"px;background-image:url("+HostIcons+n.icon+');cursor:pointer;" title="'+n.description+'"></div>',r+="</td>")}r+="</tr>",r+="</table>"}if(2==iActiveTab){r+="<table cellpadding=0 cellspacing=0 onclick=\"Planner3dKupeConstructor.SetCurrentVstavkaMaterial('',event)\">",r+="<tr>";var o=GetVstavkaPossibleMaterials(KupeParams.DoorsType);ArrayHasItem(o,CurrentVstavkaMaterial)||(CurrentVstavkaMaterial=o[0]);for(var t=0;o.length>t;t++){t>0&&0==t%4&&(r+="</tr><tr>");var n=GetMaterial(o[t]);n&&(r+="<td onmouseover=\"Planner3dKupeConstructor.showPopupMenu('mat_"+o[t]+'\')" onmouseout="Planner3dKupeConstructor.OnPopupOut()" width='+(iconSize+4)+" height="+(iconSize+4)+' valign=middle align=center style="',r+="border:2px solid "+(CurrentVstavkaMaterial==o[t]?"#ff9e18;":"#ffffff;"),r+='">',r+='<div draggable="true" id="mat_'+o[t]+'" style="width:'+iconSize+"px;height:"+iconSize+"px;background-image:url("+HostIcons+n.icon+');cursor:pointer;text-align:right;" ondragstart="Planner3dKupeConstructor.onDragMatStart(\''+o[t]+'\', event)" ondragend="Planner3dKupeConstructor.onDragMatEnd()"  title="'+n.description+'">',ArrayHasItem(ProblemVstavkaMaterials,o[t])&&(r+='<img draggable="false" src="'+HostImgs+'attention.gif" border=0>'),r+="</div>",r+="</td>")}r+="</tr>",r+="</table>"}1==iActiveTab?document.getElementById("Planner3d_TabInfo"+iActiveTab).innerHTML=r:document.getElementById("Planner3d_scrollcontent").innerHTML=r,r=1==iActiveTab?"<font style=\"font-family:'Enter Type';color:#000000;font-size:13px;\">Выбор цвета профиля</font><br>":"<font style=\"font-family:'Enter Type';color:#000000;font-size:13px;\">Выбор цвета рамки</font><br>",r+="<table cellpadding=0 cellspacing=0>",r+="<tr>";for(var o=GetProfilePossibleMaterials(KupeParams.KorpusName),t=0;o.length>t;t++){var i=50,s=42,n=GetMaterial(o[t]);n&&(r+="<td width="+(i+6)+" height="+(s+6)+' valign=middle align=center style="',r+=KupeParams.ProfileMaterial==o[t]?"border:2px solid #ff9e18;":"border:2px solid #ffffff;",r+='">',r+='<img ondragstart="Planner3dKupeConstructor.stopStart(event)" onclick="Planner3dKupeConstructor.SetProfileMaterial(\''+o[t]+"',event)\" width="+i+" height="+s+' src="'+HostIcons+n.icon+'" title="'+n.description+'">',r+="</td>")}r+="</tr>",r+="</table>",document.getElementById("Planner3d_ProfileVariantsDiv").innerHTML=r,GetKorpusByName(KupeParams.KorpusName),MainJsonData.articuls.lamps&&(r="<font style=\"font-family:'Enter Type';color:#000000;font-size:13px;\">Подсветка</font><br>",r+="<table cellpadding=0 cellspacing=0>",r+="<tr>",r+='<td valign=middle align=center style="',r+=KupeParams.Lamp?"border:2px solid #ff9e18;":"border:2px solid #ffffff;",r+='">',r+='<img ondragstart="Planner3dKupeConstructor.stopStart(event)" onclick="Planner3dKupeConstructor.SwitchLamp(event)" width='+i+" height="+s+' src="'+HostImgs+'lamp.png">',r+="</td>",r+="</tr>",r+="</table>",document.getElementById("Planner3d_LampVariantsDiv").innerHTML=r),UpdateKorpusesDiv()}function UnborderTableCells(e,a){for(var t=e.rows,r=0;t.length>r;r++)for(var o=t.item(r).cells,n=0;o.length>n;n++){var i=o.item(n);i&&i!=a&&(i.style.borderColor="#FFFFFF")}}function SetKorpusMaterial(e,a){if(SetKorpusMaterial.arguments.length>=2){if("DIV"!=a.target.tagName||"mat_"!=a.target.id.substring(0,4))return;e=a.target.id.substring(4)}var t=GetMaterial(e);if(t&&(Korpus3dHolder.children[0].material=LoadMaterialByName(e),KupeParams.KorpusMaterial=e,SetKorpusMaterial.arguments.length>=2)){var r=a.target?a.target.offsetParent:null;"TD"==r.tagName&&(UnborderTableCells(r.offsetParent,r),r.style.borderColor="#ff9e18")}SetKorpusMaterial.arguments.length>=2&&UpdatePrice()}function SetCurrentVstavkaMaterial(e,a){if(SetCurrentVstavkaMaterial.arguments.length>=2){var t=a.target;if("IMG"==t.tagName&&"DIV"==t.parentNode.tagName&&"mat_"==t.parentNode.id.substring(0,4)&&(t=t.parentNode),"DIV"!=t.tagName&&"IMG"!=t.tagName||"mat_"!=t.id.substring(0,4))return;e=t.id.substring(4),LoadMaterialByName(e),CurrentVstavkaMaterial=e;var r=t?t.offsetParent:null;r&&"TD"==r.tagName&&(UnborderTableCells(r.offsetParent,r),r.style.borderColor="#ff9e18")}else CurrentVstavkaMaterial=e}function SetProfileMaterial(e,a){var t=LoadMaterialByName(e);Korpus3dHolder.children[1].material=t,KupeParams.ProfileMaterial=e;for(var r=0;KupeParams.nDoors>r;r++)Doors3dHolders[r].children.length>0&&(Doors3dHolders[r].children[0].material=t);if(SetProfileMaterial.arguments.length>=2){var o=a.target?a.target.offsetParent:null;"TD"==o.tagName&&(UnborderTableCells(o.offsetParent,o),o.style.borderColor="#ff9e18"),UpdatePrice()}}function SwitchLamp(e){if(KupeParams.Lamp=1-KupeParams.Lamp,SwitchLamp.arguments.length>=1){var a=e.target?e.target.offsetParent:null;"TD"==a.tagName&&(a.style.borderColor=KupeParams.Lamp?"#ff9e18":"#ffffff")}for(var t=0;Lamp3dHolder.children.length>t;t++)for(var r=0;Lamp3dHolder.children[t].children.length>r;r++)Lamp3dHolder.children[t].children[r].visible=KupeParams.Lamp?!0:!1}function DoActivateTab(){for(var e=0;DoActivateTab.arguments.length>e;e++){var a=document.getElementById("Planner3d_"+DoActivateTab.arguments[e]),t=document.getElementById("Planner3d_"+DoActivateTab.arguments[e]+"Header");a&&t&&(t.style.borderBottom=0==e?"2px #ff9e18 solid":"0px",a.style.display=0==e?"block":"none",t.style.color=0==e?"#000000":"#666666",t.style.cursor=0==e?"default":"pointer",t.style.fontWeight=0==e?"bold":"normal")}}function GetKorpusPossibleMaterials(e){if(MainJsonData.articuls){for(var a=0;MainJsonData.articuls.korpuses.length>a;a++)if(MainJsonData.articuls.korpuses[a].name==e)return GetColorsArrayFromVariants(MainJsonData.articuls.korpuses[a].variants);return["oak_milk"]}return["oak_milk","oak_ferrara","apple_locarno"]}function GetVstavkaPossibleMaterials(e,a,t){var r=[];if(MainJsonData.articuls){var o=GetDoorByType(e),n=0;if(a)for(var i=GetDoorVariants(o),s=0;i.length>s;s++)if(i[s].type==a){n=i[s].sections[t].height;break}for(var l=[],d=0;MainJsonData.articuls.vstavki.length>d;d++)if(MainJsonData.articuls.vstavki[d].width==o.width&&(0==n||MainJsonData.articuls.vstavki[d].height==n))for(var p=0;MainJsonData.articuls.vstavki[d].variants.length>p;p++)ArrayHasItem(l,MainJsonData.articuls.vstavki[d].variants[p].color)||l.push(MainJsonData.articuls.vstavki[d].variants[p].color);for(var s=0;MainJsonData.materials.length>s;s++)ArrayHasItem(l,MainJsonData.materials[s].name)&&r.push(MainJsonData.materials[s].name)}else for(var s=0;MainJsonData.materials.length>s;s++)0!=MainJsonData.materials[s].name.indexOf("Profile")&&r.push(MainJsonData.materials[s].name);return r}function GetColorsArrayFromVariants(e){for(var a=[],t=0;e.length>t;t++)a.push(e[t].color);return a}function GetProfilePossibleMaterials(e){if(MainJsonData.articuls){var a=GetKorpusByName(e);if(a)for(var t=0;MainJsonData.articuls.profiles.length>t;t++)if(a.width==MainJsonData.articuls.profiles[t].width)return GetColorsArrayFromVariants(MainJsonData.articuls.profiles[t].variants);return["ProfileSilver"]}return["ProfileSilver","ProfileBronza","ProfileZoloto","ProfileShampan"]}function GetMaterial(e){for(var a=0;MainJsonData.materials.length>a;a++)if(MainJsonData.materials[a].name==e)return MainJsonData.materials[a]}function GetDoorVariant(e,a){if(void 0!=e)for(var t=0;a.length>t;t++)if(a[t].type==e)return a[t]}function GetKorpusByName(e){for(var a=0;MainJsonData.korpuses.length>a;a++)if(MainJsonData.korpuses[a].name==e)return MainJsonData.korpuses[a]}function GetDoorByType(e){for(var a=0;MainJsonData.doors.length>a;a++)if(MainJsonData.doors[a].type==e)return MainJsonData.doors[a]}function ClearChildren(e){for(var a=e.children.length-1;a>=0;a--)e.remove(e.children[a])}function GetDoorVariants(e){if(MainJsonData.articuls){for(var a=[],t=0;MainJsonData.articuls.doors.length>t;t++)if(MainJsonData.articuls.doors[t].name==e.type)for(var r=MainJsonData.articuls.doors[t].types,o=0;e.variants.length>o;o++)for(var n=0;r.length>n;n++)if(e.variants[o].type==r[n].type){a.push(e.variants[o]);break}return a}return e.variants}function UpdateKupeDoor(e){var a=GetKorpusByName(KupeParams.KorpusName);if(void 0!=a){var t=GetDoorByType(a.doors.type),r=GetDoorVariants(t);ClearChildren(Doors3dHolders[e]);var o=GetDoorVariant(KupeParams.doors[e].variantType,r);if(void 0!=o){KupeParams.doors[e].sections=o.sections;for(var n=0;KupeParams.doors[e].sections.length>n;n++){var i=GetVstavkaPossibleMaterials(KupeParams.DoorsType,KupeParams.doors[e].variantType,n);ArrayHasItem(i,KupeParams.doors[e].materials[n])||(KupeParams.doors[e].materials[n]=i[0])}Doors3dHolders[e].position.z=0==e%2?t.shiftSecondRail:0,Doors3dHolders[e].position.x=0==e?-.5*a.width+a.DspThickness+.5*t.width:e==a.doors.count-1?.5*a.width-a.DspThickness-.5*t.width:0;for(var s=0;o.shapes.length>s;s++)loader.createModel(o.shapes[s],function(a,t){OnShapeLoaded("Door"+e,s,a,t)},"");UpdateKupeDoorMaterial(e)}}}function UpdateKupeDoorMaterial(e,a){var t=Doors3dHolders[e].children;if(UpdateKupeDoorMaterial.arguments.length>=2)KupeParams.doors[e].sections.length>a&&t.length>a+1&&void 0!=KupeParams.doors[e].materials[a]&&KupeParams.doors[e].materials[a].length&&(t[1+a].material=LoadMaterialByName(KupeParams.doors[e].materials[a]));else{t.length&&void 0!=KupeParams.ProfileMaterial&&(t[0].material=LoadMaterialByName(KupeParams.ProfileMaterial));for(var r=0;KupeParams.doors[e].sections.length>r;r++)t.length>r+1&&void 0!=KupeParams.doors[e].materials[r]&&KupeParams.doors[e].materials[r].length&&(t[1+r].material=LoadMaterialByName(KupeParams.doors[e].materials[r]))}}function UpdateKorpusesDiv(){var e="<table cellpadding=0 cellspacing=0>";if(1==iActiveTab){var a,t=[];for(a=0;MainJsonData.korpuses.length>a;a++){var r,o=Math.round(1e3*MainJsonData.korpuses[a].width);for(r=0;t.length>r&&o>t[r][0];r++);if(r==t.length)t.push([o,MainJsonData.korpuses[a]]);else if(o==t[r][0])t[r].push(MainJsonData.korpuses[a]);else{t.length++;for(var n=t.length-1;n>r;n--)t[n]=t[n-1];t[r]=[o,MainJsonData.korpuses[a]]}}for(var i=GetKorpusByName(KupeParams.KorpusName),s=Math.round(1e3*i.width),l=0;2>l;l++){for(e+="<tr>",a=0;t.length>a;a++){var d=t[a][1];t[a][0]==s&&(d=i),e+='<td align=center style="cursor:pointer;';var p=t[a][0]==s?"#ff9e18":"#ffffff";e+="border-"+(0==l?"top":"bottom")+":2px solid "+p+";border-left:2px solid "+p+";border-right:2px solid "+p+";",1==l&&(e+="font-family:Arial;font-size:9px;"),e+='" onmouseover="Planner3dKupeConstructor.showPopupMenu(\'door_'+t[a][0]+'\',event.target)" onmouseout="Planner3dKupeConstructor.OnPopupOut()"',e+=0==l?" valign=bottom width=80 height=47 onclick=\"Planner3dKupeConstructor.SetKorpus('"+d.name+'\')"><img ondragstart="Planner3dKupeConstructor.stopStart(event)" src="'+HostImgs+"korpus_"+t[a][0]+'.png" >':">"+t[a][0]+" мм",e+="</td>"}e+="</tr>"}}if(2==iActiveTab){e+="<tr>";for(var u=0;KupeParams.nDoors>u;u++){var c=KupeParams.doors[u];e+='<td align=center style="cursor:pointer;" onmouseover="Planner3dKupeConstructor.showPopupMenu(\'dsb_'+u+'\',event.target)" onmouseout="Planner3dKupeConstructor.OnPopupOut()" valign=bottom width=40 height=43><img ondragstart="Planner3dKupeConstructor.stopStart(event)" src="'+HostImgs+"icon_door_variant_"+c.variantType+'.gif" width=36 height=36>',e+="</td>"}e+="</tr>"}e+="</table>",document.getElementById("Planner3d_KorpusVariantsDiv").innerHTML=e,cPopupMenu&&1==iActiveTab&&"door_"==cPopupMenu.substring(0,5)&&CreateDoorPopup(PopupMenuDiv,parseInt(cPopupMenu.substring(5))),cPopupMenu&&2==iActiveTab&&"dsb_"==cPopupMenu.substring(0,4)&&CreateDsbPopup(PopupMenuDiv,parseInt(cPopupMenu.substring(4)))}function SetKorpus(e){KupeParams.KorpusName=e,CreateFullKupe(),UpdateKorpusesDiv(),UpdatePrice()}function CreateFullKupe(){ClearChildren(Korpus3dHolder),ClearChildren(Lamp3dHolder);for(var e=GetKorpusByName(KupeParams.KorpusName),a=e.width>1.5?3:2,t=0;a>t;t++){var r=new THREE.Object3D;r.position.x=-.5*e.width+(t+.5)*e.width/a,Lamp3dHolder.add(r)}KupeParams.nDoors=e.doors.count,(void 0==iActiveDoor||iActiveDoor>=KupeParams.nDoors)&&(iActiveDoor=0),KupeParams.DoorsType=e.doors.type;for(var t=0;e.shapes.length>t;t++)loader.createModel(e.shapes[t],function(e,a){OnShapeLoaded("Korpus",t,e,a)},"");for(var t=0;MainJsonData.lamp.length>t;t++)loader.createModel(MainJsonData.lamp[t],function(e,a){OnShapeLoaded("Lamp",t,e,a)},"");var o=GetDoorByType(KupeParams.DoorsType);if(o)for(var n=GetDoorVariants(o),i=0;Doors3dHoldersMax>i;i++)e.doors.count>i?(void 0==GetDoorVariant(KupeParams.doors[i].variantType,n)&&(KupeParams.doors[i].variantType=n[0].type),UpdateKupeDoor(i)):ClearChildren(Doors3dHolders[i]);SetKorpusMaterial(KupeParams.KorpusMaterial),SetProfileMaterial(KupeParams.ProfileMaterial)}function onDocumentMouseDown(e){var a=e.pageX-getGlobalOffsetX(MainDiv),t=e.pageY-getGlobalOffsetY(MainDiv);if(2==e.button)e.preventDefault(),(!MSIE||MSIE>=11)&&(bMouseNavigationActive=!0,document.addEventListener("mouseup",onDocumentMouseUp,!1),document.addEventListener("mouseout",onDocumentMouseOut,!1),mouseXOnMouseDown=a-windowHalfX,targetRotationOnMouseDown=NormAngle(targetRotation),bMouseMoveBetweenClick=0);else if(0==e.button){if(2==iActiveTab&&a>=0&&Window3dWidth>a&&t>=0&&Window3dHeight>t){mouse2D.x=2*(a/Window3dWidth)-1,mouse2D.y=2*-(t/Window3dHeight)+1,raycaster=projector.pickingRay(mouse2D.clone(),camera);var r=raycaster.intersectObjects(scene.children,!0);if(r.length&&r[0].object.parent==Korpus3dHolder);else if(r.length)for(var o=0;KupeParams.nDoors>o;o++)if(r[0].object.parent==Doors3dHolders[o]){var n=GetDoorByType(KupeParams.DoorsType);if(void 0!=n)for(var i=0;KupeParams.doors[o].sections.length>i;i++)if(r[0].object==Doors3dHolders[o].children[1+i]){var s=GetVstavkaPossibleMaterials(KupeParams.DoorsType,KupeParams.doors[o].variantType,i);ArrayHasItem(s,CurrentVstavkaMaterial)&&(KupeParams.doors[o].materials[i]=CurrentVstavkaMaterial,UpdateKupeDoorMaterial(iActiveDoor,i),UpdatePrice());break}}}}else if(1==e.button&&a>=0&&Window3dWidth>a&&t>=0&&Window3dHeight>t){e.preventDefault(),mouse2D.x=2*(a/Window3dWidth)-1,mouse2D.y=2*-(t/Window3dHeight)+1,raycaster=projector.pickingRay(mouse2D.clone(),camera);var r=raycaster.intersectObjects(scene.children,!0);if(r.length){var l=r[0].point.clone().sub(camera.position),d=new THREE.Quaternion;d.setFromEuler(camera.rotation);var p=new THREE.Vector3(0,0,-1);p.applyQuaternion(d),fPanDistance=l.dot(p)}else fPanDistance=cameraDistance;last_pan_X=a,last_pan_Y=t,bPanActive=!0,document.addEventListener("mouseup",onDocumentMouseUp,!1),document.addEventListener("mouseout",onDocumentMouseOut,!1)}}function onDocumentMouseMove(e){var a=e.pageX-getGlobalOffsetX(MainDiv),t=e.pageY-getGlobalOffsetY(MainDiv);if(bMouseNavigationActive&&(bMouseMoveBetweenClick=1,mouseX=a-windowHalfX,targetRotation=targetRotationOnMouseDown+.02*(mouseX-mouseXOnMouseDown)),bPanActive&&(last_pan_X!=a||last_pan_Y!=t)){var r=new THREE.Vector3(2*(1*last_pan_X/Window3dWidth)-1,2*-(1*last_pan_Y/Window3dHeight)+1,.5);projector.unprojectVector(r,camera),r.sub(camera.position);var o=new THREE.Vector3(2*(1*a/Window3dWidth)-1,2*-(1*t/Window3dHeight)+1,.5);projector.unprojectVector(o,camera),o.sub(camera.position);var n=new THREE.Quaternion;n.setFromEuler(camera.rotation);var i=new THREE.Vector3(0,0,-1);i.applyQuaternion(n);var s=r.dot(i),l=o.dot(i);if(s>0&&l>0){camera.position.y+=fPanDistance*(r.y/s-o.y/l);var d=Math.sin(camera.rotation.y),p=Math.cos(camera.rotation.y);cameraXshift+=fPanDistance*(r.x/s-o.x/l)*p-fPanDistance*(r.z/s-o.z/l)*d,last_pan_X=a,last_pan_Y=t}}On3dMouseMove(a,t),e.stopPropagation()}function On3dMouseMove(e,a){var t=iActiveDoor;if(e>=0&&Window3dWidth>e&&a>=0&&Window3dHeight>a){var r="default";if(2==iActiveTab){mouse2D.x=2*(e/Window3dWidth)-1,mouse2D.y=2*-(a/Window3dHeight)+1,raycaster=projector.pickingRay(mouse2D.clone(),camera);var o=raycaster.intersectObjects(scene.children,!0);if(o.length&&o[0].object.parent==Korpus3dHolder);else if(o.length)for(var n=0;KupeParams.nDoors>n;n++)if(o[0].object.parent==Doors3dHolders[n]){iActiveDoor=n;var i=GetDoorByType(KupeParams.DoorsType);if(void 0!=i){for(var s=0;KupeParams.doors[n].sections.length>s;s++)if(o[0].object==Doors3dHolders[n].children[1+s]){iActiveDoorSection=s;var l=GetVstavkaPossibleMaterials(KupeParams.DoorsType,KupeParams.doors[n].variantType,s);ArrayHasItem(l,CurrentVstavkaMaterial)&&(r="url("+HostImgs+"brush.cur), pointer");break}s==KupeParams.doors[n].sections.length&&(iActiveDoorSection=-1)}break}}renderer.domElement.style.cursor=r}else iActiveDoor=-1;iActiveDoor>=0?showPopupMenu("ds_"+iActiveDoor):t!=iActiveDoor&&void 0!=cPopupMenu&&"ds_"==cPopupMenu.substring(0,3)&&OnPopupOut()
}function onDocumentContextMenu(){event.preventDefault()}function onDocumentMouseUp(e){(2==e.button||1==e.button)&&(e.preventDefault(),bMouseNavigationActive=!1,bPanActive=!1,document.removeEventListener("mouseup",onDocumentMouseUp,!1),document.removeEventListener("mouseout",onDocumentMouseOut,!1))}function onDocumentMouseOut(){bMouseNavigationActive=!1,bPanActive=!1,document.removeEventListener("mouseup",onDocumentMouseUp,!1),document.removeEventListener("mouseout",onDocumentMouseOut,!1)}function onDocumentTouchStart(e){1==e.touches.length&&(e.preventDefault(),mouseXOnMouseDown=e.touches[0].pageX-windowHalfX,targetRotationOnMouseDown=NormAngle(targetRotation))}function onDocumentTouchMove(e){1==e.touches.length&&(e.preventDefault(),mouseX=e.touches[0].pageX-windowHalfX,targetRotation=targetRotationOnMouseDown+.05*(mouseX-mouseXOnMouseDown))}function onMouseWheel(e){e.wheelDelta>0?cameraDistance*=1-Math.min(.2,5e-4*e.wheelDelta):cameraDistance/=1-Math.min(.2,-5e-4*e.wheelDelta),e.preventDefault(),e.stopPropagation()}function hidePopup(){PopupMenuDiv.style.display="none",(void 0!=cPopupMenu&&("door_"==cPopupMenu.substring(0,5)||"mat_"==cPopupMenu.substring(0,4))||"dsb_"==cPopupMenu.substring(0,4))&&(document.getElementById("Planner3d_ProfileVariantsDiv").style.visibility="visible",document.getElementById("Planner3d_LampVariantsDiv").style.visibility="visible",document.getElementById("Planner3d_TabInfo1").style.visibility="visible",document.getElementById("Planner3d_TabInfo2").style.visibility="visible"),null!=hideTimeout&&(clearTimeout(hideTimeout),hideTimeout=null),cPopupMenu=null}function getGlobalOffsetX(e,a){var t,r=0;for(t=e;"BODY"!=t.tagName&&t!=a;t=t.offsetParent)r+=t.offsetLeft;return r}function getGlobalOffsetY(e,a){var t,r=0;for(t=e;"BODY"!=t.tagName&&t!=a;t=t.offsetParent)r+=t.offsetTop;return r}function OnPopupOut(){null==hideTimeout&&(hideTimeout=setTimeout(hidePopup,100))}function CreateDoorPopup(e,a){var t=GetKorpusByName(KupeParams.KorpusName),r="<table cellpadding=0 cellspacing=0>";r+="";for(var o=0;MainJsonData.korpuses.length>o;o++)if(a==Math.round(1e3*MainJsonData.korpuses[o].width)){r+="<tr>";for(var n=0;2>n;n++){r+='<td style="cursor:pointer;padding-left:4px;padding-top:4px;padding-right:4px;',1==n&&(r+="font-family:Arial;font-size:9px;color:#666666;");var i=MainJsonData.korpuses[o]==t?"#ff9e18":"#ffffff";r+="border-"+(0==n?"left":"right")+":2px solid "+i+";border-top:2px solid "+i+";border-bottom:2px solid "+i+";",r+='" ',0==n&&(r+=" align=center"),r+=" onclick=\"Planner3dKupeConstructor.SetKorpus('"+MainJsonData.korpuses[o].name+"')\">",r+=0==n?'<img src="'+HostIcons+MainJsonData.korpuses[o].icon+'" height=37>':"глубина "+Math.round(1e3*MainJsonData.korpuses[o].depth)+" мм<br>"+MainJsonData.korpuses[o].doors.count+" двери",r+="</td>"}r+="</tr>"}r+="",r+="</table>",e.innerHTML=r}function CreateDsbPopup(e,a){var a=parseInt(cPopupMenu.substring(4)),t='<table cellpadding=0 cellspacing=0 style="background-color:#FFFFFF">',r=GetDoorByType(KupeParams.DoorsType),o=GetDoorVariants(r);if(r)for(var n=0;o.length>n;n++){t+="<tr>";for(var i=0;2>i;i++){t+='<td style="cursor:pointer;padding-left:4px;padding-top:4px;padding-right:4px;',1==i&&(t+="font-family:Arial;font-size:9px;color:#666666;");var s=KupeParams.doors[a].variantType==o[n].type?"#ff9e18":"#ffffff";t+="border-"+(0==i?"left":"right")+":2px solid "+s+";border-top:2px solid "+s+";border-bottom:2px solid "+s+";",t+='" ',0==i&&(t+=" align=center"),t+=' onclick=\'Planner3dKupeConstructor.OnClickSmallButt(event,"set_variant","'+o[n].type+'","'+a+"\")'>",t+=0==i?'<img src="'+HostImgs+"icon_door_variant_"+o[n].type+'.gif" width=36 height=36 border=0>':1==o[n].type?o[n].type+" секция":o[n].type+" секции",t+="</td>"}t+="</tr>"}t+="</table>",e.innerHTML=t}function showPopupMenu(e,a){if(null!=hideTimeout&&(clearTimeout(hideTimeout),hideTimeout=null),!(0==showPopupMenu.arguments.length||e instanceof Event)&&cPopupMenu!=e){cPopupMenu=e,"door_"==cPopupMenu.substring(0,5)||"mat_"==cPopupMenu.substring(0,4)||"dsb_"==cPopupMenu.substring(0,4)?("mat_"==cPopupMenu.substring(0,4)&&(document.getElementById("Planner3d_ProfileVariantsDiv").style.visibility="hidden",document.getElementById("Planner3d_LampVariantsDiv").style.visibility="hidden"),document.getElementById("Planner3d_TabInfo1").style.visibility="mat_"!=cPopupMenu.substring(0,4)?"hidden":"visible",document.getElementById("Planner3d_TabInfo2").style.visibility="mat_"!=cPopupMenu.substring(0,4)?"hidden":"visible"):"ds_"==cPopupMenu.substring(0,3)&&(document.getElementById("Planner3d_ProfileVariantsDiv").style.visibility="visible",document.getElementById("Planner3d_LampVariantsDiv").style.visibility="visible",document.getElementById("Planner3d_TabInfo1").style.visibility="visible",document.getElementById("Planner3d_TabInfo2").style.visibility="visible");var t=PopupMenuDiv;if(t.style.display="block","door_"==cPopupMenu.substring(0,5)){CreateDoorPopup(t,parseInt(cPopupMenu.substring(5)));var r=getGlobalOffsetX(a,MainDiv),o=document.getElementById("Planner3d_KorpusVariantsDiv");r+t.offsetWidth>getGlobalOffsetX(o,MainDiv)+o.offsetWidth-1&&(r=getGlobalOffsetX(o,MainDiv)+o.offsetWidth-t.offsetWidth-1),t.style.left=r+"px",t.style.top=getGlobalOffsetY(o,MainDiv)+o.offsetHeight+"px"}else if("mat_"==cPopupMenu.substring(0,4)){var n=GetMaterial(cPopupMenu.substring(4));if(void 0!=n){var i='<div style="width:149px;height:89px;background-image:url('+HostIcons+n.icon+');"></div>';i+='<div style="width:149px;text-align:center;font-family:Arial;font-size:9px;color:#666666;">'+n.description+"</div>",t.innerHTML=i}t.style.left=getGlobalOffsetX(document.getElementById("Planner3d_LampVariantsDiv"),MainDiv)+44+"px",t.style.top=getGlobalOffsetY(document.getElementById("Planner3d_LampVariantsDiv"),MainDiv)+25+"px"}else if("ds_"==cPopupMenu.substring(0,3)){var s=parseInt(cPopupMenu.substring(3)),i='<table cellpadding=0 cellspacing=0 style="background-color:#FFFFFF"><tr>',l=GetDoorByType(KupeParams.DoorsType),d=GetDoorVariants(l);if(l)for(var p=0;d.length>p;p++)i+="<td height=30 valign=middle",KupeParams.doors[iActiveDoor].variantType==d[p].type&&(i+=' style="border:2px solid #ff9e18;"'),i+='><img src="'+HostImgs+"icon_door_variant_"+d[p].type+'_sm.gif" style="cursor:pointer" width=20 height=24 border=0 onclick=\'Planner3dKupeConstructor.OnClickSmallButt(event,"set_variant","'+d[p].type+'","'+s+"\")'></td>";i+="</tr></table>",t.innerHTML=i}else if("dsb_"==cPopupMenu.substring(0,4)){CreateDsbPopup(t,parseInt(cPopupMenu.substring(4)));var r=getGlobalOffsetX(a,MainDiv),o=document.getElementById("Planner3d_KorpusVariantsDiv");r+t.offsetWidth>getGlobalOffsetX(o,MainDiv)+o.offsetWidth&&(r=getGlobalOffsetX(o,MainDiv)+o.offsetWidth-t.offsetWidth),t.style.left=r+"px",t.style.top=getGlobalOffsetY(o,MainDiv)+o.offsetHeight+"px"}}}function ClearPlayTimeInterval(){playTimeInterval&&(clearInterval(playTimeInterval),playTimeInterval=null)}function OnPressSmallButtRotateL(event,idStr){ClearPlayTimeInterval(),(""==idStr||"RotateR"==idStr)&&(targetRotation=-camera.rotation.y),eval("ProcessPressAction('"+idStr+"')"),playTimeInterval=setInterval("ProcessPressAction('"+idStr+"')",30)}function OnPressSmallButtRotateL(){ClearPlayTimeInterval(),targetRotation=-camera.rotation.y,document.addEventListener("mouseup",OnReleaseSmallButt,!1),ProcessPressActionRotateL(),playTimeInterval=setInterval(ProcessPressActionRotateL,30)}function OnPressSmallButtRotateR(){ClearPlayTimeInterval(),targetRotation=-camera.rotation.y,document.addEventListener("mouseup",OnReleaseSmallButt,!1),ProcessPressActionRotateR(),playTimeInterval=setInterval(ProcessPressActionRotateR,30)}function OnPressSmallButtZoomIn(){ClearPlayTimeInterval(),document.addEventListener("mouseup",OnReleaseSmallButt,!1),ProcessPressActionZoomIn(),playTimeInterval=setInterval(ProcessPressActionZoomIn,30)}function OnPressSmallButtZoomOut(){ClearPlayTimeInterval(),document.addEventListener("mouseup",OnReleaseSmallButt,!1),ProcessPressActionZoomOut(),playTimeInterval=setInterval(ProcessPressActionZoomOut,30)}function ProcessPressActionRotateR(){targetRotation+=.2}function ProcessPressActionRotateL(){targetRotation-=.2}function ProcessPressActionZoomIn(){cameraDistance*=1-Math.min(.2,.0025)}function ProcessPressActionZoomOut(){cameraDistance/=1-Math.min(.2,.0025)}function OnReleaseSmallButt(){document.removeEventListener("mouseup",OnReleaseSmallButt,!1),ClearPlayTimeInterval()}function OnClickSmallButtColorPicker(e){OnClickSmallButt(e,"colorpicker",0)}function OnClickSmallButt(e,a,t,r){if("set_variant"==a){KupeParams.doors[r].variantType=t,UpdateKupeDoor(r);var o=cPopupMenu;cPopupMenu=void 0,void 0!=o&&"dsb_"==o.substring(0,4)?(cPopupMenu=o,CreateDsbPopup(PopupMenuDiv,parseInt(cPopupMenu.substring(4)))):showPopupMenu(o),UpdateKorpusesDiv(),UpdatePrice()}else"colorpicker"==a&&iActiveDoorSection>=0&&KupeParams.doors[iActiveDoor].sections.length>iActiveDoorSection&&(CurrentVstavkaMaterial=KupeParams.doors[iActiveDoor].materials[iActiveDoorSection],ActivateTab(iActiveTab))}function stopStart(e){e.preventDefault(),e.stopPropagation()}function _onFinishStart(){return!1}function onDragMatStart(e,a){LoadMaterialByName(e),a.dataTransfer.setData("text",e),curDragMat=e,a.stopPropagation()}function onDragMatEnd(){curDragMat=""}function onDropHandler(e){var a=e.pageX-getGlobalOffsetX(MainDiv),t=e.pageY-getGlobalOffsetY(MainDiv);if(a>=0&&Window3dWidth>a&&t>=0&&Window3dHeight>t){mouse2D.x=2*(a/Window3dWidth)-1,mouse2D.y=2*-(t/Window3dHeight)+1,raycaster=projector.pickingRay(mouse2D.clone(),camera);var r=raycaster.intersectObjects(scene.children,!0);if(r.length&&r[0].object.parent==Korpus3dHolder)return;if(r.length)for(var o=0;KupeParams.nDoors>o;o++)if(r[0].object.parent==Doors3dHolders[o]){var n=GetDoorByType(KupeParams.DoorsType);if(void 0!=n)for(var i=0;KupeParams.doors[o].sections.length>i;i++)if(r[0].object==Doors3dHolders[o].children[1+i]){var s=GetVstavkaPossibleMaterials(KupeParams.DoorsType,KupeParams.doors[o].variantType,i);ArrayHasItem(s,curDragMat)&&(KupeParams.doors[o].materials[i]=curDragMat,UpdateKupeDoorMaterial(o,i),UpdatePrice());break}return}}}function onDragOver(e){if(e.dataTransfer.getData("text"),e.dataTransfer.dropEffect="none",curDragMat&&curDragMat.length){e.preventDefault&&e.preventDefault();var a=e.pageX-getGlobalOffsetX(MainDiv),t=e.pageY-getGlobalOffsetY(MainDiv);if(a>=0&&Window3dWidth>a&&t>=0&&Window3dHeight>t){mouse2D.x=2*(a/Window3dWidth)-1,mouse2D.y=2*-(t/Window3dHeight)+1,raycaster=projector.pickingRay(mouse2D.clone(),camera);var r=raycaster.intersectObjects(scene.children,!0);if(r.length&&r[0].object.parent!=Korpus3dHolder)for(var o=0;KupeParams.nDoors>o;o++)if(r[0].object.parent==Doors3dHolders[o]){var n=GetDoorByType(KupeParams.DoorsType);if(void 0!=n)for(var i=0;KupeParams.doors[o].sections.length>i;i++)if(r[0].object==Doors3dHolders[o].children[1+i]){var s=GetVstavkaPossibleMaterials(KupeParams.DoorsType,KupeParams.doors[o].variantType,i);ArrayHasItem(s,curDragMat)&&(e.dataTransfer.dropEffect="copy");break}return}}}}function onDragEnter(e){return curDragMat&&curDragMat.length?(e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="copy"):e.dataTransfer.dropEffect="none",!1}function Project3dPointTo2d(e,a,t){var r=projector.projectVector(new THREE.Vector3(e,a,t),camera);return{x:Math.round(.5*r.x*Window3dWidth+Window3dWidth/2),y:Math.round(Window3dHeight/2-.5*r.y*Window3dHeight)}}function animate(){if(requestAnimationFrame(animate),render(),2==iActiveTab)if(Doors3dHolders[0].children.length>0&&iActiveDoor>=0){if(void 0!=cPopupMenu&&"ds_"==cPopupMenu.substring(0,3)){Doors3dHolders[iActiveDoor].children[0].geometry.computeBoundingBox();var e=Doors3dHolders[iActiveDoor].children[0].geometry.boundingBox,a=Project3dPointTo2d(.5*(e.min.x+e.max.x)+Doors3dHolders[iActiveDoor].position.x,e.max.y+Doors3dHolders[iActiveDoor].position.y,e.max.z+Doors3dHolders[iActiveDoor].position.z),t=PopupMenuDiv;0>a.x-30&&(a.x=30),a.x+30>=Window3dWidth&&(a.x=Window3dWidth-30),16>a.y&&(a.y=16),a.y+28>=Window3dHeight&&(a.y=Window3dHeight-28),t.style.left=a.x-30+"px",t.style.top=Math.round(a.y-16)+"px"}if(iActiveDoorSection>=0&&KupeParams.doors[iActiveDoor].sections.length>iActiveDoorSection){Doors3dHolders[iActiveDoor].children[1+iActiveDoorSection].geometry.computeBoundingBox();var e=Doors3dHolders[iActiveDoor].children[1+iActiveDoorSection].geometry.boundingBox,a=Project3dPointTo2d(e.min.x+Doors3dHolders[iActiveDoor].position.x,e.min.y+Doors3dHolders[iActiveDoor].position.y,e.max.z+Doors3dHolders[iActiveDoor].position.z);ButtColorPicker.style.left=a.x+"px",ButtColorPicker.style.top=Math.round(a.y-26)+"px",ButtColorPicker.style.display="block"}else ButtColorPicker.style.display="none"}else ButtColorPicker.style.display="none";stats&&stats.update()}function render(){var e=NormAngle(camera.rotation.y+.05*(-targetRotation-camera.rotation.y));camera.rotation.y=Math.abs(e)>1.483529886111111?3.1415927*(e>0?1:-1)/2*(17/18):e;var a=Math.sin(camera.rotation.y),t=Math.cos(camera.rotation.y);2>cameraDistance?cameraDistance=2:cameraDistance>25&&(cameraDistance=25),camera.position.x=a*cameraDistance+cameraXshift*t,camera.position.z=t*cameraDistance-cameraXshift*a,renderer.render(scene,camera)}var container,stats,mouse2D,camera,scene,renderer,cameraDistance=15,cameraXshift=0,stats,mouseX=0,mouseY=0,raycaster,projector,Window3dWidth=430,Window3dHeight=450,windowHalfX=Window3dWidth/2,windowHalfY=Window3dHeight/2,iconSize=50,bMouseMoveBetweenClick,bMouseNavigationActive=0,targetRotation=0,targetRotationOnMouseDown=0,mouseXOnMouseDown=0,MainJsonData=null,Korpus3dHolder,Lamp3dHolder,Doors3dHolders=[],Doors3dHoldersMax=3,CurrentVstavkaMaterial,ProblemVstavkaMaterials=[],KupeParams={};KupeParams.nDoors=0;var iActiveDoor=0,iActiveDoorSection=-1;KupeParams.doors=[];var hideTimeout=null,cPopupMenu,progDAnim=null,MSIE=0,MainDiv=null,PopupMenuDiv=null,ButtColorPicker=null,StartKupeSetId,MainJsonText,MatLib=[],iActiveTab=1,bPanActive=0,fPanDistance,last_pan_X,last_pan_Y,playTimeInterval=null,curDragMat=0;return{Initialize:Initialize,Uninitialize:Uninitialize,GetBasketContent:GetBasketContent,SetKorpusMaterial:SetKorpusMaterial,SetCurrentVstavkaMaterial:SetCurrentVstavkaMaterial,SetProfileMaterial:SetProfileMaterial,SetKorpus:SetKorpus,OnClickSmallButt:OnClickSmallButt,showPopupMenu:showPopupMenu,OnPopupOut:OnPopupOut,stopStart:stopStart,onDragMatStart:onDragMatStart,onDragMatEnd:onDragMatEnd}},DAnimProgressBar=function(e){function a(e,a,t,r,o,n){e.beginPath(),e.moveTo(a+n,t),e.lineTo(a+r-n,t),e.arc(a+r-n,t+n,n,-Math.PI/2,Math.PI/2,!1),e.lineTo(a+n,t+o),e.arc(a+n,t+n,n,Math.PI/2,3*Math.PI/2,!1),e.closePath(),e.fill()}function t(e,t,r,o,n,i){e.save(),e.shadowOffsetX=2,e.shadowOffsetY=2,e.shadowBlur=5,e.shadowColor="#666",e.fillStyle="rgba(189,189,189,1)",a(e,t,r,o,n,i),e.shadowColor="rgba(0,0,0,0)";var s=e.createLinearGradient(0,r+n,0,0);s.addColorStop(0,"rgba(255,255,255, 0.1)"),s.addColorStop(.4,"rgba(255,255,255, 0.7)"),s.addColorStop(1,"rgba(255,255,255,0.4)"),e.fillStyle=s,a(e,t,r,o,n,i),e.fillStyle="white",e.restore()}function r(e,a,t,r,o,n,i){var s=0;e.beginPath(),n>r?(s=n-Math.sqrt(Math.pow(n,2)-Math.pow(n-r,2)),e.moveTo(a+r,t+s),e.lineTo(a+r,t+o-s),e.arc(a+n,t+n,n,Math.PI-Math.acos((n-r)/n),Math.PI+Math.acos((n-r)/n),!1)):r+n>i?(s=n-Math.sqrt(Math.pow(n,2)-Math.pow(n-(i-r),2)),e.moveTo(a+n,t),e.lineTo(a+r,t),e.arc(a+i-n,t+n,n,-Math.PI/2,-Math.acos((n-(i-r))/n),!1),e.lineTo(a+r,t+o-s),e.arc(a+i-n,t+n,n,Math.acos((n-(i-r))/n),Math.PI/2,!1),e.lineTo(a+n,t+o),e.arc(a+n,t+n,n,Math.PI/2,3*Math.PI/2,!1)):(e.moveTo(a+n,t),e.lineTo(a+r,t),e.lineTo(a+r,t+o),e.lineTo(a+n,t+o),e.arc(a+n,t+n,n,Math.PI/2,3*Math.PI/2,!1)),e.closePath(),e.fill(),i-1>r&&(e.save(),e.shadowOffsetX=1,e.shadowBlur=1,e.shadowColor="#666",r+n>i&&(s+=1),e.fillRect(a+r,t+s,1,l-2*s),e.restore())}function o(e,a,t,r,o,n,i){e.save(),e.fillStyle="white";var s=Math.floor(100*(r/i))+"%",l=e.measureText(s).width,d=a+r-l-n/2;n+l>=r&&(d=a+n/2),e.fillText(s,d,t+22),e.restore()}var n=null,i=null,s=300,l=34,d=20,p=20,u=l/2,c=e,m=function(){n.style.display="none"},f=function(e,a,t){if(n=document.createElement(c?"DIV":"canvas"),c||(n.width=500,n.height=150),n.style.position="absolute",n.style.left=Math.floor((a-s)/2)+"px",n.style.top=Math.floor((t-l)/2)+"px",e.appendChild(n),c&&(n.style.width=s+"px",n.style.height=l/2+"px",n.style.overflow="hidden",n.style.borderColor="#000000",n.style.borderWidth="1px",n.style.borderStyle="solid",n.style.backgroundColor="#FFFFFF",n.innerHTML='<DIV style="background-color:#ADD9FF;width:0px;height:'+l/2+'px;"></DIV>'),!c){if(!n||!n.getContext)return;if(i=n.getContext("2d"),!i)return;i.font="16px Verdana";var r=i.createLinearGradient(0,p+l,0,0);r.addColorStop(0,"#4DA4F3"),r.addColorStop(.4,"#ADD9FF"),r.addColorStop(1,"#9ED1FF"),i.fillStyle=r}v(0)},v=function(e){if(c){var a=n.children(0);a&&(a.style.width=e+"px")}else i.clearRect(d-5,p-5,s+15,l+15),t(i,d,p,s,l,u),r(i,d,p,e,l,u,s),o(i,d,p,e,l,u,s)};return{width:s,height:l,Initialize:f,Uninitialize:m,doDraw:v}};