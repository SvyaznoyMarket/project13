var DKupe3dConstructor=function(ParentItem,HostImgs,HostTextures,HostIcons){function Initialize(e,t){StartKupeSetId=t;var a=navigator.userAgent.match(/MSIE ([\d\.]+)/);a&&(MSIE=parseFloat(a[1])),MainDiv=document.createElement("DIV"),MainDiv.setAttribute("id","Planner3d_MainDiv"),MainDiv.style.position="relative",ParentItem.appendChild(MainDiv),MainDiv.innerHTML='<div id="Planner3d_tab_info" style="color: #666666;font-family:\'Enter Type Bold\';font-size:18px;position: absolute;top: 0px;left: 50%;width: 200px;position:absolute;z-index: 1;display:none;">	<table cellpadding=0 cellspacing=0 width=250>	<tr><td height=25 id=Planner3d_TabInfo1Header width=120 align=center>Выбор корпуса</td><td height=25 width=5>&nbsp;</td><td id=Planner3d_TabInfo2Header width=120 align=center>Выбор фасада</td></tr>	<tr><td id=Planner3d_KorpusVariantsDiv height=80 colspan=3 style="padding-left:5px;border:1px solid #c1c1bf;"></td></tr>	<tr><td id=Planner3d_TabInfo colspan=3 height=183 valign=top style="padding-top:5px;padding-bottom:5px;padding-left:5px;border-left:1px solid #c1c1bf;border-right:1px solid #c1c1bf;border-bottom:1px solid #c1c1bf;">	<div id=Planner3d_TabInfo1 style="display:none;">&nbsp;</div><div id=Planner3d_TabInfo2 style="display:none;">	<font style="font-family:\'Enter Type\';color:#000000;font-size:13px;">Выбор цвета вставки</font><br>	<div id="Planner3d_scrollcontent"></div></div></td></tr>	<tr><td id=Planner3d_LampVariantsDiv height=80 colspan=4 style="padding-left:5px;border-left:1px solid #c1c1bf;border-right:1px solid #c1c1bf;border-bottom:1px solid #c1c1bf;"></td></tr>	<tr><td id=Planner3d_ProfileVariantsDiv height=80 colspan=4 style="padding-left:5px;border-left:1px solid #c1c1bf;border-right:1px solid #c1c1bf;border-bottom:1px solid #c1c1bf;"></td></tr>	</table></div>',document.getElementById("Planner3d_TabInfo1Header").addEventListener("click",ActivateTab1,!1),document.getElementById("Planner3d_TabInfo2Header").addEventListener("click",ActivateTab2,!1),PopupMenuDiv=document.createElement("DIV"),PopupMenuDiv.style.position="absolute",PopupMenuDiv.style.zIndex="2",PopupMenuDiv.style.display="none",PopupMenuDiv.addEventListener("mouseover",showPopupMenu,!1),PopupMenuDiv.addEventListener("mouseout",OnPopupOut,!1),MainDiv.appendChild(PopupMenuDiv),ButtColorPicker=document.createElement("DIV"),ButtColorPicker.style.position="absolute",ButtColorPicker.style.cursor="pointer",ButtColorPicker.style.display="none",ButtColorPicker.innerHTML='<img src="'+HostImgs+'icon_colorpicker.png" width=27 height=26 border=0>',ButtColorPicker.addEventListener("mousedown",stopStart,!1),ButtColorPicker.addEventListener("click",OnClickSmallButtColorPicker,!1),MainDiv.appendChild(ButtColorPicker),progDAnim=new DAnimProgressBar(0),progDAnim.Initialize(MainDiv,Window3dWidth,Window3dHeight);var o=new XMLHttpRequest;o.addEventListener("load",onMainData,!1),o.addEventListener("progress",onMainDataProgress,!1),o.open("GET",e,!0),o.send(null)}function Uninitialize(){}function onMainData(e){progDAnim&&progDAnim.doDraw(progDAnim.width),MainJsonText=e.target.responseText,setTimeout(init,1)}function onMainDataProgress(e){e.lengthComputable&&(e.loaded/e.total,progDAnim&&progDAnim.doDraw(progDAnim.width*e.loaded/e.total))}function ArrayHasItem(e,t){for(var a=0;e.length>a;a++)if(e[a]==t)return 1;return 0}function NormAngle(e){for(var t=e;Math.abs(t)>3.1415927;)t>0?t-=6.2831852:t+=6.2831852;return t}function rgb2hex(e){return(255*e[0]<<16)+(255*e[1]<<8)+255*e[2]}function LoadMaterialByName(e){if(void 0!==MatLib[e])return MatLib[e];var t=GetMaterial(e);if(t){var a=MyCreateMaterial(t);return MatLib[e]=a,a}var o={};return o.color=15790320,new THREE.MeshLambertMaterial(o)}function MyCreateMaterial(e){var t={};if(!e.colorDiffuse||e.mapDiffuse&&e.mapDiffuse.length||(t.color=rgb2hex(e.colorDiffuse)),e.colorSpecular&&(t.specular=rgb2hex(e.colorSpecular)),e.colorAmbient&&(t.ambient=rgb2hex(e.colorAmbient)),e.transparency&&(t.opacity=e.transparency),e.specularCoef&&(t.shininess=e.specularCoef),e.mapDiffuse&&(t.map=THREE.ImageUtils.loadTexture(HostTextures+e.mapDiffuse),t.map.wrapS=THREE.RepeatWrapping,t.map.wrapT=THREE.RepeatWrapping,e.mapDiffuseScale&&t.map.repeat.set(e.mapDiffuseScale[0],e.mapDiffuseScale[1]),e.mapDiffuseOffset&&t.map.offset.set(e.mapDiffuseOffset[0],e.mapDiffuseOffset[1])),e.cubeMap){var a=THREE.ImageUtils.loadTextureCube(e.cubeMap);a.format=THREE.RGBFormat,t.envMap=a,t.combine=THREE.MixOperation,t.reflectivity=.3}return new THREE.MeshPhongMaterial(t)}function FindAllArts(e,t){for(var a=0;t.length>a;a++){var o=t[a].api_id;if(o.length){var r=o.indexOf("/");r>0&&(o=o.substring(0,r)),ArrayHasItem(e,o)||e.push(o)}}}function init(){if(MainJsonData=JSON.parse(MainJsonText)){if(!MSIE||MSIE>=11){var e=document.createElement("DIV");e.setAttribute("id","RotateL"),e.innerHTML='<img draggable="false" src="'+HostImgs+'rotate_left.png" width=35 height=43 border=0>',MainDiv.appendChild(e),e.addEventListener("mousedown",OnPressSmallButtRotateL,!1),e.style.position="absolute",e.style.cursor="pointer";var t=document.createElement("DIV");t.setAttribute("id","RotateC"),t.innerHTML='<img draggable="false" src="'+HostImgs+'rotate_center.png" width=51 height=47 border=0>',MainDiv.appendChild(t),t.style.position="absolute";var a=document.createElement("DIV");a.setAttribute("id","RotateR"),a.innerHTML='<img draggable="false" src="'+HostImgs+'rotate_right.png" width=35 height=43 border=0>',MainDiv.appendChild(a),a.addEventListener("mousedown",OnPressSmallButtRotateR,!1),a.style.position="absolute",a.style.cursor="pointer";var o=document.createElement("DIV");o.setAttribute("id","ZoomOut"),o.innerHTML='<img draggable="false" src="'+HostImgs+'zoom_out.png" width=41 height=39 border=0>',MainDiv.appendChild(o),o.addEventListener("mousedown",OnPressSmallButtZoomOut,!1),o.style.position="absolute",o.style.cursor="pointer";var r=document.createElement("DIV");r.setAttribute("id","ZoomIn"),r.innerHTML='<img draggable="false" src="'+HostImgs+'zoom_in.png" width=41 height=39 border=0>',MainDiv.appendChild(r),r.addEventListener("mousedown",OnPressSmallButtZoomIn,!1),r.style.position="absolute",r.style.cursor="pointer",e.style.top=Window3dHeight+10+"px",e.style.left=Window3dWidth/2-20-35+"px",a.style.top=Window3dHeight+10+"px",a.style.left=Window3dWidth/2+33+"px",t.style.left=Window3dWidth/2-20+"px",t.style.top=Window3dHeight+10+"px",o.style.left="0px",o.style.top="0px",r.style.left="0px",r.style.top="50px"}if(MainJsonData.articuls){for(var n=[],i=0;MainJsonData.korpuses.length>i;i++)for(var s=0;MainJsonData.articuls.korpuses.length>s;s++)if(MainJsonData.korpuses[i].name==MainJsonData.articuls.korpuses[s].name){n.push(MainJsonData.korpuses[i]);break}MainJsonData.korpuses=n}MainJsonText=void 0,progDAnim&&progDAnim.Uninitialize(),container=document.createElement("div"),MainDiv.appendChild(container),document.body.addEventListener("drop",onDropHandler,!1),document.body.addEventListener("dragenter",onDragEnter,!1),document.body.addEventListener("dragover",onDragOver,!1),camera=new THREE.PerspectiveCamera(10,Window3dWidth/Window3dHeight,1,2e3),camera.position.x=0,camera.position.y=1.2,camera.position.z=cameraDistance,scene=new THREE.Scene;var l=new THREE.AmbientLight(5000268);scene.add(l);var d=new THREE.DirectionalLight(10066329);d.position.set(1,0,0).normalize(),scene.add(d);var u=new THREE.DirectionalLight(8355711);u.position.set(-1,0,0).normalize(),scene.add(u);var p=new THREE.DirectionalLight(5855577);p.position.set(0,1,0).normalize(),scene.add(p);var c=new THREE.DirectionalLight(7500402);c.position.set(0,-1,0).normalize(),scene.add(c);var m=new THREE.DirectionalLight(10066329);m.position.set(0,0,1).normalize(),scene.add(m);var f=new THREE.DirectionalLight(10066329);f.position.set(0,0,-1).normalize(),scene.add(f);var v=new THREE.CubeGeometry(600,600,5);floormesh=new THREE.Mesh(v,new THREE.MeshBasicMaterial({color:13421772})),floormesh.position.y=-2.5,floormesh.rotation.x=90*Math.PI/180,Korpus3dHolder=new THREE.Object3D,scene.add(Korpus3dHolder),Lamp3dHolder=new THREE.Object3D,scene.add(Lamp3dHolder);for(var i=0;Doors3dHoldersMax>i;i++){var h=new THREE.Object3D;Doors3dHolders[i]=h,scene.add(h)}for(var i=0;Doors3dHoldersMax>i;i++)KupeParams.doors[i]={},KupeParams.doors[i].materials=["","","",""];if(projector=new THREE.Projector,mouse2D=new THREE.Vector3(0,1e4,.5),loader=new THREE.JSONLoader,void 0!=StartKupeSetId&&null!=StartKupeSetId&&MainJsonData.sets)for(var i=0;MainJsonData.sets.length>i;i++)if(MainJsonData.sets[i].set_id==StartKupeSetId){KupeParams.KorpusName=MainJsonData.sets[i].KorpusName,KupeParams.KorpusMaterial=MainJsonData.sets[i].KorpusMaterial,KupeParams.ProfileMaterial=MainJsonData.sets[i].ProfileMaterial;for(var g=0;MainJsonData.sets[i].doors.length>g;g++)KupeParams.doors[g].variantType=MainJsonData.sets[i].doors[g].type,KupeParams.doors[g].materials=MainJsonData.sets[i].doors[g].colors;break}void 0==KupeParams.KorpusName&&(KupeParams.KorpusName=MainJsonData.korpuses[0].name),void 0==KupeParams.KorpusMaterial&&(KupeParams.KorpusMaterial=GetKorpusPossibleMaterials(KupeParams.KorpusName)[0]),void 0==KupeParams.ProfileMaterial&&(KupeParams.ProfileMaterial=GetProfilePossibleMaterials(KupeParams.KorpusName)[0]),void 0==KupeParams.Lamp&&(KupeParams.Lamp=0),CreateFullKupe(),UpdateKorpusesDiv();var D=document.getElementById("Planner3d_tab_info");if(D.style.display="block",D.style.left=Window3dWidth+20+"px",D.style.height=Window3dHeight+"px",ActivateTab(1),renderer=!MSIE||MSIE>=11?new THREE.WebGLRenderer({antialias:!0}):new THREE.CanvasRenderer,renderer.setSize(Window3dWidth,Window3dHeight),container.appendChild(renderer.domElement),renderer.domElement.style.borderBottom="2px solid #c1c1bf",stats=null,MainDiv.addEventListener("mousewheel",onMouseWheel,!1),MainDiv.addEventListener("mousedown",onDocumentMouseDown,!1),MainDiv.addEventListener("touchstart",onDocumentTouchStart,!1),MainDiv.addEventListener("touchmove",onDocumentTouchMove,!1),document.addEventListener("mousemove",onDocumentMouseMove,!1),document.onselectstart=_onFinishStart,document.oncontextmenu=_onFinishStart,animate(),MainJsonData.articuls){for(var M=[],P=0;MainJsonData.articuls.korpuses.length>P;P++)FindAllArts(M,MainJsonData.articuls.korpuses[P].variants);for(var y=0;MainJsonData.articuls.vstavki.length>y;y++)FindAllArts(M,MainJsonData.articuls.vstavki[y].variants);for(var b=0;MainJsonData.articuls.profiles.length>b;b++)FindAllArts(M,MainJsonData.articuls.profiles[b].variants);for(var s=0;MainJsonData.articuls.doors.length>s;s++)for(var w=0;MainJsonData.articuls.doors[s].types.length>w;w++)FindAllArts(M,MainJsonData.articuls.doors[s].types[w].variants);Planner3d_Init(M),UpdatePrice()}}}function AppendSceneApiIdsIds(e,t,a){for(var o=0;t.length>o;o++)if(t[o].color==a){var r=t[o].api_id;if(r.length){var n=r.indexOf("/");if(n>0&&"/2"==r.substring(n))for(var i=0;e.length>i;i++)if(e[i]==r)return e[i]=r.substring(0,n),void 0;e.push(r)}}}function GetSceneApiIds(){for(var e=[],t=0;MainJsonData.articuls.korpuses.length>t;t++)if(MainJsonData.articuls.korpuses[t].name==KupeParams.KorpusName){AppendSceneApiIdsIds(e,MainJsonData.articuls.korpuses[t].variants,KupeParams.KorpusMaterial);break}var a=GetKorpusByName(KupeParams.KorpusName);if(a){for(var t=0;MainJsonData.articuls.profiles.length>t;t++)if(a.width==MainJsonData.articuls.profiles[t].width){AppendSceneApiIdsIds(e,MainJsonData.articuls.profiles[t].variants,KupeParams.ProfileMaterial);break}for(var t=0;MainJsonData.articuls.doors.length>t;t++)if(MainJsonData.articuls.doors[t].name==a.doors.type){for(var o=0;KupeParams.nDoors>o;o++)for(var r=0;MainJsonData.articuls.doors[t].types.length>r;r++)if(MainJsonData.articuls.doors[t].types[r].type==KupeParams.doors[o].variantType){AppendSceneApiIdsIds(e,MainJsonData.articuls.doors[t].types[r].variants,KupeParams.ProfileMaterial);break}break}var n=GetDoorByType(KupeParams.DoorsType);if(n)for(var o=0;KupeParams.nDoors>o;o++){for(var i=null,s=0;n.variants.length>s&&null==i;s++)n.variants[s].type==KupeParams.doors[o].variantType&&(i=n.variants[s].sections);if(i)for(var l=0;KupeParams.doors[o].sections.length>l;l++)for(var d=0;MainJsonData.articuls.vstavki.length>d;d++)if(MainJsonData.articuls.vstavki[d].width==n.width&&MainJsonData.articuls.vstavki[d].height==i[l].height){AppendSceneApiIdsIds(e,MainJsonData.articuls.vstavki[d].variants,KupeParams.doors[o].materials[l]);break}}}return e}function UpdatePrice(){var e=GetSceneApiIds(),t=ProblemVstavkaMaterials;ProblemVstavkaMaterials=[];for(var a=[],o=0;e.length>o;o++){var r=e[o],n=r.indexOf("/");if(n>0){a.push({id:parseInt(r.substring(0,n)),error:"Вставки продаютcя только комплектом по 2шт!"});for(var i=0;MainJsonData.articuls.vstavki.length>i;i++)for(var s=0;MainJsonData.articuls.vstavki[i].variants.length>s;s++)MainJsonData.articuls.vstavki[i].variants[s].api_id==r&&ProblemVstavkaMaterials.push(MainJsonData.articuls.vstavki[i].variants[s].color)}else a.push({id:parseInt(r),error:""})}if(Planner3d_UpdatePrice(a),2==iActiveTab&&(t.length||ProblemVstavkaMaterials.length)){var l=document.getElementById("Planner3d_scrollcontent").childNodes;if(l.length&&"TABLE"==l[l.length-1].tagName)for(var d=l[l.length-1].rows,u=0;d.length>u;u++)for(var p=d.item(u).cells,c=0;p.length>c;c++){var m=p.item(c);if(m&&m.childNodes.length&&"DIV"==m.childNodes[0].tagName&&"mat_"==m.childNodes[0].id.substring(0,4)){var f=!ArrayHasItem(ProblemVstavkaMaterials,m.childNodes[0].id.substring(4));f&&m.childNodes[0].childNodes.length?m.childNodes[0].innerHTML="":f||0!=m.childNodes[0].childNodes.length||(m.childNodes[0].innerHTML='<img draggable="false" src="'+HostImgs+'attention.gif" border=0>')}}}}function GetBasketContent(){for(var e=GetSceneApiIds(),t=[],a=0;e.length>a;a++){var o=e[a].indexOf("/"),r=parseInt(o>0?e[a].substring(0,o):e[a]);for(o=0;t.length>o;o++)if(t[o].id==r){t[o].quantity++;break}o==t.length&&t.push({id:r,quantity:1})}return t}function OnShapeLoaded(e,t,a,o){var r=new THREE.Mesh(a,new THREE.MeshFaceMaterial(o));if("Korpus"==e)Korpus3dHolder.add(r);else if("Lamp"==e)for(var n=0;Lamp3dHolder.children.length>n;n++)KupeParams.Lamp||(r.visible=!1),Lamp3dHolder.children[n].add(0==n?r:r.clone());else for(var n=0;Doors3dHoldersMax>n;n++)if(e=="Door"+n)return 1==iActiveTab&&(r.visible=!1),Doors3dHolders[n].add(r),void 0}function ActivateTab1(){ActivateTab(1)}function ActivateTab2(){ActivateTab(2)}function ActivateTab(e){iActiveTab=e,DoActivateTab("TabInfo"+e,"TabInfo"+(3-e));for(var t=0;KupeParams.nDoors>t;t++)for(var a=0;Doors3dHolders[t].children.length>a;a++)Doors3dHolders[t].children[a].visible=1==iActiveTab?!1:!0;1==iActiveTab&&(ButtColorPicker.style.display="none"),document.getElementById("Planner3d_KorpusVariantsDiv").height=1==iActiveTab?90:57,document.getElementById("Planner3d_TabInfo").height=1==iActiveTab?160:195;var o="";if(1==iActiveTab){o="<font style=\"font-family:'Enter Type';color:#000000;font-size:13px;\">Выбор цвета корпуса</font><br>",o+="<table cellpadding=0 cellspacing=0 onclick=\"Planner3dKupeConstructor.SetKorpusMaterial('',event)\">",o+="<tr>";for(var r=GetKorpusPossibleMaterials(KupeParams.KorpusName),a=0;r.length>a;a++){var n=GetMaterial(r[a]);n&&(o+="<td onmouseover=\"Planner3dKupeConstructor.showPopupMenu('mat_"+r[a]+'\')" onmouseout="Planner3dKupeConstructor.OnPopupOut()" width='+(iconSize+4)+" height="+(iconSize+4)+' valign=middle align=center style="',o+="border:2px solid "+(KupeParams.KorpusMaterial==r[a]?"#ff9e18;":"#ffffff;"),o+='">',o+='<div id="mat_'+r[a]+'" style="width:'+iconSize+"px;height:"+iconSize+"px;background-image:url("+HostIcons+n.icon+');cursor:pointer;" title="'+n.description+'"></div>',o+="</td>")}o+="</tr>",o+="</table>"}if(2==iActiveTab){o+="<table cellpadding=0 cellspacing=0 onclick=\"Planner3dKupeConstructor.SetCurrentVstavkaMaterial('',event)\">",o+="<tr>";var r=GetVstavkaPossibleMaterials(KupeParams.DoorsType);ArrayHasItem(r,CurrentVstavkaMaterial)||(CurrentVstavkaMaterial=r[0]);for(var a=0;r.length>a;a++){a>0&&0==a%4&&(o+="</tr><tr>");var n=GetMaterial(r[a]);n&&(o+="<td onmouseover=\"Planner3dKupeConstructor.showPopupMenu('mat_"+r[a]+'\')" onmouseout="Planner3dKupeConstructor.OnPopupOut()" width='+(iconSize+4)+" height="+(iconSize+4)+' valign=middle align=center style="',o+="border:2px solid "+(CurrentVstavkaMaterial==r[a]?"#ff9e18;":"#ffffff;"),o+='">',o+='<div draggable="true" id="mat_'+r[a]+'" style="width:'+iconSize+"px;height:"+iconSize+"px;background-image:url("+HostIcons+n.icon+');cursor:pointer;text-align:right;" ondragstart="Planner3dKupeConstructor.onDragMatStart(\''+r[a]+'\', event)" ondragend="Planner3dKupeConstructor.onDragMatEnd()"  title="'+n.description+'">',ArrayHasItem(ProblemVstavkaMaterials,r[a])&&(o+='<img draggable="false" src="'+HostImgs+'attention.gif" border=0>'),o+="</div>",o+="</td>")}o+="</tr>",o+="</table>"}1==iActiveTab?document.getElementById("Planner3d_TabInfo"+iActiveTab).innerHTML=o:document.getElementById("Planner3d_scrollcontent").innerHTML=o,o=1==iActiveTab?"<font style=\"font-family:'Enter Type';color:#000000;font-size:13px;\">Выбор цвета профиля</font><br>":"<font style=\"font-family:'Enter Type';color:#000000;font-size:13px;\">Выбор цвета рамки</font><br>",o+="<table cellpadding=0 cellspacing=0>",o+="<tr>";for(var r=GetProfilePossibleMaterials(KupeParams.KorpusName),a=0;r.length>a;a++){var i=50,s=42,n=GetMaterial(r[a]);n&&(o+="<td width="+(i+6)+" height="+(s+6)+' valign=middle align=center style="',o+=KupeParams.ProfileMaterial==r[a]?"border:2px solid #ff9e18;":"border:2px solid #ffffff;",o+='">',o+='<img ondragstart="Planner3dKupeConstructor.stopStart(event)" onclick="Planner3dKupeConstructor.SetProfileMaterial(\''+r[a]+"',event)\" width="+i+" height="+s+' src="'+HostIcons+n.icon+'" title="'+n.description+'">',o+="</td>")}o+="</tr>",o+="</table>",document.getElementById("Planner3d_ProfileVariantsDiv").innerHTML=o,GetKorpusByName(KupeParams.KorpusName),MainJsonData.articuls.lamps&&(o="<font style=\"font-family:'Enter Type';color:#000000;font-size:13px;\">Подсветка</font><br>",o+="<table cellpadding=0 cellspacing=0>",o+="<tr>",o+='<td valign=middle align=center style="',o+=KupeParams.Lamp?"border:2px solid #ff9e18;":"border:2px solid #ffffff;",o+='">',o+='<img ondragstart="Planner3dKupeConstructor.stopStart(event)" onclick="Planner3dKupeConstructor.SwitchLamp(event)" width='+i+" height="+s+' src="'+HostImgs+'lamp.png">',o+="</td>",o+="</tr>",o+="</table>",document.getElementById("Planner3d_LampVariantsDiv").innerHTML=o),UpdateKorpusesDiv()}function UnborderTableCells(e,t){for(var a=e.rows,o=0;a.length>o;o++)for(var r=a.item(o).cells,n=0;r.length>n;n++){var i=r.item(n);i&&i!=t&&(i.style.borderColor="#FFFFFF")}}function SetKorpusMaterial(e,t){if(SetKorpusMaterial.arguments.length>=2){if("DIV"!=t.target.tagName||"mat_"!=t.target.id.substring(0,4))return;e=t.target.id.substring(4)}var a=GetMaterial(e);if(a&&(Korpus3dHolder.children[0].material=LoadMaterialByName(e),KupeParams.KorpusMaterial=e,SetKorpusMaterial.arguments.length>=2)){var o=t.target?t.target.offsetParent:null;"TD"==o.tagName&&(UnborderTableCells(o.offsetParent,o),o.style.borderColor="#ff9e18")}SetKorpusMaterial.arguments.length>=2&&UpdatePrice()}function SetCurrentVstavkaMaterial(e,t){if(SetCurrentVstavkaMaterial.arguments.length>=2){var a=t.target;if("IMG"==a.tagName&&"DIV"==a.parentNode.tagName&&"mat_"==a.parentNode.id.substring(0,4)&&(a=a.parentNode),"DIV"!=a.tagName&&"IMG"!=a.tagName||"mat_"!=a.id.substring(0,4))return;e=a.id.substring(4),LoadMaterialByName(e),CurrentVstavkaMaterial=e;var o=a?a.offsetParent:null;o&&"TD"==o.tagName&&(UnborderTableCells(o.offsetParent,o),o.style.borderColor="#ff9e18")}else CurrentVstavkaMaterial=e}function SetProfileMaterial(e,t){var a=LoadMaterialByName(e);Korpus3dHolder.children[1].material=a,KupeParams.ProfileMaterial=e;for(var o=0;KupeParams.nDoors>o;o++)Doors3dHolders[o].children.length>0&&(Doors3dHolders[o].children[0].material=a);if(SetProfileMaterial.arguments.length>=2){var r=t.target?t.target.offsetParent:null;"TD"==r.tagName&&(UnborderTableCells(r.offsetParent,r),r.style.borderColor="#ff9e18"),UpdatePrice()}}function SwitchLamp(e){if(KupeParams.Lamp=1-KupeParams.Lamp,SwitchLamp.arguments.length>=1){var t=e.target?e.target.offsetParent:null;"TD"==t.tagName&&(t.style.borderColor=KupeParams.Lamp?"#ff9e18":"#ffffff")}for(var a=0;Lamp3dHolder.children.length>a;a++)for(var o=0;Lamp3dHolder.children[a].children.length>o;o++)Lamp3dHolder.children[a].children[o].visible=KupeParams.Lamp?!0:!1}function DoActivateTab(){for(var e=0;DoActivateTab.arguments.length>e;e++){var t=document.getElementById("Planner3d_"+DoActivateTab.arguments[e]),a=document.getElementById("Planner3d_"+DoActivateTab.arguments[e]+"Header");t&&a&&(a.style.borderBottom=0==e?"2px #ff9e18 solid":"0px",t.style.display=0==e?"block":"none",a.style.color=0==e?"#000000":"#666666",a.style.cursor=0==e?"default":"pointer",a.style.fontWeight=0==e?"bold":"normal")}}function GetKorpusPossibleMaterials(e){if(MainJsonData.articuls){for(var t=0;MainJsonData.articuls.korpuses.length>t;t++)if(MainJsonData.articuls.korpuses[t].name==e)return GetColorsArrayFromVariants(MainJsonData.articuls.korpuses[t].variants);return["oak_milk"]}return["oak_milk","oak_ferrara","apple_locarno"]}function GetVstavkaPossibleMaterials(e,t,a){var o=[];if(MainJsonData.articuls){var r=GetDoorByType(e),n=0;if(t)for(var i=GetDoorVariants(r),s=0;i.length>s;s++)if(i[s].type==t){n=i[s].sections[a].height;break}for(var l=[],d=0;MainJsonData.articuls.vstavki.length>d;d++)if(MainJsonData.articuls.vstavki[d].width==r.width&&(0==n||MainJsonData.articuls.vstavki[d].height==n))for(var u=0;MainJsonData.articuls.vstavki[d].variants.length>u;u++)ArrayHasItem(l,MainJsonData.articuls.vstavki[d].variants[u].color)||l.push(MainJsonData.articuls.vstavki[d].variants[u].color);for(var s=0;MainJsonData.materials.length>s;s++)ArrayHasItem(l,MainJsonData.materials[s].name)&&o.push(MainJsonData.materials[s].name)}else for(var s=0;MainJsonData.materials.length>s;s++)0!=MainJsonData.materials[s].name.indexOf("Profile")&&o.push(MainJsonData.materials[s].name);return o}function GetColorsArrayFromVariants(e){for(var t=[],a=0;e.length>a;a++)t.push(e[a].color);return t}function GetProfilePossibleMaterials(e){if(MainJsonData.articuls){var t=GetKorpusByName(e);if(t)for(var a=0;MainJsonData.articuls.profiles.length>a;a++)if(t.width==MainJsonData.articuls.profiles[a].width)return GetColorsArrayFromVariants(MainJsonData.articuls.profiles[a].variants);return["ProfileSilver"]}return["ProfileSilver","ProfileBronza","ProfileZoloto","ProfileShampan"]}function GetMaterial(e){for(var t=0;MainJsonData.materials.length>t;t++)if(MainJsonData.materials[t].name==e)return MainJsonData.materials[t]}function GetDoorVariant(e,t){if(void 0!=e)for(var a=0;t.length>a;a++)if(t[a].type==e)return t[a]}function GetKorpusByName(e){for(var t=0;MainJsonData.korpuses.length>t;t++)if(MainJsonData.korpuses[t].name==e)return MainJsonData.korpuses[t]}function GetDoorByType(e){for(var t=0;MainJsonData.doors.length>t;t++)if(MainJsonData.doors[t].type==e)return MainJsonData.doors[t]}function ClearChildren(e){for(var t=e.children.length-1;t>=0;t--)e.remove(e.children[t])}function GetDoorVariants(e){if(MainJsonData.articuls){for(var t=[],a=0;MainJsonData.articuls.doors.length>a;a++)if(MainJsonData.articuls.doors[a].name==e.type)for(var o=MainJsonData.articuls.doors[a].types,r=0;e.variants.length>r;r++)for(var n=0;o.length>n;n++)if(e.variants[r].type==o[n].type){t.push(e.variants[r]);break}return t}return e.variants}function UpdateKupeDoor(e){var t=GetKorpusByName(KupeParams.KorpusName);if(void 0!=t){var a=GetDoorByType(t.doors.type),o=GetDoorVariants(a);ClearChildren(Doors3dHolders[e]);var r=GetDoorVariant(KupeParams.doors[e].variantType,o);if(void 0!=r){KupeParams.doors[e].sections=r.sections;for(var n=0;KupeParams.doors[e].sections.length>n;n++){var i=GetVstavkaPossibleMaterials(KupeParams.DoorsType,KupeParams.doors[e].variantType,n);ArrayHasItem(i,KupeParams.doors[e].materials[n])||(KupeParams.doors[e].materials[n]=i[0])}Doors3dHolders[e].position.z=0==e%2?a.shiftSecondRail:0,Doors3dHolders[e].position.x=0==e?-.5*t.width+t.DspThickness+.5*a.width:e==t.doors.count-1?.5*t.width-t.DspThickness-.5*a.width:0;for(var s=0;r.shapes.length>s;s++)loader.createModel(r.shapes[s],function(t,a){OnShapeLoaded("Door"+e,s,t,a)},"");UpdateKupeDoorMaterial(e)}}}function UpdateKupeDoorMaterial(e,t){var a=Doors3dHolders[e].children;if(UpdateKupeDoorMaterial.arguments.length>=2)KupeParams.doors[e].sections.length>t&&a.length>t+1&&void 0!=KupeParams.doors[e].materials[t]&&KupeParams.doors[e].materials[t].length&&(a[1+t].material=LoadMaterialByName(KupeParams.doors[e].materials[t]));else{a.length&&void 0!=KupeParams.ProfileMaterial&&(a[0].material=LoadMaterialByName(KupeParams.ProfileMaterial));for(var o=0;KupeParams.doors[e].sections.length>o;o++)a.length>o+1&&void 0!=KupeParams.doors[e].materials[o]&&KupeParams.doors[e].materials[o].length&&(a[1+o].material=LoadMaterialByName(KupeParams.doors[e].materials[o]))}}function UpdateKorpusesDiv(){var e="<table cellpadding=0 cellspacing=0>";if(1==iActiveTab){var t,a=[];for(t=0;MainJsonData.korpuses.length>t;t++){var o,r=Math.round(1e3*MainJsonData.korpuses[t].width);for(o=0;a.length>o&&r>a[o][0];o++);if(o==a.length)a.push([r,MainJsonData.korpuses[t]]);else if(r==a[o][0])a[o].push(MainJsonData.korpuses[t]);else{a.length++;for(var n=a.length-1;n>o;n--)a[n]=a[n-1];a[o]=[r,MainJsonData.korpuses[t]]}}for(var i=GetKorpusByName(KupeParams.KorpusName),s=Math.round(1e3*i.width),l=0;2>l;l++){for(e+="<tr>",t=0;a.length>t;t++){var d=a[t][1];a[t][0]==s&&(d=i),e+='<td align=center style="cursor:pointer;';var u=a[t][0]==s?"#ff9e18":"#ffffff";e+="border-"+(0==l?"top":"bottom")+":2px solid "+u+";border-left:2px solid "+u+";border-right:2px solid "+u+";",1==l&&(e+="font-family:Arial;font-size:9px;"),e+='" onmouseover="Planner3dKupeConstructor.showPopupMenu(\'door_'+a[t][0]+'\',event.target)" onmouseout="Planner3dKupeConstructor.OnPopupOut()"',e+=0==l?" valign=bottom width=80 height=47 onclick=\"Planner3dKupeConstructor.SetKorpus('"+d.name+'\')"><img ondragstart="Planner3dKupeConstructor.stopStart(event)" src="'+HostImgs+"korpus_"+a[t][0]+'.png" >':">"+a[t][0]+" мм",e+="</td>"}e+="</tr>"}}if(2==iActiveTab){e+="<tr>";for(var p=0;KupeParams.nDoors>p;p++){var c=KupeParams.doors[p];e+='<td align=center style="cursor:pointer;" onmouseover="Planner3dKupeConstructor.showPopupMenu(\'dsb_'+p+'\',event.target)" onmouseout="Planner3dKupeConstructor.OnPopupOut()" valign=bottom width=40 height=43><img ondragstart="Planner3dKupeConstructor.stopStart(event)" src="'+HostImgs+"icon_door_variant_"+c.variantType+'.gif" width=36 height=36>',e+="</td>"}e+="</tr>"}e+="</table>",document.getElementById("Planner3d_KorpusVariantsDiv").innerHTML=e,cPopupMenu&&1==iActiveTab&&"door_"==cPopupMenu.substring(0,5)&&CreateDoorPopup(PopupMenuDiv,parseInt(cPopupMenu.substring(5))),cPopupMenu&&2==iActiveTab&&"dsb_"==cPopupMenu.substring(0,4)&&CreateDsbPopup(PopupMenuDiv,parseInt(cPopupMenu.substring(4)))}function SetKorpus(e){KupeParams.KorpusName=e,CreateFullKupe(),UpdateKorpusesDiv(),UpdatePrice()}function CreateFullKupe(){ClearChildren(Korpus3dHolder),ClearChildren(Lamp3dHolder);for(var e=GetKorpusByName(KupeParams.KorpusName),t=e.width>1.5?3:2,a=0;t>a;a++){var o=new THREE.Object3D;o.position.x=-.5*e.width+(a+.5)*e.width/t,Lamp3dHolder.add(o)}KupeParams.nDoors=e.doors.count,(void 0==iActiveDoor||iActiveDoor>=KupeParams.nDoors)&&(iActiveDoor=0),KupeParams.DoorsType=e.doors.type;for(var a=0;e.shapes.length>a;a++)loader.createModel(e.shapes[a],function(e,t){OnShapeLoaded("Korpus",a,e,t)},"");for(var a=0;MainJsonData.lamp.length>a;a++)loader.createModel(MainJsonData.lamp[a],function(e,t){OnShapeLoaded("Lamp",a,e,t)},"");var r=GetDoorByType(KupeParams.DoorsType);if(r)for(var n=GetDoorVariants(r),i=0;Doors3dHoldersMax>i;i++)e.doors.count>i?(void 0==GetDoorVariant(KupeParams.doors[i].variantType,n)&&(KupeParams.doors[i].variantType=n[0].type),UpdateKupeDoor(i)):ClearChildren(Doors3dHolders[i]);SetKorpusMaterial(KupeParams.KorpusMaterial),SetProfileMaterial(KupeParams.ProfileMaterial)}function onDocumentMouseDown(e){var t=e.pageX-getGlobalOffsetX(MainDiv),a=e.pageY-getGlobalOffsetY(MainDiv);if(2==e.button)e.preventDefault(),(!MSIE||MSIE>=11)&&(bMouseNavigationActive=!0,document.addEventListener("mouseup",onDocumentMouseUp,!1),document.addEventListener("mouseout",onDocumentMouseOut,!1),mouseXOnMouseDown=t-windowHalfX,targetRotationOnMouseDown=NormAngle(targetRotation),bMouseMoveBetweenClick=0);else if(0==e.button){if(2==iActiveTab&&t>=0&&Window3dWidth>t&&a>=0&&Window3dHeight>a){mouse2D.x=2*(t/Window3dWidth)-1,mouse2D.y=2*-(a/Window3dHeight)+1,raycaster=projector.pickingRay(mouse2D.clone(),camera);var o=raycaster.intersectObjects(scene.children,!0);if(o.length&&o[0].object.parent==Korpus3dHolder);else if(o.length)for(var r=0;KupeParams.nDoors>r;r++)if(o[0].object.parent==Doors3dHolders[r]){var n=GetDoorByType(KupeParams.DoorsType);if(void 0!=n)for(var i=0;KupeParams.doors[r].sections.length>i;i++)if(o[0].object==Doors3dHolders[r].children[1+i]){var s=GetVstavkaPossibleMaterials(KupeParams.DoorsType,KupeParams.doors[r].variantType,i);ArrayHasItem(s,CurrentVstavkaMaterial)&&(KupeParams.doors[r].materials[i]=CurrentVstavkaMaterial,UpdateKupeDoorMaterial(iActiveDoor,i),UpdatePrice());break}}}}else if(1==e.button&&t>=0&&Window3dWidth>t&&a>=0&&Window3dHeight>a){e.preventDefault(),mouse2D.x=2*(t/Window3dWidth)-1,mouse2D.y=2*-(a/Window3dHeight)+1,raycaster=projector.pickingRay(mouse2D.clone(),camera);var o=raycaster.intersectObjects(scene.children,!0);if(o.length){var l=o[0].point.clone().sub(camera.position),d=new THREE.Quaternion;d.setFromEuler(camera.rotation);var u=new THREE.Vector3(0,0,-1);u.applyQuaternion(d),fPanDistance=l.dot(u)}else fPanDistance=cameraDistance;last_pan_X=t,last_pan_Y=a,bPanActive=!0,document.addEventListener("mouseup",onDocumentMouseUp,!1),document.addEventListener("mouseout",onDocumentMouseOut,!1)}}function onDocumentMouseMove(e){var t=e.pageX-getGlobalOffsetX(MainDiv),a=e.pageY-getGlobalOffsetY(MainDiv);if(bMouseNavigationActive&&(bMouseMoveBetweenClick=1,mouseX=t-windowHalfX,targetRotation=targetRotationOnMouseDown+.02*(mouseX-mouseXOnMouseDown)),bPanActive&&(last_pan_X!=t||last_pan_Y!=a)){var o=new THREE.Vector3(2*(1*last_pan_X/Window3dWidth)-1,2*-(1*last_pan_Y/Window3dHeight)+1,.5);projector.unprojectVector(o,camera),o.sub(camera.position);var r=new THREE.Vector3(2*(1*t/Window3dWidth)-1,2*-(1*a/Window3dHeight)+1,.5);projector.unprojectVector(r,camera),r.sub(camera.position);var n=new THREE.Quaternion;n.setFromEuler(camera.rotation);var i=new THREE.Vector3(0,0,-1);i.applyQuaternion(n);var s=o.dot(i),l=r.dot(i);if(s>0&&l>0){camera.position.y+=fPanDistance*(o.y/s-r.y/l);var d=Math.sin(camera.rotation.y),u=Math.cos(camera.rotation.y);cameraXshift+=fPanDistance*(o.x/s-r.x/l)*u-fPanDistance*(o.z/s-r.z/l)*d,last_pan_X=t,last_pan_Y=a}}On3dMouseMove(t,a),e.stopPropagation()}function On3dMouseMove(e,t){var a=iActiveDoor;if(e>=0&&Window3dWidth>e&&t>=0&&Window3dHeight>t){var o="default";if(2==iActiveTab){mouse2D.x=2*(e/Window3dWidth)-1,mouse2D.y=2*-(t/Window3dHeight)+1,raycaster=projector.pickingRay(mouse2D.clone(),camera);var r=raycaster.intersectObjects(scene.children,!0);if(r.length&&r[0].object.parent==Korpus3dHolder);else if(r.length)for(var n=0;KupeParams.nDoors>n;n++)if(r[0].object.parent==Doors3dHolders[n]){iActiveDoor=n;var i=GetDoorByType(KupeParams.DoorsType);if(void 0!=i){for(var s=0;KupeParams.doors[n].sections.length>s;s++)if(r[0].object==Doors3dHolders[n].children[1+s]){iActiveDoorSection=s;var l=GetVstavkaPossibleMaterials(KupeParams.DoorsType,KupeParams.doors[n].variantType,s);ArrayHasItem(l,CurrentVstavkaMaterial)&&(o="url("+HostImgs+"brush.cur), pointer");break}s==KupeParams.doors[n].sections.length&&(iActiveDoorSection=-1)}break}}renderer.domElement.style.cursor=o}else iActiveDoor=-1;iActiveDoor>=0?showPopupMenu("ds_"+iActiveDoor):a!=iActiveDoor&&void 0!=cPopupMenu&&"ds_"==cPopupMenu.substring(0,3)&&OnPopupOut()
}function onDocumentContextMenu(){event.preventDefault()}function onDocumentMouseUp(e){(2==e.button||1==e.button)&&(e.preventDefault(),bMouseNavigationActive=!1,bPanActive=!1,document.removeEventListener("mouseup",onDocumentMouseUp,!1),document.removeEventListener("mouseout",onDocumentMouseOut,!1))}function onDocumentMouseOut(){bMouseNavigationActive=!1,bPanActive=!1,document.removeEventListener("mouseup",onDocumentMouseUp,!1),document.removeEventListener("mouseout",onDocumentMouseOut,!1)}function onDocumentTouchStart(e){1==e.touches.length&&(e.preventDefault(),mouseXOnMouseDown=e.touches[0].pageX-windowHalfX,targetRotationOnMouseDown=NormAngle(targetRotation))}function onDocumentTouchMove(e){1==e.touches.length&&(e.preventDefault(),mouseX=e.touches[0].pageX-windowHalfX,targetRotation=targetRotationOnMouseDown+.05*(mouseX-mouseXOnMouseDown))}function onMouseWheel(e){e.wheelDelta>0?cameraDistance*=1-Math.min(.2,5e-4*e.wheelDelta):cameraDistance/=1-Math.min(.2,-5e-4*e.wheelDelta),e.preventDefault(),e.stopPropagation()}function hidePopup(){PopupMenuDiv.style.display="none",(void 0!=cPopupMenu&&("door_"==cPopupMenu.substring(0,5)||"mat_"==cPopupMenu.substring(0,4))||"dsb_"==cPopupMenu.substring(0,4))&&(document.getElementById("Planner3d_ProfileVariantsDiv").style.visibility="visible",document.getElementById("Planner3d_LampVariantsDiv").style.visibility="visible",document.getElementById("Planner3d_TabInfo1").style.visibility="visible",document.getElementById("Planner3d_TabInfo2").style.visibility="visible"),null!=hideTimeout&&(clearTimeout(hideTimeout),hideTimeout=null),cPopupMenu=null}function getGlobalOffsetX(e,t){var a,o=0;for(a=e;"BODY"!=a.tagName&&a!=t;a=a.offsetParent)o+=a.offsetLeft;return o}function getGlobalOffsetY(e,t){var a,o=0;for(a=e;"BODY"!=a.tagName&&a!=t;a=a.offsetParent)o+=a.offsetTop;return o}function OnPopupOut(){null==hideTimeout&&(hideTimeout=setTimeout(hidePopup,100))}function CreateDoorPopup(e,t){var a=GetKorpusByName(KupeParams.KorpusName),o="<table cellpadding=0 cellspacing=0>";o+="";for(var r=0;MainJsonData.korpuses.length>r;r++)if(t==Math.round(1e3*MainJsonData.korpuses[r].width)){o+="<tr>";for(var n=0;2>n;n++){o+='<td style="cursor:pointer;padding-left:4px;padding-top:4px;padding-right:4px;',1==n&&(o+="font-family:Arial;font-size:9px;color:#666666;");var i=MainJsonData.korpuses[r]==a?"#ff9e18":"#ffffff";o+="border-"+(0==n?"left":"right")+":2px solid "+i+";border-top:2px solid "+i+";border-bottom:2px solid "+i+";",o+='" ',0==n&&(o+=" align=center"),o+=" onclick=\"Planner3dKupeConstructor.SetKorpus('"+MainJsonData.korpuses[r].name+"')\">",o+=0==n?'<img src="'+HostIcons+MainJsonData.korpuses[r].icon+'" height=37>':"глубина "+Math.round(1e3*MainJsonData.korpuses[r].depth)+" мм<br>"+MainJsonData.korpuses[r].doors.count+" двери",o+="</td>"}o+="</tr>"}o+="",o+="</table>",e.innerHTML=o}function CreateDsbPopup(e,t){var t=parseInt(cPopupMenu.substring(4)),a='<table cellpadding=0 cellspacing=0 style="background-color:#FFFFFF">',o=GetDoorByType(KupeParams.DoorsType),r=GetDoorVariants(o);if(o)for(var n=0;r.length>n;n++){a+="<tr>";for(var i=0;2>i;i++){a+='<td style="cursor:pointer;padding-left:4px;padding-top:4px;padding-right:4px;',1==i&&(a+="font-family:Arial;font-size:9px;color:#666666;");var s=KupeParams.doors[t].variantType==r[n].type?"#ff9e18":"#ffffff";a+="border-"+(0==i?"left":"right")+":2px solid "+s+";border-top:2px solid "+s+";border-bottom:2px solid "+s+";",a+='" ',0==i&&(a+=" align=center"),a+=' onclick=\'Planner3dKupeConstructor.OnClickSmallButt(event,"set_variant","'+r[n].type+'","'+t+"\")'>",a+=0==i?'<img src="'+HostImgs+"icon_door_variant_"+r[n].type+'.gif" width=36 height=36 border=0>':1==r[n].type?r[n].type+" секция":r[n].type+" секции",a+="</td>"}a+="</tr>"}a+="</table>",e.innerHTML=a}function showPopupMenu(e,t){if(null!=hideTimeout&&(clearTimeout(hideTimeout),hideTimeout=null),!(0==showPopupMenu.arguments.length||e instanceof Event)&&cPopupMenu!=e){cPopupMenu=e,"door_"==cPopupMenu.substring(0,5)||"mat_"==cPopupMenu.substring(0,4)||"dsb_"==cPopupMenu.substring(0,4)?("mat_"==cPopupMenu.substring(0,4)&&(document.getElementById("Planner3d_ProfileVariantsDiv").style.visibility="hidden",document.getElementById("Planner3d_LampVariantsDiv").style.visibility="hidden"),document.getElementById("Planner3d_TabInfo1").style.visibility="mat_"!=cPopupMenu.substring(0,4)?"hidden":"visible",document.getElementById("Planner3d_TabInfo2").style.visibility="mat_"!=cPopupMenu.substring(0,4)?"hidden":"visible"):"ds_"==cPopupMenu.substring(0,3)&&(document.getElementById("Planner3d_ProfileVariantsDiv").style.visibility="visible",document.getElementById("Planner3d_LampVariantsDiv").style.visibility="visible",document.getElementById("Planner3d_TabInfo1").style.visibility="visible",document.getElementById("Planner3d_TabInfo2").style.visibility="visible");var a=PopupMenuDiv;if(a.style.display="block","door_"==cPopupMenu.substring(0,5)){CreateDoorPopup(a,parseInt(cPopupMenu.substring(5)));var o=getGlobalOffsetX(t,MainDiv),r=document.getElementById("Planner3d_KorpusVariantsDiv");o+a.offsetWidth>getGlobalOffsetX(r,MainDiv)+r.offsetWidth-1&&(o=getGlobalOffsetX(r,MainDiv)+r.offsetWidth-a.offsetWidth-1),a.style.left=o+"px",a.style.top=getGlobalOffsetY(r,MainDiv)+r.offsetHeight+"px"}else if("mat_"==cPopupMenu.substring(0,4)){var n=GetMaterial(cPopupMenu.substring(4));if(void 0!=n){var i='<div style="width:149px;height:89px;background-image:url('+HostIcons+n.icon+');"></div>';i+='<div style="width:149px;text-align:center;font-family:Arial;font-size:9px;color:#666666;">'+n.description+"</div>",a.innerHTML=i}a.style.left=getGlobalOffsetX(document.getElementById("Planner3d_LampVariantsDiv"),MainDiv)+44+"px",a.style.top=getGlobalOffsetY(document.getElementById("Planner3d_LampVariantsDiv"),MainDiv)+25+"px"}else if("ds_"==cPopupMenu.substring(0,3)){var s=parseInt(cPopupMenu.substring(3)),i='<table cellpadding=0 cellspacing=0 style="background-color:#FFFFFF"><tr>',l=GetDoorByType(KupeParams.DoorsType),d=GetDoorVariants(l);if(l)for(var u=0;d.length>u;u++)i+="<td height=30 valign=middle",KupeParams.doors[iActiveDoor].variantType==d[u].type&&(i+=' style="border:2px solid #ff9e18;"'),i+='><img src="'+HostImgs+"icon_door_variant_"+d[u].type+'_sm.gif" style="cursor:pointer" width=20 height=24 border=0 onclick=\'Planner3dKupeConstructor.OnClickSmallButt(event,"set_variant","'+d[u].type+'","'+s+"\")'></td>";i+="</tr></table>",a.innerHTML=i}else if("dsb_"==cPopupMenu.substring(0,4)){CreateDsbPopup(a,parseInt(cPopupMenu.substring(4)));var o=getGlobalOffsetX(t,MainDiv),r=document.getElementById("Planner3d_KorpusVariantsDiv");o+a.offsetWidth>getGlobalOffsetX(r,MainDiv)+r.offsetWidth&&(o=getGlobalOffsetX(r,MainDiv)+r.offsetWidth-a.offsetWidth),a.style.left=o+"px",a.style.top=getGlobalOffsetY(r,MainDiv)+r.offsetHeight+"px"}}}function ClearPlayTimeInterval(){playTimeInterval&&(clearInterval(playTimeInterval),playTimeInterval=null)}function OnPressSmallButtRotateL(event,idStr){ClearPlayTimeInterval(),(""==idStr||"RotateR"==idStr)&&(targetRotation=-camera.rotation.y),eval("ProcessPressAction('"+idStr+"')"),playTimeInterval=setInterval("ProcessPressAction('"+idStr+"')",30)}function OnPressSmallButtRotateL(){ClearPlayTimeInterval(),targetRotation=-camera.rotation.y,document.addEventListener("mouseup",OnReleaseSmallButt,!1),ProcessPressActionRotateL(),playTimeInterval=setInterval(ProcessPressActionRotateL,30)}function OnPressSmallButtRotateR(){ClearPlayTimeInterval(),targetRotation=-camera.rotation.y,document.addEventListener("mouseup",OnReleaseSmallButt,!1),ProcessPressActionRotateR(),playTimeInterval=setInterval(ProcessPressActionRotateR,30)}function OnPressSmallButtZoomIn(){ClearPlayTimeInterval(),document.addEventListener("mouseup",OnReleaseSmallButt,!1),ProcessPressActionZoomIn(),playTimeInterval=setInterval(ProcessPressActionZoomIn,30)}function OnPressSmallButtZoomOut(){ClearPlayTimeInterval(),document.addEventListener("mouseup",OnReleaseSmallButt,!1),ProcessPressActionZoomOut(),playTimeInterval=setInterval(ProcessPressActionZoomOut,30)}function ProcessPressActionRotateR(){targetRotation+=.2}function ProcessPressActionRotateL(){targetRotation-=.2}function ProcessPressActionZoomIn(){cameraDistance*=1-Math.min(.2,.0025)}function ProcessPressActionZoomOut(){cameraDistance/=1-Math.min(.2,.0025)}function OnReleaseSmallButt(){document.removeEventListener("mouseup",OnReleaseSmallButt,!1),ClearPlayTimeInterval()}function OnClickSmallButtColorPicker(e){OnClickSmallButt(e,"colorpicker",0)}function OnClickSmallButt(e,t,a,o){if("set_variant"==t){KupeParams.doors[o].variantType=a,UpdateKupeDoor(o);var r=cPopupMenu;cPopupMenu=void 0,void 0!=r&&"dsb_"==r.substring(0,4)?(cPopupMenu=r,CreateDsbPopup(PopupMenuDiv,parseInt(cPopupMenu.substring(4)))):showPopupMenu(r),UpdateKorpusesDiv(),UpdatePrice()}else"colorpicker"==t&&iActiveDoorSection>=0&&KupeParams.doors[iActiveDoor].sections.length>iActiveDoorSection&&(CurrentVstavkaMaterial=KupeParams.doors[iActiveDoor].materials[iActiveDoorSection],ActivateTab(iActiveTab))}function stopStart(e){e.preventDefault(),e.stopPropagation()}function _onFinishStart(){return!1}function onDragMatStart(e,t){LoadMaterialByName(e),t.dataTransfer.setData("text",e),curDragMat=e,t.stopPropagation()}function onDragMatEnd(){curDragMat=""}function onDropHandler(e){var t=e.pageX-getGlobalOffsetX(MainDiv),a=e.pageY-getGlobalOffsetY(MainDiv);if(t>=0&&Window3dWidth>t&&a>=0&&Window3dHeight>a){mouse2D.x=2*(t/Window3dWidth)-1,mouse2D.y=2*-(a/Window3dHeight)+1,raycaster=projector.pickingRay(mouse2D.clone(),camera);var o=raycaster.intersectObjects(scene.children,!0);if(o.length&&o[0].object.parent==Korpus3dHolder)return;if(o.length)for(var r=0;KupeParams.nDoors>r;r++)if(o[0].object.parent==Doors3dHolders[r]){var n=GetDoorByType(KupeParams.DoorsType);if(void 0!=n)for(var i=0;KupeParams.doors[r].sections.length>i;i++)if(o[0].object==Doors3dHolders[r].children[1+i]){var s=GetVstavkaPossibleMaterials(KupeParams.DoorsType,KupeParams.doors[r].variantType,i);ArrayHasItem(s,curDragMat)&&(KupeParams.doors[r].materials[i]=curDragMat,UpdateKupeDoorMaterial(r,i),UpdatePrice());break}return}}}function onDragOver(e){if(e.dataTransfer.getData("text"),e.dataTransfer.dropEffect="none",curDragMat&&curDragMat.length){e.preventDefault&&e.preventDefault();var t=e.pageX-getGlobalOffsetX(MainDiv),a=e.pageY-getGlobalOffsetY(MainDiv);if(t>=0&&Window3dWidth>t&&a>=0&&Window3dHeight>a){mouse2D.x=2*(t/Window3dWidth)-1,mouse2D.y=2*-(a/Window3dHeight)+1,raycaster=projector.pickingRay(mouse2D.clone(),camera);var o=raycaster.intersectObjects(scene.children,!0);if(o.length&&o[0].object.parent!=Korpus3dHolder)for(var r=0;KupeParams.nDoors>r;r++)if(o[0].object.parent==Doors3dHolders[r]){var n=GetDoorByType(KupeParams.DoorsType);if(void 0!=n)for(var i=0;KupeParams.doors[r].sections.length>i;i++)if(o[0].object==Doors3dHolders[r].children[1+i]){var s=GetVstavkaPossibleMaterials(KupeParams.DoorsType,KupeParams.doors[r].variantType,i);ArrayHasItem(s,curDragMat)&&(e.dataTransfer.dropEffect="copy");break}return}}}}function onDragEnter(e){return curDragMat&&curDragMat.length?(e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="copy"):e.dataTransfer.dropEffect="none",!1}function Project3dPointTo2d(e,t,a){var o=projector.projectVector(new THREE.Vector3(e,t,a),camera);return{x:Math.round(.5*o.x*Window3dWidth+Window3dWidth/2),y:Math.round(Window3dHeight/2-.5*o.y*Window3dHeight)}}function animate(){if(requestAnimationFrame(animate),render(),2==iActiveTab)if(Doors3dHolders[0].children.length>0&&iActiveDoor>=0){if(void 0!=cPopupMenu&&"ds_"==cPopupMenu.substring(0,3)){Doors3dHolders[iActiveDoor].children[0].geometry.computeBoundingBox();var e=Doors3dHolders[iActiveDoor].children[0].geometry.boundingBox,t=Project3dPointTo2d(.5*(e.min.x+e.max.x)+Doors3dHolders[iActiveDoor].position.x,e.max.y+Doors3dHolders[iActiveDoor].position.y,e.max.z+Doors3dHolders[iActiveDoor].position.z),a=PopupMenuDiv;0>t.x-30&&(t.x=30),t.x+30>=Window3dWidth&&(t.x=Window3dWidth-30),16>t.y&&(t.y=16),t.y+28>=Window3dHeight&&(t.y=Window3dHeight-28),a.style.left=t.x-30+"px",a.style.top=Math.round(t.y-16)+"px"}if(iActiveDoorSection>=0&&KupeParams.doors[iActiveDoor].sections.length>iActiveDoorSection){Doors3dHolders[iActiveDoor].children[1+iActiveDoorSection].geometry.computeBoundingBox();var e=Doors3dHolders[iActiveDoor].children[1+iActiveDoorSection].geometry.boundingBox,t=Project3dPointTo2d(e.min.x+Doors3dHolders[iActiveDoor].position.x,e.min.y+Doors3dHolders[iActiveDoor].position.y,e.max.z+Doors3dHolders[iActiveDoor].position.z);ButtColorPicker.style.left=t.x+"px",ButtColorPicker.style.top=Math.round(t.y-26)+"px",ButtColorPicker.style.display="block"}else ButtColorPicker.style.display="none"}else ButtColorPicker.style.display="none";stats&&stats.update()}function render(){var e=NormAngle(camera.rotation.y+.05*(-targetRotation-camera.rotation.y));camera.rotation.y=Math.abs(e)>1.483529886111111?3.1415927*(e>0?1:-1)/2*(17/18):e;var t=Math.sin(camera.rotation.y),a=Math.cos(camera.rotation.y);2>cameraDistance?cameraDistance=2:cameraDistance>25&&(cameraDistance=25),camera.position.x=t*cameraDistance+cameraXshift*a,camera.position.z=a*cameraDistance-cameraXshift*t,renderer.render(scene,camera)}var container,stats,mouse2D,camera,scene,renderer,cameraDistance=15,cameraXshift=0,stats,mouseX=0,mouseY=0,raycaster,projector,Window3dWidth=430,Window3dHeight=450,windowHalfX=Window3dWidth/2,windowHalfY=Window3dHeight/2,iconSize=50,bMouseMoveBetweenClick,bMouseNavigationActive=0,targetRotation=0,targetRotationOnMouseDown=0,mouseXOnMouseDown=0,MainJsonData=null,Korpus3dHolder,Lamp3dHolder,Doors3dHolders=[],Doors3dHoldersMax=3,CurrentVstavkaMaterial,ProblemVstavkaMaterials=[],KupeParams={};KupeParams.nDoors=0;var iActiveDoor=0,iActiveDoorSection=-1;KupeParams.doors=[];var hideTimeout=null,cPopupMenu,progDAnim=null,MSIE=0,MainDiv=null,PopupMenuDiv=null,ButtColorPicker=null,StartKupeSetId,MainJsonText,MatLib=[],iActiveTab=1,bPanActive=0,fPanDistance,last_pan_X,last_pan_Y,playTimeInterval=null,curDragMat=0;return{Initialize:Initialize,Uninitialize:Uninitialize,GetBasketContent:GetBasketContent,SetKorpusMaterial:SetKorpusMaterial,SetCurrentVstavkaMaterial:SetCurrentVstavkaMaterial,SetProfileMaterial:SetProfileMaterial,SetKorpus:SetKorpus,OnClickSmallButt:OnClickSmallButt,showPopupMenu:showPopupMenu,OnPopupOut:OnPopupOut,stopStart:stopStart,onDragMatStart:onDragMatStart,onDragMatEnd:onDragMatEnd}},DAnimProgressBar=function(e){function t(e,t,a,o,r,n){e.beginPath(),e.moveTo(t+n,a),e.lineTo(t+o-n,a),e.arc(t+o-n,a+n,n,-Math.PI/2,Math.PI/2,!1),e.lineTo(t+n,a+r),e.arc(t+n,a+n,n,Math.PI/2,3*Math.PI/2,!1),e.closePath(),e.fill()}function a(e,a,o,r,n,i){e.save(),e.shadowOffsetX=2,e.shadowOffsetY=2,e.shadowBlur=5,e.shadowColor="#666",e.fillStyle="rgba(189,189,189,1)",t(e,a,o,r,n,i),e.shadowColor="rgba(0,0,0,0)";var s=e.createLinearGradient(0,o+n,0,0);s.addColorStop(0,"rgba(255,255,255, 0.1)"),s.addColorStop(.4,"rgba(255,255,255, 0.7)"),s.addColorStop(1,"rgba(255,255,255,0.4)"),e.fillStyle=s,t(e,a,o,r,n,i),e.fillStyle="white",e.restore()}function o(e,t,a,o,r,n,i){var s=0;e.beginPath(),n>o?(s=n-Math.sqrt(Math.pow(n,2)-Math.pow(n-o,2)),e.moveTo(t+o,a+s),e.lineTo(t+o,a+r-s),e.arc(t+n,a+n,n,Math.PI-Math.acos((n-o)/n),Math.PI+Math.acos((n-o)/n),!1)):o+n>i?(s=n-Math.sqrt(Math.pow(n,2)-Math.pow(n-(i-o),2)),e.moveTo(t+n,a),e.lineTo(t+o,a),e.arc(t+i-n,a+n,n,-Math.PI/2,-Math.acos((n-(i-o))/n),!1),e.lineTo(t+o,a+r-s),e.arc(t+i-n,a+n,n,Math.acos((n-(i-o))/n),Math.PI/2,!1),e.lineTo(t+n,a+r),e.arc(t+n,a+n,n,Math.PI/2,3*Math.PI/2,!1)):(e.moveTo(t+n,a),e.lineTo(t+o,a),e.lineTo(t+o,a+r),e.lineTo(t+n,a+r),e.arc(t+n,a+n,n,Math.PI/2,3*Math.PI/2,!1)),e.closePath(),e.fill(),i-1>o&&(e.save(),e.shadowOffsetX=1,e.shadowBlur=1,e.shadowColor="#666",o+n>i&&(s+=1),e.fillRect(t+o,a+s,1,l-2*s),e.restore())}function r(e,t,a,o,r,n,i){e.save(),e.fillStyle="white";var s=Math.floor(100*(o/i))+"%",l=e.measureText(s).width,d=t+o-l-n/2;n+l>=o&&(d=t+n/2),e.fillText(s,d,a+22),e.restore()}var n=null,i=null,s=300,l=34,d=20,u=20,p=l/2,c=e,m=function(){n.style.display="none"},f=function(e,t,a){if(n=document.createElement(c?"DIV":"canvas"),c||(n.width=500,n.height=150),n.style.position="absolute",n.style.left=Math.floor((t-s)/2)+"px",n.style.top=Math.floor((a-l)/2)+"px",e.appendChild(n),c&&(n.style.width=s+"px",n.style.height=l/2+"px",n.style.overflow="hidden",n.style.borderColor="#000000",n.style.borderWidth="1px",n.style.borderStyle="solid",n.style.backgroundColor="#FFFFFF",n.innerHTML='<DIV style="background-color:#ADD9FF;width:0px;height:'+l/2+'px;"></DIV>'),!c){if(!n||!n.getContext)return;if(i=n.getContext("2d"),!i)return;i.font="16px Verdana";var o=i.createLinearGradient(0,u+l,0,0);o.addColorStop(0,"#4DA4F3"),o.addColorStop(.4,"#ADD9FF"),o.addColorStop(1,"#9ED1FF"),i.fillStyle=o}v(0)},v=function(e){if(c){var t=n.children(0);t&&(t.style.width=e+"px")}else i.clearRect(d-5,u-5,s+15,l+15),a(i,d,u,s,l,p),o(i,d,u,e,l,p,s),r(i,d,u,e,l,p,s)};return{width:s,height:l,Initialize:f,Uninitialize:m,doDraw:v}};