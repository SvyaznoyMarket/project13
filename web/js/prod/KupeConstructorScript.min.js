var DKupe3dConstructor=function(ParentItem,HostImgs,HostTextures,HostIcons){function Initialize(a,b){StartKupeSetId=b;var c=navigator.userAgent.match(/MSIE ([\d\.]+)/);c&&(MSIE=parseFloat(c[1])),MainDiv=document.createElement("DIV"),MainDiv.setAttribute("id","Planner3d_MainDiv"),MainDiv.style.position="relative",ParentItem.appendChild(MainDiv),MainDiv.innerHTML='<div id="Planner3d_tab_info" style="color: #666666;font-family:\'Enter Type Bold\';font-size:18px;position: absolute;top: 0px;left: 50%;width: 200px;position:absolute;z-index: 1;display:none;">\r\n	<table cellpadding=0 cellspacing=0 width=250>\r\n	<tr><td height=25 id=Planner3d_TabInfo1Header width=120 align=center>Выбор корпуса</td><td height=25 width=5>&nbsp;</td><td id=Planner3d_TabInfo2Header width=120 align=center>Выбор фасада</td></tr>\r\n	<tr><td id=Planner3d_KorpusVariantsDiv height=80 colspan=3 style="padding-left:5px;border:1px solid #c1c1bf;"></td></tr>\r\n	<tr><td id=Planner3d_TabInfo colspan=3 height=183 valign=top style="padding-top:5px;padding-bottom:5px;padding-left:5px;border-left:1px solid #c1c1bf;border-right:1px solid #c1c1bf;border-bottom:1px solid #c1c1bf;">\r\n	<div id=Planner3d_TabInfo1 style="display:none;">&nbsp;</div><div id=Planner3d_TabInfo2 style="display:none;">\r\n	<font style="font-family:\'Enter Type\';color:#000000;font-size:13px;">Выбор цвета вставки</font><br>\r\n	<div id="Planner3d_scrollcontent"></div></div></td></tr>\r\n	<tr><td id=Planner3d_LampVariantsDiv height=80 colspan=4 style="padding-left:5px;border-left:1px solid #c1c1bf;border-right:1px solid #c1c1bf;border-bottom:1px solid #c1c1bf;"></td></tr>\r\n	<tr><td id=Planner3d_ProfileVariantsDiv height=80 colspan=4 style="padding-left:5px;border-left:1px solid #c1c1bf;border-right:1px solid #c1c1bf;border-bottom:1px solid #c1c1bf;"></td></tr>\r\n	</table></div>',document.getElementById("Planner3d_TabInfo1Header").addEventListener("click",ActivateTab1,!1),document.getElementById("Planner3d_TabInfo2Header").addEventListener("click",ActivateTab2,!1),PopupMenuDiv=document.createElement("DIV"),PopupMenuDiv.style.position="absolute",PopupMenuDiv.style.zIndex="2",PopupMenuDiv.style.display="none",PopupMenuDiv.addEventListener("mouseover",showPopupMenu,!1),PopupMenuDiv.addEventListener("mouseout",OnPopupOut,!1),MainDiv.appendChild(PopupMenuDiv),ButtColorPicker=document.createElement("DIV"),ButtColorPicker.style.position="absolute",ButtColorPicker.style.cursor="pointer",ButtColorPicker.style.display="none",ButtColorPicker.innerHTML='<img src="'+HostImgs+'icon_colorpicker.png" width=27 height=26 border=0>',ButtColorPicker.addEventListener("mousedown",stopStart,!1),ButtColorPicker.addEventListener("click",OnClickSmallButtColorPicker,!1),MainDiv.appendChild(ButtColorPicker),progDAnim=new DAnimProgressBar(0),progDAnim.Initialize(MainDiv,Window3dWidth,Window3dHeight);var d=new XMLHttpRequest;d.addEventListener("load",onMainData,!1),d.addEventListener("progress",onMainDataProgress,!1),d.open("GET",a,!0),d.send(null)}function Uninitialize(){}function onMainData(a){progDAnim&&progDAnim.doDraw(progDAnim.width),MainJsonText=a.target.responseText,setTimeout(init,1)}function onMainDataProgress(a){if(a.lengthComputable){{a.loaded/a.total}progDAnim&&progDAnim.doDraw(progDAnim.width*a.loaded/a.total)}}function ArrayHasItem(a,b){for(var c=0;c<a.length;c++)if(a[c]==b)return 1;return 0}function NormAngle(a){for(var b=a;Math.abs(b)>3.1415927;)b>0?b-=6.2831852:b+=6.2831852;return b}function rgb2hex(a){return(255*a[0]<<16)+(255*a[1]<<8)+255*a[2]}function LoadMaterialByName(a){if(void 0!==MatLib[a])return MatLib[a];var b=GetMaterial(a);if(b){var c=MyCreateMaterial(b);return MatLib[a]=c,c}var d=new Object;return d.color=15790320,new THREE.MeshLambertMaterial(d)}function MyCreateMaterial(a){var b=new Object;if(!a.colorDiffuse||a.mapDiffuse&&a.mapDiffuse.length||(b.color=rgb2hex(a.colorDiffuse)),a.colorSpecular&&(b.specular=rgb2hex(a.colorSpecular)),a.colorAmbient&&(b.ambient=rgb2hex(a.colorAmbient)),a.transparency&&(b.opacity=a.transparency),a.specularCoef&&(b.shininess=a.specularCoef),a.mapDiffuse&&(b.map=THREE.ImageUtils.loadTexture(HostTextures+a.mapDiffuse),b.map.wrapS=THREE.RepeatWrapping,b.map.wrapT=THREE.RepeatWrapping,a.mapDiffuseScale&&b.map.repeat.set(a.mapDiffuseScale[0],a.mapDiffuseScale[1]),a.mapDiffuseOffset&&b.map.offset.set(a.mapDiffuseOffset[0],a.mapDiffuseOffset[1])),a.cubeMap){var c=THREE.ImageUtils.loadTextureCube(a.cubeMap);c.format=THREE.RGBFormat,b.envMap=c,b.combine=THREE.MixOperation,b.reflectivity=.3}return new THREE.MeshPhongMaterial(b)}function FindAllArts(a,b){for(var c=0;c<b.length;c++){var d=b[c].api_id;if(d.length){var e=d.indexOf("/");e>0&&(d=d.substring(0,e)),ArrayHasItem(a,d)||a.push(d)}}}function init(){if(MainJsonData=JSON.parse(MainJsonText)){if(!MSIE||MSIE>=11){var a=document.createElement("DIV");a.setAttribute("id","RotateL"),a.innerHTML='<img draggable="false" src="'+HostImgs+'rotate_left.png" width=35 height=43 border=0>',MainDiv.appendChild(a),a.addEventListener("mousedown",OnPressSmallButtRotateL,!1),a.style.position="absolute",a.style.cursor="pointer";var b=document.createElement("DIV");b.setAttribute("id","RotateC"),b.innerHTML='<img draggable="false" src="'+HostImgs+'rotate_center.png" width=51 height=47 border=0>',MainDiv.appendChild(b),b.style.position="absolute";var c=document.createElement("DIV");c.setAttribute("id","RotateR"),c.innerHTML='<img draggable="false" src="'+HostImgs+'rotate_right.png" width=35 height=43 border=0>',MainDiv.appendChild(c),c.addEventListener("mousedown",OnPressSmallButtRotateR,!1),c.style.position="absolute",c.style.cursor="pointer";var d=document.createElement("DIV");d.setAttribute("id","ZoomOut"),d.innerHTML='<img draggable="false" src="'+HostImgs+'zoom_out.png" width=41 height=39 border=0>',MainDiv.appendChild(d),d.addEventListener("mousedown",OnPressSmallButtZoomOut,!1),d.style.position="absolute",d.style.cursor="pointer";var e=document.createElement("DIV");e.setAttribute("id","ZoomIn"),e.innerHTML='<img draggable="false" src="'+HostImgs+'zoom_in.png" width=41 height=39 border=0>',MainDiv.appendChild(e),e.addEventListener("mousedown",OnPressSmallButtZoomIn,!1),e.style.position="absolute",e.style.cursor="pointer",a.style.top=Window3dHeight+10+"px",a.style.left=Window3dWidth/2-20-35+"px",c.style.top=Window3dHeight+10+"px",c.style.left=Window3dWidth/2+33+"px",b.style.left=Window3dWidth/2-20+"px",b.style.top=Window3dHeight+10+"px",d.style.left="0px",d.style.top="0px",e.style.left="0px",e.style.top="50px"}if(MainJsonData.articuls){for(var f=[],g=0;g<MainJsonData.korpuses.length;g++)for(var h=0;h<MainJsonData.articuls.korpuses.length;h++)if(MainJsonData.korpuses[g].name==MainJsonData.articuls.korpuses[h].name){f.push(MainJsonData.korpuses[g]);break}MainJsonData.korpuses=f}MainJsonText=void 0,progDAnim&&progDAnim.Uninitialize(),container=document.createElement("div"),MainDiv.appendChild(container),document.body.addEventListener("drop",onDropHandler,!1),document.body.addEventListener("dragenter",onDragEnter,!1),document.body.addEventListener("dragover",onDragOver,!1),camera=new THREE.PerspectiveCamera(10,Window3dWidth/Window3dHeight,1,2e3),camera.position.x=0,camera.position.y=1.2,camera.position.z=cameraDistance,scene=new THREE.Scene;var i=new THREE.AmbientLight(5000268);scene.add(i);var j=new THREE.DirectionalLight(10066329);j.position.set(1,0,0).normalize(),scene.add(j);var k=new THREE.DirectionalLight(8355711);k.position.set(-1,0,0).normalize(),scene.add(k);var l=new THREE.DirectionalLight(5855577);l.position.set(0,1,0).normalize(),scene.add(l);var m=new THREE.DirectionalLight(7500402);m.position.set(0,-1,0).normalize(),scene.add(m);var n=new THREE.DirectionalLight(10066329);n.position.set(0,0,1).normalize(),scene.add(n);var o=new THREE.DirectionalLight(10066329);o.position.set(0,0,-1).normalize(),scene.add(o);var p=new THREE.CubeGeometry(600,600,5);floormesh=new THREE.Mesh(p,new THREE.MeshBasicMaterial({color:13421772})),floormesh.position.y=-2.5,floormesh.rotation.x=90*Math.PI/180,Korpus3dHolder=new THREE.Object3D,scene.add(Korpus3dHolder),Lamp3dHolder=new THREE.Object3D,scene.add(Lamp3dHolder);for(var g=0;Doors3dHoldersMax>g;g++){var q=new THREE.Object3D;Doors3dHolders[g]=q,scene.add(q)}for(var g=0;Doors3dHoldersMax>g;g++)KupeParams.doors[g]=new Object,KupeParams.doors[g].materials=["","","",""];if(projector=new THREE.Projector,mouse2D=new THREE.Vector3(0,1e4,.5),loader=new THREE.JSONLoader,void 0!=StartKupeSetId&&null!=StartKupeSetId&&MainJsonData.sets)for(var g=0;g<MainJsonData.sets.length;g++)if(MainJsonData.sets[g].set_id==StartKupeSetId){KupeParams.KorpusName=MainJsonData.sets[g].KorpusName,KupeParams.KorpusMaterial=MainJsonData.sets[g].KorpusMaterial,KupeParams.ProfileMaterial=MainJsonData.sets[g].ProfileMaterial;for(var r=0;r<MainJsonData.sets[g].doors.length;r++)KupeParams.doors[r].variantType=MainJsonData.sets[g].doors[r].type,KupeParams.doors[r].materials=MainJsonData.sets[g].doors[r].colors;break}void 0==KupeParams.KorpusName&&(KupeParams.KorpusName=MainJsonData.korpuses[0].name),void 0==KupeParams.KorpusMaterial&&(KupeParams.KorpusMaterial=GetKorpusPossibleMaterials(KupeParams.KorpusName)[0]),void 0==KupeParams.ProfileMaterial&&(KupeParams.ProfileMaterial=GetProfilePossibleMaterials(KupeParams.KorpusName)[0]),void 0==KupeParams.Lamp&&(KupeParams.Lamp=0),CreateFullKupe(),UpdateKorpusesDiv();var s=document.getElementById("Planner3d_tab_info");if(s.style.display="block",s.style.left=Window3dWidth+20+"px",s.style.height=Window3dHeight+"px",ActivateTab(1),renderer=!MSIE||MSIE>=11?new THREE.WebGLRenderer({antialias:!0}):new THREE.CanvasRenderer,renderer.setSize(Window3dWidth,Window3dHeight),container.appendChild(renderer.domElement),renderer.domElement.style.borderBottom="2px solid #c1c1bf",stats=null,MainDiv.addEventListener("mousewheel",onMouseWheel,!1),MainDiv.addEventListener("mousedown",onDocumentMouseDown,!1),MainDiv.addEventListener("touchstart",onDocumentTouchStart,!1),MainDiv.addEventListener("touchmove",onDocumentTouchMove,!1),document.addEventListener("mousemove",onDocumentMouseMove,!1),document.onselectstart=_onFinishStart,document.oncontextmenu=_onFinishStart,animate(),MainJsonData.articuls){for(var t=[],u=0;u<MainJsonData.articuls.korpuses.length;u++)FindAllArts(t,MainJsonData.articuls.korpuses[u].variants);for(var v=0;v<MainJsonData.articuls.vstavki.length;v++)FindAllArts(t,MainJsonData.articuls.vstavki[v].variants);for(var w=0;w<MainJsonData.articuls.profiles.length;w++)FindAllArts(t,MainJsonData.articuls.profiles[w].variants);for(var h=0;h<MainJsonData.articuls.doors.length;h++)for(var x=0;x<MainJsonData.articuls.doors[h].types.length;x++)FindAllArts(t,MainJsonData.articuls.doors[h].types[x].variants);Planner3d_Init(t),UpdatePrice()}}}function AppendSceneApiIdsIds(a,b,c){for(var d=0;d<b.length;d++)if(b[d].color==c){var e=b[d].api_id;if(e.length){var f=e.indexOf("/");if(f>0&&"/2"==e.substring(f))for(var g=0;g<a.length;g++)if(a[g]==e)return void(a[g]=e.substring(0,f));a.push(e)}}}function GetSceneApiIds(){for(var a=[],b=0;b<MainJsonData.articuls.korpuses.length;b++)if(MainJsonData.articuls.korpuses[b].name==KupeParams.KorpusName){AppendSceneApiIdsIds(a,MainJsonData.articuls.korpuses[b].variants,KupeParams.KorpusMaterial);break}var c=GetKorpusByName(KupeParams.KorpusName);if(c){for(var b=0;b<MainJsonData.articuls.profiles.length;b++)if(c.width==MainJsonData.articuls.profiles[b].width){AppendSceneApiIdsIds(a,MainJsonData.articuls.profiles[b].variants,KupeParams.ProfileMaterial);break}for(var b=0;b<MainJsonData.articuls.doors.length;b++)if(MainJsonData.articuls.doors[b].name==c.doors.type){for(var d=0;d<KupeParams.nDoors;d++)for(var e=0;e<MainJsonData.articuls.doors[b].types.length;e++)if(MainJsonData.articuls.doors[b].types[e].type==KupeParams.doors[d].variantType){AppendSceneApiIdsIds(a,MainJsonData.articuls.doors[b].types[e].variants,KupeParams.ProfileMaterial);break}break}var f=GetDoorByType(KupeParams.DoorsType);if(f)for(var d=0;d<KupeParams.nDoors;d++){for(var g=null,h=0;h<f.variants.length&&null==g;h++)f.variants[h].type==KupeParams.doors[d].variantType&&(g=f.variants[h].sections);if(g)for(var i=0;i<KupeParams.doors[d].sections.length;i++)for(var j=0;j<MainJsonData.articuls.vstavki.length;j++)if(MainJsonData.articuls.vstavki[j].width==f.width&&MainJsonData.articuls.vstavki[j].height==g[i].height){AppendSceneApiIdsIds(a,MainJsonData.articuls.vstavki[j].variants,KupeParams.doors[d].materials[i]);break}}}return a}function UpdatePrice(){var a=GetSceneApiIds(),b=ProblemVstavkaMaterials;ProblemVstavkaMaterials=[];for(var c=[],d=0;d<a.length;d++){var e=a[d],f=e.indexOf("/");if(f>0){c.push({id:parseInt(e.substring(0,f)),error:"Вставки продаютcя только комплектом по 2шт!"});for(var g=0;g<MainJsonData.articuls.vstavki.length;g++)for(var h=0;h<MainJsonData.articuls.vstavki[g].variants.length;h++)MainJsonData.articuls.vstavki[g].variants[h].api_id==e&&ProblemVstavkaMaterials.push(MainJsonData.articuls.vstavki[g].variants[h].color)}else c.push({id:parseInt(e),error:""})}if(Planner3d_UpdatePrice(c),2==iActiveTab&&(b.length||ProblemVstavkaMaterials.length)){var i=document.getElementById("Planner3d_scrollcontent").childNodes;if(i.length&&"TABLE"==i[i.length-1].tagName)for(var j=i[i.length-1].rows,k=0;k<j.length;k++)for(var l=j.item(k).cells,m=0;m<l.length;m++){var n=l.item(m);if(n&&n.childNodes.length&&"DIV"==n.childNodes[0].tagName&&"mat_"==n.childNodes[0].id.substring(0,4)){var o=!ArrayHasItem(ProblemVstavkaMaterials,n.childNodes[0].id.substring(4));o&&n.childNodes[0].childNodes.length?n.childNodes[0].innerHTML="":o||0!=n.childNodes[0].childNodes.length||(n.childNodes[0].innerHTML='<img draggable="false" src="'+HostImgs+'attention.gif" border=0>')}}}}function GetBasketContent(){for(var a=GetSceneApiIds(),b=[],c=0;c<a.length;c++){var d=a[c].indexOf("/"),e=parseInt(d>0?a[c].substring(0,d):a[c]);for(d=0;d<b.length;d++)if(b[d].id==e){b[d].quantity++;break}d==b.length&&b.push({id:e,quantity:1})}return b}function OnShapeLoaded(a,b,c,d){var e=new THREE.Mesh(c,new THREE.MeshFaceMaterial(d));if("Korpus"==a)Korpus3dHolder.add(e);else if("Lamp"==a)for(var f=0;f<Lamp3dHolder.children.length;f++)KupeParams.Lamp||(e.visible=!1),Lamp3dHolder.children[f].add(0==f?e:e.clone());else for(var f=0;Doors3dHoldersMax>f;f++)if(a=="Door"+f)return 1==iActiveTab&&(e.visible=!1),void Doors3dHolders[f].add(e)}function ActivateTab1(){ActivateTab(1)}function ActivateTab2(){ActivateTab(2)}function ActivateTab(a){iActiveTab=a,DoActivateTab("TabInfo"+a,"TabInfo"+(3-a));for(var b=0;b<KupeParams.nDoors;b++)for(var c=0;c<Doors3dHolders[b].children.length;c++)Doors3dHolders[b].children[c].visible=1==iActiveTab?!1:!0;1==iActiveTab&&(ButtColorPicker.style.display="none"),document.getElementById("Planner3d_KorpusVariantsDiv").height=1==iActiveTab?90:57,document.getElementById("Planner3d_TabInfo").height=1==iActiveTab?160:195;var d="";if(1==iActiveTab){d="<font style=\"font-family:'Enter Type';color:#000000;font-size:13px;\">Выбор цвета корпуса</font><br>",d+="<table cellpadding=0 cellspacing=0 onclick=\"Planner3dKupeConstructor.SetKorpusMaterial('',event)\">",d+="<tr>";for(var e=GetKorpusPossibleMaterials(KupeParams.KorpusName),c=0;c<e.length;c++){var f=GetMaterial(e[c]);f&&(d+="<td onmouseover=\"Planner3dKupeConstructor.showPopupMenu('mat_"+e[c]+'\')" onmouseout="Planner3dKupeConstructor.OnPopupOut()" width='+(iconSize+4)+" height="+(iconSize+4)+' valign=middle align=center style="',d+="border:2px solid "+(KupeParams.KorpusMaterial==e[c]?"#ff9e18;":"#ffffff;"),d+='">',d+='<div id="mat_'+e[c]+'" style="width:'+iconSize+"px;height:"+iconSize+"px;background-image:url("+HostIcons+f.icon+');cursor:pointer;" title="'+f.description+'"></div>',d+="</td>")}d+="</tr>",d+="</table>"}if(2==iActiveTab){d+="<table cellpadding=0 cellspacing=0 onclick=\"Planner3dKupeConstructor.SetCurrentVstavkaMaterial('',event)\">",d+="<tr>";var e=GetVstavkaPossibleMaterials(KupeParams.DoorsType);ArrayHasItem(e,CurrentVstavkaMaterial)||(CurrentVstavkaMaterial=e[0]);for(var c=0;c<e.length;c++){c>0&&c%4==0&&(d+="</tr><tr>");var f=GetMaterial(e[c]);f&&(d+="<td onmouseover=\"Planner3dKupeConstructor.showPopupMenu('mat_"+e[c]+'\')" onmouseout="Planner3dKupeConstructor.OnPopupOut()" width='+(iconSize+4)+" height="+(iconSize+4)+' valign=middle align=center style="',d+="border:2px solid "+(CurrentVstavkaMaterial==e[c]?"#ff9e18;":"#ffffff;"),d+='">',d+='<div draggable="true" id="mat_'+e[c]+'" style="width:'+iconSize+"px;height:"+iconSize+"px;background-image:url("+HostIcons+f.icon+');cursor:pointer;text-align:right;" ondragstart="Planner3dKupeConstructor.onDragMatStart(\''+e[c]+'\', event)" ondragend="Planner3dKupeConstructor.onDragMatEnd()"  title="'+f.description+'">',ArrayHasItem(ProblemVstavkaMaterials,e[c])&&(d+='<img draggable="false" src="'+HostImgs+'attention.gif" border=0>'),d+="</div>",d+="</td>")}d+="</tr>",d+="</table>"}1==iActiveTab?document.getElementById("Planner3d_TabInfo"+iActiveTab).innerHTML=d:document.getElementById("Planner3d_scrollcontent").innerHTML=d,d=1==iActiveTab?"<font style=\"font-family:'Enter Type';color:#000000;font-size:13px;\">Выбор цвета профиля</font><br>":"<font style=\"font-family:'Enter Type';color:#000000;font-size:13px;\">Выбор цвета рамки</font><br>",d+="<table cellpadding=0 cellspacing=0>",d+="<tr>";for(var e=GetProfilePossibleMaterials(KupeParams.KorpusName),c=0;c<e.length;c++){var g=50,h=42,f=GetMaterial(e[c]);f&&(d+="<td width="+(g+6)+" height="+(h+6)+' valign=middle align=center style="',d+=KupeParams.ProfileMaterial==e[c]?"border:2px solid #ff9e18;":"border:2px solid #ffffff;",d+='">',d+='<img ondragstart="Planner3dKupeConstructor.stopStart(event)" onclick="Planner3dKupeConstructor.SetProfileMaterial(\''+e[c]+"',event)\" width="+g+" height="+h+' src="'+HostIcons+f.icon+'" title="'+f.description+'">',d+="</td>")}d+="</tr>",d+="</table>",document.getElementById("Planner3d_ProfileVariantsDiv").innerHTML=d;GetKorpusByName(KupeParams.KorpusName);MainJsonData.articuls.lamps&&(d="<font style=\"font-family:'Enter Type';color:#000000;font-size:13px;\">Подсветка</font><br>",d+="<table cellpadding=0 cellspacing=0>",d+="<tr>",d+='<td valign=middle align=center style="',d+=KupeParams.Lamp?"border:2px solid #ff9e18;":"border:2px solid #ffffff;",d+='">',d+='<img ondragstart="Planner3dKupeConstructor.stopStart(event)" onclick="Planner3dKupeConstructor.SwitchLamp(event)" width='+g+" height="+h+' src="'+HostImgs+'lamp.png">',d+="</td>",d+="</tr>",d+="</table>",document.getElementById("Planner3d_LampVariantsDiv").innerHTML=d),UpdateKorpusesDiv()}function UnborderTableCells(a,b){for(var c=a.rows,d=0;d<c.length;d++)for(var e=c.item(d).cells,f=0;f<e.length;f++){var g=e.item(f);g&&g!=b&&(g.style.borderColor="#FFFFFF")}}function SetKorpusMaterial(a,b){if(SetKorpusMaterial.arguments.length>=2){if("DIV"!=b.target.tagName||"mat_"!=b.target.id.substring(0,4))return;a=b.target.id.substring(4)}var c=GetMaterial(a);if(c&&(Korpus3dHolder.children[0].material=LoadMaterialByName(a),KupeParams.KorpusMaterial=a,SetKorpusMaterial.arguments.length>=2)){var d=b.target?b.target.offsetParent:null;"TD"==d.tagName&&(UnborderTableCells(d.offsetParent,d),d.style.borderColor="#ff9e18")}SetKorpusMaterial.arguments.length>=2&&UpdatePrice()}function SetCurrentVstavkaMaterial(a,b){if(SetCurrentVstavkaMaterial.arguments.length>=2){var c=b.target;if("IMG"==c.tagName&&"DIV"==c.parentNode.tagName&&"mat_"==c.parentNode.id.substring(0,4)&&(c=c.parentNode),"DIV"!=c.tagName&&"IMG"!=c.tagName||"mat_"!=c.id.substring(0,4))return;a=c.id.substring(4),LoadMaterialByName(a),CurrentVstavkaMaterial=a;var d=c?c.offsetParent:null;d&&"TD"==d.tagName&&(UnborderTableCells(d.offsetParent,d),d.style.borderColor="#ff9e18")}else CurrentVstavkaMaterial=a}function SetProfileMaterial(a,b){var c=LoadMaterialByName(a);Korpus3dHolder.children[1].material=c,KupeParams.ProfileMaterial=a;for(var d=0;d<KupeParams.nDoors;d++)Doors3dHolders[d].children.length>0&&(Doors3dHolders[d].children[0].material=c);if(SetProfileMaterial.arguments.length>=2){var e=b.target?b.target.offsetParent:null;"TD"==e.tagName&&(UnborderTableCells(e.offsetParent,e),e.style.borderColor="#ff9e18"),UpdatePrice()}}function SwitchLamp(a){if(KupeParams.Lamp=1-KupeParams.Lamp,SwitchLamp.arguments.length>=1){var b=a.target?a.target.offsetParent:null;"TD"==b.tagName&&(b.style.borderColor=KupeParams.Lamp?"#ff9e18":"#ffffff")}for(var c=0;c<Lamp3dHolder.children.length;c++)for(var d=0;d<Lamp3dHolder.children[c].children.length;d++)Lamp3dHolder.children[c].children[d].visible=KupeParams.Lamp?!0:!1}function DoActivateTab(a,b){for(var c=0;c<DoActivateTab.arguments.length;c++){var d=document.getElementById("Planner3d_"+DoActivateTab.arguments[c]),e=document.getElementById("Planner3d_"+DoActivateTab.arguments[c]+"Header");d&&e&&(e.style.borderBottom=0==c?"2px #ff9e18 solid":"0px",d.style.display=0==c?"block":"none",e.style.color=0==c?"#000000":"#666666",e.style.cursor=0==c?"default":"pointer",e.style.fontWeight=0==c?"bold":"normal")}}function GetKorpusPossibleMaterials(a){if(MainJsonData.articuls){for(var b=0;b<MainJsonData.articuls.korpuses.length;b++)if(MainJsonData.articuls.korpuses[b].name==a)return GetColorsArrayFromVariants(MainJsonData.articuls.korpuses[b].variants);return["oak_milk"]}return["oak_milk","oak_ferrara","apple_locarno"]}function GetVstavkaPossibleMaterials(a,b,c){var d=[];if(MainJsonData.articuls){var e=GetDoorByType(a),f=0;if(b)for(var g=GetDoorVariants(e),h=0;h<g.length;h++)if(g[h].type==b){f=g[h].sections[c].height;break}for(var i=[],j=0;j<MainJsonData.articuls.vstavki.length;j++)if(MainJsonData.articuls.vstavki[j].width==e.width&&(0==f||MainJsonData.articuls.vstavki[j].height==f))for(var k=0;k<MainJsonData.articuls.vstavki[j].variants.length;k++)ArrayHasItem(i,MainJsonData.articuls.vstavki[j].variants[k].color)||i.push(MainJsonData.articuls.vstavki[j].variants[k].color);for(var h=0;h<MainJsonData.materials.length;h++)ArrayHasItem(i,MainJsonData.materials[h].name)&&d.push(MainJsonData.materials[h].name)}else for(var h=0;h<MainJsonData.materials.length;h++)0!=MainJsonData.materials[h].name.indexOf("Profile")&&d.push(MainJsonData.materials[h].name);return d}function GetColorsArrayFromVariants(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c].color);return b}function GetProfilePossibleMaterials(a){if(MainJsonData.articuls){var b=GetKorpusByName(a);if(b)for(var c=0;c<MainJsonData.articuls.profiles.length;c++)if(b.width==MainJsonData.articuls.profiles[c].width)return GetColorsArrayFromVariants(MainJsonData.articuls.profiles[c].variants);return["ProfileSilver"]}return["ProfileSilver","ProfileBronza","ProfileZoloto","ProfileShampan"]}function GetMaterial(a){for(var b=0;b<MainJsonData.materials.length;b++)if(MainJsonData.materials[b].name==a)return MainJsonData.materials[b]}function GetDoorVariant(a,b){if(void 0!=a)for(var c=0;c<b.length;c++)if(b[c].type==a)return b[c]}function GetKorpusByName(a){for(var b=0;b<MainJsonData.korpuses.length;b++)if(MainJsonData.korpuses[b].name==a)return MainJsonData.korpuses[b]}function GetDoorByType(a){for(var b=0;b<MainJsonData.doors.length;b++)if(MainJsonData.doors[b].type==a)return MainJsonData.doors[b]}function ClearChildren(a){for(var b=a.children.length-1;b>=0;b--)a.remove(a.children[b])}function GetDoorVariants(a){if(MainJsonData.articuls){for(var b=[],c=0;c<MainJsonData.articuls.doors.length;c++)if(MainJsonData.articuls.doors[c].name==a.type)for(var d=MainJsonData.articuls.doors[c].types,e=0;e<a.variants.length;e++)for(var f=0;f<d.length;f++)if(a.variants[e].type==d[f].type){b.push(a.variants[e]);break}return b}return a.variants}function UpdateKupeDoor(a){var b=GetKorpusByName(KupeParams.KorpusName);if(void 0!=b){var c=GetDoorByType(b.doors.type),d=GetDoorVariants(c);ClearChildren(Doors3dHolders[a]);var e=GetDoorVariant(KupeParams.doors[a].variantType,d);if(void 0!=e){KupeParams.doors[a].sections=e.sections;for(var f=0;f<KupeParams.doors[a].sections.length;f++){var g=GetVstavkaPossibleMaterials(KupeParams.DoorsType,KupeParams.doors[a].variantType,f);ArrayHasItem(g,KupeParams.doors[a].materials[f])||(KupeParams.doors[a].materials[f]=g[0])}Doors3dHolders[a].position.z=a%2==0?c.shiftSecondRail:0,Doors3dHolders[a].position.x=0==a?-.5*b.width+b.DspThickness+.5*c.width:a==b.doors.count-1?.5*b.width-b.DspThickness-.5*c.width:0;for(var h=0;h<e.shapes.length;h++)loader.createModel(e.shapes[h],function(b,c){OnShapeLoaded("Door"+a,h,b,c)},"");UpdateKupeDoorMaterial(a)}}}function UpdateKupeDoorMaterial(a,b){var c=Doors3dHolders[a].children;if(UpdateKupeDoorMaterial.arguments.length>=2)b<KupeParams.doors[a].sections.length&&c.length>b+1&&void 0!=KupeParams.doors[a].materials[b]&&KupeParams.doors[a].materials[b].length&&(c[1+b].material=LoadMaterialByName(KupeParams.doors[a].materials[b]));else{c.length&&void 0!=KupeParams.ProfileMaterial&&(c[0].material=LoadMaterialByName(KupeParams.ProfileMaterial));for(var d=0;d<KupeParams.doors[a].sections.length;d++)c.length>d+1&&void 0!=KupeParams.doors[a].materials[d]&&KupeParams.doors[a].materials[d].length&&(c[1+d].material=LoadMaterialByName(KupeParams.doors[a].materials[d]))}}function UpdateKorpusesDiv(){var a="<table cellpadding=0 cellspacing=0>";if(1==iActiveTab){var b,c=[];for(b=0;b<MainJsonData.korpuses.length;b++){var d,e=Math.round(1e3*MainJsonData.korpuses[b].width);for(d=0;d<c.length&&e>c[d][0];d++);if(d==c.length)c.push(new Array(e,MainJsonData.korpuses[b]));else if(e==c[d][0])c[d].push(MainJsonData.korpuses[b]);else{c.length++;for(var f=c.length-1;f>d;f--)c[f]=c[f-1];c[d]=new Array(e,MainJsonData.korpuses[b])}}for(var g=GetKorpusByName(KupeParams.KorpusName),h=Math.round(1e3*g.width),i=0;2>i;i++){for(a+="<tr>",b=0;b<c.length;b++){var j=c[b][1];c[b][0]==h&&(j=g),a+='<td align=center style="cursor:pointer;';var k=c[b][0]==h?"#ff9e18":"#ffffff";a+="border-"+(0==i?"top":"bottom")+":2px solid "+k+";border-left:2px solid "+k+";border-right:2px solid "+k+";",1==i&&(a+="font-family:Arial;font-size:9px;"),a+='" onmouseover="Planner3dKupeConstructor.showPopupMenu(\'door_'+c[b][0]+'\',event.target)" onmouseout="Planner3dKupeConstructor.OnPopupOut()"',a+=0==i?" valign=bottom width=80 height=47 onclick=\"Planner3dKupeConstructor.SetKorpus('"+j.name+'\')"><img ondragstart="Planner3dKupeConstructor.stopStart(event)" src="'+HostImgs+"korpus_"+c[b][0]+'.png" >':">"+c[b][0]+" мм",a+="</td>"}a+="</tr>"}}if(2==iActiveTab){a+="<tr>";for(var l=0;l<KupeParams.nDoors;l++){var m=KupeParams.doors[l];a+='<td align=center style="cursor:pointer;" onmouseover="Planner3dKupeConstructor.showPopupMenu(\'dsb_'+l+'\',event.target)" onmouseout="Planner3dKupeConstructor.OnPopupOut()" valign=bottom width=40 height=43><img ondragstart="Planner3dKupeConstructor.stopStart(event)" src="'+HostImgs+"icon_door_variant_"+m.variantType+'.gif" width=36 height=36>',a+="</td>"}a+="</tr>"}a+="</table>",document.getElementById("Planner3d_KorpusVariantsDiv").innerHTML=a,cPopupMenu&&1==iActiveTab&&"door_"==cPopupMenu.substring(0,5)&&CreateDoorPopup(PopupMenuDiv,parseInt(cPopupMenu.substring(5))),cPopupMenu&&2==iActiveTab&&"dsb_"==cPopupMenu.substring(0,4)&&CreateDsbPopup(PopupMenuDiv,parseInt(cPopupMenu.substring(4)))}function SetKorpus(a){KupeParams.KorpusName=a,CreateFullKupe(),UpdateKorpusesDiv(),UpdatePrice()}function CreateFullKupe(){ClearChildren(Korpus3dHolder),ClearChildren(Lamp3dHolder);for(var a=GetKorpusByName(KupeParams.KorpusName),b=a.width>1.5?3:2,c=0;b>c;c++){var d=new THREE.Object3D;d.position.x=-.5*a.width+(c+.5)*a.width/b,Lamp3dHolder.add(d)}KupeParams.nDoors=a.doors.count,(void 0==iActiveDoor||iActiveDoor>=KupeParams.nDoors)&&(iActiveDoor=0),KupeParams.DoorsType=a.doors.type;for(var c=0;c<a.shapes.length;c++)loader.createModel(a.shapes[c],function(a,b){OnShapeLoaded("Korpus",c,a,b)},"");for(var c=0;c<MainJsonData.lamp.length;c++)loader.createModel(MainJsonData.lamp[c],function(a,b){OnShapeLoaded("Lamp",c,a,b)},"");var e=GetDoorByType(KupeParams.DoorsType);if(e)for(var f=GetDoorVariants(e),g=0;Doors3dHoldersMax>g;g++)g<a.doors.count?(void 0==GetDoorVariant(KupeParams.doors[g].variantType,f)&&(KupeParams.doors[g].variantType=f[0].type),UpdateKupeDoor(g)):ClearChildren(Doors3dHolders[g]);SetKorpusMaterial(KupeParams.KorpusMaterial),SetProfileMaterial(KupeParams.ProfileMaterial)}function onDocumentMouseDown(a){var b=a.pageX-getGlobalOffsetX(MainDiv),c=a.pageY-getGlobalOffsetY(MainDiv);if(2==a.button)a.preventDefault(),(!MSIE||MSIE>=11)&&(bMouseNavigationActive=!0,document.addEventListener("mouseup",onDocumentMouseUp,!1),document.addEventListener("mouseout",onDocumentMouseOut,!1),mouseXOnMouseDown=b-windowHalfX,targetRotationOnMouseDown=NormAngle(targetRotation),bMouseMoveBetweenClick=0);else if(0==a.button){if(2==iActiveTab&&b>=0&&Window3dWidth>b&&c>=0&&Window3dHeight>c){mouse2D.x=b/Window3dWidth*2-1,mouse2D.y=2*-(c/Window3dHeight)+1,raycaster=projector.pickingRay(mouse2D.clone(),camera);var d=raycaster.intersectObjects(scene.children,!0);if(d.length&&d[0].object.parent==Korpus3dHolder);else if(d.length)for(var e=0;e<KupeParams.nDoors;e++)if(d[0].object.parent==Doors3dHolders[e]){var f=GetDoorByType(KupeParams.DoorsType);if(void 0!=f)for(var g=0;g<KupeParams.doors[e].sections.length;g++)if(d[0].object==Doors3dHolders[e].children[1+g]){var h=GetVstavkaPossibleMaterials(KupeParams.DoorsType,KupeParams.doors[e].variantType,g);ArrayHasItem(h,CurrentVstavkaMaterial)&&(KupeParams.doors[e].materials[g]=CurrentVstavkaMaterial,UpdateKupeDoorMaterial(iActiveDoor,g),UpdatePrice());break}}}}else if(1==a.button&&b>=0&&Window3dWidth>b&&c>=0&&Window3dHeight>c){a.preventDefault(),mouse2D.x=b/Window3dWidth*2-1,mouse2D.y=2*-(c/Window3dHeight)+1,raycaster=projector.pickingRay(mouse2D.clone(),camera);var d=raycaster.intersectObjects(scene.children,!0);if(d.length){var i=d[0].point.clone().sub(camera.position),j=new THREE.Quaternion;j.setFromEuler(camera.rotation);var k=new THREE.Vector3(0,0,-1);k.applyQuaternion(j),fPanDistance=i.dot(k)}else fPanDistance=cameraDistance;last_pan_X=b,last_pan_Y=c,bPanActive=!0,document.addEventListener("mouseup",onDocumentMouseUp,!1),document.addEventListener("mouseout",onDocumentMouseOut,!1)}}function onDocumentMouseMove(a){var b=a.pageX-getGlobalOffsetX(MainDiv),c=a.pageY-getGlobalOffsetY(MainDiv);if(bMouseNavigationActive&&(bMouseMoveBetweenClick=1,mouseX=b-windowHalfX,targetRotation=targetRotationOnMouseDown+.02*(mouseX-mouseXOnMouseDown)),bPanActive&&(last_pan_X!=b||last_pan_Y!=c)){var d=new THREE.Vector3(1*last_pan_X/Window3dWidth*2-1,2*-(1*last_pan_Y/Window3dHeight)+1,.5);projector.unprojectVector(d,camera),d.sub(camera.position);var e=new THREE.Vector3(1*b/Window3dWidth*2-1,2*-(1*c/Window3dHeight)+1,.5);projector.unprojectVector(e,camera),e.sub(camera.position);var f=new THREE.Quaternion;f.setFromEuler(camera.rotation);var g=new THREE.Vector3(0,0,-1);g.applyQuaternion(f);var h=d.dot(g),i=e.dot(g);if(h>0&&i>0){camera.position.y+=fPanDistance*(d.y/h-e.y/i);var j=Math.sin(camera.rotation.y),k=Math.cos(camera.rotation.y);cameraXshift+=fPanDistance*(d.x/h-e.x/i)*k-fPanDistance*(d.z/h-e.z/i)*j,last_pan_X=b,last_pan_Y=c}}On3dMouseMove(b,c),a.stopPropagation()}function On3dMouseMove(a,b){var c=iActiveDoor;if(a>=0&&Window3dWidth>a&&b>=0&&Window3dHeight>b){var d="default";if(2==iActiveTab){mouse2D.x=a/Window3dWidth*2-1,mouse2D.y=2*-(b/Window3dHeight)+1,raycaster=projector.pickingRay(mouse2D.clone(),camera);var e=raycaster.intersectObjects(scene.children,!0);if(e.length&&e[0].object.parent==Korpus3dHolder);else if(e.length)for(var f=0;f<KupeParams.nDoors;f++)if(e[0].object.parent==Doors3dHolders[f]){iActiveDoor=f;var g=GetDoorByType(KupeParams.DoorsType);if(void 0!=g){for(var h=0;h<KupeParams.doors[f].sections.length;h++)if(e[0].object==Doors3dHolders[f].children[1+h]){iActiveDoorSection=h;var i=GetVstavkaPossibleMaterials(KupeParams.DoorsType,KupeParams.doors[f].variantType,h);ArrayHasItem(i,CurrentVstavkaMaterial)&&(d="url("+HostImgs+"brush.cur), pointer");break}h==KupeParams.doors[f].sections.length&&(iActiveDoorSection=-1)}break}}renderer.domElement.style.cursor=d;

}else iActiveDoor=-1;iActiveDoor>=0?showPopupMenu("ds_"+iActiveDoor):c!=iActiveDoor&&void 0!=cPopupMenu&&"ds_"==cPopupMenu.substring(0,3)&&OnPopupOut()}function onDocumentContextMenu(){event.preventDefault()}function onDocumentMouseUp(a){(2==a.button||1==a.button)&&(a.preventDefault(),bMouseNavigationActive=!1,bPanActive=!1,document.removeEventListener("mouseup",onDocumentMouseUp,!1),document.removeEventListener("mouseout",onDocumentMouseOut,!1))}function onDocumentMouseOut(a){bMouseNavigationActive=!1,bPanActive=!1,document.removeEventListener("mouseup",onDocumentMouseUp,!1),document.removeEventListener("mouseout",onDocumentMouseOut,!1)}function onDocumentTouchStart(a){1==a.touches.length&&(a.preventDefault(),mouseXOnMouseDown=a.touches[0].pageX-windowHalfX,targetRotationOnMouseDown=NormAngle(targetRotation))}function onDocumentTouchMove(a){1==a.touches.length&&(a.preventDefault(),mouseX=a.touches[0].pageX-windowHalfX,targetRotation=targetRotationOnMouseDown+.05*(mouseX-mouseXOnMouseDown))}function onMouseWheel(a){a.wheelDelta>0?cameraDistance*=1-Math.min(.2,5e-4*a.wheelDelta):cameraDistance/=1-Math.min(.2,-5e-4*a.wheelDelta),a.preventDefault(),a.stopPropagation()}function hidePopup(){PopupMenuDiv.style.display="none",(void 0!=cPopupMenu&&("door_"==cPopupMenu.substring(0,5)||"mat_"==cPopupMenu.substring(0,4))||"dsb_"==cPopupMenu.substring(0,4))&&(document.getElementById("Planner3d_ProfileVariantsDiv").style.visibility="visible",document.getElementById("Planner3d_LampVariantsDiv").style.visibility="visible",document.getElementById("Planner3d_TabInfo1").style.visibility="visible",document.getElementById("Planner3d_TabInfo2").style.visibility="visible"),null!=hideTimeout&&(clearTimeout(hideTimeout),hideTimeout=null),cPopupMenu=null}function getGlobalOffsetX(a,b){var c,d=0;for(c=a;"BODY"!=c.tagName&&c!=b;c=c.offsetParent)d+=c.offsetLeft;return d}function getGlobalOffsetY(a,b){var c,d=0;for(c=a;"BODY"!=c.tagName&&c!=b;c=c.offsetParent)d+=c.offsetTop;return d}function OnPopupOut(){null==hideTimeout&&(hideTimeout=setTimeout(hidePopup,100))}function CreateDoorPopup(a,b){var c=GetKorpusByName(KupeParams.KorpusName),d="<table cellpadding=0 cellspacing=0>";d+="";for(var e=0;e<MainJsonData.korpuses.length;e++)if(b==Math.round(1e3*MainJsonData.korpuses[e].width)){d+="<tr>";for(var f=0;2>f;f++){d+='<td style="cursor:pointer;padding-left:4px;padding-top:4px;padding-right:4px;',1==f&&(d+="font-family:Arial;font-size:9px;color:#666666;");var g=MainJsonData.korpuses[e]==c?"#ff9e18":"#ffffff";d+="border-"+(0==f?"left":"right")+":2px solid "+g+";border-top:2px solid "+g+";border-bottom:2px solid "+g+";",d+='" ',0==f&&(d+=" align=center"),d+=" onclick=\"Planner3dKupeConstructor.SetKorpus('"+MainJsonData.korpuses[e].name+"')\">",d+=0==f?'<img src="'+HostIcons+MainJsonData.korpuses[e].icon+'" height=37>':"глубина "+Math.round(1e3*MainJsonData.korpuses[e].depth)+" мм<br>"+MainJsonData.korpuses[e].doors.count+" двери",d+="</td>"}d+="</tr>"}d+="",d+="</table>",a.innerHTML=d}function CreateDsbPopup(a,b){var b=parseInt(cPopupMenu.substring(4)),c='<table cellpadding=0 cellspacing=0 style="background-color:#FFFFFF">',d=GetDoorByType(KupeParams.DoorsType),e=GetDoorVariants(d);if(d)for(var f=0;f<e.length;f++){c+="<tr>";for(var g=0;2>g;g++){c+='<td style="cursor:pointer;padding-left:4px;padding-top:4px;padding-right:4px;',1==g&&(c+="font-family:Arial;font-size:9px;color:#666666;");var h=KupeParams.doors[b].variantType==e[f].type?"#ff9e18":"#ffffff";c+="border-"+(0==g?"left":"right")+":2px solid "+h+";border-top:2px solid "+h+";border-bottom:2px solid "+h+";",c+='" ',0==g&&(c+=" align=center"),c+=' onclick=\'Planner3dKupeConstructor.OnClickSmallButt(event,"set_variant","'+e[f].type+'","'+b+"\")'>",c+=0==g?'<img src="'+HostImgs+"icon_door_variant_"+e[f].type+'.gif" width=36 height=36 border=0>':1==e[f].type?e[f].type+" секция":e[f].type+" секции",c+="</td>"}c+="</tr>"}c+="</table>",a.innerHTML=c}function showPopupMenu(a,b){if(null!=hideTimeout&&(clearTimeout(hideTimeout),hideTimeout=null),!(0==showPopupMenu.arguments.length||a instanceof Event)&&cPopupMenu!=a){cPopupMenu=a,"door_"==cPopupMenu.substring(0,5)||"mat_"==cPopupMenu.substring(0,4)||"dsb_"==cPopupMenu.substring(0,4)?("mat_"==cPopupMenu.substring(0,4)&&(document.getElementById("Planner3d_ProfileVariantsDiv").style.visibility="hidden",document.getElementById("Planner3d_LampVariantsDiv").style.visibility="hidden"),document.getElementById("Planner3d_TabInfo1").style.visibility="mat_"!=cPopupMenu.substring(0,4)?"hidden":"visible",document.getElementById("Planner3d_TabInfo2").style.visibility="mat_"!=cPopupMenu.substring(0,4)?"hidden":"visible"):"ds_"==cPopupMenu.substring(0,3)&&(document.getElementById("Planner3d_ProfileVariantsDiv").style.visibility="visible",document.getElementById("Planner3d_LampVariantsDiv").style.visibility="visible",document.getElementById("Planner3d_TabInfo1").style.visibility="visible",document.getElementById("Planner3d_TabInfo2").style.visibility="visible");var c=PopupMenuDiv;if(c.style.display="block","door_"==cPopupMenu.substring(0,5)){CreateDoorPopup(c,parseInt(cPopupMenu.substring(5)));var d=getGlobalOffsetX(b,MainDiv),e=document.getElementById("Planner3d_KorpusVariantsDiv");d+c.offsetWidth>getGlobalOffsetX(e,MainDiv)+e.offsetWidth-1&&(d=getGlobalOffsetX(e,MainDiv)+e.offsetWidth-c.offsetWidth-1),c.style.left=d+"px",c.style.top=getGlobalOffsetY(e,MainDiv)+e.offsetHeight+"px"}else if("mat_"==cPopupMenu.substring(0,4)){var f=GetMaterial(cPopupMenu.substring(4));if(void 0!=f){var g='<div style="width:149px;height:89px;background-image:url('+HostIcons+f.icon+');"></div>';g+='<div style="width:149px;text-align:center;font-family:Arial;font-size:9px;color:#666666;">'+f.description+"</div>",c.innerHTML=g}c.style.left=getGlobalOffsetX(document.getElementById("Planner3d_LampVariantsDiv"),MainDiv)+44+"px",c.style.top=getGlobalOffsetY(document.getElementById("Planner3d_LampVariantsDiv"),MainDiv)+25+"px"}else if("ds_"==cPopupMenu.substring(0,3)){var h=parseInt(cPopupMenu.substring(3)),g='<table cellpadding=0 cellspacing=0 style="background-color:#FFFFFF"><tr>',i=GetDoorByType(KupeParams.DoorsType),j=GetDoorVariants(i);if(i)for(var k=0;k<j.length;k++)g+="<td height=30 valign=middle",KupeParams.doors[iActiveDoor].variantType==j[k].type&&(g+=' style="border:2px solid #ff9e18;"'),g+='><img src="'+HostImgs+"icon_door_variant_"+j[k].type+'_sm.gif" style="cursor:pointer" width=20 height=24 border=0 onclick=\'Planner3dKupeConstructor.OnClickSmallButt(event,"set_variant","'+j[k].type+'","'+h+"\")'></td>";g+="</tr></table>",c.innerHTML=g}else if("dsb_"==cPopupMenu.substring(0,4)){CreateDsbPopup(c,parseInt(cPopupMenu.substring(4)));var d=getGlobalOffsetX(b,MainDiv),e=document.getElementById("Planner3d_KorpusVariantsDiv");d+c.offsetWidth>getGlobalOffsetX(e,MainDiv)+e.offsetWidth&&(d=getGlobalOffsetX(e,MainDiv)+e.offsetWidth-c.offsetWidth),c.style.left=d+"px",c.style.top=getGlobalOffsetY(e,MainDiv)+e.offsetHeight+"px"}}}function ClearPlayTimeInterval(){playTimeInterval&&(clearInterval(playTimeInterval),playTimeInterval=null)}function OnPressSmallButtRotateL(event,idStr){ClearPlayTimeInterval(),(""==idStr||"RotateR"==idStr)&&(targetRotation=-camera.rotation.y),eval("ProcessPressAction('"+idStr+"')"),playTimeInterval=setInterval("ProcessPressAction('"+idStr+"')",30)}function OnPressSmallButtRotateL(a,b){ClearPlayTimeInterval(),targetRotation=-camera.rotation.y,document.addEventListener("mouseup",OnReleaseSmallButt,!1),ProcessPressActionRotateL(),playTimeInterval=setInterval(ProcessPressActionRotateL,30)}function OnPressSmallButtRotateR(a,b){ClearPlayTimeInterval(),targetRotation=-camera.rotation.y,document.addEventListener("mouseup",OnReleaseSmallButt,!1),ProcessPressActionRotateR(),playTimeInterval=setInterval(ProcessPressActionRotateR,30)}function OnPressSmallButtZoomIn(a,b){ClearPlayTimeInterval(),document.addEventListener("mouseup",OnReleaseSmallButt,!1),ProcessPressActionZoomIn(),playTimeInterval=setInterval(ProcessPressActionZoomIn,30)}function OnPressSmallButtZoomOut(a,b){ClearPlayTimeInterval(),document.addEventListener("mouseup",OnReleaseSmallButt,!1),ProcessPressActionZoomOut(),playTimeInterval=setInterval(ProcessPressActionZoomOut,30)}function ProcessPressActionRotateR(){targetRotation+=.2}function ProcessPressActionRotateL(){targetRotation-=.2}function ProcessPressActionZoomIn(){cameraDistance*=1-Math.min(.2,.0025)}function ProcessPressActionZoomOut(){cameraDistance/=1-Math.min(.2,.0025)}function OnReleaseSmallButt(){document.removeEventListener("mouseup",OnReleaseSmallButt,!1),ClearPlayTimeInterval()}function OnClickSmallButtColorPicker(a){OnClickSmallButt(a,"colorpicker",0)}function OnClickSmallButt(a,b,c,d){if("set_variant"==b){KupeParams.doors[d].variantType=c,UpdateKupeDoor(d);var e=cPopupMenu;cPopupMenu=void 0,void 0!=e&&"dsb_"==e.substring(0,4)?(cPopupMenu=e,CreateDsbPopup(PopupMenuDiv,parseInt(cPopupMenu.substring(4)))):showPopupMenu(e),UpdateKorpusesDiv(),UpdatePrice()}else"colorpicker"==b&&iActiveDoorSection>=0&&iActiveDoorSection<KupeParams.doors[iActiveDoor].sections.length&&(CurrentVstavkaMaterial=KupeParams.doors[iActiveDoor].materials[iActiveDoorSection],ActivateTab(iActiveTab))}function stopStart(a){a.preventDefault(),a.stopPropagation()}function _onFinishStart(){return!1}function onDragMatStart(a,b){LoadMaterialByName(a),b.dataTransfer.setData("text",a),curDragMat=a,b.stopPropagation()}function onDragMatEnd(){curDragMat=""}function onDropHandler(a){var b=a.pageX-getGlobalOffsetX(MainDiv),c=a.pageY-getGlobalOffsetY(MainDiv);if(b>=0&&Window3dWidth>b&&c>=0&&Window3dHeight>c){mouse2D.x=b/Window3dWidth*2-1,mouse2D.y=2*-(c/Window3dHeight)+1,raycaster=projector.pickingRay(mouse2D.clone(),camera);var d=raycaster.intersectObjects(scene.children,!0);if(d.length&&d[0].object.parent==Korpus3dHolder)return;if(d.length)for(var e=0;e<KupeParams.nDoors;e++)if(d[0].object.parent==Doors3dHolders[e]){var f=GetDoorByType(KupeParams.DoorsType);if(void 0!=f)for(var g=0;g<KupeParams.doors[e].sections.length;g++)if(d[0].object==Doors3dHolders[e].children[1+g]){var h=GetVstavkaPossibleMaterials(KupeParams.DoorsType,KupeParams.doors[e].variantType,g);ArrayHasItem(h,curDragMat)&&(KupeParams.doors[e].materials[g]=curDragMat,UpdateKupeDoorMaterial(e,g),UpdatePrice());break}return}}}function onDragOver(a){a.dataTransfer.getData("text");if(a.dataTransfer.dropEffect="none",curDragMat&&curDragMat.length){a.preventDefault&&a.preventDefault();var b=a.pageX-getGlobalOffsetX(MainDiv),c=a.pageY-getGlobalOffsetY(MainDiv);if(b>=0&&Window3dWidth>b&&c>=0&&Window3dHeight>c){mouse2D.x=b/Window3dWidth*2-1,mouse2D.y=2*-(c/Window3dHeight)+1,raycaster=projector.pickingRay(mouse2D.clone(),camera);var d=raycaster.intersectObjects(scene.children,!0);if(d.length&&d[0].object.parent!=Korpus3dHolder)for(var e=0;e<KupeParams.nDoors;e++)if(d[0].object.parent==Doors3dHolders[e]){var f=GetDoorByType(KupeParams.DoorsType);if(void 0!=f)for(var g=0;g<KupeParams.doors[e].sections.length;g++)if(d[0].object==Doors3dHolders[e].children[1+g]){var h=GetVstavkaPossibleMaterials(KupeParams.DoorsType,KupeParams.doors[e].variantType,g);ArrayHasItem(h,curDragMat)&&(a.dataTransfer.dropEffect="copy");break}return}}}}function onDragEnter(a){return curDragMat&&curDragMat.length?(a.preventDefault&&a.preventDefault(),a.dataTransfer.dropEffect="copy"):a.dataTransfer.dropEffect="none",!1}function Project3dPointTo2d(a,b,c){var d=projector.projectVector(new THREE.Vector3(a,b,c),camera);return{x:Math.round(d.x*Window3dWidth*.5+Window3dWidth/2),y:Math.round(Window3dHeight/2-d.y*Window3dHeight*.5)}}function animate(){if(requestAnimationFrame(animate),render(),2==iActiveTab)if(Doors3dHolders[0].children.length>0&&iActiveDoor>=0){if(void 0!=cPopupMenu&&"ds_"==cPopupMenu.substring(0,3)){Doors3dHolders[iActiveDoor].children[0].geometry.computeBoundingBox();var a=Doors3dHolders[iActiveDoor].children[0].geometry.boundingBox,b=Project3dPointTo2d(.5*(a.min.x+a.max.x)+Doors3dHolders[iActiveDoor].position.x,a.max.y+Doors3dHolders[iActiveDoor].position.y,a.max.z+Doors3dHolders[iActiveDoor].position.z),c=PopupMenuDiv;b.x-30<0&&(b.x=30),b.x+30>=Window3dWidth&&(b.x=Window3dWidth-30),b.y<16&&(b.y=16),b.y+28>=Window3dHeight&&(b.y=Window3dHeight-28),c.style.left=b.x-30+"px",c.style.top=Math.round(b.y-16)+"px"}if(iActiveDoorSection>=0&&iActiveDoorSection<KupeParams.doors[iActiveDoor].sections.length){Doors3dHolders[iActiveDoor].children[1+iActiveDoorSection].geometry.computeBoundingBox();var a=Doors3dHolders[iActiveDoor].children[1+iActiveDoorSection].geometry.boundingBox,b=Project3dPointTo2d(a.min.x+Doors3dHolders[iActiveDoor].position.x,a.min.y+Doors3dHolders[iActiveDoor].position.y,a.max.z+Doors3dHolders[iActiveDoor].position.z);ButtColorPicker.style.left=b.x+"px",ButtColorPicker.style.top=Math.round(b.y-26)+"px",ButtColorPicker.style.display="block"}else ButtColorPicker.style.display="none"}else ButtColorPicker.style.display="none";stats&&stats.update()}function render(){var a=NormAngle(camera.rotation.y+.05*(-targetRotation-camera.rotation.y));camera.rotation.y=Math.abs(a)>1.483529886111111?3.1415927*(a>0?1:-1)/2*(17/18):a;var b=Math.sin(camera.rotation.y),c=Math.cos(camera.rotation.y);2>cameraDistance?cameraDistance=2:cameraDistance>25&&(cameraDistance=25),camera.position.x=b*cameraDistance+cameraXshift*c,camera.position.z=c*cameraDistance-cameraXshift*b,renderer.render(scene,camera)}var container,stats,mouse2D,camera,scene,renderer,cameraDistance=15,cameraXshift=0,stats,mouseX=0,mouseY=0,raycaster,projector,Window3dWidth=430,Window3dHeight=450,windowHalfX=Window3dWidth/2,windowHalfY=Window3dHeight/2,iconSize=50,bMouseMoveBetweenClick,bMouseNavigationActive=0,targetRotation=0,targetRotationOnMouseDown=0,mouseXOnMouseDown=0,MainJsonData=null,Korpus3dHolder,Lamp3dHolder,Doors3dHolders=[],Doors3dHoldersMax=3,CurrentVstavkaMaterial,ProblemVstavkaMaterials=[],KupeParams=new Object;KupeParams.nDoors=0;var iActiveDoor=0,iActiveDoorSection=-1;KupeParams.doors=[];var hideTimeout=null,cPopupMenu,progDAnim=null,MSIE=0,MainDiv=null,PopupMenuDiv=null,ButtColorPicker=null,StartKupeSetId,MainJsonText,MatLib=new Array,iActiveTab=1,bPanActive=0,fPanDistance,last_pan_X,last_pan_Y,playTimeInterval=null,curDragMat=0;return{Initialize:Initialize,Uninitialize:Uninitialize,GetBasketContent:GetBasketContent,SetKorpusMaterial:SetKorpusMaterial,SetCurrentVstavkaMaterial:SetCurrentVstavkaMaterial,SetProfileMaterial:SetProfileMaterial,SetKorpus:SetKorpus,OnClickSmallButt:OnClickSmallButt,showPopupMenu:showPopupMenu,OnPopupOut:OnPopupOut,stopStart:stopStart,onDragMatStart:onDragMatStart,onDragMatEnd:onDragMatEnd}},DAnimProgressBar=function(a){function b(a,b,c,d,e,f){a.beginPath(),a.moveTo(b+f,c),a.lineTo(b+d-f,c),a.arc(b+d-f,c+f,f,-Math.PI/2,Math.PI/2,!1),a.lineTo(b+f,c+e),a.arc(b+f,c+f,f,Math.PI/2,3*Math.PI/2,!1),a.closePath(),a.fill()}function c(a,c,d,e,f,g){a.save(),a.shadowOffsetX=2,a.shadowOffsetY=2,a.shadowBlur=5,a.shadowColor="#666",a.fillStyle="rgba(189,189,189,1)",b(a,c,d,e,f,g),a.shadowColor="rgba(0,0,0,0)";var h=a.createLinearGradient(0,d+f,0,0);h.addColorStop(0,"rgba(255,255,255, 0.1)"),h.addColorStop(.4,"rgba(255,255,255, 0.7)"),h.addColorStop(1,"rgba(255,255,255,0.4)"),a.fillStyle=h,b(a,c,d,e,f,g),a.fillStyle="white",a.restore()}function d(a,b,c,d,e,f,g){var h=0;a.beginPath(),f>d?(h=f-Math.sqrt(Math.pow(f,2)-Math.pow(f-d,2)),a.moveTo(b+d,c+h),a.lineTo(b+d,c+e-h),a.arc(b+f,c+f,f,Math.PI-Math.acos((f-d)/f),Math.PI+Math.acos((f-d)/f),!1)):d+f>g?(h=f-Math.sqrt(Math.pow(f,2)-Math.pow(f-(g-d),2)),a.moveTo(b+f,c),a.lineTo(b+d,c),a.arc(b+g-f,c+f,f,-Math.PI/2,-Math.acos((f-(g-d))/f),!1),a.lineTo(b+d,c+e-h),a.arc(b+g-f,c+f,f,Math.acos((f-(g-d))/f),Math.PI/2,!1),a.lineTo(b+f,c+e),a.arc(b+f,c+f,f,Math.PI/2,3*Math.PI/2,!1)):(a.moveTo(b+f,c),a.lineTo(b+d,c),a.lineTo(b+d,c+e),a.lineTo(b+f,c+e),a.arc(b+f,c+f,f,Math.PI/2,3*Math.PI/2,!1)),a.closePath(),a.fill(),g-1>d&&(a.save(),a.shadowOffsetX=1,a.shadowBlur=1,a.shadowColor="#666",d+f>g&&(h+=1),a.fillRect(b+d,c+h,1,i-2*h),a.restore())}function e(a,b,c,d,e,f,g){a.save(),a.fillStyle="white";var h=Math.floor(d/g*100)+"%",i=a.measureText(h).width,j=b+d-i-f/2;f+i>=d&&(j=b+f/2),a.fillText(h,j,c+22),a.restore()}var f=null,g=null,h=300,i=34,j=20,k=20,l=i/2,m=a,n=function(){f.style.display="none"},o=function(a,b,c){if(f=document.createElement(m?"DIV":"canvas"),m||(f.width=500,f.height=150),f.style.position="absolute",f.style.left=Math.floor((b-h)/2)+"px",f.style.top=Math.floor((c-i)/2)+"px",a.appendChild(f),m&&(f.style.width=h+"px",f.style.height=i/2+"px",f.style.overflow="hidden",f.style.borderColor="#000000",f.style.borderWidth="1px",f.style.borderStyle="solid",f.style.backgroundColor="#FFFFFF",f.innerHTML='<DIV style="background-color:#ADD9FF;width:0px;height:'+i/2+'px;"></DIV>'),!m){if(!f||!f.getContext)return;if(g=f.getContext("2d"),!g)return;g.font="16px Verdana";var d=g.createLinearGradient(0,k+i,0,0);d.addColorStop(0,"#4DA4F3"),d.addColorStop(.4,"#ADD9FF"),d.addColorStop(1,"#9ED1FF"),g.fillStyle=d}p(0)},p=function(a){if(m){var b=f.children(0);b&&(b.style.width=a+"px")}else g.clearRect(j-5,k-5,h+15,i+15),c(g,j,k,h,i,l),d(g,j,k,a,i,l,h),e(g,j,k,a,i,l,h)};return{width:h,height:i,Initialize:o,Uninitialize:n,doDraw:p}};