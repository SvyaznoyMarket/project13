$(document).ready(function(){function e(){function e(e,t,i){for(var r=0,n=e.length;n>r;r++)if(e[r][t]==i)return!0;return!1}function t(e,t,i){for(var r=[],n=0,a=e.length;a>n;n++)if(e[n][t]==i){for(var o in e[n].intervals)r.push("c "+e[n].intervals[o].start_at+" по "+e[n].intervals[o].end_at);return r}return!1}function r(e){var t=e[0];if(e.length>1)for(var i=1,r=e.length;r>i;i++)e[i][0]>t[0]&&(t[0]=e[i][0]),e[i][1]<t[1]&&(t[1]=e[i][1]);return t}function n(e){var t=new Date(e);if(1!==t.getDay()){var i=t.getDay()?1*t.getDay()-1:6;t.setTime(1*t.getTime()-1e3*60*60*24*i)}return t}function a(e){var t=new Date(e);return 0!==t.getDay()&&t.setTime(1*t.getTime()+1e3*60*60*24*(7-t.getDay())),t}function o(e){var t=1*e.substr(0,4),i=1*e.substr(5,2),r=1*e.substr(8,2),n=new Date(t,i-1,r),a=Date.parse(n);return a}function s(i){i.caclDates=[];for(var s=i.token,l=[],c=0,u=i.itemList().length;u>c;c++){for(var h in i.itemList()[c].deliveries[s].dates)i.itemList()[c].deliveries[s].dates[h].timestamp=o(i.itemList()[c].deliveries[s].dates[h].value);var d=i.itemList()[c].deliveries[s].dates;l.push([d[0],d[d.length-1]])}for(var f=r(l),p=n(f[0].timestamp),m=a(f[1].timestamp),v=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"],g=1;1*p.getTime()<=1*m.getTime();){var _={dayOfWeek:v[1*p.getDay()],day:1*p.getDate(),tstamp:1*p.getTime(),week:g,enable:ko.observable(!1)};p.getDay()||g++,i.caclDates.push(_),_=null,p.setTime(1*p.getTime()+864e5)}i.nweeks=g-1;e:for(var E in i.caclDates){for(var d=[],c=0,u=i.itemList().length;u>c;c++){var s=i.token;if(d=i.itemList()[c].deliveries[s].dates,!e(d,"timestamp",i.caclDates[E].tstamp)){i.caclDates[E].enable(!1);continue e}i.caclDates[E].enable(!0)}i.caclDates[E].intervals=t(d,"timestamp",i.caclDates[E].tstamp)}}function l(e,t,i,r){var n={};n.type=e,n.token=t,n.curWeek=ko.observable(1),n.itemList=ko.observableArray([]);for(var a in i)n.itemList.push(S.items[i[a]]);n.shop=ko.observable(r),s(n),n.chosenDate=ko.observable(0),n.chosenInterval=ko.observable("none"),n.currentIntervals=ko.observableArray([]);var o=0;for(var l in n.caclDates){if(o++,n.caclDates[l].enable()){n.chosenDate(n.caclDates[l].tstamp),n.chosenInterval(n.caclDates[l].intervals[0]);for(var c in n.caclDates[l].intervals)n.currentIntervals.push(n.caclDates[l].intervals[c]);break}7==o&&(o=0,n.curWeek(n.curWeek()+1))}n.dlvrPrice=ko.computed(function(){for(var e=0,t=this.token,i=0,r=this.itemList().length;r>i;i++){var n=this.itemList()[i].deliveries[t].price;n>e&&(e=n)}return e},n),n.supplied=ko.computed(function(){for(var e=this.token,t=0,i=this.itemList().length;i>t;t++){var r=this.itemList()[t].deliveries[e].isSupplied;if(r)return r}return r},n),n.totalPrice=ko.computed(function(){for(var e=0,t=0,i=this.itemList().length;i>t;t++)e+=this.itemList()[t].total;return e+=1*this.dlvrPrice()},n),f.dlvrBoxes.push(n)}function c(){f.dlvrBoxes.removeAll();for(var e in S.deliveryTypes)S.deliveryTypes[e].items.length&&l(S.deliveryTypes[e].type,S.deliveryTypes[e].token,S.deliveryTypes[e].items,S.deliveryTypes[e].shop)}function u(){f.shopsInPopup.removeAll();for(var e in S.deliveryTypes)S.deliveryTypes[e].shop&&f.shopsInPopup.push(S.deliveryTypes[e].shop)}function d(e){var t=new Date(e),i=t.getMonth()+1,r=t.getDate();return t.getFullYear()+"-"+(i>9?i:"0"+i)+"-"+(r>9?r:"0"+r)}var f=this;f.cssForDate=$(".order-delivery_date").css("display"),f.stolenItems=ko.observableArray([]),S.unavailable.length,f.showForm=ko.observable(!1),f.dlvrCourierEnable=ko.observable(!1),f.dlvrShopEnable=ko.observable(!1),f.chosenBox=ko.observable(null),f.step2=ko.observable(!1),f.dlvrBoxes=ko.observableArray([]),c(),f.shopsInPopup=ko.observableArray([]),u(),f.chosenShop=ko.observable(null),f.shopButtonEnable=ko.observable(!1),f.changeWeek=function(e,t){if(e>0){if(t.nweeks==t.curWeek())return;t.curWeek(t.curWeek()+1)}if(0>e){if(1==t.curWeek())return;t.curWeek(t.curWeek()-1)}},f.clickDate=function(e,t){if(t.enable()){var i=e.chosenDate();e.chosenDate(t.tstamp);var r=e.chosenDate(),n=(r-i)/60/60/24/1e3;"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Order card","Date changed",n]),e.currentIntervals.removeAll();for(var a in t.intervals)e.currentIntervals.push(t.intervals[a]);$.inArray(e.chosenInterval(),e.currentIntervals())||e.chosenInterval(e.currentIntervals()[0])}},f.clickInterval=function(e,t){e.chosenInterval(t)},f.deleteItem=function(e,t){$.get(t.deleteUrl,function(){toKISS_del={"Checkout Step 1 SKU Quantity":t.quantity,"Checkout Step 1 SKU Total":t.price,"Checkout Step 1 F1 Quantity":t.serviceQ,"Checkout Step 1 Warranty Quantity":t.warrantyQ,"Checkout Step 1 F1 Total":t.total-t.price,"Checkout Step 1 Order Total":e.totalPrice()-t.total},"undefined"!=typeof _kmq&&_kmq.push(["set",toKISS_del]),"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Order card","Item deleted"]),e.itemList.remove(t),e.itemList().length||f.dlvrBoxes.remove(e);e:for(var i in S.deliveryTypes)for(var r=S.deliveryTypes[i],n=0,a=r.items.length;a>n;n++)if(r.items[n]===t.token){r.items.splice(n,1);break e}f.dlvrBoxes().length||document.location.reload()})},f.totalSum=ko.computed(function(){for(var e=0,t=0,i=f.dlvrBoxes().length;i>t;t++)e+=1*f.dlvrBoxes()[t].totalPrice();return e},this),f.pickCourier=function(){h="standart",c(),f.step2(!0),f.shopButtonEnable(!1);var e={type:"courier",boxQuantity:f.dlvrBoxes().length};PubSub.publish("DeliveryChanged",e)},f.pickShops=function(){h="self",f.step2(!1),f.shopButtonEnable(!0);var e={type:"shops",boxQuantity:f.dlvrBoxes().length};PubSub.publish("DeliveryChanged",e)},f.showShopPopup=function(e){f.chosenBox(e);for(var t=[],i=0,r=e.itemList().length;r>i;i++){var n=e.itemList()[i].deliveries;for(var a in n)a.match("self_")&&t.push(1*a.replace("self_",""))}u();for(var i=0;f.shopsInPopup().length>i;)-1===$.inArray(f.shopsInPopup()[i].id,t)?f.shopsInPopup.remove(f.shopsInPopup()[i]):i++},f.showAllShops=function(){f.shopsInPopup.removeAll();for(var e in S.deliveryTypes)S.deliveryTypes[e].shop&&f.shopsInPopup.push(S.deliveryTypes[e].shop)},f.selectShop=function(e){if(f.step2()){var t=[{shop:f.chosenBox().token.replace("self_",""),items:[]},{shop:e.id,items:[]}];e:for(var r=0,n=f.chosenBox().itemList();n.length>r;){for(var a in n[r].deliveries)if(a==="self_"+e.id){t[1].items.push(n[r].token),f.chosenBox().itemList.remove(n[r]);continue e}t[0].items.push(n[r].token),f.chosenBox().itemList.remove(n[r]),r++}for(var o in t)if(t[o].items.length>0){var s=S.shops[t[o].shop];l("self","self_"+t[o].shop,t[o].items,s)}f.chosenBox().itemList().length||f.dlvrBoxes.remove(f.chosenBox())}else{var c=[{shop:e.id,items:[]}];for(var u in f.dlvrBoxes())for(var h=f.dlvrBoxes()[u],r=0;h.itemList().length>r;)"self_"+e.id in h.itemList()[r].deliveries?(h.itemList()[r].deliveries["self_"+e.id].dates.length>1?c[0].items.push(h.itemList()[r].token):c.push({shop:e.id,items:[h.itemList()[r].token]}),h.itemList.remove(h.itemList()[r])):r++;var d={},p=[];for(var u in f.dlvrBoxes())for(var h=f.dlvrBoxes()[u],r=0,m=h.itemList();m.length>r;){p=[];for(_ in m[r].deliveries)m[r].deliveries[_].token.match("self_")&&p.push(m[r].deliveries[_].token.replace("self_",""));d[m[r].token+""]=p,p.length?h.itemList.remove(h.itemList()[r]):r++}for(var t=i(d),v=0,g=c.length;g>v;v++)c[v].items.length>0&&t.push(c[v]);for(var _ in t){var s=S.shops[t[_].shop];l("self","self_"+t[_].shop,t[_].items,s)}for(var u=0;f.dlvrBoxes().length>u;)f.dlvrBoxes()[u].itemList().length?u++:f.dlvrBoxes.remove(f.dlvrBoxes()[u]);f.shopButtonEnable(!1);var d={type:"shops",boxQuantity:f.dlvrBoxes().length};for(var u in f.dlvrBoxes())if("standart"===f.dlvrBoxes()[u].type){d.type="courier";break}PubSub.publish("DeliveryChanged",d)}f.chosenShop(e),f.step2(!0),PubSub.publish("ShopSelected",e)},f.printDate=function(e){var t=new Date(e),i=["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"];return t.getDate()+" "+i[t.getMonth()]},f.getServerModel=function(){var e={deliveryTypes:{}};for(var t in f.dlvrBoxes()){var i=f.dlvrBoxes()[t],r={id:S.deliveryTypes[i.token].id,token:i.token,type:i.type,date:d(i.chosenDate()),interval:i.chosenInterval().match(/\d{2}:\d{2}/g).join(","),shop:{id:i.token.replace("self_","")}},n=[];for(var a in i.itemList())n.push(i.itemList()[a].token);r.items=n,e.deliveryTypes[i.token+"_"+d(i.chosenDate())+"_"+i.itemList()[0].id]=r}return e},f.showForm(!0);var p=(new Date).getTime(),m=p-startTime;"undefined"!=typeof _gaq&&_gaq.push(["_trackTiming","New order","JS response",m]);for(var v in S.deliveryTypes)"standart"===S.deliveryTypes[v].type?f.dlvrCourierEnable(!0):f.dlvrShopEnable(!0);f.dlvrCourierEnable()&&!f.dlvrShopEnable()&&f.pickCourier(),!f.dlvrCourierEnable()&&f.dlvrShopEnable()&&f.pickShops()}function t(e){var t=0,i="none";for(var r in e)e[r].length>t&&(t=e[r].length,i=r);return i}function i(e){for(var i=[];;){var r={},n=0;for(var a in e)for(var o=0,s=e[a].length;s>o;o++)r[e[a][o]]?r[e[a][o]].push(a):(r[e[a][o]]=[a],n++);if(!n)break;var l=t(r);i.push({shop:l,items:r[l]});for(var a in r[l])e[r[l][a]]=[]}return i}function r(e,t){I++,$("body").delegate('input[name="'+e+'"]',"change",function(){I--,$('input[name="'+e+'"]').removeClass("mRed"),$('input[name="'+e+'"]').prev(".placeholder").removeClass("mRed");var t=$('input[name="'+e+'"]').closest(".bBuyingLine");t.find(".mRed").length||t.find(".bFormError").remove()});var i=$('input[name="'+e+'"]:first');if(!i.hasClass("mRed"))switch(i.attr("type")){case"text":i.addClass("mRed"),i.prev(".placeholder").addClass("mRed");var r=i.parent().parent();r.find(".bFormError").length||r.append('<span class="bFormError mb10 pt5">'+t+"</span>");break;default:i.addClass("mRed"),i.prev(".placeholder").addClass("mRed"),i.parent().parent().parent().append('<span class="bFormError mb10 pt5">'+t+"</span>")}}function n(e){for(var t in e)r(t,e[t]);I>0&&$.scrollTo(".mRed:first",500)}function a(){MVM.showAllShops();var e={};for(var t in MVM.shopsInPopup())e[MVM.shopsInPopup()[t].id]=MVM.shopsInPopup()[t];return e}function o(e){B.html(tmpl("mapInfoBlock",e)),O.id=e.id}function s(e){var t=$(e).parent().find(".shopnum").text(),i=S.shops[t];MVM.selectShop(i)}function l(e,t){MapInterface.ready(e,{yandex:$("#mapInfoBlock"),google:$("#map-info_window-container")});var i=calcMCenter(t),r=function(){window.regionMap.showMarkers(t),window.regionMap.addHandler(".shopchoose",s)};MapInterface.init(i,"mapPopup",r,o)}var c=0,u=0,h=0;if($("body").delegate(".bBuyingLine label","click",function(){if("radio"==$(this).find("input").attr("type")){var e=$('.mChecked input[name="'+$(this).find("input").attr("name")+'"]');return e.length&&e.each(function(e,t){$(t).parent("label").removeClass("mChecked")}),$(this).addClass("mChecked"),void 0}"checkbox"==$(this).find("input").attr("type")&&$(this).toggleClass("mChecked")}),$("body").delegate(".bBuyingLine input:radio, .bBuyingLine input:checkbox","click",function(e){e.stopPropagation()}),$("body").delegate('input[name="order[payment_method_id]"]',"click",function(){$(".innerType").hide(),$(this).parent().parent().find(".innerType").show()}),$(".orderFinal__certificate").length){var d=$(".cardNumber"),f=$(".cardPin"),p=$("#sertificateFields"),m="/certificate-check",v=function(){function e(){return d.val().replace(/[^0-9]/g,"")}function t(){return f.val().replace(/[^0-9]/g,"")}function i(){return{code:e(),pin:t()}}function r(){return o&&""!==e()&&14===e().length&&""!==t()&&4===t().length?!0:!1}function n(){a("orange","Проверка по номеру карты"),$.post(m,i(),function(e){if(false in e)return!1;if(!e.success){var t=e.error!==void 0?e.error:"ERROR";return a("red",t),!1}a("green",e.data)})}function a(e,t){var i=$(".process").first();i.hasClass("picked")||i.remove();var r={typeNum:e};switch(e){case"orange":r.text=t,o=!1;break;case"red":r.text="Произошла ошибка: "+t,o=!1;break;case"green":r.text="activated"in t?"Карта "+t.code+" на сумму "+t.sum+" активирована!":"Карта "+t.code+" имеет номинал "+t.sum,o=!0}p.after(tmpl(s,r)),t.activated!==void 0&&$(".process").first().addClass("picked")}var o=(1*$("#paymentWithCard").text(),!1),s="processBlock";return{checkCard:n,setProcessingStatus:a,isActive:r,getCode:e,getPIN:t}}();d.bind("keyup",function(e){if(e.which>=48&&57>=e.which||8==e.which)4==f.val().length&&v.checkCard();else{var t=$(this).val().replace(/\D/g,"");$(this).val(t)}}),f.mask("9999",{completed:v.checkCard,placeholder:"*"})}if($(".bankWrap").length){var g=$(".bankWrap .bSelect").data("value"),_=$(".bankWrap > .creditHref"),E=$(".bankWrap .bSelect"),y=function(){var e=$("option:selected",E).attr("ref");$(".bankWrap .bSelectWrap_eText").text(g[e].name),$('input[name="order[credit_bank_id]"]').val(e),_.find("a").attr("href",g[e].href),_.find("span").text("("+g[e].name+")")};for(var b in g){var T=$("<option>").attr("ref",b).addClass("bSelect_eItem").text(g[b].name);E.append(T)}$("option",E).eq(0).attr("selected","selected"),y(),E.change(y),DirectCredit.init($("#tsCreditCart").data("value"),$("#creditPrice"))}PubSub.subscribe("authorize",function(e,t){$("#order_recipient_first_name").val(t.first_name),$("#order_recipient_last_name").val(t.last_name),$("#order_recipient_phonenumbers").val(t.phonenumber+""),$("#user-block").hide()}),$(".auth-link").bind("click",function(e){e.preventDefault(),$(this),$("#login-form, #register-form").data("redirect",!1),$("#auth-block").lightbox_me({centered:!0,onLoad:function(){$("#auth-block").find("input:first").focus()}})}),$.mask!==void 0&&($("#order_recipient_phonenumbers").mask("(999) 999-99-99"),$("#order_recipient_phonenumbers").val($("#order_recipient_phonenumbers").val()),$.mask.definitions["*"]="[0-9*]",$("#order_sclub_card_number").mask("* ****** ******",{placeholder:"*"}),$("#order_sclub_card_number")[0].getAttribute("value")&&$("#order_sclub_card_number").val($("#order_sclub_card_number")[0].getAttribute("value")),$("#order_sclub_card_number").blur(function(){"* ****** ******"===$(this).val()&&($(this).trigger("unmask").val(""),$(this).focus(function(){$("#order_sclub_card_number").mask("* ****** ******",{placeholder:"*"})}))})),$(".placeholder-input").focus(function(e){var t=$(e.target);t.prev(".placeholder").hasClass("mRed")||t.prev(".placeholder").css("border-color","#FFA901")}).focusout(function(e){var t=$(e.target);t.prev(".placeholder").hasClass("mRed")||t.prev(".placeholder").css("border-color","#DDDDDD")}),$(".placeholder").click(function(){$(this).next(".placeholder-input").focus()});var x=[];if($("#metrostations").length&&(x=$("#metrostations").data("name"),$("#order_subway_id").val().length)){var R=1*$("#order_subway_id").val();for(var w in x)1*x[w].val==R&&$("#order_address_metro").val(x[w].label)}$("#order_address_metro").autocomplete({source:x,appendTo:"#metrostations",minLength:2,select:function(e,t){$("#order_subway_id").val(t.item.val)}}).change(function(){for(var e=0,t=x.length;t>e;e++)if($(this).val()===x[e].label)return!0;$(this).val("")}),window.blockScreen=function(e){$('<img src="/images/ajaxnoti.gif" />').css("display","none").appendTo("body");var t=$("<div>").addClass("noti").html('<div><img src="/images/ajaxnoti.gif" /></br></br> '+e+"</div>");t.appendTo("body"),this.block=function(){t.is(":hidden")&&t.lightbox_me({centered:!0,closeClick:!1,closeEsc:!1})},this.unblock=function(){t.trigger("close")},this.bye=function(){t.find("img").remove()}},Blocker=new blockScreen("Ваш заказ оформляется"),PubSub.subscribe("DeliveryChanged",function(e,t){"courier"===t.type?($("#order-submit").removeClass("disable"),$("#order-form").show(),$("#addressField").show()):($("#addressField").hide(),$("#order-form").hide(),$("#order-submit").addClass("disable")),t.boxQuantity>1?($("#payTypes > div").hide(),$("#payment_method_1-field").show(),$("#payment_method_2-field").show()):$("#payTypes > div").show()}),PubSub.subscribe("ShopSelected",function(){$("#orderMapPopup").trigger("close"),$("#order-form").show(),$("#order-submit").removeClass("disable")});var S=$("#order-delivery_map-data").data("value"),c=0,M=0,H=0,C=0,k=0,A=0;$.each(S.items,function(e,t){c+=t.quantity,M+=t.price,H+=t.total,C+=t.quantity,k+=t.serviceQ,A+=t.warrantyQ});var P={"Checkout Step 1 SKU Quantity":C,"Checkout Step 1 SKU Total":M,"Checkout Step 1 F1 Quantity":k,"Checkout Step 1 Warranty Quantity":A,"Checkout Step 1 F1 Total":H-M,"Checkout Step 1 Order Total":H,"Checkout Step 1 Order Type":"cart order"};"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","New order","Items",c]),"undefined"!=typeof _kmq&&_kmq.push(["record","Checkout Step 1",P]);var D=$("#order-form"),L=!1,I=0;$("#order-submit").click(function(e){if(I=0,e.preventDefault(),!L){if($(this).hasClass("disable"))return!1;var t=D.serializeArray(),i=$("#order-validator").data("value");e:for(field in i)if(D.find('[name="'+field+'"]:visible').length){if("order[recipient_phonenumbers]"==field){var a=$("#order_recipient_phonenumbers").val();10>a.length&&r(field,"Маловато цифр")}if("order[recipient_email]"==field){var o=$("#order_recipient_email").val();o.length>0&&-1==o.search("@")&&r(field,"Некорректный e-mail")}for(var s=0,l=t.length;l>s;s++)if(t[s].name==field){""==t[s].value&&"order[recipient_email]"!=field&&r(field,i[field]);continue e}r(field,i[field])}if(I>0)return $.scrollTo(".mRed:first",500),void 0;var d=$(this);d.text("Оформляется..."),Blocker.block();var f=function(e,t){var i="orderAlert",r='<div id="'+i+'" class="popup">'+'<div class="popupbox width290">'+'<div class="font18 pb18"> '+e+"</div>"+"</div>"+'<p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>';$("body").append($(r)),$("#"+i).lightbox_me({centered:!0,closeSelector:".closePopup",onClose:function(){window.location=t}})};L=!0;var p=D.serializeArray(),m=$('label.mChecked input[name="order[delivery_type_id]"]').val();m||(m=$('input[name="order[delivery_type_id]"]').val()),p.push({name:"order[delivery_type_id]",value:m}),p.push({name:"delivery_map",value:JSON.stringify(MVM.getServerModel())}),v!==void 0&&v.isActive()&&(p.push({name:"order[card]",value:v.getCode()}),p.push({name:"order[pin]",value:v.getPIN()}));var g=(new Date).getTime();$.ajax({url:D.attr("action"),timeout:12e4,type:"POST",data:p,success:function(e){if(L=!1,!e.success)return Blocker.unblock(),d.text("Завершить оформление"),"errors"in e&&n(e.errors),void 0;if(Blocker.bye(),"undefined"!=typeof _gaq){for(var t in MVM.getServerModel().deliveryTypes){var i="выбрана "+h+" доставят "+MVM.getServerModel().deliveryTypes[t].type;_gaq.push(["_trackEvent","Order card","Completed",i]),u++}_gaq.push(["_trackEvent","Order complete",u,c]);var r=(new Date).getTime(),a=r-g;_gaq.push(["_trackTiming","Order complete","DB response",a])}var o="8"+$("#order_recipient_phonenumbers").val().replace(/\D/g,""),s=$("#order_recipient_email").val(),l=0;$.each(MVM.dlvrBoxes(),function(e,t){l+=t.dlvrPrice()});var p=0,m=0,v=0,_=0,E=0,y=0;for(var b in MVM.dlvrBoxes()){var T=MVM.dlvrBoxes()[b];for(var t in T.itemList())p+=T.itemList()[t].quantity,m+=T.itemList()[t].price,v+=T.itemList()[t].serviceQ,_+=T.itemList()[t].serviceTotal,E+=T.itemList()[t].warrantyQ,y+=T.itemList()[t].warrantyTotal}var x={"Checkout Complete Order ID":e.orderNumber,"Checkout Complete SKU Quantity":p,"Checkout Complete SKU Total":m,"Checkout Complete F1 Quantity":v,"Checkout Complete F1 Total":_,"Checkout Complete Warranty Quantity":E,"Checkout Complete Warranty Total":y,"Checkout Complete Order Subtotal":m+_+y,"Checkout Complete Delivery Total":parseInt(l),"Checkout Complete Order Total":MVM.totalSum(),"Checkout Complete Order Type":"cart order","Checkout Complete Delivery":h,"Checkout Complete Payment":e.paymentMethodId};if("undefined"!=typeof _kmq&&"undefined"!==KM){_kmq.push(["alias",o,KM.i()]),_kmq.push(["alias",s,KM.i()]),_kmq.push(["identify",o]),_kmq.push(["record","Checkout Complete",x]);for(var b in MVM.dlvrBoxes()){var T=MVM.dlvrBoxes()[b];for(var t in T.itemList()){var R={"Checkout Complete SKU":T.itemList()[t].article,"Checkout Complete SKU Quantity":T.itemList()[t].quantity,"Checkout Complete SKU Price":T.itemList()[t].price,"Checkout Complete F1 Quantity":T.itemList()[t].serviceQ,"Checkout Complete F1 Total":T.itemList()[t].serviceTotal,"Checkout Complete Warranty Quantity":T.itemList()[t].warrantyQ,"Checkout Complete Warranty Total":T.itemList()[t].warrantyTotal,"Checkout Complete Parent category":T.itemList()[t].parent_category,"Checkout Complete Category name":T.itemList()[t].categoty,_t:KM.ts()+b+t,_d:1};_kmq.push(["set",R])}}}"undefined"!=typeof yaCounter10503055&&yaCounter10503055.reachGoal("orderscomplete"),void 0!==e.action.alert?f(e.action.alert.message,e.data.redirect):"redirect"in e.data&&(window.location=e.data.redirect)},error:function(){d.text("Попробовать еще раз"),Blocker.unblock(),L=!1}})}}),MVM=new e,ko.applyBindings(MVM,$("#MVVM")[0]);var F=$("#mapPopup_shopInfo"),B=$("#map-info_window-container");$("#OrderView").delegate(".selectShop","click",function(){return $("#orderMapPopup").lightbox_me({centered:!0,onLoad:function(){$("#mapPopup").empty(),shops=a(),$.isEmptyObject(shops)||l("yandex",shops)}}),!1});var O={timer:null,id:0};F.delegate("li","hover",function(){var e=$(this).attr("ref");O.timer&&clearTimeout(O.timer),e&&e!=O.id&&(O.id=e,O.timer=setTimeout(function(){window.regionMap.showInfobox(e)},350))})});