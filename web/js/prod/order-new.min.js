$(document).ready(function(){function e(){function e(e,t,r){for(var o=0,a=e.length;a>o;o++)if(e[o][t]==r)return!0;return!1}function t(e,t,r){for(var o=[],a=0,i=e.length;i>a;a++)if(e[a][t]==r){for(var n in e[a].intervals)o.push("c "+e[a].intervals[n].start_at+" по "+e[a].intervals[n].end_at);return o}return!1}function o(e){var t=e[0];if(e.length>1)for(var r=1,o=e.length;o>r;r++)e[r][0]>t[0]&&(t[0]=e[r][0]),e[r][1]<t[1]&&(t[1]=e[r][1]);return t}function a(e){var t=new Date(e);if(1!==t.getDay()){var r=t.getDay()?1*t.getDay()-1:6;t.setTime(1*t.getTime()-1e3*60*60*24*r)}return t}function i(e){var t=new Date(e);return 0!==t.getDay()&&t.setTime(1*t.getTime()+1e3*60*60*24*(7-t.getDay())),t}function n(e){var t=1*e.substr(0,4),r=1*e.substr(5,2),o=1*e.substr(8,2),a=new Date(t,r-1,o),i=Date.parse(a);return i}function s(r){r.caclDates=[];for(var s=r.token,l=[],c=0,d=r.itemList().length;d>c;c++){for(var p in r.itemList()[c].deliveries[s].dates)r.itemList()[c].deliveries[s].dates[p].timestamp=n(r.itemList()[c].deliveries[s].dates[p].value);var u=r.itemList()[c].deliveries[s].dates;l.push([u[0],u[u.length-1]])}for(var v=o(l),h=a(v[0].timestamp),m=i(v[1].timestamp),f=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"],b=1;1*h.getTime()<=1*m.getTime();){var y={dayOfWeek:f[1*h.getDay()],day:1*h.getDate(),tstamp:1*h.getTime(),week:b,enable:ko.observable(!1)};h.getDay()||b++,r.caclDates.push(y),y=null,h.setTime(1*h.getTime()+864e5)}r.nweeks=b-1;e:for(var k in r.caclDates){for(var u=[],c=0,d=r.itemList().length;d>c;c++){var s=r.token;if(u=r.itemList()[c].deliveries[s].dates,!e(u,"timestamp",r.caclDates[k].tstamp)){r.caclDates[k].enable(!1);continue e}r.caclDates[k].enable(!0)}r.caclDates[k].intervals=t(u,"timestamp",r.caclDates[k].tstamp)}}function l(e,t,r,o){var a={};a.type=e,a.token=t,a.curWeek=ko.observable(1),a.itemList=ko.observableArray([]);for(var i in r)a.itemList.push(T.items[r[i]]);a.shop=ko.observable(o),s(a),a.chosenDate=ko.observable(0),a.chosenInterval=ko.observable("none"),a.currentIntervals=ko.observableArray([]);var n=0;for(var l in a.caclDates){if(n++,a.caclDates[l].enable()){a.chosenDate(a.caclDates[l].tstamp),a.chosenInterval(a.caclDates[l].intervals[0]);for(var c in a.caclDates[l].intervals)a.currentIntervals.push(a.caclDates[l].intervals[c]);break}7==n&&(n=0,a.curWeek(a.curWeek()+1))}a.dlvrPrice=ko.computed(function(){for(var e=0,t=this.token,r=0,o=this.itemList().length;o>r;r++){var a=this.itemList()[r].deliveries[t].price;a>e&&(e=a)}return e},a),a.supplied=ko.computed(function(){for(var e=this.token,t=0,r=this.itemList().length;r>t;t++){var o=this.itemList()[t].deliveries[e].isSupplied;if(o)return o}return o},a),a.totalPrice=ko.computed(function(){for(var e=0,t=0,r=this.itemList().length;r>t;t++)e+=this.itemList()[t].total;return e+=1*this.dlvrPrice()},a),v.dlvrBoxes.push(a)}function c(){v.dlvrBoxes.removeAll();for(var e in T.deliveryTypes)T.deliveryTypes[e].items.length&&l(T.deliveryTypes[e].type,T.deliveryTypes[e].token,T.deliveryTypes[e].items,T.deliveryTypes[e].shop)}function d(){v.shopsInPopup.removeAll();for(var e in T.deliveryTypes)T.deliveryTypes[e].shop&&v.shopsInPopup.push(T.deliveryTypes[e].shop)}function u(e){var t=new Date(e),r=t.getMonth()+1,o=t.getDate();return t.getFullYear()+"-"+(r>9?r:"0"+r)+"-"+(o>9?o:"0"+o)}var v=this;v.cssForDate=$(".order-delivery_date").css("display"),v.stolenItems=ko.observableArray([]),T.unavailable.length,v.showForm=ko.observable(!1),v.dlvrCourierEnable=ko.observable(!1),v.dlvrShopEnable=ko.observable(!1),v.chosenBox=ko.observable(null),v.step2=ko.observable(!1),v.dlvrBoxes=ko.observableArray([]),c(),v.shopsInPopup=ko.observableArray([]),d(),v.chosenShop=ko.observable(null),v.shopButtonEnable=ko.observable(!1),v.changeWeek=function(e,t){if(e>0){if(t.nweeks==t.curWeek())return;t.curWeek(t.curWeek()+1)}if(0>e){if(1==t.curWeek())return;t.curWeek(t.curWeek()-1)}},v.clickDate=function(e,t){if(t.enable()){var r=e.chosenDate();e.chosenDate(t.tstamp);var o=e.chosenDate(),a=(o-r)/60/60/24/1e3;"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Order card","Date changed",a]),e.currentIntervals.removeAll();for(var i in t.intervals)e.currentIntervals.push(t.intervals[i]);$.inArray(e.chosenInterval(),e.currentIntervals())||e.chosenInterval(e.currentIntervals()[0])}},v.clickInterval=function(e,t){e.chosenInterval(t)},v.deleteItem=function(e,t){$.get(t.deleteUrl,function(){var r={"Checkout Step 1 SKU Quantity":t.quantity,"Checkout Step 1 SKU Total":t.price,"Checkout Step 1 F1 Quantity":t.serviceQ,"Checkout Step 1 Warranty Quantity":t.warrantyQ,"Checkout Step 1 F1 Total":t.total-t.price,"Checkout Step 1 Order Total":e.totalPrice()-t.total};"undefined"!=typeof _kmq&&_kmq.push(["set",r]),"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Order card","Item deleted"]),e.itemList.remove(t),e.itemList().length||v.dlvrBoxes.remove(e);e:for(var o in T.deliveryTypes)for(var a=T.deliveryTypes[o],i=0,n=a.items.length;n>i;i++)if(a.items[i]===t.token){a.items.splice(i,1);break e}v.dlvrBoxes().length||document.location.reload()})},v.totalSum=ko.computed(function(){for(var e=0,t=0,r=v.dlvrBoxes().length;r>t;t++)e+=1*v.dlvrBoxes()[t].totalPrice();return e},this),v.pickCourier=function(){p="standart",c(),v.step2(!0),v.shopButtonEnable(!1);var e={type:"courier",boxQuantity:v.dlvrBoxes().length};PubSub.publish("DeliveryChanged",e)},v.pickShops=function(){p="self",v.step2(!1),v.shopButtonEnable(!0);var e={type:"shops",boxQuantity:v.dlvrBoxes().length};PubSub.publish("DeliveryChanged",e)},v.showShopPopup=function(e){v.chosenBox(e);for(var t=[],r=0,o=e.itemList().length;o>r;r++){var a=e.itemList()[r].deliveries;for(var i in a)i.match("self_")&&t.push(1*i.replace("self_",""))}d();for(var r=0;v.shopsInPopup().length>r;)-1===$.inArray(v.shopsInPopup()[r].id,t)?v.shopsInPopup.remove(v.shopsInPopup()[r]):r++},v.showAllShops=function(){v.shopsInPopup.removeAll();for(var e in T.deliveryTypes)T.deliveryTypes[e].shop&&v.shopsInPopup.push(T.deliveryTypes[e].shop)},v.selectShop=function(e){if(v.step2()){var t=[{shop:v.chosenBox().token.replace("self_",""),items:[]},{shop:e.id,items:[]}];e:for(var o=0,a=v.chosenBox().itemList();a.length>o;){for(var i in a[o].deliveries)if(i==="self_"+e.id){t[1].items.push(a[o].token),v.chosenBox().itemList.remove(a[o]);continue e}t[0].items.push(a[o].token),v.chosenBox().itemList.remove(a[o]),o++}for(var n in t)if(t[n].items.length>0){var s=T.shops[t[n].shop];l("self","self_"+t[n].shop,t[n].items,s)}v.chosenBox().itemList().length||v.dlvrBoxes.remove(v.chosenBox())}else{var c=[{shop:e.id,items:[]}];for(var d in v.dlvrBoxes())for(var p=v.dlvrBoxes()[d],o=0;p.itemList().length>o;)"self_"+e.id in p.itemList()[o].deliveries?(c[0].items.push(p.itemList()[o].token),p.itemList.remove(p.itemList()[o])):o++;var u={},h=[];for(var d in v.dlvrBoxes())for(var p=v.dlvrBoxes()[d],o=0,m=p.itemList();m.length>o;){h=[];for(y in m[o].deliveries)m[o].deliveries[y].token.match("self_")&&h.push(m[o].deliveries[y].token.replace("self_",""));u[m[o].token+""]=h,h.length?p.itemList.remove(p.itemList()[o]):o++}for(var t=r(u),f=0,b=c.length;b>f;f++)c[f].items.length>0&&t.push(c[f]);for(var y in t){var s=T.shops[t[y].shop];l("self","self_"+t[y].shop,t[y].items,s)}for(var d=0;v.dlvrBoxes().length>d;)v.dlvrBoxes()[d].itemList().length?d++:v.dlvrBoxes.remove(v.dlvrBoxes()[d]);v.shopButtonEnable(!1);var u={type:"shops",boxQuantity:v.dlvrBoxes().length};for(var d in v.dlvrBoxes())if("standart"===v.dlvrBoxes()[d].type){u.type="courier";break}PubSub.publish("DeliveryChanged",u)}v.chosenShop(e),v.step2(!0),PubSub.publish("ShopSelected",e)},v.printDate=function(e){var t=new Date(e),r=["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"];return t.getDate()+" "+r[t.getMonth()]},v.getServerModel=function(){var e={deliveryTypes:{}};for(var t in v.dlvrBoxes()){for(var r=v.dlvrBoxes()[t],o=r.itemList()[0].deliveries[r.token].dates,a=r.token,i=r.type,n=T.deliveryTypes[r.token].id,s=0,l=o.length;l>s;s++)o[s].timestamp==r.chosenDate()&&o[s].isNow&&(a="now"+r.token.replace("self",""),i="now",n=4);var c={id:n,token:a,type:i,date:u(r.chosenDate()),interval:r.chosenInterval().match(/\d{2}:\d{2}/g).join(","),shop:{id:r.token.replace("self_","")}},d=[];for(var s in r.itemList())d.push(r.itemList()[s].token);c.items=d,e.deliveryTypes[a+"_"+u(r.chosenDate())+"_"+r.itemList()[0].id]=c}return e},v.showForm(!0);var h=(new Date).getTime(),m=h-startTime;"undefined"!=typeof _gaq&&_gaq.push(["_trackTiming","New order","JS response",m]);for(var f in T.deliveryTypes)"standart"===T.deliveryTypes[f].type?v.dlvrCourierEnable(!0):v.dlvrShopEnable(!0);v.dlvrCourierEnable()&&!v.dlvrShopEnable()&&v.pickCourier(),!v.dlvrCourierEnable()&&v.dlvrShopEnable()&&v.pickShops()}function t(e){var t=0,r="none";for(var o in e)e[o].length>t&&(t=e[o].length,r=o);return r}function r(e){for(var r=[];;){var o={},a=0;for(var i in e)for(var n=0,s=e[i].length;s>n;n++)o[e[i][n]]?o[e[i][n]].push(i):(o[e[i][n]]=[i],a++);if(!a)break;var l=t(o);r.push({shop:l,items:o[l]});for(var i in o[l])e[o[l][i]]=[]}return r}function o(e,t){Q++,$("body").delegate('input[name="'+e+'"]',"change",function(){Q--,$('input[name="'+e+'"]').removeClass("mRed"),$('input[name="'+e+'"]').prev(".placeholder").removeClass("mRed");var t=$('input[name="'+e+'"]').closest(".bBuyingLine");t.find(".mRed").length||t.find(".bFormError").remove()});var r=$('input[name="'+e+'"]:first');if(!r.hasClass("mRed"))switch(r.attr("type")){case"text":r.addClass("mRed"),r.prev(".placeholder").addClass("mRed");var o=r.parent().parent();o.find(".bFormError").length||o.append('<span class="bFormError mb10 pt5">'+t+"</span>");break;default:r.addClass("mRed"),r.prev(".placeholder").addClass("mRed"),r.parent().parent().parent().append('<span class="bFormError mb10 pt5">'+t+"</span>")}}function a(e){for(var t in e)o(t,e[t]);Q>0&&$.scrollTo(".mRed:first",500)}function i(){MVM.showAllShops();var e={};for(var t in MVM.shopsInPopup())e[MVM.shopsInPopup()[t].id]=MVM.shopsInPopup()[t];return e}function n(e){A.html(tmpl("mapInfoBlock",e)),F.id=e.id}function s(e){var t=$(e).parent().find(".shopnum").text(),r=T.shops[t];MVM.selectShop(r)}function l(e,t){MapInterface.ready(e,{yandex:$("#mapInfoBlock"),google:$("#map-info_window-container")});var r=calcMCenter(t),o=function(){window.regionMap.showMarkers(t),window.regionMap.addHandler(".shopchoose",s)};MapInterface.init(r,"mapPopup",o,n)}var c=0,d=0,p=0;if($("body").delegate(".bBuyingLine label","click",function(){if("radio"==$(this).find("input").attr("type")){var e=$('.mChecked input[name="'+$(this).find("input").attr("name")+'"]');return e.length&&e.each(function(e,t){$(t).parent("label").removeClass("mChecked")}),$(this).addClass("mChecked"),void 0}"checkbox"==$(this).find("input").attr("type")&&$(this).toggleClass("mChecked")}),$("body").delegate(".bBuyingLine input:radio, .bBuyingLine input:checkbox","click",function(e){e.stopPropagation()}),$("body").delegate('input[name="order[payment_method_id]"]',"click",function(){$(".innerType").hide(),$(this).parent().parent().find(".innerType").show()}),$(".orderFinal__certificate").length){var u=$(".cardNumber"),v=$(".cardPin"),h=$("#sertificateFields"),m="/certificate-check",f=function(){function e(){return u.val().replace(/[^0-9]/g,"")}function t(){return v.val().replace(/[^0-9]/g,"")}function r(){return{code:e(),pin:t()}}function o(){return n&&""!==e()&&14===e().length&&""!==t()&&4===t().length?!0:!1}function a(){i("orange","Проверка по номеру карты"),$.post(m,r(),function(e){if(false in e)return!1;if(!e.success){var t=e.error!==void 0?e.error:"ERROR";return i("red",t),!1}i("green",e.data)})}function i(e,t){var r=$(".process").first();r.hasClass("picked")||r.remove();var o={typeNum:e};switch(e){case"orange":o.text=t,n=!1;break;case"red":o.text="Произошла ошибка: "+t,n=!1;break;case"green":o.text="activated"in t?"Карта "+t.code+" на сумму "+t.sum+" активирована!":"Карта "+t.code+" имеет номинал "+t.sum,n=!0}h.after(tmpl(s,o)),t.activated!==void 0&&$(".process").first().addClass("picked")}var n=(1*$("#paymentWithCard").text(),!1),s="processBlock";return{checkCard:a,setProcessingStatus:i,isActive:o,getCode:e,getPIN:t}}();u.bind("keyup",function(e){if(e.which>=48&&57>=e.which||8==e.which)4==v.val().length&&f.checkCard();else{var t=$(this).val().replace(/\D/g,"");$(this).val(t)}}),v.mask("9999",{completed:f.checkCard,placeholder:"*"})}if($(".bankWrap").length){var b=$(".bankWrap .bSelect").data("value"),y=$(".bankWrap > .creditHref"),k=$(".bankWrap .bSelect"),g=function(){var e=$("option:selected",k).attr("ref");$(".bankWrap .bSelectWrap_eText").text(b[e].name),$('input[name="order[credit_bank_id]"]').val(e),y.find("a").attr("href",b[e].href),y.find("span").text("("+b[e].name+")")};for(var _ in b){var C=$("<option>").attr("ref",_).addClass("bSelect_eItem").text(b[_].name);k.append(C)}$("option",k).eq(0).attr("selected","selected"),g(),k.change(g),DirectCredit.init($("#tsCreditCart").data("value"),$("#creditPrice"))}PubSub.subscribe("authorize",function(e,t){$("#order_recipient_first_name").val(t.first_name),$("#order_recipient_last_name").val(t.last_name),$("#order_recipient_phonenumbers").val(t.phonenumber+""),$("#user-block").hide()}),$(".auth-link").bind("click",function(e){e.preventDefault(),$(this),$("#login-form, #register-form").data("redirect",!1),$("#auth-block").lightbox_me({centered:!0,onLoad:function(){$("#auth-block").find("input:first").focus()}})}),$.mask!==void 0&&($("#order_recipient_phonenumbers").mask("(999) 999-99-99"),$("#order_recipient_phonenumbers").val($("#order_recipient_phonenumbers").val()),$.mask.definitions["*"]="[0-9*]",$("#order_sclub_card_number").mask("* ****** ******",{placeholder:"*"}),$("#order_sclub_card_number")[0].getAttribute("value")&&$("#order_sclub_card_number").val($("#order_sclub_card_number")[0].getAttribute("value")),$("#order_sclub_card_number").blur(function(){"* ****** ******"===$(this).val()&&($(this).trigger("unmask").val(""),$(this).focus(function(){$("#order_sclub_card_number").mask("* ****** ******",{placeholder:"*"})}))})),$(".placeholder-input").focus(function(e){var t=$(e.target);t.prev(".placeholder").hasClass("mRed")||t.prev(".placeholder").css("border-color","#FFA901")}).focusout(function(e){var t=$(e.target);t.prev(".placeholder").hasClass("mRed")||t.prev(".placeholder").css("border-color","#DDDDDD")}),$(".placeholder").click(function(){$(this).next(".placeholder-input").focus()});var w=[];if($("#metrostations").length&&(w=$("#metrostations").data("name"),$("#order_subway_id").val().length)){var x=1*$("#order_subway_id").val();for(var S in w)1*w[S].val==x&&$("#order_address_metro").val(w[S].label)}$("#order_address_metro").autocomplete({source:w,appendTo:"#metrostations",minLength:2,select:function(e,t){$("#order_subway_id").val(t.item.val)}}).change(function(){for(var e=0,t=w.length;t>e;e++)if($(this).val()===w[e].label)return!0;$(this).val("")}),window.blockScreen=function(e){$('<img src="/images/ajaxnoti.gif" />').css("display","none").appendTo("body");var t=$("<div>").addClass("noti").html('<div><img src="/images/ajaxnoti.gif" /></br></br> '+e+"</div>");t.appendTo("body"),this.block=function(){t.is(":hidden")&&t.lightbox_me({centered:!0,closeClick:!1,closeEsc:!1})},this.unblock=function(){t.trigger("close")},this.bye=function(){t.find("img").remove()}},Blocker=new blockScreen("Ваш заказ оформляется"),PubSub.subscribe("DeliveryChanged",function(e,t){"courier"===t.type?($("#order-submit").removeClass("disable"),$("#order-form").show(),$("#addressField").show()):($("#addressField").hide(),$("#order-form").hide(),$("#order-submit").addClass("disable")),t.boxQuantity>1?($("#payTypes > div").hide(),$("#payment_method_1-field").show(),$("#payment_method_2-field").show()):$("#payTypes > div").show()}),PubSub.subscribe("ShopSelected",function(){$("#orderMapPopup").trigger("close"),$("#order-form").show(),$("#order-submit").removeClass("disable")});var T=$("#order-delivery_map-data").data("value"),c=0,D=0,B=0,M=0,L=0,P=0;$.each(T.items,function(e,t){c+=t.quantity,D+=t.price,B+=t.total,M+=t.quantity,L+=t.serviceQ,P+=t.warrantyQ});var I={"Checkout Step 1 SKU Quantity":M,"Checkout Step 1 SKU Total":D,"Checkout Step 1 F1 Quantity":L,"Checkout Step 1 Warranty Quantity":P,"Checkout Step 1 F1 Total":B-D,"Checkout Step 1 Order Total":B,"Checkout Step 1 Order Type":"cart order"};"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","New order","Items",c]),"undefined"!=typeof _kmq&&_kmq.push(["record","Checkout Step 1",I]);var q=$("#order-form"),E=!1,Q=0;$("#order-submit").click(function(e){if(Q=0,e.preventDefault(),!E){if($(this).hasClass("disable"))return!1;var t=q.serializeArray(),r=$("#order-validator").data("value");e:for(field in r)if(q.find('[name="'+field+'"]:visible').length){if("order[recipient_phonenumbers]"==field){var i=$("#order_recipient_phonenumbers").val();10>i.length&&o(field,"Маловато цифр")}if("order[recipient_email]"==field){var n=$("#order_recipient_email").val();n.length>0&&-1==n.search("@")&&o(field,"Некорректный e-mail")}for(var s=0,l=t.length;l>s;s++)if(t[s].name==field){""==t[s].value&&"order[recipient_email]"!=field&&o(field,r[field]);continue e}o(field,r[field])}if(Q>0)return $.scrollTo(".mRed:first",500),void 0;var u=$(this);u.text("Оформляется..."),Blocker.block();var v=function(e,t){var r="orderAlert",o='<div id="'+r+'" class="popup">'+'<div class="popupbox width290">'+'<div class="font18 pb18"> '+e+"</div>"+"</div>"+'<p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>';$("body").append($(o)),$("#"+r).lightbox_me({centered:!0,closeSelector:".closePopup",onClose:function(){window.location=t}})};E=!0;var h=q.serializeArray(),m=$('label.mChecked input[name="order[delivery_type_id]"]').val();m||(m=$('input[name="order[delivery_type_id]"]').val()),h.push({name:"order[delivery_type_id]",value:m}),h.push({name:"delivery_map",value:JSON.stringify(MVM.getServerModel())}),f!==void 0&&f.isActive()&&(h.push({name:"order[card]",value:f.getCode()}),h.push({name:"order[pin]",value:f.getPIN()}));var b=(new Date).getTime();$.ajax({url:q.attr("action"),timeout:12e4,type:"POST",data:h,success:function(e){if(E=!1,!e.success)return Blocker.unblock(),u.text("Завершить оформление"),"errors"in e&&a(e.errors),void 0;if("undefined"!=typeof _gaq){for(var t in MVM.getServerModel().deliveryTypes){var r="выбрана "+p+" доставят "+MVM.getServerModel().deliveryTypes[t].type;_gaq.push(["_trackEvent","Order card","Completed",r]),d++}_gaq.push(["_trackEvent","Order complete",d,c]);var o=(new Date).getTime(),i=o-b;_gaq.push(["_trackTiming","Order complete","DB response",i])}var n="8"+$("#order_recipient_phonenumbers").val().replace(/\D/g,""),s=$("#order_recipient_email").val(),l=0;$.each(MVM.dlvrBoxes(),function(e,t){l+=t.dlvrPrice()});var h=0,m=0,f=0,y=0,k=0,g=0;for(var _ in MVM.dlvrBoxes()){var C=MVM.dlvrBoxes()[_];for(var t in C.itemList())h+=C.itemList()[t].quantity,m+=C.itemList()[t].price,f+=C.itemList()[t].serviceQ,y+=C.itemList()[t].serviceTotal,k+=C.itemList()[t].warrantyQ,g+=C.itemList()[t].warrantyTotal}var w={"Checkout Complete Order ID":e.orderNumber,"Checkout Complete SKU Quantity":h,"Checkout Complete SKU Total":m,"Checkout Complete F1 Quantity":f,"Checkout Complete F1 Total":y,"Checkout Complete Warranty Quantity":k,"Checkout Complete Warranty Total":g,"Checkout Complete Order Subtotal":m+y+g,"Checkout Complete Delivery Total":parseInt(l),"Checkout Complete Order Total":MVM.totalSum(),"Checkout Complete Order Type":"cart order","Checkout Complete Delivery":p,"Checkout Complete Payment":e.paymentMethodId};"undefined"!=typeof _kmq&&"undefined"!==KM&&(_kmq.push(["alias",n,KM.i()]),_kmq.push(["alias",s,KM.i()]),_kmq.push(["identify",n]),_kmq.push(["record","Checkout Complete",w]));var x=0;window.sonar_basket={products:[],transaction:e.orderNumber,amount:MVM.totalSum(),currency:"RUB"};for(x in MVM.dlvrBoxes()){var C=MVM.dlvrBoxes()[x];for(var t in C.itemList()){var S=C.itemList()[t],T={identifier:S.article+"_"+docCookies.getItem("geoshop"),amount:S.price,currency:"RUB",quantity:S.quantity};if(window.sonar_basket.products.push(T),"undefined"!=typeof _kmq&&"undefined"!==KM){var D={"Checkout Complete SKU":S.article,"Checkout Complete SKU Quantity":S.quantity,"Checkout Complete SKU Price":S.price,"Checkout Complete F1 Quantity":S.serviceQ,"Checkout Complete F1 Total":S.serviceTotal,"Checkout Complete Warranty Quantity":S.warrantyQ,"Checkout Complete Warranty Total":S.warrantyTotal,"Checkout Complete Parent category":S.parent_category,"Checkout Complete Category name":S.category,_t:KM.ts()+x+t,_d:1};_kmq.push(["set",D])}}}"undefined"!=typeof yaCounter10503055&&yaCounter10503055.reachGoal("orderscomplete");var B=("https:"===document.location.protocol?"https://":"http://")+"eu-sonar.sociomantic.com/js/2010-07-01/adpan/enter-ru";$LAB.script(B).wait(function(){Blocker.bye(),void 0!==e.action.alert?v(e.action.alert.message,e.data.redirect):"redirect"in e.data&&(window.location=e.data.redirect)})},error:function(){u.text("Попробовать еще раз"),Blocker.unblock(),E=!1}})}}),MVM=new e,ko.applyBindings(MVM,$("#MVVM")[0]);var W=$("#mapPopup_shopInfo"),A=$("#map-info_window-container");$("#OrderView").delegate(".selectShop","click",function(){return $("#orderMapPopup").lightbox_me({centered:!0,onLoad:function(){$("#mapPopup").empty(),shops=i(),$.isEmptyObject(shops)||l("yandex",shops)}}),!1});var F={timer:null,id:0};W.delegate("li","hover",function(){var e=$(this).attr("ref");F.timer&&clearTimeout(F.timer),e&&e!=F.id&&(F.id=e,F.timer=setTimeout(function(){window.regionMap.showInfobox(e)},350))})});