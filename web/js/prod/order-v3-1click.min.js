!function(a){a.ENTER.OrderV31Click={info:{},functions:{},map:{},mapOptions:{},$map:{},kladrCityId:0,koModels:[]}}(window),function(a){var b=a(document.body),c=window._gaq,d=function(a,b,d,e){var f=d||"",g=b||"";a&&a.data&&(a.data.step&&(g=a.data.step),a.data.action&&(f=a.data.action)),"undefined"==typeof ga&&(ga=window[window.GoogleAnalyticsObject]),"object"==typeof c&&c.push(["_trackEvent","Воронка_1 клик",g,f]),"function"==typeof ga&&ga("send","event","Воронка_1 клик",g,f)};b.on("trackUserAction.orderV3Tracking",d)}(jQuery),function(a,b,c){var d;ENTER.OrderV31Click.functions.initAddress=function(){function a(){var a=this,d="Улица";return a.streetShortToLong={"пр-кт":"Проспект","ш":"Шоссе","ул.":"Улица","ул":"Улица","пер":"Переулок","пл":"Площадь","дор":"Дорога"},a.cityName=b.observable(""),a.cityId=b.observable(0),a.streetName=b.observable(""),a.streetType=b.observable(d),a.streetTypeShort=b.observable(""),a.streetId=b.observable(0),a.buildingName=b.observable(""),a.buildingId=b.observable(0),a.apartmentName=b.observable(""),a.inputFocus=b.observable(!0),a.inputPrefix=b.computed(function(){return""==a.streetName()?"Улица:":""==a.buildingName()?"дом:":"квартира:"}),a.getParent=function(){var b=!1;return 0!=a.cityId()&&"Улица:"==a.inputPrefix()?b={type:c.kladr.type.street,parentType:"city",parentId:a.cityId()}:0!=a.streetId()&&"дом:"==a.inputPrefix()&&(b={type:c.kladr.type.building,parentType:"street",parentId:a.streetId()}),b},a.update=function(b){"string"==typeof b?""==a.streetName()?(a.streetName(b),a.streetTypeShort("")):""==a.buildingName()?a.buildingName(b):""==a.apartmentName()&&a.apartmentName(b):"object"==typeof b&&("street"==b.contentType?a.streetName(b.name).streetId(b.id).streetType(b.type).streetTypeShort(b.typeShort):"building"==b.contentType&&a.buildingName(b.name).buildingId(b.id))},a.clearCity=function(){return a.cityName("").cityId(0),a},a.clearStreet=function(){return a.streetName("").streetType(d).streetId(0),a},a.clearBuilding=function(){return a.buildingName("").buildingId(0),a},a.clearApartment=function(){return a.apartmentName(""),a},a}function e(a){c.ajax({type:"POST",url:"/order-1click/delivery",data:{action:"changeAddress",params:{street:a.streetName()+" "+(""==a.streetTypeShort()?a.streetType():a.streetTypeShort()),building:a.buildingName(),apartment:a.apartmentName(),kladr_id:0!=a.buildingId()?a.buildingId():0!=a.streetId()?a.streetId():0!=a.cityId()?a.cityId():""},products:JSON.parse(c("#js-order-content").data("param")).products,update:1}}).fail(function(a){var b=c.parseJSON(a.responseText);b.result})}function f(a,b){if(d.getParent()!==!1){var e=c.extend({},{limit:10,name:a.term},d.getParent());c.kladr.api(e,function(a){b(c.map(a,function(a){return{label:g(a),value:a}}))})}}function g(a){var b=a.name,d=a.typeShort,e="";return-1!=c.inArray(d,["ул","пер","пл","дор"])&&(e="."),"street"===a.contentType?b+" "+d+e:b}var h=c("#kladr-config").data("value"),i=c("#page-config").data("value").user.region;ENTER.OrderV31Click.functions.smartAddressInit=function(){var a=c(".jsSmartAddressInput"),g=c(".jsAddressRootNode"),j=c.extend(h,{limit:1,type:c.kladr.type.city,name:i.name});a.autocomplete({source:f,minLength:1,open:function(a,b){c(".ui-autocomplete").css({position:"absolute",top:29,left:0})},select:function(b,c){return this.value="",a.val(""),d.update(c.item.value),e(d),!1},focus:function(a,b){this.value=b.item.label,a.preventDefault(),a.stopPropagation()},change:function(a,b){},messages:{noResults:"",results:function(){}}}),a.on({keypress:function(b){13==b.which&&(b.preventDefault(),c(this).val().length>0&&(d.update(c(this).val()),a.val(""),a.autocomplete("close"),e(d)))},keydown:function(b){var e=b.keyCode||b.charCode;8===e&&0===c(this).val().length&&("дом:"==d.inputPrefix()&&(a.val(d.streetName()),d.clearBuilding().clearStreet()),"квартира:"==d.inputPrefix()&&(a.val(d.buildingName()),d.clearApartment().clearBuilding()),b.preventDefault())},blur:function(){d.update(c(this).val()),a.val(""),e(d)}}),c(".jsSmartAddressEditField").on("click",function(){var b=c(this).data("type");b&&"function"==typeof d[b]&&(a.val(d[b]()),"apartmentName"==b&&d.clearApartment(),"buildingName"==b&&d.clearBuilding().clearApartment(),"streetName"==b&&(d.clearStreet().clearBuilding().clearApartment(),""!=d.streetTypeShort()&&a.val(a.val()+" "+d.streetTypeShort())))}),i.kladrId?d.cityId(i.kladrId):h&&i.name&&c.kladr.api(j,function(a){var b=a.length>0?a[0].id:0;0==b||d.cityId(a[0].id)}),g.length>0&&b.applyBindings(d,g[0])},"undefined"==typeof d&&(d=new a),ENTER.OrderV31Click.address=d,ENTER.OrderV31Click.functions.smartAddressInit()}}(window,ko,jQuery),function(a){ENTER.OrderV31Click.functions.initYandexMaps=function(){var b=ENTER.OrderV31Click,c=a("#yandex-map-container"),d=function(){var d=c.data("options");b.map=new ymaps.Map("yandex-map-container",{center:[d.latitude,d.longitude],zoom:d.zoom,controls:["zoomControl","fullscreenControl","geolocationControl","typeSelector"]},{autoFitToViewport:"always",suppressMapOpenBlock:!0}),b.map.controls.remove("searchControl"),b.mapOptions=d,b.$map=c,b.koModels=[],b.map.events.add("boundschange",function(b){var c;b.get("newBounds")&&(c=b.get("target").getBounds(),a.each(ENTER.OrderV31Click.koModels,function(a,b){b.latitudeMin(c[0][0]),b.latitudeMax(c[1][0]),b.longitudeMin(c[0][1]),b.longitudeMax(c[1][1])}))})};c.length&&ymaps.ready(d)}}(jQuery),function(a){var b=a("body"),c=function(c,d,e,f){var g={method:c,order:d,number:e};"undefined"!=typeof f&&""!=f&&(g.action=f),a.ajax({url:"/order/getPaymentForm",type:"POST",data:g,success:function(c){var d;""!=c.form&&(d=a(c.form),d.hasClass("jsPaymentFormPaypal")&&"undefined"!=typeof d.attr("action")?window.location.href=d.attr("action"):(b.append(d),d.submit()))}})};b.on("click",".jsOnlinePaymentPossible",function(){a(".jsOnlinePaymentPossible").hide(),a(".jsOnlinePaymentBlock").show()}),b.on("click",".jsPaymentMethod",function(b){var d=a(this).data("value"),e=a(this).closest(".jsOneClickCompletePage"),f=e.data("order-id"),g=e.data("order-number");b.preventDefault(),c(d,f,g)})}(jQuery),function(a){var b=document.getElementsByTagName("body")[0],c=a(b);ENTER.OrderV31Click.functions.initDelivery=function(){var b=a("#js-order-content"),d=a("#jsOneClickContent"),e="spinner-new",f=function(a,b){j("changeDelivery",{block_name:a,delivery_method_token:b})},g=function(a,b){j("changeDate",{block_name:a,date:b})},h=function(a,b,c){j("changePoint",{block_name:a,id:b,token:c})},i=function(a,b){j("changeInterval",{block_name:a,interval:b})},j=function(c,f){b.data("shop")&&(f.shopId=b.data("shop")),a.ajax({url:"/order-1click/delivery",type:"POST",data:{action:c,params:f,products:JSON.parse(b.data("param")).products,update:1},beforeSend:function(){d.addClass(e)}}).fail(function(b){var c=a.parseJSON(b.responseText);c.result&&c.result.errorContent&&a("#OrderV3ErrorBlock").html(a(c.result.errorContent).html()).show()}).done(function(c){b.empty().html(a(c.result.page).html()),ENTER.OrderV31Click.functions.initAddress(),b.find("input[name=address]").focus(),ENTER.OrderV31Click.koModels=[],a.each(b.find(".jsNewPoints"),function(b,c){var d=a.parseJSON(a(this).find("script.jsMapData").html()),e=new ENTER.DeliveryPoints(d.points,ENTER.OrderV31Click.map);ENTER.OrderV31Click.koModels.push(e),ko.applyBindings(e,c)})}).always(function(){d.removeClass(e)})},k=function(b){var c=b.find(".js-order-map").first(),d=a.parseJSON(c.next().html()),e=ENTER.OrderV31Click.mapOptions,f=ENTER.OrderV31Click.map;d&&"function"==typeof f.getType&&(b.is(":visible")||b.show(),f.geoObjects.removeAll(),f.setCenter([e.latitude,e.longitude],e.zoom),c.append(ENTER.OrderV31Click.$map.show()),f.container.fitToViewport(),a.each(d.points,function(a,b){try{f.geoObjects.add(new ENTER.Placemark(b,!0))}catch(c){}}),1===f.geoObjects.getLength()?(f.setCenter(f.geoObjects.get(0).geometry.getCoordinates(),15),f.geoObjects.get(0).options.set("visible",!0)):f.setBounds(f.geoObjects.getBounds()))},l=function(){var b=a(this).data("id"),d=a(this).data("token");b&&d&&(c.trigger("trackUserAction",["2_2 Ввод_данных_Самовывоза|Доставки"]),c.children(".selShop").remove(),h(a(".jsOneClickOrderRow").data("block_name"),b,d))};c.on("click",".jsOrderV3Dropbox",function(){a(this).siblings().removeClass("opn").find(".jsOrderV3DropboxInner").hide(),a(this).find(".jsOrderV3DropboxInner").toggle(),a(this).hasClass("opn")?a(this).removeClass("opn"):a(this).addClass("opn")}),b.on("click",".jsCloseFl",function(b){b.stopPropagation(),a(this).closest(".popupFl").hide(),b.preventDefault()}),b.on("click",".orderCol_date, .js-order-changePlace-link",function(b){var d=a(this).parent().parent().next();b.stopPropagation(),a(".popupFl").hide(),a(this).hasClass("js-order-changePlace-link")?(d.lightbox_me({centered:!0,closeSelector:".jsCloseFl",removeOtherOnCreate:!1}),k(d),c.trigger("trackUserAction",["2_1 Место_самовывоза|Адрес_доставки"]),d.on("click",".jsChangePoint",l)):a(a(this).data("content")).show(),b.preventDefault()}),b.on("click",".jsShowDiscountForm",function(b){b.stopPropagation(),a(this).hide().parent().next().show()}),b.on("click",".orderCol_delivrLst li",function(){var b=a(this);b.hasClass("orderCol_delivrLst_i-act")||f(a(this).closest(".orderRow").data("block_name"),a(this).data("delivery_method_token"))}),b.on("click",".celedr_col",function(){var b=a(this).data("value");"number"==typeof b&&g(a(this).closest(".orderRow").data("block_name"),b)}),b.on("click",".jsShowDeliveryIntervals",function(){a(this).find(".customSel_lst").show()}),b.on("click",".customSel_lst li",function(){i(a(this).closest(".orderRow").data("block_name"),a(this).data("value"))}),d.on("focus",".jsOrderV3PhoneField",function(){c.trigger("trackUserAction",["1_1 Телефон"])}),d.on("focus",".jsOrderV3EmailField",function(){c.trigger("trackUserAction",["1_3 E-mail"])}),d.on("focus",".jsOrderV3NameField",function(){c.trigger("trackUserAction",["1_2 Имя"])}),d.on("click",".jsOrderOneClickClose",function(b){b.preventDefault(),a(this).closest("#jsOneClickContent").trigger("close")})}}(jQuery),function(a){ENTER.OrderV31Click.functions.initValidate=function(){var b=a("#jsOneClickContentPage"),c=a(".jsOrderValidationErrors"),d=a(".jsOrderV3OneClickForm"),e="textfield-err",f=function(a){var b=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return b.test(a)&&!/[а-яА-Я]/.test(a)},g=function(){var b=!0,c=a("[name=user_info\\[mobile\\]]"),d=a("[name=user_info\\[email\\]]"),g=(a(".orderCol_delivrLst_i-act span"),c.val().replace(/\s+/g,""));return/\+7\(\d{3}\)\d{3}-\d{2}-\d{2}/.test(g)?c.removeClass(e).siblings(".errTx").hide():(b=!1,c.addClass(e).siblings(".errTx").show()),d.hasClass("jsOrderV3EmailRequired")&&0==d.val().length?(d.addClass("textfield-err").siblings(".errTx").text("Не указан email").show(),b=!1):0==d.val().length||f(d.val())?d.removeClass(e).siblings(".errTx").hide():(d.addClass("textfield-err").siblings(".errTx").text("Неверный формат email").show(),b=!1),b};c.length,b.on("blur","input",function(){g()}).on("keyup",".jsOrderV3PhoneField",function(){var b=a(this).val();"_"!=b[b.length-1]&&g()}),d.on("submit",function(b){b.preventDefault();var c=a(this),d=c.find(".orderCompl_btn"),e=c.serializeArray();g()&&a.ajax({type:"POST",url:c.attr("action"),data:e,beforeSend:function(){d.attr("disabled",!0)}}).always(function(){d.attr("disabled",!1)}).done(function(b){"undefined"!=typeof b.result&&(a("#jsOneClickContentPage").hide(),a("#jsOneClickContent").append(b.result.page),a("body").trigger("trackUserAction",["3_1 Оформить_успешно"]),function(){return"blackfridaysale"!=b.result.lastPartner?"":void a.each(b.result.orders,function(b,c){var d=[],e=0;a.each(c.products,function(a,b){d.push({id:b.id+"",price:b.price+"",quantity:parseInt(b.quantity)}),e+=parseFloat(b.price)*parseInt(b.quantity)}),ENTER.counters.callGetIntentCounter({type:"CONVERSION",orderId:c.id+"",orderProducts:d,orderRevenue:e+""})})}(),function(){var a,c;"hubrus"==b.result.lastPartner&&window.smartPixel1&&(a=b.result.orders[0].products[0],c=b.result.orders[0].id,smartPixel1.trackState("oneclick_complete",{cart_items:[{price:a.price,id:a.id}],order_id:c}))}(),function(){"advmaker"==b.result.lastPartner&&a.get("http://am15.net/s2s.php",{ams2s:docCookies.get("ams2s"),orders:b.result.orders[0].id})}(),function(){a.each(b.result.orders,function(b,c){var d=[];a.each(c.products,function(a,b){d.push({id:b.id,qnt:b.quantity,price:b.price})}),ENTER.counters.callRetailRocketCounter("order.complete",{transaction:c.id,items:d})})}(),b.result.orderAnalytics&&ENTER.utils.sendOrderToGA(b.result.orderAnalytics))}).fail(function(b){var c=a.parseJSON(b.responseText);c.result&&c.result.errorContent&&a("#OrderV3ErrorBlock").html(a(c.result.errorContent).html()).show();var d=c.result&&c.result.error?c.result.error:[];a("body").trigger("trackUserAction",["3_2 Оформить_ошибка","Поле ошибки: "+("undefined"!=typeof d?d.join(", "):"")])})})}}(jQuery);