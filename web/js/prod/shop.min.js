$(document).ready(function(){function i(i){var e={};for(var n in i)e[i[n].id]=i[n];return e}function e(i){$("#map-info_window-container").html(tmpl("infowindowtmpl",i))}var n=$(".bMap__eScrollWrap");if(n.on("click","div.map-image-link",function(){return $(this).hasClass("first")&&$("div.map-360-link",n).length?($("div.map-360-link",n).trigger("click"),void 0):($(this).hasClass("mChecked")||($("div.mChecked",$(this).parent()).removeClass("mChecked"),$(this).addClass("mChecked")),void 0)}),$("div.map-360-link",n).length&&n.on("click","div.map-360-link",function(i){if($("div.mChecked",$(".bMap__eScrollWrap")).removeClass("mChecked"),!$("#map-container embed").length){var e=$("#map-panorama").data();embedpano({swf:e.swf,xml:e.xml,target:"map-container",wmode:"transparent"})}i.stopPropagation()}),n.on("click","div.map-google-link",function(){if($("div.mChecked",n).removeClass("mChecked"),!$("#map-container div").length){var i=($(this),{latitude:$('[name="shop[latitude]"]').val(),longitude:$('[name="shop[longitude]"]').val()});$.when(MapInterface.ready("yandex",{yandex:$("#infowindowtmpl"),google:$("#map-info_window-container")})).done(function(){MapInterface.onePoint(i,"map-container")})}}),$("div.map-google-link:first",n).trigger("click"),$("#map-markers").length){var a=$("#map-markers").data("content"),t=!1,o={timer:null,id:0};$(".bMapShops__eMapCityList ul").on("hover","li",function(){var i=$(this).attr("ref");o.timer&&clearTimeout(o.timer),i&&i!=o.id&&(o.id=i,o.timer=setTimeout(function(){window.regionMap.showInfobox(i)},350))});var r=function(){var e=$(".bMapShops__eMapCityList_city"),n=e.find("ul");e.click(function(){var o=$(this).attr("ref"),r=$(event.target).hasClass("cityName");if(r)if($(".bShopCard").hide(),n.fadeOut(500,function(){n.empty()}),t)console.log("### город открыт, схлопываем список магазинов"),$(this).removeClass("chosedCity"),e.show(),t=!1;else{console.log("### город не открыт открываем спискок магазинов");var s=[];for(var d in a)if(a[d].region_id==$(this).attr("ref")){var l=tmpl("shopInCity",a[d]);$(this).find("ul").append(l),s.push(a[d])}if(s.length){e.hide(),$(this).addClass("chosedCity").show();var c=$(".chosedCity").offset().top;$(".shop_"+o).css("display","inline-block"),$(this).find("ul").fadeIn(500,function(){window.regionMap.showMarkers(i(s)),$(".bMapShops__eMapCityList").scroll(function(){var i=$(".chosedCity").offset().top;$(".chosedCity .cityName").css("top",c-i)})})}else alert("В этом городе пока еще нет наших магазинов");t=!0}})},s=calcMCenter(a),d=function(){window.regionMap.showCluster(a),r()};$.when(MapInterface.ready("yandex",{yandex:$("#infowindowtmpl"),google:$("#map-info_window-container")})).done(function(){MapInterface.init(s,"region_map-container",d,e)})}});