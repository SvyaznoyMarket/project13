$(document).ready(function(){function a(a){var b={};for(var c in a)b[a[c].id]=a[c];return b}function b(a){$("#map-info_window-container").html(tmpl("infowindowtmpl",a))}var c=$(".bMap__eScrollWrap");if(c.on("click","div.map-image-link",function(){return $(this).hasClass("first")&&$("div.map-360-link",c).length?void $("div.map-360-link",c).trigger("click"):void($(this).hasClass("mChecked")||($("div.mChecked",$(this).parent()).removeClass("mChecked"),$(this).addClass("mChecked")))}),$("div.map-360-link",c).length&&c.on("click","div.map-360-link",function(a){if($("div.mChecked",$(".bMap__eScrollWrap")).removeClass("mChecked"),!$("#map-container embed").length){var b=$("#map-panorama").data();embedpano({swf:b.swf,xml:b.xml,target:"map-container",wmode:"transparent"})}a.stopPropagation()}),c.on("click","div.map-google-link",function(){if($("div.mChecked",c).removeClass("mChecked"),!$("#map-container div").length){var a=($(this),{latitude:$('[name="shop[latitude]"]').val(),longitude:$('[name="shop[longitude]"]').val()});$.when(MapInterface.ready("yandex",{yandex:$("#infowindowtmpl"),google:$("#map-info_window-container")})).done(function(){MapInterface.onePoint(a,"map-container")})}}),$("div.map-google-link:first",c).trigger("click"),$("#map-markers").length){var d=$("#map-markers").data("content"),e=!1,f={timer:null,id:0};$(".bMapShops__eMapCityList ul").on("hover","li",function(){var a=$(this).attr("ref");f.timer&&clearTimeout(f.timer),a&&a!=f.id&&(f.id=a,f.timer=setTimeout(function(){window.regionMap.showInfobox(a)},350))});var g=function(){var b=$(".bMapShops__eMapCityList_city"),c=b.find("ul");b.click(function(f){var g=$(this).attr("ref"),h=$(f.target).hasClass("cityName");if(h)if($(".bShopCard").hide(),c.fadeOut(500,function(){c.empty()}),e)console.log("### город открыт, схлопываем список магазинов"),$(this).removeClass("chosedCity"),b.show(),e=!1;else{console.log("### город не открыт открываем спискок магазинов");var i=[];for(var j in d)if(d[j].region_id==$(this).attr("ref")){var k=tmpl("shopInCity",d[j]);$(this).find("ul").append(k),i.push(d[j])}if(i.length){b.hide(),$(this).addClass("chosedCity").show();var l=$(".chosedCity").offset().top;$(".shop_"+g).css("display","inline-block"),$(this).find("ul").fadeIn(500,function(){window.regionMap.showMarkers(a(i)),$(".bMapShops__eMapCityList").scroll(function(){var a=$(".chosedCity").offset().top;$(".chosedCity .cityName").css("top",l-a)})})}else alert("В этом городе пока еще нет наших магазинов");e=!0}})},h=calcMCenter(d),i=function(){window.regionMap.showCluster(d),g()};$.when(MapInterface.ready("yandex",{yandex:$("#infowindowtmpl"),google:$("#map-info_window-container")})).done(function(){MapInterface.init(h,"region_map-container",i,b)})}});