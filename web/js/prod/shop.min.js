!function(a){var b,c,d=a(".bMapShops").first(),e=d.find(".bMapShops__eMapCityList_city"),f=a("#map-markers").data("content"),g=tmpl,h={iconLayout:"default#image",iconImageHref:"/images/map/marker-shop.png",iconImageSize:[28,39],iconImageOffset:[-14,-39]};if(1==a("#region_map-container").length){if(!a.isArray(f)||0===f.length)return;b=a.grep(f,function(a){return a.is_reconstruction},!0),e.each(function(){var c=a(this).attr("ref");0===a.grep(b,function(a){return a.region_id==c}).length&&a(this).remove()}),d.on("click",".bMapShops__eMapCityList_city",function(c){var f=a(this),h=f.find("ul"),i=f.attr("ref"),j=a.grep(b,function(a){return a.region_id==i}),k="";j.length>0&&(f.hasClass("chosedCity")?(f.removeClass("chosedCity"),h.hide(),e.show(),d.trigger("cityClose")):(e.hide().removeClass("chosedCity"),f.addClass("chosedCity").show(),0==h.find("li").length&&(a.each(j,function(a,b){k+=g("shopInCity",b)}),h.html(k)),h.show(),d.trigger("cityOpen",[i]))),c.stopPropagation()}),d.on("click",".shopInCity",function(b){d.trigger("shopClick",[a(this).attr("ref")]),b.stopPropagation()}),ymaps.ready(function(){var e=new ymaps.Clusterer({hasBaloon:!1,hasHint:!1,minClusterSize:3,preset:"islands#orangeClusterIcons"});a.each(b,function(a,b){var c=new ymaps.Placemark([b.latitude,b.longitude],{balloonContent:"<h3>"+b.name+"</h3><span>"+b.regtime+'</span><br><a href="'+b.link+'" class="bGrayButton shopchoose">Перейти к магазину</a>'},h);e.add(c)}),c=new ymaps.Map("region_map-container",{center:[55.76,37.64],zoom:10}),c.geoObjects.add(e),c.setBounds(e.getBounds()),d.on("cityOpen",function(d,e){var f=a.grep(b,function(a){return a.region_id==e}),g=new ymaps.GeoObjectCollection,i=c.geoObjects;a.each(f,function(a,b){var c=new ymaps.Placemark([b.latitude,b.longitude],{balloonContent:"<h3>"+b.address+"</h3><span>"+b.regtime+'</span><br><a href="'+b.link+'" class="bGrayButton shopchoose">Перейти к магазину</a>'},h);g.add(c)}),i.removeAll(),i.add(g),i.get(0).getLength()>1?c.setBounds(g.getBounds()):c.setCenter(i.get(0).get(0).geometry.getCoordinates(),14)}),d.on("cityClose",function(){c.geoObjects.removeAll(),c.geoObjects.add(e),c.setBounds(e.getBounds())}),d.on("shopClick",function(d,e){var f=a.grep(b,function(a){return a.id==e})[0];c.setCenter([f.latitude,f.longitude],16)})})}1==a("#map-container").length&&ymaps.ready(function(){var b=a("input[name=shop\\[latitude\\]]").val(),d=a("input[name=shop\\[longitude\\]]").val();c=new ymaps.Map("map-container",{center:[b,d],zoom:16}),c.geoObjects.add(new ymaps.Placemark([b,d],{},h))})}(jQuery);