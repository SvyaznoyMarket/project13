$(document).ready(function(){function e(e){var t={};for(var r in e)t[e[r].id]=e[r];return t}function t(e){$("#map-info_window-container").html(tmpl("infowindowtmpl",e))}var r=$(".bMap__eScrollWrap");if(r.on("click","div.map-image-link",function(){return $(this).hasClass("first")&&$("div.map-360-link",r).length?($("div.map-360-link",r).trigger("click"),void 0):($(this).hasClass("mChecked")||($("div.mChecked",$(this).parent()).removeClass("mChecked"),$(this).addClass("mChecked")),void 0)}),$("div.map-360-link",r).length&&r.on("click","div.map-360-link",function(e){if($("div.mChecked",$(".bMap__eScrollWrap")).removeClass("mChecked"),!$("#map-container embed").length){var t=$("#map-panorama").data();embedpano({swf:t.swf,xml:t.xml,target:"map-container",wmode:"transparent"})}e.stopPropagation()}),r.on("click","div.map-google-link",function(){if($("div.mChecked",r).removeClass("mChecked"),!$("#map-container div").length){var e=($(this),{latitude:$('[name="shop[latitude]"]').val(),longitude:$('[name="shop[longitude]"]').val()});$.when(MapInterface.ready("yandex",{yandex:$("#infowindowtmpl"),google:$("#map-info_window-container")})).done(function(){MapInterface.onePoint(e,"map-container")})}}),$("div.map-google-link:first",r).trigger("click"),$("#map-markers").length){var i=$("#map-markers").data("content"),n=!1,o={timer:null,id:0};$(".bMapShops__eMapCityList ul").on("hover","li",function(){var e=$(this).attr("ref");o.timer&&clearTimeout(o.timer),e&&e!=o.id&&(o.id=e,o.timer=setTimeout(function(){window.regionMap.showInfobox(e)},350))});var a=function(){var t=$(".bMapShops__eMapCityList_city"),r=t.find("ul");t.click(function(o){var a=$(this).attr("ref"),s=$(o.target).hasClass("cityName");if(s)if($(".bShopCard").hide(),r.fadeOut(500,function(){r.empty()}),n)console.log("### город открыт, схлопываем список магазинов"),$(this).removeClass("chosedCity"),t.show(),n=!1;else{console.log("### город не открыт открываем спискок магазинов");var l=[];for(var c in i)if(i[c].region_id==$(this).attr("ref")){var u=tmpl("shopInCity",i[c]);$(this).find("ul").append(u),l.push(i[c])}if(l.length){t.hide(),$(this).addClass("chosedCity").show();var h=$(".chosedCity").offset().top;$(".shop_"+a).css("display","inline-block"),$(this).find("ul").fadeIn(500,function(){window.regionMap.showMarkers(e(l)),$(".bMapShops__eMapCityList").scroll(function(){var e=$(".chosedCity").offset().top;$(".chosedCity .cityName").css("top",h-e)})})}else alert("В этом городе пока еще нет наших магазинов");n=!0}})},s=calcMCenter(i),l=function(){window.regionMap.showCluster(i),a()};$.when(MapInterface.ready("yandex",{yandex:$("#infowindowtmpl"),google:$("#map-info_window-container")})).done(function(){MapInterface.init(s,"region_map-container",l,t)})}});