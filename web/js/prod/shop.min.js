$(document).ready(function(){function e(e){var i={};for(var n in e)i[e[n].id]=e[n];return i}function i(e){$("#map-info_window-container").html(tmpl("infowindowtmpl",e))}var n=$(".bMap__eScrollWrap");if(n.on("click","div.map-image-link",function(){return $(this).hasClass("first")&&$("div.map-360-link",n).length?($("div.map-360-link",n).trigger("click"),void 0):($(this).hasClass("mChecked")||($("div.mChecked",$(this).parent()).removeClass("mChecked"),$(this).addClass("mChecked")),void 0)}),$("div.map-360-link",n).length&&n.on("click","div.map-360-link",function(e){if($("div.mChecked",$(".bMap__eScrollWrap")).removeClass("mChecked"),!$("#map-container embed").length){var i=$("#map-panorama").data();embedpano({swf:i.swf,xml:i.xml,target:"map-container",wmode:"transparent"})}e.stopPropagation()}),n.on("click","div.map-google-link",function(){if($("div.mChecked",n).removeClass("mChecked"),!$("#map-container div").length){var e=($(this),{latitude:$('[name="shop[latitude]"]').val(),longitude:$('[name="shop[longitude]"]').val()});$.when(MapInterface.ready("yandex",{yandex:$("#infowindowtmpl"),google:$("#map-info_window-container")})).done(function(){MapInterface.onePoint(e,"map-container")})}}),$("div.map-google-link:first",n).trigger("click"),$("#map-markers").length){var t=$("#map-markers").data("content"),a=!1,o={timer:null,id:0};$(".bMapShops__eMapCityList ul").on("hover","li",function(){var e=$(this).attr("ref");o.timer&&clearTimeout(o.timer),e&&e!=o.id&&(o.id=e,o.timer=setTimeout(function(){window.regionMap.showInfobox(e)},350))});var r=function(){var i=$(".bMapShops__eMapCityList_city"),n=i.find("ul");i.click(function(){var o=$(this).attr("ref");if($(".bShopCard").hide(),n.fadeOut(500,function(){n.empty()}),a)$(this).removeClass("chosedCity"),i.show(),a=!1,console.log("###");else{var r=[];for(var d in t)if(t[d].region_id==$(this).attr("ref")){var l=tmpl("shopInCity",t[d]);$(this).find("ul").append(l),r.push(t[d])}if(r.length){i.hide(),$(this).addClass("chosedCity").show();var s=$(".chosedCity").offset().top;$(".shop_"+o).css("display","inline-block"),$(this).find("ul").fadeIn(500,function(){window.regionMap.showMarkers(e(r)),$(".bMapShops__eMapCityList").scroll(function(){var e=$(".chosedCity").offset().top;$(".chosedCity .cityName").css("top",s-e)})})}else alert("В этом городе пока еще нет наших магазинов");a=!0}}),n.click(function(e){return e.preventDefault?e.preventDefault():e.returnValue=!1,!1})},d=calcMCenter(t),l=function(){window.regionMap.showCluster(t),r()};$.when(MapInterface.ready("yandex",{yandex:$("#infowindowtmpl"),google:$("#map-info_window-container")})).done(function(){MapInterface.init(d,"region_map-container",l,i)})}});