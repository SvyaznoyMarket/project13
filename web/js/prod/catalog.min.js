(function(e){console.info("Catalog init: catalog.js");var t=e.utils,r=t.extendApp("ENTER.catalog"),i=$("#bCatalog").data("lastpage");r.enableHistoryAPI="object"==typeof Mustache&&History.enabled,r.listingWrap=$(".bListing"),r.liveScroll=!1,r.lastPage=null,i&&(r.lastPage=i),console.info("Mustache is "+typeof Mustache+" (Catalog main config)"),console.info("enableHistoryAPI "+r.enableHistoryAPI)})(window.ENTER),function(e){console.info("New catalog init: filter.js");var t,r=$("body"),i=(e.config.pageConfig,e.utils),n=i.extendApp("ENTER.catalog"),a=$(".bFilter"),o=(a.find(".bBtnPick__eLink"),a.find(".bFilterToggle")),s=a.find(".bFilterCont"),l=a.find(".bRangeSlider"),c=a.find(".bFilterParams__eItem"),u=a.find(".bFilterValuesItem"),d=$(".bSortingLine");n.filter={lastRes:null,getViewType:function(){var e=d.find(".mViewer .mSortItem");return e.filter(".mActive").data("type")},applyTemplate:{list:function(e){console.info("applyTemplate list"),n.listingWrap.empty(),n.listingWrap.html(e)},selectedFilter:function(e){var t=a.find(".bFilterFoot");t.empty(),t.html(e)},sorting:function(e){var t=d.find(".bSortingList.mSorting");t.empty(),t.html(e)},pagination:function(e){var t=$(".bSortingList.mPager");t.empty(),t.html(e)},page:function(e){var t=$(".bTitlePage");t.empty(),t.html(e)},countProducts:function(e){var t=$(".bBtnPick__eLink",".bFilter"),r=e?parseInt(e):-1;r>=0&&t.length&&t.text("Подобрать ("+e+")")}},render:{list:function(e){console.info("render list"),console.log(n.filter.getViewType()!==void 0?n.filter.getViewType():"default");var t,r=n.filter.getViewType()!==void 0?n.filter.getViewType():"default",i={compact:$("#listing_compact_tmpl"),expanded:$("#listing_compact_tmpl"),"default":$("#listing_compact_tmpl")},a=i[r].html(),o=i[r].data("partial");return t=Mustache.render(a,e,o),console.log("end of render list"),t},selectedFilter:function(e){if(console.info("render selectedFilter"),!e)return console.warn("nothing to render"),void 0;var t,r=$("#tplSelectedFilter"),i=r.html(),a=r.data("partial");return t=Mustache.render(i,e,a),e.hasOwnProperty("values")&&(console.info("run update filter!"),n.filter.updateFilter(e.values)),console.log("end of render selectedFilter"),t},sorting:function(e){console.info("render sorting");var t,r=$("script.tplSorting:first"),i=r.html(),n=r.data("partial");return t=Mustache.render(i,e,n),console.log("end of render sorting"),t},pagination:function(e){console.info("render pagination");var t,r=$("script.tplPagination:first"),i=r.html(),n=r.data("partial");return t=Mustache.render(i,e,n),console.log("end of render paginaton"),t},page:function(e){var t=e.title;return t},countProducts:function(e){return console.info("render countProducts"),e}},renderCatalogPage:function(e){console.info("renderCatalogPage");var t,i,a=e?e:n.filter.lastRes,o=e.pagination?e.pagination.lastPage:!1;n.filter.resetForm();for(t in a)n.filter.render.hasOwnProperty(t)&&(i=n.filter.render[t](a[t])),n.filter.applyTemplate.hasOwnProperty(t)&&n.filter.applyTemplate[t](i);n.infScroll.checkInfinity(),o&&(n.lastPage=o),n.filter.lastRes=a,r.trigger("markcartbutton")},getSlidersInputState:function(){console.info("getSlidersInputState");var e={changedSliders:[],unchangedSliders:[]},t=function t(){var t=$(this),r=t.find(".bFilterSlider"),i=r.data("config"),n=t.find(".mFromRange"),a=t.find(".mToRange"),o=i.min,s=i.max;1*n.val()===o?e.unchangedSliders.push(n.attr("name")):e.changedSliders.push(n.attr("name")),1*a.val()===s?e.unchangedSliders.push(a.attr("name")):e.changedSliders.push(a.attr("name"))};return l.each(t),e},getFilterUrl:function(){console.info("getFilterUrl");for(var e,t=a.serializeArray(),r=a.attr("action")||"",i=n.filter.getSlidersInputState(),o=d.find(".mSortItem.mActive").find(".jsSorting"),s=o.data("sort"),l=n.filter.getUrlParams(),c=!1,u=t.length-1;u>=0;u--)-1!==i.unchangedSliders.indexOf(t[u].name)&&(console.log("slider input "+t[u].name+" unchanged"),t.splice(u,1));return l&&l.category&&($.each(t,function(){"category"==this.name&&(c=!0)}),c||t.unshift({name:"category",value:l.category})),e=$.param(t),0!==e.length&&(r+=-1===r.indexOf("?")?"?"+e:"&"+e),console.log(r),r=r.addParameterToUrl("sort",s)},getUrlParams:function(){var e,t,r={},i=window.location.search.substring(1).split("&");for(t=0;i.length>t;t++)e=i[t].split("="),r[e[0]]=e[1]===void 0?"":e[1];return r},changeFilterHandler:function(e,r){console.info("change filter"),console.log(e),console.log(r);var i=function i(){a.trigger("submit")};return"object"==typeof e&&e.isTrigger&&!r?(console.warn("it's trigger event!"),void 0):n.enableHistoryAPI?(console.info("need update from server..."),clearTimeout(t),t=setTimeout(i,300),void 0):(console.warn("history api off"),void 0)},sendFilter:function(e){console.info("sendFilter"),console.log(e);var t=n.filter.getFilterUrl();return t!==document.location.pathname+document.location.search&&(console.info("goto url "+t),n.history.gotoUrl(t)),e.isTrigger?console.warn("it's trigger"):"object"==typeof e&&n.enableHistoryAPI&&(console.warn("it's true event and HistoryAPI enable"),$.scrollTo(a.find(".bFilterFoot"),500)),!1},resetForm:function(){console.info("resetForm");var e=function e(e,t){var r=$(t),i=r.attr("id"),n=a.find('label[for="'+i+'"]');console.info(i),console.info(n),r.removeAttr("checked"),n.removeClass("mChecked")},t=function t(e,t){$(t).removeAttr("checked").trigger("change")},r=function r(){var e=$(this),t=e.find(".bFilterSlider"),r=t.data("config"),i=e.find(".mFromRange"),n=e.find(".mToRange"),a=r.min,o=r.max;i.val(a).trigger("change"),n.val(o).trigger("change")};a.find(":input:radio:checked").each(e),a.find(":input:checkbox:checked").each(t),l.each(r)},updateFilter:function(e){console.info("update filter");var t,r,i,n;console.info(e);var o={text:function(e,t){e.val(t).trigger("change")},radio:function(e,t){var r=e.filter('[value="'+t+'"]'),i=r.attr("id"),n=a.find('label[for="'+i+'"]');r.attr("checked","checked"),n.addClass("mChecked")},checkbox:function(e,t){e.filter('[value="'+t+'"]').attr("checked","checked").trigger("change")}};for(n in e){if(!e.hasOwnProperty(n))return;t=a.find('input[name="'+n+'"]'),r=e[n],i=t.attr("type"),console.log(t),console.log(r),console.log(i),o.hasOwnProperty(i)&&o[i](t,r)}},openFilter:function(){f(!0)}};var h=function h(){var e=$(this),t=e.find(".bFilterSlider"),r=t.data("config"),i=e.find(".mFromRange"),n=e.find(".mToRange"),o=r.min,s=r.max,l=r.step;t.slider({range:!0,step:l,min:o,max:s,values:[i.val(),n.val()],slide:function(e,t){i.val(t.values[0]),n.val(t.values[1])},change:function(e){console.log("change slider"),e.originalEvent&&a.trigger("change",[!0])}});var c=function c(){var e="0"+$(this).val();e=parseFloat(e),console.info("inputUpdates"),console.log(e),e=e>s?s:o>e?o:e,$(this).val(e),t.slider({values:[i.val(),n.val()]})};n.on("change",c),i.on("change",c)},p=function p(){var e=$(this),t=e.attr("href");return n.history.gotoUrl(t),!1},f=function f(e){var t="mOpen",r="mClose",i=o.hasClass(t);return i&&"boolean"!=typeof e?(o.removeClass(t).addClass(r),s.slideUp(400)):(o.removeClass(r).addClass(t),s.slideDown(400)),!1},m=function m(){var e=$(this),t=e.attr("href"),r="mActive",i=e.parent(),o=i.hasClass(r);return o?!1:(n.history.gotoUrl(t),a.length&&$.scrollTo(a,500),!1)},g=function g(){var e=$(this),t="mActive",r=e.hasClass(t),i=e.data("ref");return r?!1:(c.removeClass(t),e.addClass(t),u.fadeOut(300),u.promise().done(function(){$("#"+i).fadeIn(300)}),$.scrollTo(a,500),!1)},v=function v(){var e=$(this),t=e.attr("href"),r="mActive",i=e.parent(),a=d.find(".mViewer .mSortItem"),o=i.hasClass(r);return o?!1:(a.removeClass(r),i.addClass(r),n.filter.lastRes?n.history.updateUrl(t):n.history.gotoUrl(t),!1)},_=function _(){var e=$(this),t=e.attr("href"),r="mActive",i=e.parent(),a=d.find(".mSorting .mSortItem"),o=i.hasClass(r);return o?!1:(a.removeClass(r),i.addClass(r),n.history.gotoUrl(t),!1)};o.on("click",f),c.on("click",g),a.on("change",n.filter.changeFilterHandler),a.on("submit",n.filter.sendFilter),d.on("click",".jsSorting",_),d.on("click",".jsChangeView",v),d.on("click",".jsPagination",m),r.on("click",".jsHistoryLink",p),l.each(h)}(window.ENTER),function(e){var t=e.utils,r=t.extendApp("ENTER.catalog");console.info("New catalog history module"),r.history={_defaultCallback:r.filter.renderCatalogPage,_customCallback:null,gotoUrl:function(e,t,i){console.info("gotoUrl");var n={title:document.title,url:e,data:{_onlychange:i?!0:!1}};return r.enableHistoryAPI?(r.history._customCallback=t?t:null,console.info("link handler. push state new url: "+n.url),History.pushState(n,n.title,n.url),void 0):(document.location.href=e,void 0)},updateUrl:function(e,t){var i=t?t:null;r.history.gotoUrl(e,i,!0)},getDataFromServer:function(e,t){console.info("getDataFromServer "+e),r.loader&&r.loader.loading(),console.log("getDataFromServer::loading");var i=function i(){r.loader&&r.loader.complete()},n=function n(e){console.info("resHandler"),"object"==typeof e?t(e):(console.warn("res isn't object"),console.log(typeof e)),r.loader&&r.loader.complete()};$.ajax({type:"GET",url:e,success:n,statusCode:{500:i,503:i},error:i})}};var i=function i(){var e=History.getState(),t=e.url,i=e.data.data,n="function"==typeof r.history._customCallback?r.history._customCallback:r.history._defaultCallback;console.info("statechange"),console.log(e),i._onlychange?(console.info("only update url "+t),n()):(t=t.addParameterToUrl("ajax","true"),r.history.getDataFromServer(t,n)),r.history._customCallback=null};History.Adapter.bind(window,"statechange",i)}(window.ENTER),function(e){console.info("Catalog init: catalog_infinityScroll.js");var t=e.utils,r=t.extendApp("ENTER.catalog"),i=$(".bSortingLine");r.infScroll={loading:!1,nowPage:1,checkInfinity:function(){console.info("checkInfinity "+window.docCookies.getItem("infScroll")),"1"===window.docCookies.getItem("infScroll")&&(console.warn("inf cookie == 1"),r.infScroll.enable())},checkScroll:function(){console.info("checkscroll");var e=$(window),t=$(document);!r.infScroll.loading&&e.scrollTop()+800>t.height()-e.height()&&(r.lastPage-r.infScroll.nowPage>0||null===r.lastPage)&&(console.warn("checkscroll true. load"),r.infScroll.nowPage+=1,r.infScroll.load())},load:function(){console.info("load page");var e=r.filter.getFilterUrl(),t=function t(e){var t;t=r.filter.render.list(e.list),r.infScroll.loading=!1,r.listingWrap.append(t)};r.liveScroll=!0,r.infScroll.loading=!0,e=e.addParameterToUrl("page",r.infScroll.nowPage),e=e.addParameterToUrl("ajax","true"),r.history.getDataFromServer(e,t)},enable:function(){console.info("enable...");var e="mActive",t=i.find(".mInfinity"),n=i.find(".mPaging"),a=i.find(".bSortingList__eItem.mPage"),o=r.filter.getFilterUrl(),s=document.location.search.match("page=");n.show(),a.hide(),t.addClass(e),r.infScroll.nowPage=1,r.infScroll.loading=!1,window.docCookies.setItem("infScroll",1,2419200,"/"),r.infScroll.checkScroll(),$(window).on("scroll",r.infScroll.checkScroll),console.info(s),r.enableHistoryAPI&&s&&r.history.gotoUrl(o),console.log("infinity scroll enable")},disable:function(){console.info("disable infinity...");var e=r.filter.getFilterUrl();r.liveScroll=!1,e=e.addParameterToUrl("ajax","true"),window.docCookies.setItem("infScroll",0,2419200,"/"),$(window).off("scroll",r.infScroll.checkScroll),r.history.getDataFromServer(e,r.filter.renderCatalogPage),console.log("infinity scroll disable "+window.docCookies.getItem("infScroll"))}};var n=function n(){var e="mActive",t=i.find(".mInfinity"),n=t.hasClass(e);return n?!1:(r.infScroll.enable(),!1)},a=function a(){console.info("paginationBtnHandler");var e="mActive",t=i.find(".mInfinity"),n=t.hasClass(e);return n&&r.infScroll.disable(),!1};r.infScroll.checkInfinity(),i.on("click",".jsPaginationEnable",a),i.on("click",".jsInfinityEnable",n)}(window.ENTER),function(e){console.info("New catalog init: loader.js");var t=(e.config.pageConfig,e.utils),r=t.extendApp("ENTER.catalog"),i=$(".bBtnPick__eLink",".bFilter");console.info("Mustache is "+typeof Mustache),console.info("enableHistoryAPI "+r.enableHistoryAPI),r.loader={_loader:null,loading:function(){r.loader._loader||(r.loader._loader=$("<li>").addClass("mLoader"),i.addClass("mButLoader").text("Подобрать"),r.liveScroll?r.listingWrap.append(r.loader._loader):(r.listingWrap.empty(),r.listingWrap.append(r.loader._loader)))},complete:function(){r.loader._loader&&(r.loader._loader.remove(),r.loader._loader=null),i.removeClass("mButLoader")}}}(window.ENTER);