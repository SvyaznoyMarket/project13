(function(e){var t=(e.config.pageConfig,e.utils),n=t.extendApp("ENTER.catalog");console.info("New catalog history module"),n.history={_callback:null,gotoUrl:function(e,t,a){console.info("gotoUrl");var o={title:document.title,url:e,data:{_onlychange:a?!0:!1}};return n.enableHistoryAPI?(n.history._callback=t,console.info("link handler. push state new url: "+o.url),History.pushState(o,o.title,o.url),void 0):(document.location.href=e,void 0)},updateUrl:function(e,t){n.history.gotoUrl(e,t,!0)}};var a=function a(e,n){console.info("getDataFromServer "+e),t.blockScreen.block("Загрузка товаров");var a=function a(){t.blockScreen.unblock()},o=function o(e){console.info("resHandler"),"object"==typeof e&&"function"==typeof n?n(e):(console.warn("res isn't object or catalog.history._callback isn't function"),console.log(typeof e),console.log(typeof n)),t.blockScreen.unblock()};$.ajax({type:"GET",url:e,success:o,statusCode:{500:a,503:a}})},o=function o(){var e=History.getState(),t=e.url,o=e.data.data;console.info("statechange"),console.log(e),o._onlychange&&"function"==typeof n.history._callback?(console.info("only update url "+t),n.history._callback()):(t=t.addParameterToUrl("ajax","true"),a(t,n.history._callback)),n.history._callback=null};History.Adapter.bind(window,"statechange",o)})(window.ENTER),function(e){console.info("New catalog init: filter.js");var t=(e.config.pageConfig,e.utils),n=t.extendApp("ENTER.catalog"),a=$(".bFilter"),o=a.find(".bFilterToggle"),i=a.find(".bFilterCont"),l=a.find(".bRangeSlider"),r=a.find(".bFilterParams__eItem"),s=a.find(".bFilterValuesItem"),c=$(".bSortingLine"),d=c.find(".mSorting .mSortItem"),f=c.find(".mViewer .mSortItem");c.find(".mViewer .mPager"),n.enableHistoryAPI="object"==typeof Mustache&&History.enabled,console.info("Mustache is "+typeof Mustache),console.info("enableHistoryAPI "+n.enableHistoryAPI),n.filter={lastRes:null,getViewType:function(){return f.filter(".mActive").data("type")},renderCatalogPage:function(e){console.info("renderCatalogPage"),console.log(n.filter.getViewType()!==void 0?n.filter.getViewType():"default");var t,a=n.filter.getViewType()!==void 0?n.filter.getViewType():"default",o={compact:$("#listing_compact_tmpl"),expanded:$("#listing_compact_tmpl"),"default":$("#listing_compact_tmpl")},i=e?e:n.filter.lastRes,l=o[a].html(),r=o[a].data("partial"),s=$(".bListing");t=Mustache.render(l,i,r),s.empty(),s.html(t),n.filter.lastRes=i},getSlidersInputState:function(){console.info("getSlidersInputState");var e={changedSliders:[],unchangedSliders:[]},t=function t(){var t=$(this),n=t.find(".bFilterSlider"),a=n.data("config"),o=t.find(".mFromRange"),i=t.find(".mToRange"),l=a.min,r=a.max;1*o.val()===l?e.unchangedSliders.push(o.attr("name")):e.changedSliders.push(o.attr("name")),1*i.val()===r?e.unchangedSliders.push(i.attr("name")):e.changedSliders.push(i.attr("name"))};return l.each(t),e},getFilterUrl:function(){for(var e,t=a.serializeArray(),o=a.attr("action"),i=n.filter.getSlidersInputState(),l=t.length-1;l>=0;l--)-1!==i.unchangedSliders.indexOf(t[l].name)&&(console.log("slider input "+t[l].name+" unchanged"),t.splice(l,1));return e=$.param(t),0!==e.length&&(o+="?"+e),o},changeFilterHandler:function(){console.info("change filter")},sendFilter:function(){var e=n.filter.getFilterUrl();return e!==document.location.pathname+document.location.search&&(console.info("goto url "+e),n.history.gotoUrl(e,n.filter.renderCatalogPage)),!1},updateFilter:function(){console.info("update filter")}};var u=function u(){var e="mOpen",t="mClose",n=o.hasClass(e);return n?(o.removeClass(e).addClass(t),i.slideUp(400)):(o.removeClass(t).addClass(e),i.slideDown(400)),!1},g=function g(){var e=$(this),t="mActive",n=e.hasClass(t),a=e.data("ref");return n?!1:(r.removeClass(t),e.addClass(t),s.fadeOut(300),s.promise().done(function(){$("#"+a).fadeIn(300)}),!1)},h=function h(){var e=$(this),t=e.find(".bFilterSlider"),n=t.data("config"),o=e.find(".mFromRange"),i=e.find(".mToRange"),l=n.min,r=n.max,s=n.step;t.slider({range:!0,step:s,min:l,max:r,values:[o.val(),i.val()],slide:function(e,t){o.val(t.values[0]),i.val(t.values[1])},change:function(){console.log("change slider"),a.trigger("change")}});var c=function c(){var e="0"+$(this).val();e=parseInt(e,10),e=e>r?r:l>e?l:e,$(this).val(e),t.slider({values:[o.val(),i.val()]})};i.on("change",c),o.on("change",c)},m=function m(){var e=$(this),t=e.attr("href"),a=e.parent();return f.removeClass("mActive"),a.addClass("mActive"),n.filter.lastRes?n.history.updateUrl(t,n.filter.renderCatalogPage):n.history.gotoUrl(t,n.filter.renderCatalogPage),!1},p=function p(){var e=$(this),t=e.attr("href"),a=e.parent();return d.removeClass("mActive"),a.addClass("mActive"),n.history.gotoUrl(t,n.filter.renderCatalogPage),!1};o.on("click",u),r.on("click",g),a.on("change",n.filter.changeFilterHandler),a.on("submit",n.filter.sendFilter),d.on("click",".bSortingList__eLink",p),f.on("click",".bSortingList__eLink",m),l.each(h)}(window.ENTER);