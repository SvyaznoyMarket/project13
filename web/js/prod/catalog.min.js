(function(e){console.info("Catalog init: catalog.js");var t=e.utils,r=t.extendApp("ENTER.catalog"),i=$("#bCatalog").data("lastpage");r.enableHistoryAPI="object"==typeof Mustache&&History.enabled,r.listingWrap=$(".bListing"),r.liveScroll=!1,r.lastPage=null,i&&(r.lastPage=i),console.info("Mustache is "+typeof Mustache+" (Catalog main config)"),console.info("enableHistoryAPI "+r.enableHistoryAPI)})(window.ENTER),function(e){console.info("New catalog init: filter.js");var t,r=$("body"),i=(e.config.pageConfig,e.utils),n=i.extendApp("ENTER.catalog"),o=$(".bFilter"),a=(o.find(".bBtnPick__eLink"),o.find(".bFilterToggle")),s=o.find(".bFilterCont"),l=o.find(".bRangeSlider"),c=o.find(".bFilterParams__eItem"),u=o.find(".bFilterValuesItem"),d=$(".bSortingLine");n.filter={lastRes:null,getViewType:function(){var e=d.find(".mViewer .mSortItem");return e.filter(".mActive").data("type")},applyTemplate:{list:function(e){console.info("applyTemplate list"),n.listingWrap.empty(),n.listingWrap.html(e)},selectedFilter:function(e){var t=o.find(".bFilterFoot");t.empty(),t.html(e)},sorting:function(e){var t=d.find(".bSortingList.mSorting");t.empty(),t.html(e)},pagination:function(e){var t=$(".bSortingList.mPager");t.empty(),t.html(e)},page:function(e){var t=$(".bTitlePage");t.empty(),t.html(e)},countProducts:function(e){var t=$(".bBtnPick__eLink",".bFilter"),r=e?parseInt(e):-1;r>=0&&t.length&&t.text("Подобрать ("+e+")")}},render:{list:function(e){console.info("render list"),console.log(n.filter.getViewType()!==void 0?n.filter.getViewType():"default");var t,r=n.filter.getViewType()!==void 0?n.filter.getViewType():"default",i={compact:$("#listing_compact_tmpl"),expanded:$("#listing_compact_tmpl"),"default":$("#listing_compact_tmpl")},o=i[r].html(),a=i[r].data("partial");return t=Mustache.render(o,e,a),console.log("end of render list"),t},selectedFilter:function(e){if(console.info("render selectedFilter"),!e)return console.warn("nothing to render"),void 0;var t,r=$("#tplSelectedFilter"),i=r.html(),o=r.data("partial");return t=Mustache.render(i,e,o),e.hasOwnProperty("values")&&(console.info("run update filter!"),n.filter.updateFilter(e.values)),console.log("end of render selectedFilter"),t},sorting:function(e){console.info("render sorting");var t,r=$("script.tplSorting:first"),i=r.html(),n=r.data("partial");return t=Mustache.render(i,e,n),console.log("end of render sorting"),t},pagination:function(e){console.info("render pagination");var t,r=$("script.tplPagination:first"),i=r.html(),n=r.data("partial");return t=Mustache.render(i,e,n),console.log("end of render paginaton"),t},page:function(e){var t=e.title;return t},countProducts:function(e){return console.info("render countProducts"),e}},renderCatalogPage:function(e){console.info("renderCatalogPage");var t,i,o=e?e:n.filter.lastRes,a=e.pagination?e.pagination.lastPage:!1;n.filter.resetForm();for(t in o)n.filter.render.hasOwnProperty(t)&&(i=n.filter.render[t](o[t])),n.filter.applyTemplate.hasOwnProperty(t)&&n.filter.applyTemplate[t](i);n.infScroll.checkInfinity(),a&&(n.lastPage=a),n.filter.lastRes=o,r.trigger("markcartbutton")},getSlidersInputState:function(){console.info("getSlidersInputState");var e={changedSliders:[],unchangedSliders:[]},t=function t(){var t=$(this),r=t.find(".bFilterSlider"),i=r.data("config"),n=t.find(".mFromRange"),o=t.find(".mToRange"),a=i.min,s=i.max;1*n.val()===a?e.unchangedSliders.push(n.attr("name")):e.changedSliders.push(n.attr("name")),1*o.val()===s?e.unchangedSliders.push(o.attr("name")):e.changedSliders.push(o.attr("name"))};return l.each(t),e},getFilterUrl:function(){console.info("getFilterUrl");for(var e,t=o.serializeArray(),r=o.attr("action")||"",i=n.filter.getSlidersInputState(),a=d.find(".mSortItem.mActive").find(".jsSorting"),s=a.data("sort"),l=n.filter.getUrlParams(),c=!1,u=t.length-1;u>=0;u--)-1!==i.unchangedSliders.indexOf(t[u].name)&&(console.log("slider input "+t[u].name+" unchanged"),t.splice(u,1));return l&&l.category&&($.each(t,function(){"category"==this.name&&(c=!0)}),c||t.unshift({name:"category",value:l.category})),e=$.param(t),0!==e.length&&(r+=-1===r.indexOf("?")?"?"+e:"&"+e),console.log(r),r=r.addParameterToUrl("sort",s)},getUrlParams:function(){var e,t,r={},i=window.location.search.substring(1).split("&");for(t=0;i.length>t;t++)e=i[t].split("="),r[e[0]]=e[1]===void 0?"":e[1];return r},changeFilterHandler:function(e,r){console.info("change filter"),console.log(e),console.log(r);var i=function i(){o.trigger("submit")};return"object"==typeof e&&e.isTrigger&&!r?(console.warn("it's trigger event!"),void 0):n.enableHistoryAPI?(console.info("need update from server..."),clearTimeout(t),t=setTimeout(i,300),void 0):(console.warn("history api off"),void 0)},sendFilter:function(e){console.info("sendFilter"),console.log(e);var t=n.filter.getFilterUrl();return t!==document.location.pathname+document.location.search&&(console.info("goto url "+t),n.history.gotoUrl(t)),e.isTrigger?console.warn("it's trigger"):"object"==typeof e&&n.enableHistoryAPI&&(console.warn("it's true event and HistoryAPI enable"),$.scrollTo(o.find(".bFilterFoot"),500)),!1},resetForm:function(){console.info("resetForm");var e=function e(e,t){var r=$(t),i=r.attr("id"),n=o.find('label[for="'+i+'"]');console.info(i),console.info(n),r.removeAttr("checked"),n.removeClass("mChecked")},t=function t(e,t){$(t).removeAttr("checked").trigger("change")},r=function r(){var e=$(this),t=e.find(".bFilterSlider"),r=t.data("config"),i=e.find(".mFromRange"),n=e.find(".mToRange"),o=r.min,a=r.max;i.val(o).trigger("change"),n.val(a).trigger("change")};o.find(":input:radio:checked").each(e),o.find(":input:checkbox:checked").each(t),l.each(r)},updateFilter:function(e){console.info("update filter");var t,r,i,n;console.info(e);var a={text:function(e,t){e.val(t).trigger("change")},radio:function(e,t){var r=e.filter('[value="'+t+'"]'),i=r.attr("id"),n=o.find('label[for="'+i+'"]');r.attr("checked","checked"),n.addClass("mChecked")},checkbox:function(e,t){e.filter('[value="'+t+'"]').attr("checked","checked").trigger("change")}};for(n in e){if(!e.hasOwnProperty(n))return;t=o.find('input[name="'+n+'"]'),r=e[n],i=t.attr("type"),console.log(t),console.log(r),console.log(i),a.hasOwnProperty(i)&&a[i](t,r)}},openFilter:function(){f(!0)}};var p=function p(){var e=$(this),t=e.find(".bFilterSlider"),r=t.data("config"),i=e.find(".mFromRange"),n=e.find(".mToRange"),a=r.min,s=r.max,l=r.step;t.slider({range:!0,step:l,min:a,max:s,values:[i.val(),n.val()],slide:function(e,t){i.val(t.values[0]),n.val(t.values[1])},change:function(e){console.log("change slider"),e.originalEvent&&o.trigger("change",[!0])}});var c=function c(){var e="0"+$(this).val();e=parseFloat(e),console.info("inputUpdates"),console.log(e),e=e>s?s:a>e?a:e,$(this).val(e),t.slider({values:[i.val(),n.val()]})};n.on("change",c),i.on("change",c)},h=function h(){var e=$(this),t=e.attr("href");return n.history.gotoUrl(t),!1},f=function f(e){var t="mOpen",r="mClose",i=a.hasClass(t);return i&&"boolean"!=typeof e?(a.removeClass(t).addClass(r),s.slideUp(400)):(a.removeClass(r).addClass(t),s.slideDown(400)),!1},m=function m(){var e=$(this),t=e.attr("href"),r="mActive",i=e.parent(),a=i.hasClass(r);return a?!1:(n.history.gotoUrl(t),o.length&&$.scrollTo(o,500),!1)},g=function g(){var e=$(this),t="mActive",r=e.hasClass(t),i=e.data("ref");return r?!1:(c.removeClass(t),e.addClass(t),u.fadeOut(300),u.promise().done(function(){$("#"+i).fadeIn(300)}),$.scrollTo(o,500),!1)},v=function v(){var e=$(this),t=e.attr("href"),r="mActive",i=e.parent(),o=d.find(".mViewer .mSortItem"),a=i.hasClass(r);return a?!1:(o.removeClass(r),i.addClass(r),n.filter.lastRes?n.history.updateUrl(t):n.history.gotoUrl(t),!1)},_=function _(){var e=$(this),t=e.attr("href"),r="mActive",i=e.parent(),o=d.find(".mSorting .mSortItem"),a=i.hasClass(r);return a?!1:(o.removeClass(r),i.addClass(r),n.history.gotoUrl(t),!1)};a.on("click",f),c.on("click",g),o.on("change",n.filter.changeFilterHandler),o.on("submit",n.filter.sendFilter),d.on("click",".jsSorting",_),d.on("click",".jsChangeView",v),d.on("click",".jsPagination",m),r.on("click",".jsHistoryLink",h),l.each(p)}(window.ENTER),function(e){var t=e.utils,r=t.extendApp("ENTER.catalog");console.info("New catalog history module"),r.history={_defaultCallback:r.filter.renderCatalogPage,_customCallback:null,gotoUrl:function(e,t,i){console.info("gotoUrl");var n={title:document.title,url:e,data:{_onlychange:i?!0:!1}};return r.enableHistoryAPI?(r.history._customCallback=t?t:null,console.info("link handler. push state new url: "+n.url),History.pushState(n,n.title,n.url),void 0):(document.location.href=e,void 0)},updateUrl:function(e,t){var i=t?t:null;r.history.gotoUrl(e,i,!0)},getDataFromServer:function(e,t){console.info("getDataFromServer "+e),r.loader&&r.loader.loading(),console.log("getDataFromServer::loading");var i=function i(){r.loader&&r.loader.complete()},n=function n(e){console.info("resHandler"),"object"==typeof e?t(e):(console.warn("res isn't object"),console.log(typeof e)),r.loader&&r.loader.complete()};$.ajax({type:"GET",url:e,success:n,statusCode:{500:i,503:i},error:i})}};var i=function i(){var e=History.getState(),t=e.url,i=e.data.data,n="function"==typeof r.history._customCallback?r.history._customCallback:r.history._defaultCallback;console.info("statechange"),console.log(e),i._onlychange?(console.info("only update url "+t),n()):(t=t.addParameterToUrl("ajax","true"),r.history.getDataFromServer(t,n)),r.history._customCallback=null};History.Adapter.bind(window,"statechange",i)}(window.ENTER),function(e){console.info("Catalog init: catalog_infinityScroll.js");var t=e.utils,r=t.extendApp("ENTER.catalog"),i=$(".bSortingLine");r.infScroll={loading:!1,nowPage:1,checkInfinity:function(){console.info("checkInfinity "+window.docCookies.getItem("infScroll")),"1"===window.docCookies.getItem("infScroll")&&(console.warn("inf cookie == 1"),r.infScroll.enable())},checkScroll:function(){console.info("checkscroll");var e=$(window),t=$(document);!r.infScroll.loading&&e.scrollTop()+800>t.height()-e.height()&&(r.lastPage-r.infScroll.nowPage>0||null===r.lastPage)&&(console.warn("checkscroll true. load"),r.infScroll.nowPage+=1,r.infScroll.load())},load:function(){console.info("load page");var e=r.filter.getFilterUrl(),t=function t(e){var t;t=r.filter.render.list(e.list),r.infScroll.loading=!1,r.listingWrap.append(t)};r.liveScroll=!0,r.infScroll.loading=!0,e=e.addParameterToUrl("page",r.infScroll.nowPage),e=e.addParameterToUrl("ajax","true"),r.history.getDataFromServer(e,t)},enable:function(){console.info("enable...");var e="mActive",t=i.find(".mInfinity"),n=i.find(".mPaging"),o=i.find(".bSortingList__eItem.mPage"),a=r.filter.getFilterUrl(),s=document.location.search.match("page=");n.show(),o.hide(),t.addClass(e),r.infScroll.nowPage=1,r.infScroll.loading=!1,window.docCookies.setItem("infScroll",1,2419200,"/"),r.infScroll.checkScroll(),$(window).on("scroll",r.infScroll.checkScroll),console.info(s),r.enableHistoryAPI&&s&&r.history.gotoUrl(a),console.log("infinity scroll enable")},disable:function(){console.info("disable infinity...");var e=r.filter.getFilterUrl();r.liveScroll=!1,e=e.addParameterToUrl("ajax","true"),window.docCookies.setItem("infScroll",0,2419200,"/"),$(window).off("scroll",r.infScroll.checkScroll),r.history.getDataFromServer(e,r.filter.renderCatalogPage),console.log("infinity scroll disable "+window.docCookies.getItem("infScroll"))}};var n=function n(){var e="mActive",t=i.find(".mInfinity"),n=t.hasClass(e);return n?!1:(r.infScroll.enable(),!1)},o=function o(){console.info("paginationBtnHandler");var e="mActive",t=i.find(".mInfinity"),n=t.hasClass(e);return n&&r.infScroll.disable(),!1};r.infScroll.checkInfinity(),i.on("click",".jsPaginationEnable",o),i.on("click",".jsInfinityEnable",n)}(window.ENTER),function(e){console.info("New catalog init: loader.js");var t=(e.config.pageConfig,e.utils),r=t.extendApp("ENTER.catalog"),i=$(".bBtnPick__eLink",".bFilter");console.info("Mustache is "+typeof Mustache),console.info("enableHistoryAPI "+r.enableHistoryAPI),r.loader={_loader:null,loading:function(){r.loader._loader||(r.loader._loader=$("<li>").addClass("mLoader"),i.addClass("mButLoader").text("Подобрать"),r.liveScroll?r.listingWrap.append(r.loader._loader):(r.listingWrap.empty(),r.listingWrap.append(r.loader._loader)))},complete:function(){r.loader._loader&&(r.loader._loader.remove(),r.loader._loader=null),i.removeClass("mButLoader")}}}(window.ENTER),function(){var e=$(".jsChangePackageSet"),t=$(".jsPackageSetPopup"),r=function r(){t.lightbox_me({autofocus:!0})};e.on("click",r)}(window.ENTER),$(document).ready(function(){function e(e,t){var r=window[window.GoogleAnalyticsObject],i=window._gaq,n=window.location.href;r&&r("send","event",e,n,t),i&&i.push(["_trackEvent",e,n,t])}var t=$(".jsDataSmartChoice"),r=$(".specialPriceItem"),i=t.attr("data-smartchoice");$.getJSON("/ajax/product-smartchoice",{"products[]":t.data("smartchoice")},function(e){e.success&&($.each(e.result,function(e,t){$slider=$.parseHTML(t.content),$($slider).hide(),$(".specialBorderBox").append($slider),$(".smartChoiceSliderToggle-"+e).show()}),$(".bGoodsSlider").goodsSlider(),console.info("smartchoice ajax: ",e.result))}),$(".jsSmartChoiceSliderToggle a").click(function(e){e.preventDefault();var t=$(e.target),r=t.closest("div").data("smartchoice"),i=t.closest("a"),n=$(".specialPriceItemFoot_link");i.hasClass("mActive")?(n.removeClass("mActive"),$(".smartChoiceId-"+r).parent().hide(),$(".specialBorderBox").removeClass("specialBorderBox_render")):(n.removeClass("mActive"),i.addClass("mActive"),$(".bGoodsSlider").hide(),$(".specialBorderBox").addClass("specialBorderBox_render"),$(".smartChoiceId-"+r).parent().show())}),i!==void 0&&i!==!1?r.addClass("specialPriceItem_minHeight"):r.removeClass("specialPriceItem_minHeight"),r.on("click",".specialPriceItemCont_imgLink, .specialPriceItemCont_name",function(){var t=$(this).data("article");e("SmartChoice_click",t)}),t.on("click",".productImg, .productName a",function(t){var r=$(t.target).closest(".bSlider__eItem").data("product").article;e("SmartChoice_similar_click",r)})});