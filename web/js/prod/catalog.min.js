(function(e){console.info("Catalog init: catalog.js");var n=e.utils,t=n.extendApp("ENTER.catalog"),o=$("#bCatalog").data("lastpage");t.enableHistoryAPI="object"==typeof Mustache&&History.enabled,t.listingWrap=$(".bListing"),t.liveScroll=!1,t.lastPage=null,o&&(t.lastPage=o),console.info("Mustache is "+typeof Mustache+" (Catalog main config)"),console.info("enableHistoryAPI "+t.enableHistoryAPI)})(window.ENTER),function(e){console.info("New catalog init: filter.js");var n,t=$("body"),o=(e.config.pageConfig,e.utils),i=o.extendApp("ENTER.catalog"),l=$(".bFilter"),r=(l.find(".bBtnPick__eLink"),l.find(".bFilterToggle")),a=l.find(".bFilterCont"),c=l.find(".bRangeSlider"),s=l.find(".bFilterParams__eItem"),d=l.find(".bFilterValuesItem"),f=$(".bSortingLine");i.filter={lastRes:null,getViewType:function(){var e=f.find(".mViewer .mSortItem");return e.filter(".mActive").data("type")},applyTemplate:{list:function(e){console.info("applyTemplate list"),i.listingWrap.empty(),i.listingWrap.html(e)},selectedFilter:function(e){var n=l.find(".bFilterFoot");n.empty(),n.html(e)},sorting:function(e){var n=f.find(".bSortingList.mSorting");n.empty(),n.html(e)},pagination:function(e){var n=$(".bSortingList.mPager");n.empty(),n.html(e)},page:function(e){var n=$(".bTitlePage");n.empty(),n.html(e)},countProducts:function(e){var n=$(".bBtnPick__eLink",".bFilter"),t=e?parseInt(e):-1;t>=0&&n.length&&n.text("Подобрать ("+e+")")}},render:{list:function(e){console.info("render list"),console.log(i.filter.getViewType()!==void 0?i.filter.getViewType():"default");var n,t=i.filter.getViewType()!==void 0?i.filter.getViewType():"default",o={compact:$("#listing_compact_tmpl"),expanded:$("#listing_compact_tmpl"),"default":$("#listing_compact_tmpl")},l=o[t].html(),r=o[t].data("partial");return n=Mustache.render(l,e,r),console.log("end of render list"),n},selectedFilter:function(e){if(console.info("render selectedFilter"),!e)return console.warn("nothing to render"),void 0;var n,t=$("#tplSelectedFilter"),o=t.html(),l=t.data("partial");return n=Mustache.render(o,e,l),e.hasOwnProperty("values")&&(console.info("run update filter!"),i.filter.updateFilter(e.values)),console.log("end of render selectedFilter"),n},sorting:function(e){console.info("render sorting");var n,t=$("script.tplSorting:first"),o=t.html(),i=t.data("partial");return n=Mustache.render(o,e,i),console.log("end of render sorting"),n},pagination:function(e){console.info("render pagination");var n,t=$("script.tplPagination:first"),o=t.html(),i=t.data("partial");return n=Mustache.render(o,e,i),console.log("end of render paginaton"),n},page:function(e){var n=e.title;return n},countProducts:function(e){return console.info("render countProducts"),e}},refreshFiltersVisibility:function(e){var n=function(){$(".bFilterParams li").each(function(){var e=$(this),n=e.data("ref"),t=$("#"+n),o=!0;return t.length?(t.find(".bFilterValuesCol").each(function(){"none"!==$(this).css("display")&&(o=!1)}),o?e.hide():e.show(),void 0):!0})},t=function(e){var n,t,o,i,l=function(e,n){e.length&&(i=e.parent(".bFilterValuesCol").find(".facet"),i.length&&i.html("("+n+")"))};if(e)for(t in e)if("shop"===t)for(o in e[t])n=$('input[name="'+t+'"][value="'+o+'"]'),l(n,e[t][o]);else n=$('input[name="'+t+'"]'),l(n,e[t])},o=function(e,n){var t,o,i,l=".bFilterValuesCol",r=$(l).find("input"),a=[],c=[],s=function(e){o=e.parent(l),o.length&&o.show()},d=function(e){o=e.parent(l),o.length&&o.hide()},f=function(){var e=$(this);return-1!==$.inArray(e.attr("name"),a)?("shop"===e.attr("name")?-1!==$.inArray(parseInt(e.attr("value")),c)?"disabled"===n?d(e):s(e):"disabled"===n?s(e):d(e):"disabled"===n?d(e):s(e),!0):("disabled"===n?s(e):d(e),void 0)};if(r.length){if(void 0===n&&(n="disabled"),e)for(t in e){if("shop"===t)for(i in e[t])c.push(e[t][i]);a.push(t)}r.each(f)}},i=function(e){e&&o(e,"showed")},l=function(e){e&&o(e,"disabled")};e&&(e.disabled?(l(e.disabled),e.changed&&t(e.changed)):e.showed&&(i(e.showed),t(e.showed)),n())},renderCatalogPage:function(e){console.info("renderCatalogPage");var n,o,l=e?e:i.filter.lastRes,r=e.pagination?e.pagination.lastPage:!1;i.filter.resetForm(),void 0!==e.newFilter&&i.filter.refreshFiltersVisibility(e.newFilter);for(n in l)i.filter.render.hasOwnProperty(n)&&(o=i.filter.render[n](l[n])),i.filter.applyTemplate.hasOwnProperty(n)&&i.filter.applyTemplate[n](o);i.infScroll.checkInfinity(),r&&(i.lastPage=r),i.filter.lastRes=l,t.trigger("markcartbutton")},getSlidersInputState:function(){console.info("getSlidersInputState");var e={changedSliders:[],unchangedSliders:[]},n=function n(){var n=$(this),t=n.find(".bFilterSlider"),o=t.data("config"),i=n.find(".mFromRange"),l=n.find(".mToRange"),r=o.min,a=o.max;1*i.val()===r?e.unchangedSliders.push(i.attr("name")):e.changedSliders.push(i.attr("name")),1*l.val()===a?e.unchangedSliders.push(l.attr("name")):e.changedSliders.push(l.attr("name"))};return c.each(n),e},getFilterUrl:function(){console.info("getFilterUrl");for(var e,n=l.serializeArray(),t=l.attr("action")||"",o=i.filter.getSlidersInputState(),r=f.find(".mSortItem.mActive").find(".jsSorting"),a=r.data("sort"),c=i.filter.getUrlParams(),s=!1,d=n.length-1;d>=0;d--)-1!==o.unchangedSliders.indexOf(n[d].name)&&(console.log("slider input "+n[d].name+" unchanged"),n.splice(d,1));return c&&c.category&&($.each(n,function(){"category"==this.name&&(s=!0)}),s||n.unshift({name:"category",value:c.category})),e=$.param(n),0!==e.length&&(t+=-1===t.indexOf("?")?"?"+e:"&"+e),console.log(t),t=t.addParameterToUrl("sort",a)},getUrlParams:function(){var e,n,t={},o=window.location.search.substring(1).split("&");for(n=0;o.length>n;n++)e=o[n].split("="),t[e[0]]=e[1]===void 0?"":e[1];return t},changeFilterHandler:function(e,t){console.info("change filter"),console.log(e),console.log(t);var o=function o(){l.trigger("submit")};return"object"==typeof e&&e.isTrigger&&!t?(console.warn("it's trigger event!"),void 0):i.enableHistoryAPI?(console.info("need update from server..."),clearTimeout(n),n=setTimeout(o,300),void 0):(console.warn("history api off"),void 0)},sendFilter:function(e){console.info("sendFilter"),console.log(e);var n=i.filter.getFilterUrl();return n!==document.location.pathname+document.location.search&&(console.info("goto url "+n),i.history.gotoUrl(n)),e.isTrigger?console.warn("it's trigger"):"object"==typeof e&&i.enableHistoryAPI&&(console.warn("it's true event and HistoryAPI enable"),$.scrollTo(l.find(".bFilterFoot"),500)),!1},resetForm:function(){console.info("resetForm");var e=function e(e,n){var t=$(n),o=t.attr("id"),i=l.find('label[for="'+o+'"]');console.info(o),console.info(i),t.removeAttr("checked"),i.removeClass("mChecked")},n=function n(e,n){$(n).removeAttr("checked").trigger("change")},t=function t(){var e=$(this),n=e.find(".bFilterSlider"),t=n.data("config"),o=e.find(".mFromRange"),i=e.find(".mToRange"),l=t.min,r=t.max;o.val(l).trigger("change"),i.val(r).trigger("change")};l.find(":input:radio:checked").each(e),l.find(":input:checkbox:checked").each(n),c.each(t)},updateFilter:function(e){console.info("update filter");var n,t,o,i;console.info(e);var r={text:function(e,n){e.val(n).trigger("change")},radio:function(e,n){var t=e.filter('[value="'+n+'"]'),o=t.attr("id"),i=l.find('label[for="'+o+'"]');t.attr("checked","checked"),i.addClass("mChecked")},checkbox:function(e,n){e.filter('[value="'+n+'"]').attr("checked","checked").trigger("change")}};for(i in e){if(!e.hasOwnProperty(i))return;n=l.find('input[name="'+i+'"]'),t=e[i],o=n.attr("type"),console.log(n),console.log(t),console.log(o),r.hasOwnProperty(o)&&r[o](n,t)}},openFilter:function(){h(!0)}};var g=function g(){var e=$(this),n=e.find(".bFilterSlider"),t=n.data("config"),o=e.find(".mFromRange"),i=e.find(".mToRange"),r=t.min,a=t.max,c=t.step;n.slider({range:!0,step:c,min:r,max:a,values:[o.val(),i.val()],slide:function(e,n){o.val(n.values[0]),i.val(n.values[1])},change:function(e){console.log("change slider"),e.originalEvent&&l.trigger("change",[!0])}});var s=function s(){var e="0"+$(this).val();e=parseFloat(e),console.info("inputUpdates"),console.log(e),e=e>a?a:r>e?r:e,$(this).val(e),n.slider({values:[o.val(),i.val()]})};i.on("change",s),o.on("change",s)},u=function u(){var e=$(this),n=e.attr("href");return i.history.gotoUrl(n),!1},h=function h(e){var n="mOpen",t="mClose",o=r.hasClass(n);return o&&"boolean"!=typeof e?(r.removeClass(n).addClass(t),a.slideUp(400)):(r.removeClass(t).addClass(n),a.slideDown(400)),!1},m=function m(){var e=$(this),n=e.attr("href"),t="mActive",o=e.parent(),r=o.hasClass(t);return r?!1:(i.history.gotoUrl(n),l.length&&$.scrollTo(l,500),!1)},p=function p(){var e=$(this),n="mActive",t=e.hasClass(n),o=e.data("ref");return t?!1:(s.removeClass(n),e.addClass(n),d.fadeOut(300),d.promise().done(function(){$("#"+o).fadeIn(300)}),$.scrollTo(l,500),!1)},v=function v(){var e=$(this),n=e.attr("href"),t="mActive",o=e.parent(),l=f.find(".mViewer .mSortItem"),r=o.hasClass(t);return r?!1:(l.removeClass(t),o.addClass(t),i.filter.lastRes?i.history.updateUrl(n):i.history.gotoUrl(n),!1)},y=function y(){var e=$(this),n=e.attr("href"),t="mActive",o=e.parent(),l=f.find(".mSorting .mSortItem"),r=o.hasClass(t);return r?!1:(l.removeClass(t),o.addClass(t),i.history.gotoUrl(n),!1)};r.on("click",h),s.on("click",p),l.on("change",i.filter.changeFilterHandler),l.on("submit",i.filter.sendFilter),f.on("click",".jsSorting",y),f.on("click",".jsChangeView",v),f.on("click",".jsPagination",m),t.on("click",".jsHistoryLink",u),c.each(g)}(window.ENTER),function(e){var n=e.utils,t=n.extendApp("ENTER.catalog");console.info("New catalog history module"),t.history={_defaultCallback:t.filter.renderCatalogPage,_customCallback:null,gotoUrl:function(e,n,o){console.info("gotoUrl");var i={title:document.title,url:e,data:{_onlychange:o?!0:!1}};return t.enableHistoryAPI?(t.history._customCallback=n?n:null,console.info("link handler. push state new url: "+i.url),History.pushState(i,i.title,i.url),void 0):(document.location.href=e,void 0)},updateUrl:function(e,n){var o=n?n:null;t.history.gotoUrl(e,o,!0)},getDataFromServer:function(e,n){console.info("getDataFromServer "+e),t.loader&&t.loader.loading(),console.log("getDataFromServer::loading");var o=function o(){t.loader&&t.loader.complete()},i=function i(e){console.info("resHandler"),"object"==typeof e?n(e):(console.warn("res isn't object"),console.log(typeof e)),t.loader&&t.loader.complete()};$.ajax({type:"GET",url:e,success:i,statusCode:{500:o,503:o},error:o})}};var o=function o(){var e=History.getState(),n=e.url,o=e.data.data,i="function"==typeof t.history._customCallback?t.history._customCallback:t.history._defaultCallback;console.info("statechange"),console.log(e),o._onlychange?(console.info("only update url "+n),i()):(n=n.addParameterToUrl("ajax","true"),t.history.getDataFromServer(n,i)),t.history._customCallback=null};History.Adapter.bind(window,"statechange",o)}(window.ENTER),function(e){console.info("Catalog init: catalog_infinityScroll.js");var n=e.utils,t=n.extendApp("ENTER.catalog"),o=$(".bSortingLine");t.infScroll={loading:!1,nowPage:1,checkInfinity:function(){console.info("checkInfinity "+window.docCookies.getItem("infScroll")),"1"===window.docCookies.getItem("infScroll")&&(console.warn("inf cookie == 1"),t.infScroll.enable())},checkScroll:function(){console.info("checkscroll");var e=$(window),n=$(document);!t.infScroll.loading&&e.scrollTop()+800>n.height()-e.height()&&(t.lastPage-t.infScroll.nowPage>0||null===t.lastPage)&&(console.warn("checkscroll true. load"),t.infScroll.nowPage+=1,t.infScroll.load())},load:function(){console.info("load page");var e=t.filter.getFilterUrl(),n=function n(e){var n;n=t.filter.render.list(e.list),t.infScroll.loading=!1,t.listingWrap.append(n)};t.liveScroll=!0,t.infScroll.loading=!0,e=e.addParameterToUrl("page",t.infScroll.nowPage),e=e.addParameterToUrl("ajax","true"),t.history.getDataFromServer(e,n)},enable:function(){console.info("enable...");var e="mActive",n=o.find(".mInfinity"),i=o.find(".mPaging"),l=o.find(".bSortingList__eItem.mPage"),r=t.filter.getFilterUrl(),a=document.location.search.match("page=");i.show(),l.hide(),n.addClass(e),t.infScroll.nowPage=1,t.infScroll.loading=!1,window.docCookies.setItem("infScroll",1,2419200,"/"),t.infScroll.checkScroll(),$(window).on("scroll",t.infScroll.checkScroll),console.info(a),t.enableHistoryAPI&&a&&t.history.gotoUrl(r),console.log("infinity scroll enable")},disable:function(){console.info("disable infinity...");var e=t.filter.getFilterUrl();t.liveScroll=!1,e=e.addParameterToUrl("ajax","true"),window.docCookies.setItem("infScroll",0,2419200,"/"),$(window).off("scroll",t.infScroll.checkScroll),t.history.getDataFromServer(e,t.filter.renderCatalogPage),console.log("infinity scroll disable "+window.docCookies.getItem("infScroll"))}};var i=function i(){var e="mActive",n=o.find(".mInfinity"),i=n.hasClass(e);return i?!1:(t.infScroll.enable(),!1)},l=function l(){console.info("paginationBtnHandler");var e="mActive",n=o.find(".mInfinity"),i=n.hasClass(e);return i&&t.infScroll.disable(),!1};t.infScroll.checkInfinity(),o.on("click",".jsPaginationEnable",l),o.on("click",".jsInfinityEnable",i)}(window.ENTER),function(e){console.info("New catalog init: loader.js");var n=(e.config.pageConfig,e.utils),t=n.extendApp("ENTER.catalog"),o=$(".bBtnPick__eLink",".bFilter");console.info("Mustache is "+typeof Mustache),console.info("enableHistoryAPI "+t.enableHistoryAPI),t.loader={_loader:null,loading:function(){t.loader._loader||(t.loader._loader=$("<li>").addClass("mLoader"),o.addClass("mButLoader").text("Подобрать"),t.liveScroll?t.listingWrap.append(t.loader._loader):(t.listingWrap.empty(),t.listingWrap.append(t.loader._loader)))},complete:function(){t.loader._loader&&(t.loader._loader.remove(),t.loader._loader=null),o.removeClass("mButLoader")}}}(window.ENTER);