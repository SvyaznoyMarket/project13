!function(a){a.kladr={},a.kladr.url="http://kladr-api.ru/api.php",a.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"},a.kladr.api=function(b,c){var d={};b.token&&(d.token=b.token),b.key&&(d.key=b.key),b.type&&(d.contentType=b.type),b.name&&(d.query=b.name),b.parentType&&b.parentId&&(d[b.parentType+"Id"]=b.parentId),b.withParents&&(d.withParent=1),d.limit=b.limit?b.limit:2e3;var e=!1;a.getJSON(a.kladr.url+"?callback=?",d,function(a){e||(e=!0,c&&c(a.result))}),setTimeout(function(){e||(e=!0,c&&c([]))},5e3)},a.kladr.check=function(b,c){b.withParents=!1,b.limit=1,a.kladr.api(b,function(a){a&&a.length?c&&c(a[0]):c&&c(!1)})}}(jQuery),function(a,b){a.fn.kladr=function(c,d){function e(c,d,e){function f(d,e,f){if(x=c.data("kladr-options"),e!==b)return x[d]=e,c.data("kladr-options",x),c;if("string"===a.type(d))return x?x[d]:null;if(x)return c;if(x=y,"object"===a.type(d))for(var g in d)x[g]=d[g];return c.data("kladr-options",x),f&&f(),c}function g(){var b=a(document.getElementById("kladr_autocomplete")),d=c.attr("name");b.length||(b=a('<div id="kladr_autocomplete"></div>').appendTo("body")),c.attr("autocomplete","off"),v=a('<ul class="kladr_autocomplete_'+d+'" style="display: none;"></ul>'),v.appendTo(b),w=a('<div class="spinner kladr_autocomplete_'+d+'_spinner" class="spinner" style="display: none;"></div>'),w.appendTo(b)}function h(b,c){v.empty();for(var d in b){var e=b[d],f=x.valueFormat(e,c),g=x.labelFormat(e,c),h=a('<a data-val="'+f+'">'+g+"</a>");h.data("kladr-object",e);var i=a("<li></li>").append(h);i.appendTo(v)}}function i(){var a=c.offset(),b=c.outerWidth(),d=c.outerHeight();v.css({top:a.top+d+"px",left:a.left});var e=v.outerWidth()-v.width();v.width(b-e);var f=w.width(),g=w.height();w.css({top:a.top+(d-g)/2-1,left:a.left+b-f-2})}function j(b){if(!(b.which>8&&b.which<46)&&l()){var d=q(c.val());if(!a.trim(d))return void k();t(),r("send"),x.source(d,function(b){return u(),r("received"),c.is(":focus")&&a.trim(c.val())&&b.length?(h(b,d),i(),v.slideDown(50),void r("open")):void k()})}}function k(){m(),v.hide(),r("close")}function l(){switch(x.type){case a.kladr.type.region:case a.kladr.type.district:case a.kladr.type.city:if(x.parentType&&!x.parentId)return!1;break;case a.kladr.type.street:if(x.parentType!=a.kladr.type.city)return!1;if(!x.parentId)return!1;break;case a.kladr.type.building:if(x.parentType!=a.kladr.type.street)return!1;if(!x.parentId)return!1;break;default:return!1}return x.limit<1?!1:!0}function m(){var a=v.find(".active a");a.length&&(c.val(a.attr("data-val")),x.current=a.data("kladr-object"),c.data("kladr-options",x),r("select",x.current))}function n(a){var b=v.find("li.active");switch(a.which){case z.up:b.length?(b.removeClass("active"),b=b.prev()):b=v.find("li").last(),b.addClass("active");var c=b.find("a").data("kladr-object");r("preselect",c),x.arrowSelect&&m();break;case z.down:b.length?(b.removeClass("active"),b=b.next()):b=v.find("li").first(),b.addClass("active");var c=b.find("a").data("kladr-object");r("preselect",c),x.arrowSelect&&m();break;case z.esc:b.removeClass("active"),k();break;case z.enter:return x.arrowSelect||m(),b.removeClass("active"),k(),!1}}function o(){var b=a(this);return b.is("li")&&(b=b.find("a")),k(),c.focus(),!1}function p(){if(x.verify&&l()){var b=q(c.val());a.trim(b)&&(t(),r("send"),x.source(b,function(a){u(),r("received");for(var d=null,e=0;e<a.length;e++){var f=b.toLowerCase(),g=a[e].name.toLowerCase();if(f==g){d=a[e];break}}d&&c.val(x.valueFormat(d,b)),x.current=d,c.data("kladr-options",x),r("check",x.current)}))}}function q(a){for(var b,c,d="1234567890qazwsxedcrfvtgbyhnujmik,ol.p;[']- QAZWSXEDCRFVTGBYHNUJMIK<OL>P:{\"} ",e="1234567890йфяцычувскамепинртгоьшлбщдюзжхэъ- ЙФЯЦЫЧУВСКАМЕПИНРТГОЬШЛБЩДЮЗЖХЭЪ ",f="",g=0;g<a.length;g++)b=a[g],c=d.indexOf(b),f+=c>-1?e[c]:b;return f}function r(a,b){a&&(c.trigger("kladr_"+a,b),x[a]&&x[a].call(c.get(0),b))}function s(){if(!A){var a=-.2;A=setInterval(function(){return w.is(":visible")?(w.css("background-position","0% "+a+"%"),a+=5.555556,void(a>95&&(a=-.2))):(clearInterval(A),void(A=null))},30)}}function t(){x.showSpinner&&(w.show(),s())}function u(){w.hide()}var v=null,w=null,x=null,y={token:null,key:null,type:null,parentType:null,parentId:null,limit:10,withParents:!1,verify:!1,showSpinner:!0,arrowSelect:!0,current:null,open:null,close:null,send:null,received:null,select:null,check:null,source:function(b,c){var d={token:x.token,key:x.token,type:x.type,name:b,parentType:x.parentType,parentId:x.parentId,withParents:x.withParents,limit:x.limit};a.kladr.api(d,c)},labelFormat:function(a,b){var c="",d=a.name.toLowerCase();b=b.toLowerCase();var e=d.indexOf(b);return e=e>0?e:0,a.typeShort&&(c+=a.typeShort+". "),b.length<a.name.length?(c+=a.name.substr(0,e),c+="<strong>"+a.name.substr(e,b.length)+"</strong>",c+=a.name.substr(e+b.length,a.name.length-b.length-e)):c+="<strong>"+a.name+"</strong>",c},valueFormat:function(a){return a.name}},z={up:38,down:40,esc:27,enter:13},A=null;return f(d,e,function(){var b=!1;g(),i(),c.keyup(j),c.keydown(n),c.change(function(){b||p()}),c.blur(function(){b||k()}),v.on("click","li, a",o),v.on("mouseenter","li",function(){var c=a(this);v.find("li.active").removeClass("active"),c.addClass("active");var d=c.find("a").data("kladr-object");r("preselect",d),b=!0}),v.on("mouseleave","li",function(){a(this).removeClass("active"),b=!1}),a(window).resize(i)})}var f=b;return this.each(function(){var g=e(a(this),c,d);f==b&&(f=g)}),f}}(jQuery);