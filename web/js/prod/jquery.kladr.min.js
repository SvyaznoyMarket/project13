(function(e){e.kladr={},e.kladr.url="http://kladr-api.ru/api.php",e.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"},e.kladr.api=function(t,r){var a={};t.token&&(a.token=t.token),t.key&&(a.key=t.key),t.type&&(a.contentType=t.type),t.name&&(a.query=t.name),t.parentType&&t.parentId&&(a[t.parentType+"Id"]=t.parentId),t.withParents&&(a.withParent=1),a.limit=t.limit?t.limit:2e3;var n=!1;e.getJSON(e.kladr.url+"?callback=?",a,function(e){n||(n=!0,r&&r(e.result))}),setTimeout(function(){n||(n=!0,console.error("Request error"),r&&r([]))},5e3)},e.kladr.check=function(t,r){t.withParents=!1,t.limit=1,e.kladr.api(t,function(e){e&&e.length?r&&r(e[0]):r&&r(!1)})}})(jQuery),function(e,t){e.fn.kladr=function(r,a){function n(r,a,n){function o(a,n,o){if(w=r.data("kladr-options"),n!==t)return w[a]=n,r.data("kladr-options",w),r;if("string"===e.type(a))return w?w[a]:null;if(w)return r;if(w=T,"object"===e.type(a))for(var i in a)w[i]=a[i];return r.data("kladr-options",w),o&&o(),r}function i(){var t=e(document.getElementById("kladr_autocomplete")),a=r.attr("name");t.length||(t=e('<div id="kladr_autocomplete"></div>').appendTo("body")),r.attr("autocomplete","off"),M=e('<ul class="kladr_autocomplete_'+a+'" style="display: none;"></ul>'),M.appendTo(t),P=e('<div class="spinner kladr_autocomplete_'+a+'_spinner" class="spinner" style="display: none;"></div>'),P.appendTo(t)}function s(t,r){M.empty();for(var a in t){var n=t[a],o=w.valueFormat(n,r),i=w.labelFormat(n,r),s=e('<a data-val="'+o+'">'+i+"</a>");s.data("kladr-object",n);var l=e("<li></li>").append(s);l.appendTo(M)}}function l(){var e=r.offset(),t=r.outerWidth(),a=r.outerHeight();M.css({top:e.top+a+"px",left:e.left});var n=M.outerWidth()-M.width();M.width(t-n);var o=P.width(),i=P.height();P.css({top:e.top+(a-i)/2-1,left:e.left+t-o-2})}function u(a){if(!(a.which>8&&46>a.which)&&c()){var n=g(r.val());if(!e.trim(n))return d(),t;b(),v("send"),w.source(n,function(a){return D(),v("received"),r.is(":focus")?e.trim(r.val())&&a.length?(s(a,n),l(),M.slideDown(50),v("open"),t):(d(),t):(d(),t)})}}function d(){p(),M.hide(),v("close")}function c(){switch(w.type){case e.kladr.type.region:case e.kladr.type.district:case e.kladr.type.city:if(w.parentType&&!w.parentId)return console.error("parentType is defined and parentId in not"),!1;break;case e.kladr.type.street:if(w.parentType!=e.kladr.type.city)return console.error('For street parentType must equal "city"'),!1;if(!w.parentId)return console.error("For street parentId must defined"),!1;break;case e.kladr.type.building:if(w.parentType!=e.kladr.type.street)return console.error('For building parentType must equal "street"'),!1;if(!w.parentId)return console.error("For building parentId must defined"),!1;break;default:return console.error('type must defined and equal "region", "district", "city", "street" or "building"'),!1}return 1>w.limit?(console.error("limit must greater than 0"),!1):!0}function p(){var e=M.find(".active a");e.length&&(r.val(e.attr("data-val")),w.current=e.data("kladr-object"),r.data("kladr-options",w),v("select",w.current))}function f(e){var t=M.find("li.active");switch(e.which){case S.up:t.length?(t.removeClass("active"),t=t.prev()):t=M.find("li").last(),t.addClass("active");var r=t.find("a").data("kladr-object");v("preselect",r),w.arrowSelect&&p();break;case S.down:t.length?(t.removeClass("active"),t=t.next()):t=M.find("li").first(),t.addClass("active");var r=t.find("a").data("kladr-object");v("preselect",r),w.arrowSelect&&p();break;case S.esc:t.removeClass("active"),d();break;case S.enter:return w.arrowSelect||p(),t.removeClass("active"),d(),!1}}function h(){var t=e(this);return t.is("li")&&(t=t.find("a")),d(),r.focus(),!1}function m(){if(w.verify&&c()){var t=g(r.val());e.trim(t)&&(b(),v("send"),w.source(t,function(e){D(),v("received");for(var a=null,n=0;e.length>n;n++){var o=t.toLowerCase(),i=e[n].name.toLowerCase();if(o==i){a=e[n];break}}a&&r.val(w.valueFormat(a,t)),w.current=a,r.data("kladr-options",w),v("check",w.current)}))}}function g(e){for(var t,r,a="1234567890qazwsxedcrfvtgbyhnujmik,ol.p;[']- QAZWSXEDCRFVTGBYHNUJMIK<OL>P:{\"} ",n="1234567890йфяцычувскамепинртгоьшлбщдюзжхэъ- ЙФЯЦЫЧУВСКАМЕПИНРТГОЬШЛБЩДЮЗЖХЭЪ ",o="",i=0;e.length>i;i++)t=e[i],r=a.indexOf(t),o+=r>-1?n[r]:t;return o}function v(e,t){e&&(r.trigger("kladr_"+e,t),w[e]&&w[e].call(r.get(0),t))}function y(){if(!_){var e=-.2;_=setInterval(function(){return P.is(":visible")?(P.css("background-position","0% "+e+"%"),e+=5.555556,e>95&&(e=-.2),t):(clearInterval(_),_=null,t)},30)}}function b(){w.showSpinner&&(P.show(),y())}function D(){P.hide()}var M=null,P=null,w=null,T={token:null,key:null,type:null,parentType:null,parentId:null,limit:10,withParents:!1,verify:!1,showSpinner:!0,arrowSelect:!0,current:null,open:null,close:null,send:null,received:null,select:null,check:null,source:function(t,r){var a={token:w.token,key:w.token,type:w.type,name:t,parentType:w.parentType,parentId:w.parentId,withParents:w.withParents,limit:w.limit};e.kladr.api(a,r)},labelFormat:function(e,t){var r="",a=e.name.toLowerCase();t=t.toLowerCase();var n=a.indexOf(t);return n=n>0?n:0,e.typeShort&&(r+=e.typeShort+". "),t.length<e.name.length?(r+=e.name.substr(0,n),r+="<strong>"+e.name.substr(n,t.length)+"</strong>",r+=e.name.substr(n+t.length,e.name.length-t.length-n)):r+="<strong>"+e.name+"</strong>",r},valueFormat:function(e){return e.name}},S={up:38,down:40,esc:27,enter:13},_=null;return o(a,n,function(){var t=!1;i(),l(),r.keyup(u),r.keydown(f),r.change(function(){t||m()}),r.blur(function(){t||d()}),M.on("click","li, a",h),M.on("mouseenter","li",function(){var r=e(this);M.find("li.active").removeClass("active"),r.addClass("active");var a=r.find("a").data("kladr-object");v("preselect",a),t=!0}),M.on("mouseleave","li",function(){e(this).removeClass("active"),t=!1}),e(window).resize(l)})}var o=t;return this.each(function(){var i=n(e(this),r,a);o==t&&(o=i)}),o}}(jQuery);