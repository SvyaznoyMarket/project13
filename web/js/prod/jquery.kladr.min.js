(function(e){e.kladr={},e.kladr.url="http://kladr-api.ru/api.php",e.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"},e.kladr.api=function(t,r){var n={};t.token&&(n.token=t.token),t.key&&(n.key=t.key),t.type&&(n.contentType=t.type),t.name&&(n.query=t.name),t.parentType&&t.parentId&&(n[t.parentType+"Id"]=t.parentId),t.withParents&&(n.withParent=1),n.limit=t.limit?t.limit:2e3;var a=!1;e.getJSON(e.kladr.url+"?callback=?",n,function(e){a||(a=!0,r&&r(e.result))}),setTimeout(function(){a||(a=!0,console.error("Request error"),r&&r([]))},5e3)},e.kladr.check=function(t,r){t.withParents=!1,t.limit=1,e.kladr.api(t,function(e){e&&e.length?r&&r(e[0]):r&&r(!1)})}})(jQuery),function(e,t){e.fn.kladr=function(r,n){function a(r,n,a){function o(n,a,o){if(x=r.data("kladr-options"),a!==t)return x[n]=a,r.data("kladr-options",x),r;if("string"===e.type(n))return x?x[n]:null;if(x)return r;if(x=H,"object"===e.type(n))for(var s in n)x[s]=n[s];return r.data("kladr-options",x),o&&o(),r}function s(){var t=e(document.getElementById("kladr_autocomplete")),n=r.attr("name");t.length||(t=e('<div id="kladr_autocomplete"></div>').appendTo("body")),r.attr("autocomplete","off"),S=e('<ul class="kladr_autocomplete_'+n+'" style="display: none;"></ul>'),S.appendTo(t),T=e('<div class="spinner kladr_autocomplete_'+n+'_spinner" class="spinner" style="display: none;"></div>'),T.appendTo(t)}function i(t,r){S.empty();for(var n in t){var a=t[n],o=x.valueFormat(a,r),s=x.labelFormat(a,r),i=e('<a data-val="'+o+'">'+s+"</a>");i.data("kladr-object",a);var l=e("<li></li>").append(i);l.appendTo(S)}}function l(){var e=r.offset(),t=r.outerWidth(),n=r.outerHeight();S.css({top:e.top+n+"px",left:e.left});var a=S.outerWidth()-S.width();S.width(t-a);var o=T.width(),s=T.height();T.css({top:e.top+(n-s)/2-1,left:e.left+t-o-2})}function u(n){if(!(n.which>8&&46>n.which)&&d()){var a=m(r.val());if(!e.trim(a))return c(),t;_(),y("send"),x.source(a,function(n){return b(),y("received"),r.is(":focus")?e.trim(r.val())&&n.length?(i(n,a),l(),S.slideDown(50),y("open"),t):(c(),t):(c(),t)})}}function c(){p(),S.hide(),y("close")}function d(){switch(x.type){case e.kladr.type.region:case e.kladr.type.district:case e.kladr.type.city:if(x.parentType&&!x.parentId)return console.error("parentType is defined and parentId in not"),!1;break;case e.kladr.type.street:if(x.parentType!=e.kladr.type.city)return console.error('For street parentType must equal "city"'),!1;if(!x.parentId)return console.error("For street parentId must defined"),!1;break;case e.kladr.type.building:if(x.parentType!=e.kladr.type.street)return console.error('For building parentType must equal "street"'),!1;if(!x.parentId)return console.error("For building parentId must defined"),!1;break;default:return console.error('type must defined and equal "region", "district", "city", "street" or "building"'),!1}return 1>x.limit?(console.error("limit must greater than 0"),!1):!0}function p(){var e=S.find(".active a");e.length&&(r.val(e.attr("data-val")),x.current=e.data("kladr-object"),r.data("kladr-options",x),y("select",x.current))}function h(e){var t=S.find("li.active");switch(e.which){case E.up:t.length?(t.removeClass("active"),t=t.prev()):t=S.find("li").last(),t.addClass("active");var r=t.find("a").data("kladr-object");y("preselect",r),x.arrowSelect&&p();break;case E.down:t.length?(t.removeClass("active"),t=t.next()):t=S.find("li").first(),t.addClass("active");var r=t.find("a").data("kladr-object");y("preselect",r),x.arrowSelect&&p();break;case E.esc:t.removeClass("active"),c();break;case E.enter:return x.arrowSelect||p(),t.removeClass("active"),c(),!1}}function f(){var t=e(this);return t.is("li")&&(t=t.find("a")),c(),r.focus(),!1}function g(){if(x.verify&&d()){var t=m(r.val());e.trim(t)&&(_(),y("send"),x.source(t,function(e){b(),y("received");for(var n=null,a=0;e.length>a;a++){var o=t.toLowerCase(),s=e[a].name.toLowerCase();if(o==s){n=e[a];break}}n&&r.val(x.valueFormat(n,t)),x.current=n,r.data("kladr-options",x),y("check",x.current)}))}}function m(e){for(var t,r,n="1234567890qazwsxedcrfvtgbyhnujmik,ol.p;[']- QAZWSXEDCRFVTGBYHNUJMIK<OL>P:{\"} ",a="1234567890йфяцычувскамепинртгоьшлбщдюзжхэъ- ЙФЯЦЫЧУВСКАМЕПИНРТГОЬШЛБЩДЮЗЖХЭЪ ",o="",s=0;e.length>s;s++)t=e[s],r=n.indexOf(t),o+=r>-1?a[r]:t;return o}function y(e,t){e&&(r.trigger("kladr_"+e,t),x[e]&&x[e].call(r.get(0),t))}function v(){if(!q){var e=-.2;q=setInterval(function(){return T.is(":visible")?(T.css("background-position","0% "+e+"%"),e+=5.555556,e>95&&(e=-.2),t):(clearInterval(q),q=null,t)},30)}}function _(){x.showSpinner&&(T.show(),v())}function b(){T.hide()}var S=null,T=null,x=null,H={token:null,key:null,type:null,parentType:null,parentId:null,limit:10,withParents:!1,verify:!1,showSpinner:!0,arrowSelect:!0,current:null,open:null,close:null,send:null,received:null,select:null,check:null,source:function(t,r){var n={token:x.token,key:x.token,type:x.type,name:t,parentType:x.parentType,parentId:x.parentId,withParents:x.withParents,limit:x.limit};e.kladr.api(n,r)},labelFormat:function(e,t){var r="",n=e.name.toLowerCase();t=t.toLowerCase();var a=n.indexOf(t);return a=a>0?a:0,e.typeShort&&(r+=e.typeShort+". "),t.length<e.name.length?(r+=e.name.substr(0,a),r+="<strong>"+e.name.substr(a,t.length)+"</strong>",r+=e.name.substr(a+t.length,e.name.length-t.length-a)):r+="<strong>"+e.name+"</strong>",r},valueFormat:function(e){return e.name}},E={up:38,down:40,esc:27,enter:13},q=null;return o(n,a,function(){var t=!1;s(),l(),r.keyup(u),r.keydown(h),r.change(function(){t||g()}),r.blur(function(){t||c()}),S.on("click","li, a",f),S.on("mouseenter","li",function(){var r=e(this);S.find("li.active").removeClass("active"),r.addClass("active");var n=r.find("a").data("kladr-object");y("preselect",n),t=!0}),S.on("mouseleave","li",function(){e(this).removeClass("active"),t=!1}),e(window).resize(l)})}var o=t;return this.each(function(){var s=a(e(this),r,n);o==t&&(o=s)}),o}}(jQuery);