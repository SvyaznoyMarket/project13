(function(e){e.kladr={},e.kladr.url="http://kladr-api.ru/api.php",e.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"},e.kladr.api=function(t,a){var r={};t.token&&(r.token=t.token),t.key&&(r.key=t.key),t.type&&(r.contentType=t.type),t.name&&(r.query=t.name),t.parentType&&t.parentId&&(r[t.parentType+"Id"]=t.parentId),t.withParents&&(r.withParent=1),r.limit=t.limit?t.limit:2e3;var n=!1;e.getJSON(e.kladr.url+"?callback=?",r,function(e){n||(n=!0,a&&a(e.result))}),setTimeout(function(){n||(n=!0,console.error("Request error"),a&&a([]))},5e3)},e.kladr.check=function(t,a){t.withParents=!1,t.limit=1,e.kladr.api(t,function(e){e&&e.length?a&&a(e[0]):a&&a(!1)})}})(jQuery),function(e,t){e.fn.kladr=function(a,r){function n(a,r,n){function o(r,n,o){if(w=a.data("kladr-options"),n!==t)return w[r]=n,a.data("kladr-options",w),a;if("string"===e.type(r))return w?w[r]:null;if(w)return a;if(w=_,"object"===e.type(r))for(var i in r)w[i]=r[i];return a.data("kladr-options",w),o&&o(),a}function i(){var t=e(document.getElementById("kladr_autocomplete")),r=a.attr("name");t.length||(t=e('<div id="kladr_autocomplete"></div>').appendTo("body")),a.attr("autocomplete","off"),M=e('<ul class="kladr_autocomplete_'+r+'" style="display: none;"></ul>'),M.appendTo(t),P=e('<div class="spinner kladr_autocomplete_'+r+'_spinner" class="spinner" style="display: none;"></div>'),P.appendTo(t)}function s(t,a){M.empty();for(var r in t){var n=t[r],o=w.valueFormat(n,a),i=w.labelFormat(n,a),s=e('<a data-val="'+o+'">'+i+"</a>");s.data("kladr-object",n);var l=e("<li></li>").append(s);l.appendTo(M)}}function l(){var e=a.offset(),t=a.outerWidth(),r=a.outerHeight();M.css({top:e.top+r+"px",left:e.left});var n=M.outerWidth()-M.width();M.width(t-n);var o=P.width(),i=P.height();P.css({top:e.top+(r-i)/2-1,left:e.left+t-o-2})}function u(r){if(!(r.which>8&&46>r.which)&&c()){var n=v(a.val());if(!e.trim(n))return d(),t;b(),g("send"),w.source(n,function(r){return D(),g("received"),a.is(":focus")?e.trim(a.val())&&r.length?(s(r,n),l(),M.slideDown(50),g("open"),t):(d(),t):(d(),t)})}}function d(){p(),M.hide(),g("close")}function c(){switch(w.type){case e.kladr.type.region:case e.kladr.type.district:case e.kladr.type.city:if(w.parentType&&!w.parentId)return console.error("parentType is defined and parentId in not"),!1;break;case e.kladr.type.street:if(w.parentType!=e.kladr.type.city)return console.error('For street parentType must equal "city"'),!1;if(!w.parentId)return console.error("For street parentId must defined"),!1;break;case e.kladr.type.building:if(w.parentType!=e.kladr.type.street)return console.error('For building parentType must equal "street"'),!1;if(!w.parentId)return console.error("For building parentId must defined"),!1;break;default:return console.error('type must defined and equal "region", "district", "city", "street" or "building"'),!1}return 1>w.limit?(console.error("limit must greater than 0"),!1):!0}function p(){var e=M.find(".active a");e.length&&(a.val(e.attr("data-val")),w.current=e.data("kladr-object"),a.data("kladr-options",w),g("select",w.current))}function f(e){var t=M.find("li.active");switch(e.which){case T.up:t.length?(t.removeClass("active"),t=t.prev()):t=M.find("li").last(),t.addClass("active");var a=t.find("a").data("kladr-object");g("preselect",a),w.arrowSelect&&p();break;case T.down:t.length?(t.removeClass("active"),t=t.next()):t=M.find("li").first(),t.addClass("active");var a=t.find("a").data("kladr-object");g("preselect",a),w.arrowSelect&&p();break;case T.esc:t.removeClass("active"),d();break;case T.enter:return w.arrowSelect||p(),t.removeClass("active"),d(),!1}}function h(){var t=e(this);return t.is("li")&&(t=t.find("a")),d(),a.focus(),!1}function m(){if(w.verify&&c()){var t=v(a.val());e.trim(t)&&(b(),g("send"),w.source(t,function(e){D(),g("received");for(var r=null,n=0;e.length>n;n++){var o=t.toLowerCase(),i=e[n].name.toLowerCase();if(o==i){r=e[n];break}}r&&a.val(w.valueFormat(r,t)),w.current=r,a.data("kladr-options",w),g("check",w.current)}))}}function v(e){for(var t,a,r="1234567890qazwsxedcrfvtgbyhnujmik,ol.p;[']- QAZWSXEDCRFVTGBYHNUJMIK<OL>P:{\"} ",n="1234567890йфяцычувскамепинртгоьшлбщдюзжхэъ- ЙФЯЦЫЧУВСКАМЕПИНРТГОЬШЛБЩДЮЗЖХЭЪ ",o="",i=0;e.length>i;i++)t=e[i],a=r.indexOf(t),o+=a>-1?n[a]:t;return o}function g(e,t){e&&(a.trigger("kladr_"+e,t),w[e]&&w[e].call(a.get(0),t))}function y(){if(!S){var e=-.2;S=setInterval(function(){return P.is(":visible")?(P.css("background-position","0% "+e+"%"),e+=5.555556,e>95&&(e=-.2),t):(clearInterval(S),S=null,t)},30)}}function b(){w.showSpinner&&(P.show(),y())}function D(){P.hide()}var M=null,P=null,w=null,_={token:null,key:null,type:null,parentType:null,parentId:null,limit:10,withParents:!1,verify:!1,showSpinner:!0,arrowSelect:!0,current:null,open:null,close:null,send:null,received:null,select:null,check:null,source:function(t,a){var r={token:w.token,key:w.token,type:w.type,name:t,parentType:w.parentType,parentId:w.parentId,withParents:w.withParents,limit:w.limit};e.kladr.api(r,a)},labelFormat:function(e,t){var a="",r=e.name.toLowerCase();t=t.toLowerCase();var n=r.indexOf(t);return n=n>0?n:0,e.typeShort&&(a+=e.typeShort+". "),t.length<e.name.length?(a+=e.name.substr(0,n),a+="<strong>"+e.name.substr(n,t.length)+"</strong>",a+=e.name.substr(n+t.length,e.name.length-t.length-n)):a+="<strong>"+e.name+"</strong>",a},valueFormat:function(e){return e.name}},T={up:38,down:40,esc:27,enter:13},S=null;return o(r,n,function(){var t=!1;i(),l(),a.keyup(u),a.keydown(f),a.change(function(){t||m()}),a.blur(function(){t||d()}),M.on("click","li, a",h),M.on("mouseenter","li",function(){var a=e(this);M.find("li.active").removeClass("active"),a.addClass("active");var r=a.find("a").data("kladr-object");g("preselect",r),t=!0}),M.on("mouseleave","li",function(){e(this).removeClass("active"),t=!1}),e(window).resize(l)})}var o=t;return this.each(function(){var i=n(e(this),a,r);o==t&&(o=i)}),o}}(jQuery);