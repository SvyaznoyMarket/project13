(function(e,o,r,t){var n,l,i=t.utils,a=r("#page-config").data("value"),d=r("#jsOrderForm").data("value"),s=r("#metrostations").data("name"),c=r("#jsDeliveryAddress").data("value"),u=a?a.addressAutocomplete:!1,p=null,y=null,h=6,f=r("#order_address_street"),v=r("#order_address_building"),g=r("#order_address_number"),m=r("#order_address_metro"),k=r("#order_subway_id"),b=null,O=!1,D=c?c.regionName:"",P=r("#map"),S=null,_=function(){var e,o,t,n,l=12,i="";return e=r.trim(D),o="город",e&&(i&&(i+=", "),i+=o+" "+e,l=12),e=null,o=null,t=f.kladr("current"),n=r.trim(f.val()),t?(e=t.name,o=t.type):n&&(e=n,o=""),e&&(i&&(i+=", "),i+=o+" "+e,l=14),e=null,o=null,t=v.kladr("current"),n=r.trim(v.val()),t?(e=t.name,o="дом"):n&&(e=n,o="дом"),e&&(i&&(i+=", "),i+=o+" "+e,l=16),e=null,o=null,n=r.trim(g.val()),n&&(e=n,o="корпус"),e&&(i&&(i+=", "),i+=o+" "+e,l=16),{address:i,zoom:l}},M=function(){var e,o,r,t,n=_();n.address&&O&&S!==n.address&&(console.log(n.address),S=n.address,e=ymaps.geocode(n.address),e.then(function(e){o=e.geoObjects.get(0).geometry.getCoordinates(),o&&(r=o[0],t=o[1],b.points=[],b.mapWS.geoObjects.each(function(e){b.mapWS.geoObjects.remove(e)}),b.points.push({latitude:r,longitude:t}),b._showMarkers(),b.mapWS.setCenter(o,n.zoom),m.length&&C(r,t))}))},C=function(e,o){var r,t,n;k.length&&(r=ymaps.geocode([e,o],{kind:"metro"}),r.then(function(e){if(t=e.geoObjects.get(0),n=t.properties.get("name"),n=n.replace("метро ",""),m.val(n),k.val(""),i.orderValidator&&i.orderValidator._unmarkFieldError(m),void 0!==s)for(var o=s.length-1;o>=0;o--)if(n===s[o].label){k.val(s[o].val);break}},function(e){console.warn("При выполнении запроса произошла ошибка: "+e),m.val(""),k.val(""),i.orderValidator&&i.orderValidator._markFieldError(m,"Не выбрана станция метро")}))},B=function(e){return n=r("ul.error_list"),n.length?n.html("<li>"+e+"</li>"):r("#map").before(r('<ul class="error_list" />').append("<li>"+e+"</li>")),!1},I=function(){return n=r("ul.error_list"),n.length&&n.html(""),!1},T=function(e){""===r.trim(e)&&r.kladr.api({token:v.kladr("token"),key:v.kladr("key"),type:v.kladr("type"),name:e,parentType:v.kladr("parentType"),parentId:v.kladr("parentId"),limit:1},function(e){e.length&&(I(),v.kladr("current",e[0]))})};defaultValues=function(){""!=r.trim(d["order[address_street]"])&&r.kladr.api({token:p,key:y,type:r.kladr.type.street,name:d["order[address_street]"],parentType:r.kladr.type.city,parentId:l,limit:1},function(e){e.length&&(I(),f.kladr("current",e[0]),v.kladr("parentType",r.kladr.type.street),v.kladr("parentId",e[0].id),T(d["order[address_building]"]))})},fieldsHandler={city:function(){return D?(r.kladr.api({token:p,key:y,type:r.kladr.type.city,name:D,limit:1},function(e){return e.length?(l=e[0].id,fieldsHandler.street(),fieldsHandler.building(),fieldsHandler.buildingAdd(),f.kladr("parentType",r.kladr.type.city),f.kladr("parentId",l),defaultValues(),void 0):(console.log("КЛАДР не нашел город "+D),void 0)}),void 0):null},street:function(){f.kladr({token:p,key:y,type:r.kladr.type.street,verify:!0,limit:h,source:function(e){r.kladr.api({token:f.kladr("token"),key:f.kladr("key"),type:f.kladr("type"),name:e,parentType:f.kladr("parentType"),parentId:f.kladr("parentId"),limit:f.kladr("limit")},function(e){var o,t,n=[];if(e.length&&(I(),f.kladr("current",e[0]),v.kladr("parentType",r.kladr.type.street),e[0].id!==v.kladr("parentId")&&(v.kladr("parentId",e[0].id),T(v.val())),M(),1!==e.length)){for(o in e)t=e[o],t.label=t.type+" "+t.name,t.value=t.name,n.push(t);f.autocomplete({source:n,appendTo:".jsInputStreet",minLength:2,select:function(e,o){I(),f.kladr("current",o.item),v.kladr("parentType",r.kladr.type.street),o.item.id!==v.kladr("parentId")&&(v.kladr("parentId",o.item.id),T(v.val())),M()}})}})}})},building:function(){v.kladr({token:p,key:y,type:r.kladr.type.building,verify:!0,limit:h,source:function(e){r.kladr.api({token:v.kladr("token"),key:v.kladr("key"),type:v.kladr("type"),name:e,parentType:v.kladr("parentType"),parentId:v.kladr("parentId"),limit:v.kladr("limit")},function(e){var o,r,t=[];if(e.length&&(I(),v.kladr("current",e[0]),M(),1!==e.length)){for(o in e)r=e[o],r.label=r.name,t.push(r);v.autocomplete({source:t,appendTo:".jsInputBuilding",minLength:0,select:function(e,o){I(),v.kladr("current",o.item),M()}})}})}})},buildingAdd:function(){g.change(function(){M()})}},fieldsInit=function(){fieldsHandler.city()},mapCreate=function(){var e,o,n=_();!O&&P.length&&(S=n.address,P.show().width(477).height(350),O=!0,e=ymaps.geocode(n.address),e.then(function(e){o=e.geoObjects.get(0).geometry.getCoordinates(),b=new t.constructors.CreateMap("map",[{latitude:o[0],longitude:o[1]}]),b.points=[],b.mapWS.geoObjects.each(function(e){b.mapWS.geoObjects.remove(e)}),""!==r.trim(d["order[address_street]"])&&b.points.push({latitude:o[0],longitude:o[1]}),b._showMarkers(),b.mapWS.setCenter(o,n.zoom)},function(e){console.log(e),B("Не нашли ваш город на карте."),b=new t.constructors.CreateMap("map",[{latitude:55.76,longitude:37.64}])}))},u&&(c&&c.kladr&&(p=c.kladr.token?c.kladr.token:null,y=c.kladr.key?c.kladr.key:null,h=c.kladr.itemLimit?c.kladr.itemLimit:6),fieldsInit(),r("body").bind("orderdeliverychange",function(){ymaps.ready(mapCreate)}))})(this,this.document,this.jQuery,this.ENTER),function(e,o,r,t,n){var l,i=t.constructors,a=(t.utils,t.config.pageConfig),d=a.prepayment;console.info("deliveryBox.js init"),console.log(t.OrderModel),i.DeliveryBox=function(){"use strict";function o(e,i,a){if(!(this instanceof o))return new o(e,i,a);console.info("Cоздание блока доставки "+i+" для "+a),console.log(this),l=t.OrderModel;var d=this;return d.isUnique=l.orderDictionary.isUniqueDeliveryState(i),d.token=i+"_"+a,d.products=[],d.fullPrice=0,d.totalBlockSum=0,d.state=i,d.deliveryName=l.orderDictionary.getNameOfState(i),d.deliveryPrice=Number.NEGATIVE_INFINITY,d.choosenDate=n.observable(),d.choosenNameOfWeek=n.observable(),d.choosenPoint=n.observable({id:a}),d.choosenInterval=n.observable(),d.showPopupWithPoints=n.observable(!1),d.hasPointDelivery=l.orderDictionary.hasPointDelivery(i),d.isExpensiveOrder=!1,d.hasProductWithPrepayment=!1,d.allDatesForBlock=n.observableArray([]),d.pointList=[],d.changePointButtonText=l.orderDictionary.getChangeButtonText(i),d.hasPointDelivery&&!l.orderDictionary.getPointByStateAndId(d.state,a)?(console.info("есть точки доставки для выбранного метода доставки, но выбранная точка не доступна для этого метода доставки. Берем первую точку для выбранного метода доставки"),d.choosenPoint(l.orderDictionary.getFirstPointByState(d.state))):d.hasPointDelivery?(console.info("есть точки доставки для выбранного метода доставки, и выбранная точка доступна для этого метода доставки"),d.choosenPoint(l.orderDictionary.getPointByStateAndId(d.state,a))):(console.info("для выбранного метода доставки не нужна точка доставки"),l.hasHomeDelivery(!0),r("body").trigger("orderdeliverychange",[!0])),d.calendarSliderLeft=n.observable(0),d.addProductGroup(e),0===d.products.length?(console.warn("в блоке "+d.token+" не осталось товаров"),void 0):(l.deliveryBoxes.push(d),void 0)}return o.prototype._makePointList=function(){console.info("Создание списка точек доставки");var e,o,r,t=this,n=!0,i=null;for(e in t.products[0].deliveries[t.state]){for(o=t.products.length-1;o>=0&&(n=t.products[o].deliveries[t.state].hasOwnProperty(e),n);o--);if(n)i=l.orderDictionary.getPointByStateAndId(t.state,e),t.isUniquePointIdInPointList(e,t.pointList)&&(console.warn("Add point "+e+" to pointList"),t.pointList.push(i));else for(r in t.pointList)void 0!==t.pointList[r].id&&e===t.pointList[r].id&&(console.warn("Delete point "+e+" from pointList"),t.pointList.splice(r))}console.log("Точки доставки созданы"),console.log(t.pointList)},o.prototype.isUniquePointIdInPointList=function(e,o){var r,t=!0;if(void 0===e||void 0===o)return t;for(r in o)if(o[r].id==e)return!1;return!0},o.prototype.addUniqueSuffix=function(e){var o;return e=e||"",o=Math.floor(1e4*Math.random()+1),e+="_"+o},o.prototype.selectPoint=function(o){var r,n=this,i=n.state+"_"+o.id,a=null,d=[];if(l.hasDeliveryBox(i)){for(r=n.products.length-1;r>=0;r--)n.products[r].id&&d.push(n.products[r].id);n._hasProductsAlreadyAdded(d)||(a=l.getDeliveryBoxByToken(i),a.addProductGroup(n.products),l.removeDeliveryBox(n.token))}else n.isUnique&&(i+=n.addUniqueSuffix()),console.info("удаляем старый блок"),console.log("старый токен "+n.token),console.log("новый токен "+i),n.token=i,n.choosenPoint(l.orderDictionary.getPointByStateAndId(n.state,o.id)),t.OrderModel.choosenPoint(o.id),console.log(l.deliveryBoxes()),l.paypalECS()&&(console.info("PayPal ECS включен. Необходимо сохранить выбранную точку доставки в cookie"),e.docCookies.setItem("chPoint_paypalECS",o.id,600));return l.showPopupWithPoints(!1),!1},o.prototype.changePoint=function(){var e,o=this;for(e=o.pointList.length-1;e>=0;e--)o.pointList[e].parentBoxToken=o.token;return l.popupWithPoints({header:"Выберите точку доставки",points:o.pointList}),l.showPopupWithPoints(!0),!1},o.prototype._getFirstPropertyName=function(e){for(var o in e)return o},o.prototype._addProduct=function(e){var r,n,i=this,a=null,s=null,c=null,u=[],p=null,y={};if(!i._hasProductsAlreadyAdded([e.id])){if(!e.deliveries[i.state].hasOwnProperty(i.choosenPoint().id))return console.warn("Для товара "+e.id+" нет пункта доставки "+i.choosenPoint().id+" Необходимо создать новый блок"),c=i._getFirstPropertyName(e.deliveries[i.state]),s=i.state+"_"+c,u.push(e),l.hasDeliveryBox(s)?(console.log("Блок для этого типа доставки в этот пункт уже существует. Добавляем продукт в блок",s),p=l.getDeliveryBoxByToken(s),n=l.removeDeliveryBox(s),r=l.totalSum()-n.fullPrice-p.deliveryPrice,l.totalSum(r),p.addProductGroup(u),l.deliveryBoxes.push(p)):(console.log("Блока для этого типа доставки в этот пункт еще не существует"),new o(u,i.state,c)),void 0;a=parseInt(e.deliveries[i.state][i.choosenPoint().id].price,10),i.deliveryPrice=a>i.deliveryPrice?a:i.deliveryPrice,y={id:e.id,name:e.name,price:e.sum?e.sum:e.price,quantity:e.quantity,deleteUrl:e.deleteUrl,setUrl:e.setUrl,productUrl:e.url,productImg:e.image?e.image:e.productImg,deliveries:{},isPrepayment:e.isPrepayment},i.isUnique&&e.oldQuantity-1>0&&(console.log("Переделываем deleteUrl:"),console.log(y.deleteUrl),y.deleteUrl=y.deleteUrl.replace("delete-","add-"),y.deleteUrl+="?quantity="+(e.oldQuantity-1),console.log(y.deleteUrl)),y.isPrepayment&&(i.hasProductWithPrepayment=!0),y.deliveries[i.state]=e.deliveries[i.state],i.fullPrice=t.utils.numMethods.sumDecimal(y.price,i.fullPrice),i.products.push(y),d.enabled&&(i.isExpensiveOrder=d.priceLimit<=parseInt(i.fullPrice,10)+parseInt(i.deliveryPrice,10)?!0:!1)}},o.prototype._hasProductsAlreadyAdded=function(e){var o,t=this,n=!1;if(void 0===e||!e.length)return n;for(o=t.products.length-1;o>=0;o--)-1!==r.inArray(t.products[o].id,e)&&(n=!0);return n},o.prototype.updateTotalPrice=function(){console.info("Перерасчет общей стоимости заказа");var e=this,o=l.totalSum();e.totalBlockSum=t.utils.numMethods.sumDecimal(e.fullPrice,e.deliveryPrice),o=t.utils.numMethods.sumDecimal(e.totalBlockSum,o),l.totalSum(o),console.log(l.totalSum())},o.prototype.addProductGroup=function(e){var o,r=this;for(console.info("добавляем товары в блок"),o=e.length-1;o>=0;o--)console.log(o+"ый пошел..."),console.log(e[o]),r._addProduct(e[o]);return r.products.length?(r.calculateDate(),r.updateTotalPrice(),r.hasPointDelivery&&(console.info("У товара есть точки доставки. Создаем список точек доставки"),r._makePointList()),void 0):(console.warn("в блоке "+r.token+" нет товаров"),void 0)},o.prototype._getNameDayOfWeek=function(e){var o=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"];return o[e]},o.prototype._getFullNameDayOfWeek=function(e){var o=["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"];return o[e]},o.prototype._hasDateInAllProducts=function(e){var o,r,t,n=this,l=null,i=null,a=!0;for(r=n.products.length-1;r>=0;r--){for(l=n.products[r].deliveries[n.state][n.choosenPoint().id].dates,t=0,o=l.length;o>t;t++){if(i=l[t].value,i===e){a=!0;break}a=!1}if(!a)break}return a},o.prototype.clickCalendarDay=function(o){var r=this;return o.avalible?(l.paypalECS()&&(console.info("PayPal ECS включен. Необходимо сохранить выбранную дату в cookie"),e.docCookies.setItem("chDate_paypalECS",JSON.stringify(o),600)),r.choosenNameOfWeek(r._getFullNameDayOfWeek(o.dayOfWeek)),r.choosenDate(o),void 0):!1},o.prototype.calculateDate=function(){console.info("Вычисление общей даты для продуктов в блоке");var r,t,n=this,i=l.orderDictionary.getToday(),a=null,d=null,s="",c=null,u=[],p=null,y=null;for(console.log("Сегодняшняя дата с сервера "+i),a=n.products[0].deliveries[n.state][n.choosenPoint().id].dates,t=0,r=a.length;r>t;t++)d=a[t].value,n._hasDateInAllProducts(d)&&d>=i&&(a[t].avalible=!0,a[t].humanDayOfWeek=n._getNameDayOfWeek(a[t].dayOfWeek),n.allDatesForBlock().push(a[t]));return n.allDatesForBlock().length||(console.warn("нет общих дат для блока. Необходимо разделить продукты в блоке"),c=n.products.pop(),u.push(c),s=n.state+"_"+n.choosenPoint().id+"_"+n.addUniqueSuffix(),console.log("новый токен "+s),console.log(n),new o(u,n.state,n.choosenPoint().id),n.calculateDate()),l.paypalECS()&&e.docCookies.hasItem("chDate_paypalECS")?(console.info("PayPal ECS включен. Необходимо взять выбранную дату из cookie"),p=e.docCookies.getItem("chDate_paypalECS"),y=JSON.parse(p)):y=n.allDatesForBlock()[0],console.log("Выбранная дата (chooseDate) ",y),!0!==y.avalible?(console.warn("Блок недоступен. Вычисление общей даты для продуктов в блоке невозможно. Выходим."),!1):(n.choosenDate(y),void 0===typeof n.choosenDate().intervals?(console.warn("В блоке нет интервалов. Вычисление даты невозможно. Выходим."),!1):(n.choosenNameOfWeek(n._getFullNameDayOfWeek(n.choosenDate().dayOfWeek)),0!==n.choosenDate().intervals.length&&n.choosenInterval(n.choosenDate().intervals[0]),n.makeCalendar(),void 0))},o.prototype.makeCalendar=function(){console.info("Создание календаря, округление до целых недель");var e,o,r,t=this,n=0,l={},i=null,a=null,d=864e5;for(r=0;t.allDatesForBlock().length-1>=r;r++){if(void 0===t.allDatesForBlock()[r+1]){console.info("Следущая дата последняя. заканчиваем цикл");break}if(r>99)break;l={},i=t.allDatesForBlock()[r].value+d,a=new Date(i),i!==t.allDatesForBlock()[r+1].value&&(l={value:i,avalible:!1,humanDayOfWeek:t._getNameDayOfWeek(a.getDay()),dayOfWeek:a.getDay(),day:a.getDate()},console.log("предыдущая дата была "+new Date(t.allDatesForBlock()[r].value).getDate()+" новая дата вклинилась "+a.getDate()+" следущая дата "+new Date(t.allDatesForBlock()[r+1].value).getDate()),t.allDatesForBlock.splice(r+1,0,l))}if(1!==t.allDatesForBlock()[0].dayOfWeek)for(n=0===t.allDatesForBlock()[0].dayOfWeek?6:t.allDatesForBlock()[0].dayOfWeek-1,i=t.allDatesForBlock()[0].value,e=n;e>0;e--)i-=d,a=new Date(i),l={avalible:!1,humanDayOfWeek:t._getNameDayOfWeek(a.getDay()),dayOfWeek:a.getDay(),day:a.getDate()},t.allDatesForBlock.unshift(l);if(0!==t.allDatesForBlock()[t.allDatesForBlock().length-1].dayOfWeek)for(n=7-t.allDatesForBlock()[t.allDatesForBlock().length-1].dayOfWeek,i=t.allDatesForBlock()[t.allDatesForBlock().length-1].value,o=n;o>0;o--)i+=d,a=new Date(i),l={avalible:!1,humanDayOfWeek:t._getNameDayOfWeek(a.getDay()),dayOfWeek:a.getDay(),day:a.getDate()},t.allDatesForBlock.push(l)},o.prototype.calendarLeftBtn=function(){var e=this,o=parseInt(e.calendarSliderLeft(),10);o+=380,e.calendarSliderLeft(o)},o.prototype.calendarRightBtn=function(){var e=this,o=parseInt(e.calendarSliderLeft(),10);o-=380,e.calendarSliderLeft(o)},o}()}(this,this.document,this.jQuery,this.ENTER,this.ko),function(e){console.info("orderCredit.js init...");var o=$("div.bBankWrap"),r=function r(){var r=$("#selectedBank"),t=function t(){var e=$("input:checked",o),t=e.val();console.log("selectBank with ID",t),"undefined"!==t&&($(".bSelectInput",o).addClass("bUnchecked"),e.closest(".bSelectInput",o).removeClass("bUnchecked"),r.val(t))};o.change(t),"function"==typeof e.DirectCredit.init&&e.DirectCredit.init($("#jsCreditBank").data("value"),$(".credit_pay"))};o.length&&r()}(this),function(e,o,r,t){console.info("orderDictionary.js init...");var n=t.constructors;n.OrderDictionary=function(){"use strict";function o(e){return this instanceof o?(this.orderData=e,this.serverTime=this.orderData.time,this.deliveryTypes=this.orderData.deliveryTypes,this.deliveryStates=this.orderData.deliveryStates,this.pointsByDelivery=this.orderData.pointsByDelivery,this.products=this.orderData.products,this.defPoints=this.orderData.defPoints||{},void 0):new o(e)}return o.prototype.getNameOfState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].name:(console.warn("Не найден метод доставки "+e),!1)},o.prototype.getToday=function(){return this.serverTime},o.prototype.getDefaultPointId=function(e){return this.defPoints.hasOwnProperty(e)?this.defPoints[e]:0},o.prototype.hasDeliveryState=function(e){return this.deliveryStates.hasOwnProperty(e)},o.prototype.isUniqueDeliveryState=function(e){var o;return this.hasDeliveryState(e)?(o=this.deliveryStates[e],o.unique):!1},o.prototype.hasPointDelivery=function(e){return this.hasDeliveryState(e)?this.pointsByDelivery.hasOwnProperty(e):!1},o.prototype.getPointByStateAndId=function(o,r){var t,n=this.getAllPointsByState(o);for(r+="",t=n.length-1;t>=0;t--)if(n[t].id===r)return e.ENTER.utils.cloneObject(n[t]);return!1},o.prototype.getFirstPointByState=function(e){var o=this.getAllPointsByState(e);return o[0]?t.utils.cloneObject(o[0]):!1},o.prototype.getAllPointsByState=function(e){if(!this.hasDeliveryState(e))return!1;var o,r,t=this.pointsByDelivery[e],n=t?t.token:!1,l=n?this.orderData[n]:!1,i=[];if("now"==e||"self"==e){for(o in l)for(r in l[o].products)r==e&&i.push(l[o]);l=i}return l||!1},o.prototype.getChangeButtonText=function(e){var o=this.pointsByDelivery[e]?this.pointsByDelivery[e].changeName:"Сменить";return o},o.prototype.getProductFromState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].products:(console.warn("Не найден метод доставки "+e),!1)},o.prototype.getProductById=function(e){return this.products.hasOwnProperty(e)?this.products[e]:(console.warn("Такого продукта не найдено"),!1)},o}()}(this,this.document,this.jQuery,this.ENTER),function(){if(console.info("orderSertificate init..."),!$("#paymentMethod-10").length)return console.warn("нет метода оплаты сертификатом"),!1;var e=$("#paymentMethod-10").parent(),o=e.find(".mCardNumber"),r=e.find(".mCardPin"),t=e.find(".bPayMethodAction"),n=t.attr("data-url"),l=function(){var e=!1,l="processBlock",i=function i(){return o.val().replace(/[^0-9]/g,"")},a=function a(){return r.val().replace(/[^0-9]/g,"")},d=function d(){return{code:i(),pin:a()}},s=function s(){return e&&""!==i()&&14===i().length&&""!==a()&&4===a().length?!0:!1},c=function c(){return 4!==r.val().length?(console.warn("пин код мал"),!1):o.val().length?(u("mOrange","Проверка по номеру карты"),$.post(n,d(),function(e){if(!("success"in e))return!1;if(!e.success){var o=e.error!==void 0?e.error:"ERROR";return u("mRed",o),!1}u("mGreen",e.data)}),void 0):(console.warn("номер карты не введен"),!1)},u=function u(o,r){console.info("setProcessingStatus");var n=$(".process").first(),i={typeNum:o};switch(n.hasClass("picked")||n.remove(),o){case"mOrange":i.text=r,e=!1;break;case"mRed":i.text="Произошла ошибка: "+r,e=!1;break;case"mGreen":i.text="activated"in r?"Карта "+r.code+" на сумму "+r.sum+" активирована!":"Карта "+r.code+" имеет номинал "+r.sum,e=!0}t.after(tmpl(l,i)),r.activated!==void 0&&$(".process").first().addClass("picked")};return{checkCard:c,setProcessingStatus:u,isActive:s,getCode:i,getPIN:a}}();o.bind("change",function(){l.checkCard()}),r.bind("change",function(){l.checkCard()}),$.mask.definitions.n="[0-9]",r.mask("nnnn",{completed:l.checkCard,placeholder:"*"})}(this),function(e,o,r,t){console.info("orderValidation.js init");var n=t.utils,l={},i=r("#metrostations").data("name"),a=r("#order_recipient_first_name"),d=(r("#order_recipient_last_name"),r("#order_recipient_email")),s=r("#order_recipient_phonenumbers"),c=r("#order_address_metro"),u=r("#order_subway_id"),p=r("#order_address_street"),y=r("#order_address_building"),h=r("#sclub-number"),f=(r('.jsCustomRadio[name="order[payment_method_id]"]'),r("#qiwi-phone")),v=r("#order_agreed"),g=r("#completeOrder"),m=null,k=null,b=null,O={fields:[{fieldNode:a,require:!0,customErr:"Введите имя получателя",validateOnChange:!0},{fieldNode:d,validBy:"isEmail",customErr:"Некорректно введен e-mail",validateOnChange:!0},{fieldNode:s,require:!0,customErr:"Некорректно введен телефон",validateOnChange:!0},{fieldNode:v,require:!0,customErr:"Необходимо согласие"},{fieldNode:h,customErr:"Некорректно введен номер карты Связного клуба"}]},D={source:i,appendTo:"#metrostations",minLength:2,select:function(e,o){u.val(o.item.val)}};console.log(t.OrderModel),console.log("orderValidation:: vars initd"),l=new FormValidator(O),n.orderValidator=l;var P=function P(e,o){var t='<div class="popupbox width290"><div class="font18 pb18"> '+e+"</div>"+"</div>"+'<p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>',n=r("<div>").addClass("popup").html(t);n.appendTo("body");var l=function(){return n.trigger("close"),n.remove(),void 0!==o&&o(),!1};n.lightbox_me({centered:!0,onClose:l}),n.find(".closePopup").bind("click",l)},S=function S(e){console.warn("Ошибка в поле");var o=r('[name="order['+e.field+']"]'),t=function t(){l._unmarkFieldError(r(this))};l._markFieldError(o,e.message),o.bind("focus",t)},_={"default":function(e){return console.log("Обработчик ошибки"),e.redirect===void 0&&(e.redirect="/cart"),e.error&&e.error.message?(P(e.error.message,function(){0!==e.redirect&&(o.location.href=e.redirect)}),void 0):(o.location.href=e.redirect,void 0)},0:function(e){console.warn("Обработка ошибок формы");var t=null;if(e.redirect)return P(e.error.message,function(){o.location.href=e.redirect}),void 0;P(e.error.message);for(var n=e.form.error.length-1;n>=0;n--)t=e.form.error[n],console.warn(t),S(t);r.scrollTo(r(".mError").eq(0),500,{offset:-15})},743:function(e){P(e.error.message)}},M=function M(){if("undefined"!=typeof _gaq){for(var o=t.OrderModel.deliveryBoxes().length-1;o>=0;o--)_gaq.push(["_trackEvent","Order card","Completed","выбрана "+t.OrderModel.choosenDeliveryTypeId+" доставят "+t.OrderModel.deliveryBoxes()[o].state]);_gaq.push(["_trackEvent","Order complete",t.OrderModel.deliveryBoxes().length,t.OrderModel.orderDictionary.products.length]),_gaq.push(["_trackTiming","Order complete","DB response",b])}e.yaCounter10503055!==void 0&&e.yaCounter10503055.reachGoal("\\orders\\complete")},C=function C(r){return console.info("данные отправлены. получен ответ от сервера"),k=(new Date).getTime(),b=k-m,console.log(r),r.success?(M(),t.OrderModel.paypalECS()&&!g.hasClass("mConfirm")&&(console.info("PayPal ECS включен. Заказ оформлен. Необходимо удалить выбранные параметры из cookie"),e.docCookies.removeItem("chDate_paypalECS","/"),e.docCookies.removeItem("chTypeBtn_paypalECS","/"),e.docCookies.removeItem("chPoint_paypalECS","/"),e.docCookies.removeItem("chTypeId_paypalECS","/"),e.docCookies.removeItem("chStetesPriority_paypalECS","/")),o.location.href=r.redirect,void 0):(console.log("ошибка оформления заказа"),n.blockScreen.unblock(),_.hasOwnProperty(r.error.code)?(console.log("Есть обработчик"),_[r.error.code](r)):(console.log("Стандартный обработчик"),_["default"](r)),!1)},B=function B(){var o,l,i,a=null,d=[],s=[],c={},u=r("#order-form");for(n.blockScreen.block("Ваш заказ оформляется"),s=u.serializeArray(),console.info("Перебираем блоки доставки"),l=t.OrderModel.deliveryBoxes().length-1;l>=0;l--){for(c={},a=t.OrderModel.deliveryBoxes()[l],o=a.choosenPoint(),console.log("currentDeliveryBox:"),console.log(a),c={deliveryMethod_token:a.state,date:a.choosenDate().value,interval:[a.choosenInterval()?a.choosenInterval().start:"",a.choosenInterval()?a.choosenInterval().end:""],point_id:o.id,products:[]},console.log("choosePoint:"),console.log(o),"pickpoint"===a.state&&(console.log("Is PickPoint!"),c.point_id=o.number,c.point_address={street:o.street,house:o.house},c.point_name=o.point_name),i=a.products.length-1;i>=0;i--)c.products.push(a.products[i].id);console.log("tmpPart:"),console.log(c),d.push(c)}s.push({name:"order[delivery_type_id]",value:t.OrderModel.choosenDeliveryTypeId}),s.push({name:"order[part]",value:JSON.stringify(d)}),e.KM!==void 0&&s.push({name:"kiss_session",value:e.KM.i}),console.log("dataToSend:"),console.log(s),m=(new Date).getTime(),r.ajax({url:u.attr("action"),timeout:12e4,type:"POST",data:s,success:C,statusCode:{500:function(){P("Не удалось создать заказ. Попробуйте позднее. 500")},504:function(){P("Не удалось создать заказ. Попробуйте позднее. 504")}}})},I=function I(){return console.info("Завершить оформление заказа"),t.OrderModel.lifeGift()?(B(),!1):(l.validate({onInvalid:function(e){console.warn("invalid"),console.log(e),r.scrollTo(e[e.length-1].fieldNode,500,{offset:-15})},onValid:B}),!1)},T=function T(){for(var e=i.length-1;e>=0;e--)if(c.val()===i[e].label)return;c.val("")},w=function w(e,o){o?(l.setValidate(p,{require:!0,customErr:"Не введено название улицы",validateOnChange:!0}),l.setValidate(y,{require:!0,customErr:"Не введен номер дома",validateOnChange:!0}),void 0!==i&&l.setValidate(c,{fieldNode:c,customErr:"Не выбрана станция метро",require:!0,validateOnChange:!0})):(l.setValidate(p,{require:!1}),l.setValidate(y,{require:!1}),void 0!==i&&l.setValidate(c,{require:!1})),console.info("Изменен тип доставки"),console.log(l)};r.mask.definitions.n="[0-9]",h.mask("2 98nnnn nnnnnn",{placeholder:"*"}),f.mask("(nnn) nnn-nn-nn"),s.mask("(nnn) nnn-nn-nn"),e.docCookies.getItem("emails")&&(console.log("AB TEST: e-mail require"),l.setValidate(d,{require:!0}));var E=function E(e){var o,t=null;console.info("defaultValueToField");for(o in e)if(console.log("поле "+o),e[o]){if(console.log("для поля есть значение "+e[o]),t=r('input[name="'+o+'"]'),"radio"===t.attr("type")){t.filter('[value="'+e[o]+'"]').attr("checked","checked").trigger("change");continue}t.val(e[o])}};if(E(r("#jsOrderForm").data("value")),void 0!==i){c.autocomplete(D),c.bind("change",T);for(var x=i.length-1;x>=0;x--)if(parseInt(u.val(),10)===i[x].val){c.val(i[x].label);break}}r("body").bind("orderdeliverychange",w),g.bind("click",I),console.log("orderValidation.js inited")}(this,this.document,this.jQuery,this.ENTER),function(e,o,r,t,n){console.info("separate-order.js init");var l=r("#jsOrderDelivery").data("value"),i=t.utils,a=r("body"),d=function d(o){var n={},l=[],d=[],c=null,u=null,p=null,y=null,h=null,f=null,v=[],g=t.OrderModel.orderDictionary.orderData.discounts||[];t.OrderModel.paypalECS()&&(console.info("PayPal ECS включен. Необходимо сохранить выбранные параметры в cookie"),e.docCookies.setItem("chTypeBtn_paypalECS",t.OrderModel.deliveryTypesButton,600),e.docCookies.setItem("chPoint_paypalECS",t.OrderModel.choosenPoint(),600),e.docCookies.setItem("chTypeId_paypalECS",t.OrderModel.choosenDeliveryTypeId,600),e.docCookies.setItem("chStetesPriority_paypalECS",JSON.stringify(t.OrderModel.statesPriority),600)),t.OrderModel.deliveryBoxes.removeAll(),t.OrderModel.hasCoupons(!1),console.log("Маркируем выбранный способ доставки"),r("#"+t.OrderModel.deliveryTypesButton).attr("checked","checked").trigger("change"),t.OrderModel.totalSum(0),t.OrderModel.hasHomeDelivery(!1),a.trigger("orderdeliverychange",[!1]);for(var m=0,k=o.length;k>m;m++)if(p=o[m],f=t.OrderModel.orderDictionary.isUniqueDeliveryState(p),console.info("перебирем "+(f?"уникальный* ":"")+"метод "+p),d=[],t.OrderModel.orderDictionary.hasDeliveryState(p)){l=t.OrderModel.orderDictionary.getProductFromState(p);for(var b=l.length-1;b>=0;b--)y=l[b],n[y]?console.log("товар "+y+" уже определялся к блоку"):(console.log("добавляем товар "+y+" в блок для метода "+p),n[y]=!0,d.push(t.OrderModel.orderDictionary.getProductById(y)));if(d.length)if(c=t.OrderModel.orderDictionary.hasPointDelivery(p)?t.OrderModel.choosenPoint():t.OrderModel.orderDictionary.getDefaultPointId(p),u=p+"_"+c,t.OrderModel.hasDeliveryBox(u))h=t.OrderModel.getDeliveryBoxByToken(u),h.addProductGroup(d);else if(f)for(v=t.OrderModel.prepareProductsQuantityByUniq(d),b=v.length-1;b>=0;b--)y=[v[b]],t.constructors.DeliveryBox(y,p,c);else t.constructors.DeliveryBox(d,p,c)}else console.info("для метода "+p+" нет товаров");if(console.info("Созданные блоки:"),console.log(t.OrderModel.deliveryBoxes()),t.OrderModel.couponsBox(g),t.OrderModel.couponUrl(r(".bSaleList__eItem:visible .jsCustomRadio").eq(0).val()),r(".bSaleList__eItem:visible .jsCustomRadio").eq(0).trigger("change"),0===r(".bPayMethod:visible .jsCustomRadio:checked").length&&r(".bPayMethod:visible .jsCustomRadio").eq(0).attr("checked","checked").trigger("change"),t.OrderModel.hasCoupons()&&t.OrderModel.deliveryBoxes().length>1||t.OrderModel.appliedCoupon()&&t.OrderModel.appliedCoupon().sum&&parseFloat(t.OrderModel.totalSum())+parseFloat(t.OrderModel.appliedCoupon().sum)<=parseFloat(t.OrderModel.appliedCoupon().sum)){console.warn("Нужно удалить купон");var O="Купон не может быть применен при текущем разбиении заказа и будет удален",D=function(){console.log("удаление"),t.OrderModel.deleteItem(t.OrderModel.appliedCoupon())};return r.when(s(O)).then(D),!1}n.length!==t.OrderModel.orderDictionary.orderData.products.length&&console.warn("не все товары были обработаны"),console.warn("end"),r(".bCountSection").goodsCounter({onChange:function(o){console.info("counter change"),console.log(o);var n,l=r(this).data("seturl")||"",a=l.addParameterToUrl("quantity",o);console.log(l),console.log(a);var d=function d(o){var r,t=e._rutarget||[];o.product&&o.regionId&&(r={event:"updateInCart",sku:o.product.id,qty:o.product.quantity,regionId:o.regionId},console.info("RuTarget updateInCart. Клики кнопок увеличения/уменьшения кол-ва товара."),console.log(r),t.push(r))},s=function s(e){return e.success?(t.OrderModel.couponNumber(""),d(e),void 0):(t.OrderModel.couponError(e.error.message),i.blockScreen.unblock(),void 0)};i.blockScreen.block("Обновляем"),n=[{type:"GET",url:a,callback:s},{type:"GET",url:t.OrderModel.updateUrl,callback:t.OrderModel.modelUpdate}],i.packageReq(n)}})};n.bindingHandlers.popupShower={update:function(e,o){var l=o(),i=n.utils.unwrapObservable(l),a=null;i?(a=new t.constructors.CreateMap("pointPopupMap",t.OrderModel.popupWithPoints().points,r("#mapInfoBlock")),r(e).lightbox_me({centered:!0,onClose:function(){console.info("закрываем"),l(!1)}}),a._showMarkers()):(r("#pointPopupMap").empty(),r(e).trigger("close"))}},n.bindingHandlers.payBlockVisible={update:function(e){var o,n,l=r(e),i=l.data("vars"),a=i&&i.toHide?i.toHide:!1,d=t.OrderModel.choosenDeliveryTypeId,s=t.OrderModel.deliveryBoxes(),c=s.length,u=1;if(c){if(1===c?(u=0,console.log("Кол-во deliveryBoxes == 1: Показываем payBlock")):(u=1,console.log("Кол-во deliveryBoxes > 1: Скрываем payBlock")),a)for(o in a)if(a[o].length===void 0)r.inArray(d,a)>=0&&(u=1,console.log("toHide NoArr: Скрываем payBlock"));else if(d===o)for(n in a[o])n===i.typeId&&(u=1,console.log("toHide Arr: Скрываем payBlock"));u?l.hide():l.show()}}},n.bindingHandlers.paymentMethodVisible={update:function(e,o){var l=o(),i=n.utils.unwrapObservable(l),a=r(e),d=a.data("value"),s=parseInt(d["max-sum"],10),c=parseInt(d["min-sum"],10),u=d.method_id,p=d.isAvailableToPickpoint;return 6===t.OrderModel.choosenDeliveryTypeId&&!1===p||4===t.OrderModel.choosenDeliveryTypeId&&13===u&&t.OrderModel.lifeGift()===!1||!isNaN(s)&&i>s||!isNaN(c)&&c>i?(a.hide(),void 0):(a.show(),void 0)}},n.bindingHandlers.calendarSlider={update:function(e,o,t,n,l){var i=r(e),a=o(),d=i.find(".bBuyingDatesItem"),s=d.width()+parseInt(d.css("marginRight"),10)+parseInt(d.css("marginLeft"),10);return i.width(d.length*s),a>0?(a-=380,l.box.calendarSliderLeft(a),void 0):-i.width()>a?(a+=380,l.box.calendarSliderLeft(a),void 0):(i.animate({left:a}),void 0)}},n.bindingHandlers.couponsVisible={update:function(e,o){var l,i=o(),a=n.utils.unwrapObservable(i),d=r(e),s=d.find(".mSaleInput"),c=d.find(".mSaleBtn"),u=d.find(".bSaleData__eEmptyBlock");
for(r(".bSaleList__eItem").removeClass("hidden"),l=a.length-1;l>=0;l--)d.find('.bSaleList__eItem[data-type="'+a[l].type+'"]').addClass("hidden"),"coupon"===a[l].type&&(console.log("Есть примененный купон"),t.OrderModel.hasCoupons(!0),t.OrderModel.appliedCoupon(a[l]));r(".bSaleList__eItem.hidden").length===r(".bSaleList__eItem").length||r(".bSaleList__eItem:hidden").length===r(".bSaleList__eItem").length?(s.attr("disabled","disabled"),c.attr("disabled","disabled").addClass("mDisabled"),u.show()):(s.removeAttr("disabled"),c.removeAttr("disabled").removeClass("mDisabled"),u.hide())}},t.OrderModel={updateUrl:r("#jsOrderDelivery").data("url"),prepareData:n.observable(!1),showPopupWithPoints:n.observable(!1),deliveryTypesButton:null,tmpStatesPriority:null,statesPriority:null,lifeGift:n.observable(!1),oneClick:n.observable(!1),paypalECS:n.observable(!1),cartSum:null,orderDictionary:null,choosenPoint:n.observable(),hasHomeDelivery:n.observable(!1),deliveryTypes:n.observableArray([]),deliveryBoxes:n.observableArray([]),popupWithPoints:n.observable({}),totalSum:n.observable(0),hasCoupons:n.observable(!1),appliedCoupon:n.observable(),couponNumber:n.observable(),couponUrl:n.observable(),couponError:n.observable(),couponsBox:n.observableArray([]),hasDeliveryBox:function(e){console.info("Существует ли блок доставки "+e);var o=null;for(o=t.OrderModel.deliveryBoxes().length-1;o>=0;o--)if(t.OrderModel.deliveryBoxes()[o].token===e)return!0;return!1},getDeliveryBoxByToken:function(e){console.info("Получить ссылку на блок по токену "+e);var o=null;for(o=t.OrderModel.deliveryBoxes().length-1;o>=0;o--)if(t.OrderModel.deliveryBoxes()[o].token===e)return t.OrderModel.deliveryBoxes()[o]},removeDeliveryBox:function(e){console.info("Поиск для удаления блока по токену "+e);var o,r=null,n=t.OrderModel.deliveryBoxes(),l=n.length;for(o=l-1;o>=0;o--)if(n[o].token===e){console.info("Удаление блока по токену "+e),r=t.OrderModel.deliveryBoxes.splice(o,1),"object"==typeof r[0]&&(r=r[0]);break}return r},checkCoupon:function(){console.info("проверяем купон");var e,o={number:t.OrderModel.couponNumber()},r=t.OrderModel.couponUrl(),n=function n(e){return e.success?(t.OrderModel.couponNumber(""),void 0):(t.OrderModel.couponError(e.error.message),i.blockScreen.unblock(),void 0)};return t.OrderModel.couponError(""),void 0===r?(console.warn("Не выбран тип скидки"),t.OrderModel.couponError("Не выбран тип скидки"),void 0):void 0!==o.number&&o.number.length?(i.blockScreen.block("Применяем купон"),e=[{type:"POST",url:r,data:o,callback:n},{type:"GET",url:t.OrderModel.updateUrl,callback:t.OrderModel.modelUpdate}],i.packageReq(e),!1):(console.warn("Не введен номер"),t.OrderModel.couponError("Не введен номер"),void 0)},selectPoint:function(e){console.info("point selected..."),console.log(e.parentBoxToken);var o=null;return e.parentBoxToken?(o=t.OrderModel.getDeliveryBoxByToken(e.parentBoxToken),console.log(o),o.selectPoint.apply(o,[e]),!1):(t.OrderModel.statesPriority=t.OrderModel.tmpStatesPriority,t.OrderModel.choosenPoint(e.id),t.OrderModel.showPopupWithPoints(!1),d(t.OrderModel.statesPriority),!1)},chooseDeliveryTypes:function(e,o){console.info("chooseDeliveryTypes");var n=e.states[0],l=o.target.htmlFor;return console.log(n),console.log(l),r("#"+l).attr("checked")?(console.warn("Этот пункт "+l+" уже был выбран"),!1):(t.OrderModel.deliveryTypesButton=l,console.log(t.OrderModel.deliveryTypesButton),t.OrderModel.tmpStatesPriority=e.states,console.log(t.OrderModel.tmpStatesPriority),t.OrderModel.choosenDeliveryTypeId=e.id,console.log(t.OrderModel.choosenDeliveryTypeId),t.OrderModel.orderDictionary.hasPointDelivery(n)?(console.log("Необходимо показать окно с выбором точки доставки"),t.OrderModel.popupWithPoints({header:e.name,points:t.OrderModel.orderDictionary.getAllPointsByState(n)}),t.OrderModel.showPopupWithPoints(!0),!1):(console.log("Выбор точки доставки не требуется"),t.OrderModel.statesPriority=t.OrderModel.tmpStatesPriority,t.OrderModel.choosenPoint(0),console.info("Отправляем данные на разбивку"),d(t.OrderModel.statesPriority),!1))},modelUpdate:function(e){console.info("обновление данных с сервера"),p(e),d(t.OrderModel.statesPriority)},deleteItem:function(r){console.info("удаление товара");var n=null;i.blockScreen.block("Удаляем");var l=function l(o){var r,n=t.OrderModel.orderDictionary.products,l=0,i=0,a={},d=e._rutarget||[];if(!o.product)return!1;for(var s in n)l+=n[s].price,i+=n[s].quantity;a={"Checkout Step 1 SKU Quantity":i,"Checkout Step 1 SKU Total":l},"undefined"!=typeof _kmq&&_kmq.push(["set",a]),"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Order card","Item deleted"]),o.regionId&&(r={event:"removeFromCart",sku:o.product.id,regionId:o.regionId},console.info("RuTarget removeFromCart"),console.log(r),d.push(r))},a=function a(e){if(console.info("deleteItemResponceHandler"),console.log(e),!e.success)return console.warn("не удалось удалить товар"),i.blockScreen.unblock(),!1;if(l(e),e.product){var r=e.product.id,t=e.category_id;(function(e){var r=o,t=r.createElement("IMG"),n=r.body;e=e.replace(/!\[rnd\]/,Math.round(9999999*Math.random()))+"&tail256="+escape(r.referrer||"unknown"),t.style.position="absolute",t.style.width=t.style.height="0px",t.onload=t.onerror=function(){n.removeChild(t),t=n=null},t.src=e,n.insertBefore(t,n.firstChild)})("http://ad.adriver.ru/cgi-bin/rle.cgi?sid=182615&sz=del_basket&bt=55&pz=0&custom=10="+r+";11="+t+"&![rnd]")}};return console.log(r.deleteUrl),n=[{type:"GET",url:r.deleteUrl,callback:a},{type:"GET",url:t.OrderModel.updateUrl,callback:t.OrderModel.modelUpdate}],i.packageReq(n),!1},prepareProductsQuantityByUniq:function(e){var o,r,n,l=[];for(r=e.length-1;r>=0;r--)for(o=t.utils.cloneObject(e[r]),o.sum=o.price,o.quantity=1,o.oldQuantity=e[r].quantity,n=e[r].quantity-1;n>=0;n--)l.push(o);return l}},n.applyBindings(t.OrderModel);var s=function s(e){var o='<div class="popupbox width290"><div class="font18 pb18"> '+e+"</div>"+"</div>"+'<p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>',t=r("<div>").addClass("popup").html(o),n=r.Deferred();t.appendTo("body");var l=function(){t.trigger("close"),t.remove(),n.resolve()};return t.lightbox_me({centered:!0,closeClick:!1,closeEsc:!1}),t.find(".closePopup").bind("click",l),n.promise()},c={"default":function(e){var o="Товар "+e.name+" недоступен для продажи.",t=r.Deferred();return r.when(s(o)).then(function(){r.ajax({type:"GET",url:e.deleteUrl}).then(t.resolve)}),t.promise()},708:function(e){var o="",n=r.Deferred();o=e.name&&e.error.message&&e.quantity?"Вы заказали товар "+e.name+" в количестве "+e.quantity+" шт. <br/ >"+e.error.message:"Товар недоступен для продажи",r.when(s(o)).then(function(){var o=[{type:"GET",url:e.setUrl,callback:n.resolve},{type:"GET",url:t.OrderModel.updateUrl,callback:t.OrderModel.modelUpdate}];return i.packageReq(o),n.promise()})}},u=function u(e){var t=null,n=[];for(t in e.products)e.products[t].error&&e.products[t].error.code&&n.push(e.products[t]);var l=function l(e,o){var t=null;return 0>e?(console.warn("return"),o(),void 0):(t=n[e].error.code,t=c.hasOwnProperty(t)?t:"default",r.when(c[t](n[e])).then(function(){var r=e-1;l(r,o)}),void 0)};0===n.length&&e.error.message?r.when(s(e.error.message)).then(function(){e.redirect&&(o.location.href=e.redirect)}):l(n.length-1,function(){console.warn("1 этап закончен"),e.redirect&&(o.location.href=e.redirect)})},p=function p(o){var r,n;return i.blockScreen.unblock(),o.success?(console.info("Данные с сервера получены"),t.OrderModel.orderDictionary=new t.constructors.OrderDictionary(o),o.paypalECS&&(console.info("paypal true"),t.OrderModel.paypalECS(!0)),o.cart&&o.cart.sum&&(console.info("Есть первоначальная сумма корзины : "+o.cart.sum),t.OrderModel.cartSum=o.cart.sum),t.OrderModel.deliveryTypes(o.deliveryTypes),t.OrderModel.lifeGift(o.lifeGift||!1),t.OrderModel.oneClick(o.oneClick||!1),t.OrderModel.prepareData(!0),t.OrderModel.paypalECS()&&e.docCookies.hasItem("chTypeBtn_paypalECS")&&e.docCookies.hasItem("chPoint_paypalECS")&&e.docCookies.hasItem("chTypeId_paypalECS")&&e.docCookies.hasItem("chStetesPriority_paypalECS")&&(console.info("PayPal ECS включен. Необходимо применить параметры из cookie"),t.OrderModel.deliveryTypesButton=e.docCookies.getItem("chTypeBtn_paypalECS"),t.OrderModel.choosenPoint(e.docCookies.getItem("chPoint_paypalECS")),t.OrderModel.choosenDeliveryTypeId=e.docCookies.getItem("chTypeId_paypalECS"),t.OrderModel.statesPriority=JSON.parse(e.docCookies.getItem("chStetesPriority_paypalECS")),d(t.OrderModel.statesPriority)),1===o.deliveryTypes.length&&(r=o.deliveryTypes[0],n=t.OrderModel.orderDictionary.getFirstPointByState(r.states[0])||r.id,console.log("Обнаружен только 1 способ доставки: "+r.name+" — выбираем его."),console.log("Выбран первый пункт* доставки:"),console.log(n),t.OrderModel.statesPriority=r.states,t.OrderModel.deliveryTypesButton="method_"+r.id,t.OrderModel.choosenDeliveryTypeId=r.id,t.OrderModel.choosenPoint(n),d(t.OrderModel.statesPriority)),void 0):(console.warn("Данные содержат ошибки"),console.log(o.error),u(o),!1)},y=function y(e){return console.log("selectPointOnBaloon"),console.log(e),console.log(r(this).data("pointid")),console.log(r(this).data("parentbox")),t.OrderModel.selectPoint({id:r(this).data("pointid"),parentBoxToken:r(this).data("parentbox")}),!1},h=function(o){console.info("analyticsStep_1");var r,t=0,n=0,l=[],i={};for(r in o.products)t+=o.products[r].price,n+=o.products[r].quantity,l.push({id:o.products[r].id,name:o.products[r].name,price:o.products[r].price,quantity:o.products[r].quantity});i={"Checkout Step 1 SKU Quantity":n,"Checkout Step 1 SKU Total":t,"Checkout Step 1 Order Type":"cart order"},"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","New order","Items",n]),"undefined"!=typeof _kmq&&_kmq.push(["record","Checkout Step 1",i]),e.APRT_DATA=e.APRT_DATA||{},e.APRT_DATA.pageType=5,e.APRT_DATA.orderInfo=e.APRT_DATA.orderInfo||{},e.APRT_DATA.orderInfo.totalPrice=t,e.APRT_DATA.basketProducts=l};console.log(t.OrderModel),p(l),h(l),a.on("click",".shopchoose",y)}(this,this.document,this.jQuery,this.ENTER,this.ko);