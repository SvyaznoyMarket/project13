function DeliveryBox(e,t,r,i,n){console.info("Cоздание блока доставки "+t+" для "+r);var a=this;a.OrderModel=n,a.createdBox=i,a.token=t+"_"+r,a.products=[],a.fullPrice=0,a.state=t,a.deliveryName=a.OrderModel.orderDictionary.getNameOfState(t),a.deliveryPrice=Number.POSITIVE_INFINITY,a.choosenDate=ko.observable(),a.choosenPoint=ko.observable({id:r}),a.choosenInterval=ko.observable(),a.showPopupWithPoints=ko.observable(!1),a.hasPointDelivery=a.OrderModel.orderDictionary.hasPointDelivery(t),a.allDatesForBlock=ko.observableArray([]),a.pointList=ko.observableArray([]),a.hasPointDelivery&&a.choosenPoint(a.OrderModel.orderDictionary.getPointByStateAndId(a.state,r)),a.addProductGroup(e),a.OrderModel.deliveryBoxes.push(a)}function OrderDictionary(e){this.orderData=e,this.serverTime=this.orderData.time,this.deliveryTypes=this.orderData.deliveryTypes,this.deliveryStates=this.orderData.deliveryStates,this.pointsByDelivery=this.orderData.pointsByDelivery,this.products=this.orderData.products}DeliveryBox.prototype._makePointList=function(){var e=this,t=!0;for(var r in e.products[0].deliveries){for(var i=e.products.length-1;i>=0&&(t=e.products[i].deliveries.hasOwnProperty(r),t);i--);t&&e.pointList.push(e.OrderModel.orderDictionary.getPointByStateAndId(e.state,r))}},DeliveryBox.prototype.selectPoint=function(e){var t=this,r=t.state+"_"+e.id;return void 0!==t.createdBox[r]?(t.createdBox[r].addProductGroup(t.products),delete t.createdBox[t.token]):(t.createdBox[r]=t.createdBox[t.token],delete t.createdBox[t.token],t.token=r,t.choosenPoint(e)),t.showPopupWithPoints(!1),!1},DeliveryBox.prototype.changePoint=function(){var e=this;return e.showPopupWithPoints(!0),!1},DeliveryBox.prototype._getFirstPropertyName=function(e){for(var t in e)return t},DeliveryBox.prototype._addProduct=function(e){var t=this,r=null,i=null,n=null,a=[];return e.deliveries[t.state].hasOwnProperty(t.choosenPoint().id)?(r=parseInt(e.deliveries[t.state][t.choosenPoint().id].price,10),t.deliveryPrice=t.deliveryPrice>r?r:t.deliveryPrice,t.fullPrice+=e.sum,t.products.push({name:e.name,price:e.sum,quantity:e.quantity,deleteUrl:e.deleteUrl,productUrl:e.url,productImg:e.image,deliveries:e.deliveries[t.state]}),void 0):(console.warn("Для товара "+e.id+" нет пункта доставки "+t.choosenPoint().id+" Необходимо создать новый блок"),n=t._getFirstPropertyName(e.deliveries[t.state]),i=t.state+"_"+n,a.push(e),void 0!==t.createdBox[i]?t.createdBox[i].addProductGroup(e):t.createdBox[i]=new DeliveryBox(a,t.state,n,t.createdBox,t.OrderModel),void 0)},DeliveryBox.prototype.addProductGroup=function(e){for(var t=this,r=e.length-1;r>=0;r--)t._addProduct(e[r]);this.calculateDate(),t.hasPointDelivery&&t._makePointList()},DeliveryBox.prototype._getNameDayOfWeek=function(e){var t=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"];return t[e]},DeliveryBox.prototype._hasDateInAllProducts=function(e){for(var t=this,r=null,i=null,n=!0,a=t.products.length-1;a>=0;a--){r=t.products[a].deliveries[t.choosenPoint().id].dates;for(var o=0,s=r.length;s>o;o++){if(i=r[o].value,i===e){n=!0;break}n=!1}if(!n)break}return n},DeliveryBox.prototype.calculateDate=function(){console.info("Вычисление общей даты для продуктов в блоке");var e=this,t=e.OrderModel.orderDictionary.getToday(),r=null,i=null;if(console.log("Сегодняшняя дата с сервера "+t),!e.products.length)return console.warn("в блоке нет товаров"),void 0;r=e.products[0].deliveries[e.choosenPoint().id].dates;for(var n=0,a=r.length;a>n;n++)i=r[n].value,e._hasDateInAllProducts(i)&&i>=t&&(r[n].avalible=!0,r[n].humanDayOfWeek=e._getNameDayOfWeek(r[n].dayOfWeek),r[n].selectDay=e.selectDay,e.allDatesForBlock.push(r[n]));e.choosenDate(e.allDatesForBlock()[0]),e.choosenInterval(e.choosenDate().intervals[0]),e.makeCalendar()},DeliveryBox.prototype.makeCalendar=function(){var e=this,t=0,r=null,i={};if(1!==e.allDatesForBlock()[0].dayOfWeek){t=0===e.allDatesForBlock()[0].dayOfWeek?6:e.allDatesForBlock()[0].dayOfWeek-1;for(var n=t;n>0;n--)r=e.allDatesForBlock()[0].dayOfWeek-1,i={avalible:!1,humanDayOfWeek:e._getNameDayOfWeek(r),dayOfWeek:r,day:0},e.allDatesForBlock.unshift(i)}if(0!==e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek){t=7-e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek;for(var a=t;a>0;a--)r=7===e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek+1?0:e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek+1,i={avalible:!1,humanDayOfWeek:e._getNameDayOfWeek(r),dayOfWeek:r,day:0},e.allDatesForBlock.push(i)}},OrderDictionary.prototype.getNameOfState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].name:(console.warn("Не найден метод доставки "+e),!1)},OrderDictionary.prototype.getToday=function(){return this.serverTime},OrderDictionary.prototype.hasDeliveryState=function(e){return this.deliveryStates.hasOwnProperty(e)},OrderDictionary.prototype.hasPointDelivery=function(e){return this.pointsByDelivery.hasOwnProperty(e)},OrderDictionary.prototype.getPointByStateAndId=function(e,t){var r=this.getAllPointsByState(e);t+="";for(var i=r.length-1;i>=0;i--)if(r[i].id===t)return r[i]},OrderDictionary.prototype.getAllPointsByState=function(e){var t=this.pointsByDelivery[e];return this.orderData[t]},OrderDictionary.prototype.getProductFromState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].products:(console.warn("Не найден метод доставки "+e),!1)},OrderDictionary.prototype.getProductById=function(e){return this.products.hasOwnProperty(e)?this.products[e]:(console.warn("Такого продукта не найдено"),!1)},function(){console.info("Логика разбиения заказа для оформления заказа v.5");var e="/ajax/order-delivery",t=null,r={},i=function i(e){for(var i={},a=[],o=[],s=null,l=null,c=null,u=null,h=0,d=e.length;d>h;h++)if(c=e[h],console.info("перебирем метод "+c),o=[],n.orderDictionary.hasDeliveryState(c)){a=n.orderDictionary.getProductFromState(c);for(var f=a.length-1;f>=0;f--)u=a[f],i[u]?console.log("товар "+u+" уже определялся к блоку"):(console.log("добавляем товар "+u+" в блок для метода "+c),i[u]=!0,o.push(n.orderDictionary.getProductById(u)));o.length&&(s=n.orderDictionary.hasPointDelivery(c)?t:0,l=c+"_"+s,void 0!==r[l]?r[l].addProductGroup(o):r[l]=new DeliveryBox(o,c,s,r,n))}else console.info("для метода "+c+" нет товаров");console.info("Созданные блоки:"),console.log(r),i.length!==n.orderDictionary.orderData.products.length&&console.warn("не все товары были обработаны")},n={prepareData:ko.observable(!1),statesPriority:null,orderDictionary:null,deliveryTypes:ko.observableArray([]),deliveryBoxes:ko.observableArray([]),showPopupWithPoints:ko.observable(!1),popupWithPoints:ko.observable({}),selectPoint:function(e){return console.info("point selected..."),t=e.id,n.showPopupWithPoints(!1),i(n.statesPriority),!1},chooseDeliveryTypes:function(e){var a=e.states[0];return n.statesPriority=e.states,r={},n.deliveryBoxes.removeAll(),n.orderDictionary.hasPointDelivery(a)?(n.popupWithPoints({header:e.description,points:n.orderDictionary.getAllPointsByState(a)}),n.showPopupWithPoints(!0),!1):(t=0,i(n.statesPriority),!1)}};ko.applyBindings(n);var a=function a(e){return e.success?(console.log("Данные с сервера получены"),n.orderDictionary=new OrderDictionary(e),n.deliveryTypes(e.deliveryTypes),n.prepareData(!0),$("#order").removeClass("hidden"),void 0):(console.warn("произошла ошибка при получении данных с сервера"),console.log(e.error),!1)};$.ajax({type:"GET",url:e,success:a})}();