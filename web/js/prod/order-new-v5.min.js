function DeliveryBox(e,r,o,t,l){console.info("Cоздание блока доставки "+r+" для "+o);var a=this;a.OrderModel=l,a.createdBox=t,a.deliveryPoint=o,a.products=[],a.fullPrice=0,a.state=r,a.deliveryName=a.OrderModel.orderDictionary.getNameOfState(r),a.deliveryPrice=Number.POSITIVE_INFINITY,a.choosenDate=ko.observable(),a.hasPointDelivery=a.OrderModel.orderDictionary.hasPointDelivery(r),console.log(a.hasPointDelivery),a.choosenInterval=ko.observable(),a.allDatesForBlock=ko.observableArray([]),a.addProductGroup(e),a.OrderModel.deliveryBoxes.push(a)}function OrderDictionary(e){this.orderData=e,this.serverTime=this.orderData.time,this.deliveryTypes=this.orderData.deliveryTypes,this.deliveryStates=this.orderData.deliveryStates,this.pointsByDelivery=this.orderData.pointsByDelivery,this.products=this.orderData.products}DeliveryBox.prototype._getFirstPropertyName=function(e){for(var r in e)return r},DeliveryBox.prototype._addProduct=function(e){var r=this,o=null,t=null,l=null,a=[];return e.deliveries[r.state].hasOwnProperty(r.deliveryPoint)?(o=parseInt(e.deliveries[r.state][r.deliveryPoint].price,10),r.deliveryPrice=r.deliveryPrice>o?o:r.deliveryPrice,r.fullPrice+=e.sum,r.products.push({name:e.name,price:e.sum,quantity:e.quantity,deleteUrl:e.deleteUrl,productUrl:e.url,productImg:e.image,deliveries:e.deliveries[r.state]}),void 0):(console.warn("Для товара "+e.id+" нет пункта доставки "+r.deliveryPoint+". Необходимо создать новый блок"),l=r._getFirstPropertyName(e.deliveries[r.state]),t=r.state+"_"+l,a.push(e),void 0!==r.createdBox[t]?r.createdBox[t].addProductGroup(e):r.createdBox[t]=new DeliveryBox(a,r.state,l,r.createdBox,r.OrderModel),void 0)},DeliveryBox.prototype.addProductGroup=function(e){for(var r=e.length-1;r>=0;r--)this._addProduct(e[r]);this.calculateDate()},DeliveryBox.prototype._getNameDayOfWeek=function(e){var r=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"];return r[e]},DeliveryBox.prototype._hasDateInAllProducts=function(e){for(var r=this,o=null,t=null,l=!0,a=r.products.length-1;a>=0;a--){o=r.products[a].deliveries[r.deliveryPoint].dates;for(var i=0,n=o.length;n>i;i++){if(t=o[i].value,t===e){l=!0;break}l=!1}if(!l)break}return l},DeliveryBox.prototype.selectDay=function(e){Console.info("выбор даты"),console.log(e)},DeliveryBox.prototype.calculateDate=function(){console.info("Вычисление общей даты для продуктов в блоке");var e=this,r=e.OrderModel.orderDictionary.getToday(),o=null,t=null;if(console.log("Сегодняшняя дата с сервера "+r),!e.products.length)return console.warn("в блоке нет товаров"),void 0;o=e.products[0].deliveries[e.deliveryPoint].dates;for(var l=0,a=o.length;a>l;l++)t=o[l].value,e._hasDateInAllProducts(t)&&t>=r&&(o[l].avalible=!0,o[l].humanDayOfWeek=e._getNameDayOfWeek(o[l].dayOfWeek),o[l].selectDay=e.selectDay,e.allDatesForBlock.push(o[l]));e.choosenDate(e.allDatesForBlock()[0]),e.choosenInterval(e.choosenDate().intervals[0]),e.makeCalendar()},DeliveryBox.prototype.makeCalendar=function(){console.info("Cобираем календарь");var e=this,r=0,o=null,t={};if(1!==e.allDatesForBlock()[0].dayOfWeek){r=0===e.allDatesForBlock()[0].dayOfWeek?6:e.allDatesForBlock()[0].dayOfWeek-1,console.log("первый день в календаре не понедельник. Нужно добавить "+r+" дней");for(var l=r;l>0;l--)o=e.allDatesForBlock()[0].dayOfWeek-1,t={avalible:!1,humanDayOfWeek:e._getNameDayOfWeek(o),dayOfWeek:o,day:0},e.allDatesForBlock.unshift(t)}if(0!==e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek){r=7-e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek,console.log("последний день в календаре не воскресение, нужно добавить "+r);for(var a=r;a>0;a--)o=7===e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek+1?0:e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek+1,t={avalible:!1,humanDayOfWeek:e._getNameDayOfWeek(o),dayOfWeek:o,day:0},e.allDatesForBlock.push(t)}},OrderDictionary.prototype.getNameOfState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].name:(console.warn("Не найден метод доставки "+e),!1)},OrderDictionary.prototype.getToday=function(){return this.serverTime},OrderDictionary.prototype.hasDeliveryState=function(e){return this.deliveryStates.hasOwnProperty(e)},OrderDictionary.prototype.hasPointDelivery=function(e){return this.pointsByDelivery.hasOwnProperty(e)},OrderDictionary.prototype.getProductFromState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].products:(console.warn("Не найден метод доставки "+e),!1)},OrderDictionary.prototype.getProductById=function(e){return this.products.hasOwnProperty(e)?this.products[e]:(console.warn("Такого продукта не найдено"),!1)},function(){console.info("Логика разбиения заказа для оформления заказа v.5");var e="/ajax/order-delivery",r=null,o=null,t={},l=function l(e){for(var r={},l=[],i=[],n=null,s=null,d=null,c=null,y=0,u=e.length;u>y;y++)if(d=e[y],console.info("перебирем метод "+d),i=[],a.orderDictionary.hasDeliveryState(d)){l=a.orderDictionary.getProductFromState(d);for(var v=l.length-1;v>=0;v--)c=l[v],r[c]?console.log("товар "+c+" уже определялся к блоку"):(console.log("добавляем товар "+c+" в блок для метода "+d),r[c]=!0,i.push(a.orderDictionary.getProductById(c)));i.length&&(n=a.orderDictionary.hasPointDelivery(d)?o:0,s=d+"_"+n,void 0!==t[s]?t[s].addProductGroup(i):t[s]=new DeliveryBox(i,d,n,t,a))}else console.info("для метода "+d+" нет товаров");console.info("Созданные блоки:"),console.log(t),r.length!==a.orderDictionary.orderData.products.length&&console.warn("не все товары были обработаны")},a={prepareData:ko.observable(!1),orderDictionary:null,deliveryTypes:ko.observableArray([]),deliveryBoxes:ko.observableArray([]),chooseDeliveryTypes:function(e){var i=e.states,n=i[0];t={},a.deliveryBoxes.removeAll(),r=e.token,a.orderDictionary.hasPointDelivery(n)?(console.log("есть точки доставки из которых нужно выбрать"),o=13):(console.log("для выбранного метода доставки нет точек доставки"),o=0),console.log("выбранный метод доставки "+r),console.log("выбранное место доставки "+o),l(i)}};ko.applyBindings(a);var i=function i(e){return e.success?(console.log("Данные с сервера получены"),a.orderDictionary=new OrderDictionary(e),a.deliveryTypes(e.deliveryTypes),a.prepareData(!0),void 0):(console.warn("произошла ошибка при получении данных с сервера"),console.log(e.error),!1)};$.ajax({type:"GET",url:e,success:i})}();