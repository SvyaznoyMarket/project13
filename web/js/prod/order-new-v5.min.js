!function(a,b,c,d){var e,f,g=d.utils,h=c("#page-config").data("value"),i=c("#jsOrderForm").data("value"),j=c("#metrostations").data("name"),k=c("#jsDeliveryAddress").data("value"),l=h?h.addressAutocomplete:!1,m=null,n=null,o=6,p=c("#order_address_street"),q=c("#order_address_building"),r=c("#order_address_number"),s=c("#order_address_metro"),t=c("#order_subway_id"),u=null,v=!1,w=k?k.regionName:"",x=c("#map"),y=null,z=function(){var a,b,d,e,f=12,g="";return a=c.trim(w),b="город",a&&(g&&(g+=", "),g+=b+" "+a,f=12),a=null,b=null,d=p.kladr("current"),e=c.trim(p.val()),d?(a=d.name,b=d.type):e&&(a=e,b=""),a&&(g&&(g+=", "),g+=b+" "+a,f=14),a=null,b=null,d=q.kladr("current"),e=c.trim(q.val()),d?(a=d.name,b="дом"):e&&(a=e,b="дом"),a&&(g&&(g+=", "),g+=b+" "+a,f=16),a=null,b=null,e=c.trim(r.val()),e&&(a=e,b="корпус"),a&&(g&&(g+=", "),g+=b+" "+a,f=16),{address:g,zoom:f}},A=function(){var a,b,c,d,e=z();e.address&&v&&y!==e.address&&(console.log(e.address),y=e.address,a=ymaps.geocode(e.address),a.then(function(a){b=a.geoObjects.get(0).geometry.getCoordinates(),b&&(c=b[0],d=b[1],u.points=[],u.mapWS.geoObjects.each(function(a){u.mapWS.geoObjects.remove(a)}),u.points.push({latitude:c,longitude:d}),u._showMarkers(),u.mapWS.setCenter(b,e.zoom),s.length&&B(c,d))}))},B=function(a,b){var c,d,e;t.length&&(c=ymaps.geocode([a,b],{kind:"metro"}),c.then(function(a){if(d=a.geoObjects.get(0),e=d.properties.get("name"),e=e.replace("метро ",""),s.val(e),t.val(""),g.orderValidator&&g.orderValidator._unmarkFieldError(s),void 0!==j)for(var b=j.length-1;b>=0;b--)if(e===j[b].label){t.val(j[b].val);break}},function(a){console.warn("При выполнении запроса произошла ошибка: "+a),s.val(""),t.val(""),g.orderValidator&&g.orderValidator._markFieldError(s,"Не выбрана станция метро")}))},C=function(a){return e=c("ul.error_list"),e.length?e.html("<li>"+a+"</li>"):c("#map").before(c('<ul class="error_list" />').append("<li>"+a+"</li>")),!1},D=function(){return e=c("ul.error_list"),e.length&&e.html(""),!1},E=function(a){""===c.trim(a)&&c.kladr.api({token:q.kladr("token"),key:q.kladr("key"),type:q.kladr("type"),name:a,parentType:q.kladr("parentType"),parentId:q.kladr("parentId"),limit:1},function(a){a.length&&(D(),q.kladr("current",a[0]))})};defaultValues=function(){""!=c.trim(i["order[address_street]"])&&c.kladr.api({token:m,key:n,type:c.kladr.type.street,name:i["order[address_street]"],parentType:c.kladr.type.city,parentId:f,limit:1},function(a){a.length&&(D(),p.kladr("current",a[0]),q.kladr("parentType",c.kladr.type.street),q.kladr("parentId",a[0].id),E(i["order[address_building]"]))})},fieldsHandler={city:function(){return w?void c.kladr.api({token:m,key:n,type:c.kladr.type.city,name:w,limit:1},function(a){return a.length?(f=a[0].id,fieldsHandler.street(),fieldsHandler.building(),fieldsHandler.buildingAdd(),p.kladr("parentType",c.kladr.type.city),p.kladr("parentId",f),void defaultValues()):void console.log("КЛАДР не нашел город "+w)}):null},street:function(){p.kladr({token:m,key:n,type:c.kladr.type.street,verify:!0,limit:o,source:function(a){c.kladr.api({token:p.kladr("token"),key:p.kladr("key"),type:p.kladr("type"),name:a,parentType:p.kladr("parentType"),parentId:p.kladr("parentId"),limit:p.kladr("limit")},function(a){var b,d,e=[];if(a.length&&(D(),p.kladr("current",a[0]),q.kladr("parentType",c.kladr.type.street),a[0].id!==q.kladr("parentId")&&(q.kladr("parentId",a[0].id),E(q.val())),A(),1!==a.length)){for(b in a)d=a[b],d.label=d.type+" "+d.name,d.value=d.name,e.push(d);p.autocomplete({source:e,appendTo:".jsInputStreet",minLength:2,select:function(a,b){D(),p.kladr("current",b.item),q.kladr("parentType",c.kladr.type.street),b.item.id!==q.kladr("parentId")&&(q.kladr("parentId",b.item.id),E(q.val())),A()}})}})}})},building:function(){q.kladr({token:m,key:n,type:c.kladr.type.building,verify:!0,limit:o,source:function(a){c.kladr.api({token:q.kladr("token"),key:q.kladr("key"),type:q.kladr("type"),name:a,parentType:q.kladr("parentType"),parentId:q.kladr("parentId"),limit:q.kladr("limit")},function(a){var b,c,d=[];if(a.length&&(D(),q.kladr("current",a[0]),A(),1!==a.length)){for(b in a)c=a[b],c.label=c.name,d.push(c);q.autocomplete({source:d,appendTo:".jsInputBuilding",minLength:0,select:function(a,b){D(),q.kladr("current",b.item),A()}})}})}})},buildingAdd:function(){r.change(function(){A()})}},fieldsInit=function(){fieldsHandler.city()},mapCreate=function(){var a,b,e=z();!v&&x.length&&(y=e.address,x.show().width(477).height(350),v=!0,a=ymaps.geocode(e.address),a.then(function(a){b=a.geoObjects.get(0).geometry.getCoordinates(),u=new d.constructors.CreateMap("map",[{latitude:b[0],longitude:b[1]}]),u.points=[],u.mapWS.geoObjects.each(function(a){u.mapWS.geoObjects.remove(a)}),""!==c.trim(i["order[address_street]"])&&u.points.push({latitude:b[0],longitude:b[1]}),u._showMarkers(),u.mapWS.setCenter(b,e.zoom)},function(a){console.log(a),C("Не нашли ваш город на карте."),u=new d.constructors.CreateMap("map",[{latitude:55.76,longitude:37.64}])}))},l&&(k&&k.kladr&&(m=k.kladr.token?k.kladr.token:null,n=k.kladr.key?k.kladr.key:null,o=k.kladr.itemLimit?k.kladr.itemLimit:6),fieldsInit(),c("body").bind("orderdeliverychange",function(){ymaps.ready(mapCreate)}))}(this,this.document,this.jQuery,this.ENTER),function(a,b,c,d,e){var f,g=d.constructors,h=(d.utils,d.config.pageConfig),i=h.prepayment;console.info("deliveryBox.js init"),console.log(d.OrderModel),g.DeliveryBox=function(){"use strict";function b(a,g,h){if(!(this instanceof b))return new b(a,g,h);console.info("Cоздание блока доставки %s для %s",g,h,this),f=d.OrderModel;var j=this;return j.isUnique=f.orderDictionary.isUniqueDeliveryState(g),j.token=g+"_"+h,j.products=[],j.fullPrice=e.observable(0),j.totalBlockSum=0,j.state=g,j.deliveryName=f.orderDictionary.getNameOfState(g),j.deliveryPrice=Number.NEGATIVE_INFINITY,j.choosenDate=e.observable(),j.choosenNameOfWeek=e.observable(),j.choosenPoint=e.observable({id:h}),j.choosenInterval=e.observable(),j.showPopupWithPoints=e.observable(!1),j.hasPointDelivery=f.orderDictionary.hasPointDelivery(g),j.isExpensiveOrder=e.computed(function(){return i.enabled&&i.priceLimit<=parseInt(j.fullPrice(),10)+parseInt(j.deliveryPrice,10)?!0:!1}),j.hasProductWithPrepayment=!1,j.allDatesForBlock=e.observableArray([]),j.pointList=[],j.changePointButtonText=f.orderDictionary.getChangeButtonText(g),j.hasPointDelivery&&!f.orderDictionary.getPointByStateAndId(j.state,h)?(console.info("есть точки доставки для выбранного метода доставки, но выбранная точка не доступна для этого метода доставки. Берем первую точку для выбранного метода доставки"),j.choosenPoint(f.orderDictionary.getFirstPointByState(j.state))):j.hasPointDelivery?(console.info("есть точки доставки для выбранного метода доставки, и выбранная точка доступна для этого метода доставки"),j.choosenPoint(f.orderDictionary.getPointByStateAndId(j.state,h))):(console.info("для выбранного метода доставки не нужна точка доставки"),f.hasHomeDelivery(!0),c("body").trigger("orderdeliverychange",[!0])),j.calendarSliderLeft=e.observable(0),j.addProductGroup(a),0===j.products.length?void console.warn("в блоке "+j.token+" не осталось товаров"):void f.deliveryBoxes.push(j)}return b.prototype._makePointList=function(){console.info("Создание списка точек доставки");var a,b,c,d=this,e=!0,g=null;for(a in d.products[0].deliveries[d.state]){for(b=d.products.length-1;b>=0&&(e=d.products[b].deliveries[d.state].hasOwnProperty(a),e);b--);if(e)g=f.orderDictionary.getPointByStateAndId(d.state,a),d.isUniquePointIdInPointList(a,d.pointList)&&(console.warn("Add point "+a+" to pointList"),d.pointList.push(g));else for(c in d.pointList)void 0!==d.pointList[c].id&&a===d.pointList[c].id&&(console.warn("Delete point "+a+" from pointList"),d.pointList.splice(c))}console.log("Точки доставки созданы"),console.log(d.pointList)},b.prototype.isUniquePointIdInPointList=function(a,b){var c,d=!0;if(void 0===a||void 0===b)return d;for(c in b)if(b[c].id==a)return!1;return!0},b.prototype.addUniqueSuffix=function(a){var b;return a=a||"",b=Math.floor(1e4*Math.random()+1),a+="_"+b},b.prototype.selectPoint=function(b){var c,e=this,g=e.state+"_"+b.id,h=null,i=[];if(f.hasDeliveryBox(g)){for(c=e.products.length-1;c>=0;c--)e.products[c].id&&i.push(e.products[c].id);e._hasProductsAlreadyAdded(i)||(h=f.getDeliveryBoxByToken(g),h.addProductGroup(e.products),f.removeDeliveryBox(e.token))}else e.isUnique&&(g+=e.addUniqueSuffix()),console.info("удаляем старый блок"),console.log("старый токен "+e.token),console.log("новый токен "+g),e.token=g,e.choosenPoint(f.orderDictionary.getPointByStateAndId(e.state,b.id)),d.OrderModel.choosenPoint(b.id),console.log(f.deliveryBoxes()),f.paypalECS()&&(console.info("PayPal ECS включен. Необходимо сохранить выбранную точку доставки в cookie"),a.docCookies.setItem("chPoint_paypalECS",b.id,600));return f.showPopupWithPoints(!1),!1},b.prototype.changePoint=function(){var a,b=this;for(a=b.pointList.length-1;a>=0;a--)b.pointList[a].parentBoxToken=b.token;return f.popupWithPoints({header:"Выберите точку доставки",points:b.pointList}),f.showPopupWithPoints(!0),!1},b.prototype._getFirstPropertyName=function(a){for(var b in a)return b},b.prototype._addProduct=function(a){var c,e,g=this,h=null,i=null,j=null,k=[],l=null,m={};if(!g._hasProductsAlreadyAdded([a.id])){if(!a.deliveries[g.state].hasOwnProperty(g.choosenPoint().id))return console.warn("Для товара "+a.id+" нет пункта доставки "+g.choosenPoint().id+" Необходимо создать новый блок"),j=g._getFirstPropertyName(a.deliveries[g.state]),i=g.state+"_"+j,k.push(a),void(f.hasDeliveryBox(i)?(console.log("Блок для этого типа доставки в этот пункт уже существует. Добавляем продукт в блок",i),l=f.getDeliveryBoxByToken(i),e=f.removeDeliveryBox(i),c=f.totalSum()-e.fullPrice()-l.deliveryPrice,f.totalSum(c),l.addProductGroup(k),f.deliveryBoxes.push(l)):new b(k,g.state,j));h=parseInt(a.deliveries[g.state][g.choosenPoint().id].price,10),g.deliveryPrice=g.deliveryPrice<h?h:g.deliveryPrice,m={id:a.id,name:a.name,price:a.sum?a.sum:a.price,quantity:a.quantity,stock:a.stock,deleteUrl:a.deleteUrl,setUrl:a.setUrl,productUrl:a.url,productImg:a.image?a.image:a.productImg,deliveries:{},isPrepayment:a.isPrepayment},g.isUnique&&a.oldQuantity-1>0&&(console.log("Переделываем deleteUrl:"),console.log(m.deleteUrl),m.deleteUrl=m.deleteUrl.replace("delete-","add-"),m.deleteUrl+="?quantity="+(a.oldQuantity-1),console.log(m.deleteUrl)),m.isPrepayment&&(g.hasProductWithPrepayment=!0),m.deliveries[g.state]=a.deliveries[g.state],g.fullPrice(d.utils.numMethods.sumDecimal(m.price,g.fullPrice())),g.products.push(m)}},b.prototype._hasProductsAlreadyAdded=function(a){var b,d=this,e=!1;if(void 0===a||!a.length)return e;for(b=d.products.length-1;b>=0;b--)-1!==c.inArray(d.products[b].id,a)&&(e=!0);return e},b.prototype.updateTotalPrice=function(){console.info("Перерасчет общей стоимости заказа");var a=this,b=f.totalSum();a.totalBlockSum=d.utils.numMethods.sumDecimal(a.fullPrice(),a.deliveryPrice),b=d.utils.numMethods.sumDecimal(a.totalBlockSum,b),f.totalSum(b),console.log(f.totalSum())},b.prototype.addProductGroup=function(a){var b,c=this;for(console.groupCollapsed("Добавление товаров в блок, количество товаров: %s",a.length),b=a.length-1;b>=0;b--)console.log(b+"-ый товар: ",a[b]),c._addProduct(a[b]);return console.groupEnd(),c.products.length?(c.calculateDate(),c.updateTotalPrice(),void(c.hasPointDelivery&&(console.info("У товара есть точки доставки. Создаем список точек доставки"),c._makePointList()))):void console.warn("в блоке "+c.token+" нет товаров")},b.prototype._getNameDayOfWeek=function(a){var b=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"];return b[a]},b.prototype._getFullNameDayOfWeek=function(a){var b=["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"];return b[a]},b.prototype._hasDateInAllProducts=function(a){var b,c,d,e=this,f=null,g=null,h=!0;for(c=0;c<e.products.length;c++){for(f=e.products[c].deliveries[e.state][e.choosenPoint().id].dates,d=0,b=f.length;b>d;d++){if(g=f[d].value,g===a){h=!0;break}h=!1}if(!h)break}return h},b.prototype.clickCalendarDay=function(b){var c=this;return b.avalible?(f.paypalECS()&&(console.info("PayPal ECS включен. Необходимо сохранить выбранную дату в cookie"),a.docCookies.setItem("chDate_paypalECS",JSON.stringify(b),600)),c.choosenNameOfWeek(c._getFullNameDayOfWeek(b.dayOfWeek)),void c.choosenDate(b)):!1},b.prototype.calculateDate=function(){console.info("Вычисление общей даты для продуктов в блоке");var c,e,g=this,h=f.orderDictionary.getToday(),i=null,j=null,k="",l=null,m=[],n=null,o=null;for(console.log("Сегодняшняя дата с сервера "+h),i=g.products[0].deliveries[g.state][g.choosenPoint().id].dates,e=0,c=i.length;c>e;e++)j=i[e].value,g._hasDateInAllProducts(j)&&j>=h&&(i[e].avalible=!0,i[e].humanDayOfWeek=g._getNameDayOfWeek(i[e].dayOfWeek),g.allDatesForBlock().push(i[e]));if(!g.allDatesForBlock().length){console.warn("Нет общих дат для блока. Необходимо разделить продукты в блоке."),console.groupCollapsed("Разделяемый блок");var p=[];for(var q in g.products){var r=g.products[q];r.firstDate=g.products[q].deliveries[g.state][g.choosenPoint().id].dates[0].name,r.lastDate=g.products[q].deliveries[g.state][g.choosenPoint().id].dates[g.products[q].deliveries[g.state][g.choosenPoint().id].dates.length-1].name,p.push(r)}console.table(p),console.groupEnd(),console.info("Выделяем в отдельный блок товары от поставщика");var s=[];s=g.products.reduceRight(function(a,b,c,e){return 0x8000000000000000==b.stock&&(e.splice(c,1),a.push(b),g.fullPrice(d.utils.numMethods.sumDecimal(g.fullPrice(),-b.price))),a},[]),console.log("Количество товаров от поставщика = %s",s.length),s.length&&new b(s,g.state,g.choosenPoint().id),m=g.products.reduceRight(function(a,b,c,e){var f=b.deliveries[g.state][g.choosenPoint().id].dates[0].value;return null===l&&(l=f),l==f&&(e.splice(c,1),a.push(b),g.fullPrice(d.utils.numMethods.sumDecimal(g.fullPrice(),-b.price))),a},[]),console.log("Продукты в новом блоке:",m),k=g.state+"_"+g.choosenPoint().id+"_"+g.addUniqueSuffix(),console.log("новый токен "+k),console.log(g),new b(m,g.state,g.choosenPoint().id),g.calculateDate()}return f.paypalECS()&&a.docCookies.hasItem("chDate_paypalECS")?(console.info("PayPal ECS включен. Необходимо взять выбранную дату из cookie"),n=a.docCookies.getItem("chDate_paypalECS"),o=JSON.parse(n)):o=g.allDatesForBlock()[0],console.log("Выбранная дата (chooseDate) ",o),!0!==o.avalible?(console.warn("Блок недоступен. Вычисление общей даты для продуктов в блоке невозможно. Выходим."),!1):(g.choosenDate(o),void 0===typeof g.choosenDate().intervals?(console.warn("В блоке нет интервалов. Вычисление даты невозможно. Выходим."),!1):(g.choosenNameOfWeek(g._getFullNameDayOfWeek(g.choosenDate().dayOfWeek)),0!==g.choosenDate().intervals.length&&g.choosenInterval(g.choosenDate().intervals[0]),void g.makeCalendar()))},b.prototype.makeCalendar=function(){console.groupCollapsed("Создание календаря, округление до целых недель");var a,b,c,d=this,e=0,f={},g=null,h=null,i=864e5;for(c=0;c<=d.allDatesForBlock().length-1;c++){if(void 0===d.allDatesForBlock()[c+1]){console.info("Следущая дата последняя. заканчиваем цикл");break}if(c>99)break;f={},g=d.allDatesForBlock()[c].value+i,h=new Date(g),g!==d.allDatesForBlock()[c+1].value&&(f={value:g,avalible:!1,humanDayOfWeek:d._getNameDayOfWeek(h.getDay()),dayOfWeek:h.getDay(),day:h.getDate()},console.log("предыдущая дата была "+new Date(d.allDatesForBlock()[c].value).getDate()+" новая дата вклинилась "+h.getDate()+" следущая дата "+new Date(d.allDatesForBlock()[c+1].value).getDate()),d.allDatesForBlock.splice(c+1,0,f))}if(1!==d.allDatesForBlock()[0].dayOfWeek)for(e=0===d.allDatesForBlock()[0].dayOfWeek?6:d.allDatesForBlock()[0].dayOfWeek-1,g=d.allDatesForBlock()[0].value,a=e;a>0;a--)g-=i,h=new Date(g),f={avalible:!1,humanDayOfWeek:d._getNameDayOfWeek(h.getDay()),dayOfWeek:h.getDay(),day:h.getDate()},d.allDatesForBlock.unshift(f);if(0!==d.allDatesForBlock()[d.allDatesForBlock().length-1].dayOfWeek)for(e=7-d.allDatesForBlock()[d.allDatesForBlock().length-1].dayOfWeek,g=d.allDatesForBlock()[d.allDatesForBlock().length-1].value,b=e;b>0;b--)g+=i,h=new Date(g),f={avalible:!1,humanDayOfWeek:d._getNameDayOfWeek(h.getDay()),dayOfWeek:h.getDay(),day:h.getDate()},d.allDatesForBlock.push(f);console.groupEnd()},b.prototype.calendarLeftBtn=function(){var a=this,b=parseInt(a.calendarSliderLeft(),10);b+=380,a.calendarSliderLeft(b)},b.prototype.calendarRightBtn=function(){var a=this,b=parseInt(a.calendarSliderLeft(),10);b-=380,a.calendarSliderLeft(b)},b}()}(this,this.document,this.jQuery,this.ENTER,this.ko),function(a){console.info("orderCredit.js init...");var b=$("div.bBankWrap"),c=function(){var c=$("#selectedBank"),d=function(){var a=$("input:checked",b),d=a.val();console.log("selectBank with ID",d),"undefined"!==d&&($(".bSelectInput",b).addClass("bUnchecked"),a.closest(".bSelectInput",b).removeClass("bUnchecked"),c.val(d))};b.change(d),"function"==typeof a.DirectCredit.init&&a.DirectCredit.init($("#jsCreditBank").data("value"),$(".credit_pay"))};b.length&&c()}(this),function(a,b,c,d){console.info("orderDictionary.js init...");var e=d.constructors;e.OrderDictionary=function(){"use strict";function b(a){return this instanceof b?(this.orderData=a,this.serverTime=this.orderData.time,this.deliveryTypes=this.orderData.deliveryTypes,this.deliveryStates=this.orderData.deliveryStates,this.pointsByDelivery=this.orderData.pointsByDelivery,this.products=this.orderData.products,void(this.defPoints=this.orderData.defPoints||{})):new b(a)}return b.prototype.getNameOfState=function(a){return this.hasDeliveryState(a)?this.deliveryStates[a].name:(console.warn("Не найден метод доставки "+a),!1)},b.prototype.getToday=function(){return this.serverTime},b.prototype.getDefaultPointId=function(a){return this.defPoints.hasOwnProperty(a)?this.defPoints[a]:0},b.prototype.hasDeliveryState=function(a){return this.deliveryStates.hasOwnProperty(a)},b.prototype.isUniqueDeliveryState=function(a){var b;return this.hasDeliveryState(a)?(b=this.deliveryStates[a],b.unique):!1},b.prototype.hasPointDelivery=function(a){return this.hasDeliveryState(a)?this.pointsByDelivery.hasOwnProperty(a):!1},b.prototype.getPointByStateAndId=function(b,c){var d,e=this.getAllPointsByState(b);for(c+="",d=e.length-1;d>=0;d--)if(e[d].id===c)return a.ENTER.utils.cloneObject(e[d]);return!1},b.prototype.getFirstPointByState=function(a){var b=this.getAllPointsByState(a);return b[0]?d.utils.cloneObject(b[0]):!1},b.prototype.getAllPointsByState=function(a){if(!this.hasDeliveryState(a))return!1;var b,c,d=this.pointsByDelivery[a],e=d?d.token:!1,f=e?this.orderData[e]:!1,g=[];if("now"==a||"self"==a){for(b in f)for(c in f[b].products)c==a&&g.push(f[b]);f=g}return f||!1},b.prototype.getChangeButtonText=function(a){var b=this.pointsByDelivery[a]?this.pointsByDelivery[a].changeName:"Сменить";return b},b.prototype.getProductFromState=function(a){return this.hasDeliveryState(a)?this.deliveryStates[a].products:(console.warn("Не найден метод доставки "+a),!1)},b.prototype.getProductById=function(a){return this.products.hasOwnProperty(a)?this.products[a]:(console.warn("Такого продукта не найдено"),!1)},b.prototype.getStateToProductByDeliveryID=function(a,b){console.info("Перебираем все методы доставок и ищем среди них со схожим типом точек доставок");var c,d=this.products[a].deliveries;console.log("productId "+a),console.log("pointId "+b),console.log(d);for(c in d)if(console.log("ищем в "+c),d.hasOwnProperty(c)&&d[c].hasOwnProperty(b))return console.log("возвращаем "+c),c;return console.warn("не нашли...(("),!1},b}()}(this,this.document,this.jQuery,this.ENTER),function(){if(console.info("orderSertificate init..."),!$("#paymentMethod-10").length)return console.warn("нет метода оплаты сертификатом"),!1;var a=$("#paymentMethod-10").parent(),b=a.find(".mCardNumber"),c=a.find(".mCardPin"),d=a.find(".bPayMethodAction"),e=d.attr("data-url"),f=function(){var a=!1,f="processBlock",g=function(){return b.val().replace(/[^0-9]/g,"")},h=function(){return c.val().replace(/[^0-9]/g,"")},i=function(){return{code:g(),pin:h()}},j=function(){return a&&""!==g()&&14===g().length&&""!==h()&&4===h().length?!0:!1},k=function(){return 4!==c.val().length?(console.warn("пин код мал"),!1):b.val().length?(l("mOrange","Проверка по номеру карты"),void $.post(e,i(),function(a){if(!("success"in a))return!1;if(!a.success){var b="undefined"!=typeof a.error?a.error:"ERROR";return l("mRed",b),!1}l("mGreen",a.data)})):(console.warn("номер карты не введен"),!1)},l=function(b,c){console.info("setProcessingStatus");var e=$(".process").first(),g={typeNum:b};switch(e.hasClass("picked")||e.remove(),b){case"mOrange":g.text=c,a=!1;break;case"mRed":g.text="Произошла ошибка: "+c,a=!1;break;case"mGreen":g.text="activated"in c?"Карта "+c.code+" на сумму "+c.sum+" активирована!":"Карта "+c.code+" имеет номинал "+c.sum,a=!0}d.after(tmpl(f,g)),"undefined"!=typeof c.activated&&$(".process").first().addClass("picked")};return{checkCard:k,setProcessingStatus:l,isActive:j,getCode:g,getPIN:h}}();b.bind("change",function(){f.checkCard()}),c.bind("change",function(){f.checkCard()}),$.mask.definitions.n="[0-9]",c.mask("nnnn",{completed:f.checkCard,placeholder:"*"})}(this),function(a,b,c,d){console.info("orderValidation.js init");var e=d.utils,f={},g=c("#metrostations").data("name"),h=c("#order_recipient_first_name"),i=(c("#order_recipient_last_name"),c("#order_recipient_email")),j=c("#order_recipient_phonenumbers"),k=c("#order_address_metro"),l=c("#order_subway_id"),m=c("#order_address_street"),n=c("#order_address_building"),o=c("#sclub-number"),p=(c('.jsCustomRadio[name="order[payment_method_id]"]'),c("#qiwi-phone")),q=c("#order_agreed"),r=c("#completeOrder"),s=null,t=null,u=null,v={fields:[{fieldNode:h,require:!0,customErr:"Введите имя получателя",validateOnChange:!0},{fieldNode:i,validBy:"isEmail",customErr:"Некорректно введен e-mail",validateOnChange:!0},{fieldNode:j,require:!0,customErr:"Некорректно введен телефон",validateOnChange:!0},{fieldNode:q,require:!0,customErr:"Необходимо согласие"},{fieldNode:o,customErr:"Некорректно введен номер карты Связного клуба"}]},w={source:g,appendTo:"#metrostations",minLength:2,select:function(a,b){l.val(b.item.val)}};console.log(d.OrderModel),console.log("orderValidation:: vars initd"),f=new FormValidator(v),e.orderValidator=f;var x=function(a,b){var d='<div class="popupbox width290"><div class="font18 pb18"> '+a+'</div></div><p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>',e=c("<div>").addClass("popup").html(d);e.appendTo("body");var f=function(){return e.trigger("close"),e.remove(),void 0!==b&&b(),!1};e.lightbox_me({centered:!0,onClose:f}),e.find(".closePopup").bind("click",f)},y=function(a){console.warn("Ошибка в поле");var b=c('[name="order['+a.field+']"]'),d=function(){f._unmarkFieldError(c(this))};f._markFieldError(b,a.message),b.bind("focus",d)},z={"default":function(a){return console.log("Обработчик ошибки"),"undefined"==typeof a.redirect&&(a.redirect="/cart"),a.error&&a.error.message?void x(a.error.message,function(){0!==a.redirect&&(b.location.href=a.redirect)}):void(b.location.href=a.redirect)},0:function(a){console.warn("Обработка ошибок формы");var d=null;if(a.redirect)return void x(a.error.message,function(){b.location.href=a.redirect});x(a.error.message);for(var e=a.form.error.length-1;e>=0;e--)d=a.form.error[e],console.warn(d),y(d);c.scrollTo(c(".mError").eq(0),500,{offset:-15})},743:function(a){x(a.error.message)}},A=function(){if("undefined"!=typeof _gaq){for(var b=d.OrderModel.deliveryBoxes().length-1;b>=0;b--)_gaq.push(["_trackEvent","Order card","Completed","выбрана "+d.OrderModel.choosenDeliveryTypeId+" доставят "+d.OrderModel.deliveryBoxes()[b].state]);_gaq.push(["_trackEvent","Order complete",d.OrderModel.deliveryBoxes().length,d.OrderModel.orderDictionary.products.length]),_gaq.push(["_trackTiming","Order complete","DB response",u])}"undefined"!=typeof a.yaCounter10503055&&a.yaCounter10503055.reachGoal("\\orders\\complete")},B=function(c){return console.info("данные отправлены. получен ответ от сервера"),t=(new Date).getTime(),u=t-s,console.log(c),c.success?(A(),d.OrderModel.paypalECS()&&!r.hasClass("mConfirm")&&(console.info("PayPal ECS включен. Заказ оформлен. Необходимо удалить выбранные параметры из cookie"),a.docCookies.removeItem("chDate_paypalECS","/"),a.docCookies.removeItem("chTypeBtn_paypalECS","/"),a.docCookies.removeItem("chPoint_paypalECS","/"),a.docCookies.removeItem("chTypeId_paypalECS","/"),a.docCookies.removeItem("chStetesPriority_paypalECS","/")),void(b.location.href=c.redirect)):(console.log("ошибка оформления заказа"),e.blockScreen.unblock(),z.hasOwnProperty(c.error.code)?(console.log("Есть обработчик"),z[c.error.code](c)):(console.log("Стандартный обработчик"),z["default"](c)),!1)},C=function(){var b,f,g,h=null,i=[],j=[],k={},l=c("#order-form");for(e.blockScreen.block("Ваш заказ оформляется"),j=l.serializeArray(),console.info("Перебираем блоки доставки"),f=d.OrderModel.deliveryBoxes().length-1;f>=0;f--){for(k={},h=d.OrderModel.deliveryBoxes()[f],b=h.choosenPoint(),console.log("currentDeliveryBox:"),console.log(h),k={deliveryMethod_token:h.state,date:h.choosenDate().value,interval:[h.choosenInterval()?h.choosenInterval().start:"",h.choosenInterval()?h.choosenInterval().end:""],point_id:b.id,products:[]},console.log("choosePoint:"),console.log(b),"pickpoint"===h.state&&(console.log("Is PickPoint!"),k.point_id=b.number,k.point_address={street:b.street,house:b.house},k.point_name=b.point_name),g=h.products.length-1;g>=0;g--)k.products.push(h.products[g].id);console.log("tmpPart:"),console.log(k),i.push(k)}j.push({name:"order[delivery_type_id]",value:d.OrderModel.choosenDeliveryTypeId}),j.push({name:"order[part]",value:JSON.stringify(i)}),"undefined"!=typeof a.KM&&j.push({name:"kiss_session",value:a.KM.i}),console.log("dataToSend:"),console.log(j),s=(new Date).getTime(),c.ajax({url:l.attr("action"),timeout:12e4,type:"POST",data:j,success:B,statusCode:{500:function(){x("Не удалось создать заказ. Попробуйте позднее. 500")},504:function(){x("Не удалось создать заказ. Попробуйте позднее. 504")}}})},D=function(){return console.info("Завершить оформление заказа"),d.OrderModel.lifeGift()?(C(),!1):(f.validate({onInvalid:function(a){console.warn("invalid"),console.log(a),c.scrollTo(a[a.length-1].fieldNode,500,{offset:-15})},onValid:C}),!1)},E=function(){for(var a=g.length-1;a>=0;a--)if(k.val()===g[a].label)return;k.val("")},F=function(a,b){b?(f.setValidate(m,{require:!0,customErr:"Не введено название улицы",validateOnChange:!0}),f.setValidate(n,{require:!0,customErr:"Не введен номер дома",validateOnChange:!0}),void 0!==g&&f.setValidate(k,{fieldNode:k,customErr:"Не выбрана станция метро",require:!0,validateOnChange:!0})):(f.setValidate(m,{require:!1}),f.setValidate(n,{require:!1}),void 0!==g&&f.setValidate(k,{require:!1})),console.info("Изменен тип доставки"),console.log(f)};c.mask.definitions.n="[0-9]",o.mask("2 98nnnn nnnnnn",{placeholder:"*"}),p.mask("(nnn) nnn-nn-nn"),j.mask("(nnn) nnn-nn-nn"),a.docCookies.getItem("emails")&&(console.log("AB TEST: e-mail require"),f.setValidate(i,{require:!0}));var G=function(a){var b,d=null;console.info("defaultValueToField");for(b in a)if(console.log("поле "+b),a[b]){if(console.log("для поля есть значение "+a[b]),d=c('input[name="'+b+'"]'),"radio"===d.attr("type")){d.filter('[value="'+a[b]+'"]').attr("checked","checked").trigger("change");continue}d.val(a[b])}};if(G(c("#jsOrderForm").data("value")),void 0!==g){k.autocomplete(w),k.bind("change",E);for(var H=g.length-1;H>=0;H--)if(parseInt(l.val(),10)===g[H].val){k.val(g[H].label);break}}c("body").bind("orderdeliverychange",F),r.bind("click",D),console.log("orderValidation.js inited")}(this,this.document,this.jQuery,this.ENTER),function(a,b,c,d,e){console.info("separate-order.js init");var f=c("#jsOrderDelivery").data("value"),g=d.utils,h=c("body"),i=function(b){var f={},i=[],k=[],l=null,m=null,n=null,o=null,p=null,q=null,r=[],s=[],t=d.OrderModel.orderDictionary.orderData.discounts||[];d.OrderModel.paypalECS()&&(console.info("PayPal ECS включен. Необходимо сохранить выбранные параметры в cookie"),a.docCookies.setItem("chTypeBtn_paypalECS",d.OrderModel.deliveryTypesButton,600),a.docCookies.setItem("chPoint_paypalECS",d.OrderModel.choosenPoint(),600),a.docCookies.setItem("chTypeId_paypalECS",d.OrderModel.choosenDeliveryTypeId,600),a.docCookies.setItem("chStetesPriority_paypalECS",JSON.stringify(d.OrderModel.statesPriority),600)),d.OrderModel.deliveryBoxes().length&&(s=e.toJS(d.OrderModel.deliveryBoxes()),console.info("[DeliveryBox] Существуют старые блоки доставки",s)),d.OrderModel.deliveryBoxes.removeAll(),d.OrderModel.hasCoupons(!1),console.log("Маркируем выбранный способ доставки"),c("#"+d.OrderModel.deliveryTypesButton).attr("checked","checked").trigger("change"),d.OrderModel.totalSum(0),d.OrderModel.hasHomeDelivery(!1),h.trigger("orderdeliverychange",[!1]);for(var u=0,v=b.length;v>u;u++)if(n=b[u],q=d.OrderModel.orderDictionary.isUniqueDeliveryState(n),console.info("перебирем "+(q?"уникальный* ":"")+"метод "+n),k=[],d.OrderModel.orderDictionary.hasDeliveryState(n)){i=d.OrderModel.orderDictionary.getProductFromState(n);for(var w=i.length-1;w>=0;w--)o=i[w],f[o]?console.log("товар "+o+" уже определялся к блоку"):(console.log("добавляем товар "+o+" в блок для метода "+n),f[o]=!0,k.push(d.OrderModel.orderDictionary.getProductById(o)));if(k.length)if(l=d.OrderModel.orderDictionary.hasPointDelivery(n)?d.OrderModel.choosenPoint():d.OrderModel.orderDictionary.getDefaultPointId(n),m=n+"_"+l,d.OrderModel.hasDeliveryBox(m))p=d.OrderModel.getDeliveryBoxByToken(m),p.addProductGroup(k);else if(q)for(r=d.OrderModel.prepareProductsQuantityByUniq(k),w=r.length-1;w>=0;w--)o=[r[w]],d.constructors.DeliveryBox(o,n,l);else d.constructors.DeliveryBox(k,n,l)}else console.info("для метода "+n+" нет товаров");for(var x in s)d.OrderModel.hasDeliveryBox(s[x].token)&&(console.log("[Deliverybox] Обнаружен старый блок доставки: ",s[x].token," c выбранной датой ",s[x].choosenDate),console.info("[Deliverybox] Применяю старую дату на блок ",s[x].token),d.OrderModel.getDeliveryBoxByToken(s[x].token).choosenDate(s[x].choosenDate),console.log("[Deliverybox] Дата на новом блоке ",s[x].token,": ",d.OrderModel.getDeliveryBoxByToken(s[x].token).choosenDate()));if(console.info("Созданные блоки:"),console.log(d.OrderModel.deliveryBoxes()),d.OrderModel.couponsBox(t),d.OrderModel.couponUrl(c(".bSaleList__eItem:visible .jsCustomRadio").eq(0).val()),c(".bSaleList__eItem:visible .jsCustomRadio").eq(0).trigger("change"),0===c(".bPayMethod:visible .jsCustomRadio:checked").length&&c(".bPayMethod:visible .jsCustomRadio").eq(0).attr("checked","checked").trigger("change"),d.OrderModel.hasCoupons()&&d.OrderModel.deliveryBoxes().length>1||d.OrderModel.appliedCoupon()&&d.OrderModel.appliedCoupon().sum&&parseFloat(d.OrderModel.totalSum())+parseFloat(d.OrderModel.appliedCoupon().sum)<=parseFloat(d.OrderModel.appliedCoupon().sum)){console.warn("Нужно удалить купон");var y="Купон не может быть применен при текущем разбиении заказа и будет удален",z=function(){console.log("удаление"),d.OrderModel.deleteItem(d.OrderModel.appliedCoupon())};return c.when(j(y)).then(z),!1}f.length!==d.OrderModel.orderDictionary.orderData.products.length&&console.warn("не все товары были обработаны"),console.warn("end"),c(".bCountSection").goodsCounter({onChange:function(a){console.info("counter change"),console.log(a);var b,e=c(this).data("seturl")||"",f=e.addParameterToUrl("quantity",a);console.log(e),console.log(f);var h=function(a){return a.success?void d.OrderModel.couponNumber(""):(d.OrderModel.couponError(a.error.message),void g.blockScreen.unblock())};g.blockScreen.block("Обновляем"),b=[{type:"GET",url:f,callback:h},{type:"GET",url:d.OrderModel.updateUrl,callback:d.OrderModel.modelUpdate}],g.packageReq(b)}})};e.bindingHandlers.popupShower={update:function(a,b){var f=b(),g=e.utils.unwrapObservable(f),h=null;g?(h=new d.constructors.CreateMap("pointPopupMap",d.OrderModel.popupWithPoints().points,c("#mapInfoBlock")),c(a).lightbox_me({centered:!0,onClose:function(){console.info("закрываем"),f(!1)
}}),h._showMarkers()):(c("#pointPopupMap").empty(),c(a).trigger("close"))}},e.bindingHandlers.payBlockVisible={update:function(a){var b,e,f=c(a),g=f.data("vars"),h=g&&g.toHide?g.toHide:!1,i=d.OrderModel.choosenDeliveryTypeId,j=d.OrderModel.deliveryBoxes(),k=j.length,l=1;if(k){if(1===k?(l=0,console.log("Кол-во deliveryBoxes == 1: Показываем payBlock")):(l=1,console.log("Кол-во deliveryBoxes > 1: Скрываем payBlock")),h)for(b in h)if("undefined"==typeof h[b].length)c.inArray(i,h)>=0&&(l=1,console.log("toHide NoArr: Скрываем payBlock"));else if(i===b)for(e in h[b])e===g.typeId&&(l=1,console.log("toHide Arr: Скрываем payBlock"));l?f.hide():f.show()}}},e.bindingHandlers.paymentMethodVisible={update:function(a,b){var f=b(),g=e.utils.unwrapObservable(f),h=c(a),i=h.data("value"),j=parseInt(i["max-sum"],10),k=parseInt(i["min-sum"],10),l=i.method_id,m=i.isAvailableToPickpoint;return 6===d.OrderModel.choosenDeliveryTypeId&&!1===m||4===d.OrderModel.choosenDeliveryTypeId&&13===l&&d.OrderModel.lifeGift()===!1||!isNaN(j)&&g>j||!isNaN(k)&&k>g?void h.hide():void h.show()}},e.bindingHandlers.calendarSlider={update:function(a,b,d,e,f){var g=c(a),h=b(),i=g.find(".bBuyingDatesItem"),j=i.width()+parseInt(i.css("marginRight"),10)+parseInt(i.css("marginLeft"),10);return g.width(i.length*j),h>0?(h-=380,void f.box.calendarSliderLeft(h)):h<-g.width()?(h+=380,void f.box.calendarSliderLeft(h)):void g.animate({left:h})}},e.bindingHandlers.couponsVisible={update:function(a,b){var f,g=b(),h=e.utils.unwrapObservable(g),i=c(a),j=i.find(".mSaleInput"),k=i.find(".mSaleBtn"),l=i.find(".bSaleData__eEmptyBlock");for(c(".bSaleList__eItem").removeClass("hidden"),f=h.length-1;f>=0;f--)i.find('.bSaleList__eItem[data-type="'+h[f].type+'"]').addClass("hidden"),"coupon"===h[f].type&&(console.log("Есть примененный купон"),d.OrderModel.hasCoupons(!0),d.OrderModel.appliedCoupon(h[f]));c(".bSaleList__eItem.hidden").length===c(".bSaleList__eItem").length||c(".bSaleList__eItem:hidden").length===c(".bSaleList__eItem").length?(j.attr("disabled","disabled"),k.attr("disabled","disabled").addClass("mDisabled"),l.show()):(j.removeAttr("disabled"),k.removeAttr("disabled").removeClass("mDisabled"),l.hide())}},d.OrderModel={updateUrl:c("#jsOrderDelivery").data("url"),prepareData:e.observable(!1),showPopupWithPoints:e.observable(!1),deliveryTypesButton:null,tmpStatesPriority:null,statesPriority:null,lifeGift:e.observable(!1),oneClick:e.observable(!1),paypalECS:e.observable(!1),cartSum:null,orderDictionary:null,choosenPoint:e.observable(),hasHomeDelivery:e.observable(!1),deliveryTypes:e.observableArray([]),deliveryBoxes:e.observableArray([]),popupWithPoints:e.observable({}),totalSum:e.observable(0),hasCoupons:e.observable(!1),appliedCoupon:e.observable(),couponNumber:e.observable(),couponUrl:e.observable(),couponError:e.observable(),couponsBox:e.observableArray([]),hasDeliveryBox:function(a){console.info("Существует ли блок доставки "+a);var b=null;for(b=d.OrderModel.deliveryBoxes().length-1;b>=0;b--)if(d.OrderModel.deliveryBoxes()[b].token===a)return!0;return!1},getDeliveryBoxByToken:function(a){console.info("Получить ссылку на блок по токену "+a);var b=null;for(b=d.OrderModel.deliveryBoxes().length-1;b>=0;b--)if(d.OrderModel.deliveryBoxes()[b].token===a)return d.OrderModel.deliveryBoxes()[b]},removeDeliveryBox:function(a){console.info("Поиск для удаления блока по токену "+a);var b,c=null,e=d.OrderModel.deliveryBoxes(),f=e.length;for(b=f-1;b>=0;b--)if(e[b].token===a){console.info("Удаление блока по токену "+a),c=d.OrderModel.deliveryBoxes.splice(b,1),"object"==typeof c[0]&&(c=c[0]);break}return c},checkCoupon:function(){console.info("проверяем купон");var a,b={number:d.OrderModel.couponNumber()},c=d.OrderModel.couponUrl(),e=function(a){return a.success?void d.OrderModel.couponNumber(""):(d.OrderModel.couponError(a.error.message),void g.blockScreen.unblock())};return d.OrderModel.couponError(""),void 0===c?(console.warn("Не выбран тип скидки"),void d.OrderModel.couponError("Не выбран тип скидки")):void 0!==b.number&&b.number.length?(g.blockScreen.block("Применяем купон"),a=[{type:"POST",url:c,data:b,callback:e},{type:"GET",url:d.OrderModel.updateUrl,callback:d.OrderModel.modelUpdate}],g.packageReq(a),!1):(console.warn("Не введен номер"),void d.OrderModel.couponError("Не введен номер"))},selectPoint:function(a){console.info("point selected..."),console.log(a.parentBoxToken);var b=null;return a.parentBoxToken?(b=d.OrderModel.getDeliveryBoxByToken(a.parentBoxToken),console.log(b),b.selectPoint.apply(b,[a]),!1):(d.OrderModel.statesPriority=d.OrderModel.tmpStatesPriority,d.OrderModel.choosenPoint(a.id),d.OrderModel.showPopupWithPoints(!1),i(d.OrderModel.statesPriority),!1)},chooseDeliveryTypes:function(a,b){console.info("chooseDeliveryTypes");var e=a.states[0],f=b.target.htmlFor;return console.log(e),console.log(f),c("#"+f).attr("checked")?(console.warn("Этот пункт "+f+" уже был выбран"),!1):(d.OrderModel.deliveryTypesButton=f,console.log(d.OrderModel.deliveryTypesButton),d.OrderModel.tmpStatesPriority=a.states,console.log(d.OrderModel.tmpStatesPriority),d.OrderModel.choosenDeliveryTypeId=a.id,console.log(d.OrderModel.choosenDeliveryTypeId),d.OrderModel.orderDictionary.hasPointDelivery(e)?(console.log("Необходимо показать окно с выбором точки доставки"),d.OrderModel.popupWithPoints({header:a.name,points:d.OrderModel.orderDictionary.getAllPointsByState(e)}),d.OrderModel.showPopupWithPoints(!0),!1):(console.log("Выбор точки доставки не требуется"),d.OrderModel.statesPriority=d.OrderModel.tmpStatesPriority,d.OrderModel.choosenPoint(0),console.info("Отправляем данные на разбивку"),i(d.OrderModel.statesPriority),!1))},modelUpdate:function(a){console.info("обновление данных с сервера"),m(a),i(d.OrderModel.statesPriority)},deleteItem:function(a){console.info("удаление товара");var c=null;g.blockScreen.block("Удаляем");var e=function(){var b=d.OrderModel.orderDictionary.products,c=0,e=0,f={};if(!a.product)return!1;for(var g in b)c+=g[g].price,e+=g[g].quantity;f={"Checkout Step 1 SKU Quantity":e,"Checkout Step 1 SKU Total":c},"undefined"!=typeof _kmq&&_kmq.push(["set",f]),"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Order card","Item deleted"])},f=function(a){if(console.info("deleteItemResponceHandler"),console.log(a),!a.success)return console.warn("не удалось удалить товар"),g.blockScreen.unblock(),!1;if(("undefined"!=typeof _gaq||"undefined"!=typeof _kmq)&&e(),a.product){var c=a.product.id,d=a.category_id;!function(a){var c=b,d=c.createElement("IMG"),e=c.body;a=a.replace(/!\[rnd\]/,Math.round(9999999*Math.random()))+"&tail256="+escape(c.referrer||"unknown"),d.style.position="absolute",d.style.width=d.style.height="0px",d.onload=d.onerror=function(){e.removeChild(d),d=e=null},d.src=a,e.insertBefore(d,e.firstChild)}("http://ad.adriver.ru/cgi-bin/rle.cgi?sid=182615&sz=del_basket&bt=55&pz=0&custom=10="+c+";11="+d+"&![rnd]")}};return console.log(a.deleteUrl),c=[{type:"GET",url:a.deleteUrl,callback:f},{type:"GET",url:d.OrderModel.updateUrl,callback:d.OrderModel.modelUpdate}],g.packageReq(c),!1},prepareProductsQuantityByUniq:function(a){var b,c,e,f=[];for(c=a.length-1;c>=0;c--)for(b=d.utils.cloneObject(a[c]),b.sum=b.price,b.quantity=1,b.oldQuantity=a[c].quantity,e=a[c].quantity-1;e>=0;e--)f.push(b);return f}},e.applyBindings(d.OrderModel);var j=function(a){var b='<div class="popupbox width290"><div class="font18 pb18"> '+a+'</div></div><p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>',d=c("<div>").addClass("popup").html(b),e=c.Deferred();d.appendTo("body");var f=function(){d.trigger("close"),d.remove(),e.resolve()};return d.lightbox_me({centered:!0,closeClick:!1,closeEsc:!1}),d.find(".closePopup").bind("click",f),e.promise()},k={"default":function(a){var b="Товар "+a.name+" недоступен для продажи.",d=c.Deferred();return c.when(j(b)).then(function(){c.ajax({type:"GET",url:a.deleteUrl}).then(d.resolve)}),d.promise()},708:function(a){var b="",e=c.Deferred();b=a.name&&a.error.message&&a.quantity?"Вы заказали товар "+a.name+" в количестве "+a.quantity+" шт. <br/ >"+a.error.message:"Товар недоступен для продажи",c.when(j(b)).then(function(){var b=[{type:"GET",url:a.setUrl,callback:e.resolve},{type:"GET",url:d.OrderModel.updateUrl,callback:d.OrderModel.modelUpdate}];return g.packageReq(b),e.promise()})}},l=function(a){var d=null,e=[];for(d in a.products)a.products[d].error&&a.products[d].error.code&&e.push(a.products[d]);var f=function g(a,b){var d=null;return 0>a?(console.warn("return"),void b()):(d=e[a].error.code,d=k.hasOwnProperty(d)?d:"default",void c.when(k[d](e[a])).then(function(){var c=a-1;g(c,b)}))};0===e.length&&a.error.message?c.when(j(a.error.message)).then(function(){a.redirect&&(b.location.href=a.redirect)}):f(e.length-1,function(){console.warn("1 этап закончен"),a.redirect&&(b.location.href=a.redirect)})},m=function(b){var c,e;return g.blockScreen.unblock(),b.success?(console.info("Данные с сервера получены"),d.OrderModel.orderDictionary=new d.constructors.OrderDictionary(b),b.paypalECS&&(console.info("paypal true"),d.OrderModel.paypalECS(!0)),b.cart&&b.cart.sum&&(console.info("Есть первоначальная сумма корзины : "+b.cart.sum),d.OrderModel.cartSum=b.cart.sum),d.OrderModel.deliveryTypes(b.deliveryTypes),d.OrderModel.lifeGift(b.lifeGift||!1),d.OrderModel.oneClick(b.oneClick||!1),d.OrderModel.prepareData(!0),d.OrderModel.paypalECS()&&a.docCookies.hasItem("chTypeBtn_paypalECS")&&a.docCookies.hasItem("chPoint_paypalECS")&&a.docCookies.hasItem("chTypeId_paypalECS")&&a.docCookies.hasItem("chStetesPriority_paypalECS")&&(console.info("PayPal ECS включен. Необходимо применить параметры из cookie"),d.OrderModel.deliveryTypesButton=a.docCookies.getItem("chTypeBtn_paypalECS"),d.OrderModel.choosenPoint(a.docCookies.getItem("chPoint_paypalECS")),d.OrderModel.choosenDeliveryTypeId=a.docCookies.getItem("chTypeId_paypalECS"),d.OrderModel.statesPriority=JSON.parse(a.docCookies.getItem("chStetesPriority_paypalECS")),i(d.OrderModel.statesPriority)),void(1===b.deliveryTypes.length&&(c=b.deliveryTypes[0],e=d.OrderModel.orderDictionary.getFirstPointByState(c.states[0])||c.id,console.log("Обнаружен только 1 способ доставки: "+c.name+" — выбираем его."),console.log("Выбран первый пункт* доставки:"),console.log(e),d.OrderModel.statesPriority=c.states,d.OrderModel.deliveryTypesButton="method_"+c.id,d.OrderModel.choosenDeliveryTypeId=c.id,d.OrderModel.choosenPoint(e),i(d.OrderModel.statesPriority)))):(console.warn("Данные содержат ошибки"),console.log(b.error),l(b),!1)},n=function(a){return console.log("selectPointOnBaloon"),console.log(a),console.log(c(this).data("pointid")),console.log(c(this).data("parentbox")),d.OrderModel.selectPoint({id:c(this).data("pointid"),parentBoxToken:c(this).data("parentbox")}),!1},o=function(b){console.info("analyticsStep_1");var c,d=0,e=0,f=[],g={};for(c in b.products)d+=b.products[c].price,e+=b.products[c].quantity,f.push({id:b.products[c].id,name:b.products[c].name,price:b.products[c].price,quantity:b.products[c].quantity});g={"Checkout Step 1 SKU Quantity":e,"Checkout Step 1 SKU Total":d,"Checkout Step 1 Order Type":"cart order"},"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","New order","Items",e]),"undefined"!=typeof _kmq&&_kmq.push(["record","Checkout Step 1",g]),a.APRT_DATA=a.APRT_DATA||{},a.APRT_DATA.pageType=5,a.APRT_DATA.orderInfo=a.APRT_DATA.orderInfo||{},a.APRT_DATA.orderInfo.totalPrice=d,a.APRT_DATA.basketProducts=f};console.log(d.OrderModel),m(f),o(f),h.on("click",".shopchoose",n)}(this,this.document,this.jQuery,this.ENTER,this.ko);