function DeliveryBox(e,o,r,t){console.info("Cоздание блока доставки "+o+" для "+r);var n=this;return n.OrderModel=t,n.token=o+"_"+r,n.products=[],n.fullPrice=0,n.state=o,n.deliveryName=n.OrderModel.orderDictionary.getNameOfState(o),n.deliveryPrice=Number.POSITIVE_INFINITY,n.choosenDate=ko.observable(),n.choosenNameOfWeek=ko.observable(),n.choosenPoint=ko.observable({id:r}),n.choosenInterval=ko.observable(),n.showPopupWithPoints=ko.observable(!1),n.hasPointDelivery=n.OrderModel.orderDictionary.hasPointDelivery(o),n.allDatesForBlock=ko.observableArray([]),n.pointList=[],n.hasPointDelivery&&!n.OrderModel.orderDictionary.getPointByStateAndId(n.state,r)?(console.info("есть точки доставки для выбранного метода доставки, но выбранная точка не доступна для этого метода доставки. Берем первую точку для выбранного метода доставки"),n.choosenPoint(n.OrderModel.orderDictionary.getFirstPointByState(n.state))):n.hasPointDelivery?(console.info("есть точки доставки для выбранного метода доставки, и выбранная точка доступна для этого метода доставки"),n.choosenPoint(n.OrderModel.orderDictionary.getPointByStateAndId(n.state,r))):(console.info("для выбранного метода доставки не нужна точка доставки"),n.OrderModel.hasHomeDelivery(!0),$("body").trigger("orderdeliverychange",[!0])),n.calendarSliderLeft=ko.observable(0),n.addProductGroup(e),n.products.length?(n.OrderModel.deliveryBoxes.push(n),void 0):(console.warn("в блоке "+n.token+" неосталось товаров"),void 0)}function OrderDictionary(e){this.orderData=e,this.serverTime=this.orderData.time,this.deliveryTypes=this.orderData.deliveryTypes,this.deliveryStates=this.orderData.deliveryStates,this.pointsByDelivery=this.orderData.pointsByDelivery,this.products=this.orderData.products}DeliveryBox.prototype._makePointList=function(){var e=this,o=!0,r=null;for(var t in e.products[0].deliveries){for(var n=e.products.length-1;n>=0&&(o=e.products[n].deliveries.hasOwnProperty(t),o);n--);o&&(r=e.OrderModel.orderDictionary.getPointByStateAndId(e.state,t),e.pointList.push(r))}},DeliveryBox.prototype.selectPoint=function(e){var o=this,r=o.state+"_"+e.id;return void 0!==o.OrderModel.createdBox[r]?(o.OrderModel.createdBox[r].addProductGroup(o.products),delete o.OrderModel.createdBox[o.token]):(console.info("удаляем старый блок"),console.log("старый токен "+o.token),console.log("новый токен "+r),o.OrderModel.createdBox[r]=o.OrderModel.createdBox[o.token],delete o.OrderModel.createdBox[o.token],o.token=r,o.choosenPoint(o.OrderModel.orderDictionary.getPointByStateAndId(o.state,e.id)),console.log(o.OrderModel.createdBox)),o.OrderModel.showPopupWithPoints(!1),!1},DeliveryBox.prototype.changePoint=function(){for(var e=this,o=e.pointList.length-1;o>=0;o--)e.pointList[o].parentBoxToken=e.token;return e.OrderModel.popupWithPoints({header:"Выберите точку доставки",points:e.pointList}),e.OrderModel.showPopupWithPoints(!0),!1},DeliveryBox.prototype._getFirstPropertyName=function(e){for(var o in e)return o},DeliveryBox.prototype._addProduct=function(e){var o=this,r=null,t=null,n=null,a=[];return e.deliveries[o.state].hasOwnProperty(o.choosenPoint().id)?(r=parseInt(e.deliveries[o.state][o.choosenPoint().id].price,10),o.deliveryPrice=o.deliveryPrice>r?r:o.deliveryPrice,o.fullPrice+=e.sum,o.products.push({id:e.id,name:e.name,price:e.sum,quantity:e.quantity,deleteUrl:e.deleteUrl,productUrl:e.url,productImg:e.image,deliveries:e.deliveries[o.state]}),void 0):(console.warn("Для товара "+e.id+" нет пункта доставки "+o.choosenPoint().id+" Необходимо создать новый блок"),n=o._getFirstPropertyName(e.deliveries[o.state]),t=o.state+"_"+n,a.push(e),void 0!==o.OrderModel.createdBox[t]?o.OrderModel.createdBox[t].addProductGroup(e):o.OrderModel.createdBox[t]=new DeliveryBox(a,o.state,n,o.OrderModel),void 0)},DeliveryBox.prototype.updateTotalPrice=function(){var e=this,o=e.OrderModel.totalSum();o+=e.fullPrice+e.deliveryPrice,e.OrderModel.totalSum(o)},DeliveryBox.prototype.addProductGroup=function(e){for(var o=this,r=e.length-1;r>=0;r--)o._addProduct(e[r]);return o.products.length?(o.calculateDate(),o.updateTotalPrice(),o.hasPointDelivery&&o._makePointList(),void 0):(console.warn("в блоке "+o.token+" нет товаров"),void 0)},DeliveryBox.prototype._getNameDayOfWeek=function(e){var o=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"];return o[e]},DeliveryBox.prototype._getFullNameDayOfWeek=function(e){var o=["воскресение","понедельник","вторник","среда","четверг","пятница","суббота"];return o[e]},DeliveryBox.prototype._hasDateInAllProducts=function(e){for(var o=this,r=null,t=null,n=!0,a=o.products.length-1;a>=0;a--){r=o.products[a].deliveries[o.choosenPoint().id].dates;for(var i=0,l=r.length;l>i;i++){if(t=r[i].value,t===e){n=!0;break}n=!1}if(!n)break}return n},DeliveryBox.prototype.clickCalendarDay=function(e){var o=this;return e.avalible?(o.choosenNameOfWeek(o._getFullNameDayOfWeek(e.dayOfWeek)),o.choosenDate(e),void 0):!1},DeliveryBox.prototype.calculateDate=function(){console.info("Вычисление общей даты для продуктов в блоке");var e=this,o=e.OrderModel.orderDictionary.getToday(),r=null,t=null;console.log("Сегодняшняя дата с сервера "+o),r=e.products[0].deliveries[e.choosenPoint().id].dates;for(var n=0,a=r.length;a>n;n++)t=r[n].value,e._hasDateInAllProducts(t)&&t>=o&&(r[n].avalible=!0,r[n].humanDayOfWeek=e._getNameDayOfWeek(r[n].dayOfWeek),e.allDatesForBlock.push(r[n]));e.choosenDate(e.allDatesForBlock()[0]),e.choosenNameOfWeek(e._getFullNameDayOfWeek(e.allDatesForBlock()[0].dayOfWeek)),e.choosenInterval(e.choosenDate().intervals[0]),e.makeCalendar()},DeliveryBox.prototype.makeCalendar=function(){var e=this,o=0,r=null,t={},n=null,a=864e5;if(1!==e.allDatesForBlock()[0].dayOfWeek){o=0===e.allDatesForBlock()[0].dayOfWeek?6:e.allDatesForBlock()[0].dayOfWeek-1,n=e.allDatesForBlock()[0].value;for(var i=o;i>0;i--)r=e.allDatesForBlock()[0].dayOfWeek-1,n-=a,t={avalible:!1,humanDayOfWeek:e._getNameDayOfWeek(r),dayOfWeek:r,day:new Date(n).getDate()},e.allDatesForBlock.unshift(t)}if(0!==e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek){o=7-e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek,n=e.allDatesForBlock()[e.allDatesForBlock().length-1].value;for(var l=o;l>0;l--)r=7===e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek+1?0:e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek+1,n+=a,t={avalible:!1,humanDayOfWeek:e._getNameDayOfWeek(r),dayOfWeek:r,day:new Date(n).getDate()},e.allDatesForBlock.push(t)}},DeliveryBox.prototype.calendarLeftBtn=function(){var e=this,o=parseInt(e.calendarSliderLeft(),10);o+=380,e.calendarSliderLeft(o)},DeliveryBox.prototype.calendarRightBtn=function(){var e=this,o=parseInt(e.calendarSliderLeft(),10);o-=380,e.calendarSliderLeft(o)},ko.bindingHandlers.calendarSlider={update:function(e,o,r,t,n){var a=$(e),i=o(),l=a.find(".bBuyingDatesItem"),d=l.width()+parseInt(l.css("marginRight"),10)+parseInt(l.css("marginLeft"),10);return a.width(l.length*d),i>0?(i-=380,n.box.calendarSliderLeft(i),void 0):-a.width()>i?(i+=380,n.box.calendarSliderLeft(i),void 0):(a.animate({left:i}),void 0)}},function(){var e=$(".bBankWrap"),o=function o(){var o=e.find(".bBankLink"),r=e.find(".bBankLink__eName"),t=e.find(".bSelect"),n=$("#selectedBank"),a=e.find(".bSelectWrap_eText"),i=function i(){var e=$("option:selected",t).attr("data-link"),i=$("option:selected",t).val(),l=$("option:selected",t).html();a.html(l),r.html(l),n.val(i),o.attr("href",e)};$("option",t).eq(0).attr("selected","selected"),t.change(i),i(),DirectCredit.init($("#jsCreditBank").data("value"),$("#creditPrice"))};e.length&&o()}(this),OrderDictionary.prototype.getNameOfState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].name:(console.warn("Не найден метод доставки "+e),!1)},OrderDictionary.prototype.getToday=function(){return this.serverTime},OrderDictionary.prototype.hasDeliveryState=function(e){return this.deliveryStates.hasOwnProperty(e)},OrderDictionary.prototype.hasPointDelivery=function(e){return this.pointsByDelivery.hasOwnProperty(e)},OrderDictionary.prototype.getPointByStateAndId=function(e,o){var r=this.getAllPointsByState(e);o+="";for(var t=r.length-1;t>=0;t--)if(r[t].id===o)return window.cloneObject(r[t]);return!1},OrderDictionary.prototype.getFirstPointByState=function(e){var o=this.getAllPointsByState(e);return window.cloneObject(o[0])},OrderDictionary.prototype.getAllPointsByState=function(e){var o=this.pointsByDelivery[e];return this.orderData[o]},OrderDictionary.prototype.getProductFromState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].products:(console.warn("Не найден метод доставки "+e),!1)},OrderDictionary.prototype.getProductById=function(e){return this.products.hasOwnProperty(e)?this.products[e]:(console.warn("Такого продукта не найдено"),!1)},function(){if(!$("#paymentMethod-10").length)return console.warn("нет метода оплаты сертификатом"),!1;var e=$("#paymentMethod-10").parent(),o=e.find(".mCardNumber"),r=e.find(".mCardPin"),t=e.find(".bPayMethodAction"),n=t.attr("data-url"),a=function(){var e=!1,a="processBlock",i=function i(){return o.val().replace(/[^0-9]/g,"")},l=function l(){return r.val().replace(/[^0-9]/g,"")},d=function d(){return{code:i(),pin:l()}},s=function s(){return e&&""!==i()&&14===i().length&&""!==l()&&4===l().length?!0:!1},c=function c(){return 4!==r.val().length?(console.warn("пин код мал"),!1):o.val().length?(u("mOrange","Проверка по номеру карты"),$.post(n,d(),function(e){if(!("success"in e))return!1;if(!e.success){var o=e.error!==void 0?e.error:"ERROR";return u("mRed",o),!1}u("mGreen",e.data)}),void 0):(console.warn("номер карты не введен"),!1)},u=function u(o,r){console.info("setProcessingStatus");var n=$(".process").first(),i={typeNum:o};switch(n.hasClass("picked")||n.remove(),o){case"mOrange":i.text=r,e=!1;break;case"mRed":i.text="Произошла ошибка: "+r,e=!1;break;case"mGreen":i.text="activated"in r?"Карта "+r.code+" на сумму "+r.sum+" активирована!":"Карта "+r.code+" имеет номинал "+r.sum,e=!0}t.after(tmpl(a,i)),r.activated!==void 0&&$(".process").first().addClass("picked")};return{checkCard:c,setProcessingStatus:u,isActive:s,getCode:i,getPIN:l}}();o.bind("change",function(){a.checkCard()}),r.bind("change",function(){a.checkCard()}),r.mask("9999",{completed:a.checkCard,placeholder:"*"})}(this),function(e){var o={},r=$("#metrostations").data("name"),t=$("#order_recipient_first_name"),n=($("#order_recipient_last_name"),$("#order_recipient_email")),a=$("#order_recipient_phonenumbers"),i=$("#order_address_metro"),l=$("#order_subway_id"),d=$("#order_address_street"),s=$("#order_address_building"),c=$("#sclub-number"),u=$('.jsCustomRadio[name="order[payment_method_id]"]'),p=$("#qiwi-phone"),v=$("#order_agreed"),h=$("#completeOrder"),y={fields:[{fieldNode:t,require:!0,customErr:"Введите имя получателя",validateOnChange:!0},{fieldNode:n,validBy:"isEmail",customErr:"Некорректно введен e-mail",validateOnChange:!0},{fieldNode:a,require:!0,customErr:"Некорректно введен телефон",validateOnChange:!0},{fieldNode:v,require:!0,customErr:"Необходимо согласие"},{fieldNode:u,require:!0,customErr:"Необходимо выбрать метод оплаты"}]},f={source:r,appendTo:"#metrostations",minLength:2,select:function(e,o){l.val(o.item.val)}};o=new FormValidator(y);var O=function O(e){var o='<div class="popupbox width290"><div class="font18 pb18"> '+e+"</div>"+"</div>"+'<p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>',r=$("<div>").addClass("popup").html(o);r.appendTo("body");var t=function(){return r.trigger("close"),r.remove(),!1};r.lightbox_me({centered:!0,onClose:t}),r.find(".closePopup").bind("click",t)},m=function m(e){console.warn("Ошибка в поле");var r=$('[name="order['+e.field+']"]');o.setValidate(r,{require:!0,customErr:e.message,validateOnChange:!0}),o._markFieldError(r,e.message)},g={0:function(e){var o=null;O(e.error.message);for(var r=e.form.error.length-1;r>=0;r--)o=e.form.error[r],console.warn(o),m(o);$.scrollTo($(".mError").eq(0),500,{offset:-15})},743:function(e){O(e.error.message)}},k=function k(o){return console.info("данные отправлены. получен ответ от сервера"),e.OrderModel.blockScreen.unblock(),console.log(o),o.success?(document.location.href=o.redirect,void 0):(console.log("ошибка оформления заказа"),g[o.error.code](o),!1)},D=function D(){var o=null,r=[],t=[],n={},a=$("#order-form");e.OrderModel.blockScreen.block("Ваш заказ оформляется"),console.info("Перебираем блоки доставки");for(var i=e.OrderModel.deliveryBoxes().length-1;i>=0;i--){n={},o=e.OrderModel.deliveryBoxes()[i],console.log(o),n={deliveryMethod_token:o.state,date:o.choosenDate().value,interval:[o.choosenInterval().start,o.choosenInterval().end],point_id:o.choosenPoint().id,products:[]};for(var l=o.products.length-1;l>=0;l--)n.products.push(o.products[l].id);r.push(n)}t=a.serializeArray(),t.push({name:"order[delivery_type_id]",value:e.OrderModel.choosenDeliveryTypeId}),t.push({name:"order[part]",value:JSON.stringify(r)}),console.log(t),$.ajax({url:a.attr("action"),timeout:12e4,type:"POST",data:t,success:k})},b=function b(){return console.info("завершить оформление заказа"),o.validate({onInvalid:function(e){console.warn("invalid"),console.log(e),$.scrollTo(e[e.length-1].fieldNode,500,{offset:-15})},onValid:D}),!1},P=function P(){for(var e=r.length-1;e>=0;e--)if(i.val()===r[e].label)return;i.val("")},B=function B(e,t){t?(o.setValidate(d,{require:!0,customErr:"Не введено название улицы",validateOnChange:!0}),o.setValidate(s,{require:!0,customErr:"Не введен номер дома",validateOnChange:!0}),void 0!==r&&o.setValidate(i,{fieldNode:i,customErr:"Не выбрана станция метро",require:!0,validateOnChange:!0})):(o.setValidate(d,{require:!1}),o.setValidate(s,{require:!1}),void 0!==r&&o.setValidate(i,{require:!1})),console.info("Изменен тип доставки"),console.log(o)};c.mask("* ****** ******",{placeholder:"*"}),p.mask("(999) 999-99-99"),a.mask("(999) 999-99-99"),e.docCookies.getItem("emails")&&(console.log("AB TEST: e-mail require"),o.setValidate(n,{require:!0})),void 0!==r&&(i.autocomplete(f),i.bind("change",P));var M=function M(e){var o=null;console.info("defaultValueToField");for(var r in e)console.log("поле "+r),e[r]&&(console.log("для поля есть значение "+e[r]),o=$('input[name="'+r+'"]'),"text"===o.attr("type")&&o.val(e[r]),"radio"===o.attr("type")&&o.filter('[value="'+e[r]+'"]').attr("checked","checked"))};M($("#jsOrderForm").data("value")),$("body").bind("orderdeliverychange",B),h.bind("click",b)}(this),function(e){console.info("Логика разбиения заказа для оформления заказа v.5");var o=function o(o){var r={},t=[],n=[],a=null,i=null,l=null,d=null,s=e.OrderModel.orderDictionary.orderData.discounts;e.OrderModel.createdBox={},e.OrderModel.deliveryBoxes.removeAll(),$("#"+e.OrderModel.deliveryTypesButton).attr("checked","checked"),e.OrderModel.totalSum(0),e.OrderModel.hasHomeDelivery(!1),$("body").trigger("orderdeliverychange",[!1]),e.OrderModel.couponsBox(s);for(var c=0,u=o.length;u>c;c++)if(l=o[c],console.info("перебирем метод "+l),n=[],e.OrderModel.orderDictionary.hasDeliveryState(l)){t=e.OrderModel.orderDictionary.getProductFromState(l);for(var p=t.length-1;p>=0;p--)d=t[p],r[d]?console.log("товар "+d+" уже определялся к блоку"):(console.log("добавляем товар "+d+" в блок для метода "+l),r[d]=!0,n.push(e.OrderModel.orderDictionary.getProductById(d)));n.length&&(a=e.OrderModel.orderDictionary.hasPointDelivery(l)?e.OrderModel.choosenPoint():0,i=l+"_"+a,void 0!==e.OrderModel.createdBox[i]?e.OrderModel.createdBox[i].addProductGroup(n):e.OrderModel.createdBox[i]=new DeliveryBox(n,l,a,e.OrderModel))}else console.info("для метода "+l+" нет товаров");console.info("Созданные блоки:"),console.log(e.OrderModel.createdBox),r.length!==e.OrderModel.orderDictionary.orderData.products.length&&console.warn("не все товары были обработаны")};ko.bindingHandlers.popupShower={update:function(o,r){var t=r(),n=ko.utils.unwrapObservable(t),a=null;n?(a=new CreateMap("pointPopupMap",e.OrderModel.popupWithPoints().points,$("#mapInfoBlock")),$(o).lightbox_me({centered:!0,onClose:function(){console.info("закрываем"),t(!1)}})):($("#pointPopupMap").empty(),$(o).trigger("close"))}},ko.bindingHandlers.paymentMethodVisible={update:function(e,o){var r=o(),t=ko.utils.unwrapObservable(r),n=parseInt($(e).data("value")["max-sum"],10);isNaN(n)||(t>n?$(e).hide():$(e).show())}},e.OrderModel={updateUrl:$("#jsOrderDelivery").data("url"),prepareData:ko.observable(!1),showPopupWithPoints:ko.observable(!1),deliveryTypesButton:null,tmpStatesPriority:null,statesPriority:null,orderDictionary:null,choosenPoint:ko.observable(),hasHomeDelivery:ko.observable(!1),deliveryTypes:ko.observableArray([]),deliveryBoxes:ko.observableArray([]),createdBox:{},popupWithPoints:ko.observable({}),totalSum:ko.observable(0),couponNumber:ko.observable(),couponUrl:ko.observable($(".bSaleData .jsCustomRadio").eq(0).val()),couponError:ko.observable(),couponsBox:ko.observableArray([]),blockScreen:{noti:null,block:function(e){var o=this;console.warn("block screen"),o.noti&&o.unblock(),o.noti=$("<div>").addClass("noti").html('<div><img src="/images/ajaxnoti.gif" /></br></br> '+e+"</div>"),o.noti.appendTo("body"),o.noti.lightbox_me({centered:!0,closeClick:!1,closeEsc:!1,onClose:function(){o.noti.remove()}})},unblock:function(){console.warn("unblock screen"),this.noti.trigger("close")}},checkCoupon:function(){console.info("проверяем купон");var o={number:e.OrderModel.couponNumber()},r=e.OrderModel.couponUrl(),t=function t(o){return e.OrderModel.blockScreen.block("Применяем купон"),o.success?(e.OrderModel.modelUpdate(),void 0):(e.OrderModel.couponError(o.error.message),e.OrderModel.blockScreen.unblock(),void 0)};return e.OrderModel.couponError(""),void 0===r?(console.warn("Не выбран тип сертификата"),e.OrderModel.couponError("Не выбран тип сертификата"),void 0):void 0!==o.number&&o.number.length?($.ajax({type:"POST",url:r,data:o,success:t}),void 0):(console.warn("Не введен номер сертификата"),e.OrderModel.couponError("Не введен номер сертификата"),void 0)},selectPoint:function(r){return console.info("point selected..."),console.log(r.parentBoxToken),r.parentBoxToken?(console.log(e.OrderModel.createdBox[r.parentBoxToken]),e.OrderModel.createdBox[r.parentBoxToken].selectPoint.apply(e.OrderModel.createdBox[r.parentBoxToken],[r]),!1):(e.OrderModel.statesPriority=e.OrderModel.tmpStatesPriority,e.OrderModel.choosenPoint(r.id),e.OrderModel.showPopupWithPoints(!1),o(e.OrderModel.statesPriority),!1)},chooseDeliveryTypes:function(r,t){var n=r.states[0],a=t.target.htmlFor;return $("#"+a).attr("checked")?!1:(e.OrderModel.deliveryTypesButton=a,e.OrderModel.tmpStatesPriority=r.states,e.OrderModel.choosenDeliveryTypeId=r.id,e.OrderModel.orderDictionary.hasPointDelivery(n)?(e.OrderModel.popupWithPoints({header:r.description,points:e.OrderModel.orderDictionary.getAllPointsByState(n)}),e.OrderModel.showPopupWithPoints(!0),!1):(e.OrderModel.statesPriority=e.OrderModel.tmpStatesPriority,e.OrderModel.choosenPoint(0),o(e.OrderModel.statesPriority),!1))},modelUpdate:function(){console.info("обновление данных с сервера");var r=function r(r){a(r),e.OrderModel.blockScreen.unblock(),o(e.OrderModel.statesPriority)};$.ajax({type:"GET",url:e.OrderModel.updateUrl,success:r})},deleteItem:function(o){console.info("удаление товара"),e.OrderModel.blockScreen.block("Удаляем товар");var r=function r(o){return console.log(o),o.success?(e.OrderModel.modelUpdate(),void 0):(console.warn("не удалось удалить товар"),e.OrderModel.blockScreen.unblock(),!1)};return console.log(o.deleteUrl),$.ajax({type:"GET",url:o.deleteUrl,success:r}),!1}},ko.applyBindings(e.OrderModel);var r=function r(e){var o='<div class="popupbox width290"><div class="font18 pb18"> '+e+"</div>"+"</div>"+'<p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>',r=$("<div>").addClass("popup").html(o),t=$.Deferred();r.appendTo("body");var n=function(){r.trigger("close"),r.remove(),t.resolve()};return r.lightbox_me({centered:!0,closeClick:!1,closeEsc:!1}),r.find(".closePopup").bind("click",n),t.promise()},t={800:function(e){var o="Товар "+e.name+" недоступен для продажи.",t=$.Deferred();return $.when(r(o)).then(function(){$.ajax({type:"GET",url:e.deleteUrl}).then(t.resolve)}),t.promise()},708:function(e){var o="Вы заказали товар "+e.name+" в количестве "+e.quantity+" шт. <br/ >"+e.error.message,t=$.Deferred();return $.when(r(o)).then(function(){$.ajax({type:"GET",url:e.setUrl}).then(t.resolve)}),t.promise()}},n=function n(e){var o=null,r=[];for(o in e.products)e.products[o].error.code&&r.push(e.products[o]);var n=function n(e,o){var a=null;return 0>e?(console.warn("return"),o(),void 0):(a=r[e].error.code,$.when(t[a](r[e])).then(function(){var r=e-1;n(r,o)}),void 0)};n(r.length-1,function(){console.warn("1 этап закончен"),document.location.href=e.redirect})},a=function a(o){return o.success?(console.info("Данные с сервера получены"),e.OrderModel.orderDictionary=new OrderDictionary(o),e.OrderModel.deliveryTypes(o.deliveryTypes),e.OrderModel.prepareData(!0),void 0):(console.warn("Данные содержат ошибки"),console.log(o.error),n(o),!1)},i=function(o){return console.log("selectPointOnBaloon"),console.log(o),console.log($(this).data("pointid")),console.log($(this).data("parentbox")),e.OrderModel.selectPoint({id:$(this).data("pointid"),parentBoxToken:$(this).data("parentbox")}),!1};$("body").on("click",".shopchoose",i),a($("#jsOrderDelivery").data("value"))}(this);