function DeliveryBox(e,t,o,r,a){console.info("Cоздание блока доставки "+t+" для "+o);var i=this;i.OrderModel=a,i.createdBox=r,i.token=t+"_"+o,i.products=[],i.fullPrice=0,i.state=t,i.deliveryName=i.OrderModel.orderDictionary.getNameOfState(t),i.deliveryPrice=Number.POSITIVE_INFINITY,i.choosenDate=ko.observable(),i.choosenPoint=ko.observable({id:o}),i.choosenInterval=ko.observable(),i.showPopupWithPoints=ko.observable(!1),i.hasPointDelivery=i.OrderModel.orderDictionary.hasPointDelivery(t),i.allDatesForBlock=ko.observableArray([]),i.pointList=ko.observableArray([]),i.hasPointDelivery&&i.choosenPoint(i.OrderModel.orderDictionary.getPointByStateAndId(i.state,o)),i.addProductGroup(e),i.OrderModel.deliveryBoxes.push(i)}function OrderDictionary(e){this.orderData=e,this.serverTime=this.orderData.time,this.deliveryTypes=this.orderData.deliveryTypes,this.deliveryStates=this.orderData.deliveryStates,this.pointsByDelivery=this.orderData.pointsByDelivery,this.products=this.orderData.products}DeliveryBox.prototype._makePointList=function(){var e=this,t=!0;for(var o in e.products[0].deliveries){for(var r=e.products.length-1;r>=0&&(t=e.products[r].deliveries.hasOwnProperty(o),t);r--);t&&e.pointList.push(e.OrderModel.orderDictionary.getPointByStateAndId(e.state,o))}},DeliveryBox.prototype.selectPoint=function(e){var t=this,o=t.state+"_"+e.id;return void 0!==t.createdBox[o]?(t.createdBox[o].addProductGroup(t.products),delete t.createdBox[t.token]):(t.createdBox[o]=t.createdBox[t.token],delete t.createdBox[t.token],t.token=o,t.choosenPoint(e)),t.showPopupWithPoints(!1),!1},DeliveryBox.prototype.changePoint=function(){var e=this;return e.showPopupWithPoints(!0),!1},DeliveryBox.prototype._getFirstPropertyName=function(e){for(var t in e)return t},DeliveryBox.prototype._addProduct=function(e){var t=this,o=null,r=null,a=null,i=[];return e.deliveries[t.state].hasOwnProperty(t.choosenPoint().id)?(o=parseInt(e.deliveries[t.state][t.choosenPoint().id].price,10),t.deliveryPrice=t.deliveryPrice>o?o:t.deliveryPrice,t.fullPrice+=e.sum,t.products.push({name:e.name,price:e.sum,quantity:e.quantity,deleteUrl:e.deleteUrl,productUrl:e.url,productImg:e.image,deliveries:e.deliveries[t.state]}),void 0):(console.warn("Для товара "+e.id+" нет пункта доставки "+t.choosenPoint().id+" Необходимо создать новый блок"),a=t._getFirstPropertyName(e.deliveries[t.state]),r=t.state+"_"+a,i.push(e),void 0!==t.createdBox[r]?t.createdBox[r].addProductGroup(e):t.createdBox[r]=new DeliveryBox(i,t.state,a,t.createdBox,t.OrderModel),void 0)},DeliveryBox.prototype.addProductGroup=function(e){for(var t=this,o=e.length-1;o>=0;o--)t._addProduct(e[o]);this.calculateDate(),t.hasPointDelivery&&t._makePointList()},DeliveryBox.prototype._getNameDayOfWeek=function(e){var t=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"];return t[e]},DeliveryBox.prototype._hasDateInAllProducts=function(e){for(var t=this,o=null,r=null,a=!0,i=t.products.length-1;i>=0;i--){o=t.products[i].deliveries[t.choosenPoint().id].dates;for(var l=0,n=o.length;n>l;l++){if(r=o[l].value,r===e){a=!0;break}a=!1}if(!a)break}return a},DeliveryBox.prototype.clickCalendarDay=function(e){var t=this;return e.avalible?(t.choosenDate(e),void 0):!1},DeliveryBox.prototype.calculateDate=function(){console.info("Вычисление общей даты для продуктов в блоке");var e=this,t=e.OrderModel.orderDictionary.getToday(),o=null,r=null;if(console.log("Сегодняшняя дата с сервера "+t),!e.products.length)return console.warn("в блоке нет товаров"),void 0;o=e.products[0].deliveries[e.choosenPoint().id].dates;for(var a=0,i=o.length;i>a;a++)r=o[a].value,e._hasDateInAllProducts(r)&&r>=t&&(o[a].avalible=!0,o[a].humanDayOfWeek=e._getNameDayOfWeek(o[a].dayOfWeek),e.allDatesForBlock.push(o[a]));e.choosenDate(e.allDatesForBlock()[0]),e.choosenInterval(e.choosenDate().intervals[0]),e.makeCalendar()},DeliveryBox.prototype.makeCalendar=function(){var e=this,t=0,o=null,r={},a=null,i=864e5;if(1!==e.allDatesForBlock()[0].dayOfWeek){t=0===e.allDatesForBlock()[0].dayOfWeek?6:e.allDatesForBlock()[0].dayOfWeek-1,a=e.allDatesForBlock()[0].value;for(var l=t;l>0;l--)o=e.allDatesForBlock()[0].dayOfWeek-1,a-=i,r={avalible:!1,humanDayOfWeek:e._getNameDayOfWeek(o),dayOfWeek:o,day:new Date(a).getDate()},e.allDatesForBlock.unshift(r)}if(0!==e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek){t=7-e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek,a=e.allDatesForBlock()[e.allDatesForBlock().length-1].value;for(var n=t;n>0;n--)o=7===e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek+1?0:e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek+1,a+=i,r={avalible:!1,humanDayOfWeek:e._getNameDayOfWeek(o),dayOfWeek:o,day:new Date(a).getDate()},e.allDatesForBlock.push(r)}},OrderDictionary.prototype.getNameOfState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].name:(console.warn("Не найден метод доставки "+e),!1)},OrderDictionary.prototype.getToday=function(){return this.serverTime},OrderDictionary.prototype.hasDeliveryState=function(e){return this.deliveryStates.hasOwnProperty(e)},OrderDictionary.prototype.hasPointDelivery=function(e){return this.pointsByDelivery.hasOwnProperty(e)},OrderDictionary.prototype.getPointByStateAndId=function(e,t){var o=this.getAllPointsByState(e);t+="";for(var r=o.length-1;r>=0;r--)if(o[r].id===t)return o[r]},OrderDictionary.prototype.getAllPointsByState=function(e){var t=this.pointsByDelivery[e];return this.orderData[t]},OrderDictionary.prototype.getProductFromState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].products:(console.warn("Не найден метод доставки "+e),!1)},OrderDictionary.prototype.getProductById=function(e){return this.products.hasOwnProperty(e)?this.products[e]:(console.warn("Такого продукта не найдено"),!1)},function(){console.info("Логика разбиения заказа для оформления заказа v.5");var e="/ajax/order-delivery",t=null,o={},r=function r(e){for(var r={},i=[],l=[],n=null,s=null,d=null,c=null,y=0,u=e.length;u>y;y++)if(d=e[y],console.info("перебирем метод "+d),l=[],a.orderDictionary.hasDeliveryState(d)){i=a.orderDictionary.getProductFromState(d);for(var p=i.length-1;p>=0;p--)c=i[p],r[c]?console.log("товар "+c+" уже определялся к блоку"):(console.log("добавляем товар "+c+" в блок для метода "+d),r[c]=!0,l.push(a.orderDictionary.getProductById(c)));l.length&&(n=a.orderDictionary.hasPointDelivery(d)?t:0,s=d+"_"+n,void 0!==o[s]?o[s].addProductGroup(l):o[s]=new DeliveryBox(l,d,n,o,a))}else console.info("для метода "+d+" нет товаров");console.info("Созданные блоки:"),console.log(o),r.length!==a.orderDictionary.orderData.products.length&&console.warn("не все товары были обработаны")},a={prepareData:ko.observable(!1),deliveryTypesButton:null,statesPriority:null,orderDictionary:null,deliveryTypes:ko.observableArray([]),deliveryBoxes:ko.observableArray([]),showPopupWithPoints:ko.observable(!1),popupWithPoints:ko.observable({}),selectPoint:function(e){return console.info("point selected..."),t=e.id,a.showPopupWithPoints(!1),a.deliveryTypesButton.attr("checked","checked"),r(a.statesPriority),!1},chooseDeliveryTypes:function(e,i){var l=e.states[0];return $("#"+i.target.htmlFor).attr("checked")?!1:(a.deliveryTypesButton=$("#"+i.target.htmlFor),a.statesPriority=e.states,o={},a.deliveryBoxes.removeAll(),a.orderDictionary.hasPointDelivery(l)?(a.popupWithPoints({header:e.description,points:a.orderDictionary.getAllPointsByState(l)}),a.showPopupWithPoints(!0),!1):(t=0,a.deliveryTypesButton.attr("checked","checked"),r(a.statesPriority),!1))}};ko.applyBindings(a);var i=function i(e){return e.success?(console.log("Данные с сервера получены"),a.orderDictionary=new OrderDictionary(e),a.deliveryTypes(e.deliveryTypes),a.prepareData(!0),void 0):(console.warn("произошла ошибка при получении данных с сервера"),console.log(e.error),!1)};$.ajax({type:"GET",url:e,success:i})}();