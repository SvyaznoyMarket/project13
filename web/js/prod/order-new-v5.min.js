(function(e){var t=(e.config.pageConfig.userUrl,e.constructors);t.DeliveryBox=function(){"use strict";function t(e,r,i){if(!(this instanceof t))return new t(e,r,i);console.info("Cоздание блока доставки "+r+" для "+i);var n=this;return n.isUnique=window.OrderModel.orderDictionary.isUniqueDeliveryState(r),n.token=r+"_"+i,n.products=[],n.fullPrice=0,n.totalBlockSum=0,n.state=r,n.deliveryName=window.OrderModel.orderDictionary.getNameOfState(r),n.deliveryPrice=Number.NEGATIVE_INFINITY,n.choosenDate=ko.observable(),n.choosenNameOfWeek=ko.observable(),n.choosenPoint=ko.observable({id:i}),n.choosenInterval=ko.observable(),n.showPopupWithPoints=ko.observable(!1),n.hasPointDelivery=window.OrderModel.orderDictionary.hasPointDelivery(r),n.allDatesForBlock=ko.observableArray([]),n.pointList=[],n.changePointButtonText=window.OrderModel.orderDictionary.getChangeButtonText(r),n.hasPointDelivery&&!window.OrderModel.orderDictionary.getPointByStateAndId(n.state,i)?(console.info("есть точки доставки для выбранного метода доставки, но выбранная точка не доступна для этого метода доставки. Берем первую точку для выбранного метода доставки"),n.choosenPoint(window.OrderModel.orderDictionary.getFirstPointByState(n.state))):n.hasPointDelivery?(console.info("есть точки доставки для выбранного метода доставки, и выбранная точка доступна для этого метода доставки"),n.choosenPoint(window.OrderModel.orderDictionary.getPointByStateAndId(n.state,i))):(console.info("для выбранного метода доставки не нужна точка доставки"),window.OrderModel.hasHomeDelivery(!0),$("body").trigger("orderdeliverychange",[!0])),n.calendarSliderLeft=ko.observable(0),n.addProductGroup(e),0===n.products.length?(console.warn("в блоке "+n.token+" не осталось товаров"),void 0):(window.OrderModel.deliveryBoxes.push(n),void 0)}return t.prototype._makePointList=function(){console.info("Создание списка точек доставки");var e=this,t=!0,r=null;for(var i in e.products[0].deliveries[e.state]){for(var n=e.products.length-1;n>=0&&(t=e.products[n].deliveries[e.state].hasOwnProperty(i),t);n--);t&&(r=window.OrderModel.orderDictionary.getPointByStateAndId(e.state,i),e.pointList.push(r))}console.log("Точки доставки созданы"),console.log(e.pointList)},t.prototype.addUniqueSuffix=function(e){e=e||"";var t;return t=Math.floor(1e4*Math.random()+1),e+="_"+t},t.prototype.selectPoint=function(e){var t=this,r=t.state+"_"+e.id,i=null;return window.OrderModel.hasDeliveryBox(r)?(i=global.OrderModel.getDeliveryBoxByToken(r),i.addProductGroup(t.products),window.OrderModel.removeDeliveryBox(t.token)):(t.isUnique&&(r+=t.addUniqueSuffix()),console.info("удаляем старый блок"),console.log("старый токен "+t.token),console.log("новый токен "+r),t.token=r,t.choosenPoint(window.OrderModel.orderDictionary.getPointByStateAndId(t.state,e.id)),console.log(window.OrderModel.deliveryBoxes()),window.OrderModel.paypalECS()&&(console.info("PayPal ECS включен. Необходимо сохранить выбранную точку доставки в cookie"),window.docCookies.setItem("chPoint_paypalECS",e.id,600))),window.OrderModel.showPopupWithPoints(!1),!1},t.prototype.changePoint=function(){for(var e=this,t=e.pointList.length-1;t>=0;t--)e.pointList[t].parentBoxToken=e.token;return window.OrderModel.popupWithPoints({header:"Выберите точку доставки",points:e.pointList}),window.OrderModel.showPopupWithPoints(!0),!1},t.prototype._getFirstPropertyName=function(e){for(var t in e)return t},t.prototype._addProduct=function(r){var i=this,n=null,o=null,a=null,s=[],l=null,c={};return r.deliveries[i.state].hasOwnProperty(i.choosenPoint().id)?(n=parseInt(r.deliveries[i.state][i.choosenPoint().id].price,10),i.deliveryPrice=n>i.deliveryPrice?n:i.deliveryPrice,c={id:r.id,name:r.name,price:r.sum?r.sum:r.price,quantity:r.quantity,deleteUrl:r.deleteUrl,productUrl:r.url,productImg:r.image?r.image:r.productImg,deliveries:{}},i.isUnique&&r.oldQuantity-1>0&&(console.log("Переделываем deleteUrl:"),console.log(c.deleteUrl),c.deleteUrl=c.deleteUrl.replace("delete-","add-"),c.deleteUrl+="?quantity="+(r.oldQuantity-1),console.log(c.deleteUrl)),c.deliveries[i.state]=r.deliveries[i.state],i.fullPrice=e.utils.numMethods.sumDecimal(c.price,i.fullPrice),i.products.push(c),void 0):(console.warn("Для товара "+r.id+" нет пункта доставки "+i.choosenPoint().id+" Необходимо создать новый блок"),a=i._getFirstPropertyName(r.deliveries[i.state]),o=i.state+"_"+a,s.push(r),window.OrderModel.hasDeliveryBox(o)?(console.log("Блок для этого типа доставки в этот пункт уже существует. Добавляем продукт в блок"),l=global.OrderModel.getDeliveryBoxByToken(o),l.addProductGroup(r),window.OrderModel.removeDeliveryBox(i.token)):(console.log("Блока для этого типа доставки в этот пункт еще существует"),new t(s,i.state,a)),void 0)},t.prototype.updateTotalPrice=function(){console.info("Перерасчет общей стоимости заказа");var t=this,r=window.OrderModel.totalSum();t.totalBlockSum=e.utils.numMethods.sumDecimal(t.fullPrice,t.deliveryPrice),r=e.utils.numMethods.sumDecimal(t.totalBlockSum,r),window.OrderModel.totalSum(r),console.log(window.OrderModel.totalSum())},t.prototype.addProductGroup=function(e){var t=this;console.info("добавляем товары в блок");for(var r=e.length-1;r>=0;r--)console.log(r+"ый пошел..."),console.log(e[r]),t._addProduct(e[r]);return t.products.length?(t.calculateDate(),t.updateTotalPrice(),t.hasPointDelivery&&(console.info("У товара есть точки доставки. Создаем список точек доставки"),t._makePointList()),void 0):(console.warn("в блоке "+t.token+" нет товаров"),void 0)},t.prototype._getNameDayOfWeek=function(e){var t=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"];return t[e]},t.prototype._getFullNameDayOfWeek=function(e){var t=["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"];return t[e]},t.prototype._hasDateInAllProducts=function(e){for(var t=this,r=null,i=null,n=!0,o=t.products.length-1;o>=0;o--){r=t.products[o].deliveries[t.state][t.choosenPoint().id].dates;for(var a=0,s=r.length;s>a;a++){if(i=r[a].value,i===e){n=!0;break}n=!1}if(!n)break}return n},t.prototype.clickCalendarDay=function(e){var t=this;return e.avalible?(window.OrderModel.paypalECS()&&(console.info("PayPal ECS включен. Необходимо сохранить выбранную дату в cookie"),window.docCookies.setItem("chDate_paypalECS",JSON.stringify(e),600)),t.choosenNameOfWeek(t._getFullNameDayOfWeek(e.dayOfWeek)),t.choosenDate(e),void 0):!1},t.prototype.calculateDate=function(){console.info("Вычисление общей даты для продуктов в блоке");var e=this,r=window.OrderModel.orderDictionary.getToday(),i=null,n=null,o="",a=null,s=[],l=null;console.log("Сегодняшняя дата с сервера "+r),i=e.products[0].deliveries[e.state][e.choosenPoint().id].dates;for(var c=0,u=i.length;u>c;c++)n=i[c].value,e._hasDateInAllProducts(n)&&n>=r&&(i[c].avalible=!0,i[c].humanDayOfWeek=e._getNameDayOfWeek(i[c].dayOfWeek),e.allDatesForBlock.push(i[c]));e.allDatesForBlock().length||(console.warn("нет общих дат для блока. Необходимо разделить продукты в блоке"),a=e.products.pop(),s.push(a),o=e.state+"_"+e.choosenPoint().id+"_"+e.addUniqueSuffix(),console.log("новый токен "+o),console.log(e),new t(s,e.state,e.choosenPoint().id),e.calculateDate()),window.OrderModel.paypalECS()&&window.docCookies.hasItem("chDate_paypalECS")?(console.info("PayPal ECS включен. Необходимо взять выбранную дату из cookie"),l=window.docCookies.getItem("chDate_paypalECS"),e.choosenDate(JSON.parse(l))):e.choosenDate(e.allDatesForBlock()[0]),e.choosenNameOfWeek(e._getFullNameDayOfWeek(e.choosenDate().dayOfWeek)),0!==e.choosenDate().intervals.length&&e.choosenInterval(e.choosenDate().intervals[0]),e.makeCalendar()},t.prototype.makeCalendar=function(){console.info("Создание календаря, округление до целых недель");var e,t,r,i=this,n=0,o={},a=null,s=null,l=864e5;for(r=0;i.allDatesForBlock().length-1>=r;r++){if(void 0===i.allDatesForBlock()[r+1]){console.info("Следущая дата последняя. заканчиваем цикл");break}o={},a=i.allDatesForBlock()[r].value+l,s=new Date(a),a!==i.allDatesForBlock()[r+1].value&&(o={value:a,avalible:!1,humanDayOfWeek:i._getNameDayOfWeek(s.getDay()),dayOfWeek:s.getDay(),day:s.getDate()},console.log("предыдущая дата была "+new Date(i.allDatesForBlock()[r].value).getDate()+" новая дата вклинилась "+s.getDate()+" следущая дата "+new Date(i.allDatesForBlock()[r+1].value).getDate()),i.allDatesForBlock.splice(r+1,0,o))}if(1!==i.allDatesForBlock()[0].dayOfWeek)for(n=0===i.allDatesForBlock()[0].dayOfWeek?6:i.allDatesForBlock()[0].dayOfWeek-1,a=i.allDatesForBlock()[0].value,e=n;e>0;e--)a-=l,s=new Date(a),o={avalible:!1,humanDayOfWeek:i._getNameDayOfWeek(s.getDay()),dayOfWeek:s.getDay(),day:s.getDate()},i.allDatesForBlock.unshift(o);if(0!==i.allDatesForBlock()[i.allDatesForBlock().length-1].dayOfWeek)for(n=7-i.allDatesForBlock()[i.allDatesForBlock().length-1].dayOfWeek,a=i.allDatesForBlock()[i.allDatesForBlock().length-1].value,t=n;t>0;t--)a+=l,s=new Date(a),o={avalible:!1,humanDayOfWeek:i._getNameDayOfWeek(s.getDay()),dayOfWeek:s.getDay(),day:s.getDate()},i.allDatesForBlock.push(o)},t.prototype.calendarLeftBtn=function(){var e=this,t=parseInt(e.calendarSliderLeft(),10);t+=380,e.calendarSliderLeft(t)},t.prototype.calendarRightBtn=function(){var e=this,t=parseInt(e.calendarSliderLeft(),10);t-=380,e.calendarSliderLeft(t)},t}()})(window.ENTER),function(){var e=$(".bBankWrap"),t=function t(){var t=e.find(".bBankLink"),r=e.find(".bBankLink__eName"),i=e.find(".bSelect"),n=$("#selectedBank"),o=e.find(".bSelectWrap_eText"),a=function a(){var e=$("option:selected",i).attr("data-link"),a=$("option:selected",i).val(),s=$("option:selected",i).html();o.html(s),r.html(s),n.val(a),t.attr("href",e)};$("option",i).eq(0).attr("selected","selected"),i.change(a),a(),DirectCredit.init($("#jsCreditBank").data("value"),$("#creditPrice"))};e.length&&t()}(this),function(e){var t=(e.config.pageConfig.userUrl,e.constructors);t.OrderDictionary=function(){"use strict";function t(e){return this instanceof t?(this.orderData=e,this.serverTime=this.orderData.time,this.deliveryTypes=this.orderData.deliveryTypes,this.deliveryStates=this.orderData.deliveryStates,this.pointsByDelivery=this.orderData.pointsByDelivery,this.products=this.orderData.products,void 0):new t(e)}return t.prototype.getNameOfState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].name:(console.warn("Не найден метод доставки "+e),!1)},t.prototype.getToday=function(){return this.serverTime},t.prototype.hasDeliveryState=function(e){return this.deliveryStates.hasOwnProperty(e)},t.prototype.isUniqueDeliveryState=function(e){if(this.hasDeliveryState(e)){var t=this.deliveryStates[e];return t.unique}return!1},t.prototype.hasPointDelivery=function(e){return this.hasDeliveryState(e)?this.pointsByDelivery.hasOwnProperty(e):!1},t.prototype.getPointByStateAndId=function(e,t){var r=this.getAllPointsByState(e);t+="";for(var i=r.length-1;i>=0;i--)if(r[i].id===t)return window.ENTER.utils.cloneObject(r[i]);return!1},t.prototype.getFirstPointByState=function(t){var r=this.getAllPointsByState(t);return r[0]?e.utils.cloneObject(r[0]):!1},t.prototype.getAllPointsByState=function(e){if(!this.hasDeliveryState(e))return!1;var t=this.pointsByDelivery[e],r=t?t.token:!1,i=r?this.orderData[r]:!1;return i||!1},t.prototype.getChangeButtonText=function(e){var t=this.pointsByDelivery[e]?this.pointsByDelivery[e].changeName:"Сменить";return t},t.prototype.getProductFromState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].products:(console.warn("Не найден метод доставки "+e),!1)},t.prototype.getProductById=function(e){return this.products.hasOwnProperty(e)?this.products[e]:(console.warn("Такого продукта не найдено"),!1)},t}()}(window.ENTER),function(){if(!$("#paymentMethod-10").length)return console.warn("нет метода оплаты сертификатом"),!1;var e=$("#paymentMethod-10").parent(),t=e.find(".mCardNumber"),r=e.find(".mCardPin"),i=e.find(".bPayMethodAction"),n=i.attr("data-url"),o=function(){var e=!1,o="processBlock",a=function a(){return t.val().replace(/[^0-9]/g,"")},s=function s(){return r.val().replace(/[^0-9]/g,"")},l=function l(){return{code:a(),pin:s()}},c=function c(){return e&&""!==a()&&14===a().length&&""!==s()&&4===s().length?!0:!1},u=function u(){return 4!==r.val().length?(console.warn("пин код мал"),!1):t.val().length?(h("mOrange","Проверка по номеру карты"),$.post(n,l(),function(e){if(!("success"in e))return!1;if(!e.success){var t=e.error!==void 0?e.error:"ERROR";return h("mRed",t),!1}h("mGreen",e.data)}),void 0):(console.warn("номер карты не введен"),!1)},h=function h(t,r){console.info("setProcessingStatus");var n=$(".process").first(),a={typeNum:t};switch(n.hasClass("picked")||n.remove(),t){case"mOrange":a.text=r,e=!1;break;case"mRed":a.text="Произошла ошибка: "+r,e=!1;break;case"mGreen":a.text="activated"in r?"Карта "+r.code+" на сумму "+r.sum+" активирована!":"Карта "+r.code+" имеет номинал "+r.sum,e=!0}i.after(tmpl(o,a)),r.activated!==void 0&&$(".process").first().addClass("picked")};return{checkCard:u,setProcessingStatus:h,isActive:c,getCode:a,getPIN:s}}();t.bind("change",function(){o.checkCard()}),r.bind("change",function(){o.checkCard()}),$.mask.definitions.n="[0-9]",r.mask("nnnn",{completed:o.checkCard,placeholder:"*"})}(this),function(e){var t={},r=$("#metrostations").data("name"),i=$("#order_recipient_first_name"),n=($("#order_recipient_last_name"),$("#order_recipient_email")),o=$("#order_recipient_phonenumbers"),a=$("#order_address_metro"),s=$("#order_subway_id"),l=$("#order_address_street"),c=$("#order_address_building"),u=$("#sclub-number"),h=$('.jsCustomRadio[name="order[payment_method_id]"]'),d=$("#qiwi-phone"),f=$("#order_agreed"),p=$("#completeOrder"),m=null,v=null,g=null,_={fields:[{fieldNode:i,require:!0,customErr:"Введите имя получателя",validateOnChange:!0},{fieldNode:n,validBy:"isEmail",customErr:"Некорректно введен e-mail",validateOnChange:!0},{fieldNode:o,require:!0,customErr:"Некорректно введен телефон",validateOnChange:!0},{fieldNode:f,require:!0,customErr:"Необходимо согласие"},{fieldNode:h,require:!0,customErr:"Необходимо выбрать метод оплаты"}]},E={source:r,appendTo:"#metrostations",minLength:2,select:function(e,t){s.val(t.item.val)}};t=new FormValidator(_);var y=function y(e,t){var r='<div class="popupbox width290"><div class="font18 pb18"> '+e+"</div>"+"</div>"+'<p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>',i=$("<div>").addClass("popup").html(r);i.appendTo("body");var n=function(){return i.trigger("close"),i.remove(),void 0!==t&&t(),!1};i.lightbox_me({centered:!0,onClose:n}),i.find(".closePopup").bind("click",n)},b=function b(e){console.warn("Ошибка в поле");var r=$('[name="order['+e.field+']"]'),i=function i(){t._unmarkFieldError($(this))};t._markFieldError(r,e.message),r.bind("focus",i)},T={"default":function(e){return console.log("Обработчик ошибки"),e.error&&e.error.message?(y(e.error.message,function(){document.location.href=e.redirect}),void 0):(document.location.href=e.redirect,void 0)},0:function(e){console.warn("Обработка ошибок формы");var t=null;if(e.redirect)return y(e.error.message,function(){document.location.href=e.redirect}),void 0;y(e.error.message);for(var r=e.form.error.length-1;r>=0;r--)t=e.form.error[r],console.warn(t),b(t);$.scrollTo($(".mError").eq(0),500,{offset:-15})},743:function(e){y(e.error.message)}},x=function x(){if("undefined"!=typeof _gaq){for(var t=e.OrderModel.deliveryBoxes().length-1;t>=0;t--)_gaq.push(["_trackEvent","Order card","Completed","выбрана "+e.OrderModel.choosenDeliveryTypeId+" доставят "+e.OrderModel.deliveryBoxes()[t].state]);_gaq.push(["_trackEvent","Order complete",e.OrderModel.deliveryBoxes().length,e.OrderModel.orderDictionary.products.length]),_gaq.push(["_trackTiming","Order complete","DB response",g])}"undefined"!=typeof yaCounter10503055&&yaCounter10503055.reachGoal("\\orders\\complete")},R=function R(t){return console.info("данные отправлены. получен ответ от сервера"),v=(new Date).getTime(),g=v-m,console.log(t),t.success?(x(),e.OrderModel.paypalECS()&&!p.hasClass("mConfirm")&&(console.info("PayPal ECS включен. Заказ оформлен. Необходимо удалить выбранные параметры из cookie"),window.docCookies.removeItem("chDate_paypalECS","/"),window.docCookies.removeItem("chTypeBtn_paypalECS","/"),window.docCookies.removeItem("chPoint_paypalECS","/"),window.docCookies.removeItem("chTypeId_paypalECS","/"),window.docCookies.removeItem("chStetesPriority_paypalECS","/")),document.location.href=t.redirect,void 0):(console.log("ошибка оформления заказа"),e.ENTER.utils.blockScreen.unblock(),T.hasOwnProperty(t.error.code)?(console.log("Есть обработчик"),T[t.error.code](t)):(console.log("Стандартный обработчик"),T["default"](t)),!1)},w=function w(){var t,r,i,n=null,o=[],a=[],s={},l=$("#order-form");for(e.ENTER.utils.blockScreen.block("Ваш заказ оформляется"),a=l.serializeArray(),console.info("Перебираем блоки доставки"),r=e.OrderModel.deliveryBoxes().length-1;r>=0;r--){for(s={},n=e.OrderModel.deliveryBoxes()[r],t=n.choosenPoint(),console.log("currentDeliveryBox:"),console.log(n),s={deliveryMethod_token:n.state,date:n.choosenDate().value,interval:[n.choosenInterval()?n.choosenInterval().start:"",n.choosenInterval()?n.choosenInterval().end:""],point_id:t.id,products:[]},console.log("choosePoint:"),console.log(t),"pickpoint"===n.state&&(console.log("Is PickPoint!"),s.point_id=t.number,s.point_address={street:t.street,house:t.house},s.point_name=t.point_name),i=n.products.length-1;i>=0;i--)s.products.push(n.products[i].id);console.log("tmpPart:"),console.log(s),o.push(s)}a.push({name:"order[delivery_type_id]",value:e.OrderModel.choosenDeliveryTypeId}),a.push({name:"order[part]",value:JSON.stringify(o)}),window.KM!==void 0&&a.push({name:"kiss_session",value:window.KM.i}),console.log("dataToSend:"),console.log(a),m=(new Date).getTime(),$.ajax({url:l.attr("action"),timeout:12e4,type:"POST",data:a,success:R,statusCode:{500:function(){y("Неудалось создать заказ. Попробуйте позднее.")},504:function(){y("Неудалось создать заказ. Попробуйте позднее.")}}})},S=function S(){return console.info("Завершить оформление заказа"),e.OrderModel.lifeGift()?(w(),!1):(t.validate({onInvalid:function(e){console.warn("invalid"),console.log(e),$.scrollTo(e[e.length-1].fieldNode,500,{offset:-15})},onValid:w}),!1)},M=function M(){for(var e=r.length-1;e>=0;e--)if(a.val()===r[e].label)return;a.val("")},H=function H(e,i){i?(t.setValidate(l,{require:!0,customErr:"Не введено название улицы",validateOnChange:!0}),t.setValidate(c,{require:!0,customErr:"Не введен номер дома",validateOnChange:!0}),void 0!==r&&t.setValidate(a,{fieldNode:a,customErr:"Не выбрана станция метро",require:!0,validateOnChange:!0})):(t.setValidate(l,{require:!1}),t.setValidate(c,{require:!1}),void 0!==r&&t.setValidate(a,{require:!1})),console.info("Изменен тип доставки"),console.log(t)};$.mask.definitions.n="[0-9]",u.mask("2 98nnnn nnnnnn",{placeholder:"*"}),d.mask("(nnn) nnn-nn-nn"),o.mask("(nnn) nnn-nn-nn"),e.docCookies.getItem("emails")&&(console.log("AB TEST: e-mail require"),t.setValidate(n,{require:!0}));var C=function C(e){var t=null;console.info("defaultValueToField");for(var r in e)if(console.log("поле "+r),e[r]){if(console.log("для поля есть значение "+e[r]),t=$('input[name="'+r+'"]'),"radio"===t.attr("type")){t.filter('[value="'+e[r]+'"]').attr("checked","checked").trigger("change");continue}t.val(e[r])}};if(C($("#jsOrderForm").data("value")),void 0!==r){a.autocomplete(E),a.bind("change",M);for(var A=r.length-1;A>=0;A--)if(parseInt(s.val(),10)===r[A].val){a.val(r[A].label);break}}$("body").bind("orderdeliverychange",H),p.bind("click",S)}(this),function(e){var t=$("#jsOrderDelivery").data("value"),r=e.ENTER.utils,i=function i(t){var r={},i=[],o=[],a=null,s=null,l=null,c=null,u=null,h=null,d=[];discounts=e.OrderModel.orderDictionary.orderData.discounts,e.OrderModel.paypalECS()&&(console.info("PayPal ECS включен. Необходимо сохранить выбранные параметры в cookie"),window.docCookies.setItem("chTypeBtn_paypalECS",e.OrderModel.deliveryTypesButton,600),window.docCookies.setItem("chPoint_paypalECS",e.OrderModel.choosenPoint(),600),window.docCookies.setItem("chTypeId_paypalECS",e.OrderModel.choosenDeliveryTypeId,600),window.docCookies.setItem("chStetesPriority_paypalECS",JSON.stringify(e.OrderModel.statesPriority),600)),e.OrderModel.deliveryBoxes.removeAll(),e.OrderModel.hasCoupons(!1),console.log("Маркируем выбранный способ доставки"),$("#"+e.OrderModel.deliveryTypesButton).attr("checked","checked").trigger("change"),e.OrderModel.totalSum(0),e.OrderModel.hasHomeDelivery(!1),$("body").trigger("orderdeliverychange",[!1]);for(var f=0,p=t.length;p>f;f++)if(l=t[f],h=e.OrderModel.orderDictionary.isUniqueDeliveryState(l),console.info("перебирем "+(h?"уникальный* ":"")+"метод "+l),o=[],e.OrderModel.orderDictionary.hasDeliveryState(l)){i=e.OrderModel.orderDictionary.getProductFromState(l);for(var m=i.length-1;m>=0;m--)c=i[m],r[c]?console.log("товар "+c+" уже определялся к блоку"):(console.log("добавляем товар "+c+" в блок для метода "+l),r[c]=!0,o.push(e.OrderModel.orderDictionary.getProductById(c)));if(o.length)if(a=e.OrderModel.orderDictionary.hasPointDelivery(l)?e.OrderModel.choosenPoint():0,s=l+"_"+a,e.OrderModel.hasDeliveryBox(s))u=e.OrderModel.getDeliveryBoxByToken(s),u.addProductGroup(o);else if(h)for(d=e.OrderModel.prepareProductsQuantityByUniq(o),m=d.length-1;m>=0;m--)c=[d[m]],e.ENTER.constructors.DeliveryBox(c,l,a);else e.ENTER.constructors.DeliveryBox(o,l,a)}else console.info("для метода "+l+" нет товаров");if(console.info("Созданные блоки:"),console.log(e.OrderModel.deliveryBoxes()),e.OrderModel.couponsBox(discounts),e.OrderModel.couponsBox(discounts),e.OrderModel.couponUrl($(".bSaleList__eItem:visible .jsCustomRadio").eq(0).val()),$(".bSaleList__eItem:visible .jsCustomRadio").eq(0).trigger("change"),$(".bPayMethod:visible .jsCustomRadio").eq(0).attr("checked","checked").trigger("change"),e.OrderModel.hasCoupons()&&e.OrderModel.deliveryBoxes().length>1||e.OrderModel.appliedCoupon()&&e.OrderModel.appliedCoupon().sum&&parseFloat(e.OrderModel.totalSum())<=parseFloat(e.OrderModel.appliedCoupon().sum)){console.warn("Нужно удалить купон");var v="Купон не может быть применен при текущем разбиении заказа и будет удален",g=function(){console.log("удаление"),e.OrderModel.deleteItem(e.OrderModel.appliedCoupon())};return $.when(n(v)).then(g),!1}r.length!==e.OrderModel.orderDictionary.orderData.products.length&&console.warn("не все товары были обработаны"),console.warn("end")};ko.bindingHandlers.popupShower={update:function(t,r){var i=r(),n=ko.utils.unwrapObservable(i),o=null;n?(o=new e.ENTER.constructors.CreateMap("pointPopupMap",e.OrderModel.popupWithPoints().points,$("#mapInfoBlock")),$(t).lightbox_me({centered:!0,onClose:function(){console.info("закрываем"),i(!1)}})):($("#pointPopupMap").empty(),$(t).trigger("close"))}},ko.bindingHandlers.payBlockVisible={update:function(t){var r,i,n=$(t),o=n.data("vars"),a=o&&o.toHide?o.toHide:!1,s=e.OrderModel.choosenDeliveryTypeId,l=e.OrderModel.deliveryBoxes(),c=l.length,u=1;if(c){if(1==c?(u=0,console.log("Кол-во deliveryBoxes == 1: Показываем payBlock")):(u=1,console.log("Кол-во deliveryBoxes > 1: Скрываем payBlock")),a)for(r in a)if(void 0===a[r].length)$.inArray(s,a)>=0&&(u=1,console.log("toHide NoArr: Скрываем payBlock"));else if(s==r)for(i in a[r])i==o.typeId&&(u=1,console.log("toHide Arr: Скрываем payBlock"));u?n.hide():n.show()}}},ko.bindingHandlers.paymentMethodVisible={update:function(t,r){var i=r(),n=ko.utils.unwrapObservable(i),o=$(t),a=o.data("value"),s=parseInt(a["max-sum"],10),l=a.method_id,c=a.isAvailableToPickpoint;return 6===e.OrderModel.choosenDeliveryTypeId&&0==c||4===e.OrderModel.choosenDeliveryTypeId&&13===l&&e.OrderModel.lifeGift()===!1||!isNaN(s)&&n>s?(o.hide(),void 0):(13===l&&o.show(),isNaN(s)||(n>s?o.hide():o.show()),void 0)}},ko.bindingHandlers.calendarSlider={update:function(e,t,r,i,n){var o=$(e),a=t(),s=o.find(".bBuyingDatesItem"),l=s.width()+parseInt(s.css("marginRight"),10)+parseInt(s.css("marginLeft"),10);return o.width(s.length*l),a>0?(a-=380,n.box.calendarSliderLeft(a),void 0):-o.width()>a?(a+=380,n.box.calendarSliderLeft(a),void 0):(o.animate({left:a}),void 0)}},ko.bindingHandlers.couponsVisible={update:function(t,r){var i=r(),n=ko.utils.unwrapObservable(i),o=$(t),a=o.find(".mSaleInput"),s=o.find(".mSaleBtn"),l=o.find(".bSaleData__eEmptyBlock");$(".bSaleList__eItem").removeClass("hidden");for(var c=n.length-1;c>=0;c--)o.find('.bSaleList__eItem[data-type="'+n[c].type+'"]').addClass("hidden"),"coupon"===n[c].type&&(console.log("Есть примененный купон"),e.OrderModel.hasCoupons(!0),e.OrderModel.appliedCoupon(n[c]));$(".bSaleList__eItem.hidden").length===$(".bSaleList__eItem").length||$(".bSaleList__eItem:hidden").length===$(".bSaleList__eItem").length?(a.attr("disabled","disabled"),s.attr("disabled","disabled").addClass("mDisabled"),l.show()):(a.removeAttr("disabled"),s.removeAttr("disabled").removeClass("mDisabled"),l.hide())}},e.OrderModel={updateUrl:$("#jsOrderDelivery").data("url"),prepareData:ko.observable(!1),showPopupWithPoints:ko.observable(!1),deliveryTypesButton:null,tmpStatesPriority:null,statesPriority:null,lifeGift:ko.observable(!1),paypalECS:ko.observable(!1),cartSum:null,orderDictionary:null,choosenPoint:ko.observable(),hasHomeDelivery:ko.observable(!1),deliveryTypes:ko.observableArray([]),deliveryBoxes:ko.observableArray([]),popupWithPoints:ko.observable({}),totalSum:ko.observable(0),hasCoupons:ko.observable(!1),appliedCoupon:ko.observable(),couponNumber:ko.observable(),couponUrl:ko.observable(),couponError:ko.observable(),couponsBox:ko.observableArray([]),hasDeliveryBox:function(t){console.info("Существует ли блок доставки "+t);var r=null;for(r=e.OrderModel.deliveryBoxes().length-1;r>=0;r--)if(e.OrderModel.deliveryBoxes()[r].token===t)return!0;return!1},getDeliveryBoxByToken:function(t){console.info("Получить ссылку на блок по токену "+t);var r=null;for(r=e.OrderModel.deliveryBoxes().length-1;r>=0;r--)if(e.OrderModel.deliveryBoxes()[r].token===t)return e.OrderModel.deliveryBoxes()[r]},removeDeliveryBox:function(t){console.info("Удаление блока по токену "+t);var r=null;for(r=e.OrderModel.deliveryBoxes().length-1;r>=0;r--)if(e.OrderModel.deliveryBoxes()[r].token===t)return e.OrderModel.deliveryBoxes().splice(r,1),void 0},checkCoupon:function(){console.info("проверяем купон");var t,i={number:e.OrderModel.couponNumber()},n=e.OrderModel.couponUrl(),o=function o(t){return t.success?(e.OrderModel.couponNumber(""),void 0):(e.OrderModel.couponError(t.error.message),r.blockScreen.unblock(),void 0)};return e.OrderModel.couponError(""),void 0===n?(console.warn("Не выбран тип сертификата"),e.OrderModel.couponError("Не выбран тип сертификата"),void 0):void 0!==i.number&&i.number.length?(r.blockScreen.block("Применяем купон"),t=[{type:"POST",url:n,data:i,callback:o},{type:"GET",url:e.OrderModel.updateUrl,callback:e.OrderModel.modelUpdate}],r.packageReq(t),!1):(console.warn("Не введен номер сертификата"),e.OrderModel.couponError("Не введен номер сертификата"),void 0)},selectPoint:function(t){console.info("point selected..."),console.log(t.parentBoxToken);var r=null;return t.parentBoxToken?(r=e.OrderModel.getDeliveryBoxByToken(t.parentBoxToken),console.log(r),r.selectPoint.apply(r,[t]),!1):(e.OrderModel.statesPriority=e.OrderModel.tmpStatesPriority,e.OrderModel.choosenPoint(t.id),e.OrderModel.showPopupWithPoints(!1),i(e.OrderModel.statesPriority),!1)},chooseDeliveryTypes:function(t,r){var n=t.states[0],o=r.target.htmlFor;return $("#"+o).attr("checked")?!1:(e.OrderModel.deliveryTypesButton=o,e.OrderModel.tmpStatesPriority=t.states,e.OrderModel.choosenDeliveryTypeId=t.id,e.OrderModel.orderDictionary.hasPointDelivery(n)?(e.OrderModel.popupWithPoints({header:t.name,points:e.OrderModel.orderDictionary.getAllPointsByState(n)}),e.OrderModel.showPopupWithPoints(!0),!1):(e.OrderModel.statesPriority=e.OrderModel.tmpStatesPriority,e.OrderModel.choosenPoint(0),i(e.OrderModel.statesPriority),!1))},modelUpdate:function(t){console.info("обновление данных с сервера"),s(t),i(e.OrderModel.statesPriority)},deleteItem:function(t){console.info("удаление товара");var i=null;r.blockScreen.block("Удаляем");var n=function n(){var r=e.OrderModel.orderDictionary.products,i=0,n=0,o={};if(!t.product)return!1;for(var a in r)i+=a[a].price,n+=a[a].quantity;o={"Checkout Step 1 SKU Quantity":n,"Checkout Step 1 SKU Total":i},"undefined"!=typeof _kmq&&_kmq.push(["set",o]),"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Order card","Item deleted"])},o=function o(e){if(console.info("deleteItemResponceHandler"),console.log(e),!e.success)return console.warn("не удалось удалить товар"),r.blockScreen.unblock(),!1;if(("undefined"!=typeof _gaq||"undefined"!=typeof _kmq)&&n(),e.product){var t=e.product.id,i=e.category_id;(function(e){var t=document,r=t.createElement("IMG"),i=t.body;e=e.replace(/!\[rnd\]/,Math.round(9999999*Math.random()))+"&tail256="+escape(t.referrer||"unknown"),r.style.position="absolute",r.style.width=r.style.height="0px",r.onload=r.onerror=function(){i.removeChild(r),r=i=null},r.src=e,i.insertBefore(r,i.firstChild)})("http://ad.adriver.ru/cgi-bin/rle.cgi?sid=182615&sz=del_basket&bt=55&pz=0&custom=10="+t+";11="+i+"&![rnd]")}};return console.log(t.deleteUrl),i=[{type:"GET",url:t.deleteUrl,callback:o},{type:"GET",url:e.OrderModel.updateUrl,callback:window.OrderModel.modelUpdate}],r.packageReq(i),!1},prepareProductsQuantityByUniq:function(e){var t,r,i,n=[];for(r=e.length-1;r>=0;r--)for(t=ENTER.utils.cloneObject(e[r]),t.sum=t.price,t.quantity=1,t.oldQuantity=e[r].quantity,i=e[r].quantity-1;i>=0;i--)n.push(t);return n}},ko.applyBindings(e.OrderModel);var n=function n(e){var t='<div class="popupbox width290"><div class="font18 pb18"> '+e+"</div>"+"</div>"+'<p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>',r=$("<div>").addClass("popup").html(t),i=$.Deferred();r.appendTo("body");var n=function(){r.trigger("close"),r.remove(),i.resolve()};return r.lightbox_me({centered:!0,closeClick:!1,closeEsc:!1}),r.find(".closePopup").bind("click",n),i.promise()},o={"default":function(e){var t="Товар "+e.name+" недоступен для продажи.",r=$.Deferred();return $.when(n(t)).then(function(){$.ajax({type:"GET",url:e.deleteUrl}).then(r.resolve)}),r.promise()},708:function(e){var t="",r=$.Deferred();return t=e.name&&e.error.message&&e.quantity?"Вы заказали товар "+e.name+" в количестве "+e.quantity+" шт. <br/ >"+e.error.message:"Товар недоступен для продажи",$.when(n(t)).then(function(){$.ajax({type:"GET",url:e.setUrl}).then(r.resolve)}),r.promise()}},a=function a(e){var t=null,r=[];for(t in e.products)e.products[t].error&&e.products[t].error.code&&r.push(e.products[t]);var i=function i(e,t){var n=null;return 0>e?(console.warn("return"),t(),void 0):(n=r[e].error.code,n=o.hasOwnProperty(n)?n:"default",$.when(o[n](r[e])).then(function(){var r=e-1;i(r,t)}),void 0)};0===r.length&&e.error.message?$.when(n(e.error.message)).then(function(){e.redirect&&(document.location.href=e.redirect)}):i(r.length-1,function(){console.warn("1 этап закончен"),e.redirect&&(document.location.href=e.redirect)})},s=function s(t){var n,o;return r.blockScreen.unblock(),t.success?(console.info("Данные с сервера получены"),e.OrderModel.orderDictionary=new e.ENTER.constructors.OrderDictionary(t),t.paypalECS&&(console.info("paypal true"),e.OrderModel.paypalECS(!0)),t.cart&&t.cart.sum&&(console.info("Есть первоначальная сумма корзины : "+t.cart.sum),e.OrderModel.cartSum=t.cart.sum),e.OrderModel.deliveryTypes(t.deliveryTypes),e.OrderModel.lifeGift(t.lifeGift||!1),e.OrderModel.prepareData(!0),e.OrderModel.paypalECS()&&window.docCookies.hasItem("chTypeBtn_paypalECS")&&window.docCookies.hasItem("chPoint_paypalECS")&&window.docCookies.hasItem("chTypeId_paypalECS")&&window.docCookies.hasItem("chStetesPriority_paypalECS")&&(console.info("PayPal ECS включен. Необходимо применить параметры из cookie"),e.OrderModel.deliveryTypesButton=window.docCookies.getItem("chTypeBtn_paypalECS"),e.OrderModel.choosenPoint(window.docCookies.getItem("chPoint_paypalECS")),e.OrderModel.choosenDeliveryTypeId=window.docCookies.getItem("chTypeId_paypalECS"),e.OrderModel.statesPriority=JSON.parse(window.docCookies.getItem("chStetesPriority_paypalECS")),i(e.OrderModel.statesPriority)),1===t.deliveryTypes.length&&(n=t.deliveryTypes[0],o=e.OrderModel.orderDictionary.getFirstPointByState(n.states[0])||n.id,console.log("Обнаружен только 1 способ доставки: "+n.name+" — выбираем его."),console.log("Выбран первый пункт* доставки:"),console.log(o),e.OrderModel.statesPriority=n.states,e.OrderModel.deliveryTypesButton="method_"+n.id,e.OrderModel.choosenDeliveryTypeId=n.id,e.OrderModel.choosenPoint(o),i(e.OrderModel.statesPriority)),void 0):(console.warn("Данные содержат ошибки"),console.log(t.error),a(t),!1)
},l=function l(t){return console.log("selectPointOnBaloon"),console.log(t),console.log($(this).data("pointid")),console.log($(this).data("parentbox")),e.OrderModel.selectPoint({id:$(this).data("pointid"),parentBoxToken:$(this).data("parentbox")}),!1},c=function(e){console.info("analyticsStep_1");var t=0,r=0,i=[],n={};for(var o in e.products)t+=e.products[o].price,r+=e.products[o].quantity,i.push({id:e.products[o].id,name:e.products[o].name,price:e.products[o].price,quantity:e.products[o].quantity});n={"Checkout Step 1 SKU Quantity":r,"Checkout Step 1 SKU Total":t,"Checkout Step 1 Order Type":"cart order"},"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","New order","Items",r]),"undefined"!=typeof _kmq&&_kmq.push(["record","Checkout Step 1",n]),window.APRT_DATA=window.APRT_DATA||{},window.APRT_DATA.pageType=5,window.APRT_DATA.orderInfo=window.APRT_DATA.orderInfo||{},window.APRT_DATA.orderInfo.totalPrice=t,window.APRT_DATA.basketProducts=i};s(t),c(t),$("body").on("click",".shopchoose",l)}(this);