!function(a){var b,c,d,e,f=a("body"),g=a(".jsBonusCard"),h="scid",i=function(){var b,c,e=a(".jsActiveCard"),f=a(".jsActiveCard .jsCardNumber"),g=a(".jsActiveCard .jsDescription"),h=function(){e.length&&b.hasOwnProperty("image")&&e.css("background","url("+b.image+") 260px -3px no-repeat")},i=function(){f.length&&b.hasOwnProperty("mask")&&(f.attr("placeholder",b.mask),f.mask(b.mask,{placeholder:"*"}))},j=function(){g.length&&b.hasOwnProperty("description")&&g.text(b.description)},k=function(){f.length&&b.hasOwnProperty("value")&&f.val(b.value)};e.length&&(c=a(".jsBonusCard .jsCard").index(this),-1!=c&&d.hasOwnProperty(c)&&(b=d[c],k(),h(),i(),j()))},j=function(){var b=a(".jsActiveCard .jsCardNumber"),c=function(){d[0].hasOwnProperty("mask")&&b.mask(d[0].mask,{placeholder:"*"})},e=function(){d[0].hasOwnProperty("value")&&b.val(d[0].value)};b.length&&d&&d.hasOwnProperty(0)&&(e(),c())},k={init:function(){b=g.data("sclub-id"),c=g.data("sclub-edit-url"),ENTER.config.userInfo!==!1&&(ENTER.config.userInfo?k.action(ENTER.config.userInfo):a("body").on("userLogged",function(){k.action(ENTER.config.userInfo)}),f.on("change",".jsBonusCard .jsCard",k.message))},action:function(a){"undefined"!=typeof a.id&&a.hasOwnProperty("sclubNumber")&&window.docCookies.getItem(h)&&(e=a.sclubNumber,k.message())},isNumbersEqual:function(a,b){return a==b},message:function(){var f,g,i,j=function(){var j,k=a(".jsBonusCard .jsCardMessage .sclub-message"),m=a(".jsActiveCard .jsCardNumber");k.length&&l(),j=e?"Номер карты в ЛК и пришедшим от sclub не совпадают. Заменить номер в ЛК?":"Сохранить номер в ЛК?",f=a("<div/>",{"class":"sclub-message",text:j}),f.append("&nbsp;"),g=a("<a/>",{href:c,text:"Да"}),g.click(function(c){c.preventDefault(),a.post(this.href,{number:window.docCookies.getItem(h)},function(c){if(c.success)window.docCookies.removeItem(h,"/"),l();else if(c.error&&a(".jsBonusCard .jsCardMessage .sclub-message").html(c.error).addClass("error"),c.hasOwnProperty("code")&&735==c.code&&(window.docCookies.removeItem(h,"/"),m.length&&m.val(e).mask(m.attr("placeholder"),{placeholder:"*"}),b))for(var f=0;f<d.length;f++)b==d[f].id&&(d[f].value=e)})}),g.appendTo(f),e&&(f.append("&nbsp;"),i=a("<a/>",{href:c,text:"Нет"}),i.click(function(a){if(a.preventDefault(),window.docCookies.removeItem(h,"/"),m.length&&e&&m.val(e).mask(m.attr("placeholder"),{placeholder:"*"}),b)for(var c=0;c<d.length;c++)b==d[c].id&&(d[c].value=e);l()}),i.appendTo(f)),f.appendTo(".jsBonusCard .jsCardMessage")},l=function(){var b=a(".jsBonusCard .jsCardMessage .sclub-message");b.length&&b.remove()};return b!=a('input[name="order[bonus_card_id]"]:checked',".jsBonusCard").val()?void l():void(window.docCookies.getItem(h)&&!0!==k.isNumbersEqual(e,window.docCookies.getItem(h))&&j())}};g.length&&(d=g.data("value"),d.length&&(a.mask.definitions.x="[0-9]",j(),k.init(),f.on("change",".jsBonusCard .jsCard",i)))}(jQuery),function(a,b,c,d){var e,f,g=d.utils,h=c("#page-config").data("value"),i=c("#jsOrderForm").data("value"),j=c("#metrostations").data("name"),k=c("#jsDeliveryAddress").data("value"),l=h?h.addressAutocomplete:!1,m=null,n=null,o=6,p=c("#order_address_street"),q=c("#order_address_building"),r=c("#order_address_number"),s=c("#order_address_metro"),t=c("#order_subway_id"),u=null,v=!1,w=k?k.regionName:"",x=c("#map"),y=null,z=function(){var a,b,d,e,f=12,g="";return a=c.trim(w),b="город",a&&(g&&(g+=", "),g+=b+" "+a,f=12),a=null,b=null,d=p.kladr("current"),e=c.trim(p.val()),d?(a=d.name,b=d.type):e&&(a=e,b=""),a&&(g&&(g+=", "),g+=b+" "+a,f=14),a=null,b=null,d=q.kladr("current"),e=c.trim(q.val()),d?(a=d.name,b="дом"):e&&(a=e,b="дом"),a&&(g&&(g+=", "),g+=b+" "+a,f=16),a=null,b=null,e=c.trim(r.val()),e&&(a=e,b="корпус"),a&&(g&&(g+=", "),g+=b+" "+a,f=16),{address:g,zoom:f}},A=function(){var a,b,c,d,e=z();e.address&&v&&y!==e.address&&(y=e.address,a=ymaps.geocode(e.address),a.then(function(a){b=a.geoObjects.get(0).geometry.getCoordinates(),b&&(c=b[0],d=b[1],u.points=[],u.mapWS.geoObjects.each(function(a){u.mapWS.geoObjects.remove(a)}),u.points.push({latitude:c,longitude:d}),u._showMarkers(),u.mapWS.setCenter(b,e.zoom),s.length&&B(c,d))}))},B=function(a,b){var c,d,e;t.length&&(c=ymaps.geocode([a,b],{kind:"metro"}),c.then(function(a){if(d=a.geoObjects.get(0),e=d.properties.get("name"),e=e.replace("метро ",""),s.val(e),t.val(""),g.orderValidator&&g.orderValidator._unmarkFieldError(s),void 0!==j)for(var b=j.length-1;b>=0;b--)if(e===j[b].label){t.val(j[b].val);break}},function(a){s.val(""),t.val(""),g.orderValidator&&g.orderValidator._markFieldError(s,"Не выбрана станция метро")}))},C=function(a){return e=c("ul.error_list"),e.length?e.html("<li>"+a+"</li>"):c("#map").before(c('<ul class="error_list" />').append("<li>"+a+"</li>")),!1},D=function(){return e=c("ul.error_list"),e.length&&e.html(""),!1},E=function(a){""===c.trim(a)&&c.kladr.api({token:q.kladr("token"),key:q.kladr("key"),type:q.kladr("type"),name:a,parentType:q.kladr("parentType"),parentId:q.kladr("parentId"),limit:1},function(a){a.length&&(D(),q.kladr("current",a[0]))})};defaultValues=function(){""!=c.trim(i["order[address_street]"])&&c.kladr.api({token:m,key:n,type:c.kladr.type.street,name:i["order[address_street]"],parentType:c.kladr.type.city,parentId:f,limit:1},function(a){a.length&&(D(),p.kladr("current",a[0]),q.kladr("parentType",c.kladr.type.street),q.kladr("parentId",a[0].id),E(i["order[address_building]"]))})},fieldsHandler={city:function(){return w?void c.kladr.api({token:m,key:n,type:c.kladr.type.city,name:w,limit:1},function(a){a.length&&(f=a[0].id,fieldsHandler.street(),fieldsHandler.building(),fieldsHandler.buildingAdd(),p.kladr("parentType",c.kladr.type.city),p.kladr("parentId",f),defaultValues())}):null},street:function(){p.kladr({token:m,key:n,type:c.kladr.type.street,verify:!0,limit:o,source:function(a){c.kladr.api({token:p.kladr("token"),key:p.kladr("key"),type:p.kladr("type"),name:a,parentType:p.kladr("parentType"),parentId:p.kladr("parentId"),limit:p.kladr("limit")},function(a){var b,d,e=[];if(a.length&&(D(),p.kladr("current",a[0]),q.kladr("parentType",c.kladr.type.street),a[0].id!==q.kladr("parentId")&&(q.kladr("parentId",a[0].id),E(q.val())),A(),1!==a.length)){for(b in a)d=a[b],d.label=d.type+" "+d.name,d.value=d.name,e.push(d);p.autocomplete({source:e,appendTo:".jsInputStreet",minLength:2,select:function(a,b){D(),p.kladr("current",b.item),q.kladr("parentType",c.kladr.type.street),b.item.id!==q.kladr("parentId")&&(q.kladr("parentId",b.item.id),E(q.val())),A()}})}})}})},building:function(){q.kladr({token:m,key:n,type:c.kladr.type.building,verify:!0,limit:o,source:function(a){c.kladr.api({token:q.kladr("token"),key:q.kladr("key"),type:q.kladr("type"),name:a,parentType:q.kladr("parentType"),parentId:q.kladr("parentId"),limit:q.kladr("limit")},function(a){var b,c,d=[];if(a.length&&(D(),q.kladr("current",a[0]),A(),1!==a.length)){for(b in a)c=a[b],c.label=c.name,d.push(c);q.autocomplete({source:d,appendTo:".jsInputBuilding",minLength:0,select:function(a,b){D(),q.kladr("current",b.item),A()}})}})}})},buildingAdd:function(){r.change(function(){A()})}},fieldsInit=function(){fieldsHandler.city()},mapCreate=function(){var a,b,e=z();!v&&x.length&&(y=e.address,x.show().width(477).height(350),v=!0,a=ymaps.geocode(e.address),a.then(function(a){b=a.geoObjects.get(0).geometry.getCoordinates(),u=new d.constructors.CreateMap("map",[{latitude:b[0],longitude:b[1]}]),u.points=[],u.mapWS.geoObjects.each(function(a){u.mapWS.geoObjects.remove(a)}),""!==c.trim(i["order[address_street]"])&&u.points.push({latitude:b[0],longitude:b[1]}),u._showMarkers(),u.mapWS.setCenter(b,e.zoom)},function(a){C("Не нашли ваш город на карте."),u=new d.constructors.CreateMap("map",[{latitude:55.76,longitude:37.64}])}))},l&&(k&&k.kladr&&(m=k.kladr.token?k.kladr.token:null,n=k.kladr.key?k.kladr.key:null,o=k.kladr.itemLimit?k.kladr.itemLimit:6),fieldsInit(),c("body").bind("orderdeliverychange",function(){ymaps.ready(mapCreate)}))}(this,this.document,this.jQuery,this.ENTER),function(a,b,c,d,e){var f,g=d.constructors,h=(d.utils,d.config.pageConfig),i=h.prepayment,j=c(b.body);g.DeliveryBox=function(){"use strict";function b(a,g,h){if(!(this instanceof b))return new b(a,g,h);f=d.OrderModel;var j=this;j.isUnique=f.orderDictionary.isUniqueDeliveryState(g),j.token=g+"_"+h,j.products=[],j.fullPrice=e.observable(0),j.totalBlockSum=0,j.state=g,j.deliveryName=f.orderDictionary.getNameOfState(g),j.deliveryPrice=Number.NEGATIVE_INFINITY,j.choosenDate=e.observable(),j.choosenNameOfWeek=e.observable(),j.choosenPoint=e.observable({id:h}),j.choosenInterval=e.observable(),j.showPopupWithPoints=e.observable(!1),j.hasPointDelivery=f.orderDictionary.hasPointDelivery(g),j.isExpensiveOrder=e.computed(function(){return i.enabled&&i.priceLimit<=parseInt(j.fullPrice(),10)+parseInt(j.deliveryPrice,10)?!0:!1}),j.hasProductWithPrepayment=!1,j.allDatesForBlock=e.observableArray([]),j.pointList=[],j.changePointButtonText=f.orderDictionary.getChangeButtonText(g),j.hasPointDelivery&&!f.orderDictionary.getPointByStateAndId(j.state,h)?j.choosenPoint(f.orderDictionary.getFirstPointByState(j.state)):j.hasPointDelivery?j.choosenPoint(f.orderDictionary.getPointByStateAndId(j.state,h)):(f.hasHomeDelivery(!0),c("body").trigger("orderdeliverychange",[!0])),j.calendarSliderLeft=e.observable(0);try{var k=[];for(var l in a){var m=a[l],n=Object.keys(a[l].deliveries[j.state])[0];m.choosenPoint=n,m.deliveries_types=JSON.stringify(Object.keys(a[l].deliveries)),m.firstDate=a[l].deliveries[j.state][n].dates[0].name,m.lastDate=a[l].deliveries[j.state][n].dates[a[l].deliveries[j.state][n].dates.length-1].name,k.push(m)}}catch(o){}finally{}j.addProductGroup(a),0!==j.products.length&&f.deliveryBoxes.push(j)}return b.prototype._makePointList=function(){var a,b,c,d=this,e=!0,g=null;for(a in d.products[0].deliveries[d.state]){for(b=d.products.length-1;b>=0&&(e=d.products[b].deliveries[d.state].hasOwnProperty(a),e);b--);if(e)g=f.orderDictionary.getPointByStateAndId(d.state,a),d.isUniquePointIdInPointList(a,d.pointList)&&d.pointList.push(g);else for(c in d.pointList)void 0!==d.pointList[c].id&&a===d.pointList[c].id&&d.pointList.splice(c)}},b.prototype.isUniquePointIdInPointList=function(a,b){var c,d=!0;if(void 0===a||void 0===b)return d;for(c in b)if(b[c].id==a)return!1;return!0},b.prototype.addUniqueSuffix=function(a){var b;return a=a||"",b=Math.floor(1e4*Math.random()+1),a+="_"+b},b.prototype.selectPoint=function(b){var c,e=this,g=e.state+"_"+b.id,h=null,i=[];if(f.hasDeliveryBox(g)){for(c=e.products.length-1;c>=0;c--)e.products[c].id&&i.push(e.products[c].id);e._hasProductsAlreadyAdded(i)||(h=f.getDeliveryBoxByToken(g),h.addProductGroup(e.products),f.removeDeliveryBox(e.token))}else e.isUnique&&(g+=e.addUniqueSuffix()),e.token=g,e.choosenPoint(f.orderDictionary.getPointByStateAndId(e.state,b.id)),d.OrderModel.choosenPoint(b.id),h=f.getDeliveryBoxByToken(g),h.allDatesForBlock([]),h.calculateDate(),f.paypalECS()&&a.docCookies.setItem("chPoint_paypalECS",b.id,600);return f.showPopupWithPoints(!1),!1},b.prototype.changePoint=function(){var a,b=this;for(a=b.pointList.length-1;a>=0;a--)b.pointList[a].parentBoxToken=b.token;return f.popupWithPoints({header:"Выберите точку доставки",points:b.pointList}),f.showPopupWithPoints(!0),!1},b.prototype._getFirstPropertyName=function(a){for(var b in a)return b},b.prototype._addProduct=function(a){var c,e,g=this,h=null,i=null,j=null,k=[],l=null,m={};if(!g._hasProductsAlreadyAdded([a.id])){if(!a.deliveries[g.state].hasOwnProperty(g.choosenPoint().id)&&!/_shipped$/.test(g.token))return j=g._getFirstPropertyName(a.deliveries[g.state]),i=g.state+"_"+j,k.push(a),void(f.hasDeliveryBox(i)?(l=f.getDeliveryBoxByToken(i),e=f.removeDeliveryBox(i),c=f.totalSum()-e.fullPrice()-l.deliveryPrice,f.totalSum(c),l.addProductGroup(k),f.deliveryBoxes.push(l)):new b(k,g.state,j));/_shipped$/.test(g.token)&&g.choosenPoint({id:0}),h=parseInt(a.deliveries[g.state][g.choosenPoint().id].price,10),g.deliveryPrice=g.deliveryPrice<h?h:g.deliveryPrice,m={id:a.id,name:a.name,price:a.sum?a.sum:a.price,quantity:a.quantity,stock:a.stock,deleteUrl:a.deleteUrl,setUrl:a.setUrl,productUrl:a.url,productImg:a.image?a.image:a.productImg,deliveries:{},isPrepayment:a.isPrepayment},g.isUnique&&a.oldQuantity-1>0&&(m.deleteUrl=m.deleteUrl.replace("delete-","add-"),m.deleteUrl+="?quantity="+(a.oldQuantity-1)),m.isPrepayment&&(g.hasProductWithPrepayment=!0),m.deliveries[g.state]=a.deliveries[g.state],g.fullPrice(d.utils.numMethods.sumDecimal(m.price,g.fullPrice())),g.products.push(m)}},b.prototype._hasProductsAlreadyAdded=function(a){var b,d=this,e=!1;if(void 0===a||!a.length)return e;for(b=d.products.length-1;b>=0;b--)-1!==c.inArray(d.products[b].id,a)&&(e=!0);return e},b.prototype.updateTotalPrice=function(){var a=this,b=f.totalSum();a.totalBlockSum=d.utils.numMethods.sumDecimal(a.fullPrice(),a.deliveryPrice),b=d.utils.numMethods.sumDecimal(a.totalBlockSum,b),f.totalSum(b)},b.prototype.addProductGroup=function(a){var c,d=this,e=[];if(!/_shipped$/.test(d.token))for(c=a.length-1;c>=0;c--)0x8000000000000000!=a[c].stock?d._addProduct(a[c]):e.push(a[c]);if(/_shipped$/.test(d.token))for(c=a.length-1;c>=0;c--)d._addProduct(a[c]);e.length&&!/_shipped$/.test(d.token)&&new b(e,d.state,"shipped"),d.products.length&&(d.calculateDate(),d.updateTotalPrice(),d.hasPointDelivery&&d._makePointList())},b.prototype._getNameDayOfWeek=function(a){var b=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"];return b[a]},b.prototype._getFullNameDayOfWeek=function(a){var b=["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"];return b[a]},b.prototype._hasDateInAllProducts=function(a){var b,c,d,e=this,f=null,g=null,h=!0;for(c=0;c<e.products.length;c++){for(f=e.products[c].deliveries[e.state][e.choosenPoint().id].dates,d=0,b=f.length;b>d;d++){if(g=f[d].value,g===a){h=!0;break}h=!1}if(!h)break}return h},b.prototype.clickCalendarDay=function(b){var c,d=this,e=d.choosenDate();if(!b.avalible)return!1;try{c=(b.value-e.value)/864e5,j.trigger("trackUserAction",["1_4_1 Смена даты",c])}catch(g){}f.paypalECS()&&a.docCookies.setItem("chDate_paypalECS",JSON.stringify(b),600),d.choosenNameOfWeek(d._getFullNameDayOfWeek(b.dayOfWeek)),d.choosenDate(b)},b.prototype._hasDateInAllDatesForBlock=function(a){for(var b=0;b<this.allDatesForBlock().length;b++)if(this.allDatesForBlock()[b].value===a.value)return!0;return!1},b.prototype.calculateDate=function(){var c,e,g=this,h=f.orderDictionary.getToday(),i=null,j=null,k="",l=null,m=[],n=null,o=null;if(g.products.length){for(/_shipped$/.test(g.token)&&g.choosenPoint({id:0}),i=g.products[0].deliveries[g.state][g.choosenPoint().id].dates,e=0,c=i.length;c>e;e++)j=i[e].value,g._hasDateInAllProducts(j)&&j>=h&&!g._hasDateInAllDatesForBlock(i[e])&&(i[e].avalible=!0,i[e].humanDayOfWeek=g._getNameDayOfWeek(i[e].dayOfWeek),g.allDatesForBlock().push(i[e]));if(!g.allDatesForBlock().length){var p=[];p=g.products.reduceRight(function(a,b,c,e){return 0x8000000000000000==b.stock&&(e.splice(c,1),a.push(b),g.fullPrice(d.utils.numMethods.sumDecimal(g.fullPrice(),-b.price))),a},[]),p.length&&new b(p,g.state,g.choosenPoint().id),m=g.products.reduceRight(function(a,b,c,e){var f=b.deliveries[g.state][g.choosenPoint().id].dates[0].value;return null===l&&(l=f),l==f&&(e.splice(c,1),a.push(b),g.fullPrice(d.utils.numMethods.sumDecimal(g.fullPrice(),-b.price))),a},[]),k=g.state+"_"+g.choosenPoint().id+"_"+g.addUniqueSuffix(),new b(m,g.state,g.choosenPoint().id),g.calculateDate()}if(f.paypalECS()&&a.docCookies.hasItem("chDate_paypalECS")?(n=a.docCookies.getItem("chDate_paypalECS"),o=JSON.parse(n)):o=g.getFirstAvalibleDate(),!o||!0!==o.avalible)return!1;if(g.choosenDate(o),void 0===typeof g.choosenDate().intervals)return!1;g.choosenNameOfWeek(g._getFullNameDayOfWeek(g.choosenDate().dayOfWeek)),0!==g.choosenDate().intervals.length&&g.choosenInterval(g.choosenDate().intervals[0]),g.makeCalendar()}},b.prototype.getFirstAvalibleDate=function(){var a,b=this;for(a=0;a<b.allDatesForBlock().length;a++)if(b.allDatesForBlock()[a].avalible)return b.allDatesForBlock()[a];return!1},b.prototype.makeCalendar=function(){var a,b,c,d=this,e=0,f={},g=null,h=null,i=864e5;for(c=0;c<d.allDatesForBlock().length&&void 0!==d.allDatesForBlock()[c+1]&&!(c>99)&&(f={},g=d.allDatesForBlock()[c].value+i,h=new Date(g),!(g>d.allDatesForBlock()[c+1].value));c++)g!==d.allDatesForBlock()[c+1].value&&(f={value:g,avalible:!1,humanDayOfWeek:d._getNameDayOfWeek(h.getDay()),dayOfWeek:h.getDay(),day:h.getDate()},d.allDatesForBlock.splice(c+1,0,f));if(1!==d.allDatesForBlock()[0].dayOfWeek)for(e=0===d.allDatesForBlock()[0].dayOfWeek?6:d.allDatesForBlock()[0].dayOfWeek-1,g=d.allDatesForBlock()[0].value,a=e;a>0;a--)g-=i,h=new Date(g),f={value:g,avalible:!1,humanDayOfWeek:d._getNameDayOfWeek(h.getDay()),dayOfWeek:h.getDay(),day:h.getDate()},d.allDatesForBlock.unshift(f);if(0!==d.allDatesForBlock()[d.allDatesForBlock().length-1].dayOfWeek)for(e=7-d.allDatesForBlock()[d.allDatesForBlock().length-1].dayOfWeek,g=d.allDatesForBlock()[d.allDatesForBlock().length-1].value,b=e;b>0;b--)g+=i,h=new Date(g),f={value:g,avalible:!1,humanDayOfWeek:d._getNameDayOfWeek(h.getDay()),dayOfWeek:h.getDay(),day:h.getDate()},d.allDatesForBlock.push(f)},b.prototype.calendarLeftBtn=function(){var a=this,b=parseInt(a.calendarSliderLeft(),10);b+=380,a.calendarSliderLeft(b)},b.prototype.calendarRightBtn=function(){var a=this,b=parseInt(a.calendarSliderLeft(),10);b-=380,a.calendarSliderLeft(b)},b}()}(this,this.document,this.jQuery,this.ENTER,this.ko),function(a){var b=$("div.bBankWrap"),c=function(){var c=$("#selectedBank"),d=function(){var a=$("input:checked",b),d=a.val();"undefined"!==d&&($(".bSelectInput",b).addClass("bUnchecked"),a.closest(".bSelectInput",b).removeClass("bUnchecked"),c.val(d))};b.change(d),"function"==typeof a.DirectCredit.init&&a.DirectCredit.init($("#jsCreditBank").data("value"),$(".credit_pay"))};b.length&&c()}(this),function(a,b,c,d){var e=d.constructors;e.OrderDictionary=function(){"use strict";function b(a){return this instanceof b?(this.orderData=a,this.serverTime=this.orderData.time,this.deliveryTypes=this.orderData.deliveryTypes,this.deliveryStates=this.orderData.deliveryStates,this.pointsByDelivery=this.orderData.pointsByDelivery,this.products=this.orderData.products,void(this.defPoints=this.orderData.defPoints||{})):new b(a)}return b.prototype.getNameOfState=function(a){return this.hasDeliveryState(a)?this.deliveryStates[a].name:!1},b.prototype.getToday=function(){return this.serverTime},b.prototype.getDefaultPointId=function(a){return this.defPoints.hasOwnProperty(a)?this.defPoints[a]:0},b.prototype.hasDeliveryState=function(a){return this.deliveryStates.hasOwnProperty(a)},b.prototype.isUniqueDeliveryState=function(a){var b;return this.hasDeliveryState(a)?(b=this.deliveryStates[a],b.unique):!1},b.prototype.hasPointDelivery=function(a){return this.hasDeliveryState(a)?this.pointsByDelivery.hasOwnProperty(a)&&this.pointsByDelivery[a].token:!1},b.prototype.getPointByStateAndId=function(b,c){var d,e=this.getAllPointsByState(b);for(c+="",d=e.length-1;d>=0;d--)if(e[d].id===c)return a.ENTER.utils.cloneObject(e[d]);return!1},b.prototype.getFirstPointByState=function(a){var b=this.getAllPointsByState(a);return b[0]?d.utils.cloneObject(b[0]):!1},b.prototype.getAllPointsByState=function(a){if(!this.hasDeliveryState(a))return!1;var b,c,d=this.pointsByDelivery[a],e=d?d.token:!1,f=e?this.orderData[e]:!1,g=[];if("now"==a||"self"==a||"self_svyaznoy"==a){for(b in f)for(c in f[b].products)c==a&&g.push(f[b]);f=g}return f||!1},b.prototype.getChangeButtonText=function(a){var b=this.pointsByDelivery[a]?this.pointsByDelivery[a].changeName:"Сменить";return b},b.prototype.getProductFromState=function(a){return this.hasDeliveryState(a)?this.deliveryStates[a].products:!1},b.prototype.getProductById=function(a){return this.products.hasOwnProperty(a)?this.products[a]:!1},b.prototype.getStateToProductByDeliveryID=function(a,b){var c,d=this.products[a].deliveries;for(c in d)if(d.hasOwnProperty(c)&&d[c].hasOwnProperty(b))return c;return!1},b}()}(this,this.document,this.jQuery,this.ENTER),function(){if(!$("#paymentMethod-10").length)return!1;var a=$("#paymentMethod-10").parent(),b=a.find(".mCardNumber"),c=a.find(".mCardPin"),d=a.find(".bPayMethodAction"),e=d.attr("data-url"),f=function(){var a=!1,f="processBlock",g=function(){return b.val().replace(/[^0-9]/g,"")},h=function(){return c.val().replace(/[^0-9]/g,"")},i=function(){return{code:g(),pin:h()}},j=function(){return a&&""!==g()&&14===g().length&&""!==h()&&4===h().length?!0:!1},k=function(){return 4!==c.val().length?!1:b.val().length?(l("mOrange","Проверка по номеру карты"),void $.post(e,i(),function(a){if(!("success"in a))return!1;if(!a.success){var b="undefined"!=typeof a.error?a.error:"ERROR";return l("mRed",b),!1}l("mGreen",a.data)})):!1},l=function(b,c){var e=$(".process").first(),g={typeNum:b};switch(e.hasClass("picked")||e.remove(),b){case"mOrange":g.text=c,a=!1;break;case"mRed":g.text="Произошла ошибка: "+c,a=!1;break;case"mGreen":g.text="activated"in c?"Карта "+c.code+" на сумму "+c.sum+" активирована!":"Карта "+c.code+" имеет номинал "+c.sum,a=!0}d.after(tmpl(f,g)),"undefined"!=typeof c.activated&&$(".process").first().addClass("picked")};return{checkCard:k,setProcessingStatus:l,isActive:j,getCode:g,getPIN:h}}();b.bind("change",function(){f.checkCard()}),c.bind("change",function(){f.checkCard()}),$.mask.definitions.n="[0-9]",c.mask("nnnn",{completed:f.checkCard,placeholder:"*"})}(this),function(){var a=window,b=a._gaq||[],c=a[a.GoogleAnalyticsObject],d=a.jQuery,e=d(document.body),f=d("#jsDeliveryAddress").data("value").regionName,g=function(a,d,e){var g=e||"",h=d||"",i="order.oneClick.new"==ENTER.config.pageConfig.currentRoute,j="воронка_";i&&(j+="старый_1_клик_"),a&&a.data&&(a.data.step&&(h=a.data.step),a.data.action&&(g=a.data.action)),"undefined"==typeof c&&(c=window[window.GoogleAnalyticsObject]),"object"==typeof b&&b.push(["_trackEvent",j+f,h,g]),"function"==typeof c&&c("send","event",j+f,h,g)};e.on("trackUserAction.orderTracking",g),e.on("click.orderTracking","a.bBackCart",function(a){d(a.target).hasClass("mOrdeRead")?e.trigger("trackUserAction",["3 Редактировать товары"]):e.trigger("trackUserAction",["1_3 Доставка, ушел в корзину"])}),e.on("click.orderTracking","a#auth-link",{step:"4_0 Авторизация"},g),e.on("focusin.orderTracking",function(a){var b=d(a.target);switch(b.attr("id")){case"order_recipient_first_name":e.trigger("trackUserAction",["4_1 Имя"]);break;case"order_recipient_last_name":e.trigger("trackUserAction",["4_2 Фамилия"]);break;case"order_recipient_email":e.trigger("trackUserAction",["4_3 Email"]);break;case"order_recipient_phonenumbers":e.trigger("trackUserAction",["4_4 телефон"]);for(var c in ENTER.OrderModel.deliveryBoxes())if(/standart/.test(ENTER.OrderModel.deliveryBoxes()[c].state)){e.trigger("trackUserAction",["4_5_1 ЛД Доставка - Адрес"]);break}break;case"order_address_street":e.trigger("trackUserAction",["4_5_2 ЛД Доставка - Улица"]);break;case"order_address_building":e.trigger("trackUserAction",["4_5_3 ЛД Доставка - Дом"]);break;case"order_address_metro":e.trigger("trackUserAction",["4_5_4 ЛД Доставка - Метро"]);break;case"bonus-card-number":e.trigger("trackUserAction",["5 Связной-клуб"])}}),e.on("click.orderTracking",".mPayMethods .bCustomLabel",function(a){e.trigger("trackUserAction",["6 Тип оплаты",d(a.target).text()])}),e.on("click.orderTracking",".mRules .bCustomLabel",function(a){var b=d(a.target);b.hasClass("bCustomLabel")&&e.trigger("trackUserAction",["7 Согласие"]),"/terms"==b.attr("href")&&e.trigger("trackUserAction",["7_1 Условия"]),"/legal"==b.attr("href")&&e.trigger("trackUserAction",["7_2 Право"])}),e.on("focus","select.bSelect",function(){var a=d(this).prop("selectedIndex");d(this).off("blur").on("blur",function(){var b=a-d(this).prop("selectedIndex");0==b?e.trigger("trackUserAction",["1_4_2 Смена времени","оставил"]):e.trigger("trackUserAction",["1_4_2 Смена времени","сменил"])})}),e.trigger("trackUserAction",["0 Вход"])}(),function(a,b,c,d){var e=d.utils,f={},g=c("#metrostations").data("name"),h=c("#order_recipient_first_name"),i=(c("#order_recipient_last_name"),c("#order_recipient_email")),j=c("#order_recipient_phonenumbers"),k=c("#order_address_metro"),l=c("#order_subway_id"),m=c("#order_address_street"),n=c("#order_address_building"),o=c("#bonus-card-number"),p=(c('.jsCustomRadio[name="order[payment_method_id]"]'),c("#qiwi-phone")),q=c("#order_agreed"),r=c("#completeOrder"),s=null,t=null,u=null,v={fields:[{fieldNode:h,require:!0,customErr:"Введите имя получателя",validateOnChange:!0},{fieldNode:i,validBy:"isEmail",customErr:"Некорректно введен e-mail",validateOnChange:!0},{fieldNode:j,require:!0,customErr:"Некорректно введен телефон",validateOnChange:!0},{fieldNode:q,require:!0,customErr:"Необходимо согласие"},{fieldNode:o,customErr:"Некорректно введен номер карты лояльности"}]},w={source:g,appendTo:"#metrostations",minLength:2,select:function(a,b){l.val(b.item.val)}};f=new FormValidator(v),e.orderValidator=f;var x=function(a,b){var d='<div class="popupbox width290"><div class="font18 pb18"> '+a+'</div></div><p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>',e=c("<div>").addClass("popup").html(d);e.appendTo("body");var f=function(){return e.trigger("close"),e.remove(),void 0!==b&&b(),!1};e.lightbox_me({centered:!0,onClose:f}),e.find(".closePopup").bind("click",f)},y=function(a){var b=c('[name="order['+a.field+']"]'),d=function(){f._unmarkFieldError(c(this))};f._markFieldError(b,a.message),b.bind("focus",d)},z={"default":function(a){return"undefined"==typeof a.redirect&&(a.redirect="/cart"),a.error&&a.error.message?void x(a.error.message,function(){0!==a.redirect&&(b.location.href=a.redirect)}):void(b.location.href=a.redirect)},0:function(a){var d=null;if(a.redirect)return void x(a.error.message,function(){b.location.href=a.redirect});x(a.error.message);for(var e=a.form.error.length-1;e>=0;e--)d=a.form.error[e],y(d);c.scrollTo(c(".mError").eq(0),500,{offset:-15})},743:function(a){x(a.error.message)}},A=function(){if("undefined"!=typeof _gaq){for(var a=d.OrderModel.deliveryBoxes().length-1;a>=0;a--)_gaq.push(["_trackEvent","Order card","Completed","выбрана "+d.OrderModel.choosenDeliveryTypeId+" доставят "+d.OrderModel.deliveryBoxes()[a].state]);_gaq.push(["_trackEvent","Order complete",d.OrderModel.deliveryBoxes().length,d.OrderModel.orderDictionary.products.length]),_gaq.push(["_trackTiming","Order complete","DB response",u])}c(b.body).trigger("trackUserAction",["9 Завершение - успех"])},B=function(f){return t=(new Date).getTime(),u=t-s,f.success?(A(),d.OrderModel.paypalECS()&&!r.hasClass("mConfirm")&&(a.docCookies.removeItem("chDate_paypalECS","/"),a.docCookies.removeItem("chTypeBtn_paypalECS","/"),a.docCookies.removeItem("chPoint_paypalECS","/"),a.docCookies.removeItem("chTypeId_paypalECS","/"),a.docCookies.removeItem("chStetesPriority_paypalECS","/")),void(b.location.href=f.redirect)):(c(b.body).trigger("trackUserAction",["8 Завершение - ошибка",f.error.code]),e.blockScreen.unblock(),z.hasOwnProperty(f.error.code)?z[f.error.code](f):z["default"](f),!1)},C=function(){var b,f,g,h=null,i=[],j=[],k={},l=c("#order-form");for(e.blockScreen.block("Ваш заказ оформляется"),j=l.serializeArray(),f=d.OrderModel.deliveryBoxes().length-1;f>=0;f--){for(k={},h=d.OrderModel.deliveryBoxes()[f],b=h.choosenPoint(),k={deliveryMethod_token:h.state,date:h.choosenDate().value,interval:[h.choosenInterval()?h.choosenInterval().start:"",h.choosenInterval()?h.choosenInterval().end:""],point_id:b.id,products:[],deliveryPrice:h.deliveryPrice},"self_partner_pickpoint"===h.state&&(k.point_id=b.number,k.point_address={street:b.street,house:b.house},k.point_name=b.point_name),g=h.products.length-1;g>=0;g--)k.products.push(h.products[g].id);i.push(k)}j.push({name:"order[delivery_type_id]",value:d.OrderModel.choosenDeliveryTypeId}),j.push({name:"order[part]",value:JSON.stringify(i)}),"undefined"!=typeof a.KM&&j.push({name:"kiss_session",value:a.KM.i}),s=(new Date).getTime(),c.ajax({url:l.attr("action"),timeout:12e4,type:"POST",data:j,success:B,statusCode:{500:function(){x("Не удалось создать заказ. Попробуйте позднее. 500")},504:function(){x("Не удалось создать заказ. Попробуйте позднее. 504")}}})},D=function(){return d.OrderModel.lifeGift()?(C(),!1):(f.validate({onInvalid:function(a){c.scrollTo(a[a.length-1].fieldNode,500,{offset:-15})},onValid:C}),!1)},E=function(){for(var a=g.length-1;a>=0;a--)if(k.val()===g[a].label)return;k.val("")},F=function(a,b){b?(f.setValidate(m,{require:!0,customErr:"Не введено название улицы",validateOnChange:!0}),f.setValidate(n,{require:!0,customErr:"Не введен номер дома",validateOnChange:!0}),void 0!==g&&f.setValidate(k,{fieldNode:k,customErr:"Не выбрана станция метро",require:!0,validateOnChange:!0})):(f.setValidate(m,{require:!1}),f.setValidate(n,{require:!1}),void 0!==g&&f.setValidate(k,{require:!1}))};c.mask.definitions.n="[0-9]",o.mask("2 98nnnn nnnnnn",{placeholder:"*"}),p.mask("(nnn) nnn-nn-nn"),j.mask("(nnn) nnn-nn-nn"),a.docCookies.getItem("emails")&&f.setValidate(i,{require:!0});var G=function(a){var b,d=null;for(b in a)if(a[b]){d=c('input[name="'+b+'"]');var e=d.attr("type");if("radio"===e){d.filter('[value="'+a[b]+'"]').attr("checked","checked").trigger("change");continue}-1!=c.inArray(e,["text","password","color","date","datetime","datetime-local","email","number","range","search","tel","time","url","month","week"])&&d.val(a[b])}};if(G(c("#jsOrderForm").data("value")),void 0!==g){k.autocomplete(w),k.bind("change",E);for(var H=g.length-1;H>=0;H--)if(parseInt(l.val(),10)===g[H].val){k.val(g[H].label);break}}c("body").bind("orderdeliverychange",F),r.bind("click",D)}(this,this.document,this.jQuery,this.ENTER),function(a,b,c,d,e){var f=c("#jsOrderDelivery").data("value"),g=d.utils,h=c(b.body),i=function(b){var f,i={},k=[],l=[],m=null,n=null,o=null,p=null,q=null,r=null,s=[],t=[],u=d.OrderModel.orderDictionary.orderData.discounts||[];d.OrderModel.paypalECS()&&(a.docCookies.setItem("chTypeBtn_paypalECS",d.OrderModel.deliveryTypesButton,600),a.docCookies.setItem("chPoint_paypalECS",d.OrderModel.choosenPoint(),600),a.docCookies.setItem("chTypeId_paypalECS",d.OrderModel.choosenDeliveryTypeId,600),a.docCookies.setItem("chStetesPriority_paypalECS",JSON.stringify(d.OrderModel.statesPriority),600)),d.OrderModel.deliveryBoxes().length&&(t=e.toJS(d.OrderModel.deliveryBoxes())),d.OrderModel.deliveryBoxes.removeAll(),d.OrderModel.hasCoupons(!1),c("#"+d.OrderModel.deliveryTypesButton).attr("checked","checked").trigger("change"),d.OrderModel.totalSum(0),d.OrderModel.hasHomeDelivery(!1),h.trigger("orderdeliverychange",[!1]);for(var v=0,w=b.length;w>v;v++)if(o=b[v],r=d.OrderModel.orderDictionary.isUniqueDeliveryState(o),l=[],d.OrderModel.orderDictionary.hasDeliveryState(o)){k=d.OrderModel.orderDictionary.getProductFromState(o);for(var x=k.length-1;x>=0;x--)p=k[x],i[p]||(i[p]=!0,l.push(d.OrderModel.orderDictionary.getProductById(p)));if(l.length)if(m=d.OrderModel.orderDictionary.hasPointDelivery(o)?d.OrderModel.choosenPoint():d.OrderModel.orderDictionary.getDefaultPointId(o),n=o+"_"+m,d.OrderModel.hasDeliveryBox(n))q=d.OrderModel.getDeliveryBoxByToken(n),q.addProductGroup(l);else if(r)for(s=d.OrderModel.prepareProductsQuantityByUniq(l),x=s.length-1;x>=0;x--)p=[s[x]],d.constructors.DeliveryBox(p,o,m);else d.constructors.DeliveryBox(l,o,m)}for(var y in t)d.OrderModel.hasDeliveryBox(t[y].token)&&(f=d.OrderModel.getDeliveryBoxByToken(t[y].token),f.choosenDate(t[y].choosenDate),f.allDatesForBlock.removeAll(),f.allDatesForBlock(t[y].allDatesForBlock));if(d.OrderModel.deliveryBoxes().length>1&&h.trigger("trackUserAction",["1_2 Доставка, заказ разбит",d.OrderModel.deliveryBoxes().length]),d.OrderModel.couponsBox(u),d.OrderModel.couponUrl(c(".bSaleList__eItem:visible .jsCustomRadio").eq(0).val()),c(".bSaleList__eItem:visible .jsCustomRadio").eq(0).trigger("change"),0===c(".bPayMethod:visible .jsCustomRadio:checked").length&&c(".bPayMethod:visible .jsCustomRadio").eq(0).attr("checked","checked").trigger("change"),d.OrderModel.hasCoupons()&&d.OrderModel.deliveryBoxes().length>1||d.OrderModel.appliedCoupon()&&d.OrderModel.appliedCoupon().sum&&parseFloat(d.OrderModel.totalSum())+parseFloat(d.OrderModel.appliedCoupon().sum)<=parseFloat(d.OrderModel.appliedCoupon().sum)){var z="Купон не может быть применен при текущем разбиении заказа и будет удален",A=function(){d.OrderModel.deleteItem(d.OrderModel.appliedCoupon())
};return c.when(j(z)).then(A),!1}i.length!==d.OrderModel.orderDictionary.orderData.products.length,c(".bCountSection").goodsCounter({onChange:function(a){h.trigger("trackUserAction",["1_4_3 Число товаров"]);var b,e=c(this).data("seturl")||"",f=e.addParameterToUrl("quantity",a),i=function(a){return a.success?void d.OrderModel.couponNumber(""):(d.OrderModel.couponError(a.error.message),void g.blockScreen.unblock())};g.blockScreen.block("Обновляем"),b=[{type:"GET",url:f,callback:i},{type:"GET",url:d.OrderModel.updateUrl,callback:d.OrderModel.modelUpdate}],g.packageReq(b)}})};e.bindingHandlers.popupShower={update:function(a,b){var f=b(),g=e.utils.unwrapObservable(f),h=null;g?(h=new d.constructors.CreateMap("pointPopupMap",d.OrderModel.popupWithPoints().points,c("#mapInfoBlock")),c(a).lightbox_me({centered:!0,onClose:function(){f(!1)}}),h._showMarkers()):(c("#pointPopupMap").empty(),c(a).trigger("close"))}},e.bindingHandlers.payBlockVisible={update:function(a){var b,e,f=c(a),g=f.data("vars"),h=g&&g.toHide?g.toHide:!1,i=d.OrderModel.choosenDeliveryTypeId,j=d.OrderModel.deliveryBoxes(),k=j.length,l=1;if(k){if(l=1===k?0:1,h)for(b in h)if("undefined"==typeof h[b].length)c.inArray(i,h)>=0&&(l=1);else if(i===b)for(e in h[b])e===g.typeId&&(l=1);l?f.hide():f.show()}}},e.bindingHandlers.paymentMethodVisible={update:function(a,b){var f=b(),g=e.utils.unwrapObservable(f),h=c(a),i=h.data("value"),j=parseInt(i["max-sum"],10),k=parseInt(i["min-sum"],10),l=i.method_id,m=i.isAvailableToPickpoint;return 6===d.OrderModel.choosenDeliveryTypeId&&!1===m||4===d.OrderModel.choosenDeliveryTypeId&&13===l&&d.OrderModel.lifeGift()===!1||!isNaN(j)&&g>j||!isNaN(k)&&k>g?(h.hide(),void(13==l&&-1==c.inArray(d.OrderModel.choosenDeliveryTypeId,[3,4])&&h.show())):void h.show()}},e.bindingHandlers.calendarSlider={update:function(a,b,d,e,f){var g=c(a),h=b(),i=g.find(".bBuyingDatesItem"),j=i.width()+parseInt(i.css("marginRight"),10)+parseInt(i.css("marginLeft"),10);return g.width(i.length*j),h>0?(h-=380,void f.box.calendarSliderLeft(h)):h<-g.width()?(h+=380,void f.box.calendarSliderLeft(h)):void g.animate({left:h})}},e.bindingHandlers.couponsVisible={update:function(a,b){var f,g=b(),h=e.utils.unwrapObservable(g),i=c(a),j=i.find(".mSaleInput"),k=i.find(".mSaleBtn"),l=i.find(".bSaleData__eEmptyBlock");for(c(".bSaleList__eItem").removeClass("hidden"),f=h.length-1;f>=0;f--)i.find('.bSaleList__eItem[data-type="'+h[f].type+'"]').addClass("hidden"),"coupon"===h[f].type&&(d.OrderModel.hasCoupons(!0),d.OrderModel.appliedCoupon(h[f]));c(".bSaleList__eItem.hidden").length===c(".bSaleList__eItem").length||c(".bSaleList__eItem:hidden").length===c(".bSaleList__eItem").length?(j.attr("disabled","disabled"),k.attr("disabled","disabled").addClass("mDisabled"),l.show()):(j.removeAttr("disabled"),k.removeAttr("disabled").removeClass("mDisabled"),l.hide())}},d.OrderModel={updateUrl:c("#jsOrderDelivery").data("url"),prepareData:e.observable(!1),showPopupWithPoints:e.observable(!1),deliveryTypesButton:null,tmpStatesPriority:null,statesPriority:null,lifeGift:e.observable(!1),oneClick:e.observable(!1),paypalECS:e.observable(!1),cartSum:null,orderDictionary:null,choosenPoint:e.observable(),hasHomeDelivery:e.observable(!1),deliveryTypes:e.observableArray([]),deliveryBoxes:e.observableArray([]),popupWithPoints:e.observable({}),totalSum:e.observable(0),hasCoupons:e.observable(!1),appliedCoupon:e.observable(),couponNumber:e.observable(),couponUrl:e.observable(),couponError:e.observable(),couponsBox:e.observableArray([]),hasDeliveryBox:function(a){var b=null;for(b=d.OrderModel.deliveryBoxes().length-1;b>=0;b--)if(d.OrderModel.deliveryBoxes()[b].token===a)return!0;return!1},getDeliveryBoxByToken:function(a){var b=null;for(b=d.OrderModel.deliveryBoxes().length-1;b>=0;b--)if(d.OrderModel.deliveryBoxes()[b].token===a)return d.OrderModel.deliveryBoxes()[b];return!1},removeDeliveryBox:function(a){var b,c=null,e=d.OrderModel.deliveryBoxes(),f=e.length;for(b=f-1;b>=0;b--)if(e[b].token===a){c=d.OrderModel.deliveryBoxes.splice(b,1),"object"==typeof c[0]&&(c=c[0]);break}return c},checkCoupon:function(){var a,b={number:d.OrderModel.couponNumber()},c=d.OrderModel.couponUrl(),e=function(a){return a.success?(h.trigger("trackUserAction",["2 Купон","Принят"]),void d.OrderModel.couponNumber("")):(d.OrderModel.couponError(a.error.message),g.blockScreen.unblock(),void h.trigger("trackUserAction",["2 Купон","Отказ"]))};return d.OrderModel.couponError(""),void 0===c?void d.OrderModel.couponError("Не выбран тип скидки"):void 0!==b.number&&b.number.length?(g.blockScreen.block("Применяем купон"),a=[{type:"POST",url:c,data:b,callback:e},{type:"GET",url:d.OrderModel.updateUrl,callback:d.OrderModel.modelUpdate}],g.packageReq(a),!1):void d.OrderModel.couponError("Не введен номер")},selectPoint:function(a){var b=null;return a.parentBoxToken?(b=d.OrderModel.getDeliveryBoxByToken(a.parentBoxToken),b.selectPoint.apply(b,[a]),!1):(d.OrderModel.statesPriority=d.OrderModel.tmpStatesPriority,d.OrderModel.choosenPoint(a.id),d.OrderModel.showPopupWithPoints(!1),i(d.OrderModel.statesPriority),!1)},chooseDeliveryTypes:function(a,b){var e=a.states[0],f=b.target.htmlFor;return h.trigger("trackUserAction",["1_1 Доставка",a.shortName]),c("#"+f).attr("checked")?!1:(d.OrderModel.deliveryTypesButton=f,d.OrderModel.tmpStatesPriority=a.states,d.OrderModel.choosenDeliveryTypeId=a.id,d.OrderModel.orderDictionary.hasPointDelivery(e)?(d.OrderModel.popupWithPoints({header:a.name,points:d.OrderModel.orderDictionary.getAllPointsByState(e)}),d.OrderModel.showPopupWithPoints(!0),!1):(d.OrderModel.statesPriority=d.OrderModel.tmpStatesPriority,d.OrderModel.choosenPoint(0),i(d.OrderModel.statesPriority),!1))},modelUpdate:function(a){m(a),i(d.OrderModel.statesPriority)},deleteItem:function(c){var e=null;g.blockScreen.block("Удаляем");var f=function(b){var c=d.OrderModel.orderDictionary.products,e=0,f=0,g={};if(!b.product)return!1;for(var h in c)e+=c[h].price,f+=c[h].quantity;g={"Checkout Step 1 SKU Quantity":f,"Checkout Step 1 SKU Total":e},"undefined"!=typeof _kmq&&_kmq.push(["set",g]),"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Order card","Item deleted"]),b.hasOwnProperty("product")&&b.product.hasOwnProperty("id")&&a.rrApiOnReady.push(function(){a.rrApi.removeFromBasket(b.product.id)})},h=function(a){if(!a.success)return g.blockScreen.unblock(),!1;if(f(a),a.product){var c=a.product.id,d=a.category_id;!function(a){var c=b,d=c.createElement("IMG"),e=c.body;a=a.replace(/!\[rnd\]/,Math.round(9999999*Math.random()))+"&tail256="+escape(c.referrer||"unknown"),d.style.position="absolute",d.style.width=d.style.height="0px",d.onload=d.onerror=function(){e.removeChild(d),d=e=null},d.src=a,e.insertBefore(d,e.firstChild)}("http://ad.adriver.ru/cgi-bin/rle.cgi?sid=182615&sz=del_basket&bt=55&pz=0&custom=10="+c+";11="+d+"&![rnd]")}};return e=[{type:"GET",url:c.deleteUrl,callback:h},{type:"GET",url:d.OrderModel.updateUrl,callback:d.OrderModel.modelUpdate}],g.packageReq(e),!1},prepareProductsQuantityByUniq:function(a){var b,c,e,f=[];for(c=a.length-1;c>=0;c--)for(b=d.utils.cloneObject(a[c]),b.sum=b.price,b.quantity=1,b.oldQuantity=a[c].quantity,e=a[c].quantity-1;e>=0;e--)f.push(b);return f}},e.applyBindings(d.OrderModel);var j=function(a){var b='<div class="popupbox width290"><div class="font18 pb18"> '+a+'</div></div><p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>',d=c("<div>").addClass("popup").html(b),e=c.Deferred();d.appendTo("body");var f=function(){d.trigger("close"),d.remove(),e.resolve()};return d.lightbox_me({centered:!0,closeClick:!1,closeEsc:!1}),d.find(".closePopup").bind("click",f),e.promise()},k={"default":function(a){var b="Товар "+(a.name?a.name:"")+" недоступен для продажи.",d=c.Deferred();return c.when(j(b)).then(function(){c.ajax({type:"GET",url:a.deleteUrl}).then(d.resolve)}),d.promise()},708:function(a){var b="",e=c.Deferred();b=a.name&&a.error.message&&a.quantity?"Вы заказали товар "+a.name+" в количестве "+a.quantity+" шт. <br/ >"+a.error.message:"Товар недоступен для продажи",c.when(j(b)).then(function(){var b=[{type:"GET",url:a.setUrl,callback:e.resolve},{type:"GET",url:d.OrderModel.updateUrl,callback:d.OrderModel.modelUpdate}];return g.packageReq(b),e.promise()})}},l=function(a){var d=null,e=[];for(d in a.products)a.products[d].error&&a.products[d].error.code&&e.push(a.products[d]);var f=function g(a,b){var d=null;return 0>a?void b():(d=e[a].error.code,d=k.hasOwnProperty(d)?d:"default",void c.when(k[d](e[a])).then(function(){var c=a-1;g(c,b)}))};0===e.length&&a.error.message?c.when(j(a.error.message)).then(function(){a.redirect&&(b.location.href=a.redirect)}):f(e.length-1,function(){a.redirect&&(b.location.href=a.redirect)})},m=function(b){var c,e;return g.blockScreen.unblock(),b.success?(b.error&&b.error.message&&j(b.error.message),d.OrderModel.orderDictionary=new d.constructors.OrderDictionary(b),b.paypalECS&&d.OrderModel.paypalECS(!0),b.cart&&b.cart.sum&&(d.OrderModel.cartSum=b.cart.sum),d.OrderModel.deliveryTypes(b.deliveryTypes),d.OrderModel.lifeGift(b.lifeGift||!1),d.OrderModel.oneClick(b.oneClick||!1),d.OrderModel.prepareData(!0),d.OrderModel.paypalECS()&&a.docCookies.hasItem("chTypeBtn_paypalECS")&&a.docCookies.hasItem("chPoint_paypalECS")&&a.docCookies.hasItem("chTypeId_paypalECS")&&a.docCookies.hasItem("chStetesPriority_paypalECS")&&(d.OrderModel.deliveryTypesButton=a.docCookies.getItem("chTypeBtn_paypalECS"),d.OrderModel.choosenPoint(a.docCookies.getItem("chPoint_paypalECS")),d.OrderModel.choosenDeliveryTypeId=a.docCookies.getItem("chTypeId_paypalECS"),d.OrderModel.statesPriority=JSON.parse(a.docCookies.getItem("chStetesPriority_paypalECS")),i(d.OrderModel.statesPriority)),void(1===b.deliveryTypes.length&&(c=b.deliveryTypes[0],e=d.OrderModel.orderDictionary.getFirstPointByState(c.states[0])||c.id,d.OrderModel.statesPriority=c.states,d.OrderModel.deliveryTypesButton="method_"+c.id,d.OrderModel.choosenDeliveryTypeId=c.id,d.OrderModel.choosenPoint(e),i(d.OrderModel.statesPriority)))):(l(b),!1)},n=function(a){return d.OrderModel.selectPoint({id:c(this).data("pointid"),parentBoxToken:c(this).data("parentbox")}),!1},o=function(b){var c,d=0,e=0,f=[],g={};for(c in b.products)d+=b.products[c].price,e+=b.products[c].quantity,f.push({id:b.products[c].id,name:b.products[c].name,price:b.products[c].price,quantity:b.products[c].quantity});g={"Checkout Step 1 SKU Quantity":e,"Checkout Step 1 SKU Total":d,"Checkout Step 1 Order Type":"cart order"},"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","New order","Items",e]),"undefined"!=typeof _kmq&&_kmq.push(["record","Checkout Step 1",g]),a.APRT_DATA=a.APRT_DATA||{},a.APRT_DATA.pageType=5,a.APRT_DATA.orderInfo=a.APRT_DATA.orderInfo||{},a.APRT_DATA.orderInfo.totalPrice=d,a.APRT_DATA.basketProducts=f};m(f),o(f),h.on("click",".shopchoose",n)}(this,this.document,this.jQuery,this.ENTER,this.ko);