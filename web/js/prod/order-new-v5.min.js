(function(e){var o=(e.config.pageConfig.userUrl,e.constructors);o.DeliveryBox=function(){"use strict";function e(o,r,t){if(!(this instanceof e))return new e(o,r,t);console.info("Cоздание блока доставки "+r+" для "+t);var n,i=this;if(i.isUnique=window.OrderModel.orderDictionary.isUniqueDeliveryState(r),i.token=r+"_"+t,i.products=[],i.fullPrice=0,i.state=r,i.deliveryName=window.OrderModel.orderDictionary.getNameOfState(r),i.deliveryPrice=Number.POSITIVE_INFINITY,i.choosenDate=ko.observable(),i.choosenNameOfWeek=ko.observable(),i.choosenPoint=ko.observable({id:t}),i.choosenInterval=ko.observable(),i.showPopupWithPoints=ko.observable(!1),i.hasPointDelivery=window.OrderModel.orderDictionary.hasPointDelivery(r),i.allDatesForBlock=ko.observableArray([]),i.pointList=[],i.point_name="",i.hasPointDelivery&&!window.OrderModel.orderDictionary.getPointByStateAndId(i.state,t)?(console.info("есть точки доставки для выбранного метода доставки, но выбранная точка не доступна для этого метода доставки. Берем первую точку для выбранного метода доставки"),i.choosenPoint(window.OrderModel.orderDictionary.getFirstPointByState(i.state))):i.hasPointDelivery?(console.info("есть точки доставки для выбранного метода доставки, и выбранная точка доступна для этого метода доставки"),i.choosenPoint(window.OrderModel.orderDictionary.getPointByStateAndId(i.state,t))):(console.info("для выбранного метода доставки не нужна точка доставки"),window.OrderModel.hasHomeDelivery(!0),$("body").trigger("orderdeliverychange",[!0])),i.calendarSliderLeft=ko.observable(0),i.addProductGroup(o),0===i.products.length)return console.warn("в блоке "+i.token+" не осталось товаров"),void 0;if("pickpoint"===r)for(n=i.pointList.length-1;n>=0;n--)t==i.pointList[n].id&&(i.point_name=i.pointList[n].point_name);window.OrderModel.deliveryBoxes.push(i)}return e.prototype._makePointList=function(){console.info("Создание списка точек доставки");var e=this,o=!0,r=null;for(var t in e.products[0].deliveries[e.state]){for(var n=e.products.length-1;n>=0&&(o=e.products[n].deliveries[e.state].hasOwnProperty(t),o);n--);o&&(r=window.OrderModel.orderDictionary.getPointByStateAndId(e.state,t),e.pointList.push(r))}console.log("Точки доставки созданы"),console.log(e.pointList)},e.prototype.addUniqueSuffix=function(e){e=e||"";var o;return o=Math.floor(1e4*Math.random()+1),e+="_"+o},e.prototype.selectPoint=function(e){var o=this,r=o.state+"_"+e.id,t=null;return window.OrderModel.hasDeliveryBox(r)?(t=global.OrderModel.getDeliveryBoxByToken(r),t.addProductGroup(o.products),window.OrderModel.removeDeliveryBox(o.token)):(o.isUnique&&(r+=o.addUniqueSuffix()),console.info("удаляем старый блок"),console.log("старый токен "+o.token),console.log("новый токен "+r),o.token=r,o.choosenPoint(window.OrderModel.orderDictionary.getPointByStateAndId(o.state,e.id)),console.log(window.OrderModel.deliveryBoxes()),window.OrderModel.paypalECS()&&(console.info("PayPal ECS включен. Необходимо сохранить выбранную точку доставки в cookie"),window.docCookies.setItem("chPoint_paypalECS",e.id,600))),window.OrderModel.showPopupWithPoints(!1),!1},e.prototype.changePoint=function(){for(var e=this,o=e.pointList.length-1;o>=0;o--)e.pointList[o].parentBoxToken=e.token;return window.OrderModel.popupWithPoints({header:"Выберите точку доставки",points:e.pointList}),window.OrderModel.showPopupWithPoints(!0),!1},e.prototype._getFirstPropertyName=function(e){for(var o in e)return o},e.prototype._addProduct=function(o){var r=this,t=null,n=null,i=null,l=[],a=null,d={};return o.deliveries[r.state].hasOwnProperty(r.choosenPoint().id)?(t=parseInt(o.deliveries[r.state][r.choosenPoint().id].price,10),r.deliveryPrice=r.deliveryPrice>t?t:r.deliveryPrice,d={id:o.id,name:o.name,price:o.sum?o.sum:o.price,quantity:o.quantity,deleteUrl:o.deleteUrl,productUrl:o.url,productImg:o.image?o.image:o.productImg,deliveries:{}},d.deliveries[r.state]=o.deliveries[r.state],r.fullPrice+=d.price,r.products.push(d),void 0):(console.warn("Для товара "+o.id+" нет пункта доставки "+r.choosenPoint().id+" Необходимо создать новый блок"),i=r._getFirstPropertyName(o.deliveries[r.state]),n=r.state+"_"+i,l.push(o),window.OrderModel.hasDeliveryBox(n)?(console.log("Блок для этого типа доставки в этот пункт уже существует. Добавляем продукт в блок"),a=global.OrderModel.getDeliveryBoxByToken(n),a.addProductGroup(o),window.OrderModel.removeDeliveryBox(r.token)):(console.log("Блока для этого типа доставки в этот пункт еще существует"),new e(l,r.state,i)),void 0)},e.prototype.updateTotalPrice=function(){console.info("Перерасчет общей стоимости заказа");var e=this,o=window.OrderModel.totalSum();o+=e.fullPrice+e.deliveryPrice,window.OrderModel.totalSum(o),console.log(window.OrderModel.totalSum())},e.prototype.addProductGroup=function(e){var o=this;console.info("добавляем товары в блок");for(var r=e.length-1;r>=0;r--)console.log(r+"ый пошел..."),console.log(e[r]),o._addProduct(e[r]);return o.products.length?(o.calculateDate(),o.updateTotalPrice(),o.hasPointDelivery&&(console.info("У товара есть точки доставки. Создаем список точек доставки"),o._makePointList()),void 0):(console.warn("в блоке "+o.token+" нет товаров"),void 0)},e.prototype._getNameDayOfWeek=function(e){var o=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"];return o[e]},e.prototype._getFullNameDayOfWeek=function(e){var o=["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"];return o[e]},e.prototype._hasDateInAllProducts=function(e){for(var o=this,r=null,t=null,n=!0,i=o.products.length-1;i>=0;i--){r=o.products[i].deliveries[o.state][o.choosenPoint().id].dates;for(var l=0,a=r.length;a>l;l++){if(t=r[l].value,t===e){n=!0;break}n=!1}if(!n)break}return n},e.prototype.clickCalendarDay=function(e){var o=this;return e.avalible?(window.OrderModel.paypalECS()&&(console.info("PayPal ECS включен. Необходимо сохранить выбранную дату в cookie"),window.docCookies.setItem("chDate_paypalECS",JSON.stringify(e),600)),o.choosenNameOfWeek(o._getFullNameDayOfWeek(e.dayOfWeek)),o.choosenDate(e),void 0):!1},e.prototype.calculateDate=function(){console.info("Вычисление общей даты для продуктов в блоке");var o=this,r=window.OrderModel.orderDictionary.getToday(),t=null,n=null,i="",l=null,a=[],d=null;console.log("Сегодняшняя дата с сервера "+r),t=o.products[0].deliveries[o.state][o.choosenPoint().id].dates;for(var s=0,c=t.length;c>s;s++)n=t[s].value,o._hasDateInAllProducts(n)&&n>=r&&(t[s].avalible=!0,t[s].humanDayOfWeek=o._getNameDayOfWeek(t[s].dayOfWeek),o.allDatesForBlock.push(t[s]));o.allDatesForBlock().length||(console.warn("нет общих дат для блока. Необходимо разделить продукты в блоке"),l=o.products.pop(),a.push(l),i=o.state+"_"+o.choosenPoint().id+"_"+o.addUniqueSuffix(),console.log("новый токен "+i),console.log(o),new e(a,o.state,o.choosenPoint().id),o.calculateDate()),window.OrderModel.paypalECS()&&window.docCookies.hasItem("chDate_paypalECS")?(console.info("PayPal ECS включен. Необходимо взять выбранную дату из cookie"),d=window.docCookies.getItem("chDate_paypalECS"),o.choosenDate(JSON.parse(d))):o.choosenDate(o.allDatesForBlock()[0]),o.choosenNameOfWeek(o._getFullNameDayOfWeek(o.choosenDate().dayOfWeek)),0!==o.choosenDate().intervals.length&&o.choosenInterval(o.choosenDate().intervals[0]),o.makeCalendar()},e.prototype.makeCalendar=function(){console.info("Создание календаря, округление до целых недель");var e,o,r,t=this,n=0,i={},l=null,a=null,d=864e5;for(r=0;t.allDatesForBlock().length-1>=r;r++){if(void 0===t.allDatesForBlock()[r+1]){console.info("Следущая дата последняя. заканчиваем цикл");break}i={},l=t.allDatesForBlock()[r].value+d,a=new Date(l),l!==t.allDatesForBlock()[r+1].value&&(i={value:l,avalible:!1,humanDayOfWeek:t._getNameDayOfWeek(a.getDay()),dayOfWeek:a.getDay(),day:a.getDate()},console.log("предыдущая дата была "+new Date(t.allDatesForBlock()[r].value).getDate()+" новая дата вклинилась "+a.getDate()+" следущая дата "+new Date(t.allDatesForBlock()[r+1].value).getDate()),t.allDatesForBlock.splice(r+1,0,i))}if(1!==t.allDatesForBlock()[0].dayOfWeek)for(n=0===t.allDatesForBlock()[0].dayOfWeek?6:t.allDatesForBlock()[0].dayOfWeek-1,l=t.allDatesForBlock()[0].value,e=n;e>0;e--)l-=d,a=new Date(l),i={avalible:!1,humanDayOfWeek:t._getNameDayOfWeek(a.getDay()),dayOfWeek:a.getDay(),day:a.getDate()},t.allDatesForBlock.unshift(i);if(0!==t.allDatesForBlock()[t.allDatesForBlock().length-1].dayOfWeek)for(n=7-t.allDatesForBlock()[t.allDatesForBlock().length-1].dayOfWeek,l=t.allDatesForBlock()[t.allDatesForBlock().length-1].value,o=n;o>0;o--)l+=d,a=new Date(l),i={avalible:!1,humanDayOfWeek:t._getNameDayOfWeek(a.getDay()),dayOfWeek:a.getDay(),day:a.getDate()},t.allDatesForBlock.push(i)},e.prototype.calendarLeftBtn=function(){var e=this,o=parseInt(e.calendarSliderLeft(),10);o+=380,e.calendarSliderLeft(o)},e.prototype.calendarRightBtn=function(){var e=this,o=parseInt(e.calendarSliderLeft(),10);o-=380,e.calendarSliderLeft(o)},e}()})(window.ENTER),function(){var e=$(".bBankWrap"),o=function o(){var o=e.find(".bBankLink"),r=e.find(".bBankLink__eName"),t=e.find(".bSelect"),n=$("#selectedBank"),i=e.find(".bSelectWrap_eText"),l=function l(){var e=$("option:selected",t).attr("data-link"),l=$("option:selected",t).val(),a=$("option:selected",t).html();i.html(a),r.html(a),n.val(l),o.attr("href",e)};$("option",t).eq(0).attr("selected","selected"),t.change(l),l(),DirectCredit.init($("#jsCreditBank").data("value"),$("#creditPrice"))};e.length&&o()}(this),function(e){var o=(e.config.pageConfig.userUrl,e.constructors);o.OrderDictionary=function(){"use strict";function e(o){return this instanceof e?(this.orderData=o,this.serverTime=this.orderData.time,this.deliveryTypes=this.orderData.deliveryTypes,this.deliveryStates=this.orderData.deliveryStates,this.pointsByDelivery=this.orderData.pointsByDelivery,this.products=this.orderData.products,void 0):new e(o)}return e.prototype.getNameOfState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].name:(console.warn("Не найден метод доставки "+e),!1)},e.prototype.getToday=function(){return this.serverTime},e.prototype.hasDeliveryState=function(e){return this.deliveryStates.hasOwnProperty(e)},e.prototype.isUniqueDeliveryState=function(e){if(this.deliveryStates.hasOwnProperty(e)){var o=this.deliveryStates[e];return o.unique}return!1},e.prototype.hasPointDelivery=function(e){return this.pointsByDelivery.hasOwnProperty(e)},e.prototype.getPointByStateAndId=function(e,o){var r=this.getAllPointsByState(e);o+="";for(var t=r.length-1;t>=0;t--)if(r[t].id===o)return window.ENTER.utils.cloneObject(r[t]);return!1},e.prototype.getFirstPointByState=function(e){var o=this.getAllPointsByState(e),r=!1;return o[0]&&(r=window.ENTER.utils.cloneObject(o[0])),r},e.prototype.getAllPointsByState=function(e){var o=this.pointsByDelivery[e],r=this.orderData[o]||!1;return r},e.prototype.getProductFromState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].products:(console.warn("Не найден метод доставки "+e),!1)},e.prototype.getProductById=function(e){return this.products.hasOwnProperty(e)?this.products[e]:(console.warn("Такого продукта не найдено"),!1)},e}()}(window.ENTER),function(){if(!$("#paymentMethod-10").length)return console.warn("нет метода оплаты сертификатом"),!1;var e=$("#paymentMethod-10").parent(),o=e.find(".mCardNumber"),r=e.find(".mCardPin"),t=e.find(".bPayMethodAction"),n=t.attr("data-url"),i=function(){var e=!1,i="processBlock",l=function l(){return o.val().replace(/[^0-9]/g,"")},a=function a(){return r.val().replace(/[^0-9]/g,"")},d=function d(){return{code:l(),pin:a()}},s=function s(){return e&&""!==l()&&14===l().length&&""!==a()&&4===a().length?!0:!1},c=function c(){return 4!==r.val().length?(console.warn("пин код мал"),!1):o.val().length?(u("mOrange","Проверка по номеру карты"),$.post(n,d(),function(e){if(!("success"in e))return!1;if(!e.success){var o=e.error!==void 0?e.error:"ERROR";return u("mRed",o),!1}u("mGreen",e.data)}),void 0):(console.warn("номер карты не введен"),!1)},u=function u(o,r){console.info("setProcessingStatus");var n=$(".process").first(),l={typeNum:o};switch(n.hasClass("picked")||n.remove(),o){case"mOrange":l.text=r,e=!1;break;case"mRed":l.text="Произошла ошибка: "+r,e=!1;break;case"mGreen":l.text="activated"in r?"Карта "+r.code+" на сумму "+r.sum+" активирована!":"Карта "+r.code+" имеет номинал "+r.sum,e=!0}t.after(tmpl(i,l)),r.activated!==void 0&&$(".process").first().addClass("picked")};return{checkCard:c,setProcessingStatus:u,isActive:s,getCode:l,getPIN:a}}();o.bind("change",function(){i.checkCard()}),r.bind("change",function(){i.checkCard()}),$.mask.definitions.n="[0-9]",r.mask("nnnn",{completed:i.checkCard,placeholder:"*"})}(this),function(e){var o={},r=$("#metrostations").data("name"),t=$("#order_recipient_first_name"),n=($("#order_recipient_last_name"),$("#order_recipient_email")),i=$("#order_recipient_phonenumbers"),l=$("#order_address_metro"),a=$("#order_subway_id"),d=$("#order_address_street"),s=$("#order_address_building"),c=$("#sclub-number"),u=$('.jsCustomRadio[name="order[payment_method_id]"]'),p=$("#qiwi-phone"),y=$("#order_agreed"),h=$("#completeOrder"),v=null,f=null,g=null,m={fields:[{fieldNode:t,require:!0,customErr:"Введите имя получателя",validateOnChange:!0},{fieldNode:n,validBy:"isEmail",customErr:"Некорректно введен e-mail",validateOnChange:!0},{fieldNode:i,require:!0,customErr:"Некорректно введен телефон",validateOnChange:!0},{fieldNode:y,require:!0,customErr:"Необходимо согласие"},{fieldNode:u,require:!0,customErr:"Необходимо выбрать метод оплаты"}]},k={source:r,appendTo:"#metrostations",minLength:2,select:function(e,o){a.val(o.item.val)}};o=new FormValidator(m);var O=function O(e,o){var r='<div class="popupbox width290"><div class="font18 pb18"> '+e+"</div>"+"</div>"+'<p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>',t=$("<div>").addClass("popup").html(r);t.appendTo("body");var n=function(){return t.trigger("close"),t.remove(),void 0!==o&&o(),!1};t.lightbox_me({centered:!0,onClose:n}),t.find(".closePopup").bind("click",n)},w=function w(e){console.warn("Ошибка в поле");var r=$('[name="order['+e.field+']"]'),t=function t(){o._unmarkFieldError($(this))};o._markFieldError(r,e.message),r.bind("focus",t)},b={"default":function(e){return console.log("Обработчик ошибки"),e.error&&e.error.message?(O(e.error.message,function(){document.location.href=e.redirect}),void 0):(document.location.href=e.redirect,void 0)},0:function(e){console.warn("Обработка ошибок формы");var o=null;if(e.redirect)return O(e.error.message,function(){document.location.href=e.redirect}),void 0;O(e.error.message);for(var r=e.form.error.length-1;r>=0;r--)o=e.form.error[r],console.warn(o),w(o);$.scrollTo($(".mError").eq(0),500,{offset:-15})},743:function(e){O(e.error.message)}},D=function D(){if("undefined"!=typeof _gaq){for(var o=e.OrderModel.deliveryBoxes().length-1;o>=0;o--)_gaq.push(["_trackEvent","Order card","Completed","выбрана "+e.OrderModel.choosenDeliveryTypeId+" доставят "+e.OrderModel.deliveryBoxes()[o].state]);_gaq.push(["_trackEvent","Order complete",e.OrderModel.deliveryBoxes().length,e.OrderModel.orderDictionary.products.length]),_gaq.push(["_trackTiming","Order complete","DB response",g])}"undefined"!=typeof yaCounter10503055&&yaCounter10503055.reachGoal("\\orders\\complete")},P=function P(o){return console.info("данные отправлены. получен ответ от сервера"),f=(new Date).getTime(),g=f-v,console.log(o),o.success?(D(),e.OrderModel.paypalECS()&&!h.hasClass("mConfirm")&&(console.info("PayPal ECS включен. Заказ оформлен. Необходимо удалить выбранные параметры из cookie"),window.docCookies.removeItem("chDate_paypalECS","/"),window.docCookies.removeItem("chTypeBtn_paypalECS","/"),window.docCookies.removeItem("chPoint_paypalECS","/"),window.docCookies.removeItem("chTypeId_paypalECS","/"),window.docCookies.removeItem("chStetesPriority_paypalECS","/")),document.location.href=o.redirect,void 0):(console.log("ошибка оформления заказа"),e.ENTER.utils.blockScreen.unblock(),b.hasOwnProperty(o.error.code)?(console.log("Есть обработчик"),b[o.error.code](o)):(console.log("Стандартный обработчик"),b["default"](o)),!1)},M=function M(){var o,r,t,n=null,i=[],l=[],a={},d=$("#order-form");for(e.ENTER.utils.blockScreen.block("Ваш заказ оформляется"),console.info("Перебираем блоки доставки"),r=e.OrderModel.deliveryBoxes().length-1;r>=0;r--){for(a={},n=e.OrderModel.deliveryBoxes()[r],o=n.choosenPoint(),console.log("currentDeliveryBox:"),console.log(n),a={deliveryMethod_token:n.state,date:n.choosenDate().value,interval:[n.choosenInterval()?n.choosenInterval().start:"",n.choosenInterval()?n.choosenInterval().end:""],point_id:o.id,point_name:n.point_name,products:[]},console.log("choosPoint:"),console.log(o),"pickpoint"===n.state&&(console.log("Is PickPoint!"),a.point_id=o.number,d.find("#order_address_street").val(o.street),d.find("#order_address_building").val(o.house),d.find("#order_address_number").val(""),d.find("#order_address_apartment").val(""),d.find("#order_address_floor").val("")),t=n.products.length-1;t>=0;t--)a.products.push(n.products[t].id);console.log("tmpPart:"),console.log(a),i.push(a)}l=d.serializeArray(),l.push({name:"order[delivery_type_id]",value:e.OrderModel.choosenDeliveryTypeId}),l.push({name:"order[part]",value:JSON.stringify(i)}),window.KM!==void 0&&l.push({name:"kiss_session",value:window.KM.i}),console.log("dataToSend:"),console.log(l),v=(new Date).getTime(),$.ajax({url:d.attr("action"),timeout:12e4,type:"POST",data:l,success:P,statusCode:{500:function(){O("Неудалось создать заказ. Попробуйте позднее.")},504:function(){O("Неудалось создать заказ. Попробуйте позднее.")}}})},S=function S(){return console.info("Завершить оформление заказа"),o.validate({onInvalid:function(e){console.warn("invalid"),console.log(e),$.scrollTo(e[e.length-1].fieldNode,500,{offset:-15})},onValid:M}),!1},_=function _(){for(var e=r.length-1;e>=0;e--)if(l.val()===r[e].label)return;l.val("")},B=function B(e,t){t?(o.setValidate(d,{require:!0,customErr:"Не введено название улицы",validateOnChange:!0}),o.setValidate(s,{require:!0,customErr:"Не введен номер дома",validateOnChange:!0}),void 0!==r&&o.setValidate(l,{fieldNode:l,customErr:"Не выбрана станция метро",require:!0,validateOnChange:!0})):(o.setValidate(d,{require:!1}),o.setValidate(s,{require:!1}),void 0!==r&&o.setValidate(l,{require:!1})),console.info("Изменен тип доставки"),console.log(o)};$.mask.definitions.n="[0-9]",c.mask("2 98nnnn nnnnnn",{placeholder:"*"}),p.mask("(nnn) nnn-nn-nn"),i.mask("(nnn) nnn-nn-nn"),e.docCookies.getItem("emails")&&(console.log("AB TEST: e-mail require"),o.setValidate(n,{require:!0}));var C=function C(e){var o=null;console.info("defaultValueToField");for(var r in e)if(console.log("поле "+r),e[r]){if(console.log("для поля есть значение "+e[r]),o=$('input[name="'+r+'"]'),"radio"===o.attr("type")){o.filter('[value="'+e[r]+'"]').attr("checked","checked").trigger("change");continue}o.val(e[r])}};if(C($("#jsOrderForm").data("value")),void 0!==r){l.autocomplete(k),l.bind("change",_);for(var E=r.length-1;E>=0;E--)if(parseInt(a.val(),10)===r[E].val){l.val(r[E].label);break}}$("body").bind("orderdeliverychange",B),h.bind("click",S)}(this),function(e){var o=$("#jsOrderDelivery").data("value"),r=e.ENTER.utils,t=function t(o){var r={},t=[],i=[],l=null,a=null,d=null,s=null,c=null,u=null,p=[];discounts=e.OrderModel.orderDictionary.orderData.discounts,e.OrderModel.paypalECS()&&(console.info("PayPal ECS включен. Необходимо сохранить выбранные параметры в cookie"),window.docCookies.setItem("chTypeBtn_paypalECS",e.OrderModel.deliveryTypesButton,600),window.docCookies.setItem("chPoint_paypalECS",e.OrderModel.choosenPoint(),600),window.docCookies.setItem("chTypeId_paypalECS",e.OrderModel.choosenDeliveryTypeId,600),window.docCookies.setItem("chStetesPriority_paypalECS",JSON.stringify(e.OrderModel.statesPriority),600)),e.OrderModel.deliveryBoxes.removeAll(),e.OrderModel.hasCoupons(!1),console.log("Маркируем выбранный способ доставки"),$("#"+e.OrderModel.deliveryTypesButton).attr("checked","checked").trigger("change"),e.OrderModel.totalSum(0),e.OrderModel.hasHomeDelivery(!1),$("body").trigger("orderdeliverychange",[!1]);for(var y=0,h=o.length;h>y;y++)if(d=o[y],u=e.OrderModel.orderDictionary.isUniqueDeliveryState(d),console.info("перебирем "+(u?"уникальный* ":"")+"метод "+d),i=[],e.OrderModel.orderDictionary.hasDeliveryState(d)){t=e.OrderModel.orderDictionary.getProductFromState(d);for(var v=t.length-1;v>=0;v--)s=t[v],r[s]?console.log("товар "+s+" уже определялся к блоку"):(console.log("добавляем товар "+s+" в блок для метода "+d),r[s]=!0,i.push(e.OrderModel.orderDictionary.getProductById(s)));if(i.length)if(l=e.OrderModel.orderDictionary.hasPointDelivery(d)?e.OrderModel.choosenPoint():0,a=d+"_"+l,e.OrderModel.hasDeliveryBox(a))c=e.OrderModel.getDeliveryBoxByToken(a),c.addProductGroup(i);else if(u)for(p=e.OrderModel.prepareProductsByUniq(i),v=p.length-1;v>=0;v--)s=[p[v]],e.ENTER.constructors.DeliveryBox(s,d,l);else e.ENTER.constructors.DeliveryBox(i,d,l)}else console.info("для метода "+d+" нет товаров");if(console.info("Созданные блоки:"),console.log(e.OrderModel.deliveryBoxes()),e.OrderModel.couponsBox(discounts),e.OrderModel.couponsBox(discounts),e.OrderModel.couponUrl($(".bSaleList__eItem:visible .jsCustomRadio").eq(0).val()),$(".bSaleList__eItem:visible .jsCustomRadio").eq(0).trigger("change"),e.OrderModel.hasCoupons()&&e.OrderModel.deliveryBoxes().length>1||e.OrderModel.appliedCoupon()&&e.OrderModel.appliedCoupon().sum&&e.OrderModel.totalSum()<=e.OrderModel.appliedCoupon().sum){console.warn("Нужно удалить купон");var f="Купон не может быть применен при текущем разбиении заказа и будет удален",g=function(){console.log("удаление"),e.OrderModel.deleteItem(e.OrderModel.appliedCoupon())};return $.when(n(f)).then(g),!1}r.length!==e.OrderModel.orderDictionary.orderData.products.length&&console.warn("не все товары были обработаны"),console.warn("end")};ko.bindingHandlers.popupShower={update:function(o,r){var t=r(),n=ko.utils.unwrapObservable(t),i=null;n?(i=new e.ENTER.constructors.CreateMap("pointPopupMap",e.OrderModel.popupWithPoints().points,$("#mapInfoBlock")),$(o).lightbox_me({centered:!0,onClose:function(){console.info("закрываем"),t(!1)}})):($("#pointPopupMap").empty(),$(o).trigger("close"))}},ko.bindingHandlers.paymentMethodVisible={update:function(o,r){var t=r(),n=ko.utils.unwrapObservable(t),i=$(o),l=parseInt($(o).data("value")["max-sum"],10),a=$(o).data("value").method_id;return 4===e.OrderModel.choosenDeliveryTypeId&&13===a?(i.hide(),void 0):(isNaN(l)||(n>l?i.hide():i.show()),void 0)}},ko.bindingHandlers.calendarSlider={update:function(e,o,r,t,n){var i=$(e),l=o(),a=i.find(".bBuyingDatesItem"),d=a.width()+parseInt(a.css("marginRight"),10)+parseInt(a.css("marginLeft"),10);return i.width(a.length*d),l>0?(l-=380,n.box.calendarSliderLeft(l),void 0):-i.width()>l?(l+=380,n.box.calendarSliderLeft(l),void 0):(i.animate({left:l}),void 0)}},ko.bindingHandlers.couponsVisible={update:function(o,r){var t=r(),n=ko.utils.unwrapObservable(t),i=$(o),l=i.find(".mSaleInput"),a=i.find(".mSaleBtn"),d=i.find(".bSaleData__eEmptyBlock");$(".bSaleList__eItem").removeClass("hidden");for(var s=n.length-1;s>=0;s--)i.find('.bSaleList__eItem[data-type="'+n[s].type+'"]').addClass("hidden"),"coupon"===n[s].type&&(console.log("Есть примененный купон"),e.OrderModel.hasCoupons(!0),e.OrderModel.appliedCoupon(n[s]));$(".bSaleList__eItem.hidden").length===$(".bSaleList__eItem").length||$(".bSaleList__eItem:hidden").length===$(".bSaleList__eItem").length?(l.attr("disabled","disabled"),a.attr("disabled","disabled").addClass("mDisabled"),d.show()):(l.removeAttr("disabled"),a.removeAttr("disabled").removeClass("mDisabled"),d.hide())}},e.OrderModel={updateUrl:$("#jsOrderDelivery").data("url"),prepareData:ko.observable(!1),showPopupWithPoints:ko.observable(!1),deliveryTypesButton:null,tmpStatesPriority:null,statesPriority:null,paypalECS:ko.observable(!1),cartSum:null,orderDictionary:null,choosenPoint:ko.observable(),hasHomeDelivery:ko.observable(!1),deliveryTypes:ko.observableArray([]),deliveryBoxes:ko.observableArray([]),popupWithPoints:ko.observable({}),totalSum:ko.observable(0),hasCoupons:ko.observable(!1),appliedCoupon:ko.observable(),couponNumber:ko.observable(),couponUrl:ko.observable(),couponError:ko.observable(),couponsBox:ko.observableArray([]),hasDeliveryBox:function(o){console.info("Существует ли блок доставки "+o);var r=null;for(r=e.OrderModel.deliveryBoxes().length-1;r>=0;r--)if(e.OrderModel.deliveryBoxes()[r].token===o)return!0;return!1},getDeliveryBoxByToken:function(o){console.info("Получить ссылку на блок по токену "+o);var r=null;for(r=e.OrderModel.deliveryBoxes().length-1;r>=0;r--)if(e.OrderModel.deliveryBoxes()[r].token===o)return e.OrderModel.deliveryBoxes()[r]},removeDeliveryBox:function(o){console.info("Удаление блока по токену "+o);var r=null;for(r=e.OrderModel.deliveryBoxes().length-1;r>=0;r--)if(e.OrderModel.deliveryBoxes()[r].token===o)return e.OrderModel.deliveryBoxes().splice(r,1),void 0},checkCoupon:function(){console.info("проверяем купон");var o,t={number:e.OrderModel.couponNumber()},n=e.OrderModel.couponUrl(),i=function i(o){return r.blockScreen.block("Применяем купон"),o.success?void 0:(e.OrderModel.couponError(o.error.message),r.blockScreen.unblock(),void 0)};return e.OrderModel.couponError(""),void 0===n?(console.warn("Не выбран тип сертификата"),e.OrderModel.couponError("Не выбран тип сертификата"),void 0):void 0!==t.number&&t.number.length?(o=[{type:"POST",url:n,data:t,callback:i},{type:"GET",url:e.OrderModel.updateUrl,callback:e.OrderModel.modelUpdate}],r.packageReq(o),!1):(console.warn("Не введен номер сертификата"),e.OrderModel.couponError("Не введен номер сертификата"),void 0)},selectPoint:function(o){console.info("point selected..."),console.log(o.parentBoxToken);var r=null;return o.parentBoxToken?(r=e.OrderModel.getDeliveryBoxByToken(o.parentBoxToken),console.log(r),r.selectPoint.apply(r,[o]),!1):(e.OrderModel.statesPriority=e.OrderModel.tmpStatesPriority,e.OrderModel.choosenPoint(o.id),e.OrderModel.showPopupWithPoints(!1),t(e.OrderModel.statesPriority),!1)},chooseDeliveryTypes:function(o,r){var n=o.states[0],i=r.target.htmlFor;return $("#"+i).attr("checked")?!1:(e.OrderModel.deliveryTypesButton=i,e.OrderModel.tmpStatesPriority=o.states,e.OrderModel.choosenDeliveryTypeId=o.id,e.OrderModel.orderDictionary.hasPointDelivery(n)?(e.OrderModel.popupWithPoints({header:o.description,points:e.OrderModel.orderDictionary.getAllPointsByState(n)}),e.OrderModel.showPopupWithPoints(!0),!1):(e.OrderModel.statesPriority=e.OrderModel.tmpStatesPriority,e.OrderModel.choosenPoint(0),t(e.OrderModel.statesPriority),!1))},modelUpdate:function(o){console.info("обновление данных с сервера"),a(o),t(e.OrderModel.statesPriority)},deleteItem:function(o){console.info("удаление");var t=null;r.blockScreen.block("Удаляем");var n=function n(){var r=e.OrderModel.orderDictionary.products,t=0,n=0,i={};if(!o.product)return!1;for(var l in r)t+=l[l].price,n+=l[l].quantity;i={"Checkout Step 1 SKU Quantity":n,"Checkout Step 1 SKU Total":t},"undefined"!=typeof _kmq&&_kmq.push(["set",i]),"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Order card","Item deleted"])},i=function i(e){if(console.info("deleteItemResponceHandler"),console.log(e),!e.success)return console.warn("не удалось удалить товар"),r.blockScreen.unblock(),!1;if(("undefined"!=typeof _gaq||"undefined"!=typeof _kmq)&&n(),e.product){var o=e.product.id,t=e.category_id;(function(e){var o=document,r=o.createElement("IMG"),t=o.body;e=e.replace(/!\[rnd\]/,Math.round(9999999*Math.random()))+"&tail256="+escape(o.referrer||"unknown"),r.style.position="absolute",r.style.width=r.style.height="0px",r.onload=r.onerror=function(){t.removeChild(r),r=t=null},r.src=e,t.insertBefore(r,t.firstChild)})("http://ad.adriver.ru/cgi-bin/rle.cgi?sid=182615&sz=del_basket&bt=55&pz=0&custom=10="+o+";11="+t+"&![rnd]")}};return console.log(o.deleteUrl),t=[{type:"GET",url:o.deleteUrl,callback:i},{type:"GET",url:e.OrderModel.updateUrl,callback:window.OrderModel.modelUpdate}],r.packageReq(t),!1},prepareProductsByUniq:function(e){var o,r,t,n=[];for(r=e.length-1;r>=0;r--)for(o=ENTER.utils.cloneObject(e[r]),o.sum=o.price,o.quantity=1,t=e[r].quantity-1;t>=0;t--)n.push(o);return n}},ko.applyBindings(e.OrderModel);var n=function n(e){var o='<div class="popupbox width290"><div class="font18 pb18"> '+e+"</div>"+"</div>"+'<p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>',r=$("<div>").addClass("popup").html(o),t=$.Deferred();r.appendTo("body");var n=function(){r.trigger("close"),r.remove(),t.resolve()};return r.lightbox_me({centered:!0,closeClick:!1,closeEsc:!1}),r.find(".closePopup").bind("click",n),t.promise()},i={"default":function(e){var o="Товар "+e.name+" недоступен для продажи.",r=$.Deferred();return $.when(n(o)).then(function(){$.ajax({type:"GET",url:e.deleteUrl}).then(r.resolve)}),r.promise()},708:function(e){var o="Вы заказали товар "+e.name+" в количестве "+e.quantity+" шт. <br/ >"+e.error.message,r=$.Deferred();return $.when(n(o)).then(function(){$.ajax({type:"GET",url:e.setUrl}).then(r.resolve)}),r.promise()}},l=function l(e){var o=null,r=[];for(o in e.products)e.products[o].error&&e.products[o].error.code&&r.push(e.products[o]);var t=function t(e,o){var n=null;return 0>e?(console.warn("return"),o(),void 0):(n=r[e].error.code,n=i.hasOwnProperty(n)?n:"default",$.when(i[n](r[e])).then(function(){var r=e-1;t(r,o)}),void 0)};0===r.length&&e.error.message?$.when(n(e.error.message)).then(function(){e.redirect&&(document.location.href=e.redirect)}):t(r.length-1,function(){console.warn("1 этап закончен"),e.redirect&&(document.location.href=e.redirect)})},a=function a(o){var n,i;return r.blockScreen.unblock(),o.success?(console.info("Данные с сервера получены"),e.OrderModel.orderDictionary=new e.ENTER.constructors.OrderDictionary(o),o.paypalECS&&(console.info("paypal true"),e.OrderModel.paypalECS(!0)),o.cart&&o.cart.sum&&(console.info("Есть первоначальная сумма корзины : "+o.cart.sum),e.OrderModel.cartSum=o.cart.sum),e.OrderModel.deliveryTypes(o.deliveryTypes),e.OrderModel.prepareData(!0),e.OrderModel.paypalECS()&&window.docCookies.hasItem("chTypeBtn_paypalECS")&&window.docCookies.hasItem("chPoint_paypalECS")&&window.docCookies.hasItem("chTypeId_paypalECS")&&window.docCookies.hasItem("chStetesPriority_paypalECS")&&(console.info("PayPal ECS включен. Необходимо применить параметры из cookie"),e.OrderModel.deliveryTypesButton=window.docCookies.getItem("chTypeBtn_paypalECS"),e.OrderModel.choosenPoint(window.docCookies.getItem("chPoint_paypalECS")),e.OrderModel.choosenDeliveryTypeId=window.docCookies.getItem("chTypeId_paypalECS"),e.OrderModel.statesPriority=JSON.parse(window.docCookies.getItem("chStetesPriority_paypalECS")),t(e.OrderModel.statesPriority)),1===o.deliveryTypes.length&&(n=o.deliveryTypes[0],i=e.OrderModel.orderDictionary.getFirstPointByState(n.states[0])||n.id,console.log("Обнаружен только 1 способ доставки: "+n.name+" — выбираем его."),console.log("Выбран первый пункт* доставки:"),console.log(i),e.OrderModel.statesPriority=n.states,e.OrderModel.deliveryTypesButton="method_"+n.id,e.OrderModel.choosenDeliveryTypeId=n.id,e.OrderModel.choosenPoint(i),t(e.OrderModel.statesPriority)),void 0):(console.warn("Данные содержат ошибки"),console.log(o.error),l(o),!1)},d=function d(o){return console.log("selectPointOnBaloon"),console.log(o),console.log($(this).data("pointid")),console.log($(this).data("parentbox")),e.OrderModel.selectPoint({id:$(this).data("pointid"),parentBoxToken:$(this).data("parentbox")}),!1},s=function(e){console.info("analyticsStep_1");var o=0,r=0,t={};for(var n in e.products)o+=e.products[n].price,r+=e.products[n].quantity;t={"Checkout Step 1 SKU Quantity":r,"Checkout Step 1 SKU Total":o,"Checkout Step 1 Order Type":"cart order"},"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","New order","Items",r]),"undefined"!=typeof _kmq&&_kmq.push(["record","Checkout Step 1",t])};a(o),s(o),$("body").on("click",".shopchoose",d)
}(this);