(function(e,o,t,r){var n,l,i=t("#page-config").data("value"),a=t("#jsOrderForm").data("value"),d=t("#metrostations").data("name"),s=t("#jsDeliveryAddress").data("value"),c=i?i.addressAutocomplete:!1,u=null,p=null,y=6,h=t("#order_address_street"),v=t("#order_address_building"),f=t("#order_address_number"),m=t("#order_address_metro"),g=(m.parents(".jsInputMetro"),t("#order_subway_id")),k=null,O=!1,b=s?s.regionName:"",D=t("#map"),P=function(){var e,o,r,n,l=12,i="";return e=t.trim(b),o="город",e&&(i&&(i+=", "),i+=o+" "+e,l=12),e=null,o=null,r=h.kladr("current"),n=t.trim(h.val()),r?(e=r.name,o=r.type+"."):n&&(e=n,o="улица"),e&&(i&&(i+=", "),i+=o+" "+e,l=14),e=null,o=null,r=v.kladr("current"),n=t.trim(v.val()),r?(e=r.name,o="дом"):n&&(e=n,o="дом"),e&&(i&&(i+=", "),i+=o+" "+e,l=16),e=null,o=null,n=t.trim(f.val()),n&&(e=n,o="корпус"),e&&(i&&(i+=", "),i+=o+" "+e,l=16),{address:i,zoom:l}},S=function(){var e,o,t,r,n=P();n.address&&O&&(console.log(n.address),e=ymaps.geocode(n.address),e.then(function(e){o=e.geoObjects.get(0).geometry.getCoordinates(),o&&(t=o[0],r=o[1],k.points=[],k.mapWS.geoObjects.each(function(e){k.mapWS.geoObjects.remove(e)}),k.points.push({latitude:t,longitude:r}),k._showMarkers(),k.mapWS.setCenter(o,n.zoom),m.length&&M(t,r))}))},M=function(e,o){var t,r,n;t=ymaps.geocode([e,o],{kind:"metro"}),t.then(function(e){if(r=e.geoObjects.get(0),n=r.properties.get("name"),n=n.replace("метро ",""),m.val(n),g.val(""),void 0!==d)for(var o=d.length-1;o>=0;o--)if(n===d[o].label){g.val(d[o].val);break}},function(e){console.warn("При выполнении запроса произошла ошибка: "+e),m.val(""),g.val("")})},_=function(e){return n=t("ul.error_list"),n.length?n.html("<li>"+e+"</li>"):t("#map",container).before(t('<ul class="error_list" />').append("<li>"+e+"</li>")),!1},B=function(){return n=t("ul.error_list"),n.length&&n.html(""),!1},C={city:function(){return b?(t.kladr.api({token:u,key:p,type:t.kladr.type.city,name:b,limit:1},function(e){return e.length?(l=e[0].id,h.kladr("parentType",t.kladr.type.city),h.kladr("parentId",l),t.kladr.api({token:u,key:p,type:t.kladr.type.street,name:a["order[address_street]"],parentType:t.kladr.type.city,parentId:l,limit:1},function(e){return e.length?(v.kladr("parentType",t.kladr.type.street),v.kladr("parentId",e[0].id),void 0):(_("Не нашли ваш адрес на карте. Уточните"),void 0)}),void 0):(console.log("КЛАДР не нашел город "+b),void 0)}),void 0):null},street:function(){h.kladr({token:u,key:p,type:t.kladr.type.street,verify:!0,limit:y,source:function(e){t.kladr.api({token:h.kladr("token"),key:h.kladr("key"),type:h.kladr("type"),name:e,parentType:h.kladr("parentType"),parentId:h.kladr("parentId"),limit:h.kladr("limit")},function(e){var o,r,n=[];if(!e.length)return _("Не нашли ваш адрес на карте. Уточните"),void 0;for(o in e)r=e[o],r.label=r.type+" "+r.name,r.value=r.name,n.push(r);h.autocomplete({source:n,appendTo:".jsInputStreet",minLength:2,select:function(e,o){B(),h.val(o.item.name),v.kladr("parentType",t.kladr.type.street),v.kladr("parentId",o.item.id),S()}})})}})},building:function(){v.kladr({token:u,key:p,type:t.kladr.type.building,verify:!0,limit:y,source:function(e){t.kladr.api({token:v.kladr("token"),key:v.kladr("key"),type:v.kladr("type"),name:e,parentType:v.kladr("parentType"),parentId:v.kladr("parentId"),limit:v.kladr("limit")},function(e){var o,t,r=[];if(!e.length)return _("Не нашли ваш адрес на карте. Уточните"),void 0;for(o in e)t=e[o],t.label=t.name,r.push(t);v.autocomplete({source:r,appendTo:".jsInputBuilding",minLength:0,select:function(e,o){B(),v.val(o.item.name),S()}})})}})},buildingAdd:function(){f.change(function(){S()})}},T=function(){C.city(),C.street(),C.building(),C.buildingAdd()},I=function(){var e,o,t=P();!O&&D.length&&(D.show().width(460).height(350),O=!0,e=ymaps.geocode(t.address),e.then(function(e){o=e.geoObjects.get(0).geometry.getCoordinates(),k=new r.constructors.CreateMap("map",[{latitude:o[0],longitude:o[1]}]),k.mapWS.setZoom(t.zoom)},function(e){console.log(e),_("Не нашли ваш город на карте."),k=new r.constructors.CreateMap("map",[{latitude:55.76,longitude:37.64}])}))};c&&(s&&s.kladr&&(u=s.kladr.token?s.kladr.token:null,p=s.kladr.key?s.kladr.key:null,y=s.kladr.itemLimit?s.kladr.itemLimit:6),T(),ymaps.ready(I))})(this,this.document,this.jQuery,this.ENTER),function(e,o,t,r,n){var l,i=r.constructors;r.utils,console.info("deliveryBox.js init"),console.log(r.OrderModel),i.DeliveryBox=function(){"use strict";function o(e,i,a){if(!(this instanceof o))return new o(e,i,a);console.info("Cоздание блока доставки "+i+" для "+a),console.log(this),l=r.OrderModel;var d=this;return d.isUnique=l.orderDictionary.isUniqueDeliveryState(i),d.token=i+"_"+a,d.products=[],d.fullPrice=0,d.totalBlockSum=0,d.state=i,d.deliveryName=l.orderDictionary.getNameOfState(i),d.deliveryPrice=Number.NEGATIVE_INFINITY,d.choosenDate=n.observable(),d.choosenNameOfWeek=n.observable(),d.choosenPoint=n.observable({id:a}),d.choosenInterval=n.observable(),d.showPopupWithPoints=n.observable(!1),d.hasPointDelivery=l.orderDictionary.hasPointDelivery(i),d.allDatesForBlock=n.observableArray([]),d.pointList=[],d.changePointButtonText=l.orderDictionary.getChangeButtonText(i),d.hasPointDelivery&&!l.orderDictionary.getPointByStateAndId(d.state,a)?(console.info("есть точки доставки для выбранного метода доставки, но выбранная точка не доступна для этого метода доставки. Берем первую точку для выбранного метода доставки"),d.choosenPoint(l.orderDictionary.getFirstPointByState(d.state))):d.hasPointDelivery?(console.info("есть точки доставки для выбранного метода доставки, и выбранная точка доступна для этого метода доставки"),d.choosenPoint(l.orderDictionary.getPointByStateAndId(d.state,a))):(console.info("для выбранного метода доставки не нужна точка доставки"),l.hasHomeDelivery(!0),t("body").trigger("orderdeliverychange",[!0])),d.calendarSliderLeft=n.observable(0),d.addProductGroup(e),0===d.products.length?(console.warn("в блоке "+d.token+" не осталось товаров"),void 0):(l.deliveryBoxes.push(d),void 0)}return o.prototype._makePointList=function(){console.info("Создание списка точек доставки");var e,o,t=this,r=!0,n=null;for(e in t.products[0].deliveries[t.state]){for(o=t.products.length-1;o>=0&&(r=t.products[o].deliveries[t.state].hasOwnProperty(e),r);o--);r&&(n=l.orderDictionary.getPointByStateAndId(t.state,e),t.pointList.push(n))}console.log("Точки доставки созданы"),console.log(t.pointList)},o.prototype.addUniqueSuffix=function(e){var o;return e=e||"",o=Math.floor(1e4*Math.random()+1),e+="_"+o},o.prototype.selectPoint=function(o){var t=this,n=t.state+"_"+o.id,i=null;return l.hasDeliveryBox(n)?(i=l.getDeliveryBoxByToken(n),i.addProductGroup(t.products),l.removeDeliveryBox(t.token)):(t.isUnique&&(n+=t.addUniqueSuffix()),console.info("удаляем старый блок"),console.log("старый токен "+t.token),console.log("новый токен "+n),t.token=n,t.choosenPoint(l.orderDictionary.getPointByStateAndId(t.state,o.id)),r.OrderModel.choosenPoint(o.id),console.log(l.deliveryBoxes()),l.paypalECS()&&(console.info("PayPal ECS включен. Необходимо сохранить выбранную точку доставки в cookie"),e.docCookies.setItem("chPoint_paypalECS",o.id,600))),l.showPopupWithPoints(!1),!1},o.prototype.changePoint=function(){var e,o=this;for(e=o.pointList.length-1;e>=0;e--)o.pointList[e].parentBoxToken=o.token;return l.popupWithPoints({header:"Выберите точку доставки",points:o.pointList}),l.showPopupWithPoints(!0),!1},o.prototype._getFirstPropertyName=function(e){for(var o in e)return o},o.prototype._addProduct=function(e){var t=this,n=null,i=null,a=null,d=[],s=null,c={};return e.deliveries[t.state].hasOwnProperty(t.choosenPoint().id)?(n=parseInt(e.deliveries[t.state][t.choosenPoint().id].price,10),t.deliveryPrice=n>t.deliveryPrice?n:t.deliveryPrice,c={id:e.id,name:e.name,price:e.sum?e.sum:e.price,quantity:e.quantity,deleteUrl:e.deleteUrl,setUrl:e.setUrl,productUrl:e.url,productImg:e.image?e.image:e.productImg,deliveries:{}},t.isUnique&&e.oldQuantity-1>0&&(console.log("Переделываем deleteUrl:"),console.log(c.deleteUrl),c.deleteUrl=c.deleteUrl.replace("delete-","add-"),c.deleteUrl+="?quantity="+(e.oldQuantity-1),console.log(c.deleteUrl)),c.deliveries[t.state]=e.deliveries[t.state],t.fullPrice=r.utils.numMethods.sumDecimal(c.price,t.fullPrice),t.products.push(c),void 0):(console.warn("Для товара "+e.id+" нет пункта доставки "+t.choosenPoint().id+" Необходимо создать новый блок"),a=t._getFirstPropertyName(e.deliveries[t.state]),i=t.state+"_"+a,d.push(e),l.hasDeliveryBox(i)?(console.log("Блок для этого типа доставки в этот пункт уже существует. Добавляем продукт в блок"),s=l.getDeliveryBoxByToken(i),s.addProductGroup(e),l.removeDeliveryBox(t.token)):(console.log("Блока для этого типа доставки в этот пункт еще существует"),new o(d,t.state,a)),void 0)},o.prototype.updateTotalPrice=function(){console.info("Перерасчет общей стоимости заказа");var e=this,o=l.totalSum();e.totalBlockSum=r.utils.numMethods.sumDecimal(e.fullPrice,e.deliveryPrice),o=r.utils.numMethods.sumDecimal(e.totalBlockSum,o),l.totalSum(o),console.log(l.totalSum())},o.prototype.addProductGroup=function(e){var o,t=this;for(console.info("добавляем товары в блок"),o=e.length-1;o>=0;o--)console.log(o+"ый пошел..."),console.log(e[o]),t._addProduct(e[o]);return t.products.length?(t.calculateDate(),t.updateTotalPrice(),t.hasPointDelivery&&(console.info("У товара есть точки доставки. Создаем список точек доставки"),t._makePointList()),void 0):(console.warn("в блоке "+t.token+" нет товаров"),void 0)},o.prototype._getNameDayOfWeek=function(e){var o=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"];return o[e]},o.prototype._getFullNameDayOfWeek=function(e){var o=["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"];return o[e]},o.prototype._hasDateInAllProducts=function(e){var o,t,r,n=this,l=null,i=null,a=!0;for(t=n.products.length-1;t>=0;t--){for(l=n.products[t].deliveries[n.state][n.choosenPoint().id].dates,r=0,o=l.length;o>r;r++){if(i=l[r].value,i===e){a=!0;break}a=!1}if(!a)break}return a},o.prototype.clickCalendarDay=function(o){var t=this;return o.avalible?(l.paypalECS()&&(console.info("PayPal ECS включен. Необходимо сохранить выбранную дату в cookie"),e.docCookies.setItem("chDate_paypalECS",JSON.stringify(o),600)),t.choosenNameOfWeek(t._getFullNameDayOfWeek(o.dayOfWeek)),t.choosenDate(o),void 0):!1},o.prototype.calculateDate=function(){console.info("Вычисление общей даты для продуктов в блоке");var t,r,n=this,i=l.orderDictionary.getToday(),a=null,d=null,s="",c=null,u=[],p=null;for(console.log("Сегодняшняя дата с сервера "+i),a=n.products[0].deliveries[n.state][n.choosenPoint().id].dates,r=0,t=a.length;t>r;r++)d=a[r].value,n._hasDateInAllProducts(d)&&d>=i&&(a[r].avalible=!0,a[r].humanDayOfWeek=n._getNameDayOfWeek(a[r].dayOfWeek),n.allDatesForBlock().push(a[r]));n.allDatesForBlock().length||(console.warn("нет общих дат для блока. Необходимо разделить продукты в блоке"),c=n.products.pop(),u.push(c),s=n.state+"_"+n.choosenPoint().id+"_"+n.addUniqueSuffix(),console.log("новый токен "+s),console.log(n),new o(u,n.state,n.choosenPoint().id),n.calculateDate()),l.paypalECS()&&e.docCookies.hasItem("chDate_paypalECS")?(console.info("PayPal ECS включен. Необходимо взять выбранную дату из cookie"),p=e.docCookies.getItem("chDate_paypalECS"),n.choosenDate(JSON.parse(p))):n.choosenDate(n.allDatesForBlock()[0]),n.choosenNameOfWeek(n._getFullNameDayOfWeek(n.choosenDate().dayOfWeek)),0!==n.choosenDate().intervals.length&&n.choosenInterval(n.choosenDate().intervals[0]),n.makeCalendar()},o.prototype.makeCalendar=function(){console.info("Создание календаря, округление до целых недель");var e,o,t,r=this,n=0,l={},i=null,a=null,d=864e5;for(t=0;r.allDatesForBlock().length-1>=t;t++){if(void 0===r.allDatesForBlock()[t+1]){console.info("Следущая дата последняя. заканчиваем цикл");break}l={},i=r.allDatesForBlock()[t].value+d,a=new Date(i),i!==r.allDatesForBlock()[t+1].value&&(l={value:i,avalible:!1,humanDayOfWeek:r._getNameDayOfWeek(a.getDay()),dayOfWeek:a.getDay(),day:a.getDate()},console.log("предыдущая дата была "+new Date(r.allDatesForBlock()[t].value).getDate()+" новая дата вклинилась "+a.getDate()+" следущая дата "+new Date(r.allDatesForBlock()[t+1].value).getDate()),r.allDatesForBlock.splice(t+1,0,l))}if(1!==r.allDatesForBlock()[0].dayOfWeek)for(n=0===r.allDatesForBlock()[0].dayOfWeek?6:r.allDatesForBlock()[0].dayOfWeek-1,i=r.allDatesForBlock()[0].value,e=n;e>0;e--)i-=d,a=new Date(i),l={avalible:!1,humanDayOfWeek:r._getNameDayOfWeek(a.getDay()),dayOfWeek:a.getDay(),day:a.getDate()},r.allDatesForBlock.unshift(l);if(0!==r.allDatesForBlock()[r.allDatesForBlock().length-1].dayOfWeek)for(n=7-r.allDatesForBlock()[r.allDatesForBlock().length-1].dayOfWeek,i=r.allDatesForBlock()[r.allDatesForBlock().length-1].value,o=n;o>0;o--)i+=d,a=new Date(i),l={avalible:!1,humanDayOfWeek:r._getNameDayOfWeek(a.getDay()),dayOfWeek:a.getDay(),day:a.getDate()},r.allDatesForBlock.push(l)},o.prototype.calendarLeftBtn=function(){var e=this,o=parseInt(e.calendarSliderLeft(),10);o+=380,e.calendarSliderLeft(o)},o.prototype.calendarRightBtn=function(){var e=this,o=parseInt(e.calendarSliderLeft(),10);o-=380,e.calendarSliderLeft(o)},o}()}(this,this.document,this.jQuery,this.ENTER,this.ko),function(e){console.info("orderCredit.js init...");var o=$(".bBankWrap"),t=function t(){var t=o.find(".bBankLink"),r=o.find(".bBankLink__eName"),n=o.find(".bSelect"),l=$("#selectedBank"),i=o.find(".bSelectWrap_eText"),a=function a(){var e=$("option:selected",n).attr("data-link"),o=$("option:selected",n).val(),a=$("option:selected",n).html();i.html(a),r.html(a),l.val(o),t.attr("href",e)};$("option",n).eq(0).attr("selected","selected"),n.change(a),a(),e.DirectCredit.init($("#jsCreditBank").data("value"),$("#creditPrice"))};o.length&&t()}(this),function(e,o,t,r){console.info("orderDictionary.js init...");var n=r.constructors;n.OrderDictionary=function(){"use strict";function o(e){return this instanceof o?(this.orderData=e,this.serverTime=this.orderData.time,this.deliveryTypes=this.orderData.deliveryTypes,this.deliveryStates=this.orderData.deliveryStates,this.pointsByDelivery=this.orderData.pointsByDelivery,this.products=this.orderData.products,void 0):new o(e)}return o.prototype.getNameOfState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].name:(console.warn("Не найден метод доставки "+e),!1)},o.prototype.getToday=function(){return this.serverTime},o.prototype.hasDeliveryState=function(e){return this.deliveryStates.hasOwnProperty(e)},o.prototype.isUniqueDeliveryState=function(e){var o;return this.hasDeliveryState(e)?(o=this.deliveryStates[e],o.unique):!1},o.prototype.hasPointDelivery=function(e){return this.hasDeliveryState(e)?this.pointsByDelivery.hasOwnProperty(e):!1},o.prototype.getPointByStateAndId=function(o,t){var r,n=this.getAllPointsByState(o);for(t+="",r=n.length-1;r>=0;r--)if(n[r].id===t)return e.ENTER.utils.cloneObject(n[r]);return!1},o.prototype.getFirstPointByState=function(e){var o=this.getAllPointsByState(e);return o[0]?r.utils.cloneObject(o[0]):!1},o.prototype.getAllPointsByState=function(e){if(!this.hasDeliveryState(e))return!1;var o=this.pointsByDelivery[e],t=o?o.token:!1,r=t?this.orderData[t]:!1;return r||!1},o.prototype.getChangeButtonText=function(e){var o=this.pointsByDelivery[e]?this.pointsByDelivery[e].changeName:"Сменить";return o},o.prototype.getProductFromState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].products:(console.warn("Не найден метод доставки "+e),!1)},o.prototype.getProductById=function(e){return this.products.hasOwnProperty(e)?this.products[e]:(console.warn("Такого продукта не найдено"),!1)},o}()}(this,this.document,this.jQuery,this.ENTER),function(){if(console.info("orderSertificate init..."),!$("#paymentMethod-10").length)return console.warn("нет метода оплаты сертификатом"),!1;var e=$("#paymentMethod-10").parent(),o=e.find(".mCardNumber"),t=e.find(".mCardPin"),r=e.find(".bPayMethodAction"),n=r.attr("data-url"),l=function(){var e=!1,l="processBlock",i=function i(){return o.val().replace(/[^0-9]/g,"")},a=function a(){return t.val().replace(/[^0-9]/g,"")},d=function d(){return{code:i(),pin:a()}},s=function s(){return e&&""!==i()&&14===i().length&&""!==a()&&4===a().length?!0:!1},c=function c(){return 4!==t.val().length?(console.warn("пин код мал"),!1):o.val().length?(u("mOrange","Проверка по номеру карты"),$.post(n,d(),function(e){if(!("success"in e))return!1;if(!e.success){var o=e.error!==void 0?e.error:"ERROR";return u("mRed",o),!1}u("mGreen",e.data)}),void 0):(console.warn("номер карты не введен"),!1)},u=function u(o,t){console.info("setProcessingStatus");var n=$(".process").first(),i={typeNum:o};switch(n.hasClass("picked")||n.remove(),o){case"mOrange":i.text=t,e=!1;break;case"mRed":i.text="Произошла ошибка: "+t,e=!1;break;case"mGreen":i.text="activated"in t?"Карта "+t.code+" на сумму "+t.sum+" активирована!":"Карта "+t.code+" имеет номинал "+t.sum,e=!0}r.after(tmpl(l,i)),t.activated!==void 0&&$(".process").first().addClass("picked")};return{checkCard:c,setProcessingStatus:u,isActive:s,getCode:i,getPIN:a}}();o.bind("change",function(){l.checkCard()}),t.bind("change",function(){l.checkCard()}),$.mask.definitions.n="[0-9]",t.mask("nnnn",{completed:l.checkCard,placeholder:"*"})}(this),function(e,o,t,r){console.info("orderValidation.js init");var n=r.utils,l={},i=t("#metrostations").data("name"),a=t("#order_recipient_first_name"),d=(t("#order_recipient_last_name"),t("#order_recipient_email")),s=t("#order_recipient_phonenumbers"),c=t("#order_address_metro"),u=t("#order_subway_id"),p=t("#order_address_street"),y=t("#order_address_building"),h=t("#sclub-number"),v=(t('.jsCustomRadio[name="order[payment_method_id]"]'),t("#qiwi-phone")),f=t("#order_agreed"),m=t("#completeOrder"),g=null,k=null,O=null,b={fields:[{fieldNode:a,require:!0,customErr:"Введите имя получателя",validateOnChange:!0},{fieldNode:d,validBy:"isEmail",customErr:"Некорректно введен e-mail",validateOnChange:!0},{fieldNode:s,require:!0,customErr:"Некорректно введен телефон",validateOnChange:!0},{fieldNode:f,require:!0,customErr:"Необходимо согласие"}]},D={source:i,appendTo:"#metrostations",minLength:2,select:function(e,o){u.val(o.item.val)}};console.log(r.OrderModel),console.log("orderValidation:: vars initd"),l=new FormValidator(b);var P=function P(e,o){var r='<div class="popupbox width290"><div class="font18 pb18"> '+e+"</div>"+"</div>"+'<p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>',n=t("<div>").addClass("popup").html(r);n.appendTo("body");var l=function(){return n.trigger("close"),n.remove(),void 0!==o&&o(),!1};n.lightbox_me({centered:!0,onClose:l}),n.find(".closePopup").bind("click",l)},S=function S(e){console.warn("Ошибка в поле");var o=t('[name="order['+e.field+']"]'),r=function r(){l._unmarkFieldError(t(this))};l._markFieldError(o,e.message),o.bind("focus",r)},M={"default":function(e){return console.log("Обработчик ошибки"),e.error&&e.error.message?(P(e.error.message,function(){o.location.href=e.redirect}),void 0):(o.location.href=e.redirect,void 0)},0:function(e){console.warn("Обработка ошибок формы");var r=null;if(e.redirect)return P(e.error.message,function(){o.location.href=e.redirect}),void 0;P(e.error.message);for(var n=e.form.error.length-1;n>=0;n--)r=e.form.error[n],console.warn(r),S(r);t.scrollTo(t(".mError").eq(0),500,{offset:-15})},743:function(e){P(e.error.message)}},_=function _(){if("undefined"!=typeof _gaq){for(var o=r.OrderModel.deliveryBoxes().length-1;o>=0;o--)_gaq.push(["_trackEvent","Order card","Completed","выбрана "+r.OrderModel.choosenDeliveryTypeId+" доставят "+r.OrderModel.deliveryBoxes()[o].state]);_gaq.push(["_trackEvent","Order complete",r.OrderModel.deliveryBoxes().length,r.OrderModel.orderDictionary.products.length]),_gaq.push(["_trackTiming","Order complete","DB response",O])}e.yaCounter10503055!==void 0&&e.yaCounter10503055.reachGoal("\\orders\\complete")},B=function B(t){return console.info("данные отправлены. получен ответ от сервера"),k=(new Date).getTime(),O=k-g,console.log(t),t.success?(_(),r.OrderModel.paypalECS()&&!m.hasClass("mConfirm")&&(console.info("PayPal ECS включен. Заказ оформлен. Необходимо удалить выбранные параметры из cookie"),e.docCookies.removeItem("chDate_paypalECS","/"),e.docCookies.removeItem("chTypeBtn_paypalECS","/"),e.docCookies.removeItem("chPoint_paypalECS","/"),e.docCookies.removeItem("chTypeId_paypalECS","/"),e.docCookies.removeItem("chStetesPriority_paypalECS","/")),o.location.href=t.redirect,void 0):(console.log("ошибка оформления заказа"),n.blockScreen.unblock(),M.hasOwnProperty(t.error.code)?(console.log("Есть обработчик"),M[t.error.code](t)):(console.log("Стандартный обработчик"),M["default"](t)),!1)},C=function C(){var o,l,i,a=null,d=[],s=[],c={},u=t("#order-form");for(n.blockScreen.block("Ваш заказ оформляется"),s=u.serializeArray(),console.info("Перебираем блоки доставки"),l=r.OrderModel.deliveryBoxes().length-1;l>=0;l--){for(c={},a=r.OrderModel.deliveryBoxes()[l],o=a.choosenPoint(),console.log("currentDeliveryBox:"),console.log(a),c={deliveryMethod_token:a.state,date:a.choosenDate().value,interval:[a.choosenInterval()?a.choosenInterval().start:"",a.choosenInterval()?a.choosenInterval().end:""],point_id:o.id,products:[]},console.log("choosePoint:"),console.log(o),"pickpoint"===a.state&&(console.log("Is PickPoint!"),c.point_id=o.number,c.point_address={street:o.street,house:o.house},c.point_name=o.point_name),i=a.products.length-1;i>=0;i--)c.products.push(a.products[i].id);console.log("tmpPart:"),console.log(c),d.push(c)}s.push({name:"order[delivery_type_id]",value:r.OrderModel.choosenDeliveryTypeId}),s.push({name:"order[part]",value:JSON.stringify(d)}),e.KM!==void 0&&s.push({name:"kiss_session",value:e.KM.i}),console.log("dataToSend:"),console.log(s),g=(new Date).getTime(),t.ajax({url:u.attr("action"),timeout:12e4,type:"POST",data:s,success:B,statusCode:{500:function(){P("Неудалось создать заказ. Попробуйте позднее.")},504:function(){P("Неудалось создать заказ. Попробуйте позднее.")}}})},T=function T(){return console.info("Завершить оформление заказа"),r.OrderModel.lifeGift()?(C(),!1):(l.validate({onInvalid:function(e){console.warn("invalid"),console.log(e),t.scrollTo(e[e.length-1].fieldNode,500,{offset:-15})},onValid:C}),!1)},I=function I(){for(var e=i.length-1;e>=0;e--)if(c.val()===i[e].label)return;c.val("")},E=function E(e,o){o?(l.setValidate(p,{require:!0,customErr:"Не введено название улицы",validateOnChange:!0}),l.setValidate(y,{require:!0,customErr:"Не введен номер дома",validateOnChange:!0}),void 0!==i&&l.setValidate(c,{fieldNode:c,customErr:"Не выбрана станция метро",require:!0,validateOnChange:!0})):(l.setValidate(p,{require:!1}),l.setValidate(y,{require:!1}),void 0!==i&&l.setValidate(c,{require:!1})),console.info("Изменен тип доставки"),console.log(l)};t.mask.definitions.n="[0-9]",h.mask("2 98nnnn nnnnnn",{placeholder:"*"}),v.mask("(nnn) nnn-nn-nn"),s.mask("(nnn) nnn-nn-nn"),e.docCookies.getItem("emails")&&(console.log("AB TEST: e-mail require"),l.setValidate(d,{require:!0}));var w=function w(e){var o,r=null;console.info("defaultValueToField");for(o in e)if(console.log("поле "+o),e[o]){if(console.log("для поля есть значение "+e[o]),r=t('input[name="'+o+'"]'),"radio"===r.attr("type")){r.filter('[value="'+e[o]+'"]').attr("checked","checked").trigger("change");continue}r.val(e[o])}};if(w(t("#jsOrderForm").data("value")),void 0!==i){c.autocomplete(D),c.bind("change",I);for(var x=i.length-1;x>=0;x--)if(parseInt(u.val(),10)===i[x].val){c.val(i[x].label);break}}t("body").bind("orderdeliverychange",E),m.bind("click",T),console.log("orderValidation.js inited")}(this,this.document,this.jQuery,this.ENTER),function(e,o,t,r,n){console.info("separate-order.js init");var l=t("#jsOrderDelivery").data("value"),i=r.utils,a=t("body"),d=function d(o){var n={},l=[],d=[],c=null,u=null,p=null,y=null,h=null,v=null,f=[],m=r.OrderModel.orderDictionary.orderData.discounts;r.OrderModel.paypalECS()&&(console.info("PayPal ECS включен. Необходимо сохранить выбранные параметры в cookie"),e.docCookies.setItem("chTypeBtn_paypalECS",r.OrderModel.deliveryTypesButton,600),e.docCookies.setItem("chPoint_paypalECS",r.OrderModel.choosenPoint(),600),e.docCookies.setItem("chTypeId_paypalECS",r.OrderModel.choosenDeliveryTypeId,600),e.docCookies.setItem("chStetesPriority_paypalECS",JSON.stringify(r.OrderModel.statesPriority),600)),r.OrderModel.deliveryBoxes.removeAll(),r.OrderModel.hasCoupons(!1),console.log("Маркируем выбранный способ доставки"),t("#"+r.OrderModel.deliveryTypesButton).attr("checked","checked").trigger("change"),r.OrderModel.totalSum(0),r.OrderModel.hasHomeDelivery(!1),a.trigger("orderdeliverychange",[!1]);for(var g=0,k=o.length;k>g;g++)if(p=o[g],v=r.OrderModel.orderDictionary.isUniqueDeliveryState(p),console.info("перебирем "+(v?"уникальный* ":"")+"метод "+p),d=[],r.OrderModel.orderDictionary.hasDeliveryState(p)){l=r.OrderModel.orderDictionary.getProductFromState(p);for(var O=l.length-1;O>=0;O--)y=l[O],n[y]?console.log("товар "+y+" уже определялся к блоку"):(console.log("добавляем товар "+y+" в блок для метода "+p),n[y]=!0,d.push(r.OrderModel.orderDictionary.getProductById(y)));if(d.length)if(c=r.OrderModel.orderDictionary.hasPointDelivery(p)?r.OrderModel.choosenPoint():0,u=p+"_"+c,r.OrderModel.hasDeliveryBox(u))h=r.OrderModel.getDeliveryBoxByToken(u),h.addProductGroup(d);else if(v)for(f=r.OrderModel.prepareProductsQuantityByUniq(d),O=f.length-1;O>=0;O--)y=[f[O]],r.constructors.DeliveryBox(y,p,c);else r.constructors.DeliveryBox(d,p,c)}else console.info("для метода "+p+" нет товаров");if(console.info("Созданные блоки:"),console.log(r.OrderModel.deliveryBoxes()),r.OrderModel.couponsBox(m),r.OrderModel.couponsBox(m),r.OrderModel.couponUrl(t(".bSaleList__eItem:visible .jsCustomRadio").eq(0).val()),t(".bSaleList__eItem:visible .jsCustomRadio").eq(0).trigger("change"),0===t(".bPayMethod:visible .jsCustomRadio:checked").length&&t(".bPayMethod:visible .jsCustomRadio").eq(0).attr("checked","checked").trigger("change"),r.OrderModel.hasCoupons()&&r.OrderModel.deliveryBoxes().length>1||r.OrderModel.appliedCoupon()&&r.OrderModel.appliedCoupon().sum&&parseFloat(r.OrderModel.totalSum())<=parseFloat(r.OrderModel.appliedCoupon().sum)){console.warn("Нужно удалить купон");var b="Купон не может быть применен при текущем разбиении заказа и будет удален",D=function(){console.log("удаление"),r.OrderModel.deleteItem(r.OrderModel.appliedCoupon())};return t.when(s(b)).then(D),!1}n.length!==r.OrderModel.orderDictionary.orderData.products.length&&console.warn("не все товары были обработаны"),console.warn("end"),t(".bCountSection").goodsCounter({onChange:function(e){console.info("counter change"),console.log(e);var o,n=t(this).data("seturl"),l=n.addParameterToUrl("quantity",e);console.log(n),console.log(l);var a=function a(e){return e.success?(r.OrderModel.couponNumber(""),void 0):(r.OrderModel.couponError(e.error.message),i.blockScreen.unblock(),void 0)};i.blockScreen.block("Обновляем"),o=[{type:"GET",url:l,callback:a},{type:"GET",url:r.OrderModel.updateUrl,callback:r.OrderModel.modelUpdate}],i.packageReq(o)}})};n.bindingHandlers.popupShower={update:function(e,o){var l=o(),i=n.utils.unwrapObservable(l),a=null;i?(a=new r.constructors.CreateMap("pointPopupMap",r.OrderModel.popupWithPoints().points,t("#mapInfoBlock")),t(e).lightbox_me({centered:!0,onClose:function(){console.info("закрываем"),l(!1)}})):(t("#pointPopupMap").empty(),t(e).trigger("close"))}},n.bindingHandlers.payBlockVisible={update:function(e){var o,n,l=t(e),i=l.data("vars"),a=i&&i.toHide?i.toHide:!1,d=r.OrderModel.choosenDeliveryTypeId,s=r.OrderModel.deliveryBoxes(),c=s.length,u=1;if(c){if(1===c?(u=0,console.log("Кол-во deliveryBoxes == 1: Показываем payBlock")):(u=1,console.log("Кол-во deliveryBoxes > 1: Скрываем payBlock")),a)for(o in a)if(a[o].length===void 0)t.inArray(d,a)>=0&&(u=1,console.log("toHide NoArr: Скрываем payBlock"));else if(d===o)for(n in a[o])n===i.typeId&&(u=1,console.log("toHide Arr: Скрываем payBlock"));u?l.hide():l.show()}}},n.bindingHandlers.paymentMethodVisible={update:function(e,o){var l=o(),i=n.utils.unwrapObservable(l),a=t(e),d=a.data("value"),s=parseInt(d["max-sum"],10),c=parseInt(d["min-sum"],10),u=d.method_id,p=d.isAvailableToPickpoint;return 6===r.OrderModel.choosenDeliveryTypeId&&!1===p||4===r.OrderModel.choosenDeliveryTypeId&&13===u&&r.OrderModel.lifeGift()===!1||!isNaN(s)&&i>s||!isNaN(c)&&c>i?(a.hide(),void 0):(a.show(),void 0)}},n.bindingHandlers.calendarSlider={update:function(e,o,r,n,l){var i=t(e),a=o(),d=i.find(".bBuyingDatesItem"),s=d.width()+parseInt(d.css("marginRight"),10)+parseInt(d.css("marginLeft"),10);return i.width(d.length*s),a>0?(a-=380,l.box.calendarSliderLeft(a),void 0):-i.width()>a?(a+=380,l.box.calendarSliderLeft(a),void 0):(i.animate({left:a}),void 0)}},n.bindingHandlers.couponsVisible={update:function(e,o){var l,i=o(),a=n.utils.unwrapObservable(i),d=t(e),s=d.find(".mSaleInput"),c=d.find(".mSaleBtn"),u=d.find(".bSaleData__eEmptyBlock");for(t(".bSaleList__eItem").removeClass("hidden"),l=a.length-1;l>=0;l--)d.find('.bSaleList__eItem[data-type="'+a[l].type+'"]').addClass("hidden"),"coupon"===a[l].type&&(console.log("Есть примененный купон"),r.OrderModel.hasCoupons(!0),r.OrderModel.appliedCoupon(a[l]));t(".bSaleList__eItem.hidden").length===t(".bSaleList__eItem").length||t(".bSaleList__eItem:hidden").length===t(".bSaleList__eItem").length?(s.attr("disabled","disabled"),c.attr("disabled","disabled").addClass("mDisabled"),u.show()):(s.removeAttr("disabled"),c.removeAttr("disabled").removeClass("mDisabled"),u.hide())}},r.OrderModel={updateUrl:t("#jsOrderDelivery").data("url"),prepareData:n.observable(!1),showPopupWithPoints:n.observable(!1),deliveryTypesButton:null,tmpStatesPriority:null,statesPriority:null,lifeGift:n.observable(!1),oneClick:n.observable(!1),paypalECS:n.observable(!1),cartSum:null,orderDictionary:null,choosenPoint:n.observable(),hasHomeDelivery:n.observable(!1),deliveryTypes:n.observableArray([]),deliveryBoxes:n.observableArray([]),popupWithPoints:n.observable({}),totalSum:n.observable(0),hasCoupons:n.observable(!1),appliedCoupon:n.observable(),couponNumber:n.observable(),couponUrl:n.observable(),couponError:n.observable(),couponsBox:n.observableArray([]),hasDeliveryBox:function(e){console.info("Существует ли блок доставки "+e);var o=null;for(o=r.OrderModel.deliveryBoxes().length-1;o>=0;o--)if(r.OrderModel.deliveryBoxes()[o].token===e)return!0;return!1},getDeliveryBoxByToken:function(e){console.info("Получить ссылку на блок по токену "+e);var o=null;for(o=r.OrderModel.deliveryBoxes().length-1;o>=0;o--)if(r.OrderModel.deliveryBoxes()[o].token===e)return r.OrderModel.deliveryBoxes()[o]},removeDeliveryBox:function(e){console.info("Удаление блока по токену "+e);var o=null;for(o=r.OrderModel.deliveryBoxes().length-1;o>=0;o--)if(r.OrderModel.deliveryBoxes()[o].token===e)return r.OrderModel.deliveryBoxes().splice(o,1),void 0},checkCoupon:function(){console.info("проверяем купон");var e,o={number:r.OrderModel.couponNumber()},t=r.OrderModel.couponUrl(),n=function n(e){return e.success?(r.OrderModel.couponNumber(""),void 0):(r.OrderModel.couponError(e.error.message),i.blockScreen.unblock(),void 0)};return r.OrderModel.couponError(""),void 0===t?(console.warn("Не выбран тип сертификата"),r.OrderModel.couponError("Не выбран тип сертификата"),void 0):void 0!==o.number&&o.number.length?(i.blockScreen.block("Применяем купон"),e=[{type:"POST",url:t,data:o,callback:n},{type:"GET",url:r.OrderModel.updateUrl,callback:r.OrderModel.modelUpdate}],i.packageReq(e),!1):(console.warn("Не введен номер сертификата"),r.OrderModel.couponError("Не введен номер сертификата"),void 0)},selectPoint:function(e){console.info("point selected..."),console.log(e.parentBoxToken);var o=null;return e.parentBoxToken?(o=r.OrderModel.getDeliveryBoxByToken(e.parentBoxToken),console.log(o),o.selectPoint.apply(o,[e]),!1):(r.OrderModel.statesPriority=r.OrderModel.tmpStatesPriority,r.OrderModel.choosenPoint(e.id),r.OrderModel.showPopupWithPoints(!1),d(r.OrderModel.statesPriority),!1)
},chooseDeliveryTypes:function(e,o){console.info("chooseDeliveryTypes");var n=e.states[0],l=o.target.htmlFor;return console.log(n),console.log(l),t("#"+l).attr("checked")?(console.warn("Этот пункт "+l+" уже был выбран"),!1):(r.OrderModel.deliveryTypesButton=l,console.log(r.OrderModel.deliveryTypesButton),r.OrderModel.tmpStatesPriority=e.states,console.log(r.OrderModel.tmpStatesPriority),r.OrderModel.choosenDeliveryTypeId=e.id,console.log(r.OrderModel.choosenDeliveryTypeId),r.OrderModel.orderDictionary.hasPointDelivery(n)?(console.log("Необходимо показать окно с выбором точки доставки"),r.OrderModel.popupWithPoints({header:e.name,points:r.OrderModel.orderDictionary.getAllPointsByState(n)}),r.OrderModel.showPopupWithPoints(!0),!1):(console.log("Выбор точки доставки не требуется"),r.OrderModel.statesPriority=r.OrderModel.tmpStatesPriority,r.OrderModel.choosenPoint(0),console.info("Отправляем данные на разбивку"),d(r.OrderModel.statesPriority),!1))},modelUpdate:function(e){console.info("обновление данных с сервера"),p(e),d(r.OrderModel.statesPriority)},deleteItem:function(e){console.info("удаление товара");var t=null;i.blockScreen.block("Удаляем");var n=function n(){var o=r.OrderModel.orderDictionary.products,t=0,n=0,l={};if(!e.product)return!1;for(var i in o)t+=i[i].price,n+=i[i].quantity;l={"Checkout Step 1 SKU Quantity":n,"Checkout Step 1 SKU Total":t},"undefined"!=typeof _kmq&&_kmq.push(["set",l]),"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Order card","Item deleted"])},l=function l(e){if(console.info("deleteItemResponceHandler"),console.log(e),!e.success)return console.warn("не удалось удалить товар"),i.blockScreen.unblock(),!1;if(("undefined"!=typeof _gaq||"undefined"!=typeof _kmq)&&n(),e.product){var t=e.product.id,r=e.category_id;(function(e){var t=o,r=t.createElement("IMG"),n=t.body;e=e.replace(/!\[rnd\]/,Math.round(9999999*Math.random()))+"&tail256="+escape(t.referrer||"unknown"),r.style.position="absolute",r.style.width=r.style.height="0px",r.onload=r.onerror=function(){n.removeChild(r),r=n=null},r.src=e,n.insertBefore(r,n.firstChild)})("http://ad.adriver.ru/cgi-bin/rle.cgi?sid=182615&sz=del_basket&bt=55&pz=0&custom=10="+t+";11="+r+"&![rnd]")}};return console.log(e.deleteUrl),t=[{type:"GET",url:e.deleteUrl,callback:l},{type:"GET",url:r.OrderModel.updateUrl,callback:r.OrderModel.modelUpdate}],i.packageReq(t),!1},prepareProductsQuantityByUniq:function(e){var o,t,n,l=[];for(t=e.length-1;t>=0;t--)for(o=r.utils.cloneObject(e[t]),o.sum=o.price,o.quantity=1,o.oldQuantity=e[t].quantity,n=e[t].quantity-1;n>=0;n--)l.push(o);return l}},n.applyBindings(r.OrderModel);var s=function s(e){var o='<div class="popupbox width290"><div class="font18 pb18"> '+e+"</div>"+"</div>"+'<p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>',r=t("<div>").addClass("popup").html(o),n=t.Deferred();r.appendTo("body");var l=function(){r.trigger("close"),r.remove(),n.resolve()};return r.lightbox_me({centered:!0,closeClick:!1,closeEsc:!1}),r.find(".closePopup").bind("click",l),n.promise()},c={"default":function(e){var o="Товар "+e.name+" недоступен для продажи.",r=t.Deferred();return t.when(s(o)).then(function(){t.ajax({type:"GET",url:e.deleteUrl}).then(r.resolve)}),r.promise()},708:function(e){var o="",r=t.Deferred();return o=e.name&&e.error.message&&e.quantity?"Вы заказали товар "+e.name+" в количестве "+e.quantity+" шт. <br/ >"+e.error.message:"Товар недоступен для продажи",t.when(s(o)).then(function(){t.ajax({type:"GET",url:e.setUrl}).then(r.resolve)}),r.promise()}},u=function u(e){var r=null,n=[];for(r in e.products)e.products[r].error&&e.products[r].error.code&&n.push(e.products[r]);var l=function l(e,o){var r=null;return 0>e?(console.warn("return"),o(),void 0):(r=n[e].error.code,r=c.hasOwnProperty(r)?r:"default",t.when(c[r](n[e])).then(function(){var t=e-1;l(t,o)}),void 0)};0===n.length&&e.error.message?t.when(s(e.error.message)).then(function(){e.redirect&&(o.location.href=e.redirect)}):l(n.length-1,function(){console.warn("1 этап закончен"),e.redirect&&(o.location.href=e.redirect)})},p=function p(o){var t,n;return i.blockScreen.unblock(),o.success?(console.info("Данные с сервера получены"),r.OrderModel.orderDictionary=new r.constructors.OrderDictionary(o),o.paypalECS&&(console.info("paypal true"),r.OrderModel.paypalECS(!0)),o.cart&&o.cart.sum&&(console.info("Есть первоначальная сумма корзины : "+o.cart.sum),r.OrderModel.cartSum=o.cart.sum),r.OrderModel.deliveryTypes(o.deliveryTypes),r.OrderModel.lifeGift(o.lifeGift||!1),r.OrderModel.oneClick(o.oneClick||!1),r.OrderModel.prepareData(!0),r.OrderModel.paypalECS()&&e.docCookies.hasItem("chTypeBtn_paypalECS")&&e.docCookies.hasItem("chPoint_paypalECS")&&e.docCookies.hasItem("chTypeId_paypalECS")&&e.docCookies.hasItem("chStetesPriority_paypalECS")&&(console.info("PayPal ECS включен. Необходимо применить параметры из cookie"),r.OrderModel.deliveryTypesButton=e.docCookies.getItem("chTypeBtn_paypalECS"),r.OrderModel.choosenPoint(e.docCookies.getItem("chPoint_paypalECS")),r.OrderModel.choosenDeliveryTypeId=e.docCookies.getItem("chTypeId_paypalECS"),r.OrderModel.statesPriority=JSON.parse(e.docCookies.getItem("chStetesPriority_paypalECS")),d(r.OrderModel.statesPriority)),1===o.deliveryTypes.length&&(t=o.deliveryTypes[0],n=r.OrderModel.orderDictionary.getFirstPointByState(t.states[0])||t.id,console.log("Обнаружен только 1 способ доставки: "+t.name+" — выбираем его."),console.log("Выбран первый пункт* доставки:"),console.log(n),r.OrderModel.statesPriority=t.states,r.OrderModel.deliveryTypesButton="method_"+t.id,r.OrderModel.choosenDeliveryTypeId=t.id,r.OrderModel.choosenPoint(n),d(r.OrderModel.statesPriority)),void 0):(console.warn("Данные содержат ошибки"),console.log(o.error),u(o),!1)},y=function y(e){return console.log("selectPointOnBaloon"),console.log(e),console.log(t(this).data("pointid")),console.log(t(this).data("parentbox")),r.OrderModel.selectPoint({id:t(this).data("pointid"),parentBoxToken:t(this).data("parentbox")}),!1},h=function(o){console.info("analyticsStep_1");var t,r=0,n=0,l=[],i={};for(t in o.products)r+=o.products[t].price,n+=o.products[t].quantity,l.push({id:o.products[t].id,name:o.products[t].name,price:o.products[t].price,quantity:o.products[t].quantity});i={"Checkout Step 1 SKU Quantity":n,"Checkout Step 1 SKU Total":r,"Checkout Step 1 Order Type":"cart order"},"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","New order","Items",n]),"undefined"!=typeof _kmq&&_kmq.push(["record","Checkout Step 1",i]),e.APRT_DATA=e.APRT_DATA||{},e.APRT_DATA.pageType=5,e.APRT_DATA.orderInfo=e.APRT_DATA.orderInfo||{},e.APRT_DATA.orderInfo.totalPrice=r,e.APRT_DATA.basketProducts=l};console.log(r.OrderModel),p(l),h(l),a.on("click",".shopchoose",y)}(this,this.document,this.jQuery,this.ENTER,this.ko);