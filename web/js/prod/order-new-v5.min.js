function OrderDictionary(e){this.orderData=e}function DeliveryBox(e,r,o,t,i){console.info("Cоздание блока доставки "+r+" для "+o);var n=this;n.OrderModel=i,n.createdBox=t,n.deliveryPoint=o,n.products=[],n.fullPrice=0,n.state=r,n.deliveryName=n.OrderModel.orderDictionary.getNameOfState(r),n.deliveryPrice=Number.POSITIVE_INFINITY,n.showMessage=null,n.choosenDate=null,n.addProductGroup(e),n.OrderModel.deliveryBoxes.push(n)}OrderDictionary.prototype.getNameOfState=function(e){return this.hasDeliveryState(e)?this.orderData.deliveryStates[e].name:(console.warn("Не найден метод доставки "+e),!1)},OrderDictionary.prototype.hasDeliveryState=function(e){return this.orderData.deliveryStates.hasOwnProperty(e)},OrderDictionary.prototype.hasPointDelivery=function(e){return this.orderData.pointsByDelivery[e]},OrderDictionary.prototype.getProductFromState=function(e){return this.hasDeliveryState(e)?this.orderData.deliveryStates[e].products:(console.warn("Не найден метод доставки "+e),!1)},OrderDictionary.prototype.getProductById=function(e){return this.orderData.products.hasOwnProperty(e)?this.orderData.products[e]:(console.warn("Такого продукта не найдено"),!1)},DeliveryBox.prototype._getFirstPropertyName=function(e){for(var r in e)return r},DeliveryBox.prototype.addProduct=function(e){var r=this,o=null,t=null,i=null,n=[];return e.deliveries[r.state].hasOwnProperty(r.deliveryPoint)?(o=parseInt(e.deliveries[r.state][r.deliveryPoint].price,10),r.deliveryPrice=r.deliveryPrice>o?o:r.deliveryPrice,r.fullPrice+=e.sum,r.products.push({name:e.name,price:e.sum,quantity:e.quantity,deleteUrl:e.deleteUrl,productUrl:e.url,productImg:e.image}),void 0):(console.warn("Для товара "+e.id+" нет пункта доставки "+r.deliveryPoint+". Необходимо создать новый блок"),i=r._getFirstPropertyName(e.deliveries[r.state]),t=r.state+"_"+i,void 0!==r.createdBox[t]?r.createdBox[t].addProduct(e):(n.push(e),r.createdBox[t]=new DeliveryBox(n,r.state,i,r.createdBox,r.OrderModel)),void 0)},DeliveryBox.prototype.addProductGroup=function(e){for(var r=e.length-1;r>=0;r--)this.addProduct(e[r])},function(){console.info("Логика разбиения заказа для оформления заказа v.5");var e="/ajax/order-delivery",r=null,o=null,t={},i=function i(e){for(var r={},i=[],l=[],a=null,d=null,s=null,c=null,y=0,u=e.length;u>y;y++)if(s=e[y],console.info("перебирем метод "+s),l=[],n.orderDictionary.hasDeliveryState(s)){i=n.orderDictionary.getProductFromState(s);for(var v=i.length-1;v>=0;v--)c=i[v],r[c]?console.log("товар "+c+" уже определялся к блоку"):(console.log("добавляем товар "+c+" в блок для метода "+s),r[c]=!0,l.push(n.orderDictionary.getProductById(c)));l.length&&(a=n.orderDictionary.hasPointDelivery(s)?o:0,d=s+"_"+a,void 0!==t[d]?t[d].addProductGroup(l):t[d]=new DeliveryBox(l,s,a,t,n))}else console.info("для метода "+s+" нет товаров");console.info("Созданные блоки:"),console.log(t),r.length!==n.orderDictionary.orderData.products.length&&console.warn("не все товары были обработаны")},n={prepareData:ko.observable(!1),orderDictionary:null,deliveryTypes:ko.observableArray([]),deliveryBoxes:ko.observableArray([]),chooseDeliveryTypes:function(e){var l=e.states,a=l[0];t={},n.deliveryBoxes.removeAll(),r=e.token,n.orderDictionary.hasPointDelivery(a)?(console.log("есть точки доставки из которых нужно выбрать"),o=13):(console.log("для выбранного метода доставки нет точек доставки"),o=0),console.log("выбранный метод доставки "+r),console.log("выбранное место доставки "+o),i(l)}};ko.applyBindings(n);var l=function l(e){return e.success?(console.log("Данные с сервера получены"),n.orderDictionary=new OrderDictionary(e),n.deliveryTypes(e.deliveryTypes),n.prepareData(!0),void 0):(console.warn("произошла ошибка при получении данных с сервера"),console.log(e.error),!1)};$.ajax({type:"GET",url:e,success:l})}();