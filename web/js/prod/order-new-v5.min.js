function DeliveryBox(e,t,r,i,n){console.info("Cоздание блока доставки "+t+" для "+r);var a=this;a.OrderModel=n,a.createdBox=i,a.token=t+"_"+r,a.products=[],a.fullPrice=0,a.state=t,a.deliveryName=a.OrderModel.orderDictionary.getNameOfState(t),a.deliveryPrice=Number.POSITIVE_INFINITY,a.choosenDate=ko.observable(),a.choosenPoint=ko.observable({id:r}),a.choosenInterval=ko.observable(),a.showPopupWithPoints=ko.observable(!1),a.hasPointDelivery=a.OrderModel.orderDictionary.hasPointDelivery(t),a.allDatesForBlock=ko.observableArray([]),a.pointList=ko.observableArray([]),a.hasPointDelivery?a.choosenPoint(a.OrderModel.orderDictionary.getPointByStateAndId(a.state,r)):(a.OrderModel.hasHomeDelivery(!0),$("body").trigger("orderdeliverychange",[!0])),a.calendarSliderLeft=ko.observable(0),a.addProductGroup(e),a.OrderModel.deliveryBoxes.push(a)}function OrderDictionary(e){this.orderData=e,this.serverTime=this.orderData.time,this.deliveryTypes=this.orderData.deliveryTypes,this.deliveryStates=this.orderData.deliveryStates,this.pointsByDelivery=this.orderData.pointsByDelivery,this.products=this.orderData.products}DeliveryBox.prototype._makePointList=function(){var e=this,t=!0;for(var r in e.products[0].deliveries){for(var i=e.products.length-1;i>=0&&(t=e.products[i].deliveries.hasOwnProperty(r),t);i--);t&&e.pointList.push(e.OrderModel.orderDictionary.getPointByStateAndId(e.state,r))}},DeliveryBox.prototype.selectPoint=function(e){var t=this,r=t.state+"_"+e.id;return void 0!==t.createdBox[r]?(t.createdBox[r].addProductGroup(t.products),delete t.createdBox[t.token]):(t.createdBox[r]=t.createdBox[t.token],delete t.createdBox[t.token],t.token=r,t.choosenPoint(e)),t.showPopupWithPoints(!1),!1},DeliveryBox.prototype.changePoint=function(){var e=this;return e.showPopupWithPoints(!0),!1},DeliveryBox.prototype._getFirstPropertyName=function(e){for(var t in e)return t},DeliveryBox.prototype._addProduct=function(e){var t=this,r=null,i=null,n=null,a=[];return e.deliveries[t.state].hasOwnProperty(t.choosenPoint().id)?(r=parseInt(e.deliveries[t.state][t.choosenPoint().id].price,10),t.deliveryPrice=t.deliveryPrice>r?r:t.deliveryPrice,t.fullPrice+=e.sum,t.products.push({id:e.id,name:e.name,price:e.sum,quantity:e.quantity,deleteUrl:e.deleteUrl,productUrl:e.url,productImg:e.image,deliveries:e.deliveries[t.state]}),void 0):(console.warn("Для товара "+e.id+" нет пункта доставки "+t.choosenPoint().id+" Необходимо создать новый блок"),n=t._getFirstPropertyName(e.deliveries[t.state]),i=t.state+"_"+n,a.push(e),void 0!==t.createdBox[i]?t.createdBox[i].addProductGroup(e):t.createdBox[i]=new DeliveryBox(a,t.state,n,t.createdBox,t.OrderModel),void 0)},DeliveryBox.prototype.updateTotalPrice=function(){var e=this,t=e.OrderModel.totalSum();t+=e.fullPrice+e.deliveryPrice,e.OrderModel.totalSum(t)},DeliveryBox.prototype.addProductGroup=function(e){for(var t=this,r=e.length-1;r>=0;r--)t._addProduct(e[r]);t.calculateDate(),t.updateTotalPrice(),t.hasPointDelivery&&t._makePointList()},DeliveryBox.prototype._getNameDayOfWeek=function(e){var t=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"];return t[e]},DeliveryBox.prototype._hasDateInAllProducts=function(e){for(var t=this,r=null,i=null,n=!0,a=t.products.length-1;a>=0;a--){r=t.products[a].deliveries[t.choosenPoint().id].dates;for(var o=0,s=r.length;s>o;o++){if(i=r[o].value,i===e){n=!0;break}n=!1}if(!n)break}return n},DeliveryBox.prototype.clickCalendarDay=function(e){var t=this;return e.avalible?(t.choosenDate(e),void 0):!1},DeliveryBox.prototype.calculateDate=function(){console.info("Вычисление общей даты для продуктов в блоке");var e=this,t=e.OrderModel.orderDictionary.getToday(),r=null,i=null;if(console.log("Сегодняшняя дата с сервера "+t),!e.products.length)return console.warn("в блоке нет товаров"),void 0;r=e.products[0].deliveries[e.choosenPoint().id].dates;for(var n=0,a=r.length;a>n;n++)i=r[n].value,e._hasDateInAllProducts(i)&&i>=t&&(r[n].avalible=!0,r[n].humanDayOfWeek=e._getNameDayOfWeek(r[n].dayOfWeek),e.allDatesForBlock.push(r[n]));e.choosenDate(e.allDatesForBlock()[0]),e.choosenInterval(e.choosenDate().intervals[0]),e.makeCalendar()},DeliveryBox.prototype.makeCalendar=function(){var e=this,t=0,r=null,i={},n=null,a=864e5;if(1!==e.allDatesForBlock()[0].dayOfWeek){t=0===e.allDatesForBlock()[0].dayOfWeek?6:e.allDatesForBlock()[0].dayOfWeek-1,n=e.allDatesForBlock()[0].value;for(var o=t;o>0;o--)r=e.allDatesForBlock()[0].dayOfWeek-1,n-=a,i={avalible:!1,humanDayOfWeek:e._getNameDayOfWeek(r),dayOfWeek:r,day:new Date(n).getDate()},e.allDatesForBlock.unshift(i)}if(0!==e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek){t=7-e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek,n=e.allDatesForBlock()[e.allDatesForBlock().length-1].value;for(var s=t;s>0;s--)r=7===e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek+1?0:e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek+1,n+=a,i={avalible:!1,humanDayOfWeek:e._getNameDayOfWeek(r),dayOfWeek:r,day:new Date(n).getDate()},e.allDatesForBlock.push(i)}},DeliveryBox.prototype.calendarLeftBtn=function(){var e=this,t=parseInt(e.calendarSliderLeft(),10);t+=365,e.calendarSliderLeft(t)},DeliveryBox.prototype.calendarRightBtn=function(){var e=this,t=parseInt(e.calendarSliderLeft(),10);t-=365,e.calendarSliderLeft(t)},ko.bindingHandlers.calendarSlider={update:function(e,t,r,i,n){var a=$(e),o=t(),s=a.find(".bBuyingDatesItem"),l=s.width()+parseInt(s.css("marginRight"),10)+parseInt(s.css("marginLeft"),10);return a.width(s.length*l),o>0?(o-=365,n.box.calendarSliderLeft(o),void 0):-a.width()>o?(o+=365,n.box.calendarSliderLeft(o),void 0):(a.animate({left:o}),void 0)}},function(){var e=$(".bBankWrap"),t=function t(){var t=e.find(".bBankLink"),r=e.find(".bBankLink__eName"),i=e.find(".bSelect"),n=$("#selectedBank"),a=e.find(".bSelectWrap_eText"),o=function o(){var e=$("option:selected",i).attr("data-link"),o=$("option:selected",i).val(),s=$("option:selected",i).html();a.html(s),r.html(s),n.val(o),t.attr("href",e)};$("option",i).eq(0).attr("selected","selected"),i.change(o),o(),DirectCredit.init($("#jsCreditBank").data("value"),$("#creditPrice"))};e.length&&t()}(this),OrderDictionary.prototype.getNameOfState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].name:(console.warn("Не найден метод доставки "+e),!1)},OrderDictionary.prototype.getToday=function(){return this.serverTime},OrderDictionary.prototype.hasDeliveryState=function(e){return this.deliveryStates.hasOwnProperty(e)},OrderDictionary.prototype.hasPointDelivery=function(e){return this.pointsByDelivery.hasOwnProperty(e)},OrderDictionary.prototype.getPointByStateAndId=function(e,t){var r=this.getAllPointsByState(e);t+="";for(var i=r.length-1;i>=0;i--)if(r[i].id===t)return r[i]},OrderDictionary.prototype.getAllPointsByState=function(e){var t=this.pointsByDelivery[e];return this.orderData[t]},OrderDictionary.prototype.getProductFromState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].products:(console.warn("Не найден метод доставки "+e),!1)},OrderDictionary.prototype.getProductById=function(e){return this.products.hasOwnProperty(e)?this.products[e]:(console.warn("Такого продукта не найдено"),!1)},function(e){var t={},r=$("#metrostations").data("name"),i=$("#order_recipient_first_name"),n=$("#order_recipient_last_name"),a=$("#order_recipient_email"),o=$("#order_recipient_phonenumbers"),s=$("#order_address_metro"),l=$("#order_subway_id"),c=$("#order_address_street"),u=$("#order_address_building"),h=$('.jsCustomRadio[name="order[payment_method_id]"]'),d=$("#order_agreed"),f=$("#completeOrder"),p={fields:[{fieldNode:i,require:!0,customErr:"Введите имя получателя",validateOnChange:!0},{fieldNode:n,require:!0,customErr:"Введите фамилию получателя",validateOnChange:!0},{fieldNode:a,validBy:"isEmail",customErr:"Некорректно введен e-mail",validateOnChange:!0},{fieldNode:o,require:!0,customErr:"Некорректно введен телефон",validateOnChange:!0},{fieldNode:d,require:!0,customErr:"Необходимо согласие"},{fieldNode:h,require:!0,customErr:"Необходимо выбрать метод оплаты"}]},m={source:r,appendTo:"#metrostations",minLength:2,select:function(e,t){l.val(t.item.val)}};t=new FormValidator(p);var v={noti:null,block:function(e){console.warn("block screen"),this.noti&&this.unblock(),this.noti=$("<div>").addClass("noti").html('<div><img src="/images/ajaxnoti.gif" /></br></br> '+e+"</div>"),this.noti.appendTo("body"),this.noti.lightbox_me({centered:!0,closeClick:!1,closeEsc:!1})},unblock:function(){console.warn("unblock screen"),this.noti.trigger("close"),this.noti.remove()}},g=function g(e){console.info("данные отправлены. получен ответ от сервера"),console.log(e),v.unblock()},_=function _(){var t=null,r=[],i=[],n={},a=$("#order-form");v.block("Ваш заказ оформляется"),console.info("Перебираем блоки доставки");for(var o=e.OrderModel.deliveryBoxes().length-1;o>=0;o--){n={},t=e.OrderModel.deliveryBoxes()[o],console.log(t),n={deliveryMethod_token:t.state,date:t.choosenDate().value,interval:[t.choosenInterval().start,t.choosenInterval().end],point_id:t.choosenPoint().id,products:[]};for(var s=t.products.length-1;s>=0;s--)n.products.push(t.products[s].id);r.push(n)}i=a.serializeArray(),i.push({name:"order[delivery_type_id]",value:e.OrderModel.choosenDeliveryTypeId}),i.push({name:"order[part]",value:JSON.stringify(r)}),console.log(i),$.ajax({url:a.attr("action"),timeout:12e4,type:"POST",data:i,success:g})},E=function E(){return console.info("завершить оформление заказа"),t.validate({onInvalid:function(e){console.warn("invalid"),console.log(e),$.scrollTo(e[e.length-1].fieldNode,500,{offset:-15})},onValid:_}),!1},y=function y(){for(var e=r.length-1;e>=0;e--)if(s.val()===r[e].label)return;s.val("")},b=function b(e,i){i?(t.setValidate(c,{require:!0,customErr:"Не введено название улицы",validateOnChange:!0}),t.setValidate(u,{require:!0,customErr:"Не введен номер дома",validateOnChange:!0}),void 0!==r&&t.setValidate(s,{fieldNode:s,customErr:"Не выбрана станция метро",require:!0})):(t.setValidate(c,{require:!1}),t.setValidate(u,{require:!1}),void 0!==r&&t.setValidate(s,{require:!1})),console.info("Изменен тип доставки"),console.log(t)};o.mask("(999) 999-99-99"),e.docCookies.getItem("emails")&&(console.log("AB TEST: e-mail require"),t.setValidate(a,{require:!0})),void 0!==r&&(s.autocomplete(m),s.bind("change",y));var T=function T(e){var t=null;console.info("defaultValueToField");for(var r in e)console.log("поле "+r),e[r]&&(console.log("для поля есть значение "+e[r]),t=$('input[name="'+r+'"]'),"text"===t.attr("type")&&t.val(e[r]),"radio"===t.attr("type")&&t.filter('[value="'+e[r]+'"]').attr("checked","checked"))};T($("#jsOrderForm").data("value")),$("body").bind("orderdeliverychange",b),f.bind("click",E)}(this),function(e){console.info("Логика разбиения заказа для оформления заказа v.5");var t={},r=function r(r){var i={},n=[],a=[],o=null,s=null,l=null,c=null,u=e.OrderModel.orderDictionary.orderData.discounts;t={},e.OrderModel.deliveryBoxes.removeAll(),e.OrderModel.deliveryTypesButton.attr("checked","checked"),e.OrderModel.totalSum(0),e.OrderModel.hasHomeDelivery(!1),$("body").trigger("orderdeliverychange",[!1]),e.OrderModel.couponsBox(u);for(var h=0,d=r.length;d>h;h++)if(l=r[h],console.info("перебирем метод "+l),a=[],e.OrderModel.orderDictionary.hasDeliveryState(l)){n=e.OrderModel.orderDictionary.getProductFromState(l);for(var f=n.length-1;f>=0;f--)c=n[f],i[c]?console.log("товар "+c+" уже определялся к блоку"):(console.log("добавляем товар "+c+" в блок для метода "+l),i[c]=!0,a.push(e.OrderModel.orderDictionary.getProductById(c)));a.length&&(o=e.OrderModel.orderDictionary.hasPointDelivery(l)?e.OrderModel.choosenPoint():0,s=l+"_"+o,void 0!==t[s]?t[s].addProductGroup(a):t[s]=new DeliveryBox(a,l,o,t,e.OrderModel))}else console.info("для метода "+l+" нет товаров");console.info("Созданные блоки:"),console.log(t),i.length!==e.OrderModel.orderDictionary.orderData.products.length&&console.warn("не все товары были обработаны")};ko.bindingHandlers.popupShower={update:function(e,t){var r=t(),i=ko.utils.unwrapObservable(r);i?$(e).lightbox_me({centered:!0,onClose:function(){console.info("закрываем"),r(!1)}}):$(e).trigger("close")}},ko.bindingHandlers.paymentMethodVisible={update:function(e,t){var r=t(),i=ko.utils.unwrapObservable(r),n=parseInt($(e).data("value")["max-sum"],10);isNaN(n)||(i>n?$(e).hide():$(e).show())}},e.OrderModel={prepareData:ko.observable(!1),showPopupWithPoints:ko.observable(!1),deliveryTypesButton:null,tmpStatesPriority:null,statesPriority:null,orderDictionary:null,choosenPoint:ko.observable(),hasHomeDelivery:ko.observable(!1),deliveryTypes:ko.observableArray([]),deliveryBoxes:ko.observableArray([]),popupWithPoints:ko.observable({}),totalSum:ko.observable(0),couponNumber:ko.observable(),couponUrl:ko.observable(),couponError:ko.observable(),couponsBox:ko.observableArray([]),checkCoupon:function(){var t={number:e.OrderModel.couponNumber()},r=e.OrderModel.couponUrl(),i=function i(t){return t.success?void 0:(e.OrderModel.couponError(t.error.message),void 0)};return e.OrderModel.couponError(""),void 0===r?(e.OrderModel.couponError("Не выбран тип сертификата"),void 0):($.ajax({type:"POST",url:r,data:t,success:i}),void 0)},selectPoint:function(t){return console.info("point selected..."),e.OrderModel.statesPriority=e.OrderModel.tmpStatesPriority,e.OrderModel.choosenPoint(t.id),e.OrderModel.showPopupWithPoints(!1),r(e.OrderModel.statesPriority),!1},chooseDeliveryTypes:function(t,i){var n=t.states[0],a=$("#"+i.target.htmlFor);return a.attr("checked")?!1:(e.OrderModel.deliveryTypesButton=a,e.OrderModel.tmpStatesPriority=t.states,e.OrderModel.choosenDeliveryTypeId=t.id,e.OrderModel.orderDictionary.hasPointDelivery(n)?(e.OrderModel.popupWithPoints({header:t.description,points:e.OrderModel.orderDictionary.getAllPointsByState(n)}),e.OrderModel.showPopupWithPoints(!0),!1):(e.OrderModel.statesPriority=e.OrderModel.tmpStatesPriority,e.OrderModel.choosenPoint(0),r(e.OrderModel.statesPriority),!1))}},ko.applyBindings(e.OrderModel);var i=function i(e){var t='<div class="popupbox width290"><div class="font18 pb18"> '+e+"</div>"+"</div>"+'<p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>',r=$("<div>").addClass("popup").html(t),i=$.Deferred();r.appendTo("body");var n=function(){r.trigger("close"),r.remove(),i.resolve()};return r.lightbox_me({centered:!0,closeClick:!1,closeEsc:!1}),r.find(".closePopup").bind("click",n),i.promise()},n={800:function(e){var t="Товар "+e.name+" недоступен для продажи.",r=$.Deferred();return $.when(i(t)).then(function(){$.ajax({type:"GET",url:e.deleteUrl}).then(r.resolve)}),r.promise()},708:function(e){var t="Вы заказали товар "+e.name+" в количестве "+e.quantity+" шт. <br/ >"+e.error.message,r=$.Deferred();return $.when(i(t)).then(function(){$.ajax({type:"GET",url:e.setUrl}).then(r.resolve)}),r.promise()}},a=function a(e){var t=null,r=[];for(t in e.products)e.products[t].error.code&&r.push(e.products[t]);var i=function i(e,t){var a=null;return 0>e?(console.warn("return"),t(),void 0):(a=r[e].error.code,$.when(n[a](r[e])).then(function(){var r=e-1;i(r,t)}),void 0)};i(r.length-1,function(){console.warn("1 этап закончен"),document.location.href=e.redirect})},o=function o(t){return t.success?(console.info("Данные с сервера получены"),e.OrderModel.orderDictionary=new OrderDictionary(t),e.OrderModel.deliveryTypes(t.deliveryTypes),e.OrderModel.prepareData(!0),void 0):(console.warn("Данные содержат ошибки"),console.log(t.error),a(t),!1)};o($("#jsOrderDelivery").data("value"))}(this);