function DeliveryBox(e,r,t,o,i){console.info("Cоздание блока доставки "+r+" для "+t);var a=this;a.OrderModel=i,a.createdBox=o,a.token=r+"_"+t,a.products=[],a.fullPrice=0,a.state=r,a.deliveryName=a.OrderModel.orderDictionary.getNameOfState(r),a.deliveryPrice=Number.POSITIVE_INFINITY,a.choosenDate=ko.observable(),a.choosenPoint=ko.observable({id:t}),a.choosenInterval=ko.observable(),a.showPopupWithPoints=ko.observable(!1),a.hasPointDelivery=a.OrderModel.orderDictionary.hasPointDelivery(r),a.allDatesForBlock=ko.observableArray([]),a.pointList=ko.observableArray([]),a.hasPointDelivery?a.choosenPoint(a.OrderModel.orderDictionary.getPointByStateAndId(a.state,t)):(a.OrderModel.hasHomeDelivery(!0),$("body").trigger("orderdeliverychange",[!0])),a.calendarSliderLeft=ko.observable(0),a.addProductGroup(e),a.OrderModel.deliveryBoxes.push(a)}function OrderDictionary(e){this.orderData=e,this.serverTime=this.orderData.time,this.deliveryTypes=this.orderData.deliveryTypes,this.deliveryStates=this.orderData.deliveryStates,this.pointsByDelivery=this.orderData.pointsByDelivery,this.products=this.orderData.products}DeliveryBox.prototype._makePointList=function(){var e=this,r=!0;for(var t in e.products[0].deliveries){for(var o=e.products.length-1;o>=0&&(r=e.products[o].deliveries.hasOwnProperty(t),r);o--);r&&e.pointList.push(e.OrderModel.orderDictionary.getPointByStateAndId(e.state,t))}},DeliveryBox.prototype.selectPoint=function(e){var r=this,t=r.state+"_"+e.id;return void 0!==r.createdBox[t]?(r.createdBox[t].addProductGroup(r.products),delete r.createdBox[r.token]):(r.createdBox[t]=r.createdBox[r.token],delete r.createdBox[r.token],r.token=t,r.choosenPoint(e)),r.showPopupWithPoints(!1),!1},DeliveryBox.prototype.changePoint=function(){var e=this;return e.showPopupWithPoints(!0),!1},DeliveryBox.prototype._getFirstPropertyName=function(e){for(var r in e)return r},DeliveryBox.prototype._addProduct=function(e){var r=this,t=null,o=null,i=null,a=[];return e.deliveries[r.state].hasOwnProperty(r.choosenPoint().id)?(t=parseInt(e.deliveries[r.state][r.choosenPoint().id].price,10),r.deliveryPrice=r.deliveryPrice>t?t:r.deliveryPrice,r.fullPrice+=e.sum,r.products.push({name:e.name,price:e.sum,quantity:e.quantity,deleteUrl:e.deleteUrl,productUrl:e.url,productImg:e.image,deliveries:e.deliveries[r.state]}),void 0):(console.warn("Для товара "+e.id+" нет пункта доставки "+r.choosenPoint().id+" Необходимо создать новый блок"),i=r._getFirstPropertyName(e.deliveries[r.state]),o=r.state+"_"+i,a.push(e),void 0!==r.createdBox[o]?r.createdBox[o].addProductGroup(e):r.createdBox[o]=new DeliveryBox(a,r.state,i,r.createdBox,r.OrderModel),void 0)},DeliveryBox.prototype.updateTotalPrice=function(){var e=this,r=e.OrderModel.totalSum();r+=e.fullPrice+e.deliveryPrice,e.OrderModel.totalSum(r)},DeliveryBox.prototype.addProductGroup=function(e){for(var r=this,t=e.length-1;t>=0;t--)r._addProduct(e[t]);r.calculateDate(),r.updateTotalPrice(),r.hasPointDelivery&&r._makePointList()},DeliveryBox.prototype._getNameDayOfWeek=function(e){var r=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"];return r[e]},DeliveryBox.prototype._hasDateInAllProducts=function(e){for(var r=this,t=null,o=null,i=!0,a=r.products.length-1;a>=0;a--){t=r.products[a].deliveries[r.choosenPoint().id].dates;for(var n=0,l=t.length;l>n;n++){if(o=t[n].value,o===e){i=!0;break}i=!1}if(!i)break}return i},DeliveryBox.prototype.clickCalendarDay=function(e){var r=this;return e.avalible?(r.choosenDate(e),void 0):!1},DeliveryBox.prototype.calculateDate=function(){console.info("Вычисление общей даты для продуктов в блоке");var e=this,r=e.OrderModel.orderDictionary.getToday(),t=null,o=null;if(console.log("Сегодняшняя дата с сервера "+r),!e.products.length)return console.warn("в блоке нет товаров"),void 0;t=e.products[0].deliveries[e.choosenPoint().id].dates;for(var i=0,a=t.length;a>i;i++)o=t[i].value,e._hasDateInAllProducts(o)&&o>=r&&(t[i].avalible=!0,t[i].humanDayOfWeek=e._getNameDayOfWeek(t[i].dayOfWeek),e.allDatesForBlock.push(t[i]));e.choosenDate(e.allDatesForBlock()[0]),e.choosenInterval(e.choosenDate().intervals[0]),e.makeCalendar()},DeliveryBox.prototype.makeCalendar=function(){var e=this,r=0,t=null,o={},i=null,a=864e5;if(1!==e.allDatesForBlock()[0].dayOfWeek){r=0===e.allDatesForBlock()[0].dayOfWeek?6:e.allDatesForBlock()[0].dayOfWeek-1,i=e.allDatesForBlock()[0].value;for(var n=r;n>0;n--)t=e.allDatesForBlock()[0].dayOfWeek-1,i-=a,o={avalible:!1,humanDayOfWeek:e._getNameDayOfWeek(t),dayOfWeek:t,day:new Date(i).getDate()},e.allDatesForBlock.unshift(o)}if(0!==e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek){r=7-e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek,i=e.allDatesForBlock()[e.allDatesForBlock().length-1].value;for(var l=r;l>0;l--)t=7===e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek+1?0:e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek+1,i+=a,o={avalible:!1,humanDayOfWeek:e._getNameDayOfWeek(t),dayOfWeek:t,day:new Date(i).getDate()},e.allDatesForBlock.push(o)}},DeliveryBox.prototype.calendarLeftBtn=function(){var e=this,r=parseInt(e.calendarSliderLeft(),10);r+=365,e.calendarSliderLeft(r)},DeliveryBox.prototype.calendarRightBtn=function(){var e=this,r=parseInt(e.calendarSliderLeft(),10);r-=365,e.calendarSliderLeft(r)},ko.bindingHandlers.calendarSlider={update:function(e,r,t,o,i){var a=$(e),n=r(),l=a.find(".bBuyingDatesItem"),s=l.width()+parseInt(l.css("marginRight"),10)+parseInt(l.css("marginLeft"),10);return a.width(l.length*s),n>0?(n-=365,i.box.calendarSliderLeft(n),void 0):-a.width()>n?(n+=365,i.box.calendarSliderLeft(n),void 0):(a.animate({left:n}),void 0)}},OrderDictionary.prototype.getNameOfState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].name:(console.warn("Не найден метод доставки "+e),!1)},OrderDictionary.prototype.getToday=function(){return this.serverTime},OrderDictionary.prototype.hasDeliveryState=function(e){return this.deliveryStates.hasOwnProperty(e)},OrderDictionary.prototype.hasPointDelivery=function(e){return this.pointsByDelivery.hasOwnProperty(e)},OrderDictionary.prototype.getPointByStateAndId=function(e,r){var t=this.getAllPointsByState(e);r+="";for(var o=t.length-1;o>=0;o--)if(t[o].id===r)return t[o]},OrderDictionary.prototype.getAllPointsByState=function(e){var r=this.pointsByDelivery[e];return this.orderData[r]},OrderDictionary.prototype.getProductFromState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].products:(console.warn("Не найден метод доставки "+e),!1)},OrderDictionary.prototype.getProductById=function(e){return this.products.hasOwnProperty(e)?this.products[e]:(console.warn("Такого продукта не найдено"),!1)},function(e){var r={},t=$("#metrostations").data("name"),o=$("#order_recipient_first_name"),i=$("#order_recipient_last_name"),a=$("#order_recipient_email"),n=$("#order_recipient_phonenumbers"),l=$("#order_address_metro"),s=$("#order_subway_id"),d=$("#order_address_street"),c=$("#order_address_building"),u=$('.jsCustomRadio[name="order[payment_type_id]"]'),y=$("#order_agreed"),v=$("#completeOrder"),p={fields:[{fieldNode:o,require:!0,customErr:"Введите имя получателя",validateOnChange:!0},{fieldNode:i,require:!0,customErr:"Введите фамилию получателя",validateOnChange:!0},{fieldNode:a,validBy:"isEmail",customErr:"Некорректно введен e-mail",validateOnChange:!0},{fieldNode:n,require:!0,customErr:"Некорректно введен телефон",validateOnChange:!0},{fieldNode:l,customErr:"Не выбрана станция метро",validateOnChange:!0},{fieldNode:d,require:!0,customErr:"Не введено название улицы",validateOnChange:!0},{fieldNode:c,require:!0,customErr:"Не введен номер дома",validateOnChange:!0},{fieldNode:y,require:!0,customErr:"Необходимо согласие"},{fieldNode:u,require:!0,customErr:"Необходимо выбрать метод оплаты"}]},h={source:t,appendTo:"#metrostations",minLength:2,select:function(e,r){s.val(r.item.val)}};r=new FormValidator(p);var f=function f(){return console.info("завершить оформление заказа"),r.validate({onInvalid:function(e){console.warn("invalid"),console.log(e),$.scrollTo(e[e.length-1].fieldNode,500,{offset:-15})},onValid:function(){console.info("valid")}}),!1},D=function D(){for(var e=t.length-1;e>=0;e--)if(l.val()===t[e].label)return;l.val("")},g=function g(e,t){t?r.setValidate(l,{require:!0}):r.setValidate(l,{require:!1}),console.info("Изменен тип доставки"),console.log(r)};n.mask("(999) 999-99-99"),e.docCookies.getItem("emails")&&(console.log("AB TEST: e-mail require"),r.setValidate(a,{require:!0})),void 0!==t&&(l.autocomplete(h),l.bind("change",D)),$("body").bind("orderdeliverychange",g),v.bind("click",f)}(this),function(){console.info("Логика разбиения заказа для оформления заказа v.5");var e={},r=function r(r){var o={},i=[],a=[],n=null,l=null,s=null,d=null;e={},t.deliveryBoxes.removeAll(),t.deliveryTypesButton.attr("checked","checked"),t.totalSum(0),t.hasHomeDelivery(!1),$("body").trigger("orderdeliverychange",[!1]);for(var c=0,u=r.length;u>c;c++)if(s=r[c],console.info("перебирем метод "+s),a=[],t.orderDictionary.hasDeliveryState(s)){i=t.orderDictionary.getProductFromState(s);for(var y=i.length-1;y>=0;y--)d=i[y],o[d]?console.log("товар "+d+" уже определялся к блоку"):(console.log("добавляем товар "+d+" в блок для метода "+s),o[d]=!0,a.push(t.orderDictionary.getProductById(d)));a.length&&(n=t.orderDictionary.hasPointDelivery(s)?t.choosenPoint():0,l=s+"_"+n,void 0!==e[l]?e[l].addProductGroup(a):e[l]=new DeliveryBox(a,s,n,e,t))}else console.info("для метода "+s+" нет товаров");console.info("Созданные блоки:"),console.log(e),o.length!==t.orderDictionary.orderData.products.length&&console.warn("не все товары были обработаны")};ko.bindingHandlers.popupShower={update:function(e,r){var t=r(),o=ko.utils.unwrapObservable(t);o?$(e).lightbox_me({centered:!0,onClose:function(){console.info("закрываем"),t(!1)}}):$(e).trigger("close")}},ko.bindingHandlers.paymentMethodVisible={update:function(e,r){var t=r(),o=ko.utils.unwrapObservable(t),i=parseInt($(e).data("max-sum"),10);isNaN(i)||(o>i?$(e).hide():$(e).show())}};var t={prepareData:ko.observable(!1),showPopupWithPoints:ko.observable(!1),deliveryTypesButton:null,tmpStatesPriority:null,statesPriority:null,orderDictionary:null,choosenPoint:ko.observable(),hasHomeDelivery:ko.observable(!1),deliveryTypes:ko.observableArray([]),deliveryBoxes:ko.observableArray([]),popupWithPoints:ko.observable({}),totalSum:ko.observable(0),selectPoint:function(e){return console.info("point selected..."),t.statesPriority=t.tmpStatesPriority,t.choosenPoint(e.id),t.showPopupWithPoints(!1),r(t.statesPriority),!1},chooseDeliveryTypes:function(e,o){var i=e.states[0],a=$("#"+o.target.htmlFor);return a.attr("checked")?!1:(t.deliveryTypesButton=a,t.tmpStatesPriority=e.states,t.orderDictionary.hasPointDelivery(i)?(t.popupWithPoints({header:e.description,points:t.orderDictionary.getAllPointsByState(i)}),t.showPopupWithPoints(!0),!1):(t.statesPriority=t.tmpStatesPriority,t.choosenPoint(0),r(t.statesPriority),!1))}};ko.applyBindings(t);var o=function o(e){return e.success?(console.log("Данные с сервера получены"),t.orderDictionary=new OrderDictionary(e),t.deliveryTypes(e.deliveryTypes),t.prepareData(!0),void 0):(console.warn("произошла ошибка при получении данных с сервера"),console.log(e.error),!1)};o($("#jsOrderDelivery").data("value"))}();