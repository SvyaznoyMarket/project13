function DeliveryBox(e,o,t,r,i){console.info("Cоздание блока доставки "+o+" для "+t);var a=this;a.OrderModel=i,a.createdBox=r,a.token=o+"_"+t,a.products=[],a.fullPrice=0,a.state=o,a.deliveryName=a.OrderModel.orderDictionary.getNameOfState(o),a.deliveryPrice=Number.POSITIVE_INFINITY,a.choosenDate=ko.observable(),a.choosenPoint=ko.observable({id:t}),a.choosenInterval=ko.observable(),a.showPopupWithPoints=ko.observable(!1),a.hasPointDelivery=a.OrderModel.orderDictionary.hasPointDelivery(o),a.allDatesForBlock=ko.observableArray([]),a.pointList=ko.observableArray([]),a.hasPointDelivery&&a.choosenPoint(a.OrderModel.orderDictionary.getPointByStateAndId(a.state,t)),a.addProductGroup(e),a.OrderModel.deliveryBoxes.push(a)}function OrderDictionary(e){this.orderData=e,this.serverTime=this.orderData.time,this.deliveryTypes=this.orderData.deliveryTypes,this.deliveryStates=this.orderData.deliveryStates,this.pointsByDelivery=this.orderData.pointsByDelivery,this.products=this.orderData.products}DeliveryBox.prototype._makePointList=function(){var e=this,o=!0;for(var t in e.products[0].deliveries){for(var r=e.products.length-1;r>=0&&(o=e.products[r].deliveries.hasOwnProperty(t),o);r--);o&&e.pointList.push(e.OrderModel.orderDictionary.getPointByStateAndId(e.state,t))}},DeliveryBox.prototype.selectPoint=function(e){var o=this,t=o.state+"_"+e.id;return void 0!==o.createdBox[t]?(o.createdBox[t].addProductGroup(o.products),delete o.createdBox[o.token]):(o.createdBox[t]=o.createdBox[o.token],delete o.createdBox[o.token],o.token=t,o.choosenPoint(e)),o.showPopupWithPoints(!1),!1},DeliveryBox.prototype.changePoint=function(){var e=this;return e.showPopupWithPoints(!0),!1},DeliveryBox.prototype._getFirstPropertyName=function(e){for(var o in e)return o},DeliveryBox.prototype._addProduct=function(e){var o=this,t=null,r=null,i=null,a=[];return e.deliveries[o.state].hasOwnProperty(o.choosenPoint().id)?(t=parseInt(e.deliveries[o.state][o.choosenPoint().id].price,10),o.deliveryPrice=o.deliveryPrice>t?t:o.deliveryPrice,o.fullPrice+=e.sum,o.products.push({name:e.name,price:e.sum,quantity:e.quantity,deleteUrl:e.deleteUrl,productUrl:e.url,productImg:e.image,deliveries:e.deliveries[o.state]}),void 0):(console.warn("Для товара "+e.id+" нет пункта доставки "+o.choosenPoint().id+" Необходимо создать новый блок"),i=o._getFirstPropertyName(e.deliveries[o.state]),r=o.state+"_"+i,a.push(e),void 0!==o.createdBox[r]?o.createdBox[r].addProductGroup(e):o.createdBox[r]=new DeliveryBox(a,o.state,i,o.createdBox,o.OrderModel),void 0)},DeliveryBox.prototype.addProductGroup=function(e){for(var o=this,t=e.length-1;t>=0;t--)o._addProduct(e[t]);this.calculateDate(),o.hasPointDelivery&&o._makePointList()},DeliveryBox.prototype._getNameDayOfWeek=function(e){var o=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"];return o[e]},DeliveryBox.prototype._hasDateInAllProducts=function(e){for(var o=this,t=null,r=null,i=!0,a=o.products.length-1;a>=0;a--){t=o.products[a].deliveries[o.choosenPoint().id].dates;for(var n=0,l=t.length;l>n;n++){if(r=t[n].value,r===e){i=!0;break}i=!1}if(!i)break}return i},DeliveryBox.prototype.calculateDate=function(){console.info("Вычисление общей даты для продуктов в блоке");var e=this,o=e.OrderModel.orderDictionary.getToday(),t=null,r=null;if(console.log("Сегодняшняя дата с сервера "+o),!e.products.length)return console.warn("в блоке нет товаров"),void 0;t=e.products[0].deliveries[e.choosenPoint().id].dates;for(var i=0,a=t.length;a>i;i++)r=t[i].value,e._hasDateInAllProducts(r)&&r>=o&&(t[i].avalible=!0,t[i].humanDayOfWeek=e._getNameDayOfWeek(t[i].dayOfWeek),t[i].selectDay=e.selectDay,e.allDatesForBlock.push(t[i]));e.choosenDate(e.allDatesForBlock()[0]),e.choosenInterval(e.choosenDate().intervals[0]),e.makeCalendar()},DeliveryBox.prototype.makeCalendar=function(){var e=this,o=0,t=null,r={};if(1!==e.allDatesForBlock()[0].dayOfWeek){o=0===e.allDatesForBlock()[0].dayOfWeek?6:e.allDatesForBlock()[0].dayOfWeek-1;for(var i=o;i>0;i--)t=e.allDatesForBlock()[0].dayOfWeek-1,r={avalible:!1,humanDayOfWeek:e._getNameDayOfWeek(t),dayOfWeek:t,day:0},e.allDatesForBlock.unshift(r)}if(0!==e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek){o=7-e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek;for(var a=o;a>0;a--)t=7===e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek+1?0:e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek+1,r={avalible:!1,humanDayOfWeek:e._getNameDayOfWeek(t),dayOfWeek:t,day:0},e.allDatesForBlock.push(r)}},OrderDictionary.prototype.getNameOfState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].name:(console.warn("Не найден метод доставки "+e),!1)},OrderDictionary.prototype.getToday=function(){return this.serverTime},OrderDictionary.prototype.hasDeliveryState=function(e){return this.deliveryStates.hasOwnProperty(e)},OrderDictionary.prototype.hasPointDelivery=function(e){return this.pointsByDelivery.hasOwnProperty(e)},OrderDictionary.prototype.getPointByStateAndId=function(e,o){var t=this.getAllPointsByState(e);o+="";for(var r=t.length-1;r>=0;r--)if(t[r].id===o)return t[r]},OrderDictionary.prototype.getAllPointsByState=function(e){var o=this.pointsByDelivery[e];return this.orderData[o]},OrderDictionary.prototype.getProductFromState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].products:(console.warn("Не найден метод доставки "+e),!1)},OrderDictionary.prototype.getProductById=function(e){return this.products.hasOwnProperty(e)?this.products[e]:(console.warn("Такого продукта не найдено"),!1)},function(){console.info("Логика разбиения заказа для оформления заказа v.5");var e="/ajax/order-delivery",o=null,t={},r=function r(e){for(var r={},a=[],n=[],l=null,s=null,d=null,c=null,y=0,u=e.length;u>y;y++)if(d=e[y],console.info("перебирем метод "+d),n=[],i.orderDictionary.hasDeliveryState(d)){a=i.orderDictionary.getProductFromState(d);for(var p=a.length-1;p>=0;p--)c=a[p],r[c]?console.log("товар "+c+" уже определялся к блоку"):(console.log("добавляем товар "+c+" в блок для метода "+d),r[c]=!0,n.push(i.orderDictionary.getProductById(c)));n.length&&(l=i.orderDictionary.hasPointDelivery(d)?o:0,s=d+"_"+l,void 0!==t[s]?t[s].addProductGroup(n):t[s]=new DeliveryBox(n,d,l,t,i))}else console.info("для метода "+d+" нет товаров");console.info("Созданные блоки:"),console.log(t),r.length!==i.orderDictionary.orderData.products.length&&console.warn("не все товары были обработаны")},i={prepareData:ko.observable(!1),statesPriority:null,orderDictionary:null,deliveryTypes:ko.observableArray([]),deliveryBoxes:ko.observableArray([]),showPopupWithPoints:ko.observable(!1),popupWithPoints:ko.observable({}),selectPoint:function(e){return console.info("point selected..."),o=e.id,i.showPopupWithPoints(!1),r(i.statesPriority),!1},chooseDeliveryTypes:function(e){var a=e.states[0];return i.statesPriority=e.states,t={},i.deliveryBoxes.removeAll(),i.orderDictionary.hasPointDelivery(a)?(i.popupWithPoints({header:e.description,points:i.orderDictionary.getAllPointsByState(a)}),i.showPopupWithPoints(!0),!1):(o=0,r(i.statesPriority),!1)}};ko.applyBindings(i);var a=function a(e){return e.success?(console.log("Данные с сервера получены"),i.orderDictionary=new OrderDictionary(e),i.deliveryTypes(e.deliveryTypes),i.prepareData(!0),$("#order").removeClass("hidden"),void 0):(console.warn("произошла ошибка при получении данных с сервера"),console.log(e.error),!1)};$.ajax({type:"GET",url:e,success:a})}();