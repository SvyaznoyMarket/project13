function DeliveryBox(e,r,o,t,a){console.info("Cоздание блока доставки "+r+" для "+o);var n=this;n.OrderModel=a,n.createdBox=t,n.token=r+"_"+o,n.products=[],n.fullPrice=0,n.state=r,n.deliveryName=n.OrderModel.orderDictionary.getNameOfState(r),n.deliveryPrice=Number.POSITIVE_INFINITY,n.choosenDate=ko.observable(),n.choosenNameOfWeek=ko.observable(),n.choosenPoint=ko.observable({id:o}),n.choosenInterval=ko.observable(),n.showPopupWithPoints=ko.observable(!1),n.hasPointDelivery=n.OrderModel.orderDictionary.hasPointDelivery(r),n.allDatesForBlock=ko.observableArray([]),n.pointList=ko.observableArray([]),n.hasPointDelivery?n.choosenPoint(n.OrderModel.orderDictionary.getPointByStateAndId(n.state,o)):(n.OrderModel.hasHomeDelivery(!0),$("body").trigger("orderdeliverychange",[!0])),n.calendarSliderLeft=ko.observable(0),n.addProductGroup(e),n.OrderModel.deliveryBoxes.push(n)}function OrderDictionary(e){this.orderData=e,this.serverTime=this.orderData.time,this.deliveryTypes=this.orderData.deliveryTypes,this.deliveryStates=this.orderData.deliveryStates,this.pointsByDelivery=this.orderData.pointsByDelivery,this.products=this.orderData.products}DeliveryBox.prototype._makePointList=function(){var e=this,r=!0;for(var o in e.products[0].deliveries){for(var t=e.products.length-1;t>=0&&(r=e.products[t].deliveries.hasOwnProperty(o),r);t--);r&&e.pointList.push(e.OrderModel.orderDictionary.getPointByStateAndId(e.state,o))}},DeliveryBox.prototype.selectPoint=function(e){var r=this,o=r.state+"_"+e.id;return void 0!==r.createdBox[o]?(r.createdBox[o].addProductGroup(r.products),delete r.createdBox[r.token]):(r.createdBox[o]=r.createdBox[r.token],delete r.createdBox[r.token],r.token=o,r.choosenPoint(e)),r.showPopupWithPoints(!1),!1},DeliveryBox.prototype.changePoint=function(){var e=this;return e.showPopupWithPoints(!0),!1},DeliveryBox.prototype._getFirstPropertyName=function(e){for(var r in e)return r},DeliveryBox.prototype._addProduct=function(e){var r=this,o=null,t=null,a=null,n=[];return e.deliveries[r.state].hasOwnProperty(r.choosenPoint().id)?(o=parseInt(e.deliveries[r.state][r.choosenPoint().id].price,10),r.deliveryPrice=r.deliveryPrice>o?o:r.deliveryPrice,r.fullPrice+=e.sum,r.products.push({id:e.id,name:e.name,price:e.sum,quantity:e.quantity,deleteUrl:e.deleteUrl,productUrl:e.url,productImg:e.image,deliveries:e.deliveries[r.state]}),void 0):(console.warn("Для товара "+e.id+" нет пункта доставки "+r.choosenPoint().id+" Необходимо создать новый блок"),a=r._getFirstPropertyName(e.deliveries[r.state]),t=r.state+"_"+a,n.push(e),void 0!==r.createdBox[t]?r.createdBox[t].addProductGroup(e):r.createdBox[t]=new DeliveryBox(n,r.state,a,r.createdBox,r.OrderModel),void 0)},DeliveryBox.prototype.updateTotalPrice=function(){var e=this,r=e.OrderModel.totalSum();r+=e.fullPrice+e.deliveryPrice,e.OrderModel.totalSum(r)},DeliveryBox.prototype.addProductGroup=function(e){for(var r=this,o=e.length-1;o>=0;o--)r._addProduct(e[o]);r.calculateDate(),r.updateTotalPrice(),r.hasPointDelivery&&r._makePointList()},DeliveryBox.prototype._getNameDayOfWeek=function(e){var r=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"];return r[e]},DeliveryBox.prototype._getFullNameDayOfWeek=function(e){var r=["воскресение","понедельник","вторник","среда","четверг","пятница","суббота"];return r[e]},DeliveryBox.prototype._hasDateInAllProducts=function(e){for(var r=this,o=null,t=null,a=!0,n=r.products.length-1;n>=0;n--){o=r.products[n].deliveries[r.choosenPoint().id].dates;for(var i=0,l=o.length;l>i;i++){if(t=o[i].value,t===e){a=!0;break}a=!1}if(!a)break}return a},DeliveryBox.prototype.clickCalendarDay=function(e){var r=this;return e.avalible?(r.choosenNameOfWeek(r._getFullNameDayOfWeek(e.dayOfWeek)),r.choosenDate(e),void 0):!1},DeliveryBox.prototype.calculateDate=function(){console.info("Вычисление общей даты для продуктов в блоке");var e=this,r=e.OrderModel.orderDictionary.getToday(),o=null,t=null;if(console.log("Сегодняшняя дата с сервера "+r),!e.products.length)return console.warn("в блоке нет товаров"),void 0;o=e.products[0].deliveries[e.choosenPoint().id].dates;for(var a=0,n=o.length;n>a;a++)t=o[a].value,e._hasDateInAllProducts(t)&&t>=r&&(o[a].avalible=!0,o[a].humanDayOfWeek=e._getNameDayOfWeek(o[a].dayOfWeek),e.allDatesForBlock.push(o[a]));e.choosenDate(e.allDatesForBlock()[0]),e.choosenNameOfWeek(e._getFullNameDayOfWeek(e.allDatesForBlock()[0].dayOfWeek)),e.choosenInterval(e.choosenDate().intervals[0]),e.makeCalendar()},DeliveryBox.prototype.makeCalendar=function(){var e=this,r=0,o=null,t={},a=null,n=864e5;if(1!==e.allDatesForBlock()[0].dayOfWeek){r=0===e.allDatesForBlock()[0].dayOfWeek?6:e.allDatesForBlock()[0].dayOfWeek-1,a=e.allDatesForBlock()[0].value;for(var i=r;i>0;i--)o=e.allDatesForBlock()[0].dayOfWeek-1,a-=n,t={avalible:!1,humanDayOfWeek:e._getNameDayOfWeek(o),dayOfWeek:o,day:new Date(a).getDate()},e.allDatesForBlock.unshift(t)}if(0!==e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek){r=7-e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek,a=e.allDatesForBlock()[e.allDatesForBlock().length-1].value;for(var l=r;l>0;l--)o=7===e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek+1?0:e.allDatesForBlock()[e.allDatesForBlock().length-1].dayOfWeek+1,a+=n,t={avalible:!1,humanDayOfWeek:e._getNameDayOfWeek(o),dayOfWeek:o,day:new Date(a).getDate()},e.allDatesForBlock.push(t)}},DeliveryBox.prototype.calendarLeftBtn=function(){var e=this,r=parseInt(e.calendarSliderLeft(),10);r+=380,e.calendarSliderLeft(r)},DeliveryBox.prototype.calendarRightBtn=function(){var e=this,r=parseInt(e.calendarSliderLeft(),10);r-=380,e.calendarSliderLeft(r)},ko.bindingHandlers.calendarSlider={update:function(e,r,o,t,a){var n=$(e),i=r(),l=n.find(".bBuyingDatesItem"),d=l.width()+parseInt(l.css("marginRight"),10)+parseInt(l.css("marginLeft"),10);return n.width(l.length*d),i>0?(i-=380,a.box.calendarSliderLeft(i),void 0):-n.width()>i?(i+=380,a.box.calendarSliderLeft(i),void 0):(n.animate({left:i}),void 0)}},function(){var e=$(".bBankWrap"),r=function r(){var r=e.find(".bBankLink"),o=e.find(".bBankLink__eName"),t=e.find(".bSelect"),a=$("#selectedBank"),n=e.find(".bSelectWrap_eText"),i=function i(){var e=$("option:selected",t).attr("data-link"),i=$("option:selected",t).val(),l=$("option:selected",t).html();n.html(l),o.html(l),a.val(i),r.attr("href",e)};$("option",t).eq(0).attr("selected","selected"),t.change(i),i(),DirectCredit.init($("#jsCreditBank").data("value"),$("#creditPrice"))};e.length&&r()}(this),OrderDictionary.prototype.getNameOfState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].name:(console.warn("Не найден метод доставки "+e),!1)},OrderDictionary.prototype.getToday=function(){return this.serverTime},OrderDictionary.prototype.hasDeliveryState=function(e){return this.deliveryStates.hasOwnProperty(e)},OrderDictionary.prototype.hasPointDelivery=function(e){return this.pointsByDelivery.hasOwnProperty(e)},OrderDictionary.prototype.getPointByStateAndId=function(e,r){var o=this.getAllPointsByState(e);r+="";for(var t=o.length-1;t>=0;t--)if(o[t].id===r)return o[t]},OrderDictionary.prototype.getAllPointsByState=function(e){var r=this.pointsByDelivery[e];return this.orderData[r]},OrderDictionary.prototype.getProductFromState=function(e){return this.hasDeliveryState(e)?this.deliveryStates[e].products:(console.warn("Не найден метод доставки "+e),!1)},OrderDictionary.prototype.getProductById=function(e){return this.products.hasOwnProperty(e)?this.products[e]:(console.warn("Такого продукта не найдено"),!1)},function(){if(!$("#paymentMethod-10").length)return console.warn("нет метода оплаты сертификатом"),!1;var e=$("#paymentMethod-10").parent(),r=e.find(".mCardNumber"),o=e.find(".mCardPin"),t=e.find(".bPayMethodAction"),a=t.attr("data-url");console.log(e),console.log(r),console.log(o),console.log(t),console.log(a);var n=function(){var e=!1,n="processBlock",i=function i(){return r.val().replace(/[^0-9]/g,"")},l=function l(){return o.val().replace(/[^0-9]/g,"")},d=function d(){return{code:i(),pin:l()}},s=function s(){return e&&""!==i()&&14===i().length&&""!==l()&&4===l().length?!0:!1},c=function c(){return 4!==o.val().length?(console.warn("пин код мал"),!1):r.val().length?(u("mOrange","Проверка по номеру карты"),$.post(a,d(),function(e){if(!("success"in e))return!1;if(!e.success){var r=e.error!==void 0?e.error:"ERROR";return u("mRed",r),!1}u("mGreen",e.data)}),void 0):(console.warn("номер карты не введен"),!1)},u=function u(r,o){console.info("setProcessingStatus");var a=$(".process").first(),i={typeNum:r};switch(a.hasClass("picked")||a.remove(),r){case"mOrange":i.text=o,e=!1;break;case"mRed":i.text="Произошла ошибка: "+o,e=!1;break;case"mGreen":i.text="activated"in o?"Карта "+o.code+" на сумму "+o.sum+" активирована!":"Карта "+o.code+" имеет номинал "+o.sum,e=!0}t.after(tmpl(n,i)),o.activated!==void 0&&$(".process").first().addClass("picked")};return{checkCard:c,setProcessingStatus:u,isActive:s,getCode:i,getPIN:l}}();r.bind("change",function(){n.checkCard()}),o.bind("change",function(){n.checkCard()}),o.mask("9999",{completed:n.checkCard,placeholder:"*"})}(this),function(e){var r={},o=$("#metrostations").data("name"),t=$("#order_recipient_first_name"),a=$("#order_recipient_last_name"),n=$("#order_recipient_email"),i=$("#order_recipient_phonenumbers"),l=$("#order_address_metro"),d=$("#order_subway_id"),s=$("#order_address_street"),c=$("#order_address_building"),u=$('.jsCustomRadio[name="order[payment_method_id]"]'),v=$("#order_agreed"),p=$("#completeOrder"),h={fields:[{fieldNode:t,require:!0,customErr:"Введите имя получателя",validateOnChange:!0},{fieldNode:a,require:!0,customErr:"Введите фамилию получателя",validateOnChange:!0},{fieldNode:n,validBy:"isEmail",customErr:"Некорректно введен e-mail",validateOnChange:!0},{fieldNode:i,require:!0,customErr:"Некорректно введен телефон",validateOnChange:!0},{fieldNode:v,require:!0,customErr:"Необходимо согласие"},{fieldNode:u,require:!0,customErr:"Необходимо выбрать метод оплаты"}]},y={source:o,appendTo:"#metrostations",minLength:2,select:function(e,r){d.val(r.item.val)}};r=new FormValidator(h);var f={noti:null,block:function(e){console.warn("block screen"),this.noti&&this.unblock(),this.noti=$("<div>").addClass("noti").html('<div><img src="/images/ajaxnoti.gif" /></br></br> '+e+"</div>"),this.noti.appendTo("body"),this.noti.lightbox_me({centered:!0,closeClick:!1,closeEsc:!1})},unblock:function(){console.warn("unblock screen"),this.noti.trigger("close"),this.noti.remove()}},m=function m(e){console.info("данные отправлены. получен ответ от сервера"),console.log(e),f.unblock()},g=function g(){var r=null,o=[],t=[],a={},n=$("#order-form");f.block("Ваш заказ оформляется"),console.info("Перебираем блоки доставки");for(var i=e.OrderModel.deliveryBoxes().length-1;i>=0;i--){a={},r=e.OrderModel.deliveryBoxes()[i],console.log(r),a={deliveryMethod_token:r.state,date:r.choosenDate().value,interval:[r.choosenInterval().start,r.choosenInterval().end],point_id:r.choosenPoint().id,products:[]};for(var l=r.products.length-1;l>=0;l--)a.products.push(r.products[l].id);o.push(a)}t=n.serializeArray(),t.push({name:"order[delivery_type_id]",value:e.OrderModel.choosenDeliveryTypeId}),t.push({name:"order[part]",value:JSON.stringify(o)}),console.log(t),$.ajax({url:n.attr("action"),timeout:12e4,type:"POST",data:t,success:m})},D=function D(){return console.info("завершить оформление заказа"),r.validate({onInvalid:function(e){console.warn("invalid"),console.log(e),$.scrollTo(e[e.length-1].fieldNode,500,{offset:-15})},onValid:g}),!1},k=function k(){for(var e=o.length-1;e>=0;e--)if(l.val()===o[e].label)return;l.val("")},O=function O(e,t){t?(r.setValidate(s,{require:!0,customErr:"Не введено название улицы",validateOnChange:!0}),r.setValidate(c,{require:!0,customErr:"Не введен номер дома",validateOnChange:!0}),void 0!==o&&r.setValidate(l,{fieldNode:l,customErr:"Не выбрана станция метро",require:!0,validateOnChange:!0})):(r.setValidate(s,{require:!1}),r.setValidate(c,{require:!1}),void 0!==o&&r.setValidate(l,{require:!1})),console.info("Изменен тип доставки"),console.log(r)};i.mask("(999) 999-99-99"),e.docCookies.getItem("emails")&&(console.log("AB TEST: e-mail require"),r.setValidate(n,{require:!0})),void 0!==o&&(l.autocomplete(y),l.bind("change",k));var b=function b(e){var r=null;console.info("defaultValueToField");for(var o in e)console.log("поле "+o),e[o]&&(console.log("для поля есть значение "+e[o]),r=$('input[name="'+o+'"]'),"text"===r.attr("type")&&r.val(e[o]),"radio"===r.attr("type")&&r.filter('[value="'+e[o]+'"]').attr("checked","checked"))};b($("#jsOrderForm").data("value")),$("body").bind("orderdeliverychange",O),p.bind("click",D)}(this),function(e){console.info("Логика разбиения заказа для оформления заказа v.5");var r={},o=function o(o){var t={},a=[],n=[],i=null,l=null,d=null,s=null,c=e.OrderModel.orderDictionary.orderData.discounts;r={},e.OrderModel.deliveryBoxes.removeAll(),e.OrderModel.deliveryTypesButton.attr("checked","checked"),e.OrderModel.totalSum(0),e.OrderModel.hasHomeDelivery(!1),$("body").trigger("orderdeliverychange",[!1]),e.OrderModel.couponsBox(c);for(var u=0,v=o.length;v>u;u++)if(d=o[u],console.info("перебирем метод "+d),n=[],e.OrderModel.orderDictionary.hasDeliveryState(d)){a=e.OrderModel.orderDictionary.getProductFromState(d);for(var p=a.length-1;p>=0;p--)s=a[p],t[s]?console.log("товар "+s+" уже определялся к блоку"):(console.log("добавляем товар "+s+" в блок для метода "+d),t[s]=!0,n.push(e.OrderModel.orderDictionary.getProductById(s)));n.length&&(i=e.OrderModel.orderDictionary.hasPointDelivery(d)?e.OrderModel.choosenPoint():0,l=d+"_"+i,void 0!==r[l]?r[l].addProductGroup(n):r[l]=new DeliveryBox(n,d,i,r,e.OrderModel))}else console.info("для метода "+d+" нет товаров");console.info("Созданные блоки:"),console.log(r),t.length!==e.OrderModel.orderDictionary.orderData.products.length&&console.warn("не все товары были обработаны")};ko.bindingHandlers.popupShower={update:function(e,r){var o=r(),t=ko.utils.unwrapObservable(o);t?$(e).lightbox_me({centered:!0,onClose:function(){console.info("закрываем"),o(!1)}}):$(e).trigger("close")}},ko.bindingHandlers.paymentMethodVisible={update:function(e,r){var o=r(),t=ko.utils.unwrapObservable(o),a=parseInt($(e).data("value")["max-sum"],10);isNaN(a)||(t>a?$(e).hide():$(e).show())}},e.OrderModel={updateUrl:$("#jsOrderDelivery").data("url"),prepareData:ko.observable(!1),showPopupWithPoints:ko.observable(!1),deliveryTypesButton:null,tmpStatesPriority:null,statesPriority:null,orderDictionary:null,choosenPoint:ko.observable(),hasHomeDelivery:ko.observable(!1),deliveryTypes:ko.observableArray([]),deliveryBoxes:ko.observableArray([]),popupWithPoints:ko.observable({}),totalSum:ko.observable(0),couponNumber:ko.observable(),couponUrl:ko.observable($(".bSaleData .jsCustomRadio").eq(0).val()),couponError:ko.observable(),couponsBox:ko.observableArray([]),checkCoupon:function(){var r={number:e.OrderModel.couponNumber()},o=e.OrderModel.couponUrl(),t=function t(r){return r.success?void 0:(e.OrderModel.couponError(r.error.message),void 0)};return e.OrderModel.couponError(""),void 0===o?(e.OrderModel.couponError("Не выбран тип сертификата"),void 0):($.ajax({type:"POST",url:o,data:r,success:t}),void 0)},selectPoint:function(r){return console.info("point selected..."),e.OrderModel.statesPriority=e.OrderModel.tmpStatesPriority,e.OrderModel.choosenPoint(r.id),e.OrderModel.showPopupWithPoints(!1),o(e.OrderModel.statesPriority),!1},chooseDeliveryTypes:function(r,t){var a=r.states[0],n=$("#"+t.target.htmlFor);return n.attr("checked")?!1:(e.OrderModel.deliveryTypesButton=n,e.OrderModel.tmpStatesPriority=r.states,e.OrderModel.choosenDeliveryTypeId=r.id,e.OrderModel.orderDictionary.hasPointDelivery(a)?(e.OrderModel.popupWithPoints({header:r.description,points:e.OrderModel.orderDictionary.getAllPointsByState(a)}),e.OrderModel.showPopupWithPoints(!0),!1):(e.OrderModel.statesPriority=e.OrderModel.tmpStatesPriority,e.OrderModel.choosenPoint(0),o(e.OrderModel.statesPriority),!1))}},ko.applyBindings(e.OrderModel);var t=function t(e){var r='<div class="popupbox width290"><div class="font18 pb18"> '+e+"</div>"+"</div>"+'<p style="text-align:center"><a href="#" class="closePopup bBigOrangeButton">OK</a></p>',o=$("<div>").addClass("popup").html(r),t=$.Deferred();o.appendTo("body");var a=function(){o.trigger("close"),o.remove(),t.resolve()};return o.lightbox_me({centered:!0,closeClick:!1,closeEsc:!1}),o.find(".closePopup").bind("click",a),t.promise()},a={800:function(e){var r="Товар "+e.name+" недоступен для продажи.",o=$.Deferred();return $.when(t(r)).then(function(){$.ajax({type:"GET",url:e.deleteUrl}).then(o.resolve)}),o.promise()},708:function(e){var r="Вы заказали товар "+e.name+" в количестве "+e.quantity+" шт. <br/ >"+e.error.message,o=$.Deferred();return $.when(t(r)).then(function(){$.ajax({type:"GET",url:e.setUrl}).then(o.resolve)}),o.promise()}},n=function n(e){var r=null,o=[];for(r in e.products)e.products[r].error.code&&o.push(e.products[r]);var t=function t(e,r){var n=null;return 0>e?(console.warn("return"),r(),void 0):(n=o[e].error.code,$.when(a[n](o[e])).then(function(){var o=e-1;t(o,r)}),void 0)};t(o.length-1,function(){console.warn("1 этап закончен"),document.location.href=e.redirect})},i=function i(r){return r.success?(console.info("Данные с сервера получены"),e.OrderModel.orderDictionary=new OrderDictionary(r),e.OrderModel.deliveryTypes(r.deliveryTypes),e.OrderModel.prepareData(!0),void 0):(console.warn("Данные содержат ошибки"),console.log(r.error),n(r),!1)};i($("#jsOrderDelivery").data("value"))}(this);