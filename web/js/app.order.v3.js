$(document).ready(function() {
var zitata = {
"standart_rapid":{
"name":"стандарт",
"slug":"standart_rapid",
"mode_id":1,
"delivery_type_id":11,
"delivery_id":1,
"type":"delivery",
"price":"290",
"date_default":"2012-03-23T19:08:36+04:00",
"date_list":[
{
"date":"2012-03-23T00:00:00+04:00",
"interval":[
{
"id":2,
"time_begin":"09:00",
"time_end":"14:00"
},
{
"id":5,
"time_begin":"09:00",
"time_end":"18:00"
},
{
"id":3,
"time_begin":"14:00",
"time_end":"18:00"
},
{
"id":4,
"time_begin":"18:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-24T00:00:00+04:00",
"interval":[
{
"id":2,
"time_begin":"09:00",
"time_end":"14:00"
},
{
"id":5,
"time_begin":"09:00",
"time_end":"18:00"
},
{
"id":3,
"time_begin":"14:00",
"time_end":"18:00"
},
{
"id":4,
"time_begin":"18:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-25T00:00:00+04:00",
"interval":[
{
"id":2,
"time_begin":"09:00",
"time_end":"14:00"
},
{
"id":5,
"time_begin":"09:00",
"time_end":"18:00"
},
{
"id":3,
"time_begin":"14:00",
"time_end":"18:00"
},
{
"id":4,
"time_begin":"18:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-26T00:00:00+04:00",
"interval":[
{
"id":2,
"time_begin":"09:00",
"time_end":"14:00"
},
{
"id":5,
"time_begin":"09:00",
"time_end":"18:00"
},
{
"id":3,
"time_begin":"14:00",
"time_end":"18:00"
},
{
"id":4,
"time_begin":"18:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-27T00:00:00+04:00",
"interval":[
{
"id":2,
"time_begin":"09:00",
"time_end":"14:00"
},
{
"id":5,
"time_begin":"09:00",
"time_end":"18:00"
},
{
"id":3,
"time_begin":"14:00",
"time_end":"18:00"
},
{
"id":4,
"time_begin":"18:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-28T00:00:00+04:00",
"interval":[
{
"id":2,
"time_begin":"09:00",
"time_end":"14:00"
},
{
"id":5,
"time_begin":"09:00",
"time_end":"18:00"
},
{
"id":3,
"time_begin":"14:00",
"time_end":"18:00"
},
{
"id":4,
"time_begin":"18:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-29T00:00:00+04:00",
"interval":[
{
"id":2,
"time_begin":"09:00",
"time_end":"14:00"
},
{
"id":5,
"time_begin":"09:00",
"time_end":"18:00"
},
{
"id":3,
"time_begin":"14:00",
"time_end":"18:00"
},
{
"id":4,
"time_begin":"18:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-30T00:00:00+04:00",
"interval":[
{
"id":2,
"time_begin":"09:00",
"time_end":"14:00"
},
{
"id":5,
"time_begin":"09:00",
"time_end":"18:00"
},
{
"id":3,
"time_begin":"14:00",
"time_end":"18:00"
},
{
"id":4,
"time_begin":"18:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-31T00:00:00+04:00",
"interval":[
{
"id":2,
"time_begin":"09:00",
"time_end":"14:00"
},
{
"id":5,
"time_begin":"09:00",
"time_end":"18:00"
},
{
"id":3,
"time_begin":"14:00",
"time_end":"18:00"
},
{
"id":4,
"time_begin":"18:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-04-01T00:00:00+04:00",
"interval":[
{
"id":2,
"time_begin":"09:00",
"time_end":"14:00"
},
{
"id":5,
"time_begin":"09:00",
"time_end":"18:00"
},
{
"id":3,
"time_begin":"14:00",
"time_end":"18:00"
},
{
"id":4,
"time_begin":"18:00",
"time_end":"21:00"
}
]
}
],
"products":[
],
"services":{
}
},
"self":{
"name":"самовывоз",
"slug":"self",
"mode_id":3,
"delivery_type_id":3,
"delivery_id":3,
"type":"self",
"price":"0",
"date_default":"2012-03-23T19:08:36+04:00",
"date_list":[
{
"date":"2012-03-23T00:00:00+04:00",
"interval":[
{
"id":21,
"time_begin":"10:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-24T00:00:00+04:00",
"interval":[
{
"id":21,
"time_begin":"10:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-25T00:00:00+04:00",
"interval":[
{
"id":21,
"time_begin":"10:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-26T00:00:00+04:00",
"interval":[
{
"id":21,
"time_begin":"10:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-27T00:00:00+04:00",
"interval":[
{
"id":21,
"time_begin":"10:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-28T00:00:00+04:00",
"interval":[
{
"id":21,
"time_begin":"10:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-29T00:00:00+04:00",
"interval":[
{
"id":21,
"time_begin":"10:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-30T00:00:00+04:00",
"interval":[
{
"id":21,
"time_begin":"10:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-31T00:00:00+04:00",
"interval":[
{
"id":21,
"time_begin":"10:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-04-01T00:00:00+04:00",
"interval":[
{
"id":21,
"time_begin":"10:00",
"time_end":"21:00"
}
]
}
],
"shops":[
{
"id":2,
"name":"ENTER - Москва, ул. Орджоникидзе, д. 11",
"working_time":"с 9.00 до 21.00",
"address":"Орджоникидзе, д. 11, стр. 10",
"coord_long":"37.596997",
"coord_lat":"55.706488",
"products":{
},
"services":{
}
}
]
},
"standart_delayed":{
"name":"стандарт",
"slug":"standart_delayed",
"mode_id":1,
"delivery_type_id":11,
"delivery_id":1,
"type":"delivery",
"price":270,
"date_default":"2012-03-23T19:08:36+04:00",
"date_list":[
{
"date":"2012-03-23T00:00:00+04:00",
"interval":[
{
"id":2,
"time_begin":"09:00",
"time_end":"14:00"
},
{
"id":5,
"time_begin":"09:00",
"time_end":"18:00"
},
{
"id":3,
"time_begin":"14:00",
"time_end":"18:00"
},
{
"id":4,
"time_begin":"18:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-24T00:00:00+04:00",
"interval":[
{
"id":2,
"time_begin":"09:00",
"time_end":"14:00"
},
{
"id":5,
"time_begin":"09:00",
"time_end":"18:00"
},
{
"id":3,
"time_begin":"14:00",
"time_end":"18:00"
},
{
"id":4,
"time_begin":"18:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-25T00:00:00+04:00",
"interval":[
{
"id":2,
"time_begin":"09:00",
"time_end":"14:00"
},
{
"id":5,
"time_begin":"09:00",
"time_end":"18:00"
},
{
"id":3,
"time_begin":"14:00",
"time_end":"18:00"
},
{
"id":4,
"time_begin":"18:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-26T00:00:00+04:00",
"interval":[
{
"id":2,
"time_begin":"09:00",
"time_end":"14:00"
},
{
"id":5,
"time_begin":"09:00",
"time_end":"18:00"
},
{
"id":3,
"time_begin":"14:00",
"time_end":"18:00"
},
{
"id":4,
"time_begin":"18:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-27T00:00:00+04:00",
"interval":[
{
"id":2,
"time_begin":"09:00",
"time_end":"14:00"
},
{
"id":5,
"time_begin":"09:00",
"time_end":"18:00"
},
{
"id":3,
"time_begin":"14:00",
"time_end":"18:00"
},
{
"id":4,
"time_begin":"18:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-28T00:00:00+04:00",
"interval":[
{
"id":2,
"time_begin":"09:00",
"time_end":"14:00"
},
{
"id":5,
"time_begin":"09:00",
"time_end":"18:00"
},
{
"id":3,
"time_begin":"14:00",
"time_end":"18:00"
},
{
"id":4,
"time_begin":"18:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-29T00:00:00+04:00",
"interval":[
{
"id":2,
"time_begin":"09:00",
"time_end":"14:00"
},
{
"id":5,
"time_begin":"09:00",
"time_end":"18:00"
},
{
"id":3,
"time_begin":"14:00",
"time_end":"18:00"
},
{
"id":4,
"time_begin":"18:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-30T00:00:00+04:00",
"interval":[
{
"id":2,
"time_begin":"09:00",
"time_end":"14:00"
},
{
"id":5,
"time_begin":"09:00",
"time_end":"18:00"
},
{
"id":3,
"time_begin":"14:00",
"time_end":"18:00"
},
{
"id":4,
"time_begin":"18:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-03-31T00:00:00+04:00",
"interval":[
{
"id":2,
"time_begin":"09:00",
"time_end":"14:00"
},
{
"id":5,
"time_begin":"09:00",
"time_end":"18:00"
},
{
"id":3,
"time_begin":"14:00",
"time_end":"18:00"
},
{
"id":4,
"time_begin":"18:00",
"time_end":"21:00"
}
]
},
{
"date":"2012-04-01T00:00:00+04:00",
"interval":[
{
"id":2,
"time_begin":"09:00",
"time_end":"14:00"
},
{
"id":5,
"time_begin":"09:00",
"time_end":"18:00"
},
{
"id":3,
"time_begin":"14:00",
"time_end":"18:00"
},
{
"id":4,
"time_begin":"18:00",
"time_end":"21:00"
}
]
}
],
"products":{
},
"services":{
}
}
}
// zitata exists for case when only unavailable is recieved

	var orderModel = { Rapid: {}, Delay: {}, Selfy: {} }
	/* Sync Model */
	
	function getDateDM( datestring ) {
		var dd = new Date( datestring )
		var monthA = ['января', 'февраля', 'марта', 'апреля', 'мая', 'июня', 'июля', 'августа', 
		'сентября', 'октября', 'ноября', 'декабря']
		return dd.getDate() + ' ' + monthA[ dd.getMonth() ]
	}
	
	function getDateHTML( datestring ) {
		var dd = new Date( datestring )
		var weekdays = ['Вс','Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб']
		return dd.getDate() + ' <span>' + weekdays[ dd.getDay() ] + '</span>'
	}	
	
	function getTimeFT( timeobj ) {
		var time_begin = timeobj.time_begin
		if( time_begin[0] == '0' )
			time_begin = time_begin.slice(1)
		return 'с ' + time_begin + ' до ' + timeobj.time_end
	}
	
	function fillSIPartly( sw, act, datestring ) {
		var item = {}
		item.sw       = sw
		item.state    = act
		item.dv       = getDateDM( datestring )
		item.dhtml    = getDateHTML( datestring )
		item.ISO      = datestring
		item.schedule = []
		return item
	}	
	

	var ServerModel =  $('#delivery-map').data('value')
//console.info( ServerModel )
	function syncBlock( _sender, _receiver ) {
	
		_receiver.addCost  = _sender.price*1
		_receiver.dlvrDate = getDateDM( _sender.date_default )
		_receiver.ISODate  = _sender.date_default
		_receiver.dlvrTime = getTimeFT( _sender.date_list[0].interval[0] )
		_receiver.dlvrID   = _sender.date_list[0].interval[0].id
		_receiver.vcalend  = []
		var defaultDate = new Date( _sender.date_list[0].date )
		var lost = defaultDate.getDay()
		if( lost === 0 ) // voskresenie
			lost = 6
		else	
			lost --
		defaultDate.setDate( defaultDate.getDate() - lost )
	
		for(var i=0; i < lost; i++) {
			var scheduleItem = fillSIPartly( 0, 'dis', defaultDate.getTime() )
			_receiver.vcalend.push( scheduleItem ) 
			
			defaultDate.setDate( defaultDate.getDate() + 1 )
			scheduleItem = {}
		}
		
		for(var i=0, l= _sender.date_list.length; (i < l) && (i < 14 - lost); i++) {
			var item = _sender.date_list[i]					
			var scheduleItem = fillSIPartly(  ( i < (7 - lost) ) ? 0 : 1 , 'act', item.date )
			for(var j=0, jl = item.interval.length; j < jl; j++) {
				var intervalItem = {}
				intervalItem.id  = item.interval[j].id
				intervalItem.txt = getTimeFT( item.interval[j] )
				scheduleItem.schedule.push( intervalItem )
				intervalItem  = {}
			}

			_receiver.vcalend.push( scheduleItem ) 
			scheduleItem = {}
			item = {}
		}
	} // syncBlock function
	
	function syncProducts( _sender, _receiver ) {
		_receiver.products = []
		function grabItems( banka, is_service ) {
			for(var i=0, l = banka.length; i<l; i++) {
				var item = banka[i]
				var productItem = {}
				productItem.is_service = is_service
				productItem.id         = item.id
				productItem.title      = item.name
				productItem.moveable   = item.moveable			
				productItem.price      = ( item.price * 1 > 0 ) ? printPrice( item.price ) : '1'
				productItem.hm         = item.quantity*1
				productItem.locs       = item.moveto_shop
				productItem.img        = ( item.media_image !== null ) ? item.media_image : '/images/f1_footer_logo.png'
				productItem.dlvr       = []
				
				for(var j = 0, jl=item.moveto_mode.length; j<jl; j++) {
					switch( item.moveto_mode[j] ) {
						case 'self':
							productItem.dlvr.push( { txt: 'В самовывоз', lbl: 'selfy'} )
							break
						case 'standart_delay':
							productItem.dlvr.push( { txt: 'В доставку', lbl: 'delay'} )
							break					
						case 'standart_rapid':
							productItem.dlvr.push( { txt: 'В доставку', lbl: 'rapid'} )
							break					
					}
				}
				_receiver.products.push( productItem )
				item = {}
				productItem = {}
			}	
		}
		
		grabItems( _sender.products, false )
		if( 'services' in _sender )
			grabItems( _sender.services, true )		
	} // syncProducts function
	
	function syncShops( _sender, _receiver ) {
		_receiver.shops = []
		for(var i=0, l = _sender.shops.length; i<l; i++) {
			var item = _sender.shops[i]
			var shopItem = {}
			shopItem.shid     = item.id
			shopItem.title  = item.address
			shopItem.fromto  = item.working_time
			shopItem.latitude = item.coord_lat
			shopItem.longitude = item.coord_long
			shopItem.markerImg = ''			
			syncProducts( item, shopItem )
			
			_receiver.shops.push( shopItem )
			item = {}
			shopItem = {}
		}	
	}
	
	if( 'standart_rapid' in ServerModel ) {
		syncBlock( ServerModel.standart_rapid, orderModel.Rapid )
		syncProducts( ServerModel.standart_rapid, orderModel.Rapid )
	} else {
		syncBlock( zitata.standart_rapid, orderModel.Rapid )
		syncProducts( zitata.standart_rapid, orderModel.Rapid )		
	}
	
	if( 'standart_rapid' in ServerModel ) {
		syncBlock( ServerModel.standart_delayed, orderModel.Delay )
		syncProducts( ServerModel.standart_delayed, orderModel.Delay )
	} else {
		syncBlock( zitata.standart_delayed, orderModel.Delay )
		syncProducts( zitata.standart_delayed, orderModel.Delay )
	}
	
	if( 'standart_rapid' in ServerModel ) {
		syncBlock( ServerModel.self, orderModel.Selfy )
		syncShops( ServerModel.self, orderModel.Selfy )
	} else {
		syncBlock( zitata.self, orderModel.Selfy )
		syncShops( zitata.self, orderModel.Selfy )
	}
	
	/* ViewModel */
	function MyViewModel() {
		var self = this
		
		self.RequestError = ko.observable( false )
		self.errorText = ko.observable( '' )
		self.noSuchItemError = ko.observable( false )
		self.urlaftererror = ko.observable( '/' )
		self.appIsLoaded = ko.observable( false )
		self.stolenItems = ko.observableArray( [] )
		
		function customCal( papaSelector, cd, cdf, dd, ct, ctid, sch ) {
			var me = this
			me.papa = papaSelector
			me.curDate  = ko.observable( cd )
			me.curDateF = cdf // formatted ISO
			me.dates    = dd 
			me.weeknum  = ko.observable( false )
			me.cWeek = function(d, e){
				if( ! $(e.currentTarget).hasClass('mDisabled') ) {
					me.weeknum(  ! me.weeknum() )
					//me.papa.find('.bBuyingDates li.jsdate').toggleClass('erased')
				}
			}
			me.pickDate = function( dateit, e ) {
				if( $(e.currentTarget).hasClass('bBuyingDates__eDisable') )
					return false
				me.curDate( dateit.dv )
				me.curDateF = dateit.ISO
				$(me.papa).find('.bBuyingDatePopup[ref="'+dateit.dv+'"]').css({'left': $(e.target).position().left }).show()
			}
			if( typeof(ct) !== 'undefined' ) {
				me.curTime   = ko.observable( ct )
				me.curTimeId = ctid
				if( typeof(sch) !== 'undefined' ) 
					me.schedule = ko.observableArray( sch )				
				me.pickTime = function( timeit, e ) {		
					me.curTime( timeit.txt )
					me.curTimeId = timeit.id
					$(e.currentTarget).parent().parent().hide()
				}
			}
		}

		self.addCost  = orderModel.Rapid.addCost
		self.bitems   = ko.observableArray( orderModel.Rapid.products )

		self.RapidCalend = new customCal( '.rapid', orderModel.Rapid.dlvrDate, orderModel.Rapid.ISODate, orderModel.Rapid.vcalend, 
					orderModel.Rapid.dlvrTime, orderModel.Rapid.dlvrID, orderModel.Rapid.schedule)

		self.addCost_D  = orderModel.Delay.addCost
		self.bitems_D   = ko.observableArray( orderModel.Delay.products )

		self.DelayCalend = new customCal( '.delay', orderModel.Delay.dlvrDate, orderModel.Delay.ISODate, orderModel.Delay.vcalend, 
					orderModel.Delay.dlvrTime, orderModel.Delay.dlvrID, orderModel.Delay.schedule)

		self.shops      = ko.observableArray( orderModel.Selfy.shops )

		self.SelfyCalend = new customCal( '.selfy', orderModel.Selfy.dlvrDate, orderModel.Selfy.ISODate, orderModel.Selfy.vcalend )
		
		for(var b=0, lb= self.bitems().length; b<lb; b++) {
			if( typeof( self.bitems()[b].dlvr ) !== 'undefined' )
			for(var d=0, ld= self.bitems()[b].dlvr.length; d<ld; d++){
				var tmpd = self.bitems()[b].dlvr[d]
				var vedro = self.bitems()[b].dlvr[d].lbl
				self.bitems()[b].dlvr[d].lbl = ko.observable( vedro )
				tmpd.txt = ko.computed( function(){
					switch( this.lbl() ) {
						case 'delay':
							return 'В доставку ' + self.DelayCalend.curDate()
						break
						case 'rapid':
							return 'В доставку ' + self.RapidCalend.curDate()
						break
						case 'selfy':
							return 'В самовывоз ' + self.SelfyCalend.curDate()
						break
					}
				}, tmpd)
			}	
		}	
		
		for(var s=0, l= self.shops().length; s<l; s++)
			self.shops()[s].products = ko.observableArray( orderModel.Selfy.shops[s].products )
			
		self.shifting = function( line, _sender, target, e ) {
			//$(e.currentTarget).parent().parent().find('.mBacket').trigger('click') // hack
			self.interfaceMove( _sender, line )
			switch( target.lbl() ) {
			case "delay":
				self.bitems_D.unshift( line )
			break
			case "rapid":
				self.bitems.unshift( line )
			break
			case "selfy":
ull:				for(var i=0, li=line.locs.length; i < li; i++) {
					for(var j=0, lj=self.shops().length; j < lj; j++) {
						if( line.locs[i] === self.shops()[j].shid ) {
							self.shops()[j].products.unshift( line )
							break ull //up level loop
						}	
					}
				}
			break
			}
			// change lbl is complicated, side-effect
			//var ind = line.dlvr.indexOf( target )
			//line.dlvr[ ind ].lbl ( _sender )
		}
		
		self.totalPrice = ko.computed(function() {
			var tp = 0
			for(var i=0; i<self.bitems().length; i++)
				tp += self.bitems()[i].price.replace(/\D/g,'')*1
			 if( tp > 0 )
			 	tp += self.addCost	
			return printPrice( tp )
		}, this)
		
		self.totalPrice_D = ko.computed(function() {
			var tp = 0
			for(var i=0; i<self.bitems_D().length; i++)
				tp += self.bitems_D()[i].price.replace(/\D/g,'')*1
			 if( tp > 0 )
			 	tp += self.addCost_D
			return printPrice( tp )
		}, this)

		self.totalPrice_S = ko.computed(function() {
			var tp = 0
			for(var i=0; i<self.shops().length; i++)
				for(var j=0; j<self.shops()[i].products().length; j++)
				tp += self.shops()[i].products()[j].price.replace(/\D/g,'')*1				
			return printPrice( tp )
		}, this)

		self.totalSum = ko.computed(function() {
			var tp = self.totalPrice().replace(/\D/g,'')*1 + self.totalPrice_D().replace(/\D/g,'')*1 + self.totalPrice_S().replace(/\D/g,'')*1
			return printPrice( tp )
		}, this)

		var deleteUrls = {}
		deleteUrls.products = $('#delete-urls').data('products')
		deleteUrls.services = $('#delete-urls').data('services')	

		var orderMove = function( item ) {
			var tmpUrls = ( item.is_service ) ? deleteUrls.services : deleteUrls.products
			if( item.id in tmpUrls ) {
				$.ajax({
					url: tmpUrls[item.id],
					success: function(data) {
//console.info(data)
					}
				})
			}			
		}
		
		self.interfaceMove = function( _sender, item ) {
			switch( _sender ) {
				case 'rapid':
					self.bitems.remove(item)
					if( self.totalPrice_D() == '0' && self.totalPrice() == '0' )
						toggleDlvr( 'fromshop' )
				break
				case 'delay':
					self.bitems_D.remove(item)
					if( self.totalPrice_D() == '0' && self.totalPrice() == '0' )
						toggleDlvr( 'fromshop' )
				break
				case 'selfy':
					for(var i=0, l=self.shops().length; i<l; i++) {
						self.shops()[i].products.remove(item)
					}
					if( self.totalPrice_S() == '0' )
						toggleDlvr( 'standart' )
				break
			}		
		}
		
		self.removeIt = function( _sender, item ) {	
			orderMove( item )
			self.interfaceMove( _sender, item )
		}
		
		/* RETIRED
		self.removeFromShop = function( shop, item ) { 
			var ind = self.shops.indexOf( shop )
			self.shops()[ind].products.remove(item)
			//if( !self.shops()[ind].products().length )
				//self.shops.remove( shop )
		}
		*/
		
		//self.allshops = orderModel.allshops

		self.showUnavailable = function( stolen, category_url ) {
			self.urlaftererror( category_url )
			self.noSuchItemError(true)
			var obsArray = []
stln:		for(var i=0, l=stolen.length; i<l; i++) {
				obsArray = self.bitems()
				for(var ind=0, le=obsArray.length; ind<le; ind++) {
					if( obsArray[ind].id == stolen[i].id ) {
						var tmp = obsArray[ind]
						self.stolenItems.push( tmp )
						self.bitems.remove( tmp )
						continue stln
					}
				}
				
				obsArray = self.bitems_D()
				for(var ind=0, le=obsArray.length; ind<le; ind++) {
					if( obsArray[ind].id == stolen[i].id ) {
						var tmp = obsArray[ind]
						self.stolenItems.push( tmp )
						self.bitems_D.remove( tmp )
						continue stln
					}
				}
				
				for(var j=0, lj=self.shops().length; j<lj; j++) {
					obsArray = self.shops()[j].products()
					for(var ind=0, le=obsArray.length; ind<le; ind++) {
						if( obsArray[ind].id == stolen[i].id ) {
							var tmp = obsArray[ind]
							self.stolenItems.push( tmp )
							self.shops()[j].products.remove( tmp )
							continue stln
						}
					}
				}
				
				var tmp = {}
				tmp.id    = stolen[i].id
				tmp.title = stolen[i].name
				tmp.price = printPrice( stolen[i].price )
				self.stolenItems.push( tmp )
			} // stln
			
		}
		
		self.productforPopup = ko.observable( {
			moveable: false, price: '9 900', 
			title: 'Сноуборд Salomon Salvatore Sanchez ', hm: '1', img: '/images/f1_footer_logo.png',
			locs: [ 20, 10 ] 
		} )
		
		self.popupWithShops = ko.observableArray([])
		
		var shop_sender = null
		var movingItem = null
		
		self.shiftingInShops = function( shop_receiver ) {
			if( typeof(shop_receiver) === 'object' )
				shop_receiver = shop_receiver.shid
			self.shops()[ self.shops.indexOf( shop_sender ) ].products.remove( movingItem )
			for(var i=0, l=self.shops().length; i<l; i++) {
				if( self.shops()[i].shid == shop_receiver ) {
					self.shops()[i].products.push( movingItem )
					break
				}	
			}
		}
		
		self.shiftAndClose = function( shop_receiver ) {
			window.regionMap.closeMap()
			self.shiftingInShops( shop_receiver )
		}
		
		self.fillPopupWithShops = function( shop, item ) {
			shop_sender = shop
			movingItem = item
			self.productforPopup(item)
			var double_popupWithShops = self.popupWithShops.slice(0)
			var doublelocs = item.locs.slice(0)
sloop:			for(var s=0, ls=double_popupWithShops.length; s<ls; s++) {
				for(var i=0, l=item.locs.length; i<l; i++) {
					var shid = item.locs[i]
					if( double_popupWithShops[s].shid == shid ) {
						doublelocs[i] = 0
						continue sloop
					}	
				}
				self.popupWithShops.remove( double_popupWithShops[s] )
			}
locsloop:		for(var i=0, l=doublelocs.length; i<l; i++) {
				if(  !doublelocs[i] ) continue
				var shopsHub = self.shops()
				for(var asi=0, asl=shopsHub.length; asi<asl; asi++) {
					if( shopsHub[asi].shid == doublelocs[i] ) {
						var shopitem = shopsHub[asi]
						shopitem.markerImg = ko.observable( )
						self.popupWithShops.push( shopsHub[asi] )
						continue locsloop
					}
				}
			}
			for(var i=0, l=self.popupWithShops().length; i<l; i++) {
				self.popupWithShops()[i].markerImg ( '/images/marker_'+(i+1)+'.png' )
			}
			double_popupWithShops = null
			doublelocs = null
		} // fillPopupWithShops
 
	}
	MVM = new MyViewModel() //global TODO local
	
	ko.applyBindings(MVM) // this way, Lukas!
	
	MVM.appIsLoaded(true)
	if( 'unavailable' in ServerModel )
		MVM.showUnavailable( ServerModel.unavailable.products, ServerModel.unavailable.category_url )

	
	/* JQUERY handlers */
	var agent = new brwsr()
	if( !agent.isTouch ) {
		$('body').delegate('.bImgButton', 'mouseenter', function() {
			var tipData = {cssl: '-64px', tiptext: 'tip'}
			if( $(this).hasClass('mMap') )
				tipData = {cssl: '-64px', tiptext: 'Выбрать другой магазин'}
			if( $(this).hasClass('mBacket') )
				tipData = {cssl: '-36px', tiptext: 'Удалить товар'}
			if( $(this).hasClass('mArrows') )
				tipData = {cssl: '-87px', tiptext: 'Поместить товар в другой заказ'}
			$(this).html( tmpl("tip_tmpl", tipData) )
		})
		
		$('body').delegate('.bImgButton', 'mouseleave', function() { 
			$(this).empty()		
		})
		
		$('body').delegate('.bButtonPopup', 'mouseleave', function() {
			$(this).hide()
		})
		
		$('body').delegate('.bBuyingDatePopup', 'mouseleave', function() {
			$(this).hide()
		})	
	} 
	
	$('body').delegate('.bButtonPopup__eTitle', 'click', function(e) { // TODO iOS
		$(this).hide()
	})
	
	$('body').delegate('.mArrows', 'click', function(e) {
		e.preventDefault()
		$(this).parent().find('.bButtonPopup').show()
		return false
	})		
	$('body').delegate('.mMap', 'click', function(e) {
		e.preventDefault()
		// TODO проверка загруженности карты
		var markersPull = {}
		var tmp = MVM.popupWithShops()
		for(var i=0, l = tmp.length; i<l; i++) {
			var key = tmp[i].shid + ''
			markersPull[ key ] = {
				id: tmp[i].shid,
				name: tmp[i].title,
				regtime: tmp[i].fromto,
				latitude: tmp[i].latitude,
				longitude: tmp[i].longitude,
				markerImg: tmp[i].markerImg()
			}
		}
		$('.mMapPopup').lightbox_me({
			centered: true,
			onLoad: function() {
				regionMap.showMarkers( markersPull )
			}
		})
		
	}) //.mMap click
	
	$('#tocontinue').click( function(e) {
		e.preventDefault()
		MVM.noSuchItemError(false)
	})
	
	function MapWithShops( center, infoWindowTemplate, DOMid ) {
		var self = this
		self.mapWS = null
		self.infoWindow = null
		self.positionC = null
		self.markers = []
		
		function create() {
			self.positionC = new google.maps.LatLng(center.latitude, center.longitude)			
			var options = {
			  zoom: 11,
			  center: self.positionC,
			  scrollwheel: false,
			  mapTypeId: google.maps.MapTypeId.ROADMAP,
			  mapTypeControlOptions: {
				style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
			  }
			}
		  self.mapWS = new google.maps.Map( document.getElementById( DOMid ), options )
		  self.infoWindow = new google.maps.InfoWindow({
			maxWidth: 400,
			disableAutoPan: false
		  })
		}

		this.showInfobox = function( marker ) {
			var item = self.markers[marker.id]
			marker.setVisible(false) // hides marker
			$.each( infoWindowTemplate.find('[data-name]'), function(i, el) {
				el.innerHTML = item[$(el).data('name')]
			})
			
			self.infoWindow.setContent( infoWindowTemplate.prop('innerHTML') )
			self.infoWindow.setPosition( marker.position )
			self.infoWindow.open( self.mapWS )
			google.maps.event.addListener( self.infoWindow, 'closeclick', function() { marker.setVisible(true) })
		}

		this.showMarkers = function( markers ) {
			$.each( self.markers, function(i, item) {
				 if( typeof( item.ref ) !== 'undefined' )
					item.ref.setMap(null)
			})
			self.markers = markers
			google.maps.event.trigger( self.mapWS, 'resize' )
			self.mapWS.setCenter( self.positionC )
			$.each( markers, function(i, item) {
				var marker = new google.maps.Marker({
				  position: new google.maps.LatLng(item.latitude, item.longitude),
				  map: self.mapWS,
				  title: item.name,
				  icon: item.markerImg,
				  id: item.id
				})
				google.maps.event.addListener(marker, 'click', function() { self.showInfobox(this) })
				self.markers[marker.id].ref = marker
			})
		}
		
		this.closeMap = function( markers ) {
			self.infoWindow.close()
			$('.mMapPopup').trigger('close') // close lightbox_me
		}
		
		/* main() */
		create()
		
	} // object MapWithShops

	window.regionMap = new MapWithShops( $('#map-center').data('content'),
									  $('#map-info_window-container'), 'mapPopup' )
	var mapContainer = $('#mapPopup')
	mapContainer.delegate('.shopchoose', 'click', function(e) { //desktops
		e.preventDefault()
		pickStore( e.target )
	})	
	function handleStart(e) {
		e.preventDefault()
		if( e.target.className.match('shopchoose') )
			pickStore( e.target )
	}
	mapContainer[0].addEventListener("touchstart", handleStart  , false) //touch devices
	
	function pickStore( node ) {
		MVM.shiftAndClose( $(node).parent().find('.shopnum').text() )
	}
	
	/* Other Form Handlers */
	function toggleDlvr( dlvrtitle ) {
		if( dlvrtitle === 'standart' ) {
			$('#addressField').show()
		}
		if( dlvrtitle === 'fromshop' ) {
			$('#addressField').hide()
		}
	} //toggleDlvr function
	
	$('body').delegate('.bBuyingLine label', 'click', function() {
		if( $(this).find('input').attr('type') == 'radio' ) {
			var thatName = $('.mChecked input[name="'+$(this).find('input').attr('name')+'"]')
			if( thatName.length ) {
				thatName.each( function(i, item) {
					$(item).parent('label').removeClass('mChecked')
				})
			}
			$(this).addClass('mChecked')
			return
		}
		
		if( $(this).find('input').attr('type') == 'checkbox' ) {
			$(this).toggleClass('mChecked')
		}
		
	})	

	$('body').delegate('.bBuyingLine input:radio, .bBuyingLine input:checkbox', 'click', function(e) {
		e.stopPropagation()
	})	
	
	/* Mail to Server */
	function syncClientServer() {
		ServerModel.standart_rapid.products   = MVM.bitems()
		ServerModel.standart_delayed.products = MVM.bitems_D()
		
		ServerModel.standart_rapid.date_default   = MVM.RapidCalend.curDateF
		ServerModel.standart_rapid.time_default   = MVM.RapidCalend.curTimeId
		ServerModel.standart_delayed.date_default = MVM.DelayCalend.curDateF
		ServerModel.standart_delayed.time_default = MVM.DelayCalend.curTimeId
		ServerModel.self.date_default             = MVM.SelfyCalend.curDateF
		
		for(var i=0, l = ServerModel.self.shops.length; i<l; i++) {
			ServerModel.self.shops[i].products = MVM.shops()[i].products().slice(0)
		}
	} // syncClientServer function
	
	var form = $('#order')
	var broken = 0
	
	function markError( field, mess ) {
		broken++
		$('body').delegate('input[name="'+field+'"]', 'change', function() {
			if( $(this).val().replace(/\s+/g,'') != '' ) {
				broken--
				$('input[name="'+field+'"]').removeClass('mRed')
				$('input[name="'+field+'"]').closest('.bBuyingLine').find('.bFormError').remove()
			}	
		})	
		var node = $('input[name="'+field+'"]:first') 
		if( node.hasClass('mRed') ) return
		switch( node.attr('type') ) {
			case 'text':
				node.addClass('mRed')
				node.after( '<span class="bFormError mb10 pt5">'+mess+'</span>' ) // AWARE: CUSTOM
			break	
			default: // radio, checkbox
				node.addClass('mRed')
				node.parent().parent().parent().append( '<span class="bFormError mb10 pt5">'+mess+'</span>' ) // AWARE: CUSTOM
			break
		}
	}
	
	function printErrors( error ) {
		if( 'token' in error ) {
			MVM.showUnavailable( error.details.products, error.details.category_url )
			return
		}
		switch( error.code ) {
			case 705:
				MVM.RequestError(true)
				MVM.errorText(error.message)
			break
			default:
				MVM.RequestError(true)
				MVM.errorText(error.message)
			break
		}
	}
	
	var sended = false
	$('.mConfirm a.bBigOrangeButton').click( function(e) {
		e.preventDefault()
		if( sended ) return
		
		
		var serArray = form.serializeArray()
		var fieldToValidate = $('#validator').data('value')
flds:	for( field in fieldToValidate ) {
			if( !form.find('[name="'+field+'"]:visible').length )
				continue
			for(var i=0, l=serArray.length; i<l; i++) {
				if( serArray[i].name == field ) {
					if( serArray[i].value == '' )
						markError( field, fieldToValidate[field] ) // cause is empty
					continue flds
				}
			}
			markError( field, fieldToValidate[field] ) // cause not in serArray
		}
		if( broken > 0 ) {
			$.scrollTo( '.mRed:first' , 500 )
			return
		}	
		
		sended = true
		$(this).html('Минутку...')
		syncClientServer()		
		var toSend = form.serializeArray()
		toSend.push( { name: 'products_hash', value: JSON.stringify( ServerModel )  } )//encodeURIComponent

		$.ajax({
			url: form.attr('action'),
			timeout: 20000,
			type: "POST",
			data: toSend,
			success: function( data ) {
				sended = false
				if( !data.success ) {
					printErrors( data.error )
					return
				}
				window.location = data.redirect
			}
		})
	})
});	