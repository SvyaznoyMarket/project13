$(document).ready(function(){if($("#rating").length){var e=$("#rating").next().html().replace(/\D/g,"");$("#rating span").remove();$("#rating").raty({start:e,showHalf:!0,path:"/css/skin/img/",readOnly:$("#rating").data("readonly"),starHalf:"star_h.png",starOn:"star_a.png",starOff:"star_p.png",hintList:["плохо","удовлетворительно","нормально","хорошо","отлично"],click:function(a){$.getJSON($("#rating").attr("data-url").replace("score",a),function(a){!0===a.success&&a.data.rating&&($.fn.raty.start(a.data.rating,
"#rating"),$("#rating").next().html(a.data.rating))});$.fn.raty.readOnly(!0,"#rating")}})}if($(".bCountSet").length){var g=$(".goodsbarbig .bCountSet"),q=g.parent().find(".link1"),u=q.attr("href"),r=$("a.order1click-link"),v=r.attr("href");g.data("hm",g.first().find("span").text().replace(/\D/g,""));g.bind("update",function(){var a=$(this).data("hm");g.find("span").text(a+"  шт.");q.attr("href",u+"/"+a);r.attr("href",v+"&quantity="+a)});$(".bCountSet__eP",g).click(function(){if($(this).hasClass("disabled"))return!1;
g.data("hm",1*g.data("hm")+1);g.trigger("update");return!1});$(".bCountSet__eM",g).click(function(){if($(this).hasClass("disabled")||1==g.data("hm"))return!1;g.data("hm",1*g.data("hm")-1);g.trigger("update");return!1})}$(".viewstock").bind("mouseover",function(){var a=$('#stock img[ref="'+$(this).attr("ref")+'"]'),c=a.attr("src"),d=a.attr("data-url");a[0].complete&&($("#goodsphoto img").attr("src",c),$("#goodsphoto img").attr("href",d))});e={makeLite:"#turnlite",makeFull:"#turnfull",loadbar:"#percents",
zoomer:"#bigpopup .scale",rollindex:".scrollbox div b",propriate:[".versioncontrol",".scrollbox"]};"undefined"!==typeof product_3d_small&&"undefined"!==typeof product_3d_big&&(lkmv=new likemovie("#photobox",e,product_3d_small,product_3d_big));if($("#bigpopup").length)var s=new mediaLib($("#bigpopup"));$(".viewme").click(function(){s&&s.show($(this).attr("ref"),$(this).attr("href"));return!1});var n=function(a){a=a.replace("сегодня","<b>сегодня</b>");return a=a.replace(" завтра"," <b>завтра</b>")},
t=function(a){return"undefined"===typeof a||null===a?"":0<a?", "+a+" руб.":", бесплатно."},i=$(".delivery-info");if(i.length){var o=i.prop("id").replace("product-id-","");$.post(i.data().calclink,{ids:[o]},function(a){if(a[o]){var a=a[o].deliveries,c="<h4>Как получить заказ?</h4><ul>",d,b;for(d in a)b=a[d],3==b.object.core_id&&(c+="<li><h5>Можно заказать сейчас и самостоятельно забрать в магазине "+n(b.text)+'</h5><div>&mdash; <a target="blank" href="'+i.data().shoplink+'">В каких магазинах ENTER можно забрать?</a></div></li>',
a.splice(d,1));if(0<a.length){c+="<li><h5>Можно заказать сейчас с доставкой</h5>";for(d in a)b=a[d],2==b.object.core_id&&(c+="<div>&mdash; Можем доставить "+n(b.text)+t(b.price)+"</div>",a.splice(d,1));for(d in a)b=a[d],1==b.object.core_id&&(c+="<div>&mdash; Можем доставить "+n(b.text)+t(b.price)+"</div>",a.splice(d,1));c+="</li>"}i.html(c+"</ul>")}},"json")}$(".bDropMenu").each(function(){var a=$(this).find("span:first"),c=$(this).find("div");a.css("display","block");a.width()+60<c.width()?a.width(c.width()-
70):c.width(a.width()+70)});$(".product_rating-form").live({"form.ajax-submit.prepare":function(){$(this).find("input:submit").attr("disabled",!0)},"form.ajax-submit.success":function(a,c){!0==c.success&&$(".product_rating-form").effect("highlight",{},2E3)}});$(".product_comment-form").live({"form.ajax-submit.prepare":function(){$(this).find("input:submit").attr("disabled",!0)},"form.ajax-submit.success":function(a,c){$(this).find("input:submit").attr("disabled",!1);!0==c.success&&($($(this).data("listTarget")).replaceWith(c.data.list),
$.scrollTo("."+c.data.element_id,500,{onAfter:function(){$("."+c.data.element_id).effect("highlight",{},2E3)}}))}});$(".product_comment_response-link").live({"content.update.prepare":function(){$(".product_comment_response-block").html("")},"content.update.success":function(){$(".product_comment_response-block").find("textarea:first").focus()}});if($(".order1click-link").length){console.info("MODEL: ",$(".order1click-link").data("model"));var l=$(".order1click-link").data("model");Deliveries={courier:{id:4,
name:"Доставка",price:400,dates:[{value:"10-02-2012",text:"10 февраля"},{value:"11-02-2012",text:"11 февраля"}]},self:{id:2,name:"Самовывоз",price:0,dates:[{value:"08-02-2012",shopIds:[2,3],text:"8 февраля"},{value:"09-02-2012",shopIds:[2],text:"9 февраля"}],shops:[{id:2,name:"г. Москва, м. Ленинский проспект, магазин  на ул. Орджоникидзе, д. 11, стр. 10",regtime:"с 9.00 до 21.00",address:"м. Ленинский проспект, ул. Орджоникидзе, д. 11, стр. 10",addressTxt:"м. Ленинский проспект, ул. Орджоникидзе, д. 11...",
latitude:"55.706488",longitude:"37.596997"},{id:3,name:"г. Москва, м. Киевская, магазин на ул. Б. Дорогомиловская, д. 8",regtime:"с 9.00 до 22.00",address:"м. Киевская, ул. Б. Дорогомиловская, д. 8",addressTxt:"м. Киевская, ул. Б. Дорогомиловская, д. 8",latitude:"55.746197",longitude:"37.565389"}]}};console.info("Deliveries: ",Deliveries);for(var p=e=0,m=0,w=Deliveries.self.shops.length;m<w;m++)e+=1*Deliveries.self.shops[m].latitude,p+=1*Deliveries.self.shops[m].longitude;e={latitude:e/Deliveries.self.shops.length,
longitude:p/Deliveries.self.shops.length};MVM=new function(){var a=this;a.title=l.jstitle;a.price=l.jsprice;a.icon=l.jsbimg;a.shortcut=l.jsshortcut;a.quantity=ko.observable(1);a.quantityTxt=ko.computed(function(){return a.quantity()+" шт."},this);a.priceTxt=ko.computed(function(){return printPrice(a.price)},this);a.chosenDlvr=ko.observable({});a.dlvrs=[];for(var c in Deliveries)a.dlvrs.push({type:c,name:Deliveries[c].name}),"self"==c&&a.chosenDlvr(a.dlvrs[a.dlvrs.length-1]);a.total=ko.computed(function(){return printPrice(a.price*
a.quantity()+1*Deliveries[a.chosenDlvr().type].price)},this);a.changeDlvr=function(d){a.chosenDlvr(d);a.dates.removeAll();for(var b=0;b<Deliveries[d.type].dates.length;b++)a.dates.push(Deliveries[d.type].dates[b]);a.chosenDate(a.dates()[0])};a.plusItem=function(){a.quantity(a.quantity()+1);return!1};a.minusItem=function(){1<a.quantity()&&a.quantity(a.quantity()-1);return!1};a.dates=ko.observableArray(Deliveries.self.dates.slice(0));a.chosenDate=ko.observable(a.dates()[0]);a.pickDate=function(d){a.chosenDate(d);
if("shopIds"in d&&0<d.shopIds.length){a.shops.removeAll();for(var b in Deliveries.self.shops)console.info(Deliveries.self.shops[b],d.shopIds.indexOf(Deliveries.self.shops[b].id)),-1!==d.shopIds.indexOf(Deliveries.self.shops[b].id)&&a.shops.push(Deliveries.self.shops[b])}a.showMarkers()};a.shops=ko.observableArray(Deliveries.self.shops.slice(0));a.chosenShop=ko.observable(a.shops()[0]);a.pickedShop=ko.observable(a.shops()[0]);a.pickShop=function(d){a.chosenShop(d)};a.pickShopOnMap=function(d){for(var b=
0,c=a.shops().length;b<c;b++)if(a.shops()[b].id==d){a.pickedShop(a.shops()[b]);break}};a.showMap=ko.observable(!1);a.toggleMap=function(){a.showMap()?$("#mapPopup").hide("blind",null,800,function(){a.showMap(!1)}):(a.showMap(!0),$("#mapPopup").show("blind",null,1E3));a.showMap()&&a.showMarkers()};a.showMarkers=function(){for(var d={},b=a.shops(),c=0,f=b.length;c<f;c++)d[b[c].id+""]={id:b[c].id,name:b[c].address,regtime:b[c].regtime,latitude:b[c].latitude,longitude:b[c].longitude};regionMap.showMarkers(d)};
a.formStatus=ko.observable("typing");a.formStatusTxt=ko.computed(function(){var c="";switch(a.formStatus()){case "typing":c="Отправить заказ";break;case "process":c="Проверка...";break;case "error":c="Произошла ошибка!";break;case "sending":c="Отправка..."}return c},this);a.textfields=[];a.textfields.push(ko.observable({title:"Имя получателя",name:"fio",value:"Иван",valerror:!1,regexp:/^[a-zа-я\s]+$/i}));a.textfields.push(ko.observable({title:"Телефон для связи",name:"phone",value:"",valerror:!1,
regexp:/^[0-9\-\+\s]+$/}));a.validateField=function(c,b){var h=!1;if(""==b.currentTarget.value.replace(/\s/g,"")||!c.regexp.test(b.currentTarget.value))h=!0,a.formStatus("typing");for(var f=0,j=a.textfields.length;f<j;f++)if(a.textfields[f]().name===c.name){j=a.textfields[f]();j.valerror=h;j.value=b.currentTarget.value;a.textfields[f](j);break}};a.validateForm=function(){"typing"===a.formStatus()&&(a.formStatus("process"),$("#oneClick input").trigger("change"),"typing"!==a.formStatus()&&setTimeout(function(){a.formStatus("sending")},
500))}};ko.applyBindings(MVM);window.regionMap=new function(a,c,d){var b=this;b.mapWS=null;b.infoWindow=null;b.positionC=null;b.markers=[];this.showInfobox=function(a){MVM.pickShopOnMap(a.id);a.setVisible(!1);b.infoWindow.setContent(c.prop("innerHTML"));b.infoWindow.setPosition(a.position);b.infoWindow.open(b.mapWS);google.maps.event.addListener(b.infoWindow,"closeclick",function(){a.setVisible(!0)})};this.showMarkers=function(a){$.each(b.markers,function(a,b){"undefined"!==typeof b.ref&&b.ref.setMap(null)});
b.markers=a;google.maps.event.trigger(b.mapWS,"resize");b.mapWS.setCenter(b.positionC);$.each(a,function(a,c){var d=new google.maps.Marker({position:new google.maps.LatLng(c.latitude,c.longitude),map:b.mapWS,title:c.name,icon:"/images/marker.png",id:c.id});google.maps.event.addListener(d,"click",function(){b.showInfobox(this)});b.markers[d.id].ref=d})};this.closeMap=function(){b.infoWindow.close();$("#mapPopup").hide("blind",null,800,function(){MVM.showMap(!1)})};(function(){b.positionC=new google.maps.LatLng(a.latitude,
a.longitude);var c={zoom:11,center:b.positionC,scrollwheel:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}};b.mapWS=new google.maps.Map(document.getElementById(d),c);b.infoWindow=new google.maps.InfoWindow({maxWidth:400,disableAutoPan:!1})})()}(e,$("#map-info_window-container"),"mapPopup");e=$("#mapPopup");e.delegate(".shopchoose","click",function(a){a.preventDefault();k(a.target)});e[0].addEventListener("touchstart",function(a){a.preventDefault();
a.target.className.match("shopchoose")&&k(a.target)},!1);var k=function(a){a=$(a).parent().find(".shopnum").text();window.regionMap.closeMap();for(var c=0,d=MVM.shops().length;c<d;c++)MVM.shops()[c].id==a&&MVM.chosenShop(MVM.shops()[c])};$("#order1click-container").delegate(".bSelect","click",function(){$(this).find(".bSelect__eDropmenu").toggle()});$(".order1click-link").bind("click",function(a){a.preventDefault();"undefined"!==typeof _gaq&&_gaq.push(["_trackEvent","QuickOrder","Open"]);$("#order1click-container").lightbox_me({centered:!0,
onClose:function(){MVM.showMap(!1)}})})}$("#gMap").length&&($("#gMap").bind({create:function(a,c,d,b){var h=$(this),a={zoom:11,center:new google.maps.LatLng(c.latitude,c.longitude),scrollwheel:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}},f=new google.maps.Map(document.getElementById(h.attr("id")),a),a=new InfoBox({disableAutoPan:!1,maxWidth:0,pixelOffset:new google.maps.Size(-11,-108),zIndex:null,boxStyle:{opacity:0.85,width:"280px"},
closeBoxURL:"http://www.google.com/intl/en_us/mapfiles/close.gif",infoBoxClearance:new google.maps.Size(1,1),isHidden:!1,pane:"floatShadow",enableEventPropagation:!0}),e=function(){var a=d[this.id];h.trigger("showMarkers");h.trigger("infoWindow",[this,a])};h.data("markers",[]);$.each(d,function(a,b){var c=new google.maps.Marker({position:new google.maps.LatLng(b.latitude,b.longitude),map:f,title:b.name,icon:"/images/marker.png",id:b.id});google.maps.event.addListener(c,"click",e);h.data("markers").push(c)});
google.maps.event.addListener(f,"bounds_changed",function(){});google.maps.event.addListener(f,"click",function(){});google.maps.event.addListener(a,"closeclick",function(){h.trigger("showMarkers")});h.data("map",f);h.data("infoWindow",a);h.data("infoWindowTemplate",b)},move:function(){$(this).data("map")},infoWindow:function(a,c,d){var b=$(this),a=b.data("map"),e=b.data("infoWindow"),b=b.data("infoWindowTemplate");c.setMap(null);$.each(b.find("[data-name]"),function(a,b){b.innerHTML=d[$(b).data("name")]});
e.setContent(b.prop("innerHTML"));e.open(a,c)},showMarkers:function(){var a=$(this);$.each(a.data("markers"),function(c,d){null==d.map&&d.setMap(a.data("map"))})}}),e=$("#gMap"),e.trigger("create",[$("#map-center").data("content"),$("#map-markers").data("content"),$("#map-info_window-container")]),e.delegate(".shopchoose","click",function(a){k(a.target)}),e[0].addEventListener("touchstart",function(a){a.target.className.match("shopchoose")&&k(a.target)},!1),k=function(a){getOneClick($(a).parent().find(".shopnum").text())},
$(".bInShopLine__eButton a").bind("click",function(a){a.preventDefault();getOneClick($(this).attr("href"))}),$(".bInShop__eCurrent a").click(function(){$.getJSON("/region/init",function(a){if(!a.success)return!1;var a=a.data,c=$("<div>").addClass("graying").css({opacity:"0.5"}),d=$('<div class="bCityPopupWrap">').html('<div class="hideblock bCityPopup"><i title="Закрыть" class="close">Закрыть</i><div class="title">Привет! Из какого вы города?</div></div></div>');d.find(".close").click(function(){$(".graying").remove();
$(".bCityPopupWrap").hide()});for(var b=0,e=a.length;b<e;b++)if(!("undefined"===typeof a[b].link||"undefined"===typeof a[b].name)){var f=$("<div>").append($("<a>").attr("href",a[b].link).text(a[b].name));"undefined"!==typeof a[b].is_active?(f.addClass("bCityPopup__eCurrent"),d.find(".title").after(f)):(f.addClass("bCityPopup__eBlock"),d.find("div:first").append(f))}$("body").append(c).append(d)});return!1}))});
