$(document).ready(function(){function f(){for(var a=0,c=0;a<d.length;a++)!d[a].noview&&$.contains(document.body,d[a].hasnodes[0])&&(c+=1*d[a].sum);c||location.reload(!0);j.html(printPrice(c));j.typewriter(800);h=c}function k(a,c){var b=this;this.hasnodes=$(a.drop);$(a.less).data("run",!1);$(a.more).data("run",!1);var g=$(a.line);this.id=g.attr("ref");var d=$(a.less).parent().attr("href"),l=$(a.more).parent().attr("href");"#"===d&&(d=$(a.less).parent().attr("ref"));"undefined"===typeof d&&(d=l+"/-1");
var e=$(a.drop).attr("href");this.sum=$(a.sum).html().replace(/\s/,"");this.quantum=1*$(a.quan).html().replace(/\D/g,"");var i=(1*(1*b.sum/b.quantum)).toFixed(2);"price"in a&&(i=$(a.price).html().replace(/\s/,""));this.price=i;this.noview=!1;h+=1*this.sum;this.calculate=function(c){b.quantum=c;b.sum=i*c;$(a.sum).html(printPrice(b.sum));$(a.sum).typewriter(800,f)};this.clear=function(){g.remove();b.noview=!0;PubSub.publish("quantityChange",{q:0,id:b.id});c&&c();$.getJSON(e,function(b){$(a.drop).data("run",
!1);b.success?f():location.href=location.href})};this.update=function(c,g){var e=0<g?l:d;b.quantum+=g;$(a.quan).html(b.quantum+" шт.");b.calculate(b.quantum);h+=b.price*g;PubSub.publish("quantityChange",{q:b.quantum,id:b.id});if($("#selectCredit").length)var f="",f=1*$("#selectCredit").val()?"/1":"/0",e=e+f;$.getJSON(e,function(a){$(c).data("run",!1);if(!a.success)location.href=location.href})};$(a.drop).click(function(){$(a.drop).data("run")||($(a.drop).data("run",!0),b.clear());return!1});$(a.less).click(function(){$(this).data("run")||
($(this).data("run",!0),1<b.quantum?b.update(this,-1):b.clear());return!1});$(a.more).click(function(){$(this).data("run")||($(this).data("run",!0),b.update(this,1));return!1})}function m(a,c){var b=new k({line:a,less:a.find(".ajaless"),more:a.find(".ajamore"),quan:a.find(".ajaquant"),sum:a.find(".price"),drop:a.find(".whitelink")},function(){for(var a=$("td.bF1Block_eBuy",c),b=$("div.bBacketServ.mBig",c),d=0,e=$(a).length;d<e;d++)$("tr[ref="+$(a[d]).attr("ref")+"]",b).length||$(a[d]).find("input").val("Купить услугу").removeClass("active");
$("div.bBacketServ.mBig .ajaquant",c).length||($("div.bBacketServ.mBig",c).hide(),$("div.bBacketServ.mSmall",c).show())});d.push(b)}function q(a,c){$("div.bBacketServ.mSmall",a).hide();$("div.bBacketServ.mBig",a).show();var b=$("div.bBacketServ.mBig tr:first",a),g=tmpl("f1cartline",c),g=g.replace(/F1ID/g,c.fid).replace(/PRID/g,a.attr("ref"));b.after(g);m($("div.bBacketServ.mBig tr:eq(1)",a));f()}var j=$("#total .price"),h=0,d=[];$(".basketline").each(function(){var a=$(this),c=new k({line:a,less:a.find(".ajaless:first"),
more:a.find(".ajamore:first"),quan:a.find(".ajaquant:first"),price:a.find(".basketinfo .price:first"),sum:a.find(".basketinfo .sum:first"),drop:a.find(".basketinfo .whitelink:first")});d.push(c);$("div.bBacketServ.mBig",a).length&&$("div.bBacketServ.mBig tr",a).each(function(){$(".ajaquant",$(this)).length&&m($(this),a)});a.find("a.link1").click(function(){var b=$("div.bF1Block",a);b.show().find(".close").click(function(){b.hide()});b.find("input.button").click(function(){if($(this).hasClass("active"))return!1;
$(this).val("В корзине").addClass("active");var c=$(this).data();$.getJSON(c.url,function(){});q(a,c);b.hide()});return!1})});if($("#selectCredit").length){var n=$("#creditSum").data("minsum");if(n)var o=function(){$("#creditSum").toggle();$("#commonSum").toggle()};var e=function(){$("#selectCredit:checked").length&&o()},p=function(){h>=n?$("#creditFlag").is(":hidden")&&($("#creditFlag").show(),e()):$("#creditFlag").is(":visible")&&($("#creditFlag").hide(),e())};p();PubSub.subscribe("quantityChange",
p);e();$("label.bigcheck").click(function(a){$(a.target).is("input")&&($(this).toggleClass("checked"),o())});DirectCredit={basketPull:[],init:function(){for(var a=0,c=d.length;a<c;a++)this.basketPull.push({id:d[a].id,price:d[a].price,count:d[a].quantum,type:"another"});this.sendCredit()},change:function(a,c){self=DirectCredit;if(0<c.q)self.findProduct(self.basketPull,c.id).count=c.q;else{var b=self.findProductKey(self.basketPull,c.id);self.basketPull.splice(b,1)}self.sendCredit()},findProduct:function(a,
c){for(var b=0,d=a.length;b<d;b++)if(a[b].id==c)return a[b];return-1},findProductKey:function(a,c){for(var b=0,d=a.length;b<d;b++)if(a[b].id==c)return b;return-1},sendCredit:function(){var a=this;dc_getCreditForTheProduct("4427","none","getPayment",{products:a.basketPull},function(c){for(var b=0,d=0,e=a.basketPull.length;d<e;d++){var f=a.findProduct(a.basketPull,c.products[d].id);f&&(b+=c.products[d].initial_instalment*f.price/100*f.count)}$("#creditPrice").text(printPrice(b))})}};DirectCredit.init();
PubSub.subscribe("quantityChange",DirectCredit.change)}});
