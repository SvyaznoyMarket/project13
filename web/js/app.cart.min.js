$(document).ready(function(){function n(){for(var n=0,r=0;n<i.length;n++)!i[n].noview&&$.contains(document.body,i[n].hasnodes[0])&&(r+=i[n].sum*1);r||location.reload(!0),e.html(printPrice(r)),e.typewriter(800),t=r}function r(e,r){var i=this;this.hasnodes=$(e.drop),$(e.less).data("run",!1),$(e.more).data("run",!1);var s=$(e.line);this.id=s.attr("ref");var o=$(e.more).parent().attr("href"),u=$(e.drop).attr("href");this.sum=$(e.sum).html().replace(/\s/,"");var a=e.limit;this.quantum=$(e.quan).html().replace(/\D/g,"")*1;var f=(i.sum*1/i.quantum*1).toFixed(2);"price"in e&&(f=$(e.price).html().replace(/\s/,"")),this.price=f,this.noview=!1;var l=!1;t+=this.sum*1;var c=null;this.calculate=function(t){clearTimeout(c),i.quantum=t,i.sum=f*t,$(e.sum).html(printPrice(i.sum)),$(e.sum).typewriter(800,n),c=setTimeout(function(){n(),1e3})},this.clear=function(){s.remove(),i.noview=!0,PubSub.publish("quantityChange",{q:0,id:i.id}),r&&r(),$.getJSON(u,function(t){$(e.drop).data("run",!1),t.success?n():location.href=location.href})},this.update=function(n,r){if(r>0&&a<i.quantum+r){$(n).data("run",!1);return}var s=o;i.quantum+=r,s+=i.quantum,$(e.quan).html(i.quantum+" шт."),i.calculate(i.quantum),t+=i.price*r,PubSub.publish("quantityChange",{q:i.quantum,id:i.id}),$.getJSON(s,function(e){$(n).data("run",!1),e.success||(location.href=location.href)})},$(e.drop).click(function(){return $(e.drop).data("run")||($(e.drop).data("run",!0),l=i.clear()),!1}),$(e.less).click(function(){var e=this;return $(e).data("run")||($(e).data("run",!0),i.quantum>1?i.update(e,-1):i.clear()),!1}),$(e.more).click(function(){var e=this;return $(e).data("run")||($(e).data("run",!0),i.update(e,1)),!1})}function s(e,t){function n(){var e=$("td.bF1Block_eBuy",t),n=$("div.bBacketServ.mBig",t);for(var r=0,i=$(e).length;r<i;r++)$("tr[ref="+$(e[r]).attr("ref")+"]",n).length||$(e[r]).find("input").val("Купить услугу").removeClass("active");$("div.bBacketServ.mBig .ajaquant",t).length||($("div.bBacketServ.mBig",t).hide(),$("div.bBacketServ.mSmall",t).show())}var s=new r({line:e,less:e.find(".ajaless"),more:e.find(".ajamore"),quan:e.find(".ajaquant"),sum:e.find(".price"),drop:e.find(".whitelink")},n);i.push(s)}function o(e,t){$("div.bBacketServ.mSmall",e).hide(),$("div.bBacketServ.mBig",e).show();var r=$("div.bBacketServ.mBig tr:first",e),i=tmpl("f1cartline",t);i=i.replace(/F1ID/g,t.fid).replace(/F1TOKEN/g,t.f1token).replace(/PRID/g,e.attr("ref")),r.after(i),s($("div.bBacketServ.mBig tr:eq(1)",e)),n()}var e=$("#total .price"),t=0,i=[];$(".basketline").each(function(){var e=$(this),t=new r({line:e,less:e.find(".ajaless:first"),more:e.find(".ajamore:first"),quan:e.find(".ajaquant:first"),price:e.find(".basketinfo .price:first"),sum:e.find(".basketinfo .sum:first"),drop:e.find(".basketinfo .whitelink:first"),limit:e.find(".numerbox").data("limit")});i.push(t),$("div.bBacketServ.mBig",e).length&&$("div.bBacketServ.mBig tr",e).each(function(){$(".ajaquant",$(this)).length&&s($(this),e)}),e.find("a.link1").click(function(){var t=$("div.bF1Block",e);return t.show().find(".close").click(function(){t.hide()}),t.find("input.button").click(function(){if($(this).hasClass("active"))return!1;$(this).val("В корзине").addClass("active");var n=$(this).data();$.getJSON(n.url,function(e){}),o(e,n),t.hide()}),!1})});if($("#selectCredit").length){var u=$("#creditSum").data("minsum");if(u)function a(){$("#creditSum").toggle(),$("#commonSum").toggle()}function f(){$("#selectCredit:checked").length&&a()}function l(){$("#blockFromCreditAgent").fadeOut("slow"),t>=u?$("#creditFlag").is(":hidden")&&($("#creditFlag").show(),f()):$("#creditFlag").is(":visible")&&($("#creditFlag").hide(),f())}function c(e){if(!docCookies.hasItem(e)){docCookies.setItem(!1,e,1,3600,"/");return}var t=docCookies.getItem(e);docCookies.setItem(!1,e,Math.abs(t-1),3600,"/")}l(),PubSub.subscribe("quantityChange",l),PubSub.subscribe("bankAnswered",function(){$("#blockFromCreditAgent").fadeIn("slow")}),$("label.bigcheck").click(function(e){var t=$(e.target);if(!t.is("input"))return;$(this).toggleClass("checked"),a(),c("credit_on")}),DirectCredit.init($("#tsCreditCart").data("value"),$("#creditPrice")),PubSub.subscribe("quantityChange",DirectCredit.change)}});