$(document).ready(function(){function a(){warr=$(".bBacketServ.extWarr.mBig"),$.each(warr,function(){service=$(this);if(service.find("tr[ref]").length)return!0;if(service.is(":visible")){var e=service.parents(".basketline");return e.find(".bBacketServ.extWarr.mSmall").show(),e.find(".bBacketServ.extWarr.mBig").hide(),!1}})}function c(e){$("#totalOldPrice").html(printPrice(e))}function h(){$("#site-config").data("f1-certificate")&&l(),a();for(var e=0,t=0;e<d.length;e++)!d[e].noview&&$.contains(document.body,d[e].hasnodes[0])&&(t+=d[e].sum*1);t||location.reload(!0),s.html(printPrice(t)),s.typewriter(800),o=t}function p(e,t){var n=this;this.hasnodes=$(e.drop),$(e.less).data("run",!1),$(e.more).data("run",!1);var r=$(e.line);this.id=r.attr("ref");var i=$(e.more).parent().attr("href"),s=$(e.drop).attr("href"),a=typeof e.limit!="undefined"?e.limit:1e3;$(e.quan).length&&(this.quantum=$(e.quan).val()*1),this.noview=!1;var f=!1;$(e.sum).length?(this.sum=$(e.sum).html().replace(/\s/,""),this.price=(n.sum*1/n.quantum*1).toFixed(2)):(this.price=$(e.price).html().replace(/\s/,""),this.sum=this.quantum*this.price),o+=this.sum*1;var l=null;e.linked&&PubSub.subscribe("quantityChange",function(t,r){if(e.linked!=r.id)return;n.updateWrnt(r.q)}),this.updateWrnt=function(t){clearTimeout(l),n.quantum=t,n.sum=t*n.price,$(e.quan).val(n.quantum),l=setTimeout(function(){h(),1e3})},this.calculate=function(t){clearTimeout(l),n.quantum=t,n.sum=n.price*t,$(e.sum).html(printPrice(n.sum)),$(e.sum).typewriter(800,h),l=setTimeout(function(){h(),1e3})},this.clear=function(){r.remove(),n.noview=!0,PubSub.publish("quantityChange",{q:0,id:n.id}),t&&t(),$.when($.getJSON(s,function(e){})).then(function(t){$(e.drop).data("run",!1),t.success?(c(t.data.old_price),h()):location.href=location.href})},this.update=function(t,r){if(r>0&&a<n.quantum+r){$(t).data("run",!1);return}var s=i.slice(0,-1);t?n.quantum+=r:n.quantum=r,s+=n.quantum,$(e.quan).val(n.quantum),n.calculate(n.quantum),o+=n.price*r,$.when($.getJSON(s,function(e){})).then(function(e){$(t).data("run",!1),e.success||(location.href=location.href),c(e.data.old_price)})},this.checkNode=function(e,t){return e.warranty!=="undefined"?t>e.line.parents(".basketright").find(".ajaquant:first").val()?!1:!0:!0},$(e.drop).click(function(){return $(e.drop).data("run")||($(e.drop).data("run",!0),f=n.clear()),!1}),$(e.less).click(function(){var e=this;return $(e).data("run")||($(e).data("run",!0),n.quantum>1?n.update(e,-1):n.clear()),!1}),$(e.more).click(function(){var t=this,r=e.quan.val()+1;return n.checkNode(e,r)&&($(t).data("run")||($(t).data("run",!0),n.update(t,1))),!1}),$(e.quan).focusin(function(){$(e.quan).bind("keyup",function(t){if(t.which>=48&&t.which<=57||t.which==8){var r=n.quantum=$(e.quan).val().replace(/\D/g,"")*1;r>0?(u=!1,n.checkNode(e,r)&&n.update(!1,r)):u=!0}else{var r=n.quantum=$(e.quan).val().replace(/\D/g,"")*1;$(e.quan).val(n.quantum),u=r>0?!1:!0}})}),$(e.quan).focusout(function(){u&&(u=!1,n.clear()),$(e.quan).unbind("keyup")})}function m(e,t){var n=function(){var e=$("td.bF1Block_eBuy",t),n=$("div.bBacketServ.mBig.F1",t);for(var r=0,i=$(e).length;r<i;r++)$("tr[ref="+$(e[r]).attr("ref")+"]",n).length||$(e[r]).find("input").val("Купить услугу").removeClass("active");$("div.bBacketServ.mBig .ajaquant",t).length||($("div.bBacketServ.mBig.F1",t).hide(),$("div.bBacketServ.mSmall.F1",t).show())},r=new p({line:e,less:e.find(".ajaless"),more:e.find(".ajamore"),quan:e.find(".ajaquant"),sum:e.find(".price"),drop:e.find(".whitelink")},n);d.push(r)}function g(e,t){$("div.bBacketServ.mSmall.F1",e).hide();var n=$("div.bBacketServ.mBig.F1",e);n.show();var r=$("tr:first",n),i=tmpl("f1cartline",t);i=i.replace(/F1ID/g,t.fid).replace(/F1TOKEN/g,t.f1token).replace(/PRID/g,e.attr("ref")),r.after(i),m($("tr:eq(1)",n)),h()}function y(e,t){var n=function(){var e=$(".extWarranty .bF1Block_eBuy",t),n=$("div.bBacketServ.mBig.extWarr",t);for(var r=0,i=$(e).length;r<i;r++)$("tr[ref="+$(e[r]).attr("ref")+"]",n).length||$(e[r]).find("input").val("Выбрать").removeClass("active");$("div.bBacketServ.mBig.extWarr .mPrice",t).length||($("div.bBacketServ.mBig.extWarr",t).hide(),$("div.bBacketServ.mSmall.extWarr",t).show())},r=new p({line:e,warranty:!0,less:e.find(".ajaless"),more:e.find(".ajamore"),quan:e.find(".ajaquant"),sum:e.find(".price"),drop:e.find(".whitelink"),linked:t.attr("ref")},n);d.push(r)}function b(e,t){$("div.bBacketServ.mSmall:eq(1)",e).hide(),t.productQ=e.find(".ajaquant:first").text().replace(/[^0-9]/g,"");var n=$("div.bBacketServ.mBig:eq(1)",e);n.show();var i=$("tr:first",n),s=tmpl("wrntline",t);s=s.replace(/WID/g,t.ewid).replace(/PRID/g,e.attr("ref")),$(".ew_title",n).length&&$($("tr:eq(1)",n)).remove(),i.after(s),y($("tr:eq(1)",n),e),h(),c(r.data.old_price)}if($(".bF1SaleCard").length){var e=$("#F1SaleCard_number"),t=$("#F1SaleCard_btn"),n=$(".bF1SaleCard_eDel");t.bind("click",function(){var t=$(".bF1SaleCard_eRadio:checked").data("url"),n=function(e){e.success?window.location.reload():$("#bF1SaleCard_eErr").html("Извините, карта с таким номером не найдена.")},r={number:e.val()};$.ajax({type:"POST",url:t,data:r,success:n})}),n.live("click",function(){var e=$(this).data("url"),t=function(e){e.success&&window.location.reload()};$.ajax({type:"POST",url:e,success:t})}),$(".bF1SaleCard_eRadio").bind("change",function(){$("#cartCertificateAll").is(":checked")?e.attr("placeholder","Код скидки"):$("#cartCertificateF1").is(":checked")&&e.attr("placeholder","Номер карты «Под защитой F1»")})}if($("#_cartKiss").length){var r=$("#_cartKiss").data("cart"),i={"View Cart SKU Quantity":r.count,"View Cart SKU Total":r.price};typeof _kmq!="undefined"&&_kmq.push(["record","View Cart",i])}var s=$("#total .price"),o=0,u=!1;$(".product_kit-data").length&&$(".product_kit-data").bind("click",function(){var e=$(this).data("value");$(".bKitPopup").empty();for(obj in e){var t=tmpl("bKitPopupLine_Tmpl",e[obj]);$(".bKitPopup").append(t)}return $("#kitPopup").lightbox_me({centered:!0}),!1});var f=function(){var e=$(".bBacketServ.F1.mBig"),t=!1;return $.each(e,function(){service=$(this);if(service.find("tr[ref]").length)t=!0;else if(service.is(":visible")){var e=service.parents(".basketline");e.find(".bBacketServ.F1.mSmall").show(),e.find(".bBacketServ.F1.mBig").hide(),t=!1}}),t},l=function(){var e=f(),t=$(".bF1SaleCard_eComplete.mCoupon").length,n=$(".bF1SaleCard_eComplete.mSertificate").length,r=$(".bF1SaleCard_eForm"),i=$("#F1SaleCard_number");!e&&!t&&!n?r.show().removeClass("m2Coupon"):e&&!t&&!n?r.show().addClass("m2Coupon"):!e&&t?r.hide():e&&t&&!n?(r.show().removeClass("m2Coupon"),i.attr("placeholder","Номер карты «Под защитой F1»"),$(".bF1SaleCard_eRadio").removeAttr("checked"),$("#cartCertificateF1").attr("checked","checked")):t&&n&&r.hide(),$(".bF1SaleCard_eComplete").length&&e?$("#commonSum .oldPrice").show():$("#commonSum .oldPrice").hide()},d=[],v=!1;$(".basketline").each(function(){var e=$(this),t=new p({line:e,less:e.find(".ajaless:first"),more:e.find(".ajamore:first"),quan:e.find(".ajaquant:first"),price:e.find(".basketinfo .price:first"),sum:e.find(".basketinfo .sum:first"),drop:e.find(".basketinfo .whitelink:first"),limit:e.find(".numerbox").data("limit")});d.push(t),$("div.bBacketServ.mBig.F1",e).length&&$("div.bBacketServ.mBig.F1 tr",e).each(function(){$(".ajaquant",$(this)).length&&m($(this),e)}),e.find("a.link1").click(function(){if(v)return!1;v=!0;var t=$("div.bF1Block",e);return t.show().find(".close").click(function(){v=!1,t.hide()}),t.find("input.button").click(function(){if($(this).hasClass("active"))return!1;$(this).val("В корзине").addClass("active");var n=$(this).data();$.getJSON(n.url,function(r){r.success&&(n.f1price=r.data.sum,g(e,n),v=!1,t.hide(),c(r.data.old_price))})}),!1}),$("div.bBacketServ.mBig.extWarr",e).length&&$("div.bBacketServ.mBig.extWarr tr",e).each(function(){$(".mPrice",$(this)).length&&y($(this),e)}),e.find("a.link_extWarr").click(function(){if(v)return!1;v=!0;var t=$(".extWarranty",e);return t.show().find(".close").click(function(){v=!1,t.hide()}),t.find("input.button").click(function(){if($(this).hasClass("active"))return!1;t.find("input.button").val("Выбрать").removeClass("active"),$(this).val("В корзине").addClass("active");var n=$(this).data();$.getJSON(n.url,function(e){c(e.data.old_price)}),v=!1,t.hide(),b(e,n)}),!1})});if($("#selectCredit").length){var w=$("#creditSum").data("minsum");if(w)function E(){$("#creditSum").toggle(),$("#commonSum").toggle()}function S(){$("#selectCredit:checked").length&&E()}function x(){$("#blockFromCreditAgent").fadeOut("slow"),o>=w?$("#creditFlag").is(":hidden")&&($("#creditFlag").show(),S()):$("#creditFlag").is(":visible")&&($("#creditFlag").hide(),S())}function T(e){if(!docCookies.hasItem(e)){docCookies.setItem(!1,e,1,3600,"/");return}var t=docCookies.getItem(e);docCookies.setItem(!1,e,Math.abs(t-1),3600,"/")}x(),PubSub.subscribe("quantityChange",x),PubSub.subscribe("bankAnswered",function(){$("#blockFromCreditAgent").fadeIn("slow")}),$("label.bigcheck").click(function(e){var t=$(e.target);if(!t.is("input"))return;$(this).toggleClass("checked"),E(),T("credit_on")}),DirectCredit.init($("#tsCreditCart").data("value"),$("#creditPrice")),PubSub.subscribe("quantityChange",DirectCredit.change)}l()});