/*! Enter - v.40 - 2013-05-07 */$(document).ready(function(){function e(){warr=$(".bBacketServ.extWarr.mBig"),$.each(warr,function(){if(service=$(this),service.find("tr[ref]").length)return!0;if(service.is(":visible")){var e=service.parents(".basketline");return e.find(".bBacketServ.extWarr.mSmall").show(),e.find(".bBacketServ.extWarr.mBig").hide(),!1}})}function t(e){$("#totalOldPrice").html(printPrice(e))}function i(){$("#site-config").data("f1-certificate")&&g(),e();for(var t=0,i=0;v.length>t;t++)!v[t].noview&&$.contains(document.body,v[t].hasnodes[0])&&(i+=1*v[t].sum);i||location.reload(!0),h.html(printPrice(i)),h.typewriter(800),f=i}function n(e,n){var a=this;this.hasnodes=$(e.drop),$(e.less).data("run",!1),$(e.more).data("run",!1);var r=$(e.line);this.id=r.attr("ref");var o=$(e.more).parent().attr("href"),s=$(e.drop).attr("href"),l=e.limit!==void 0?e.limit:1e3;$(e.quan).length&&(this.quantum=1*$(e.quan).val()),this.noview=!1;var c=!1;$(e.sum).length?(this.sum=$(e.sum).html().replace(/\s/,""),this.price=(1*(1*a.sum/a.quantum)).toFixed(2)):(this.price=$(e.price).html().replace(/\s/,""),this.sum=this.quantum*this.price),f+=1*this.sum;var u=null;e.linked&&PubSub.subscribe("quantityChange",function(t,i){e.linked==i.id&&a.updateWrnt(i.q)}),this.updateWrnt=function(t){clearTimeout(u),a.quantum=t,a.sum=t*a.price,$(e.quan).val(a.quantum),u=setTimeout(function(){i(),1e3})},this.calculate=function(t){clearTimeout(u),a.quantum=t,a.sum=a.price*t,$(e.sum).html(printPrice(a.sum)),$(e.sum).typewriter(800,i),u=setTimeout(function(){i(),1e3})},this.clear=function(){r.remove(),a.noview=!0,PubSub.publish("quantityChange",{q:0,id:a.id}),n&&n(),$.when($.getJSON(s,function(){})).then(function(n){$(e.drop).data("run",!1),n.success?(t(n.data.old_price),i()):location.href=location.href})},this.update=function(i,n){if(n>0&&a.quantum+n>l)return $(i).data("run",!1),void 0;var r=o.slice(0,-1);i?a.quantum+=n:a.quantum=n,r+=a.quantum,$(e.quan).val(a.quantum),a.calculate(a.quantum),f+=a.price*n,$.when($.getJSON(r,function(){})).then(function(e){$(i).data("run",!1),e.success||(location.href=location.href),t(e.data.old_price)})},this.checkNode=function(e,t){return"undefined"!==e.warranty?t>e.line.parents(".basketright").find(".ajaquant:first").val()?!1:!0:!0},$(e.drop).click(function(){return $(e.drop).data("run")||($(e.drop).data("run",!0),c=a.clear()),!1}),$(e.less).click(function(){var e=this;return $(e).data("run")||($(e).data("run",!0),a.quantum>1?a.update(e,-1):a.clear()),!1}),$(e.more).click(function(){var t=this,i=e.quan.val()+1;return a.checkNode(e,i)&&($(t).data("run")||($(t).data("run",!0),a.update(t,1))),!1}),$(e.quan).focusin(function(){$(e.quan).bind("keyup",function(t){if(t.which>=48&&57>=t.which||8==t.which){var i=a.quantum=1*$(e.quan).val().replace(/\D/g,"");i>0?(p=!1,a.checkNode(e,i)&&a.update(!1,i)):p=!0}else{var i=a.quantum=1*$(e.quan).val().replace(/\D/g,"");$(e.quan).val(a.quantum),p=i>0?!1:!0}})}),$(e.quan).focusout(function(){p&&(p=!1,a.clear()),$(e.quan).unbind("keyup")})}function a(e,t){var i=function(){for(var e=$("td.bF1Block_eBuy",t),i=$("div.bBacketServ.mBig.F1",t),n=0,a=$(e).length;a>n;n++)$("tr[ref="+$(e[n]).attr("ref")+"]",i).length||$(e[n]).find("input").val("Купить услугу").removeClass("active");$("div.bBacketServ.mBig .ajaquant",t).length||($("div.bBacketServ.mBig.F1",t).hide(),$("div.bBacketServ.mSmall.F1",t).show())},a=new n({line:e,less:e.find(".ajaless"),more:e.find(".ajamore"),quan:e.find(".ajaquant"),sum:e.find(".price"),drop:e.find(".whitelink")},i);v.push(a)}function r(e,t){$("div.bBacketServ.mSmall.F1",e).hide();var n=$("div.bBacketServ.mBig.F1",e);n.show();var r=$("tr:first",n),o=tmpl("f1cartline",t);o=o.replace(/F1ID/g,t.fid).replace(/F1TOKEN/g,t.f1token).replace(/PRID/g,e.attr("ref")),r.after(o),a($("tr:eq(1)",n)),i()}function o(e,t){var i=function(){for(var e=$(".extWarranty .bF1Block_eBuy",t),i=$("div.bBacketServ.mBig.extWarr",t),n=0,a=$(e).length;a>n;n++)$("tr[ref="+$(e[n]).attr("ref")+"]",i).length||$(e[n]).find("input").val("Выбрать").removeClass("active");$("div.bBacketServ.mBig.extWarr .mPrice",t).length||($("div.bBacketServ.mBig.extWarr",t).hide(),$("div.bBacketServ.mSmall.extWarr",t).show())},a=new n({line:e,warranty:!0,less:e.find(".ajaless"),more:e.find(".ajamore"),quan:e.find(".ajaquant"),sum:e.find(".price"),drop:e.find(".whitelink"),linked:t.attr("ref")},i);v.push(a)}function s(e,n){$("div.bBacketServ.mSmall:eq(1)",e).hide(),n.productQ=e.find(".ajaquant:first").text().replace(/[^0-9]/g,"");var a=$("div.bBacketServ.mBig:eq(1)",e);a.show();var r=$("tr:first",a),s=tmpl("wrntline",n);s=s.replace(/WID/g,n.ewid).replace(/PRID/g,e.attr("ref")),$(".ew_title",a).length&&$($("tr:eq(1)",a)).remove(),r.after(s),o($("tr:eq(1)",a),e),i(),t(data.data.old_price)}function l(){$("#creditSum").toggle(),$("#commonSum").toggle()}function c(){$("#selectCredit:checked").length&&l()}function u(){$("#blockFromCreditAgent").fadeOut("slow"),f>=w?$("#creditFlag").is(":hidden")&&($("#creditFlag").show(),c()):$("#creditFlag").is(":visible")&&($("#creditFlag").hide(),c())}function d(e){if(!docCookies.hasItem(e))return docCookies.setItem(!1,e,1,3600,"/"),void 0;var t=docCookies.getItem(e);docCookies.setItem(!1,e,Math.abs(t-1),3600,"/")}var h=$("#total .price"),f=0,p=!1;$(".product_kit-data").length&&$(".product_kit-data").bind("click",function(){var e=$(this).data("value");$(".bKitPopup").empty();for(obj in e){var t=tmpl("bKitPopupLine_Tmpl",e[obj]);$(".bKitPopup").append(t)}return $("#kitPopup").lightbox_me({centered:!0}),!1});var m=function(){var e=$(".bBacketServ.F1.mBig"),t=!1;return $.each(e,function(){if(service=$(this),service.find("tr[ref]").length)t=!0;else if(service.is(":visible")){var e=service.parents(".basketline");e.find(".bBacketServ.F1.mSmall").show(),e.find(".bBacketServ.F1.mBig").hide(),t=!1}}),t},g=function(){m()?$(".bF1SaleCard").show():$(".bF1SaleCard").hide(),$(".bF1SaleCard_eComplete").length&&m()?$("#commonSum .oldPrice").show():$("#commonSum .oldPrice").hide()},v=[],b=!1;if($(".basketline").each(function(){var e=$(this),i=new n({line:e,less:e.find(".ajaless:first"),more:e.find(".ajamore:first"),quan:e.find(".ajaquant:first"),price:e.find(".basketinfo .price:first"),sum:e.find(".basketinfo .sum:first"),drop:e.find(".basketinfo .whitelink:first"),limit:e.find(".numerbox").data("limit")});v.push(i),$("div.bBacketServ.mBig.F1",e).length&&$("div.bBacketServ.mBig.F1 tr",e).each(function(){$(".ajaquant",$(this)).length&&a($(this),e)}),e.find("a.link1").click(function(){if(b)return!1;b=!0;var i=$("div.bF1Block",e);return i.show().find(".close").click(function(){b=!1,i.hide()}),i.find("input.button").click(function(){if($(this).hasClass("active"))return!1;$(this).val("В корзине").addClass("active");var n=$(this).data();$.getJSON(n.url,function(a){a.success&&(n.f1price=a.data.sum,r(e,n),b=!1,i.hide(),t(a.data.old_price))})}),!1}),$("div.bBacketServ.mBig.extWarr",e).length&&$("div.bBacketServ.mBig.extWarr tr",e).each(function(){$(".mPrice",$(this)).length&&o($(this),e)}),e.find("a.link_extWarr").click(function(){if(b)return!1;b=!0;var i=$(".extWarranty",e);return i.show().find(".close").click(function(){b=!1,i.hide()}),i.find("input.button").click(function(){if($(this).hasClass("active"))return!1;i.find("input.button").val("Выбрать").removeClass("active"),$(this).val("В корзине").addClass("active");var n=$(this).data();$.getJSON(n.url,function(e){t(e.data.old_price)}),b=!1,i.hide(),s(e,n)}),!1})}),$("#selectCredit").length){var w=$("#creditSum").data("minsum");u(),PubSub.subscribe("quantityChange",u),PubSub.subscribe("bankAnswered",function(){$("#blockFromCreditAgent").fadeIn("slow")}),$("label.bigcheck").click(function(e){var t=$(e.target);t.is("input")&&($(this).toggleClass("checked"),l(),d("credit_on"))}),DirectCredit.init($("#tsCreditCart").data("value"),$("#creditPrice")),PubSub.subscribe("quantityChange",DirectCredit.change)}});