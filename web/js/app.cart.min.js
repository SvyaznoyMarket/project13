$(document).ready(function(){function r(){for(var n=0,r=0;n<s.length;n++)!s[n].noview&&$.contains(document.body,s[n].hasnodes[0])&&(r+=s[n].sum*1);r||location.reload(!0),e.html(printPrice(r)),e.typewriter(800),t=r}function i(e,i){var s=this;this.hasnodes=$(e.drop),$(e.less).data("run",!1),$(e.more).data("run",!1);var o=$(e.line);this.id=o.attr("ref");var u=$(e.more).parent().attr("href"),a=$(e.drop).attr("href"),f=typeof e.limit!="undefined"?e.limit:1e3;$(e.quan).length&&(this.quantum=$(e.quan).val()*1),this.noview=!1;var l=!1;$(e.sum).length?(this.sum=$(e.sum).html().replace(/\s/,""),this.price=(s.sum*1/s.quantum*1).toFixed(2)):(this.price=$(e.price).html().replace(/\s/,""),this.sum=this.quantum*this.price),t+=this.sum*1;var c=null;e.linked&&PubSub.subscribe("quantityChange",function(t,n){if(e.linked!=n.id)return;s.updateWrnt(n.q)}),this.updateWrnt=function(t){clearTimeout(c),s.quantum=t,s.sum=t*s.price,$(e.quan).val(s.quantum),c=setTimeout(function(){r(),1e3})},this.calculate=function(t){clearTimeout(c),s.quantum=t,s.sum=s.price*t,$(e.sum).html(printPrice(s.sum)),$(e.sum).typewriter(800,r),c=setTimeout(function(){r(),1e3})},this.clear=function(){o.remove(),s.noview=!0,PubSub.publish("quantityChange",{q:0,id:s.id}),i&&i(),$.getJSON(a,function(t){$(e.drop).data("run",!1),t.success?r():location.href=location.href})},this.update=function(n,r){if(r>0&&f<s.quantum+r){$(n).data("run",!1);return}var i=u.slice(0,-1);n?s.quantum+=r:s.quantum=r,i+=s.quantum,$(e.quan).val(s.quantum),s.calculate(s.quantum),t+=s.price*r,PubSub.publish("quantityChange",{q:s.quantum,id:s.id}),$.getJSON(i,function(e){$(n).data("run",!1),e.success||(location.href=location.href)})},$(e.drop).click(function(){return $(e.drop).data("run")||($(e.drop).data("run",!0),l=s.clear()),!1}),$(e.less).click(function(){var e=this;return $(e).data("run")||($(e).data("run",!0),s.quantum>1?s.update(e,-1):s.clear()),!1}),$(e.more).click(function(){var e=this;return $(e).data("run")||($(e).data("run",!0),s.update(e,1)),!1}),$(e.quan).focusin(function(){$(e.quan).bind("keyup",function(t){if(t.which>=48&&t.which<=57||t.which==8){var r=s.quantum=$(e.quan).val().replace(/\D/g,"")*1;r>0?(n=!1,s.update(!1,r)):n=!0}else{var r=s.quantum=$(e.quan).val().replace(/\D/g,"")*1;$(e.quan).val(s.quantum),n=r>0?!1:!0}})}),$(e.quan).focusout(function(){n&&(n=!1,s.clear()),$(e.quan).unbind("keyup")})}function u(e,t){function n(){var e=$("td.bF1Block_eBuy",t),n=$("div.bBacketServ.mBig.F1",t);for(var r=0,i=$(e).length;r<i;r++)$("tr[ref="+$(e[r]).attr("ref")+"]",n).length||$(e[r]).find("input").val("Купить услугу").removeClass("active");$("div.bBacketServ.mBig .ajaquant",t).length||($("div.bBacketServ.mBig.F1",t).hide(),$("div.bBacketServ.mSmall.F1",t).show())}var r=new i({line:e,less:e.find(".ajaless"),more:e.find(".ajamore"),quan:e.find(".ajaquant"),sum:e.find(".price"),drop:e.find(".whitelink")},n);s.push(r)}function a(e,t){$("div.bBacketServ.mSmall.F1",e).hide();var n=$("div.bBacketServ.mBig.F1",e);n.show();var i=$("tr:first",n),s=tmpl("f1cartline",t);s=s.replace(/F1ID/g,t.fid).replace(/F1TOKEN/g,t.f1token).replace(/PRID/g,e.attr("ref")),i.after(s),u($("tr:eq(1)",n)),r()}function f(e,t){function n(){var e=$(".extWarranty .bF1Block_eBuy",t),n=$("div.bBacketServ.mBig.extWarr",t);for(var r=0,i=$(e).length;r<i;r++)$("tr[ref="+$(e[r]).attr("ref")+"]",n).length||$(e[r]).find("input").val("Выбрать").removeClass("active");$("div.bBacketServ.mBig.extWarr .mPrice",t).length||($("div.bBacketServ.mBig.extWarr",t).hide(),$("div.bBacketServ.mSmall.extWarr",t).show())}var r=new i({line:e,less:e.find(".ajaless"),more:e.find(".ajamore"),quan:e.find(".quantity"),price:e.find(".price"),drop:e.find(".whitelink"),linked:t.attr("ref")},n);s.push(r)}function l(e,t){$("div.bBacketServ.mSmall:eq(1)",e).hide(),t.productQ=e.find(".ajaquant:first").text().replace(/[^0-9]/g,"");var n=$("div.bBacketServ.mBig:eq(1)",e);n.show();var i=$("tr:first",n),s=tmpl("wrntline",t);s=s.replace(/WID/g,t.ewid).replace(/PRID/g,e.attr("ref")),i.after(s),f($("tr:eq(1)",n),e),r()}var e=$("#total .price"),t=0,n=!1,s=[],o=!1;$(".basketline").each(function(){var e=$(this),t=new i({line:e,less:e.find(".ajaless:first"),more:e.find(".ajamore:first"),quan:e.find(".ajaquant:first"),price:e.find(".basketinfo .price:first"),sum:e.find(".basketinfo .sum:first"),drop:e.find(".basketinfo .whitelink:first"),limit:e.find(".numerbox").data("limit")});s.push(t),$("div.bBacketServ.mBig.F1",e).length&&$("div.bBacketServ.mBig.F1 tr",e).each(function(){$(".ajaquant",$(this)).length&&u($(this),e)}),e.find("a.link1").click(function(){if(o)return!1;o=!0;var t=$("div.bF1Block",e);return t.show().find(".close").click(function(){o=!1,t.hide()}),t.find("input.button").click(function(){if($(this).hasClass("active"))return!1;$(this).val("В корзине").addClass("active");var n=$(this).data();$.getJSON(n.url,function(e){}),a(e,n),t.hide()}),!1}),$("div.bBacketServ.mBig.extWarr",e).length&&$("div.bBacketServ.mBig.extWarr tr",e).each(function(){$(".mPrice",$(this)).length&&f($(this),e)}),e.find("a.link_extWarr").click(function(){if(o)return!1;o=!0;var t=$(".extWarranty",e);return t.show().find(".close").click(function(){o=!1,t.hide()}),t.find("input.button").click(function(){if($(this).hasClass("active"))return!1;$(this).val("В корзине").addClass("active");var n=$(this).data();$.getJSON(n.url,function(e){}),t.hide(),l(e,n)}),!1})});if($("#selectCredit").length){var c=$("#creditSum").data("minsum");if(c)function h(){$("#creditSum").toggle(),$("#commonSum").toggle()}function p(){$("#selectCredit:checked").length&&h()}function d(){$("#blockFromCreditAgent").fadeOut("slow"),t>=c?$("#creditFlag").is(":hidden")&&($("#creditFlag").show(),p()):$("#creditFlag").is(":visible")&&($("#creditFlag").hide(),p())}function v(e){if(!docCookies.hasItem(e)){docCookies.setItem(!1,e,1,3600,"/");return}var t=docCookies.getItem(e);docCookies.setItem(!1,e,Math.abs(t-1),3600,"/")}d(),PubSub.subscribe("quantityChange",d),PubSub.subscribe("bankAnswered",function(){$("#blockFromCreditAgent").fadeIn("slow")}),$("label.bigcheck").click(function(e){var t=$(e.target);if(!t.is("input"))return;$(this).toggleClass("checked"),h(),v("credit_on")}),DirectCredit.init($("#tsCreditCart").data("value"),$("#creditPrice")),PubSub.subscribe("quantityChange",DirectCredit.change)}});