$(document).ready(function(){function h(){for(var a=0,c=0;a<d.length;a++)!d[a].noview&&$.contains(document.body,d[a].hasnodes[0])&&(c+=1*d[a].sum);c||location.reload(!0);k.html(printPrice(c));k.typewriter(800);i=c}function e(a,c){var b=this;this.hasnodes=$(a.drop);$(a.less).data("run",!1);$(a.more).data("run",!1);var f=$(a.line);this.id=f.attr("ref");var r=$(a.more).parent().attr("href"),g=$(a.drop).attr("href"),d=a.limit;if($(a.quan).length)this.quantum=1*$(a.quan).html().replace(/\D/g,"");var e=
(1*(1*b.sum/b.quantum)).toFixed(2);"price"in a&&(e=$(a.price).html().replace(/\s/,""));this.price=e;this.noview=!1;this.sum=$(a.sum).length?$(a.sum).html().replace(/\s/,""):this.quantum*this.price;i+=1*this.sum;var j=null;a.linked&&PubSub.subscribe("quantityChange",function(c,f){a.linked==f.id&&b.updateWrnt(f.q)});this.updateWrnt=function(c){clearTimeout(j);b.quantum=c;b.sum=c*b.price;$(a.quan).html(b.quantum);j=setTimeout(function(){h()})};this.calculate=function(c){clearTimeout(j);b.quantum=c;b.sum=
e*c;$(a.sum).html(printPrice(b.sum));$(a.sum).typewriter(800,h);j=setTimeout(function(){h()})};this.clear=function(){f.remove();b.noview=!0;PubSub.publish("quantityChange",{q:0,id:b.id});c&&c();$.getJSON(g,function(b){$(a.drop).data("run",!1);b.success?h():location.href=location.href})};this.update=function(c,f){if(0<f&&d<b.quantum+f)$(c).data("run",!1);else{var g=r;b.quantum+=f;g+=b.quantum;$(a.quan).html(b.quantum+" шт.");b.calculate(b.quantum);i+=b.price*f;PubSub.publish("quantityChange",{q:b.quantum,
id:b.id});$.getJSON(g,function(a){$(c).data("run",!1);if(!a.success)location.href=location.href})}};$(a.drop).click(function(){$(a.drop).data("run")||($(a.drop).data("run",!0),b.clear());return!1});$(a.less).click(function(){$(this).data("run")||($(this).data("run",!0),1<b.quantum?b.update(this,-1):b.clear());return!1});$(a.more).click(function(){$(this).data("run")||($(this).data("run",!0),b.update(this,1));return!1})}function l(a,c){var b=new e({line:a,less:a.find(".ajaless"),more:a.find(".ajamore"),
quan:a.find(".ajaquant"),sum:a.find(".price"),drop:a.find(".whitelink")},function(){for(var a=$("td.bF1Block_eBuy",c),b=$("div.bBacketServ.mBig.F1",c),g=0,d=$(a).length;g<d;g++)$("tr[ref="+$(a[g]).attr("ref")+"]",b).length||$(a[g]).find("input").val("Купить услугу").removeClass("active");$("div.bBacketServ.mBig .ajaquant",c).length||($("div.bBacketServ.mBig.F1",c).hide(),$("div.bBacketServ.mSmall.F1",c).show())});d.push(b)}function s(a,c){$("div.bBacketServ.mSmall.F1",a).hide();var b=$("div.bBacketServ.mBig.F1",
a);b.show();var f=$("tr:first",b),d=tmpl("f1cartline",c),d=d.replace(/F1ID/g,c.fid).replace(/F1TOKEN/g,c.f1token).replace(/PRID/g,a.attr("ref"));f.after(d);l($("tr:eq(1)",b));h()}function m(a,c){var b=new e({line:a,less:a.find(".ajaless"),more:a.find(".ajamore"),quan:a.find(".quantity"),price:a.find(".price"),drop:a.find(".whitelink"),linked:c.attr("ref")},function(){for(var a=$(".extWarranty .bF1Block_eBuy",c),b=$("div.bBacketServ.mBig.extWarr",c),d=0,e=$(a).length;d<e;d++)$("tr[ref="+$(a[d]).attr("ref")+
"]",b).length||$(a[d]).find("input").val("Выбрать").removeClass("active");$("div.bBacketServ.mBig.extWarr .mPrice",c).length||($("div.bBacketServ.mBig.extWarr",c).hide(),$("div.bBacketServ.mSmall.extWarr",c).show())});d.push(b)}function t(a,c){$("div.bBacketServ.mSmall:eq(1)",a).hide();c.productQ=a.find(".ajaquant:first").text().replace(/[^0-9]/g,"");var b=$("div.bBacketServ.mBig:eq(1)",a);b.show();var d=$("tr:first",b),e=tmpl("wrntline",c),e=e.replace(/WID/g,c.ewid).replace(/PRID/g,a.attr("ref"));
d.after(e);m($("tr:eq(1)",b),a);h()}var k=$("#total .price"),i=0,d=[];$(".basketline").each(function(){var a=$(this),c=new e({line:a,less:a.find(".ajaless:first"),more:a.find(".ajamore:first"),quan:a.find(".ajaquant:first"),price:a.find(".basketinfo .price:first"),sum:a.find(".basketinfo .sum:first"),drop:a.find(".basketinfo .whitelink:first"),limit:a.find(".numerbox").data("limit")});d.push(c);$("div.bBacketServ.mBig.F1",a).length&&$("div.bBacketServ.mBig.F1 tr",a).each(function(){$(".ajaquant",
$(this)).length&&l($(this),a)});a.find("a.link1").click(function(){var b=$("div.bF1Block",a);b.show().find(".close").click(function(){b.hide()});b.find("input.button").click(function(){if($(this).hasClass("active"))return!1;$(this).val("В корзине").addClass("active");var c=$(this).data();$.getJSON(c.url,function(){});s(a,c);b.hide()});return!1});$("div.bBacketServ.mBig.extWarr",a).length&&$("div.bBacketServ.mBig.extWarr tr",a).each(function(){$(".mPrice",$(this)).length&&m($(this),a)});a.find("a.link_extWarr").click(function(){var b=
$(".extWarranty",a);b.show().find(".close").click(function(){b.hide()});b.find("input.button").click(function(){if($(this).hasClass("active"))return!1;$(this).val("В корзине").addClass("active");var c=$(this).data();$.getJSON(c.url,function(){});b.hide();t(a,c)});return!1})});if($("#selectCredit").length){var n=$("#creditSum").data("minsum");if(n)var o=function(){$("#creditSum").toggle();$("#commonSum").toggle()};var p=function(){$("#selectCredit:checked").length&&o()},q=function(){$("#blockFromCreditAgent").fadeOut("slow");
i>=n?$("#creditFlag").is(":hidden")&&($("#creditFlag").show(),p()):$("#creditFlag").is(":visible")&&($("#creditFlag").hide(),p())};q();PubSub.subscribe("quantityChange",q);PubSub.subscribe("bankAnswered",function(){$("#blockFromCreditAgent").fadeIn("slow")});$("label.bigcheck").click(function(a){$(a.target).is("input")&&($(this).toggleClass("checked"),o(),docCookies.hasItem("credit_on")?(a=docCookies.getItem("credit_on"),docCookies.setItem(!1,"credit_on",Math.abs(a-1),3600,"/")):docCookies.setItem(!1,
"credit_on",1,3600,"/"))});DirectCredit.init($("#tsCreditCart").data("value"),$("#creditPrice"));PubSub.subscribe("quantityChange",DirectCredit.change)}});
