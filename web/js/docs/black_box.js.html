<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: library/black_box.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: library/black_box.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/**
 * WARNING!
 *
 * @requires jQuery, simple_templating, pageConfig
 */


/**
 * Создает объект для обновления данных с сервера и отображения текущих покупок
 *
 * @author	Zaytsev Alexandr
 * @this	{BlackBox}
 * @param	{String}		updateUrl URL по которому будут запрашиватся данные о пользователе и корзине.
 * @param	{jQuery}		mainNode  DOM элемент бокса
 * @constructor
 */
var BlackBox = function(updateUrl, mainContatiner){
	this.updUrl = (!docCookies.hasItem('enter') ||  !docCookies.hasItem('enter_auth')) ? updateUrl += '?ts=' + new Date().getTime() + Math.floor(Math.random() * 1000) : updateUrl;
	this.mainNode = mainContatiner;
};

/**
 * Объект по работе с корзиной
 *
 * @author	Zaytsev Alexandr
 * @this	{BlackBox}
 * @return	{function} update	обновление данных о корзине
 * @return	{function} add		добавление в корзину
 */
BlackBox.prototype.basket = function() {
	var self = this,

		headQ = $('#topBasket');
		bottomQ = self.mainNode.find('.bBlackBox__eCartQuan'),
		bottomSum = self.mainNode.find('.bBlackBox__eCartSum'),
		total = self.mainNode.find('.bBlackBox__eCartTotal'),
		bottomCart = self.mainNode.find('.bBlackBox__eCart'),
		flyboxBasket = self.mainNode.find('.bBlackBox__eFlybox.mBasket'),
		flyboxInner = self.mainNode.find('.bBlackBox__eFlyboxInner'),


		/**
		 * Уничтожение содержимого flybox и его скрытие
		 *
		 * @author	Zaytsev Alexandr
		 * @private
		 */
		flyboxDestroy = function(){
			flyboxBasket.hide(0, function(){
				flyboxInner.remove();
			});
		},

		/**
		 * Закрытие flybox по клику
		 * 
		 * @author	Zaytsev Alexandr
		 * @param	{Event} e
		 * @private
		 */
		flyboxcloser = function(e){
			var targ = e.target.className;

			if (!(targ.indexOf('bBlackBox__eFlybox')+1) || !(targ.indexOf('fillup')+1)) {
				flyboxDestroy();
				$('body').unbind('click', flyboxcloser);
			}
		},

		/**
		 * Обновление данных о корзине
		 *
		 * @author	Zaytsev Alexandr
		 * @param	{Object} basketInfo			Информация о корзине
		 * @param	{Number} basketInfo.cartQ	Количество товаров в корзине
		 * @param	{Number} basketInfo.cartSum	Стоимость товаров в корзине
		 * @public
		 */
		update = function(basketInfo) {
			headQ.html('('+basketInfo.cartQ+')');
			bottomQ.html(basketInfo.cartQ);
			bottomSum.html(basketInfo.cartSum);
			bottomCart.addClass('mBought');
			total.show();
		},

		/**
		 * Добавление товара в корзину
		 *
		 * @author	Zaytsev Alexandr
		 * @param	{Object} item
		 * @param	{String} item.title			Название товара
		 * @param	{Number} item.price			Стоимость товара
		 * @param	{String} item.imgSrc		Ссылка на изображение товара
		 * @param	{Number} item.TotalQuan		Общее количество товаров в корзине
		 * @param	{Number} item.totalSum		Общая стоимость корзины
		 * @param	{String} item.linkToOrder	Ссылка на оформление заказа
		 * @public
		 */
		add = function(item) {
			var flyboxTmpl = tmpl('blackbox_basketshow_tmpl', item);

			flyboxDestroy();
			flyboxBasket.append(flyboxTmpl);
			flyboxBasket.show(300);

			var nowBasket = {
				cartQ: item.totalQuan,
				cartSum: item.totalSum
			};

			self.basket().update(nowBasket);

			$('body').bind('click', flyboxcloser);

		};
	//end of vars

	return {
		'update': update,
		'add': add
	};
};

/**
 * Объект по работе с данными пользователя
 *
 * @author	Zaytsev Alexandr
 * @this	{BlackBox}
 * @return	{function} update
 */
BlackBox.prototype.user = function() {
	var self = this,

		/**
		 * Обновление пользователя
		 *
		 * @author	Zaytsev Alexandr
		 * @param	{String} userName Имя пользователя
		 * @public
		 */
		update = function(userName) {
			var topAuth = $('#auth-link'),
				bottomAuth = self.mainNode.find('.bBlackBox__eUserLink');
			//end of vars

			if (userName !== null) {
				var dtmpl={
						user: userName
					},
					show_user = tmpl('auth_tmpl', dtmpl);
				//end of vars
				
				topAuth.hide();
				topAuth.after(show_user);
				bottomAuth.html(userName).addClass('mAuth');
			}
			else {
				topAuth.show();
			}
		};
	//end of vars
	
	return {
		'update': update
	};
};


/**
 * Инициализация BlackBox.
 * Получение данных о корзине и пользователе с сервера.
 *
 * @author	Zaytsev Alexandr
 * @this	{BlackBox}
 */
BlackBox.prototype.init = function() {
	var self = this,

		/**
		 * Обработчик Action присланных с сервера
		 * 
		 * @param	{Object} action Список действий которые необходимо выполнить
		 * @private
		 */
		startAction = function(action) {
			if (action.subscribe !== undefined) {
				$("body").trigger("showsubscribe", [action.subscribe]);
			}
			if (action.cartButton !== undefined) {
				$("body").trigger("markcartbutton", [action.cartButton]);
				$("body").trigger("updatespinner", [action.cartButton]);
			}
		},

		/**
		 * Обработчик данных о корзине и пользователе
		 * 
		 * @param	{Object} data
		 * @private
		 */ 
		parseUserInfo = function(data) {
			if (data.success !== true) {
				return false;
			}

			var userInfo = data.user,
				cartInfo = data.cart,
				actionInfo = data.action;

			self.user().update(userInfo.name);

			if (cartInfo.quantity !== 0) {
				var nowBasket = {
					cartQ: cartInfo.quantity,
					cartSum: cartInfo.sum
				};
				self.basket().update(nowBasket);
			}

			if (actionInfo !== undefined) {
				startAction(actionInfo);
			}
		};
	//end of vars

	$.get(self.updUrl, parseUserInfo);
};


/**
 * Создание и иницилизация объекта для работы с корзиной и данными пользователя
 * @type	{BlackBox}
 */
window.blackBox = new BlackBox(pageConfig.userUrl, $('.bBlackBox__eInner'));
blackBox.init();</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="BlackBox.html">BlackBox</a></li></ul><h3>Global</h3><ul><li><a href="global.html#activateItemLvl1">activateItemLvl1</a></li><li><a href="global.html#activateItemLvl2">activateItemLvl2</a></li><li><a href="global.html#add">add</a></li><li><a href="global.html#buildTriangle">buildTriangle</a></li><li><a href="global.html#checkHoverLvl2">checkHoverLvl2</a></li><li><a href="global.html#createTriangle">createTriangle</a></li><li><a href="global.html#docCookies">docCookies</a></li><li><a href="global.html#flyboxcloser">flyboxcloser</a></li><li><a href="global.html#flyboxDestroy">flyboxDestroy</a></li><li><a href="global.html#getDimensions">getDimensions</a></li><li><a href="global.html#isTrueEmail">isTrueEmail</a></li><li><a href="global.html#menuCheckTriangle">menuCheckTriangle</a></li><li><a href="global.html#menuHoverInLvl1">menuHoverInLvl1</a></li><li><a href="global.html#menuHoverInLvl2">menuHoverInLvl2</a></li><li><a href="global.html#menuMouseLeaveLvl1">menuMouseLeaveLvl1</a></li><li><a href="global.html#menuMouseLeaveLvl2">menuMouseLeaveLvl2</a></li><li><a href="global.html#menuMoveLvl2">menuMoveLvl2</a></li><li><a href="global.html#pageConfig">pageConfig</a></li><li><a href="global.html#Planner3d_Init">Planner3d_Init</a></li><li><a href="global.html#Planner3d_UpdatePrice">Planner3d_UpdatePrice</a></li><li><a href="global.html#Planner3dKupeConstructor">Planner3dKupeConstructor</a></li><li><a href="global.html#printPrice">printPrice</a></li><li><a href="global.html#update">update</a></li><li><a href="global.html#UpdateUrlString">UpdateUrlString</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0</a> on Mon Jul 15 2013 19:20:00 GMT+0400 (MSK)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
