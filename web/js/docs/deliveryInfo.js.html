<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: product/deliveryInfo.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: product/deliveryInfo.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/**
 * Расчет доставки
 *
 * @author		Zaytsev Alexandr
 * @requires	jQuery, simple_templating
 * @param		{Object}	widgetBox		Контейнер с доступными вариантами доставки
 * @param		{Object}	deliveryData	Данные необходимые для отображения доставки
 * @param		{String}	url				Адрес по которому необходимо запросить данные с расчитанной доставкой для текущего продукта
 * @param		{String}	deliveryShops	Список магазинов из которых можно забрать сегодня (только если товар не доступен для продажи)
 * @param		{Object}	productInfo		Данные о текущем продукте
 * @param		{Object}	dataToSend		Данные для отправки на сервер и получение расчитанной доставки
 */
(function(){
	if (!$('#jsProductCard').length){
		return false;
	}

	var widgetBox = $('.bWidgetBuy__eDelivery'),
		deliveryData = widgetBox.data('value'),
		url = deliveryData.url,
		deliveryShops = (deliveryData.delivery.length) ? deliveryData.delivery[0].shop : [],
		productInfo = $('#jsProductCard').data('value'),
		dataToSend = {
			'product':[
				{'id': productInfo.id}
			]
		},

		/**
		 * Показ попапа с магазином
		 *
		 * @param	{Object}	popup		Контейнер с попапом
		 * @param	{Object}	button		Кнопка «перейти к магазину» в попапе
		 * @param	{Object}	position	Координаты магазина, зашитые в ссылку
		 * @param	{String}	url			Ссылка на магазин
		 * @return	{Boolean}
		 */
		showAvalShop = function (){
			var popup = $('#avalibleShop'),
				button = popup.find('.bOrangeButton'),
				position = {
					latitude: $(this).data('lat'),
					longitude: $(this).data('lng')
				},
				url = $(this).attr('href');
			// end of var

			button.attr('href', url);
			$('#ymaps-avalshops').css({'width':600, 'height':400});

			$.when(MapInterface.ready( 'yandex', {
				yandex: $('#infowindowtmpl'), 
				google: $('#infowindowtmpl')
			})).done(function(){
				MapInterface.onePoint( position, 'ymaps-avalshops' );
			});

			popup.css({'width':600, 'height':425});
			popup.lightbox_me({
				centered: true,
				onLoad: function() {
				},
				onClose: function(){
					$('#ymaps-avalshops').empty();
				}
			});

			return false;
		},

		/**
		 * Заполнение шаблона с доступными для самовывоза магазинами
		 * 
		 * @param	{Array}		shops			Массив магазинов
		 * @param	{Object}	nowBox			Контейнер для элементов текущего типа доставки
		 * @param	{Object}	toggleBtn		Кнопка переключения состояния листа магазинов открыто или закрыто
		 * @param	{Object}	shopList		Контейнер для вывода списка магазинов
		 * @param	{String}	templateNow		Готовый шаблон магазина
		 * @param	{Object}	shopInfo		Данные для подстановки в шаблон магазина
		 * @param	{Number}	shopLen			Количество магазинов
		 */
		fillAvalShopTmpl = function (shops){
			var nowBox = widgetBox.find('.bWidgetBuy__eDelivery-now'),
				toggleBtn = nowBox.find('.bWidgetBuy__eDelivery-nowClick'),
				shopList = nowBox.find('.bDeliveryFreeAddress'),
				templateNow = '',
				shopInfo = {},
				shopLen = shops.length,

				/**
				 * Обработчик переключения состояния листа магазинов открыто или закрыто
				 */
				shopToggle = function (){
					nowBox.toggleClass('mOpen');
					nowBox.toggleClass('mClose');
				};
			// end of var
			
			if (!shopLen){
				return;
			}

			for (var j = shopLen - 1; j >= 0; j--) {
				shopInfo = {
					name: shops[j].name,
					lat: shops[j].latitude,
					lng: shops[j].longitude,
					url: shops[j].url
				};

				templateNow = tmpl('widget_delivery_shop',shopInfo);
				shopList.append(templateNow);
			}

			nowBox.show();
			$('.bDeliveryFreeAddress__eLink').bind('click', showAvalShop);
			toggleBtn.bind('click', shopToggle);
		},

		/**
		 * Обработка данных с сервера
		 * 
		 * @param	{Object}	res	Ответ от сервера
		 */
		resFromSerever = function (res){
			if (!res.success){
				return false;
			}

			/**
			 * Полученнный с сервера массив вариантов доставок для текущего товара
			 * @type	{Array}
			 */
			var deliveryInfo = res.product[0].delivery;

			for (var i = deliveryInfo.length - 1; i >= 0; i--) {
				switch (deliveryInfo[i].token){
					case 'standart':
						var standartBox = widgetBox.find('.bWidgetBuy__eDelivery-price'),
							standartData = {
								price: deliveryInfo[i].price,
								dateString: deliveryInfo[i].date.name
							},
							templateStandart = tmpl('widget_delivery_standart', standartData);
						// end of var

						standartBox.html(templateStandart);
						break;

					case 'self':
						var selfBox = widgetBox.find('.bWidgetBuy__eDelivery-free'),
							selfData = {
								price: deliveryInfo[i].price,
								dateString: deliveryInfo[i].date.name
							},
							templateSelf = tmpl('widget_delivery_self', selfData);
						// end of var

						selfBox.html(templateSelf);
						break;

					case 'now':
						fillAvalShopTmpl(deliveryInfo[i].shop);
						break;
				}
			}
		};
	// end of var

	if (url === '') {
		fillAvalShopTmpl(deliveryShops);
	}
	else {
		$.ajax({
			type: 'POST',
			url: url,
			data: dataToSend,
			success: resFromSerever
		});
	}
}());</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="BlackBox.html">BlackBox</a></li></ul><h3>Global</h3><ul><li><a href="global.html#activateItemLvl1">activateItemLvl1</a></li><li><a href="global.html#activateItemLvl2">activateItemLvl2</a></li><li><a href="global.html#add">add</a></li><li><a href="global.html#buildTriangle">buildTriangle</a></li><li><a href="global.html#checkHoverLvl2">checkHoverLvl2</a></li><li><a href="global.html#createTriangle">createTriangle</a></li><li><a href="global.html#docCookies">docCookies</a></li><li><a href="global.html#flyboxcloser">flyboxcloser</a></li><li><a href="global.html#flyboxDestroy">flyboxDestroy</a></li><li><a href="global.html#getDimensions">getDimensions</a></li><li><a href="global.html#isTrueEmail">isTrueEmail</a></li><li><a href="global.html#menuCheckTriangle">menuCheckTriangle</a></li><li><a href="global.html#menuHoverInLvl1">menuHoverInLvl1</a></li><li><a href="global.html#menuHoverInLvl2">menuHoverInLvl2</a></li><li><a href="global.html#menuMouseLeaveLvl1">menuMouseLeaveLvl1</a></li><li><a href="global.html#menuMouseLeaveLvl2">menuMouseLeaveLvl2</a></li><li><a href="global.html#menuMoveLvl2">menuMoveLvl2</a></li><li><a href="global.html#pageConfig">pageConfig</a></li><li><a href="global.html#Planner3d_Init">Planner3d_Init</a></li><li><a href="global.html#Planner3d_UpdatePrice">Planner3d_UpdatePrice</a></li><li><a href="global.html#Planner3dKupeConstructor">Planner3dKupeConstructor</a></li><li><a href="global.html#printPrice">printPrice</a></li><li><a href="global.html#update">update</a></li><li><a href="global.html#UpdateUrlString">UpdateUrlString</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0</a> on Mon Jul 15 2013 19:20:00 GMT+0400 (MSK)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
