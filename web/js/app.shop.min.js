$(document).ready(function(){function e(e){var t={};for(var i in e)t[e[i].id]=e[i];return t}function t(e){$("#map-info_window-container").html(tmpl("infowindowtmpl",e))}var i=$(".bMap__eScrollWrap");if(i.delegate("div.map-image-link","click",function(){return $(this).hasClass("first")&&$("div.map-360-link",i).length?($("div.map-360-link",i).trigger("click"),void 0):($(this).hasClass("mChecked")||($("div.mChecked",$(this).parent()).removeClass("mChecked"),$(this).addClass("mChecked")),void 0)}),$("div.map-360-link",i).length&&i.delegate("div.map-360-link","click",function(e){if($("div.mChecked",$(".bMap__eScrollWrap")).removeClass("mChecked"),!$("#map-container embed").length){$(this);var t=$("#map-panorama").data();embedpano({swf:t.swf,xml:t.xml,target:"map-container",wmode:"transparent"})}e.stopPropagation()}),i.delegate("div.map-google-link","click",function(){if($("div.mChecked",i).removeClass("mChecked"),!$("#map-container div").length){$(this);var e={latitude:$('[name="shop[latitude]"]').val(),longitude:$('[name="shop[longitude]"]').val()};$.when(MapInterface.ready("yandex",{yandex:$("#infowindowtmpl"),google:$("#map-info_window-container")})).done(function(){MapInterface.onePoint(e,"map-container")})}}),$("div.map-google-link:first",i).trigger("click"),$("#map-markers").length){var r=$("#map-markers").data("content"),a=!1,n={timer:null,id:0};$(".bMapShops__eMapCityList ul").delegate("li","hover",function(){var e=$(this).attr("ref");n.timer&&clearTimeout(n.timer),e&&e!=n.id&&(n.id=e,n.timer=setTimeout(function(){window.regionMap.showInfobox(e)},350))});var o=function(){$(".bMapShops__eMapCityList_city").click(function(){var t=$(this).attr("ref");if($(".bShopCard").hide(),$(".bMapShops__eMapCityList_city ul").fadeOut(500,function(){$(".bMapShops__eMapCityList_city ul").empty()}),a)$(this).removeClass("chosedCity"),$(".bMapShops__eMapCityList_city").show(),a=!1;else{var i=[];for(var n in r)if(r[n].region_id==$(this).attr("ref")){var o=tmpl("shopInCity",r[n]);$(this).find("ul").append(o),i.push(r[n])}if(i.length){$(".bMapShops__eMapCityList_city").hide(),$(this).addClass("chosedCity").show();var s=$(".chosedCity").offset().top;$(".shop_"+t).css("display","inline-block"),$(this).find("ul").fadeIn(500,function(){window.regionMap.showMarkers(e(i)),$(".bMapShops__eMapCityList").scroll(function(){var e=$(".chosedCity").offset().top;$(".chosedCity .cityName").css("top",s-e)})})}else alert("В этом городе пока еще нет наших магазинов");a=!0}})},s=calcMCenter(r),l=function(){window.regionMap.showCluster(r),o()};$.when(MapInterface.ready("yandex",{yandex:$("#infowindowtmpl"),google:$("#map-info_window-container")})).done(function(){MapInterface.init(s,"region_map-container",l,t)})}});