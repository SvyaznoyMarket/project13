$(document).ready(function(){var l,m,n;function p(a){a=new Date(a);return a.getDate()+" "+"января,февраля,марта,апреля,мая,июня,июля,августа,сентября,октября,ноября,декабря".split(",")[a.getMonth()]}function t(a){var b=a.time_begin;"0"==b[0]&&(b=b.slice(1));return"с "+b+" до "+a.time_end}function u(a,b,d){var e={};e.sw=a;e.state=b;e.dv=p(d);a=new Date(d);a=a.getDate()+" <span>"+"Вс,Пн,Вт,Ср,Чт,Пт,Сб".split(",")[a.getDay()]+"</span>";e.dhtml=a;e.ISO=d;e.schedule=[];return e}function o(a,b){b.addCost=
1*a.price;b.dlvrDate=p(a.date_default);b.ISODate=a.date_default;b.dlvrTime=t(a.date_list[0].interval[0]);b.dlvrID=a.date_list[0].interval[0].id;b.vcalend=[];var d=new Date(a.date_list[0].date),e=d.getDay();0===e?e=6:e--;d.setDate(d.getDate()-e);for(var g=0;g<e;g++){var h=u(0,"dis",d.getTime());b.vcalend.push(h);d.setDate(d.getDate()+1)}g=0;for(d=a.date_list.length;g<d&&g<14-e;g++){for(var r=a.date_list[g],h=u(g<7-e?0:1,"act",r.date),i=0,k=r.interval.length;i<k;i++){var f={};f.id=r.interval[i].id;
f.txt=t(r.interval[i]);h.schedule.push(f)}b.vcalend.push(h)}}function q(a,b){function d(a,d){for(var h=0,f=a.length;h<f;h++){var i=a[h],k={};k.is_service=d;k.id=i.id;k.title=i.name;k.moveable=i.moveable;k.price=0<1*i.price?printPrice(i.price):"1";k.hm=1*i.quantity;k.locs=i.moveto_shop;k.img=null!==i.media_image?i.media_image:"/images/f1_footer_logo.png";k.dlvr=[];for(var l=0,m=i.moveto_mode.length;l<m;l++)switch(i.moveto_mode[l]){case "self":k.dlvr.push({txt:"В самовывоз",lbl:"selfy"});break;case "standart_delay":k.dlvr.push({txt:"В доставку",
lbl:"delay"});break;case "standart_rapid":k.dlvr.push({txt:"В доставку",lbl:"rapid"})}b.products.push(k)}}b.products=[];d(a.products,!1);"services"in a&&d(a.services,!0)}function v(a){MVM.shiftAndClose($(a).parent().find(".shopnum").text())}l={};m={};n={};console.info($("#delivery-map").data("value"));var f=$("#delivery-map").data("value");o(f.standart_rapid,l);q(f.standart_rapid,l);o(f.standart_delayed,m);q(f.standart_delayed,m);o(f.self,n);(function(a,b){b.shops=[];for(var d=0,e=a.shops.length;d<
e;d++){var g=a.shops[d],h={};h.shid=g.id;h.title=g.address;h.fromto=g.working_time;h.latitude=g.coord_lat;h.longitude=g.coord_long;h.markerImg="";q(g,h);b.shops.push(h)}})(f.self,n);MVM=new function(){function a(b,a,d,e,g,i,f){var j=this;j.papa=b;j.curDate=ko.observable(a);j.curDateF=d;j.dates=e;j.weeknum=ko.observable(!1);j.cWeek=function(b,a){$(a.currentTarget).hasClass("mDisabled")||j.weeknum(!j.weeknum())};j.pickDate=function(b,a){if($(a.currentTarget).hasClass("bBuyingDates__eDisable"))return!1;
j.curDate(b.dv);j.curDateF=b.ISO;$(j.papa).find('.bBuyingDatePopup[ref="'+b.dv+'"]').css({left:$(a.target).position().left}).show()};if("undefined"!==typeof g){j.curTime=ko.observable(g);j.curTimeId=i;if("undefined"!==typeof f)j.schedule=ko.observableArray(f);j.pickTime=function(b,a){j.curTime(b.txt);j.curTimeId=b.id;$(a.currentTarget).parent().parent().hide()}}}var b=this;b.noSuchItemError=ko.observable(!1);b.appIsLoaded=ko.observable(!1);b.stolenItems=ko.observableArray([]);b.addCost=l.addCost;
b.bitems=ko.observableArray(l.products);b.RapidCalend=new a(".rapid",l.dlvrDate,l.ISODate,l.vcalend,l.dlvrTime,l.dlvrID,l.schedule);b.addCost_D=m.addCost;b.bitems_D=ko.observableArray(m.products);b.stolenItems.push(b.bitems()[0]);b.DelayCalend=new a(".delay",m.dlvrDate,m.ISODate,m.vcalend,m.dlvrTime,m.dlvrID,m.schedule);b.shops=ko.observableArray(n.shops);b.SelfyCalend=new a(".selfy",n.dlvrDate,n.ISODate,n.vcalend);for(var d=0,e=b.bitems().length;d<e;d++)if("undefined"!==typeof b.bitems()[d].dlvr)for(var g=
0,h=b.bitems()[d].dlvr.length;g<h;g++){var f=b.bitems()[d].dlvr[g],i=b.bitems()[d].dlvr[g].lbl;b.bitems()[d].dlvr[g].lbl=ko.observable(i);f.txt=ko.computed(function(){switch(this.lbl()){case "delay":return"В доставку "+b.DelayCalend.curDate();case "rapid":return"В доставку "+b.RapidCalend.curDate();case "selfy":return"В самовывоз "+b.SelfyCalend.curDate()}},f)}d=0;for(e=b.shops().length;d<e;d++)b.shops()[d].products=ko.observableArray(n.shops[d].products);b.shifting=function(a,d,e){b.interfaceMove(d,
a);switch(e.lbl()){case "delay":b.bitems_D.unshift(a);break;case "rapid":b.bitems.unshift(a);break;case "selfy":d=0;e=a.locs.length;a:for(;d<e;d++)for(var g=0,f=b.shops().length;g<f;g++)if(a.locs[d]===b.shops()[g].shid){b.shops()[g].products.unshift(a);break a}}};b.totalPrice=ko.computed(function(){for(var a=0,d=0;d<b.bitems().length;d++)a+=1*b.bitems()[d].price.replace(/\D/g,"");0<a&&(a+=b.addCost);return printPrice(a)},this);b.totalPrice_D=ko.computed(function(){for(var a=0,d=0;d<b.bitems_D().length;d++)a+=
1*b.bitems_D()[d].price.replace(/\D/g,"");0<a&&(a+=b.addCost_D);return printPrice(a)},this);b.totalPrice_S=ko.computed(function(){for(var a=0,d=0;d<b.shops().length;d++)for(var e=0;e<b.shops()[d].products().length;e++)a+=1*b.shops()[d].products()[e].price.replace(/\D/g,"");return printPrice(a)},this);b.totalSum=ko.computed(function(){var a=1*b.totalPrice().replace(/\D/g,"")+1*b.totalPrice_D().replace(/\D/g,"")+1*b.totalPrice_S().replace(/\D/g,"");return printPrice(a)},this);var k,o;k=$("#delete-urls").data("products");
o=$("#delete-urls").data("services");var q=function(b){var a=b.is_service?o:k;b.id in a&&$.ajax({url:a[b.id],success:function(){}})};b.interfaceMove=function(a,d){switch(a){case "rapid":b.bitems.remove(d);break;case "delay":b.bitems_D.remove(d);break;case "selfy":for(var e=0,g=b.shops().length;e<g;e++)b.shops()[e].products.remove(d)}};b.removeIt=function(a,d){q(d);b.interfaceMove(a,d)};b.allshops=void 0;b.productforPopup=ko.observable({moveable:!1,price:"9 900",title:"Сноуборд Salomon Salvatore Sanchez ",
hm:"1",img:"/images/z_img6.png",locs:[20,10]});b.popupWithShops=ko.observableArray([]);var p=null,s=null;b.shiftingInShops=function(a){if("object"===typeof a)a=a.shid;b.shops()[b.shops.indexOf(p)].products.remove(s);for(var d=0,e=b.shops().length;d<e;d++)if(b.shops()[d].shid==a){b.shops()[d].products.push(s);break}};b.shiftAndClose=function(a){window.regionMap.closeMap();b.shiftingInShops(a)};b.fillPopupWithShops=function(a,d){p=a;s=d;b.productforPopup(d);var e=b.popupWithShops.slice(0),g=d.locs.slice(0),
f=0,i=e.length;a:for(;f<i;f++){for(var h=0,j=d.locs.length;h<j;h++)if(e[f].shid==d.locs[h]){g[h]=0;continue a}b.popupWithShops.remove(e[f])}h=0;j=g.length;a:for(;h<j;h++)if(g[h]){e=b.shops();f=0;for(i=e.length;f<i;f++)if(e[f].shid==g[h]){e[f].markerImg=ko.observable();b.popupWithShops.push(e[f]);continue a}}h=0;for(j=b.popupWithShops().length;h<j;h++)b.popupWithShops()[h].markerImg("/images/marker_"+(h+1)+".png")}};ko.applyBindings(MVM);MVM.appIsLoaded(!0);(new brwsr).isTouch||($("body").delegate(".bImgButton",
"mouseenter",function(){var a={cssl:"-64px",tiptext:"tip"};$(this).hasClass("mMap")&&(a={cssl:"-64px",tiptext:"Выбрать другой магазин"});$(this).hasClass("mBacket")&&(a={cssl:"-36px",tiptext:"Удалить товар"});$(this).hasClass("mArrows")&&(a={cssl:"-87px",tiptext:"Поместить товар в другой заказ"});$(this).html(tmpl("tip_tmpl",a))}),$("body").delegate(".bImgButton","mouseleave",function(){$(this).empty()}),$("body").delegate(".bButtonPopup","mouseleave",function(){$(this).hide()}),$("body").delegate(".bBuyingDatePopup",
"mouseleave",function(){$(this).hide()}));$("body").delegate(".bButtonPopup__eTitle","click",function(){$(this).hide()});$("body").delegate(".mArrows","click",function(a){a.preventDefault();$(this).parent().find(".bButtonPopup").show();return!1});$("body").delegate(".mMap","click",function(a){a.preventDefault();for(var b={},a=MVM.popupWithShops(),d=0,e=a.length;d<e;d++)b[a[d].shid+""]={id:a[d].shid,name:a[d].title,regtime:a[d].fromto,latitude:a[d].latitude,longitude:a[d].longitude,markerImg:a[d].markerImg()};
$(".mMapPopup").lightbox_me({centered:!0,onLoad:function(){regionMap.showMarkers(b)}})});window.regionMap=new function(a,b,d){var e=this;e.mapWS=null;e.infoWindow=null;e.positionC=null;e.markers=[];this.showInfobox=function(a){var d=e.markers[a.id];a.setVisible(!1);$.each(b.find("[data-name]"),function(a,b){b.innerHTML=d[$(b).data("name")]});e.infoWindow.setContent(b.prop("innerHTML"));e.infoWindow.setPosition(a.position);e.infoWindow.open(e.mapWS);google.maps.event.addListener(e.infoWindow,"closeclick",
function(){a.setVisible(!0)})};this.showMarkers=function(a){$.each(e.markers,function(a,b){"undefined"!==typeof b.ref&&b.ref.setMap(null)});e.markers=a;google.maps.event.trigger(e.mapWS,"resize");e.mapWS.setCenter(e.positionC);$.each(a,function(a,b){var d=new google.maps.Marker({position:new google.maps.LatLng(b.latitude,b.longitude),map:e.mapWS,title:b.name,icon:b.markerImg,id:b.id});google.maps.event.addListener(d,"click",function(){e.showInfobox(this)});e.markers[d.id].ref=d})};this.closeMap=function(){e.infoWindow.close();
$(".mMapPopup").trigger("close")};(function(){e.positionC=new google.maps.LatLng(a.latitude,a.longitude);var b={zoom:11,center:e.positionC,scrollwheel:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}};e.mapWS=new google.maps.Map(document.getElementById(d),b);e.infoWindow=new google.maps.InfoWindow({maxWidth:400,disableAutoPan:!1})})()}($("#map-center").data("content"),$("#map-info_window-container"),"mapPopup");var w=$("#mapPopup");
w.delegate(".shopchoose","click",function(a){a.preventDefault();v(a.target)});w[0].addEventListener("touchstart",function(a){a.preventDefault();a.target.className.match("shopchoose")&&v(a.target)},!1);$("body").delegate(".bBuyingLine label","click",function(){if("radio"==$(this).find("input").attr("type")){var a=$('.mChecked input[name="'+$(this).find("input").attr("name")+'"]');a.length&&a.each(function(a,d){$(d).parent("label").removeClass("mChecked")});$(this).addClass("mChecked")}else"checkbox"==
$(this).find("input").attr("type")&&$(this).toggleClass("mChecked")});$("body").delegate(".bBuyingLine input:radio, .bBuyingLine input:checkbox","click",function(a){a.stopPropagation()});$(".mConfirm a.bBigOrangeButton").click(function(a){a.preventDefault();var a=$("#order"),b=a.serializeArray();console.info(b);var d=$("#validator").data("value");a:for(field in d)if(a.find('[name="'+field+'"]:visible').length){for(var e=0,g=b.length;e<g;e++)if(b[e].name==field){""==b[e].value&&console.info(field);
continue a}console.info(field)}$(this).html("Минутку...");f.standart_rapid.products=MVM.bitems();f.standart_delayed.products=MVM.bitems_D();f.standart_rapid.date_default=MVM.RapidCalend.curDateF;f.standart_rapid.time_default=MVM.RapidCalend.curTimeId;f.standart_delayed.date_default=MVM.DelayCalend.curDateF;f.standart_delayed.time_default=MVM.DelayCalend.curTimeId;f.self.date_default=MVM.SelfyCalend.curDateF;b=0;for(d=f.self.shops.length;b<d;b++)f.self.shops[b].products=MVM.shops()[b].products().slice(0);
a.serializeArray().push({name:"products_hash",value:JSON.stringify(f)})})});
