$(document).ready(function(){function o(a){a=new Date(a);return a.getDate()+" "+"января,февраля,марта,апреля,мая,июня,июля,августа,сентября,октября,ноября,декабря".split(",")[a.getMonth()]}function p(a){var b=a.time_begin;"0"==b[0]&&(b=b.slice(1));return"с "+b+" до "+a.time_end}function q(a,b,d){var c={};c.sw=a;c.state=b;c.dv=o(d);a=new Date(d);a=a.getDate()+" <span>"+"Вс,Пн,Вт,Ср,Чт,Пт,Сб".split(",")[a.getDay()]+"</span>";c.dhtml=a;c.ISO=d;c.schedule=[];return c}function l(a,b){b.addCost=1*a.price;
b.dlvrDate=o(a.date_default);b.ISODate=a.date_default;b.dlvrTime=p(a.date_list[0].interval[0]);b.dlvrID=a.date_list[0].interval[0].id;b.vcalend=[];var d=new Date(a.date_list[0].date),c=d.getDay();0===c?c=6:c--;d.setDate(d.getDate()-c);for(var e=0;e<c;e++){var f=q(0,"dis",d.getTime());b.vcalend.push(f);d.setDate(d.getDate()+1)}e=0;for(d=a.date_list.length;e<d&&e<14-c;e++){for(var i=a.date_list[e],f=q(e<7-c?0:1,"act",i.date),g=0,k=i.interval.length;g<k;g++){var j={};j.id=i.interval[g].id;j.txt=p(i.interval[g]);
f.schedule.push(j)}b.vcalend.push(f)}}function n(a,b){b.products=[];for(var d=0,c=a.products.length;d<c;d++){var e=a.products[d],f={};f.title=e.name;f.moveable=e.moveable;f.price=printPrice(e.price);f.hm=1*e.quantity;f.locs=e.moveto_shop;f.img=e.moveable;f.dlvr=[];for(var g=0,m=e.moveto_mode.length;g<m;g++)switch(e.moveto_mode[g]){case "self":f.dlvr.push({txt:"В самовывоз",lbl:"selfy"});break;case "standart_delay":f.dlvr.push({txt:"В доставку",lbl:"delay"});break;case "standart_rapid":f.dlvr.push({txt:"В доставку",
lbl:"rapid"})}b.products.push(f)}}function r(a){MVM.shiftingInShops($(a).parent().find(".shopnum").text())}function t(){g.standart_rapid.products=MVM.bitems();g.standart_delayed.products=MVM.bitems_D();g.standart_rapid.date_default=MVM.RapidCalend.curDateF;g.standart_rapid.time_default=MVM.RapidCalend.curTimeId;g.standart_delayed.date_default=MVM.DelayCalend.curDateF;g.standart_delayed.time_default=MVM.DelayCalend.curTimeId;g.self.date_default=MVM.SelfyCalend.curDateF;for(var a=0,b=g.self.shops.length;a<
b;a++)g.self.shops[a].products=MVM.shops()[a].products().slice(0);console.info(g)}if(!Date.prototype.toISOString)Date.prototype.toISOString=function(){function a(b){return 10>b?"0"+b:b}return this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"Z"};orderModel={Rapid:{addCost:290,dlvrDate:"12 декабря",dlvrTime:"с 9:00 до 14:00",vcalend:[{sw:0,state:"dis",dv:"10 декабря",dhtml:"10 <span>Пн</span>"},
{sw:0,state:"dis",dv:"11 декабря",dhtml:"11 <span>Вт</span>"},{sw:0,state:"act",dv:"12 декабря",dhtml:"12 <span>Ср</span>"},{sw:0,state:"act",dv:"13 декабря",dhtml:"13 <span>Чт</span>"},{sw:0,state:"act",dv:"14 декабря",dhtml:"14 <span>Пт</span>"},{sw:0,state:"act",dv:"15 декабря",dhtml:"15 <span>Сб</span>"},{sw:0,state:"act",dv:"16 декабря",dhtml:"16 <span>Вс</span>"},{sw:1,state:"act",dv:"17 декабря",dhtml:"17 <span>Пн</span>"},{sw:1,state:"act",dv:"18 декабря",dhtml:"18 <span>Вт</span>"},{sw:1,
state:"act",dv:"19 декабря",dhtml:"19 <span>Ср</span>"},{sw:1,state:"act",dv:"20 декабря",dhtml:"20 <span>Чт</span>"},{sw:1,state:"act",dv:"21 декабря",dhtml:"21 <span>Пт</span>"},{sw:1,state:"act",dv:"22 декабря",dhtml:"22 <span>Сб</span>"},{sw:1,state:"act",dv:"23 декабря",dhtml:"23 <span>Вс</span>"}],schedule:["с 9:00 до 14:00","с 14:00 до 18:00","с 18:00 до 21:00"],products:[{moveable:!0,dlvr:[{txt:"В доставку",lbl:"delay"},{txt:"В самовывоз",lbl:"selfy"}],price:"999",title:"Чайник со свистком 2,5 л",
hm:"2",img:"/images/z_img2.png",locs:[1,2]},{moveable:!1,price:"1 400",title:"Мягкая игрушка Fancy &laquo;Медведь Топа&raquo;",hm:"3",img:"/images/z_img1.png",locs:[1,2]},{moveable:!0,dlvr:[{txt:"В доставку",lbl:"delay"},{txt:"В самовывоз",lbl:"selfy"}],price:"4 495",title:"Смартфон Samsung Wave 525 черный",hm:"1",img:"/images/z_img8.png",locs:[2]}]},Delay:{addCost:700,dlvrDate:"22 декабря",dlvrTime:"с 9:00 до 14:00",vcalend:[{sw:0,state:"dis",dv:"20 декабря",dhtml:"20 <span>Пн</span>"},{sw:0,state:"dis",
dv:"21 декабря",dhtml:"21 <span>Вт</span>"},{sw:0,state:"act",dv:"22 декабря",dhtml:"22 <span>Ср</span>"},{sw:0,state:"act",dv:"23 декабря",dhtml:"23 <span>Чт</span>"},{sw:0,state:"act",dv:"24 декабря",dhtml:"24 <span>Пт</span>"},{sw:0,state:"act",dv:"25 декабря",dhtml:"25 <span>Сб</span>"},{sw:0,state:"act",dv:"26 декабря",dhtml:"26 <span>Вс</span>"},{sw:1,state:"act",dv:"27 декабря",dhtml:"27 <span>Пн</span>"},{sw:1,state:"act",dv:"28 декабря",dhtml:"28 <span>Вт</span>"},{sw:1,state:"act",dv:"29 декабря",
dhtml:"29 <span>Ср</span>"},{sw:1,state:"act",dv:"30 декабря",dhtml:"30 <span>Чт</span>"},{sw:1,state:"act",dv:"31 декабря",dhtml:"31 <span>Пт</span>"},{sw:1,state:"act",dv:"01 января",dhtml:"01 <span>Сб</span>"},{sw:1,state:"act",dv:"02 января",dhtml:"02 <span>Вс</span>"}],schedule:["с 9:00 до 14:00","с 14:00 до 18:00","с 18:00 до 21:00"],products:[{moveable:!1,price:"24 190",title:"Угловой диван-кровать Вика 32 ",hm:"1",img:"/images/z_img3.png"},{moveable:!1,price:"1 900",title:"Утилизация демонтированной мебели",
hm:"2",img:"/images/z_img4.png"}]},Selfy:{addCost:0,dlvrDate:"13 декабря",vcalend:[{sw:0,state:"dis",dv:"10 декабря",dhtml:"10 <span>Пн</span>"},{sw:0,state:"dis",dv:"11 декабря",dhtml:"11 <span>Вт</span>"},{sw:0,state:"act",dv:"12 декабря",dhtml:"12 <span>Ср</span>"},{sw:0,state:"act",dv:"13 декабря",dhtml:"13 <span>Чт</span>"},{sw:0,state:"act",dv:"14 декабря",dhtml:"14 <span>Пт</span>"},{sw:0,state:"act",dv:"15 декабря",dhtml:"15 <span>Сб</span>"},{sw:0,state:"act",dv:"16 декабря",dhtml:"16 <span>Вс</span>"},
{sw:1,state:"act",dv:"17 декабря",dhtml:"17 <span>Пн</span>"},{sw:1,state:"act",dv:"18 декабря",dhtml:"18 <span>Вт</span>"},{sw:1,state:"act",dv:"19 декабря",dhtml:"19 <span>Ср</span>"},{sw:1,state:"act",dv:"20 декабря",dhtml:"20 <span>Чт</span>"},{sw:1,state:"act",dv:"21 декабря",dhtml:"21 <span>Пт</span>"},{sw:1,state:"act",dv:"22 декабря",dhtml:"22 <span>Сб</span>"},{sw:1,state:"act",dv:"23 декабря",dhtml:"23 <span>Вс</span>"}],shops:[{shid:1,title:"м. Белорусская, магазин на ул. Грузинский вал, д. 31",
fromto:"с 9.00 до 22.00",products:[{moveable:!1,price:"9 900",title:"Сноуборд Salomon Salvatore Sanchez ",hm:"1",img:"/images/z_img6.png",locs:[1,2,3]},{moveable:!1,price:"3 900",title:"Сноубордические ботинки Head Classic",hm:"2",img:"/images/z_img7.png",locs:[1,2]}]},{shid:2,title:"м. Ленинский проспект, ул. Орджоникидзе, д. 11, стр. 10",fromto:"с 9.00 до 22.00",products:[{moveable:!1,price:"800",title:"Фигурка South Park Cartman Talking Wacky Wobbeler",hm:"2",img:"/images/z_img9.png",locs:[2]}]},
{shid:3,title:"м. Киевская, ул. Б. Дорогомиловская, д. 8",fromto:"с 9.00 до 22.00",products:[{moveable:!1,price:"4 490",title:"Смартфон Samsung Wave 525 черный ",hm:"2",img:"/images/z_img8.png",locs:[3]}]},{shid:220,title:"новый магаз",fromto:"с 9.00 до 22.00",products:[]}]},allshops:[{shid:1,title:"м. Белорусская, магазин на ул. Грузинский вал, д. 31",fromto:"с 9.00 до 22.00",latitude:55.775004,longitude:37.581675,markerImg:""},{shid:2,title:"м. Ленинский проспект, ул. Орджоникидзе, д. 11, стр. 10",
fromto:"с 9.00 до 22.00",latitude:55.706488,longitude:37.596997,markerImg:""},{shid:3,title:"м. Киевская, ул. Б. Дорогомиловская, д. 8",fromto:"с 9.00 до 22.00",latitude:55.746197,longitude:37.565389,markerImg:""},{shid:220,title:"новый магаз",fromto:"с 9.00 до 22.00",latitude:55.851993,longitude:37.442905,markerImg:""}]};console.info($("#delivery-map").data("value"));var g=$("#delivery-map").data("value");l(g.standart_rapid,orderModel.Rapid);n(g.standart_rapid,orderModel.Rapid);l(g.standart_delayed,
orderModel.Delay);n(g.standart_delayed,orderModel.Delay);l(g.self,orderModel.Selfy);(function(a,b){b.shops=[];for(var d=0,c=a.shops.length;d<c;d++){var e=a.shops[d],f={};f.shid=e.id;f.title=e.address;f.fromto=e.working_time;f.latitude=e.coord_lat;f.longitude=e.coord_long;f.markerImg="";n(e,f);b.shops.push(f)}})(g.self,orderModel.Selfy);MVM=new function(){function a(b,a,c,d,e,f,g){var h=this;h.papa=b;h.curDate=ko.observable(a);h.curDateF=c;h.dates=d;h.weeknum=ko.observable(!1);h.cWeek=function(b,a){$(a.currentTarget).hasClass("mDisabled")||
h.weeknum(!h.weeknum())};h.pickDate=function(b,a){if($(a.currentTarget).hasClass("bBuyingDates__eDisable"))return!1;h.curDate(b.dv);h.curDateF=b.ISO;h.papa.find('.bBuyingDatePopup[ref="'+b.dv+'"]').css({left:$(a.target).position().left}).show()};if("undefined"!==typeof e){h.curTime=ko.observable(e);h.curTimeId=f;if("undefined"!==typeof g)h.schedule=ko.observableArray(g);h.pickTime=function(b){h.curTime(b.txt);h.curTimeId=b.id}}}var b=this;b.addCost=orderModel.Rapid.addCost;b.bitems=ko.observableArray(orderModel.Rapid.products);
b.RapidCalend=new a($(".rapid"),orderModel.Rapid.dlvrDate,orderModel.Rapid.ISODate,orderModel.Rapid.vcalend,orderModel.Rapid.dlvrTime,orderModel.Rapid.dlvrID,orderModel.Rapid.schedule);b.addCost_D=orderModel.Delay.addCost;b.bitems_D=ko.observableArray(orderModel.Delay.products);b.DelayCalend=new a($(".delay"),orderModel.Delay.dlvrDate,orderModel.Delay.ISODate,orderModel.Delay.vcalend,orderModel.Delay.dlvrTime,orderModel.Delay.dlvrID,orderModel.Delay.schedule);b.shops=ko.observableArray(orderModel.Selfy.shops);
b.SelfyCalend=new a($(".selfy"),orderModel.Selfy.dlvrDate,orderModel.Selfy.ISODate,orderModel.Selfy.vcalend);for(var d=0,c=b.bitems().length;d<c;d++)if("undefined"!==typeof b.bitems()[d].dlvr)for(var e=0,f=b.bitems()[d].dlvr.length;e<f;e++){var g=b.bitems()[d].dlvr[e],m=b.bitems()[d].dlvr[e].lbl;b.bitems()[d].dlvr[e].lbl=ko.observable(m);g.txt=ko.computed(function(){switch(this.lbl()){case "delay":return"В доставку "+b.DelayCalend.curDate();case "rapid":return"В доставку "+b.RapidCalend.curDate();
case "selfy":return"В самовывоз "+b.SelfyCalend.curDate()}},g)}d=0;for(c=b.shops().length;d<c;d++)b.shops()[d].products=ko.observableArray(orderModel.Selfy.shops[d].products);b.shifting=function(a,c,d,e){$(e.currentTarget).parent().parent().find(".mBacket").trigger("click");switch(d.lbl()){case "delay":b.bitems_D.unshift(a);break;case "rapid":b.bitems.unshift(a);break;case "selfy":c=0;d=a.locs.length;a:for(;c<d;c++)for(var e=0,f=b.shops().length;e<f;e++)if(a.locs[c]===b.shops()[e].shid){b.shops()[e].products.unshift(a);
break a}}};b.totalPrice=ko.computed(function(){for(var a=b.addCost,c=0;c<b.bitems().length;c++)a+=1*b.bitems()[c].price.replace(/\D/g,"");return printPrice(a)},this);b.totalPrice_D=ko.computed(function(){for(var a=b.addCost_D,c=0;c<b.bitems_D().length;c++)a+=1*b.bitems_D()[c].price.replace(/\D/g,"");return printPrice(a)},this);b.totalPrice_S=ko.computed(function(){for(var a=0,c=0;c<b.shops().length;c++)for(var d=0;d<b.shops()[c].products().length;d++)a+=1*b.shops()[c].products()[d].price.replace(/\D/g,
"");return printPrice(a)},this);b.totalSum=ko.computed(function(){var a=1*b.totalPrice().replace(/\D/g,"")+1*b.totalPrice_D().replace(/\D/g,"")+1*b.totalPrice_S().replace(/\D/g,"");return printPrice(a)},this);b.removeIt=function(a){b.bitems.remove(a);b.bitems_D.remove(a)};b.removeFromShop=function(a,c){var d=b.shops.indexOf(a);b.shops()[d].products.remove(c)};b.allshops=orderModel.allshops;b.productforPopup=ko.observable({moveable:!1,price:"9 900",title:"Сноуборд Salomon Salvatore Sanchez ",hm:"1",
img:"/images/z_img6.png",locs:[20,10]});b.popupWithShops=ko.observableArray([]);var k=null,j=null;b.shiftingInShops=function(a){if("object"===typeof a)a=a.shid;b.shops()[b.shops.indexOf(k)].products.remove(j);for(var c=0,d=b.shops().length;c<d;c++)if(b.shops()[c].shid==a){b.shops()[c].products.push(j);break}$(".mMapPopup").trigger("close")};b.fillPopupWithShops=function(a,c){k=a;j=c;b.productforPopup(c);var d=b.popupWithShops.slice(0),e=c.locs.slice(0),f=0,g=d.length;a:for(;f<g;f++){for(var i=0,h=
c.locs.length;i<h;i++)if(d[f].shid==c.locs[i]){e[i]=0;continue a}b.popupWithShops.remove(d[f])}i=0;h=e.length;a:for(;i<h;i++)if(e[i]){d=b.shops();f=0;for(g=d.length;f<g;f++)if(d[f].shid==e[i]){d[f].markerImg=ko.observable();b.popupWithShops.push(d[f]);continue a}}i=0;for(h=b.popupWithShops().length;i<h;i++)b.popupWithShops()[i].markerImg("/images/marker_"+(i+1)+".png")}};ko.applyBindings(MVM);$("body").delegate(".bImgButton","mouseenter",function(){var a={cssl:"-64px",tiptext:"tip"};$(this).hasClass("mMap")&&
(a={cssl:"-64px",tiptext:"Выбрать другой магазин"});$(this).hasClass("mBacket")&&(a={cssl:"-36px",tiptext:"Удалить товар"});$(this).hasClass("mArrows")&&(a={cssl:"-87px",tiptext:"Поместить товар в другой заказ"});$(this).html(tmpl("tip_tmpl",a))});$("body").delegate(".bImgButton","mouseleave",function(){$(this).empty()});$("body").delegate(".bButtonPopup","mouseleave",function(){$(this).hide()});$("body").delegate(".bBuyingDatePopup","mouseleave",function(){$(this).hide()});$("body").delegate(".mArrows",
"click",function(a){a.preventDefault();$(this).parent().find(".bButtonPopup").show();return!1});$("body").delegate(".mMap","click",function(a){a.preventDefault();for(var b={},a=MVM.popupWithShops(),d=0,c=a.length;d<c;d++)b[a[d].shid+""]={id:a[d].shid,name:a[d].title,regtime:a[d].fromto,latitude:a[d].latitude,longitude:a[d].longitude,markerImg:a[d].markerImg()};$(".mMapPopup").lightbox_me({centered:!0,onLoad:function(){regionMap.showMarkers(b)}})});window.regionMap=new function(a,b,d){var c=this;c.mapWS=
null;c.infoWindow=null;c.positionC=null;c.markers=[];this.showInfobox=function(a){var d=c.markers[a.id];a.setVisible(!1);$.each(b.find("[data-name]"),function(a,b){b.innerHTML=d[$(b).data("name")]});c.infoWindow.setContent(b.prop("innerHTML"));c.infoWindow.setPosition(a.position);c.infoWindow.open(c.mapWS);google.maps.event.addListener(c.infoWindow,"closeclick",function(){a.setVisible(!0)})};this.showMarkers=function(a){$.each(c.markers,function(a,b){"undefined"!==typeof b.ref&&b.ref.setMap(null)});
c.markers=a;google.maps.event.trigger(c.mapWS,"resize");c.mapWS.setCenter(c.positionC);$.each(a,function(a,b){var d=new google.maps.Marker({position:new google.maps.LatLng(b.latitude,b.longitude),map:c.mapWS,title:b.name,icon:b.markerImg,id:b.id});google.maps.event.addListener(d,"click",function(){c.showInfobox(this)});c.markers[d.id].ref=d})};(function(){c.positionC=new google.maps.LatLng(a.latitude,a.longitude);var b={zoom:11,center:c.positionC,scrollwheel:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,
mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}};c.mapWS=new google.maps.Map(document.getElementById(d),b);c.infoWindow=new google.maps.InfoWindow({disableAutoPan:!1,maxWidth:280})})()}($("#map-center").data("content"),$("#map-info_window-container"),"mapPopup");var s=$("#mapPopup");s.delegate(".shopchoose","click",function(a){a.preventDefault();r(a.target)});s[0].addEventListener("touchstart",function(a){a.preventDefault();a.target.className.match("shopchoose")&&r(a.target)},
!1);$("body").delegate(".bBuyingLine label","click",function(){if("radio"==$(this).find("input").attr("type")){var a=$('.mChecked input[name="'+$(this).find("input").attr("name")+'"]');a.length&&a.each(function(a,d){$(d).parent("label").removeClass("mChecked")});$(this).addClass("mChecked")}else"checkbox"==$(this).find("input").attr("type")&&$(this).toggleClass("mChecked")});$("body").delegate(".bBuyingLine input:radio, .bBuyingLine input:checkbox","click",function(a){a.stopPropagation()});$(".mConfirm a.bBigOrangeButton").click(function(a){a.preventDefault();
a=$("#order");t();var b=a.serializeArray();b.push({name:"products_hash",value:JSON.stringify(g)});$.ajax({url:a.attr("action"),type:"POST",data:b,success:function(){}})})});
