$(document).ready(function(){function d(){function r(e,t,n){for(var r=0,i=e.length;r<i;r++)if(e[r][t]==n)return!0;return!1}function i(e,t,n){var r=[];for(var i=0,s=e.length;i<s;i++)if(e[i][t]==n){for(var o in e[i].intervals)r.push("c "+e[i].intervals[o].start_at+" по "+e[i].intervals[o].end_at);return r}return!1}function s(e){var t=e[0];if(e.length>1)for(var n=1,r=e.length;n<r;n++)e[n][0]>t[0]&&(t[0]=e[n][0]),e[n][1]<t[1]&&(t[1]=e[n][1]);return t}function o(e){var t=new Date(e);if(t.getDay()!==1){var n=t.getDay()?t.getDay()*1-1:6;t.setTime(t.getTime()*1-n*24*60*60*1e3)}return t}function u(e){var t=new Date(e);return t.getDay()!==0&&t.setTime(t.getTime()*1+(7-t.getDay())*24*60*60*1e3),t}function a(e){e.caclDates=[];var t=e.token,n=[];for(var a=0,f=e.itemList().length;a<f;a++){var l=e.itemList()[a].deliveries[t].dates;n.push([l[0],l[l.length-1]])}var c=s(n),h=o(c[0].timestamp),p=u(c[1].timestamp),d=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"],v=1;while(h.getTime()*1<=p.getTime()*1){var m={dayOfWeek:d[h.getDay()*1],day:h.getDate()*1,tstamp:h.getTime()*1,week:v,enable:ko.observable(!1)};h.getDay()||v++,e.caclDates.push(m),m=null,h.setTime(h.getTime()*1+864e5)}e.nweeks=v-1;e:for(var g in e.caclDates){var l=[];for(var a=0,f=e.itemList().length;a<f;a++){var t=e.token;l=e.itemList()[a].deliveries[t].dates;if(!r(l,"timestamp",e.caclDates[g].tstamp)){e.caclDates[g].enable(!1);continue e}e.caclDates[g].enable(!0)}e.caclDates[g].intervals=i(l,"timestamp",e.caclDates[g].tstamp)}}function f(t,r,i,s){var o={};o.type=t,o.token=r,o.curWeek=ko.observable(1),o.itemList=ko.observableArray([]);for(var u in i)o.itemList.push(p.items[i[u]]);o.shop=ko.observable(s),a(o),o.chosenDate=ko.observable(0),o.chosenInterval=ko.observable("none"),o.currentIntervals=ko.observableArray([]);var f=0;for(var l in o.caclDates){f++;if(o.caclDates[l].enable()){o.chosenDate(o.caclDates[l].tstamp),o.chosenInterval(o.caclDates[l].intervals[0]);for(var c in o.caclDates[l].intervals)o.currentIntervals.push(o.caclDates[l].intervals[c]);break}f==7&&(f=0,o.curWeek(o.curWeek()+1))}o.dlvrPrice=ko.computed(function(){var e=0,t=this.token;for(var n=0,r=this.itemList().length;n<r;n++){var i=this.itemList()[n].deliveries[t].price;i>e&&(e=i)}return e},o),o.totalPrice=ko.computed(function(){var e=0;for(var t=0,n=this.itemList().length;t<n;t++)e+=this.itemList()[t].total;return e+=this.dlvrPrice()*1,e},o),e.push({name:"addBox",value:"start date from model="+o.chosenDate()+" type of start date="+typeof o.chosenDate()+" and token="+o.token+" and items "+i}),n.dlvrBoxes.push(o)}function l(){n.dlvrBoxes.removeAll();for(var e in p.deliveryTypes)p.deliveryTypes[e].items.length&&f(p.deliveryTypes[e].type,p.deliveryTypes[e].token,p.deliveryTypes[e].items,p.deliveryTypes[e].shop)}function c(){n.shopsInPopup.removeAll();for(var e in p.shops)n.shopsInPopup.push(p.shops[e])}function h(e){var t=new Date(e),n=t.getMonth()+1,r=t.getDate();return t.getFullYear()+"-"+(n>9?n:"0"+n)+"-"+(r>9?r:"0"+r)}var n=this;n.cssForDate=$(".order-delivery_date").css("display"),n.stolenItems=ko.observableArray([]),p.unavailable.length,n.showForm=ko.observable(!1),n.dlvrCourierEnable=ko.observable(!1),n.dlvrShopEnable=ko.observable(!1),n.chosenBox=ko.observable(null),n.step2=ko.observable(!1),n.dlvrBoxes=ko.observableArray([]),l(),n.shopsInPopup=ko.observableArray([]),c(),n.chosenShop=ko.observable(null),n.shopButtonEnable=ko.observable(!1),n.changeWeek=function(e,t,n){if(e>0){if(t.nweeks==t.curWeek())return;t.curWeek(t.curWeek()+1)}if(e<0){if(t.curWeek()==1)return;t.curWeek(t.curWeek()-1)}},n.clickDate=function(e,t,n){if(!t.enable())return;e.chosenDate(t.tstamp),e.currentIntervals.removeAll();for(var r in t.intervals)e.currentIntervals.push(t.intervals[r]);$.inArray(e.chosenInterval(),e.currentIntervals())||e.chosenInterval(e.currentIntervals()[0])},n.clickInterval=function(e,t,n){e.chosenInterval(t)},n.deleteItem=function(e,t,r){$.get(t.deleteUrl,function(){e.itemList.remove(t),e.itemList().length||n.dlvrBoxes.remove(e);e:for(var r in p.deliveryTypes){var i=p.deliveryTypes[r];for(var s=0,o=i.items.length;s<o;s++)if(i.items[s]===t.token){i.items.splice(s,1);break e}}n.dlvrBoxes().length||document.location.reload()})},n.totalSum=ko.computed(function(){var e=0;for(var t=0,r=n.dlvrBoxes().length;t<r;t++)e+=n.dlvrBoxes()[t].totalPrice()*1;return e},this),n.pickCourier=function(){l(),n.step2(!0),n.shopButtonEnable(!1);var e={type:"courier",boxQuantity:n.dlvrBoxes().length};PubSub.publish("DeliveryChanged",e)},n.pickShops=function(){n.step2(!1),n.shopButtonEnable(!0);var e={type:"shops",boxQuantity:n.dlvrBoxes().length};PubSub.publish("DeliveryChanged",e)},n.showShopPopup=function(e,t,r){n.chosenBox(e);var i=[];for(var s=0,o=e.itemList().length;s<o;s++){var u=e.itemList()[s].deliveries;for(var a in u)a.match("self_")&&i.push(a.replace("self_","")*1)}c();for(var s=0;s<n.shopsInPopup().length;)$.inArray(n.shopsInPopup()[s].id,i)===-1?n.shopsInPopup.remove(n.shopsInPopup()[s]):s++},n.showAllShops=function(){n.shopsInPopup.removeAll();for(var e in p.shops)n.shopsInPopup.push(p.shops[e])},n.selectShop=function(e){if(n.step2()){var t=[{shop:n.chosenBox().token.replace("self_",""),items:[]},{shop:e.id,items:[]}];e:for(var r=0,i=n.chosenBox().itemList();r<i.length;){for(var s in i[r].deliveries)if(s==="self_"+e.id){t[1].items.push(i[r].token),n.chosenBox().itemList.remove(i[r]);continue e}t[0].items.push(i[r].token),n.chosenBox().itemList.remove(i[r]),r++}for(var o in t)if(t[o].items.length>0){var u=p.shops[t[o].shop];f("self","self_"+t[o].shop,t[o].items,u)}n.chosenBox().itemList().length||n.dlvrBoxes.remove(n.chosenBox())}else{var a=[{shop:e.id,items:[]}];for(var l in n.dlvrBoxes()){var c=n.dlvrBoxes()[l];for(var r=0;r<c.itemList().length;)"self_"+e.id in c.itemList()[r].deliveries?(c.itemList()[r].deliveries["self_"+e.id].dates.length>1?a[0].items.push(c.itemList()[r].token):a.push({shop:e.id,items:[c.itemList()[r].token]}),c.itemList.remove(c.itemList()[r])):r++}var h={},d=[];for(var l in n.dlvrBoxes()){var c=n.dlvrBoxes()[l];for(var r=0,v=c.itemList();r<v.length;){d=[];for(b in v[r].deliveries)v[r].deliveries[b].token.match("self_")&&d.push(v[r].deliveries[b].token.replace("self_",""));h[v[r].token+""]=d,d.length?c.itemList.remove(c.itemList()[r]):r++}}var t=m(h);for(var g=0,y=a.length;g<y;g++)a[g].items.length>0&&t.push(a[g]);for(var b in t){var u=p.shops[t[b].shop];f("self","self_"+t[b].shop,t[b].items,u)}for(var l=0;l<n.dlvrBoxes().length;)n.dlvrBoxes()[l].itemList().length?l++:n.dlvrBoxes.remove(n.dlvrBoxes()[l]);n.shopButtonEnable(!1);var h={type:"shops",boxQuantity:n.dlvrBoxes().length};for(var l in n.dlvrBoxes())if(n.dlvrBoxes()[l].type==="standart"){h.type="courier";break}PubSub.publish("DeliveryChanged",h)}n.chosenShop(e),n.step2(!0),PubSub.publish("ShopSelected",e)},n.printDate=function(e){var t=new Date(e),n=["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"];return t.getDate()+" "+n[t.getMonth()]},n.getServerModel=function(){var t={deliveryTypes:{}};for(var r in n.dlvrBoxes()){var i=n.dlvrBoxes()[r],s={id:p.deliveryTypes[i.token].id,token:i.token,type:i.type,date:h(i.chosenDate()),interval:i.chosenInterval().match(/\d{2}:\d{2}/g).join(","),shop:{id:i.token.replace("self_","")}},o=[];for(var u in i.itemList())o.push(i.itemList()[u].token);s.items=o;var a="chosenDate="+i.chosenDate()+" typeCD="+typeof i.chosenDate()+" formateDate="+h(i.chosenDate())+" typeFD="+typeof h(i.chosenDate());e.push({name:"getServerModel",value:a}),t.deliveryTypes[i.token+"_"+h(i.chosenDate())+"_"+i.itemList()[0].id]=s}return t},n.showForm(!0);var d=(new Date).getTime(),v=d-startTime;t.push(["_trackTiming","New order","JS response",v]);for(var g in p.deliveryTypes)p.deliveryTypes[g].type==="standart"?n.dlvrCourierEnable(!0):n.dlvrShopEnable(!0);n.dlvrCourierEnable()&&!n.dlvrShopEnable()&&n.pickCourier(),!n.dlvrCourierEnable()&&n.dlvrShopEnable()&&n.pickShops()}function v(e){var t=0,n="none";for(var r in e)e[r].length>t&&(t=e[r].length,n=r);return n}function m(e){var t=[];for(;;){var n={},r=0;for(var i in e)for(var s=0,o=e[i].length;s<o;s++)n[e[i][s]]?n[e[i][s]].push(i):(n[e[i][s]]=[i],r++);if(!r)break;var u=v(n);t.push({shop:u,items:n[u]});for(var i in n[u])e[n[u][i]]=[]}return t}function w(e,t){b++,$("body").delegate('input[name="'+e+'"]',"change",function(){if($(this).val().replace(/\s+/g,"")!=""){b--,$('input[name="'+e+'"]').removeClass("mRed"),$('input[name="'+e+'"]').prev(".placeholder").removeClass("mRed");var t=$('input[name="'+e+'"]').closest(".bBuyingLine");t.find(".mRed").length||t.find(".bFormError").remove()}});var n=$('input[name="'+e+'"]:first');if(n.hasClass("mRed"))return;switch(n.attr("type")){case"text":n.addClass("mRed"),n.prev(".placeholder").addClass("mRed");var r=n.parent().parent();r.find(".bFormError").length||r.append('<span class="bFormError mb10 pt5">'+t+"</span>");break;default:n.addClass("mRed"),n.prev(".placeholder").addClass("mRed"),n.parent().parent().parent().append('<span class="bFormError mb10 pt5">'+t+"</span>")}}function E(e){for(var t in e)w(t,e[t]);b>0&&$.scrollTo(".mRed:first",500)}function T(){var e={};for(var t in MVM.shopsInPopup())e[MVM.shopsInPopup()[t].id]=MVM.shopsInPopup()[t];return e}function C(e){x.html(tmpl("mapInfoBlock",e)),N.id=e.id}function k(e){var t=$(e).parent().find(".shopnum").text(),n=p.shops[t];MVM.selectShop(n)}function L(e,t){MapInterface.ready(e,{yandex:$("#mapInfoBlock"),google:$("#map-info_window-container")});var n=calcMCenter(t),r=function(){window.regionMap.showMarkers(t),window.regionMap.addHandler(".shopchoose",k)};MapInterface.init(n,"mapPopup",r,C)}var e=[],t=window._gaq||[];$("body").delegate(".bSelect","click",function(){if($(this).hasClass("mDisabled"))return!1;$(this).find(".bSelect__eDropmenu").toggle()}),$("body").delegate(".bSelect","mouseleave",function(){if($(this).hasClass("mDisabled"))return!1;var e=$(this).find(".bSelect__eDropmenu");e.is(":visible")&&e.hide()}),$("body").delegate(".bBuyingLine label","click",function(){if($(this).find("input").attr("type")=="radio"){var e=$('.mChecked input[name="'+$(this).find("input").attr("name")+'"]');e.length&&e.each(function(e,t){$(t).parent("label").removeClass("mChecked")}),$(this).addClass("mChecked");return}$(this).find("input").attr("type")=="checkbox"&&$(this).toggleClass("mChecked")}),$("body").delegate(".bBuyingLine input:radio, .bBuyingLine input:checkbox","click",function(e){e.stopPropagation()}),$("body").delegate('input[name="order[payment_method_id]"]',"click",function(){$(".innerType").hide(),$(this).parent().parent().find(".innerType").show()});if($(".orderFinal__certificate").length){var n=$(".cardNumber"),r=$(".cardPin"),i=$("#sertificateFields"),s="/certificate-check",o=function(){function u(){return n.val().replace(/[^0-9]/g,"")}function a(){return r.val().replace(/[^0-9]/g,"")}function f(){return{code:u(),pin:a()}}function l(){return t&&u()!==""&&u().length===14&&a()!==""&&a().length===4?!0:!1}function c(){h("orange","Проверка по номеру карты"),$.post(s,f(),function(e){if(!1 in e)return!1;if(!e.success){var t=typeof e.error!="undefined"?e.error:"ERROR";return h("red",t),!1}h("green",e.data)})}function h(e,n){var r=$(".process").first();r.hasClass("picked")||r.remove();var s={typeNum:e};switch(e){case"orange":s.text=n,t=!1;break;case"red":s.text="Произошла ошибка: "+n,t=!1;break;case"green":"activated"in n?s.text="Карта "+n.code+" на сумму "+n.sum+" активирована!":s.text="Карта "+n.code+" имеет номинал "+n.sum,t=!0}i.after(tmpl(o,s)),typeof n["activated"]!="undefined"&&$(".process").first().addClass("picked")}var e=$("#paymentWithCard").text()*1,t=!1,o="processBlock";return{checkCard:c,setProcessingStatus:h,isActive:l,getCode:u,getPIN:a}}();n.bind("keyup",function(e){if(e.which>=48&&e.which<=57||e.which==8)r.val().length==4&&o.checkCard();else{var t=$(this).val().replace(/\D/g,"");$(this).val(t)}}),r.mask("9999",{completed:o.checkCard,placeholder:"*"})}if($(".bankWrap").length){var u=$(".bankWrap > .bSelect").data("value"),a=$(".bankWrap > .creditHref"),f=$("<div>").addClass("bSelect__eDropmenu");for(var l in u){var c=$("<div>").attr("ref",l).append($("<span>").text(u[l].name));c.click(function(){var e=$(this).attr("ref");$(".bankWrap > .bSelect").find("span:first").text(u[e].name),$('input[name="order[credit_bank_id]"]').val(e),a.find("a").attr("href",u[e].href),a.find("span").text("("+u[e].name+")")}),f.append(c)}$(".bankWrap > .bSelect").append(f),DirectCredit.init($("#tsCreditCart").data("value"),$("#creditPrice"))}PubSub.subscribe("authorize",function(e,t){$("#order_recipient_first_name").val(t.first_name),$("#order_recipient_last_name").val(t.last_name),$("#order_recipient_phonenumbers").val(t.phonenumber+""),$("#user-block").hide()}),$(".auth-link").bind("click",function(e){e.preventDefault();var t=$(this);$("#login-form, #register-form").data("redirect",!1),$("#auth-block").lightbox_me({centered:!0,onLoad:function(){$("#auth-block").find("input:first").focus()}})}),$("#order_recipient_phonenumbers").focusin(function(){$(this).attr("maxlength","10"),$(this).bind("keyup",function(e){if(!(e.which>=48&&e.which<=57||e.which==8)){var t=$(this).val().replace(/\D/g,"");$(this).val(t)}})}),typeof $.mask!="undefined"&&($.mask.definitions["*"]="[0-9*]",$("#order_sclub_card_number").mask("* ****** ******",{placeholder:"*"}),$("#order_sclub_card_number")[0].getAttribute("value")&&$("#order_sclub_card_number").val($("#order_sclub_card_number")[0].getAttribute("value")),$("#order_sclub_card_number").blur(function(){$(this).val()==="* ****** ******"&&($(this).trigger("unmask").val(""),$(this).focus(function(){$("#order_sclub_card_number").mask("* ****** ******",{placeholder:"*"})}))})),$(".placeholder-input").focus(function(e){var t=$(e.target);t.prev(".placeholder").hasClass("mRed")||t.prev(".placeholder").css("border-color","#FFA901")}).focusout(function(e){var t=$(e.target);t.prev(".placeholder").hasClass("mRed")||t.prev(".placeholder").css("border-color","#DDDDDD")}),$(".placeholder").click(function(e){$(this).next(".placeholder-input").focus()});var h=[];$("#metrostations")!=="undefined"&&(h=$("#metrostations").data("name")),$("#order_address_metro").autocomplete({source:h,appendTo:"#metrostations",minLength:2,select:function(e,t){$("#order_subway_id").val(t.item.val)}}).change(function(){for(var e=0,t=h.length;e<t;e++)if($(this).val()===h[e].label)return!0;$(this).val("")}),window.blockScreen=function(e){$('<img src="/images/ajaxnoti.gif" />').css("display","none").appendTo("body");var t=$("<div>").addClass("noti").html('<div><img src="/images/ajaxnoti.gif" /></br></br> '+e+"</div>");t.appendTo("body"),this.block=function(){t.is(":hidden")&&t.lightbox_me({centered:!0,closeClick:!1,closeEsc:!1})},this.unblock=function(){t.trigger("close")},this.bye=function(){t.find("img").remove()}},Blocker=new blockScreen("Ваш заказ оформляется"),PubSub.subscribe("DeliveryChanged",function(e,t){t.type==="courier"?($("#order-submit").removeClass("disable"),$("#order-form").show(),$("#addressField").show()):($("#addressField").hide(),$("#order-form").hide(),$("#order-submit").addClass("disable")),t.boxQuantity>1?($("#payTypes > div").hide(),$("#payment_method_1-field").show(),$("#payment_method_2-field").show()):$("#payTypes > div").show()}),PubSub.subscribe("ShopSelected",function(e,t){$("#orderMapPopup").trigger("close"),$("#order-form").show(),$("#order-submit").removeClass("disable")});var p=$("#order-delivery_map-data").data("value"),g=$("#order-form"),y=!1,b=0;$("#order-submit").click(function(n){b=0,n.preventDefault();if(y)return;if($(this).hasClass("disable"))return!1;var r=g.serializeArray(),i=$("#order-validator").data("value");e:for(field in i){if(!g.find('[name="'+field+'"]:visible').length)continue;if(field=="order[recipient_phonenumbers]"){var s=$("#order_recipient_phonenumbers").val();s.length<10&&w(field,"Маловато цифр")}for(var u=0,a=r.length;u<a;u++)if(r[u].name==field){r[u].value==""&&w(field,i[field]);continue e}w(field,i[field])}if(b>0){$.scrollTo(".mRed:first",500);return}var f=$(this);f.text("Оформляется..."),Blocker.block(),y=!0;var l=g.serializeArray(),c=$('label.mChecked input[name="order[delivery_type_id]"]').val();c||(c=$('input[name="order[delivery_type_id]"]').val()),l.push({name:"order[delivery_type_id]",value:c}),l.push({name:"delivery_map",value:JSON.stringify(MVM.getServerModel())}),typeof o!="undefined"&&o.isActive()&&(l.push({name:"order[card]",value:o.getCode()}),l.push({name:"order[pin]",value:o.getPIN()}));var h=(new Date).getTime();l.push(e),$.ajax({url:g.attr("action"),timeout:2e4,type:"POST",data:l,success:function(e){y=!1;if(!e.success){Blocker.unblock(),f.text("Завершить оформление"),"errors"in e&&E(e.errors);return}Blocker.bye();var n=(new Date).getTime(),r=n-h;t.push(["_trackTiming","Order complete","DB response",r]),typeof yaCounter10503055!="undefined"&&yaCounter10503055.reachGoal("orderscomplete"),"redirect"in e.data&&(window.location=e.data.redirect)},error:function(){f.text("Попробовать еще раз"),Blocker.unblock()}})}),MVM=new d,ko.applyBindings(MVM,$("#MVVM")[0]);var S=$("#mapPopup_shopInfo"),x=$("#map-info_window-container");$("#OrderView").delegate(".selectShop","click",function(){return $("#orderMapPopup").lightbox_me({centered:!0,onLoad:function(){$("#mapPopup").empty(),shops=T(),$.isEmptyObject(shops)||L("yandex",shops)}}),!1});var N={timer:null,id:0};S.delegate("li","hover",function(){var e=$(this).attr("ref");N.timer&&clearTimeout(N.timer),e&&e!=N.id&&(N.id=e,N.timer=setTimeout(function(){window.regionMap.showInfobox(e)},350))})});