$(document).ready(function(){function e(){function e(e,r,t){for(var i=0,n=e.length;n>i;i++)if(e[i][r]==t)return!0;return!1}function r(e,r,t){for(var i=[],n=0,a=e.length;a>n;n++)if(e[n][r]==t){for(var o in e[n].intervals)i.push("c "+e[n].intervals[o].start_at+" по "+e[n].intervals[o].end_at);return i}return!1}function i(e){var r=e[0];if(e.length>1)for(var t=1,i=e.length;i>t;t++)e[t][0]>r[0]&&(r[0]=e[t][0]),e[t][1]<r[1]&&(r[1]=e[t][1]);return r}function n(e){var r=new Date(e);if(1!==r.getDay()){var t=r.getDay()?1*r.getDay()-1:6;r.setTime(1*r.getTime()-1e3*60*60*24*t)}return r}function a(e){var r=new Date(e);return 0!==r.getDay()&&r.setTime(1*r.getTime()+1e3*60*60*24*(7-r.getDay())),r}function o(e){var r=1*e.substr(0,4),t=1*e.substr(5,2),i=1*e.substr(8,2),n=new Date(r,t-1,i),a=Date.parse(n);return a}function s(t){t.caclDates=[];for(var s=t.token,l=[],d=0,c=t.itemList().length;c>d;d++){for(var p in t.itemList()[d].deliveries[s].dates)t.itemList()[d].deliveries[s].dates[p].timestamp=o(t.itemList()[d].deliveries[s].dates[p].value);var u=t.itemList()[d].deliveries[s].dates;l.push([u[0],u[u.length-1]])}for(var v=i(l),h=n(v[0].timestamp),f=a(v[1].timestamp),m=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"],b=1;1*h.getTime()<=1*f.getTime();){var g={dayOfWeek:m[1*h.getDay()],day:1*h.getDate(),tstamp:1*h.getTime(),week:b,enable:ko.observable(!1)};h.getDay()||b++,t.caclDates.push(g),g=null,h.setTime(1*h.getTime()+864e5)}t.nweeks=b-1;e:for(var k in t.caclDates){for(var u=[],d=0,c=t.itemList().length;c>d;d++){var s=t.token;if(u=t.itemList()[d].deliveries[s].dates,!e(u,"timestamp",t.caclDates[k].tstamp)){t.caclDates[k].enable(!1);continue e}t.caclDates[k].enable(!0)}t.caclDates[k].intervals=r(u,"timestamp",t.caclDates[k].tstamp)}}function l(e,r,t,i){var n={};n.type=e,n.token=r,n.curWeek=ko.observable(1),n.itemList=ko.observableArray([]);for(var a in t)n.itemList.push(C.items[t[a]]);n.shop=ko.observable(i),s(n),n.chosenDate=ko.observable(0),n.chosenInterval=ko.observable("none"),n.currentIntervals=ko.observableArray([]);var o=0;for(var l in n.caclDates){if(o++,n.caclDates[l].enable()){n.chosenDate(n.caclDates[l].tstamp),n.chosenInterval(n.caclDates[l].intervals[0]);for(var d in n.caclDates[l].intervals)n.currentIntervals.push(n.caclDates[l].intervals[d]);break}7==o&&(o=0,n.curWeek(n.curWeek()+1))}n.dlvrPrice=ko.computed(function(){for(var e=0,r=this.token,t=0,i=this.itemList().length;i>t;t++){var n=this.itemList()[t].deliveries[r].price;n>e&&(e=n)}return e},n),n.totalPrice=ko.computed(function(){for(var e=0,r=0,t=this.itemList().length;t>r;r++)e+=this.itemList()[r].total;return e+=1*this.dlvrPrice()},n),v.dlvrBoxes.push(n)}function d(){v.dlvrBoxes.removeAll();for(var e in C.deliveryTypes)C.deliveryTypes[e].items.length&&l(C.deliveryTypes[e].type,C.deliveryTypes[e].token,C.deliveryTypes[e].items,C.deliveryTypes[e].shop)}function c(){v.shopsInPopup.removeAll();for(var e in C.shops)v.shopsInPopup.push(C.shops[e])}function u(e){var r=new Date(e),t=r.getMonth()+1,i=r.getDate();return r.getFullYear()+"-"+(t>9?t:"0"+t)+"-"+(i>9?i:"0"+i)}var v=this;v.cssForDate=$(".order-delivery_date").css("display"),v.stolenItems=ko.observableArray([]),C.unavailable.length,v.showForm=ko.observable(!1),v.dlvrCourierEnable=ko.observable(!1),v.dlvrShopEnable=ko.observable(!1),v.chosenBox=ko.observable(null),v.step2=ko.observable(!1),v.dlvrBoxes=ko.observableArray([]),d(),v.shopsInPopup=ko.observableArray([]),c(),v.chosenShop=ko.observable(null),v.shopButtonEnable=ko.observable(!1),v.changeWeek=function(e,r){if(e>0){if(r.nweeks==r.curWeek())return;r.curWeek(r.curWeek()+1)}if(0>e){if(1==r.curWeek())return;r.curWeek(r.curWeek()-1)}},v.clickDate=function(e,r){if(r.enable()){var t=e.chosenDate();e.chosenDate(r.tstamp);var i=e.chosenDate(),n=(i-t)/60/60/24/1e3;"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Order card","Date changed",n]),e.currentIntervals.removeAll();for(var a in r.intervals)e.currentIntervals.push(r.intervals[a]);$.inArray(e.chosenInterval(),e.currentIntervals())||e.chosenInterval(e.currentIntervals()[0])}},v.clickInterval=function(e,r){e.chosenInterval(r)},v.deleteItem=function(e,r){$.get(r.deleteUrl,function(){"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Order card","Item deleted"]),e.itemList.remove(r),e.itemList().length||v.dlvrBoxes.remove(e);e:for(var t in C.deliveryTypes)for(var i=C.deliveryTypes[t],n=0,a=i.items.length;a>n;n++)if(i.items[n]===r.token){i.items.splice(n,1);break e}v.dlvrBoxes().length||document.location.reload()})},v.totalSum=ko.computed(function(){for(var e=0,r=0,t=v.dlvrBoxes().length;t>r;r++)e+=1*v.dlvrBoxes()[r].totalPrice();return e},this),v.pickCourier=function(){p="standart",d(),v.step2(!0),v.shopButtonEnable(!1);var e={type:"courier",boxQuantity:v.dlvrBoxes().length};PubSub.publish("DeliveryChanged",e)},v.pickShops=function(){p="self",v.step2(!1),v.shopButtonEnable(!0);var e={type:"shops",boxQuantity:v.dlvrBoxes().length};PubSub.publish("DeliveryChanged",e)},v.showShopPopup=function(e){v.chosenBox(e);for(var r=[],t=0,i=e.itemList().length;i>t;t++){var n=e.itemList()[t].deliveries;for(var a in n)a.match("self_")&&r.push(1*a.replace("self_",""))}c();for(var t=0;v.shopsInPopup().length>t;)-1===$.inArray(v.shopsInPopup()[t].id,r)?v.shopsInPopup.remove(v.shopsInPopup()[t]):t++},v.showAllShops=function(){v.shopsInPopup.removeAll();for(var e in C.shops)v.shopsInPopup.push(C.shops[e])},v.selectShop=function(e){if(v.step2()){var r=[{shop:v.chosenBox().token.replace("self_",""),items:[]},{shop:e.id,items:[]}];e:for(var i=0,n=v.chosenBox().itemList();n.length>i;){for(var a in n[i].deliveries)if(a==="self_"+e.id){r[1].items.push(n[i].token),v.chosenBox().itemList.remove(n[i]);continue e}r[0].items.push(n[i].token),v.chosenBox().itemList.remove(n[i]),i++}for(var o in r)if(r[o].items.length>0){var s=C.shops[r[o].shop];l("self","self_"+r[o].shop,r[o].items,s)}v.chosenBox().itemList().length||v.dlvrBoxes.remove(v.chosenBox())}else{var d=[{shop:e.id,items:[]}];for(var c in v.dlvrBoxes())for(var p=v.dlvrBoxes()[c],i=0;p.itemList().length>i;)"self_"+e.id in p.itemList()[i].deliveries?(p.itemList()[i].deliveries["self_"+e.id].dates.length>1?d[0].items.push(p.itemList()[i].token):d.push({shop:e.id,items:[p.itemList()[i].token]}),p.itemList.remove(p.itemList()[i])):i++;var u={},h=[];for(var c in v.dlvrBoxes())for(var p=v.dlvrBoxes()[c],i=0,f=p.itemList();f.length>i;){h=[];for(g in f[i].deliveries)f[i].deliveries[g].token.match("self_")&&h.push(f[i].deliveries[g].token.replace("self_",""));u[f[i].token+""]=h,h.length?p.itemList.remove(p.itemList()[i]):i++}for(var r=t(u),m=0,b=d.length;b>m;m++)d[m].items.length>0&&r.push(d[m]);for(var g in r){var s=C.shops[r[g].shop];l("self","self_"+r[g].shop,r[g].items,s)}for(var c=0;v.dlvrBoxes().length>c;)v.dlvrBoxes()[c].itemList().length?c++:v.dlvrBoxes.remove(v.dlvrBoxes()[c]);v.shopButtonEnable(!1);var u={type:"shops",boxQuantity:v.dlvrBoxes().length};for(var c in v.dlvrBoxes())if("standart"===v.dlvrBoxes()[c].type){u.type="courier";break}PubSub.publish("DeliveryChanged",u)}v.chosenShop(e),v.step2(!0),PubSub.publish("ShopSelected",e)},v.printDate=function(e){var r=new Date(e),t=["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"];return r.getDate()+" "+t[r.getMonth()]},v.getServerModel=function(){var e={deliveryTypes:{}};for(var r in v.dlvrBoxes()){var t=v.dlvrBoxes()[r],i={id:C.deliveryTypes[t.token].id,token:t.token,type:t.type,date:u(t.chosenDate()),interval:t.chosenInterval().match(/\d{2}:\d{2}/g).join(","),shop:{id:t.token.replace("self_","")}},n=[];for(var a in t.itemList())n.push(t.itemList()[a].token);i.items=n,e.deliveryTypes[t.token+"_"+u(t.chosenDate())+"_"+t.itemList()[0].id]=i}return e},v.showForm(!0);var h=(new Date).getTime(),f=h-startTime;"undefined"!=typeof _gaq&&_gaq.push(["_trackTiming","New order","JS response",f]);for(var m in C.deliveryTypes)"standart"===C.deliveryTypes[m].type?v.dlvrCourierEnable(!0):v.dlvrShopEnable(!0);v.dlvrCourierEnable()&&!v.dlvrShopEnable()&&v.pickCourier(),!v.dlvrCourierEnable()&&v.dlvrShopEnable()&&v.pickShops()}function r(e){var r=0,t="none";for(var i in e)e[i].length>r&&(r=e[i].length,t=i);return t}function t(e){for(var t=[];;){var i={},n=0;for(var a in e)for(var o=0,s=e[a].length;s>o;o++)i[e[a][o]]?i[e[a][o]].push(a):(i[e[a][o]]=[a],n++);if(!n)break;var l=r(i);t.push({shop:l,items:i[l]});for(var a in i[l])e[i[l][a]]=[]}return t}function i(e,r){S++,$("body").delegate('input[name="'+e+'"]',"change",function(){S--,$('input[name="'+e+'"]').removeClass("mRed"),$('input[name="'+e+'"]').prev(".placeholder").removeClass("mRed");var r=$('input[name="'+e+'"]').closest(".bBuyingLine");r.find(".mRed").length||r.find(".bFormError").remove()});var t=$('input[name="'+e+'"]:first');if(!t.hasClass("mRed"))switch(t.attr("type")){case"text":t.addClass("mRed"),t.prev(".placeholder").addClass("mRed");var i=t.parent().parent();i.find(".bFormError").length||i.append('<span class="bFormError mb10 pt5">'+r+"</span>");break;default:t.addClass("mRed"),t.prev(".placeholder").addClass("mRed"),t.parent().parent().parent().append('<span class="bFormError mb10 pt5">'+r+"</span>")}}function n(e){for(var r in e)i(r,e[r]);S>0&&$.scrollTo(".mRed:first",500)}function a(){var e={};for(var r in MVM.shopsInPopup())e[MVM.shopsInPopup()[r].id]=MVM.shopsInPopup()[r];return e}function o(e){P.html(tmpl("mapInfoBlock",e)),M.id=e.id}function s(e){var r=$(e).parent().find(".shopnum").text(),t=C.shops[r];MVM.selectShop(t)}function l(e,r){MapInterface.ready(e,{yandex:$("#mapInfoBlock"),google:$("#map-info_window-container")});var t=calcMCenter(r),i=function(){window.regionMap.showMarkers(r),window.regionMap.addHandler(".shopchoose",s)};MapInterface.init(t,"mapPopup",i,o)}var d=0,c=0,p=0;if($("body").delegate(".bBuyingLine label","click",function(){if("radio"==$(this).find("input").attr("type")){var e=$('.mChecked input[name="'+$(this).find("input").attr("name")+'"]');return e.length&&e.each(function(e,r){$(r).parent("label").removeClass("mChecked")}),$(this).addClass("mChecked"),void 0}"checkbox"==$(this).find("input").attr("type")&&$(this).toggleClass("mChecked")}),$("body").delegate(".bBuyingLine input:radio, .bBuyingLine input:checkbox","click",function(e){e.stopPropagation()}),$("body").delegate('input[name="order[payment_method_id]"]',"click",function(){$(".innerType").hide(),$(this).parent().parent().find(".innerType").show()}),$(".orderFinal__certificate").length){var u=$(".cardNumber"),v=$(".cardPin"),h=$("#sertificateFields"),f="/certificate-check",m=function(){function e(){return u.val().replace(/[^0-9]/g,"")}function r(){return v.val().replace(/[^0-9]/g,"")}function t(){return{code:e(),pin:r()}}function i(){return o&&""!==e()&&14===e().length&&""!==r()&&4===r().length?!0:!1}function n(){a("orange","Проверка по номеру карты"),$.post(f,t(),function(e){if(false in e)return!1;if(!e.success){var r=e.error!==void 0?e.error:"ERROR";return a("red",r),!1}a("green",e.data)})}function a(e,r){var t=$(".process").first();t.hasClass("picked")||t.remove();var i={typeNum:e};switch(e){case"orange":i.text=r,o=!1;break;case"red":i.text="Произошла ошибка: "+r,o=!1;break;case"green":i.text="activated"in r?"Карта "+r.code+" на сумму "+r.sum+" активирована!":"Карта "+r.code+" имеет номинал "+r.sum,o=!0}h.after(tmpl(s,i)),r.activated!==void 0&&$(".process").first().addClass("picked")}var o=(1*$("#paymentWithCard").text(),!1),s="processBlock";return{checkCard:n,setProcessingStatus:a,isActive:i,getCode:e,getPIN:r}}();u.bind("keyup",function(e){if(e.which>=48&&57>=e.which||8==e.which)4==v.val().length&&m.checkCard();else{var r=$(this).val().replace(/\D/g,"");$(this).val(r)}}),v.mask("9999",{completed:m.checkCard,placeholder:"*"})}if($(".bankWrap").length){var b=$(".bankWrap .bSelect").data("value"),g=$(".bankWrap > .creditHref"),k=$(".bankWrap .bSelect"),y=function(){var e=$("option:selected",k).attr("ref");$(".bankWrap .bSelectWrap_eText").text(b[e].name),$('input[name="order[credit_bank_id]"]').val(e),g.find("a").attr("href",b[e].href),g.find("span").text("("+b[e].name+")")};for(var _ in b){var x=$("<option>").attr("ref",_).addClass("bSelect_eItem").text(b[_].name);k.append(x)}$("option",k).eq(0).attr("selected","selected"),y(),k.change(y),DirectCredit.init($("#tsCreditCart").data("value"),$("#creditPrice"))}PubSub.subscribe("authorize",function(e,r){$("#order_recipient_first_name").val(r.first_name),$("#order_recipient_last_name").val(r.last_name),$("#order_recipient_phonenumbers").val(r.phonenumber+""),$("#user-block").hide()}),$(".auth-link").bind("click",function(e){e.preventDefault(),$(this),$("#login-form, #register-form").data("redirect",!1),$("#auth-block").lightbox_me({centered:!0,onLoad:function(){$("#auth-block").find("input:first").focus()}})}),$.mask!==void 0&&($("#order_recipient_phonenumbers").mask("(999) 999-99-99"),$("#order_recipient_phonenumbers").val($("#order_recipient_phonenumbers").val()),$.mask.definitions["*"]="[0-9*]",$("#order_sclub_card_number").mask("* ****** ******",{placeholder:"*"}),$("#order_sclub_card_number")[0].getAttribute("value")&&$("#order_sclub_card_number").val($("#order_sclub_card_number")[0].getAttribute("value")),$("#order_sclub_card_number").blur(function(){"* ****** ******"===$(this).val()&&($(this).trigger("unmask").val(""),$(this).focus(function(){$("#order_sclub_card_number").mask("* ****** ******",{placeholder:"*"})}))})),$(".placeholder-input").focus(function(e){var r=$(e.target);r.prev(".placeholder").hasClass("mRed")||r.prev(".placeholder").css("border-color","#FFA901")}).focusout(function(e){var r=$(e.target);r.prev(".placeholder").hasClass("mRed")||r.prev(".placeholder").css("border-color","#DDDDDD")}),$(".placeholder").click(function(){$(this).next(".placeholder-input").focus()});var D=[];if($("#metrostations").length&&(D=$("#metrostations").data("name"),$("#order_subway_id").val().length)){var w=1*$("#order_subway_id").val();for(var B in D)1*D[B].val==w&&$("#order_address_metro").val(D[B].label)}$("#order_address_metro").autocomplete({source:D,appendTo:"#metrostations",minLength:2,select:function(e,r){$("#order_subway_id").val(r.item.val)}}).change(function(){for(var e=0,r=D.length;r>e;e++)if($(this).val()===D[e].label)return!0;$(this).val("")}),window.blockScreen=function(e){$('<img src="/images/ajaxnoti.gif" />').css("display","none").appendTo("body");var r=$("<div>").addClass("noti").html('<div><img src="/images/ajaxnoti.gif" /></br></br> '+e+"</div>");r.appendTo("body"),this.block=function(){r.is(":hidden")&&r.lightbox_me({centered:!0,closeClick:!1,closeEsc:!1})},this.unblock=function(){r.trigger("close")},this.bye=function(){r.find("img").remove()}},Blocker=new blockScreen("Ваш заказ оформляется"),PubSub.subscribe("DeliveryChanged",function(e,r){"courier"===r.type?($("#order-submit").removeClass("disable"),$("#order-form").show(),$("#addressField").show()):($("#addressField").hide(),$("#order-form").hide(),$("#order-submit").addClass("disable")),r.boxQuantity>1?($("#payTypes > div").hide(),$("#payment_method_1-field").show(),$("#payment_method_2-field").show()):$("#payTypes > div").show()}),PubSub.subscribe("ShopSelected",function(){$("#orderMapPopup").trigger("close"),$("#order-form").show(),$("#order-submit").removeClass("disable")});var C=$("#order-delivery_map-data").data("value");"undefined"!=typeof _gaq&&($.each(C.items,function(e,r){d+=r.quantity}),_gaq.push(["_trackEvent","New order","Items",d]));var T=$("#order-form"),L=!1,S=0;$("#order-submit").click(function(e){if(S=0,e.preventDefault(),!L){if($(this).hasClass("disable"))return!1;var r=T.serializeArray(),t=$("#order-validator").data("value");e:for(field in t)if(T.find('[name="'+field+'"]:visible').length){if("order[recipient_phonenumbers]"==field){var a=$("#order_recipient_phonenumbers").val();10>a.length&&i(field,"Маловато цифр")}if("order[recipient_email]"==field){var o=$("#order_recipient_email").val();o.length>0&&-1==o.search("@")&&i(field,"Некорректный e-mail")}for(var s=0,l=r.length;l>s;s++)if(r[s].name==field){""==r[s].value&&"order[recipient_email]"!=field&&i(field,t[field]);continue e}i(field,t[field])}if(S>0)return $.scrollTo(".mRed:first",500),void 0;var u=$(this);u.text("Оформляется..."),Blocker.block(),L=!0;var v=T.serializeArray(),h=$('label.mChecked input[name="order[delivery_type_id]"]').val();h||(h=$('input[name="order[delivery_type_id]"]').val()),v.push({name:"order[delivery_type_id]",value:h}),v.push({name:"delivery_map",value:JSON.stringify(MVM.getServerModel())}),m!==void 0&&m.isActive()&&(v.push({name:"order[card]",value:m.getCode()}),v.push({name:"order[pin]",value:m.getPIN()}));var f=(new Date).getTime();$.ajax({url:T.attr("action"),timeout:12e4,type:"POST",data:v,success:function(e){if(L=!1,!e.success)return Blocker.unblock(),u.text("Завершить оформление"),"errors"in e&&n(e.errors),void 0;if(Blocker.bye(),"undefined"!=typeof _gaq){for(var r in MVM.getServerModel().deliveryTypes){var t="выбрана "+p+" доставят "+MVM.getServerModel().deliveryTypes[r].type;_gaq.push(["_trackEvent","Order card","Completed",t]),c++}_gaq.push(["_trackEvent","Order complete",c,d]);var i=(new Date).getTime(),a=i-f;_gaq.push(["_trackTiming","Order complete","DB response",a])}"undefined"!=typeof yaCounter10503055&&yaCounter10503055.reachGoal("orderscomplete"),"redirect"in e.data&&(window.location=e.data.redirect)},error:function(){u.text("Попробовать еще раз"),Blocker.unblock(),L=!1}})}}),MVM=new e,ko.applyBindings(MVM,$("#MVVM")[0]);var I=$("#mapPopup_shopInfo"),P=$("#map-info_window-container");$("#OrderView").delegate(".selectShop","click",function(){return $("#orderMapPopup").lightbox_me({centered:!0,onLoad:function(){$("#mapPopup").empty(),shops=a(),$.isEmptyObject(shops)||l("yandex",shops)}}),!1});var M={timer:null,id:0};I.delegate("li","hover",function(){var e=$(this).attr("ref");M.timer&&clearTimeout(M.timer),e&&e!=M.id&&(M.id=e,M.timer=setTimeout(function(){window.regionMap.showInfobox(e)},350))})});