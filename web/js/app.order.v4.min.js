$(document).ready(function(){var o,p;function t(a,e){q++;$("body").delegate('input[name="'+a+'"]',"change",function(){if(""!=$(this).val().replace(/\s+/g,"")){q--;$('input[name="'+a+'"]').removeClass("mRed");$('input[name="'+a+'"]').prev(".placeholder").removeClass("mRed");var e=$('input[name="'+a+'"]').closest(".bBuyingLine");e.find(".mRed").length||e.find(".bFormError").remove()}});var h=$('input[name="'+a+'"]:first');if(!h.hasClass("mRed"))switch(h.attr("type")){case "text":h.addClass("mRed");
h.prev(".placeholder").addClass("mRed");h=h.parent().parent();h.find(".bFormError").length||h.append('<span class="bFormError mb10 pt5">'+e+"</span>");break;default:h.addClass("mRed"),h.prev(".placeholder").addClass("mRed"),h.parent().parent().parent().append('<span class="bFormError mb10 pt5">'+e+"</span>")}}function x(){var a={},e;for(e in MVM.shopsInPopup())a[MVM.shopsInPopup()[e].id]=MVM.shopsInPopup()[e];return a}$("body").delegate(".bSelect","click",function(){if($(this).hasClass("mDisabled"))return!1;
$(this).find(".bSelect__eDropmenu").toggle()});$("body").delegate(".bSelect","mouseleave",function(){if($(this).hasClass("mDisabled"))return!1;var a=$(this).find(".bSelect__eDropmenu");a.is(":visible")&&a.hide()});$("body").delegate(".bBuyingLine label","click",function(){if("radio"==$(this).find("input").attr("type")){var a=$('.mChecked input[name="'+$(this).find("input").attr("name")+'"]');a.length&&a.each(function(a,h){$(h).parent("label").removeClass("mChecked")});$(this).addClass("mChecked")}else"checkbox"==
$(this).find("input").attr("type")&&$(this).toggleClass("mChecked")});$("body").delegate(".bBuyingLine input:radio, .bBuyingLine input:checkbox","click",function(a){a.stopPropagation()});$("body").delegate('input[name="order[payment_method_id]"]',"click",function(){"order_payment_method_id_6"===this.id?$("#creditInfo").show():$("#creditInfo").hide()});if($(".bankWrap").length){var n=$(".bankWrap > .bSelect").data("value"),y=$(".bankWrap > .creditHref"),i=$("<div>").addClass("bSelect__eDropmenu"),
u;for(u in n){var z=$("<div>").attr("ref",u).append($("<span>").text(n[u].name));z.click(function(){var a=$(this).attr("ref");$(".bankWrap > .bSelect").find("span:first").text(n[a].name);$('input[name="order[credit_bank_id]"]').val(a);y.find("a").attr("href",n[a].href);y.find("span").text("("+n[a].name+")")});i.append(z)}$(".bankWrap > .bSelect").append(i);DirectCredit.init($("#tsCreditCart").data("value"),$("#creditPrice"))}PubSub.subscribe("authorize",function(a,e){$("#order_recipient_first_name").val(e.first_name);
$("#order_recipient_last_name").val(e.last_name);$("#order_recipient_phonenumbers").val(e.phonenumber+"       ");$("#user-block").hide()});$(".auth-link").bind("click",function(a){a.preventDefault();$(this);$("#login-form, #register-form").data("redirect",!1);$("#auth-block").lightbox_me({centered:!0,onLoad:function(){$("#auth-block").find("input:first").focus()}})});if("undefined"!==typeof $.mask)$.mask.definitions.n="[()0-9 -]",$("#order_recipient_phonenumbers").mask("8nnnnnnnnnnnnnnnnn",{placeholder:" ",
maxlength:10}),(i=document.getElementById("order_recipient_phonenumbers").getAttribute("value"))&&""!=i?$("#order_recipient_phonenumbers").val(i+"       "):$("#order_recipient_phonenumbers").val("8"),$.mask.definitions["*"]="[0-9*]",$("#order_sclub_card_number").mask("* ****** ******",{placeholder:"*"}),$("#order_sclub_card_number")[0].getAttribute("value")&&$("#order_sclub_card_number").val($("#order_sclub_card_number")[0].getAttribute("value")),$("#order_sclub_card_number").blur(function(){"* ****** ******"===
$(this).val()&&($(this).trigger("unmask").val(""),$(this).focus(function(){$("#order_sclub_card_number").mask("* ****** ******",{placeholder:"*"})}))});$(".placeholder-input").focus(function(a){a=$(a.target);a.prev(".placeholder").hasClass("mRed")||a.prev(".placeholder").css("border-color","#FFA901")}).focusout(function(a){a=$(a.target);a.prev(".placeholder").hasClass("mRed")||a.prev(".placeholder").css("border-color","#DDDDDD")});$(".placeholder").click(function(){$(this).next(".placeholder-input").focus()});
var v="Авиамоторная,Автозаводская,Академическая,Александровский сад,Алексеевская,Алтуфьево,Аннино,Арбатская (Арбатско-Покровская линия),Арбатская (Филевская линия,Аэропорт,Бабушкинская,Багратионовская,Баррикадная,Бауманская,Беговая,Белорусская,Беляево,Бибирево,Библиотека имени Ленина,Битцевский парк,Борисовская,Боровицкая,Ботанический сад,Братиславская,Бульвар адмирала Ушакова,Бульвар Дмитрия Донского,Бунинская аллея,Варшавская,ВДНХ,Владыкино,Водный стадион,Войковская,Волгоградский проспект,Волжская,Волоколамская,Воробьевы горы,Выставочная,Выхино,Деловой центр,Динамо,Дмитровская,Добрынинская,Домодедовская,Достоевская,Дубровка,Жулебино,Зябликово,Измайловская,Калужская,Кантемировская,Каховская,Каширская,Киевская,Китай-город,Кожуховская,Коломенская,Комсомольская,Коньково,Красногвардейская,Краснопресненская,Красносельская,Красные ворота,Крестьянская застава,Кропоткинская,Крылатское,Кузнецкий мост,Кузьминки,Кунцевская,Курская,Кутузовская,Ленинский проспект,Лубянка,Люблино,Марксистская,Марьина роща,Марьино,Маяковская,Медведково,Международная,Менделеевская,Митино,Молодежная,Мякинино,Нагатинская,Нагорная,Нахимовский проспект,Новогиреево,Новокузнецкая,Новослободская,Новоясеневская,Новые Черемушки,Октябрьская,Октябрьское поле,Орехово,Отрадное,Охотныйряд,Павелецкая,Парк культуры,Парк Победы,Партизанская,Первомайская,Перово,Петровско-Разумовская,Печатники,Пионерская,Планерная,Площадь Ильича,Площадь Революции,Полежаевская,Полянка,Пражская,Преображенская площадь,Пролетарская,Проспект Вернадского,Проспект Мира,Профсоюзная,Пушкинская,Речной вокзал,Рижская,Римская,Рязанский проспект,Савеловская,Свиблово,Севастопольская,Семеновская,Серпуховская,Славянский бульвар,Смоленская (Арбатско-Покровская линия),Смоленская (Филевская линия),Сокол,Сокольники,Спортивная,Сретенский бульвар,Строгино,Студенческая,Сухаревская,Сходненская,Таганская,Тверская,Театральная,Текстильщики,ТеплыйСтан,Тимирязевская,Третьяковская,Трубная,Тульская,Тургеневская,Тушинская,Улица 1905года,Улица Академика Янгеля,Улица Горчакова,Улица Подбельского,Улица Скобелевская,Улица Старокачаловская,Университет,Филевский парк,Фили,Фрунзенская,Царицыно,Цветной бульвар,Черкизовская,Чертановская,Чеховская,Чистые пруды,Чкаловская,Шаболовская,Шипиловская,Шоссе Энтузиастов,Щелковская,Щукинская,Электрозаводская,Юго-Западная,Южная,Ясенево".split(",");
$("#order_address_metro").autocomplete({source:v,appendTo:"#metrostations",minLength:2}).change(function(){for(var a=0,e=v.length;a<e;a++)if($(this).val()===v[a])return!0;$(this).val("")});window.blockScreen=function(a){$('<img src="/images/ajaxnoti.gif" />').css("display","none").appendTo("body");var e=$("<div>").addClass("noti").html('<div><img src="/images/ajaxnoti.gif" /></br></br> '+a+"</div>");e.appendTo("body");this.block=function(){e.is(":hidden")&&e.lightbox_me({centered:!0,closeClick:!1,
closeEsc:!1})};this.unblock=function(){e.trigger("close")};this.bye=function(){e.find("img").remove()}};Blocker=new blockScreen("Ваш заказ оформляется");PubSub.subscribe("DeliveryChanged",function(a,e){"courier"===e.type?($("#order-submit").removeClass("disable"),$("#order-form").show(),$("#addressField").show()):($("#addressField").hide(),$("#order-form").hide(),$("#order-submit").addClass("disable"));1<e.boxQuantity?($("#payTypes > div").hide(),$("#payment_method_1-field").show(),$("#payment_method_2-field").show()):
$("#payTypes > div").show()});PubSub.subscribe("ShopSelected",function(){$(".mMapPopup").trigger("close");$("#order-form").show();$("#order-submit").removeClass("disable")});var k=$("#order-delivery_map-data").data("value"),r=$("#order-form"),w=!1,q=0;$("#order-submit").click(function(a){a.preventDefault();if(!w){if($(this).hasClass("disable"))return!1;var a=r.serializeArray(),e=$("#order-validator").data("value");a:for(field in e)if(r.find('[name="'+field+'"]:visible').length){for(var h=0,k=a.length;h<
k;h++)if(a[h].name==field){""==a[h].value&&t(field,e[field]);continue a}t(field,e[field])}if(0<q)$.scrollTo(".mRed:first",500);else{var i=$(this);i.text("Оформляется...");Blocker.block();w=!0;a=r.serializeArray();(e=$('label.mChecked input[name="order[delivery_type_id]"]').val())||(e=$('input[name="order[delivery_type_id]"]').val());a.push({name:"order[delivery_type_id]",value:e});a.push({name:"delivery_map",value:JSON.stringify(MVM.getServerModel())});$.ajax({url:r.attr("action"),timeout:2E4,type:"POST",
data:a,success:function(b){w=!1;if(b.success){if(Blocker.bye(),"redirect"in b.data)window.location=b.data.redirect}else if(Blocker.unblock(),i.text("Завершить оформление"),"errors"in b){var b=b.errors,a;for(a in b)t(a,b[a]);0<q&&$.scrollTo(".mRed:first",500)}},error:function(){i.text("Попробовать еще раз");Blocker.unblock()}})}}});MVM=new function(){function a(b){b.caclDates=[];for(var a=b.token,c=[],g=0,d=b.itemList().length;g<d;g++){var f=b.itemList()[g].deliveries[a].dates;c.push([f[0],f[f.length-
1]])}g=c[0];if(1<c.length){f=1;for(d=c.length;f<d;f++)c[f][0]>g[0]&&(g[0]=c[f][0]),c[f][1]<g[1]&&(g[1]=c[f][1])}f=new Date(g[0].timestamp);1!==f.getDay()&&(c=f.getDay()?f.getDay()-1:6,f.setTime(1*f.getTime()-864E5*c));c=new Date(g[1].timestamp);0!==c.getDay()&&c.setTime(1*c.getTime()+864E5*(7-c.getDay()));g="Вс,Пн,Вт,Ср,Чт,Пт,Сб".split(",");for(d=1;f.getTime()<=c.getTime();)a={dayOfWeek:g[f.getDay()],day:f.getDate(),tstamp:1*f.getTime(),week:d,enable:ko.observable(!1)},f.getDay()||d++,b.caclDates.push(a),
f.setTime(1*f.getTime()+864E5);b.nweeks=d-1;var e;a:for(e in b.caclDates){f=[];g=0;for(d=b.itemList().length;g<d;g++){a=b.token;f=b.itemList()[g].deliveries[a].dates;b:{c=0;for(a=f.length;c<a;c++)if(f[c].timestamp==b.caclDates[e].tstamp){c=!0;break b}c=!1}if(!c){b.caclDates[e].enable(!1);continue a}b.caclDates[e].enable(!0)}c=b.caclDates[e];b:{for(var g=b.caclDates[e].tstamp,d=[],a=0,h=f.length;a<h;a++)if(f[a].timestamp==g){for(var m in f[a].intervals)d.push("c "+f[a].intervals[m].start_at+" по "+
f[a].intervals[m].end_at);f=d;break b}f=!1}c.intervals=f}}function e(s,j,c,g){var d={};d.type=s;d.token=j;d.curWeek=ko.observable(1);d.itemList=ko.observableArray([]);for(var f in c)d.itemList.push(k.items[c[f]]);d.shop=ko.observable(g);a(d);d.chosenDate=ko.observable(0);d.chosenInterval=ko.observable("none");d.currentIntervals=ko.observableArray([]);for(var e in d.caclDates)if(d.caclDates[e].enable()){d.chosenDate(d.caclDates[e].tstamp);d.chosenInterval(d.caclDates[e].intervals[0]);for(var h in d.caclDates[e].intervals)d.currentIntervals.push(d.caclDates[e].intervals[h]);
break}d.dlvrPrice=ko.computed(function(){for(var b=0,c=this.token,a=0,d=this.itemList().length;a<d;a++){var s=this.itemList()[a].deliveries[c].price;s>b&&(b=s)}return b},d);d.totalPrice=ko.computed(function(){for(var b=0,c=0,a=this.itemList().length;c<a;c++)b+=this.itemList()[c].total;return b+=1*this.dlvrPrice()},d);b.dlvrBoxes.push(d)}function h(){b.dlvrBoxes.removeAll();for(var a in k.deliveryTypes)k.deliveryTypes[a].items.length&&e(k.deliveryTypes[a].type,k.deliveryTypes[a].token,k.deliveryTypes[a].items,
k.deliveryTypes[a].shop)}function i(){b.shopsInPopup.removeAll();for(var a in k.shops)b.shopsInPopup.push(k.shops[a])}function n(b){var b=new Date(b),a=b.getMonth()+1,c=b.getDate();return b.getFullYear()+"-"+(9<a?a:"0"+a)+"-"+(9<c?c:"0"+c)}var b=this;b.cssForDate=$(".order-delivery_date").css("display");console.info(b.cssForDate);b.stolenItems=ko.observableArray([]);b.showForm=ko.observable(!1);b.dlvrCourierEnable=ko.observable(!1);b.dlvrShopEnable=ko.observable(!1);b.chosenBox=ko.observable(null);
b.step2=ko.observable(!1);b.dlvrBoxes=ko.observableArray([]);h();b.shopsInPopup=ko.observableArray([]);i();b.chosenShop=ko.observable(null);b.shopButtonEnable=ko.observable(!1);b.changeWeek=function(b,a){if(0<b){if(a.nweeks==a.curWeek())return;a.curWeek(a.curWeek()+1)}0>b&&1!=a.curWeek()&&a.curWeek(a.curWeek()-1)};b.clickDate=function(b,a){if(a.enable()){b.chosenDate(a.tstamp);b.currentIntervals.removeAll();for(var c in a.intervals)b.currentIntervals.push(a.intervals[c]);$.inArray(b.chosenInterval(),
b.currentIntervals())||b.chosenInterval(b.currentIntervals()[0])}};b.clickInterval=function(b,a){b.chosenInterval(a)};b.deleteItem=function(a,e){$.get(e.deleteUrl,function(){});a.itemList.remove(e);a.itemList().length||b.dlvrBoxes.remove(a);var c;a:for(c in k.deliveryTypes)for(var g=k.deliveryTypes[c],d=0,f=g.items.length;d<f;d++)if(g.items[d]===e.token){g.items.splice(d,1);break a}b.dlvrBoxes().length||document.location.reload()};b.totalSum=ko.computed(function(){for(var a=0,e=0,c=b.dlvrBoxes().length;e<
c;e++)a+=1*b.dlvrBoxes()[e].totalPrice();return a},this);b.pickCourier=function(){h();b.step2(!0);b.shopButtonEnable(!1);var a={type:"courier",boxQuantity:b.dlvrBoxes().length};PubSub.publish("DeliveryChanged",a)};b.pickShops=function(){b.step2(!1);b.shopButtonEnable(!0);var a={type:"shops",boxQuantity:b.dlvrBoxes().length};PubSub.publish("DeliveryChanged",a)};b.showShopPopup=function(a){b.chosenBox(a);for(var e=[],c=0,g=a.itemList().length;c<g;c++){var d=a.itemList()[c].deliveries,f;for(f in d)f.match("self_")&&
e.push(f.replace("self_",""))}i();for(c=0;c<b.shopsInPopup().length;)-1===$.inArray(b.shopsInPopup()[c].id,e)?b.shopsInPopup.remove(b.shopsInPopup()[c]):c++};b.showAllShops=function(){b.shopsInPopup.removeAll();for(var a in k.shops)b.shopsInPopup.push(k.shops[a])};b.selectShop=function(a){if(b.step2()){var j=[{shop:b.chosenBox().token.replace("self_",""),items:[]},{shop:a.id,items:[]}],c=0,g=b.chosenBox().itemList();a:for(;c<g.length;){for(var d in g[c].deliveries)if(d==="self_"+a.id){j[1].items.push(g[c].token);
b.chosenBox().itemList.remove(g[c]);continue a}j[0].items.push(g[c].token);b.chosenBox().itemList.remove(g[c]);c++}for(var f in j)0<j[f].items.length&&(c=k.shops[j[f].shop],e("self","self_"+j[f].shop,j[f].items,c));b.chosenBox().itemList().length||b.dlvrBoxes.remove(b.chosenBox())}else{f=[{shop:a.id,items:[]}];for(var h in b.dlvrBoxes()){d=b.dlvrBoxes()[h];for(c=0;c<d.itemList().length;)"self_"+a.id in d.itemList()[c].deliveries?(1<d.itemList()[c].deliveries["self_"+a.id].dates.length?f[0].items.push(d.itemList()[c].token):
f.push({shop:a.id,items:[d.itemList()[c].token]}),d.itemList.remove(d.itemList()[c])):c++}var l={},m=[];for(h in b.dlvrBoxes()){d=b.dlvrBoxes()[h];for(var c=0,i=d.itemList();c<i.length;){m=[];for(g in i[c].deliveries)i[c].deliveries[g].token.match("self_")&&m.push(i[c].deliveries[g].token.replace("self_",""));l[i[c].token+""]=m;m.length?d.itemList.remove(d.itemList()[c]):c++}}c=l;for(h=[];;){d={};l=0;for(j in c){m=0;for(i=c[j].length;m<i;m++)d[c[j][m]]?d[c[j][m]].push(j):(d[c[j][m]]=[j],l++)}if(!l)break;
l=0;m="none";i=void 0;for(i in d)if(d[i].length>l)l=d[i].length,m=i;l=m;h.push({shop:l,items:d[l]});for(j in d[l])c[d[l][j]]=[]}j=h;c=0;for(h=f.length;c<h;c++)0<f[c].items.length&&j.push(f[c]);for(g in j)c=k.shops[j[g].shop],e("self","self_"+j[g].shop,j[g].items,c);for(h=0;h<b.dlvrBoxes().length;)b.dlvrBoxes()[h].itemList().length?h++:b.dlvrBoxes.remove(b.dlvrBoxes()[h]);b.shopButtonEnable(!1);l={type:"shops",boxQuantity:b.dlvrBoxes().length};for(h in b.dlvrBoxes())if("standart"===b.dlvrBoxes()[h].type){l.type=
"courier";break}PubSub.publish("DeliveryChanged",l)}b.chosenShop(a);b.step2(!0);PubSub.publish("ShopSelected",a)};b.printDate=function(a){a=new Date(a);return a.getDate()+" "+"января,февраля,марта,апреля,мая,июня,июля,августа,сентября,октября,ноября,декабря".split(",")[a.getMonth()]};b.getServerModel=function(){var a={deliveryTypes:{}},e;for(e in b.dlvrBoxes()){var c=b.dlvrBoxes()[e],g={id:k.deliveryTypes[c.token].id,token:c.token,type:c.type,date:n(c.chosenDate()),interval:c.chosenInterval().match(/\d{2}:\d{2}/g).join(","),
shop:{id:c.token.replace("self_","")}},d=[],f;for(f in c.itemList())d.push(c.itemList()[f].token);g.items=d;a.deliveryTypes[c.token+n(c.chosenDate())]=g}return a};b.showForm(!0);for(var o in k.deliveryTypes)"standart"===k.deliveryTypes[o].type?b.dlvrCourierEnable(!0):b.dlvrShopEnable(!0);b.dlvrCourierEnable()&&!b.dlvrShopEnable()&&b.pickCourier();!b.dlvrCourierEnable()&&b.dlvrShopEnable()&&b.pickShops()};ko.applyBindings(MVM,$("#MVVM")[0]);var i=$("#mapPopup_shopInfo"),A=$("#map-info_window-container");
$("#OrderView").delegate(".selectShop","click",function(){$(".mMapPopup").lightbox_me({centered:!0,onLoad:function(){window.regionMap.showMarkers(x())}});return!1});p=null;o=0;i.delegate("li","hover",function(){var a=$(this).attr("ref");p&&clearTimeout(p);a&&a!=o&&(o=a,p=setTimeout(function(){window.regionMap.showInfobox(a)},350))});window.regionMap=new MapWithShops(calcMCenter(x()),A,"mapPopup",function(a){A.html(tmpl("mapInfoBlock",a));o=a.id});window.regionMap.addHandler(".shopchoose",function(a){a=
$(a).parent().find(".shopnum").text();MVM.selectShop(k.shops[a])});window.regionMap.addHandlerMarker("mouseover",function(a){window.regionMap.showInfobox(a.id)})});
