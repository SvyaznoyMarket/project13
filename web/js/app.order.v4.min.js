$(document).ready(function(){function a(){function t(e,t,n){for(var r=0,i=e.length;r<i;r++)if(e[r][t]==n)return!0;return!1}function n(e,t,n){var r=[];for(var i=0,s=e.length;i<s;i++)if(e[i][t]==n){for(var o in e[i].intervals)r.push("c "+e[i].intervals[o].start_at+" по "+e[i].intervals[o].end_at);return r}return!1}function r(e){var t=e[0];if(e.length>1)for(var n=1,r=e.length;n<r;n++)e[n][0]>t[0]&&(t[0]=e[n][0]),e[n][1]<t[1]&&(t[1]=e[n][1]);return t}function i(e){var t=new Date(e);if(t.getDay()!==1){var n=t.getDay()?t.getDay()-1:6;t.setTime(t.getTime()*1-n*24*60*60*1e3)}return t}function s(e){var t=new Date(e);return t.getDay()!==0&&t.setTime(t.getTime()*1+(7-t.getDay())*24*60*60*1e3),t}function o(e){e.caclDates=[];var o=e.token,u=[];for(var a=0,f=e.itemList().length;a<f;a++){var l=e.itemList()[a].deliveries[o].dates;u.push([l[0],l[l.length-1]])}var c=r(u),h=i(c[0].timestamp),p=s(c[1].timestamp),d=["Вс","Пн","Вт","Ср","Чт","Пт","Сб"],v=1;while(h.getTime()<=p.getTime()){var m={dayOfWeek:d[h.getDay()],day:h.getDate(),tstamp:h.getTime()*1,week:v,enable:ko.observable(!1)};h.getDay()||v++,e.caclDates.push(m),m=null,h.setTime(h.getTime()*1+864e5)}e.nweeks=v-1;e:for(var g in e.caclDates){var l=[];for(var a=0,f=e.itemList().length;a<f;a++){var o=e.token;l=e.itemList()[a].deliveries[o].dates;if(!t(l,"timestamp",e.caclDates[g].tstamp)){e.caclDates[g].enable(!1);continue e}e.caclDates[g].enable(!0)}e.caclDates[g].intervals=n(l,"timestamp",e.caclDates[g].tstamp)}}function a(t,n,r,i){var s={};s.type=t,s.token=n,s.curWeek=ko.observable(1),s.itemList=ko.observableArray([]);for(var a in r)s.itemList.push(u.items[r[a]]);s.shop=ko.observable(i),o(s),s.chosenDate=ko.observable(0),s.chosenInterval=ko.observable("none"),s.currentIntervals=ko.observableArray([]);for(var f in s.caclDates)if(s.caclDates[f].enable()){s.chosenDate(s.caclDates[f].tstamp),s.chosenInterval(s.caclDates[f].intervals[0]);for(var l in s.caclDates[f].intervals)s.currentIntervals.push(s.caclDates[f].intervals[l]);break}s.dlvrPrice=ko.computed(function(){var e=0,t=this.token;for(var n=0,r=this.itemList().length;n<r;n++){var i=this.itemList()[n].deliveries[t].price;i>e&&(e=i)}return e},s),s.totalPrice=ko.computed(function(){var e=0;for(var t=0,n=this.itemList().length;t<n;t++)e+=this.itemList()[t].total;return e+=this.dlvrPrice()*1,e},s),e.dlvrBoxes.push(s)}function f(){e.dlvrBoxes.removeAll();for(var t in u.deliveryTypes)u.deliveryTypes[t].items.length&&a(u.deliveryTypes[t].type,u.deliveryTypes[t].token,u.deliveryTypes[t].items,u.deliveryTypes[t].shop)}function c(){e.shopsInPopup.removeAll();for(var t in u.shops)e.shopsInPopup.push(u.shops[t])}function h(e){var t=new Date(e),n=t.getMonth()+1,r=t.getDate();return t.getFullYear()+"-"+(n>9?n:"0"+n)+"-"+(r>9?r:"0"+r)}var e=this;e.cssForDate=$(".order-delivery_date").css("display"),e.stolenItems=ko.observableArray([]),u.unavailable.length,e.showForm=ko.observable(!1),e.dlvrCourierEnable=ko.observable(!1),e.dlvrShopEnable=ko.observable(!1),e.chosenBox=ko.observable(null),e.step2=ko.observable(!1),e.dlvrBoxes=ko.observableArray([]),f(),e.shopsInPopup=ko.observableArray([]),c(),e.chosenShop=ko.observable(null),e.shopButtonEnable=ko.observable(!1),e.changeWeek=function(e,t,n){if(e>0){if(t.nweeks==t.curWeek())return;t.curWeek(t.curWeek()+1)}if(e<0){if(t.curWeek()==1)return;t.curWeek(t.curWeek()-1)}},e.clickDate=function(e,t,n){if(!t.enable())return;e.chosenDate(t.tstamp),e.currentIntervals.removeAll();for(var r in t.intervals)e.currentIntervals.push(t.intervals[r]);$.inArray(e.chosenInterval(),e.currentIntervals())||e.chosenInterval(e.currentIntervals()[0])},e.clickInterval=function(e,t,n){e.chosenInterval(t)},e.deleteItem=function(t,n,r){$.get(n.deleteUrl,function(){}),t.itemList.remove(n),t.itemList().length||e.dlvrBoxes.remove(t);e:for(var i in u.deliveryTypes){var s=u.deliveryTypes[i];for(var o=0,a=s.items.length;o<a;o++)if(s.items[o]===n.token){s.items.splice(o,1);break e}}e.dlvrBoxes().length||document.location.reload()},e.totalSum=ko.computed(function(){var t=0;for(var n=0,r=e.dlvrBoxes().length;n<r;n++)t+=e.dlvrBoxes()[n].totalPrice()*1;return t},this),e.pickCourier=function(){f(),e.step2(!0),e.shopButtonEnable(!1);var t={type:"courier",boxQuantity:e.dlvrBoxes().length};PubSub.publish("DeliveryChanged",t)},e.pickShops=function(){e.step2(!1),e.shopButtonEnable(!0);var t={type:"shops",boxQuantity:e.dlvrBoxes().length};PubSub.publish("DeliveryChanged",t)},e.showShopPopup=function(t,n,r){e.chosenBox(t);var i=[];for(var s=0,o=t.itemList().length;s<o;s++){var u=t.itemList()[s].deliveries;for(var a in u)a.match("self_")&&i.push(a.replace("self_",""))}c();for(var s=0;s<e.shopsInPopup().length;)$.inArray(e.shopsInPopup()[s].id,i)===-1?e.shopsInPopup.remove(e.shopsInPopup()[s]):s++},e.showAllShops=function(){e.shopsInPopup.removeAll();for(var t in u.shops)e.shopsInPopup.push(u.shops[t])},e.selectShop=function(t){if(e.step2()){var n=[{shop:e.chosenBox().token.replace("self_",""),items:[]},{shop:t.id,items:[]}];e:for(var r=0,i=e.chosenBox().itemList();r<i.length;){for(var s in i[r].deliveries)if(s==="self_"+t.id){n[1].items.push(i[r].token),e.chosenBox().itemList.remove(i[r]);continue e}n[0].items.push(i[r].token),e.chosenBox().itemList.remove(i[r]),r++}for(var o in n)if(n[o].items.length>0){var f=u.shops[n[o].shop];a("self","self_"+n[o].shop,n[o].items,f)}e.chosenBox().itemList().length||e.dlvrBoxes.remove(e.chosenBox())}else{var c=[{shop:t.id,items:[]}];for(var h in e.dlvrBoxes()){var p=e.dlvrBoxes()[h];for(var r=0;r<p.itemList().length;)"self_"+t.id in p.itemList()[r].deliveries?(p.itemList()[r].deliveries["self_"+t.id].dates.length>1?c[0].items.push(p.itemList()[r].token):c.push({shop:t.id,items:[p.itemList()[r].token]}),p.itemList.remove(p.itemList()[r])):r++}var d={},v=[];for(var h in e.dlvrBoxes()){var p=e.dlvrBoxes()[h];for(var r=0,m=p.itemList();r<m.length;){v=[];for(b in m[r].deliveries)m[r].deliveries[b].token.match("self_")&&v.push(m[r].deliveries[b].token.replace("self_",""));d[m[r].token+""]=v,v.length?p.itemList.remove(p.itemList()[r]):r++}}var n=l(d);for(var g=0,y=c.length;g<y;g++)c[g].items.length>0&&n.push(c[g]);for(var b in n){var f=u.shops[n[b].shop];a("self","self_"+n[b].shop,n[b].items,f)}for(var h=0;h<e.dlvrBoxes().length;)e.dlvrBoxes()[h].itemList().length?h++:e.dlvrBoxes.remove(e.dlvrBoxes()[h]);e.shopButtonEnable(!1);var d={type:"shops",boxQuantity:e.dlvrBoxes().length};for(var h in e.dlvrBoxes())if(e.dlvrBoxes()[h].type==="standart"){d.type="courier";break}PubSub.publish("DeliveryChanged",d)}e.chosenShop(t),e.step2(!0),PubSub.publish("ShopSelected",t)},e.printDate=function(e){var t=new Date(e),n=["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"];return t.getDate()+" "+n[t.getMonth()]},e.getServerModel=function(){var t={deliveryTypes:{}};for(var n in e.dlvrBoxes()){var r=e.dlvrBoxes()[n],i={id:u.deliveryTypes[r.token].id,token:r.token,type:r.type,date:h(r.chosenDate()),interval:r.chosenInterval().match(/\d{2}:\d{2}/g).join(","),shop:{id:r.token.replace("self_","")}},s=[];for(var o in r.itemList())s.push(r.itemList()[o].token);i.items=s,t.deliveryTypes[r.token+h(r.chosenDate())]=i}return t},e.showForm(!0);for(var p in u.deliveryTypes)u.deliveryTypes[p].type==="standart"?e.dlvrCourierEnable(!0):e.dlvrShopEnable(!0);e.dlvrCourierEnable()&&!e.dlvrShopEnable()&&e.pickCourier(),!e.dlvrCourierEnable()&&e.dlvrShopEnable()&&e.pickShops()}function f(e){var t=0,n="none";for(var r in e)e[r].length>t&&(t=e[r].length,n=r);return n}function l(e){var t=[];for(;;){var n={},r=0;for(var i in e)for(var s=0,o=e[i].length;s<o;s++)n[e[i][s]]?n[e[i][s]].push(i):(n[e[i][s]]=[i],r++);if(!r)break;var u=f(n);t.push({shop:u,items:n[u]});for(var i in n[u])e[n[u][i]]=[]}return t}function d(e,t){p++,$("body").delegate('input[name="'+e+'"]',"change",function(){if($(this).val().replace(/\s+/g,"")!=""){p--,$('input[name="'+e+'"]').removeClass("mRed"),$('input[name="'+e+'"]').prev(".placeholder").removeClass("mRed");var t=$('input[name="'+e+'"]').closest(".bBuyingLine");t.find(".mRed").length||t.find(".bFormError").remove()}});var n=$('input[name="'+e+'"]:first');if(n.hasClass("mRed"))return;switch(n.attr("type")){case"text":n.addClass("mRed"),n.prev(".placeholder").addClass("mRed");var r=n.parent().parent();r.find(".bFormError").length||r.append('<span class="bFormError mb10 pt5">'+t+"</span>");break;default:n.addClass("mRed"),n.prev(".placeholder").addClass("mRed"),n.parent().parent().parent().append('<span class="bFormError mb10 pt5">'+t+"</span>")}}function v(e){for(var t in e)d(t,e[t]);p>0&&$.scrollTo(".mRed:first",500)}function y(){var e={};for(var t in MVM.shopsInPopup())e[MVM.shopsInPopup()[t].id]=MVM.shopsInPopup()[t];return e}function w(e){g.html(tmpl("mapInfoBlock",e)),b.id=e.id}function E(e){var t=$(e).parent().find(".shopnum").text(),n=u.shops[t];MVM.selectShop(n)}$("body").delegate(".bSelect","click",function(){if($(this).hasClass("mDisabled"))return!1;$(this).find(".bSelect__eDropmenu").toggle()}),$("body").delegate(".bSelect","mouseleave",function(){if($(this).hasClass("mDisabled"))return!1;var e=$(this).find(".bSelect__eDropmenu");e.is(":visible")&&e.hide()}),$("body").delegate(".bBuyingLine label","click",function(){if($(this).find("input").attr("type")=="radio"){var e=$('.mChecked input[name="'+$(this).find("input").attr("name")+'"]');e.length&&e.each(function(e,t){$(t).parent("label").removeClass("mChecked")}),$(this).addClass("mChecked");return}$(this).find("input").attr("type")=="checkbox"&&$(this).toggleClass("mChecked")}),$("body").delegate(".bBuyingLine input:radio, .bBuyingLine input:checkbox","click",function(e){e.stopPropagation()}),$("body").delegate('input[name="order[payment_method_id]"]',"click",function(){this.id==="order_payment_method_id_6"?$("#creditInfo").show():$("#creditInfo").hide()});if($(".bankWrap").length){var e=$(".bankWrap > .bSelect").data("value"),t=$(".bankWrap > .creditHref"),n=$("<div>").addClass("bSelect__eDropmenu");for(var r in e){var i=$("<div>").attr("ref",r).append($("<span>").text(e[r].name));i.click(function(){var n=$(this).attr("ref");$(".bankWrap > .bSelect").find("span:first").text(e[n].name),$('input[name="order[credit_bank_id]"]').val(n),t.find("a").attr("href",e[n].href),t.find("span").text("("+e[n].name+")")}),n.append(i)}$(".bankWrap > .bSelect").append(n),DirectCredit.init($("#tsCreditCart").data("value"),$("#creditPrice"))}PubSub.subscribe("authorize",function(e,t){$("#order_recipient_first_name").val(t.first_name),$("#order_recipient_last_name").val(t.last_name),$("#order_recipient_phonenumbers").val(t.phonenumber+"       "),$("#user-block").hide()}),$(".auth-link").bind("click",function(e){e.preventDefault();var t=$(this);$("#login-form, #register-form").data("redirect",!1),$("#auth-block").lightbox_me({centered:!0,onLoad:function(){$("#auth-block").find("input:first").focus()}})});if(typeof $.mask!="undefined"){$.mask.definitions.n="[()0-9 -]",$("#order_recipient_phonenumbers").mask("8nnnnnnnnnnnnnnnnn",{placeholder:" ",maxlength:10});var s=document.getElementById("order_recipient_phonenumbers").getAttribute("value");s&&s!=""?$("#order_recipient_phonenumbers").val(s+"       "):$("#order_recipient_phonenumbers").val("8"),$.mask.definitions["*"]="[0-9*]",$("#order_sclub_card_number").mask("* ****** ******",{placeholder:"*"}),$("#order_sclub_card_number")[0].getAttribute("value")&&$("#order_sclub_card_number").val($("#order_sclub_card_number")[0].getAttribute("value")),$("#order_sclub_card_number").blur(function(){$(this).val()==="* ****** ******"&&($(this).trigger("unmask").val(""),$(this).focus(function(){$("#order_sclub_card_number").mask("* ****** ******",{placeholder:"*"})}))})}$(".placeholder-input").focus(function(e){var t=$(e.target);t.prev(".placeholder").hasClass("mRed")||t.prev(".placeholder").css("border-color","#FFA901")}).focusout(function(e){var t=$(e.target);t.prev(".placeholder").hasClass("mRed")||t.prev(".placeholder").css("border-color","#DDDDDD")}),$(".placeholder").click(function(e){$(this).next(".placeholder-input").focus()});var o=["Авиамоторная","Автозаводская","Академическая","Александровский сад","Алексеевская","Алтуфьево","Аннино","Арбатская (Арбатско-Покровская линия)","Арбатская (Филевская линия","Аэропорт","Бабушкинская","Багратионовская","Баррикадная","Бауманская","Беговая","Белорусская","Беляево","Бибирево","Библиотека имени Ленина","Битцевский парк","Борисовская","Боровицкая","Ботанический сад","Братиславская","Бульвар адмирала Ушакова","Бульвар Дмитрия Донского","Бунинская аллея","Варшавская","ВДНХ","Владыкино","Водный стадион","Войковская","Волгоградский проспект","Волжская","Волоколамская","Воробьевы горы","Выставочная","Выхино","Деловой центр","Динамо","Дмитровская","Добрынинская","Домодедовская","Достоевская","Дубровка","Жулебино","Зябликово","Измайловская","Калужская","Кантемировская","Каховская","Каширская","Киевская","Китай-город","Кожуховская","Коломенская","Комсомольская","Коньково","Красногвардейская","Краснопресненская","Красносельская","Красные ворота","Крестьянская застава","Кропоткинская","Крылатское","Кузнецкий мост","Кузьминки","Кунцевская","Курская","Кутузовская","Ленинский проспект","Лубянка","Люблино","Марксистская","Марьина роща","Марьино","Маяковская","Медведково","Международная","Менделеевская","Митино","Молодежная","Мякинино","Нагатинская","Нагорная","Нахимовский проспект","Новогиреево","Новокузнецкая","Новослободская","Новоясеневская","Новые Черемушки","Октябрьская","Октябрьское поле","Орехово","Отрадное","Охотныйряд","Павелецкая","Парк культуры","Парк Победы","Партизанская","Первомайская","Перово","Петровско-Разумовская","Печатники","Пионерская","Планерная","Площадь Ильича","Площадь Революции","Полежаевская","Полянка","Пражская","Преображенская площадь","Пролетарская","Проспект Вернадского","Проспект Мира","Профсоюзная","Пушкинская","Речной вокзал","Рижская","Римская","Рязанский проспект","Савеловская","Свиблово","Севастопольская","Семеновская","Серпуховская","Славянский бульвар","Смоленская (Арбатско-Покровская линия)","Смоленская (Филевская линия)","Сокол","Сокольники","Спортивная","Сретенский бульвар","Строгино","Студенческая","Сухаревская","Сходненская","Таганская","Тверская","Театральная","Текстильщики","ТеплыйСтан","Тимирязевская","Третьяковская","Трубная","Тульская","Тургеневская","Тушинская","Улица 1905года","Улица Академика Янгеля","Улица Горчакова","Улица Подбельского","Улица Скобелевская","Улица Старокачаловская","Университет","Филевский парк","Фили","Фрунзенская","Царицыно","Цветной бульвар","Черкизовская","Чертановская","Чеховская","Чистые пруды","Чкаловская","Шаболовская","Шипиловская","Шоссе Энтузиастов","Щелковская","Щукинская","Электрозаводская","Юго-Западная","Южная","Ясенево"];$("#order_address_metro").autocomplete({source:o,appendTo:"#metrostations",minLength:2}).change(function(){for(var e=0,t=o.length;e<t;e++)if($(this).val()===o[e])return!0;$(this).val("")}),window.blockScreen=function(e){$('<img src="/images/ajaxnoti.gif" />').css("display","none").appendTo("body");var t=$("<div>").addClass("noti").html('<div><img src="/images/ajaxnoti.gif" /></br></br> '+e+"</div>");t.appendTo("body"),this.block=function(){t.is(":hidden")&&t.lightbox_me({centered:!0,closeClick:!1,closeEsc:!1})},this.unblock=function(){t.trigger("close")},this.bye=function(){t.find("img").remove()}},Blocker=new blockScreen("Ваш заказ оформляется"),PubSub.subscribe("DeliveryChanged",function(e,t){t.type==="courier"?($("#order-submit").removeClass("disable"),$("#order-form").show(),$("#addressField").show()):($("#addressField").hide(),$("#order-form").hide(),$("#order-submit").addClass("disable")),t.boxQuantity>1?($("#payTypes > div").hide(),$("#payment_method_1-field").show(),$("#payment_method_2-field").show()):$("#payTypes > div").show()}),PubSub.subscribe("ShopSelected",function(e,t){$(".mMapPopup").trigger("close"),$("#order-form").show(),$("#order-submit").removeClass("disable")});var u=$("#order-delivery_map-data").data("value"),c=$("#order-form"),h=!1,p=0;$("#order-submit").click(function(e){e.preventDefault();if(h)return;if($(this).hasClass("disable"))return!1;var t=c.serializeArray(),n=$("#order-validator").data("value");e:for(field in n){if(!c.find('[name="'+field+'"]:visible').length)continue;for(var r=0,i=t.length;r<i;r++)if(t[r].name==field){t[r].value==""&&d(field,n[field]);continue e}d(field,n[field])}if(p>0){$.scrollTo(".mRed:first",500);return}var s=$(this);s.text("Оформляется..."),Blocker.block(),h=!0;var o=c.serializeArray(),u=$('label.mChecked input[name="order[delivery_type_id]"]').val();u||(u=$('input[name="order[delivery_type_id]"]').val()),o.push({name:"order[delivery_type_id]",value:u}),o.push({name:"delivery_map",value:JSON.stringify(MVM.getServerModel())}),$.ajax({url:c.attr("action"),timeout:2e4,type:"POST",data:o,success:function(e){h=!1;if(!e.success){Blocker.unblock(),s.text("Завершить оформление"),"errors"in e&&v(e.errors);return}Blocker.bye(),"redirect"in e.data&&(window.location=e.data.redirect)},error:function(){s.text("Попробовать еще раз"),Blocker.unblock()}})}),MVM=new a,ko.applyBindings(MVM,$("#MVVM")[0]);var m=$("#mapPopup_shopInfo"),g=$("#map-info_window-container");$("#OrderView").delegate(".selectShop","click",function(){return $(".mMapPopup").lightbox_me({centered:!0,onLoad:function(){window.regionMap.showMarkers(y())}}),!1});var b={timer:null,id:0};m.delegate("li","hover",function(){var e=$(this).attr("ref");b.timer&&clearTimeout(b.timer),e&&e!=b.id&&(b.id=e,b.timer=setTimeout(function(){window.regionMap.showInfobox(e)},350))}),window.regionMap=new MapWithShops(calcMCenter(y()),g,"mapPopup",w),window.regionMap.addHandler(".shopchoose",E),window.regionMap.addHandlerMarker("mouseover",function(e){window.regionMap.showInfobox(e.id)})});