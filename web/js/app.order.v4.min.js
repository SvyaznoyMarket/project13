$(document).ready(function(){var o,p;function s(b,g){q++;$("body").delegate('input[name="'+b+'"]',"change",function(){if(""!=$(this).val().replace(/\s+/g,"")){q--;$('input[name="'+b+'"]').removeClass("mRed");var a=$('input[name="'+b+'"]').closest(".bBuyingLine");a.find(".mRed").length||a.find(".bFormError").remove()}});var h=$('input[name="'+b+'"]:first');if(!h.hasClass("mRed"))switch(h.attr("type")){case "text":h.addClass("mRed");h=h.parent().parent();h.find(".bFormError").length||h.append('<span class="bFormError mb10 pt5">'+
g+"</span>");break;default:h.addClass("mRed"),h.parent().parent().parent().append('<span class="bFormError mb10 pt5">'+g+"</span>")}}function v(){var b={},g;for(g in MVM.shopsInPopup())b[MVM.shopsInPopup()[g].id]=MVM.shopsInPopup()[g];return b}$("#OrderView").delegate(".bSelect","click",function(){if($(this).hasClass("mDisabled"))return!1;$(this).find(".bSelect__eDropmenu").toggle()});$("#OrderView").delegate(".bSelect","mouseleave",function(){if($(this).hasClass("mDisabled"))return!1;var b=$(this).find(".bSelect__eDropmenu");
b.is(":visible")&&b.hide()});$("body").delegate(".bBuyingLine label","click",function(){if("radio"==$(this).find("input").attr("type")){var b=$('.mChecked input[name="'+$(this).find("input").attr("name")+'"]');b.length&&b.each(function(b,h){$(h).parent("label").removeClass("mChecked")});$(this).addClass("mChecked")}else"checkbox"==$(this).find("input").attr("type")&&$(this).toggleClass("mChecked")});$("body").delegate(".bBuyingLine input:radio, .bBuyingLine input:checkbox","click",function(b){b.stopPropagation()});
PubSub.subscribe("authorize",function(b,g){$("#order_recipient_first_name").val(g.first_name);$("#order_recipient_last_name").val(g.last_name);$("#order_recipient_phonenumbers").val(g.phonenumber+"       ");$("#user-block").hide()});$(".auth-link").bind("click",function(b){b.preventDefault();$(this);$("#login-form, #register-form").data("redirect",!1);$("#auth-block").lightbox_me({centered:!0,onLoad:function(){$("#auth-block").find("input:first").focus()}})});if("undefined"!==typeof $.mask){$.mask.definitions.n=
"[()0-9 -]";$("#order_recipient_phonenumbers").mask("8nnnnnnnnnnnnnnnnn",{placeholder:" ",maxlength:10});var m=document.getElementById("order_recipient_phonenumbers").getAttribute("value");m&&""!=m?$("#order_recipient_phonenumbers").val(m+"       "):$("#order_recipient_phonenumbers").val("8");$.mask.definitions["*"]="[0-9*]";$("#order_sclub_card_number").mask("* ****** ******",{placeholder:"*"});$("#order_sclub_card_number")[0].getAttribute("value")&&$("#order_sclub_card_number").val($("#order_sclub_card_number")[0].getAttribute("value"));
$("#order_sclub_card_number").blur(function(){"* ****** ******"===$(this).val()&&($(this).trigger("unmask").val(""),$(this).focus(function(){$("#order_sclub_card_number").mask("* ****** ******",{placeholder:"*"})}))})}$("#addressField").find("input").placeholder();var t="Авиамоторная,Автозаводская,Академическая,Александровский сад,Алексеевская,Алтуфьево,Аннино,Арбатская (Арбатско-Покровская линия),Арбатская (Филевская линия,Аэропорт,Бабушкинская,Багратионовская,Баррикадная,Бауманская,Беговая,Белорусская,Беляево,Бибирево,Библиотека имени Ленина,Битцевский парк,Борисовская,Боровицкая,Ботанический сад,Братиславская,Бульвар адмирала Ушакова,Бульвар Дмитрия Донского,Бунинская аллея,Варшавская,ВДНХ,Владыкино,Водный стадион,Войковская,Волгоградский проспект,Волжская,Волоколамская,Воробьевы горы,Выставочная,Выхино,Деловой центр,Динамо,Дмитровская,Добрынинская,Домодедовская,Достоевская,Дубровка,Жулебино,Зябликово,Измайловская,Калужская,Кантемировская,Каховская,Каширская,Киевская,Китай-город,Кожуховская,Коломенская,Комсомольская,Коньково,Красногвардейская,Краснопресненская,Красносельская,Красные ворота,Крестьянская застава,Кропоткинская,Крылатское,Кузнецкий мост,Кузьминки,Кунцевская,Курская,Кутузовская,Ленинский проспект,Лубянка,Люблино,Марксистская,Марьина роща,Марьино,Маяковская,Медведково,Международная,Менделеевская,Митино,Молодежная,Мякинино,Нагатинская,Нагорная,Нахимовский проспект,Новогиреево,Новокузнецкая,Новослободская,Новоясеневская,Новые Черемушки,Октябрьская,Октябрьское поле,Орехово,Отрадное,Охотныйряд,Павелецкая,Парк культуры,Парк Победы,Партизанская,Первомайская,Перово,Петровско-Разумовская,Печатники,Пионерская,Планерная,Площадь Ильича,Площадь Революции,Полежаевская,Полянка,Пражская,Преображенская площадь,Пролетарская,Проспект Вернадского,Проспект Мира,Профсоюзная,Пушкинская,Речной вокзал,Рижская,Римская,Рязанский проспект,Савеловская,Свиблово,Севастопольская,Семеновская,Серпуховская,Славянский бульвар,Смоленская (Арбатско-Покровская линия),Смоленская (Филевская линия),Сокол,Сокольники,Спортивная,Сретенский бульвар,Строгино,Студенческая,Сухаревская,Сходненская,Таганская,Тверская,Театральная,Текстильщики,ТеплыйСтан,Тимирязевская,Третьяковская,Трубная,Тульская,Тургеневская,Тушинская,Улица 1905года,Улица Академика Янгеля,Улица Горчакова,Улица Подбельского,Улица Скобелевская,Улица Старокачаловская,Университет,Филевский парк,Фили,Фрунзенская,Царицыно,Цветной бульвар,Черкизовская,Чертановская,Чеховская,Чистые пруды,Чкаловская,Шаболовская,Шипиловская,Шоссе Энтузиастов,Щелковская,Щукинская,Электрозаводская,Юго-Западная,Южная,Ясенево".split(",");
$("#order_address_metro").autocomplete({source:t,appendTo:"#metrostations",minLength:2}).change(function(){for(var b=0,g=t.length;b<g;b++)if($(this).val()===t[b])return!0;$(this).val("")});window.blockScreen=function(b){$('<img src="/images/ajaxnoti.gif" />').css("display","none").appendTo("body");var g=$("<div>").addClass("noti").html('<div><img src="/images/ajaxnoti.gif" /></br></br> '+b+"</div>");g.appendTo("body");this.block=function(){g.is(":hidden")&&g.lightbox_me({centered:!0,closeClick:!1,
closeEsc:!1})};this.unblock=function(){g.trigger("close")};this.bye=function(){g.find("img").remove()}};Blocker=new blockScreen("Ваш заказ оформляется");PubSub.subscribe("DeliveryChanged",function(b,g){"courier"===g.type?($("#order-submit").removeClass("disable"),$("#order-form").show(),$("#addressField").show()):($("#addressField").hide(),$("#order-form").hide(),$("#order-submit").addClass("disable"));1<g.boxQuantity?$("#payment_method_online-field").hide():$("#payment_method_online-field").show()});
PubSub.subscribe("ShopSelected",function(){$(".mMapPopup").trigger("close");$("#order-form").show();$("#order-submit").removeClass("disable")});var k=$("#order-delivery_map-data").data("value"),r=$("#order-form"),u=!1,q=0;$("#order-submit").click(function(b){b.preventDefault();if(!u){if($(this).hasClass("disable"))return!1;var b=r.serializeArray(),g=$("#order-validator").data("value");a:for(field in g)if(r.find('[name="'+field+'"]:visible').length){for(var h=0,a=b.length;h<a;h++)if(b[h].name==field){""==
b[h].value&&s(field,g[field]);continue a}s(field,g[field])}if(0<q)$.scrollTo(".mRed:first",500);else{var k=$(this);k.text("Оформляется...");Blocker.block();u=!0;b=r.serializeArray();b.push({name:"order[delivery_type_id]",value:$('input[name="order[delivery_type_id]"]').val()});b.push({name:"delivery_map",value:JSON.stringify(MVM.getServerModel())});console.info(b);$.ajax({url:r.attr("action"),timeout:2E4,type:"POST",data:b,success:function(a){u=!1;if(a.success){if(Blocker.bye(),"redirect"in a.data)window.location=
a.data.redirect}else if(Blocker.unblock(),k.text("Завершить оформление"),"errors"in a){var a=a.errors,e;for(e in a)s(e,a[e]);0<q&&$.scrollTo(".mRed:first",500)}},error:function(){k.text("Попробовать еще раз");Blocker.unblock()}})}}});console.info("MODEL ",k);MVM=new function(){function b(a){a.caclDates=[];for(var e=a.token,c=[],b=0,d=a.itemList().length;b<d;b++){var f=a.itemList()[b].deliveries[e].dates;c.push([f[0],f[f.length-1]])}b=c[0];if(1<c.length){f=1;for(d=c.length;f<d;f++)c[f][0]>b[0]&&(b[0]=
c[f][0]),c[f][1]<b[1]&&(b[1]=c[f][1])}f=new Date(b[0].timestamp);1!==f.getDay()&&(c=f.getDay()?f.getDay()-1:6,f.setTime(1*f.getTime()-864E5*c));c=new Date(b[1].timestamp);0!==c.getDay()&&c.setTime(1*c.getTime()+864E5*(7-c.getDay()));console.info("Interval edges for ",e," :",f,c);e="Вс,Пн,Вт,Ср,Чт,Пт,Сб".split(",");for(b=1;f.getTime()<=c.getTime();)d={dayOfWeek:e[f.getDay()],day:f.getDate(),tstamp:1*f.getTime(),week:b,enable:ko.observable(!1)},f.getDay()||b++,a.caclDates.push(d),f.setTime(1*f.getTime()+
864E5);a.nweeks=b-1;var i;a:for(i in a.caclDates){f=[];b=0;for(d=a.itemList().length;b<d;b++){e=a.token;f=a.itemList()[b].deliveries[e].dates;b:{e=0;for(c=f.length;e<c;e++)if(f[e].timestamp==a.caclDates[i].tstamp){e=!0;break b}e=!1}if(!e){a.caclDates[i].enable(!1);continue a}a.caclDates[i].enable(!0)}e=a.caclDates[i];b:{for(var c=a.caclDates[i].tstamp,b=[],d=0,g=f.length;d<g;d++)if(f[d].timestamp==c){for(var l in f[d].intervals)b.push("c "+f[d].intervals[l].start_at+" по "+f[d].intervals[l].end_at);
f=b;break b}f=!1}e.intervals=f}}function g(x,e,c,g){var d={};d.type=x;d.token=e;d.itemList=ko.observableArray([]);for(var f in c)d.itemList.push(k.items[c[f]]);d.shop=ko.observable(g);b(d);d.chosenDate=ko.observable(0);d.chosenInterval=ko.observable("none");d.currentIntervals=ko.observableArray([]);for(var i in d.caclDates)if(d.caclDates[i].enable()){d.chosenDate(d.caclDates[i].tstamp);d.chosenInterval(d.caclDates[i].intervals[0]);for(var j in d.caclDates[i].intervals)d.currentIntervals.push(d.caclDates[i].intervals[j]);
break}d.dlvrPrice=ko.computed(function(){for(var a=0,b=this.token,c=0,d=this.itemList().length;c<d;c++){var e=this.itemList()[c].deliveries[b].price;e>a&&(a=e)}return a},d);d.totalPrice=ko.computed(function(){for(var a=0,c=0,b=this.itemList().length;c<b;c++)a+=this.itemList()[c].total;return a+=1*this.dlvrPrice()},d);a.dlvrBoxes.push(d)}function h(){a.shopsInPopup.removeAll();for(var b in k.shops)a.shopsInPopup.push(k.shops[b])}var a=this;a.unavailable=ko.observable(!1);k.unavailable.length&&a.unavailable(!0);
a.curWeek=ko.observable(1);a.chosenBox=ko.observable(null);a.step2=ko.observable(!1);a.dlvrBoxes=ko.observableArray([]);for(var m in k.deliveryTypes)k.deliveryTypes[m].items.length&&g(k.deliveryTypes[m].type,k.deliveryTypes[m].token,k.deliveryTypes[m].items,k.deliveryTypes[m].shop);a.shopsInPopup=ko.observableArray([]);h();a.chosenShop=ko.observable(null);a.shopButtonEnable=ko.observable(!1);a.changeWeek=function(b,e){if(0<b){if(e.nweeks==a.curWeek())return;a.curWeek(a.curWeek()+1)}0>b&&1!=a.curWeek()&&
a.curWeek(a.curWeek()-1)};a.clickDate=function(a,b){if(b.enable()){a.chosenDate(b.tstamp);a.currentIntervals.removeAll();for(var c in b.intervals)a.currentIntervals.push(b.intervals[c]);$.inArray(a.chosenInterval(),a.currentIntervals())||a.chosenInterval(a.currentIntervals()[0])}};a.clickInterval=function(a,b){a.chosenInterval(b)};a.deleteItem=function(b,e){b.itemList.remove(e);b.itemList().length||a.dlvrBoxes.remove(b)};a.totalSum=ko.computed(function(){for(var b=0,e=0,c=a.dlvrBoxes().length;e<c;e++)b+=
1*a.dlvrBoxes()[e].totalPrice();return b},this);a.pickCourier=function(){a.step2(!0);a.shopButtonEnable(!1);var b={type:"courier",boxQuantity:a.dlvrBoxes().length};PubSub.publish("DeliveryChanged",b)};a.pickShops=function(){a.step2(!1);a.shopButtonEnable(!0)};a.showShopPopup=function(b){a.chosenBox(b);for(var e=[],c=0,g=b.itemList().length;c<g;c++){var d=b.itemList()[c].deliveries,f;for(f in d)f.match("self_")&&e.push(f.replace("self_",""))}h();for(c=0;c<a.shopsInPopup().length;)-1===$.inArray(a.shopsInPopup()[c].id,
e)?a.shopsInPopup.remove(a.shopsInPopup()[c]):c++};a.showAllShops=function(){a.shopsInPopup.removeAll();for(var b in k.shops)a.shopsInPopup.push(k.shops[b])};a.selectShop=function(b){if(a.step2()){var e=[{shop:a.chosenBox().token.replace("self_",""),items:[]},{shop:b.id,items:[]}],c=0,h=a.chosenBox().itemList();a:for(;c<h.length;){for(var d in h[c].deliveries)if(d==="self_"+b.id){e[1].items.push(h[c].token);a.chosenBox().itemList.remove(h[c]);continue a}e[0].items.push(h[c].token);a.chosenBox().itemList.remove(h[c]);
c++}for(var f in e){var i=k.shops[e[f].shop];g("self","self_"+e[f].shop,e[f].items,i)}a.chosenBox().itemList().length||a.dlvrBoxes.remove(a.chosenBox())}else{f=[];for(var j in a.dlvrBoxes()){d=a.dlvrBoxes()[j];for(c=0;c<d.itemList().length;)"self_"+b.id in d.itemList()[c].deliveries?(f.push(d.itemList()[c].token),d.itemList.remove(d.itemList()[c])):c++}var l={};for(j in a.dlvrBoxes()){d=a.dlvrBoxes()[j];for(var c=0,n=d.itemList();c<n.length;){var m=[];for(h in n[c].deliveries)n[c].deliveries[h].token.match("self_")&&
m.push(n[c].deliveries[h].token.replace("self_",""));l[n[c].token]=m;m.length?d.itemList.remove(d.itemList()[c]):c++}}for(c=l;;){j={};d=0;e=[];for(i in c){l=0;for(n=c[i].length;l<n;l++)j[c[i][l]]?j[c[i][l]].push(i):(j[c[i][l]]=[i],d++)}if(!d)break;d=0;l="none";n=void 0;for(n in j)if(j[n].length>d)d=j[n].length,l=n;d=l;e.push({shop:d,items:j[d]});for(i in j[d])c[j[d][i]]=[]}e.push({shop:b.id,items:f});for(h in e)i=k.shops[e[h].shop],g("self","self_"+e[h].shop,e[h].items,i);for(j=0;j<a.dlvrBoxes().length;)a.dlvrBoxes()[j].itemList().length?
j++:a.dlvrBoxes.remove(a.dlvrBoxes()[j]);l={type:"shops",boxQuantity:a.dlvrBoxes().length};for(j in a.dlvrBoxes())if("standart"===a.dlvrBoxes()[j].type){l.type="courier";break}PubSub.publish("DeliveryChanged",l)}a.chosenShop(b);a.step2(!0);PubSub.publish("ShopSelected",b)};a.printDate=function(a){a=new Date(a);return a.getDate()+" "+"января,февраля,марта,апреля,мая,июня,июля,августа,сентября,октября,ноября,декабря".split(",")[a.getMonth()]};a.getServerModel=function(){var b={deliveryTypes:{}},e;for(e in a.dlvrBoxes()){var c=
a.dlvrBoxes()[e],g=k.deliveryTypes[c.token].id,d=c.token,f=c.type,i;i=c.chosenDate();i=new Date(i);var h=i.getMonth()+1,l=i.getDate();i=i.getFullYear()+"-"+(9<h?h:"0"+h)+"-"+(9<l?l:"0"+l);var g={id:g,token:d,type:f,date:i,interval:c.chosenInterval().match(/\d{2}:\d{2}/g).join(",")},d=[],m;for(m in c.itemList())d.push(c.itemList()[m].token);g.items=d;console.info(g);b.deliveryTypes[c.token]=g}return b}};ko.applyBindings(MVM,$("#OrderView")[0]);var m=$("#mapPopup_shopInfo"),w=$("#map-info_window-container");
$("#OrderView").delegate(".selectShop","click",function(){$(".mMapPopup").lightbox_me({centered:!0,onLoad:function(){window.regionMap.showMarkers(v())}});return!1});p=null;o=0;m.delegate("li","hover",function(){var b=$(this).attr("ref");p&&clearTimeout(p);b&&b!=o&&(o=b,p=setTimeout(function(){window.regionMap.showInfobox(b)},350))});window.regionMap=new MapWithShops(calcMCenter(v()),w,"mapPopup",function(b){w.html(tmpl("mapInfoBlock",b));o=b.id});window.regionMap.addHandler(".shopchoose",function(b){b=
$(b).parent().find(".shopnum").text();MVM.selectShop(k.shops[b])});window.regionMap.addHandlerMarker("mouseover",function(b){window.regionMap.showInfobox(b.id)})});
