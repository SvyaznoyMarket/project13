define(["jquery","underscore","module/config","module/widget"],function(t,e,n){var a=t("body"),r=function(n){n.stopPropagation();var a=t(n.target),r=a.data(),o=t(a.data("widgetSelector"));console.info("addProductToCart",a,o,r),r.url&&(t.post(r.url,r.value,function(n){e.isObject(n.result.widgets)&&e.each(n.result.widgets,function(e,n){n&&t(n).trigger("render",e)})}),n.preventDefault())},o=function(n){n.stopPropagation();var a=t(n.target),r=a.data(),o=t(a.data("spinnerSelector"));if(console.info("deleteProductFromCart",a,r),r.url&&(t.post(r.url,r.value,function(n){if(n.redirect&&-1!==n.redirect.indexOf("/")&&(window.location.href=n.redirect),e.isObject(n.result)&&e.isObject(n.result.widgets)&&e.each(n.result.widgets,function(e,n){n&&t(n).trigger("render",e)}),a.data("parentContainerSelector")){var r=a.parents(a.data("parentContainerSelector"));r.length&&r.slideUp(300,function(){r.remove()})}}),n.preventDefault(),o.length)){var i=o.data("timer");try{clearTimeout(i)}catch(c){console.warn(c)}}},i=function(n,a){n.stopPropagation();var o=t(n.target),i=t(o),c=i.data("value"),u=t(i.data("widgetSelector")),d=parseInt(u.data("timer"));if(console.info("changeProductQuantity",i,a),e.isFinite(d)&&d>0){try{clearTimeout(d)}catch(l){console.warn(l)}d=setTimeout(function(){r(n)},600),u.data("timer",d)}if(!e.isFinite(a)||0>=a||a>999){var l={code:"invalid",message:"Неверное количество товара"};return console.info("changeProductQuantityData:js-buyButton",l,a,i),l}if(c.product.quantity=a,i.hasClass("js-quickBuyButton")){var s=i.attr("href").replace(/\d+$/,a);i.attr("href",s)}},c=function(e){e.stopPropagation();var n=t(e.target),a=t(n.data("widgetSelector")),r=t(n.data("buttonSelector")),o=r.data("value");console.info("incSpinnerValue",n,r,a),o&&(r.trigger("changeProductQuantityData",o.product.quantity+1),a.trigger("renderValue",o.product)),n.blur()},u=function(e){e.stopPropagation();var n=t(e.target),a=t(n.data("widgetSelector")),r=t(n.data("buttonSelector")),o=r.data("value");console.info("decSpinnerValue",n,r),o&&(r.trigger("changeProductQuantityData",o.product.quantity-1),a.trigger("renderValue",o.product)),n.blur()},d=function(e){e.stopPropagation();var n=t(e.target),a=t(n.data("widgetSelector")),r=t(n.data("buttonSelector")),o=r.data("value");console.info("changeSpinnerValue",n,r);var i=n.val();""!=i&&(r.trigger("changeProductQuantityData",parseInt(i)),o&&a.trigger("renderValue",o.product))},l=function(e,n){e.stopPropagation();var a=t(e.target);console.info("renderSpinnerValue",a,n),a.find(".js-buySpinner-value").val(n.quantity)},s=function(e){e.stopPropagation();var a=t(e.target);a.is(":checked")?t.cookie(n.credit.cookieName,1,{expires:7}):t.removeCookie(n.credit.cookieName),e.preventDefault()},g=function(e){e.stopPropagation(),t.removeCookie(n.credit.cookieName),e.preventDefault()},p=function(e){1==t.cookie(n.credit.cookieName)?e.attr("checked",!0):e.removeAttr("checked")};return a.on("click",".js-buyButton",r).on("changeProductQuantityData",".js-buyButton",i).on("changeProductQuantityData",".js-quickBuyButton",i).on("click",".js-deleteButton",o),a.on("click dblclick contextmenu",".js-buySpinner-inc",c).on("click dblclick contextmenu",".js-buySpinner-dec",u).on("change keyup",".js-buySpinner-value",d).on("renderValue",".js-buySpinner",l).on("changeProductQuantityData",".js-buySpinner-value",i),a.on("change",".js-creditButton",s).on("change",".js-creditButton-remove",g),p(t(".js-creditButton")),{initCredit:function(){p(t(".js-creditButton"))}}});